<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>קהילת קשר — קהילה תומכת 60+</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

  <style>
    :root{
      --primary:#2B6CB0;
      --accent:#38B2AC;
      --bg:#F7FAFC;
      --card:#FFFFFF;
      --muted:#4A5568;
    }
    html,body { height:100%; }
    body{ background:var(--bg); font-family: "Segoe UI", Roboto, Arial, sans-serif; color:#1a202c; -webkit-font-smoothing:antialiased; margin:0; padding:0; }
    .card{ background:var(--card); border-radius:12px; box-shadow:0 6px 20px rgba(0,0,0,0.06); }
    .btn-primary{ background:var(--accent); color:white; }
    .btn-sec{ background:var(--primary); color:white; }
    .pill{ padding:.5rem .9rem; border-radius:999px; font-size: .95rem; }
    .clickable{ cursor:pointer; }
    input, textarea, select { font-size:1rem; }
    .fab{ position:fixed; bottom:18px; left:18px; z-index:60; border-radius:999px; width:64px;
height:64px; display:flex; align-items:center; justify-content:center; box-shadow:0 10px 20px rgba(0,0,0,0.12); }
    .small-muted{ color:var(--muted); font-size:.9rem; }
    .hidden{ display:none; }
  </style>
</head>
<body>

<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/kesher-bakir/firebase-messaging-sw.js')
      .then(()=>console.log('SW registered (github pages path).'))
      .catch(e=>console.warn('SW register failed', e));
  }
</script>

<header class="bg-white shadow sticky top-0 z-50">
  <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
    <div class="flex items-center gap-3">
      <img id="siteLogo" src="https://images.unsplash.com/photo-1524504388940-b1c1722653e1?q=80&w=80&auto=format&fit=crop&ixlib=rb-4.0.3&s=3d6c2b2b5d3af9c1b8f8f1a5b7c4b2a1"
           alt="קהילת קשר" class="w-12 h-12 rounded-full object-cover border-2">
      <div>
        <div class="text-xl font-bold" style="color:var(--primary)">קהילת קשר</div>
        <div class="text-sm small-muted">מרחב תומך לבני 60 ומעלה</div>
      </div>
    </div>

    <div class="flex items-center gap-2">
   
    <div id="greetingText" class="text-sm small-muted mr-2"></div>

      <button class="pill bg-white border" onclick="goTo('home')">בית</button>
      <button class="pill bg-white border" onclick="goTo('forums')">פורומים</button>
      <button class="pill bg-white border" onclick="goTo('activities')">פעילויות</button>
      <button class="pill bg-white border" onclick="goTo('helpCenter')">מרכז עזרה</button>
      <button class="pill bg-white border" onclick="goTo('users')">חברים</button>

      <div class="relative">
        <button id="chatBtn" class="pill bg-white border flex items-center gap-2" onclick="goTo('chat')">
          <i class="fa-solid fa-comments"></i> צ'אט
      
     <span id="unreadBadge" class="ml-2 inline-flex items-center justify-center px-2 py-0.5 text-xs font-bold text-white bg-yellow-400 rounded-full hidden"></span>
        </button>
      </div>

      <button id="authBtn" class="pill btn-sec text-white">התחבר</button>
    </div>
  </div>
</header>

<main class="max-w-6xl mx-auto px-4 py-6" id="root"></main>

<button class="fab btn-primary card clickable" title="צ'אט מהיר" onclick="goTo('chat')" aria-label="צ'אט מהיר">
  <i class="fa-solid fa-comments" style="font-size:20px;"></i>
</button>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-messaging.js"></script>

<script>
/* ================== CONFIG - חשוב להחליף לערכים שלך ================== */
const firebaseConfig = {
  apiKey: "AIzaSyCrcxC420HW5PXGNd8M4KuclUkiJSwHreM",
  authDomain: "kesher-bakir.firebaseapp.com",
  projectId: "kesher-bakir",
  storageBucket: "kesher-bakir.appspot.com",
  messagingSenderId: "671996189455",
  appId: "1:671996189455:web:d8ee089585a852ab38fc7a",
  measurementId: "G-42EWSKFHXP"
};
/* ===================================================================== */

if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const messaging = firebase.messaging();
/* נסיון persistence */
if (db.enablePersistence) {
  db.enablePersistence().catch(err => console.warn('persistence:', err && err.code));
}

/* ========== State ========== */
const state = {
  user:null,
  screen:'home',
  users:[],
  forums:[],
  activities:[],
  helpCategories:[],
  helpRequests:[],
  chatMessages:[],
  selectedUser:null,
  cities:[],
  unreadTotal:0,
  listeners: {}
};
/* ========== Helpers ========== */
function el(html){ const d=document.createElement('div'); d.innerHTML=html; return d.firstElementChild; }
function escapeHtml(s){ return (s||'').toString().replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function getChatRoomId(a,b){ if(!a||!b) return null;
return a < b ? `${a}_${b}` : `${b}_${a}`; }
function showToast(msg){ alert(msg);
}

/* ========== Router / Render ========== */
function goTo(screen, params){ state.screen = screen; if(params) Object.assign(state, params); render(); }
function render(){
  updateHeader();
  const root = document.getElementById('root');
  try {
    switch(state.screen){
      case 'home': root.innerHTML = renderHome();
 afterHomeRender(); break;
      case 'login': root.innerHTML = renderLogin(); break;
      case 'register': root.innerHTML = renderRegister(); break;
      case 'forums': root.innerHTML = renderForums(); break;
 case 'activities': root.innerHTML = renderActivities(); break;
      case 'helpCenter': root.innerHTML = renderHelpCenter(); break;
      case 'users': root.innerHTML = renderUsers(); break;
 case 'chat': root.innerHTML = renderChat(); break;
      case 'admin': root.innerHTML = renderAdmin(); break;
      default: root.innerHTML = '<div>טעות ניווט</div>';
 }
  } catch(e){
    console.error('render error', e);
    root.innerHTML = `<div class="p-4 card">שגיאה בהצגה: ${escapeHtml(e.message)}</div>`;
 }
}

/* ========== Header updates ========== */
function updateHeader(){
  const greeting = document.getElementById('greetingText');
  if(greeting) greeting.innerText = state.user ? `שלום, ${state.user.name}${state.user.role==='admin' ?
 ' (ADMIN)' : ''}` : '';
  const authBtn = document.getElementById('authBtn');
  if(authBtn) authBtn.innerText = state.user ? 'התנתק' : 'התחבר';
  const badge = document.getElementById('unreadBadge');
  if(badge){
    badge.style.display = state.unreadTotal > 0 ? 'inline-flex' : 'none';
 badge.innerText = state.unreadTotal > 99 ? '99+' : (state.unreadTotal || '');
  }
}

/* ===================== Home ===================== */
function renderHome(){
  return `
    <section class="card overflow-hidden mb-6">
      <div class="relative">
        <img id="heroImg" src="https://images.unsplash.com/photo-1524504388940-b1c1722653e1?q=80&w=1600&auto=format&fit=crop&ixlib=rb-4.0.3&s=3d6c2b2b5d3af9c1b8f8f1a5b7c4b2a1" alt="קהילה" class="w-full h-56 object-cover" />
        <div class="absolute inset-0 bg-gradient-to-t from-black/30 to-transparent"></div>
        <div class="absolute left-6 bottom-6 text-white">
          <div class="text-2xl font-bold">ברוכים הבאים — קהילת קשר</div>
          <div class="text-sm">מרחב בטוח ותומך לבני 60 ומעלה</div>
      
    </div>
      </div>

      <div class="p-6 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
        <div class="card p-4 flex items-center gap-4 clickable" onclick="goTo('chat')">
          <div class="w-14 h-14 rounded-full bg-gradient-to-tr from-[#4EC7B6] to-[#2FB3A3] flex items-center justify-center text-white text-xl"><i class="fa-solid fa-comments"></i></div>
          <div>
            <div class="font-semibold text-lg">צ'אט</div>
            <div class="text-sm small-muted">שוחחו אחד-עם-אחד עם חברים</div>
 
          </div>
        </div>

        <div class="card p-4 flex items-center gap-4 clickable" onclick="goTo('activities')">
          <div class="w-14 h-14 rounded-full bg-gradient-to-tr from-[#FF9AA2] to-[#FF6B6B] flex items-center justify-center text-white text-xl"><i class="fa-solid fa-calendar-day"></i></div>
          <div>
            <div class="font-semibold text-lg">פעילויות</div>
            <div class="text-sm small-muted">מפגשים מקומיים וסדנאות</div>
     
          </div>
        </div>

        <div class="card p-4 flex items-center gap-4 clickable" onclick="goTo('forums')">
          <div class="w-14 h-14 rounded-full bg-gradient-to-tr from-[#A0D8EF] to-[#6FBDE8] flex items-center justify-center text-white text-xl"><i class="fa-solid fa-users"></i></div>
          <div>
            <div class="font-semibold text-lg">פורומים</div>
            <div class="text-sm small-muted">שאלות, עצות וחוויות</div>
         
   </div>
        </div>

        <div class="card p-4 flex items-center gap-4 clickable" onclick="goTo('helpCenter')">
          <div class="w-14 h-14 rounded-full bg-gradient-to-tr from-[#FFD27A] to-[#FFCD4D] flex items-center justify-center text-white text-xl"><i class="fa-solid fa-hands-helping"></i></div>
          <div>
            <div class="font-semibold text-lg">מרכז עזרה</div>
            <div class="text-sm small-muted">פנו לעזרה משפטית, טפסים, תמיכה טכנית ועוד</div>
        
    </div>
        </div>

        <div class="card p-4 col-span-full">
          <div class="flex items-center justify-between">
            <div>
              <div class="text-lg font-bold">טיפ יומי</div>
              <div id="dailyTipContainer" class="text-md small-muted mt-2">טוען...</div>
            </div>
       
         <div>
              <button id="refreshTipBtnHeader" class="pill btn-primary">טען טיפ אחר</button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="grid lg:grid-cols-2 gap-4">
      <div class="card p-4">
        <h3 class="font-semibold mb-3">פורומים אחרונים</h3>
        <div id="forumsListSmall">טוען...</div>
 
      </div>

      <div class="card p-4">
        <h3 class="font-semibold mb-3">פעילויות קרובות</h3>
        <div id="activitiesListSmall">טוען...</div>
      </div>
    </section>
  `;
}
function afterHomeRender(){
  // safe update of daily tip
  renderDailyTipSafe();
  renderForumsSmall();
  renderActivitiesSmall();
}

/* ===================== Login/Register ===================== */
function renderLogin(){
  return `
    <div class="card p-6 max-w-md mx-auto">
      <h2 class="text-xl font-bold mb-2">התחברות</h2>
      <div class="mb-2"><label class="text-sm">אימייל</label><input id="loginEmail" type="email" class="w-full p-2 border rounded" /></div>
      <div class="mb-4"><label class="text-sm">סיסמה</label><input id="loginPwd" type="password" class="w-full p-2 border rounded" /></div>
      <div class="flex gap-2 justify-end">
        <button class="pill bg-white border" onclick="goTo('home')">בטל</button>
        <button class="pill btn-primary" onclick="doLogin()">התחבר</button>
      </div>
      <div 
 class="mt-4 text-sm small-muted">אין לך חשבון? <button class="text-blue-600 underline" onclick="goTo('register')">הרשם כאן</button></div>
    </div>
  `;
}
function renderRegister(){
  const hobbies = ['טיולים','קריאה','גינון','בישול','שירה/מוסיקה','יצירה','ספורט עדין','משחקי קופסה','תפירה'];
  const contributions = ['עזרה טכנית','מילוי טפסים','ייעוץ משפטי','הסעה/קניות','הדרכה/הוראה','בישול ליומיים','סיוע רגשי'];
  return `
    <div class="card p-6 max-w-2xl mx-auto">
      <h2 class="text-xl font-bold mb-3">הרשמה</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div><label class="text-sm">שם מלא</label><input id="regName" class="w-full p-2 border rounded" /></div>
        <div><label class="text-sm">שם משתמש</label><input id="regUsername" class="w-full p-2 border rounded" /></div>
        <div><label class="text-sm">אימייל</label><input id="regEmail" type="email" class="w-full p-2 border rounded" /></div>
        <div><label class="text-sm">סיסמה</label><input id="regPwd" type="password" class="w-full p-2 border rounded" /></div>
        
 <div><label class="text-sm">גיל</label><input id="regAge" type="number" min="18" class="w-full p-2 border rounded" /></div>
        <div><label class="text-sm">עיר / ישוב</label>
          <select id="regCity" class="w-full p-2 border rounded">
            <option value="">בחר/י</option>
            <option value="תושב חו\"ל">תושב חו\"ל</option>
            <option value="תל אביב">תל אביב</option>
            <option value="ירושלים">ירושלים</option>
         
    <option value="חיפה">חיפה</option>
            <option value="באר שבע">באר שבע</option>
            <option value="ראשון לציון">ראשון לציון</option>
            <option value="נצרת">נצרת</option>
            <option value="אחר">אחר</option>
          </select>
        </div>

        <div class="md:col-span-2">
          <label class="text-sm">תחביבים (בחרו 
 מספר)</label>
          <div id="hobbiesList" class="grid grid-cols-2 gap-2 mt-2">
            ${hobbies.map(h=>`<label class="inline-flex items-center gap-2 border p-2 rounded"><input type="checkbox" value="${escapeHtml(h)}" /> ${escapeHtml(h)}</label>`).join('')}
            <label class="inline-flex items-center gap-2 border p-2 rounded"><input id="hobbyOtherChk" type="checkbox" value="אחר" /> אחר: <input id="hobbyOtherText" placeholder="כתוב..." class="ml-2 p-1 border rounded" /></label>
          </div>
        </div>

        <div class="md:col-span-2">
     
          <label class="text-sm">במה תוכל/י לתרום לקבוצה?</label>
          <div id="contribList" class="grid grid-cols-2 gap-2 mt-2">
            ${contributions.map(c=>`<label class="inline-flex items-center gap-2 border p-2 rounded"><input type="checkbox" value="${escapeHtml(c)}" /> ${escapeHtml(c)}</label>`).join('')}
            <label class="inline-flex items-center gap-2 border p-2 rounded"><input id="contribOtherChk" type="checkbox" value="אחר" /> אחר: <input id="contribOtherText" placeholder="כתוב..." class="ml-2 p-1 border rounded" /></label>
          </div>
        </div>

     
    <div class="md:col-span-2">
          <label class="text-sm">תמונת פרופיל (אופציונלי) — העלה תמונה או בחר אימוג'י</label>
          <div class="mt-2 flex gap-2 items-center">
            <input id="profileImage" type="file" accept="image/*" />
            <input id="emojiChoice" placeholder="הקלד אימוג'י..." class="p-2 border rounded w-32" />
          </div>
        </div>

        <div 
 class="md:col-span-2">
          <label class="inline-flex items-center gap-2"><input id="agreeRules" type="checkbox" /> אני מאשר/ת את <a href="#" onclick="showRules()" class="text-blue-600 underline">תקנון השימוש</a> ואת כללי ההתנהגות</label>
          <div class="text-sm small-muted mt-2">על ידי ההרשמה אתה מאשר כי המידע נכון ומסכים לתנאי הקהילה.</div>
        </div>
      </div>

      <div class="mt-4 flex justify-end gap-2">
        <button class="pill bg-white border" onclick="goTo('home')">ביטול</button>
        <button class="pill btn-primary" onclick="doRegister()">הרשם</button>
  
     </div>
    </div>
  `;
}

/* ===================== Forums ===================== */
function renderForums(){
  return `
    <div class="card p-4">
      <div class="flex items-center justify-between mb-3">
        <div><h3 class="text-lg font-semibold">פורומים</h3><div class="text-sm small-muted">שאלות, עצות וחוויות</div></div>
        <div class="flex gap-2">
          <input id="forumSearch" class="p-2 border rounded" placeholder="חפש..." oninput="searchForums()" />
          ${state.user && state.user.role==='admin' ?
 `<button class="pill btn-sec" onclick="showCreateForumModal()">צור פורום</button>` : ''}
        </div>
      </div>

      <div id="forumsFullList"></div>

      <div id="createForumModal" class="fixed inset-0 bg-black/30 hidden items-center justify-center z-50">
        <div class="bg-white p-6 rounded w-full max-w-lg card">
          <h4 class="font-semibold mb-2">צור פורום חדש</h4>
          <input id="newForumTitle" placeholder="כותרת" class="w-full p-2 border rounded mb-2" />
          <textarea id="newForumDesc" placeholder="תיאור" 
 class="w-full p-2 border rounded mb-2"></textarea>
          <div class="flex gap-2 justify-end">
            <button class="pill bg-white border" onclick="hideCreateForumModal()">ביטול</button>
            <button class="pill btn-primary" onclick="createForum()">צור</button>
          </div>
        </div>
      </div>
    </div>
  `;
}

/* ===================== Activities ===================== */
function renderActivities(){
  return `
    <div class="card p-4">
      <div class="flex items-center justify-between mb-3">
        <div><h3 class="text-lg font-semibold">פעילויות</h3><div class="text-sm small-muted">רשום/י לפעילויות קרובות</div></div>
        <div>
          ${state.user ?
 `<button class="pill btn-primary" onclick="showCreateActivityModal()">הוסף פעילות</button>` : `<button class="pill bg-white border" onclick="goTo('login')">התחבר כדי להוסיף</button>`}
        </div>
      </div>

      <div id="activitiesFullList"></div>

      <div id="createActivityModal" class="fixed inset-0 bg-black/30 hidden items-center justify-center z-50">
        <div class="bg-white p-6 rounded w-full max-w-lg card">
          <h4 class="font-semibold mb-2">הוספת פעילות</h4>
          <input id="actTitle" placeholder="כותרת" class="w-full p-2 border 
 rounded mb-2" />
          <input id="actDate" type="date" class="w-full p-2 border rounded mb-2" />
          <input id="actLocation" placeholder="מיקום" class="w-full p-2 border rounded mb-2" />
          <input id="actCapacity" type="number" placeholder="כמות מקומות (ריק = ללא הגבלה)" class="w-full p-2 border rounded mb-2" />
          <textarea id="actDesc" placeholder="תיאור" class="w-full p-2 border rounded mb-2"></textarea>
          <div class="flex gap-2 justify-end">
        
          <button class="pill bg-white border" onclick="hideCreateActivityModal()">ביטול</button>
            <button class="pill btn-primary" onclick="createActivity()">שמור</button>
          </div>
        </div>
      </div>
    </div>
  `;
}

/* ===================== Help Center ===================== */
function renderHelpCenter(){
  return `
    <div class="card p-4">
      <div class="flex items-center justify-between mb-3">
        <div><h3 class="text-lg font-semibold">מרכז עזרה</h3><div class="text-sm small-muted">הפורום מיועד לעזרה על בסיס קהילתי בלבד — אין בכך ייעוץ מקצועי מטעם בעלי האתר.</div></div>
        <div>
          ${state.user ?
 `<button class="pill btn-primary" onclick="showHelpModal()">שלח בקשה</button>` : `<button class="pill bg-white border" onclick="goTo('login')">התחבר</button>`}
          ${state.user && state.user.role==='admin' ?
 `<button class="pill btn-sec ml-2" onclick="goTo('admin')">ניהול מרכז עזרה</button>` : ''}
        </div>
      </div>

      <div class="grid md:grid-cols-3 gap-3 mb-4" id="helpCategoriesGrid"></div>

      <div id="helpRequestsList"></div>

      <div id="helpModal" class="fixed inset-0 bg-black/30 hidden items-center justify-center z-50">
        <div class="bg-white p-6 rounded w-full max-w-lg card">
          <h4 class="font-semibold mb-2">שגר בקשה לעזרה</h4>
         
 <label class="text-sm small-muted">בחר קטגוריה</label>
          <select id="helpCatSelect" class="w-full p-2 border rounded mb-2"></select>
          <input id="helpTitle" placeholder="כותרת" class="w-full p-2 border rounded mb-2" />
          <textarea id="helpBody" placeholder="תאר/י את הבקשה" class="w-full p-2 border rounded mb-2"></textarea>
          <div class="flex gap-2 justify-end">
            <button class="pill bg-white border" onclick="hideHelpModal()">ביטול</button>
            <button class="pill 
 btn-primary" onclick="submitHelpRequest()">שלח</button>
          </div>
        </div>
      </div>
    </div>
  `;
}

/* ===================== Users ===================== */
function renderUsers(){
  return `
    <div class="card p-4">
      <div class="flex items-center justify-between mb-3">
        <div><h3 class="text-lg font-semibold">חברים</h3><div class="text-sm small-muted">סינון לפי עיר / חיפוש</div></div>
        <div class="flex gap-2">
          <select id="cityFilter" class="p-2 border rounded" onchange="renderUsersList()"><option value="">הכל</option></select>
          <input id="userSearch" placeholder="חפש שם..." class="p-2 border rounded" oninput="renderUsersList()" />
        </div>
      </div>
  
     <div id="usersList"></div>
    </div>
  `;
}

/* ===================== Chat ===================== */
function renderChat(){
  if(!state.user) return `<div class="card p-4">אנא התחבר כדי להשתמש בצ'אט</div>`;
  return `
    <div class="card p-4 flex flex-col" style="height:70vh;">
      <div class="flex items-center justify-between mb-3">
        <div><h3 class="text-lg font-semibold">צ'אט</h3><div class="text-sm small-muted">סנן משתמשים לפי עיר או חפש שם</div></div>
        <div><button class="pill bg-white border" onclick="goTo('users')">חזור</button></div>
      </div>

      <div class="flex gap-4 h-full">
        <div class="w-1/3 border rounded p-2 overflow-y-auto">
          <div class="mb-2"><select id="chatCityFilter" class="w-full p-2 border rounded" onchange="renderChatUsersList()"><option value="">הכל</option></select></div>
    
          <div id="chatUsersList"></div>
        </div>

        <div class="flex-1 flex flex-col">
          <div id="chatBox" class="flex-grow overflow-y-auto p-3 space-y-3 bg-gray-50 rounded"></div>
          <div class="mt-3 flex gap-2 items-center">
            <input id="chatInput" type="text" placeholder="כתוב הודעה..." class="flex-grow p-3 border rounded" onkeydown="if(event.key==='Enter') sendMessage()" />
            <button class="pill btn-primary" onclick="sendMessage()">שלח</button>
     
          </div>
        </div>
      </div>
    </div>
  `;
}

/* ===================== Admin ===================== */
function renderAdmin(){
  if(!state.user || state.user.role !== 'admin') return goTo('home');
  return `
    <div class="card p-4">
      <h3 class="text-lg font-semibold mb-3">לוח ניהול</h3>

      <div class="grid md:grid-cols-2 gap-4">
        <div class="p-3 border rounded">
          <h4 class="font-semibold mb-2">משתמשים</h4>
          <div id="adminUsersList"></div>
        </div>

        <div class="p-3 border rounded">
          <h4 class="font-semibold mb-2">ניהול מרכז עזרה - קטגוריות</h4>
     
          <div class="flex gap-2 mb-3"><input id="newHelpCat" placeholder="שם קטגוריה" class="p-2 border rounded" /><button class="pill btn-primary" onclick="createHelpCategory()">הוסף</button></div>
          <div id="adminHelpCats"></div>
        </div>
      </div>

      <div class="mt-4 p-3 border rounded">
        <h4 class="font-semibold mb-2">ניהול פעילויות & דיווחים</h4>
        <div id="adminActivities"></div>
      </div>
    </div>
  `;
}

/* ===================== Data fetch / sync ===================== */

async function fetchInitial(){
  // fetch essential collections.
  try {
    // users
    const usersSnap = await db.collection('users').get();
 state.users = usersSnap.docs.map(d=>({ id:d.id, ...d.data() }));

    // forums
    try {
      const forumsSnap = await db.collection('forums').get();
 state.forums = forumsSnap.docs.map(d=>({ id:d.id, ...d.data() }));
    } catch(e){ console.warn('forums fetch failed', e); state.forums = [];
 }

    // activities
    try {
      const actsSnap = await db.collection('activities').get();
 state.activities = actsSnap.docs.map(d=>({ id:d.id, ...d.data() }));
    } catch(e){ console.warn('activities fetch failed', e); state.activities = [];
 }

    // helpCategories (helpCenter)
    try {
      const helpSnap = await db.collection('helpCenter').get();
 state.helpCategories = helpSnap.docs.map(d=>({ id:d.id, ...d.data() }));
    } catch(e){ console.warn('helpCenter fetch failed', e); state.helpCategories = [];
 }

    // daily tips
    try {
      const tipsSnap = await db.collection('dailyTips').get();
 state.dailyTips = tipsSnap.docs.map(d=>({ id:d.id, ...d.data() }));
    } catch(e){ console.warn('dailyTips fetch failed', e); state.dailyTips = [];
 }

    // populate cities
    state.cities = Array.from(new Set(state.users.map(u=>u.city).filter(Boolean))).sort();
    populateCityFilters();
 // update header/unread
    if(state.user) updateUnreadTotal();

  } catch(err){
    console.error('fetchInitial critical error', err);
 // if a permissions error occurs, show a clear message in UI
    if(err && err.code && err.code.includes && err.code.includes('permission')) {
      document.getElementById('root').innerHTML = `<div class="card p-4 text-red-600">שגיאת הרשאות ב-Firestore: אין גישה לאוספים.
 ודא שה־Rules נכונים ושהמשתמש מחובר.</div>`;
    }
  }
}

/* ===================== Render helpers ===================== */

function renderForumsSmall(){ const el=document.getElementById('forumsListSmall'); if(!el) return;
 el.innerHTML = (state.forums||[]).slice(0,4).map(f=>`<div class="p-3 border rounded mb-2"><div class="font-semibold">${escapeHtml(f.title)}</div><div class="text-sm small-muted">${escapeHtml(f.description||'')}</div><div class="mt-2"><button class="pill btn-primary" onclick="openForum('${f.id}')">פתח</button></div></div>`).join('') || '<div class="text-gray-500">אין פורומים</div>';
}
function renderActivitiesSmall(){ const el=document.getElementById('activitiesListSmall'); if(!el) return; el.innerHTML = (state.activities||[]).slice(0,4).map(a=>`<div class="p-3 border rounded mb-2"><div class="font-semibold">${escapeHtml(a.title)}</div><div class="text-sm small-muted">${escapeHtml(a.location||'')}</div><div class="mt-2"><button class="pill btn-primary" onclick="openActivity('${a.id}')">פתח</button></div></div>`).join('') ||
 '<div class="text-gray-500">אין פעילויות</div>'; }

function renderUsersList(){
  const q = document.getElementById('userSearch') ? document.getElementById('userSearch').value.trim().toLowerCase() : '';
  const city = document.getElementById('cityFilter') ?
 document.getElementById('cityFilter').value : '';
  const list = (state.users||[]).filter(u => (city? u.city===city : true) && (q? (u.name||'').toLowerCase().includes(q) : true) && u.isActive!==false);
  const el = document.getElementById('usersList'); if(!el) return;
  if(!list.length){ el.innerHTML = '<div class="text-gray-500">אין משתמשים</div>'; return;
 }
  el.innerHTML = list.map(u=>`<div class="p-3 border rounded mb-2 flex items-center justify-between"><div class="flex items-center gap-3"><div class="w-12 h-12 rounded-full bg-gray-200 flex items-center justify-center text-xl">${u.avatarEmoji|| (u.name||'א').charAt(0)}</div><div><div class="font-semibold">${escapeHtml(u.name)}</div><div class="text-sm small-muted">${escapeHtml(u.city||'')}</div><div class="text-sm small-muted">תחביבים: ${escapeHtml((u.hobbies||[]).join(', '))}</div></div></div><div class="flex gap-2"><button class="pill btn-primary" onclick="openChat('${u.id}','${escapeHtml(u.name)}')">צ'אט</button>${state.user && state.user.role==='admin'?`<button class="pill bg-red-400" onclick="adminDeleteUser('${u.id}')">מחק</button>`:''}</div></div>`).join('');
}

/* Chat users list (left pane) */
function renderChatUsersList(){
  const city = document.getElementById('chatCityFilter') ? document.getElementById('chatCityFilter').value : '';
  const list = (state.users||[]).filter(u => (city? u.city===city : true) && u.id !== (state.user? state.user.id : '') && u.isActive!==false);
  const el = document.getElementById('chatUsersList'); if(!el) return;
  el.innerHTML = list.map(u=>`<div class="p-2 border-b flex items-center justify-between clickable" onclick="openChat('${u.id}','${escapeHtml(u.name)}')"><div>${escapeHtml(u.name)} <div class="text-xs small-muted">${escapeHtml(u.city||'')}</div></div><div>${u.isOnline?'<span class="text-green-600 text-xs">מחובר</span>':'<span class="text-gray-400 text-xs">לא מחובר</span>'}</div></div>`).join('');
}

/* ===================== Chat realtime ===================== */
let currentChatUnsub = null;
function openChat(userId, userName){ if(!state.user) { goTo('login'); return;
 } state.selectedUser = state.users.find(u=>u.id===userId) || { id:userId, name:userName }; const roomId = getChatRoomId(state.user.id, state.selectedUser.id);
 // reset unread for this user in that room db.collection('chats').doc(roomId).update({ [`unread_${state.user.id}`]: 0 }).catch(()=>{}); state.chatMessages = []; if(currentChatUnsub) currentChatUnsub();
 currentChatUnsub = db.collection('chats').doc(roomId).collection('messages').orderBy('timestamp') .onSnapshot(snap=>{ state.chatMessages = snap.docs.map(d=>({ id:d.id, ...d.data() })); if(state.screen !== 'chat'){ state.screen='chat'; render(); } updateChatBox(); updateUnreadTotal(); }, err=>{ console.error('chat listen err', err); });
}
function updateChatBox(){ const cb = document.getElementById('chatBox'); if(!cb) return; cb.innerHTML = (state.chatMessages||[]).map(m=>{ const isMe = m.senderId === state.user.id; const time = m.timestamp && m.timestamp.toDate ? new Date(m.timestamp.toDate()).toLocaleTimeString() : ''; return `<div class="${isMe? 'text-right':'text-left'}"><div class="inline-block p-2 rounded-lg ${isMe?'bg-blue-200':'bg-gray-200'} max-w-xs"><div class="text-xs small-muted mb-1">${isMe?'אני':state.selectedUser.name||'משתמש'}</div><div>${escapeHtml(m.body)}</div><div class="text-xs small-muted mt-1 text-right">${time}</div></div></div>`; }).join(''); cb.scrollTop = cb.scrollHeight;
}
async function sendMessage(){ const input = document.getElementById('chatInput'); const text = input.value.trim(); if(!text || !state.selectedUser || !state.user) return; input.value = ''; const roomId = getChatRoomId(state.user.id, state.selectedUser.id); await db.collection('chats').doc(roomId).collection('messages').add({ senderId: state.user.id, receiverId: state.selectedUser.id, body: text, timestamp: firebase.firestore.FieldValue.serverTimestamp() }); // Increment unread counter for the receiver const receiverUnreadKey = `unread_${state.selectedUser.id}`; await db.collection('chats').doc(roomId).set({ [receiverUnreadKey]: firebase.firestore.FieldValue.increment(1) }, { merge: true }).catch(()=>{}); // Send notification if supported if(state.selectedUser.fcmToken) sendFCM(state.selectedUser.fcmToken, 'הודעה חדשה', text);
}

/* ===================== FCM Server Side (for Push) ===================== */
async function sendFCM(token, title, body){ /* This function requires a server-side component (Cloud Function)
 to send the actual push notification. For now, it only logs the action. */ console.log(`FCM simulated: Send to ${token} | ${title}: ${body}`);
}

/* ===================== Unread Logic ===================== */
let unreadUnsub = null;
auth.onAuthStateChanged(user=>{
  if(user && !unreadUnsub){
    unreadUnsub = db.collection('chats').onSnapshot(snap=>{ updateUnreadTotal(); }, err=>console.error('unread listen err', err));
  } else if(!user && unreadUnsub){
    unreadUnsub();
    unreadUnsub = null;
  }
});

async function updateUnreadTotal(){ try { if(!state.user) { state.unreadTotal = 0; updateHeader(); return; } const snaps = await db.collection('chats').get(); let total = 0; snaps.forEach(d=>{ const key = `unread_${state.user.id}`; total += d.data()[key] || 0; }); state.unreadTotal = total; updateHeader();
 } catch(e){ console.warn('updateUnreadTotal', e); } }

/* ===================== Forums functions ===================== */
function showCreateForumModal(){ document.getElementById('createForumModal').classList.remove('hidden'); }
function hideCreateForumModal(){ document.getElementById('createForumModal').classList.add('hidden');
}
async function createForum(){ const title = document.getElementById('newForumTitle').value.trim(); const desc = document.getElementById('newForumDesc').value.trim(); if(!title) return alert('הזן כותרת');
 try { const doc = await db.collection('forums').add({ title, description: desc, createdAt: firebase.firestore.FieldValue.serverTimestamp() }); state.forums.unshift({ id: doc.id, title, description: desc });
 hideCreateForumModal(); render(); } catch(e){ console.error('createForum', e); alert('שגיאה'); } }
function searchForums(){ const q = document.getElementById('forumSearch').value.trim().toLowerCase();
 const arr = (state.forums||[]).filter(f => !q || (f.title && f.title.toLowerCase().includes(q)) || (f.description && f.description.toLowerCase().includes(q))); const el = document.getElementById('forumsFullList'); if(!el) return;
 el.innerHTML = arr.map(f=>`<div class="p-3 border rounded mb-2"><div class="font-semibold">${escapeHtml(f.title)}</div><div class="text-sm small-muted">${escapeHtml(f.description||'')}</div><div class="mt-2"><button class="pill btn-primary" onclick="openForum('${f.id}')">פתח</button>${state.user && state.user.role==='admin'?` <button class="pill bg-red-400" onclick="deleteForum('${f.id}')">מחק</button>`:''}</div></div>`).join('');
}
async function openForum(id){ try { const doc = await db.collection('forums').doc(id).get(); if(!doc.exists) return alert('פורום לא קיים'); const data = doc.data();
 const postsSnap = await db.collection('forums').doc(id).collection('posts').orderBy('createdAt','desc').get(); const posts = postsSnap.docs.map(d=>({ id:d.id, ...d.data() }));
 const html = `<div class="p-4"><div class="flex justify-between items-center mb-3"><div><h3 class="font-semibold">${escapeHtml(data.title)}</h3><div class="text-sm small-muted">${escapeHtml(data.description||'')}</div></div><div><button class="pill bg-white border" onclick="render()">חזור</button></div></div><div class="mb-3"><button class="pill btn-primary" onclick="createPostPrompt('${id}')">צור פוסט</button></div><div>${posts.map(p=>`<div class="p-3 border rounded mb-2"><div class="font-semibold">${escapeHtml(p.title)}</div><div class="text-sm">${escapeHtml(p.body)}</div><div class="text-xs small-muted mt-2">${p.createdAt? new Date(p.createdAt.seconds*1000).toLocaleString():''}</div><div class="mt-2"><button class="pill bg-white border" onclick="showComments('${id}','${p.id}')">תגובות</button> ${state.user && state.user.role==='admin'?`<button class="pill bg-red-400" onclick="deletePost('${id}','${p.id}')">מחק</button>`:''}</div></div>`).join('')}</div></div>`;
 document.getElementById('root').innerHTML = `<div class="card p-4">${html}</div>`; } catch(e){ console.error('openForum', e); alert('שגיאה בטעינת פורום');
 } }
async function deleteForum(id){ if(!confirm('מחק פורום?')) return; await db.collection('forums').doc(id).delete(); state.forums = state.forums.filter(f=>f.id!==id); render();
}
async function createPostPrompt(forumId){ const title = prompt('כותרת הפוסט:'); if(!title) return; const body = prompt('תוכן הפוסט:'); if(!body) return;
 await db.collection('forums').doc(forumId).collection('posts').add({ title, body, authorId: state.user? state.user.id : null, createdAt: firebase.firestore.FieldValue.serverTimestamp() }); openForum(forumId);
}
async function deletePost(forumId, postId){ if(!confirm('מחק פוסט?')) return; await db.collection('forums').doc(forumId).collection('posts').doc(postId).delete(); openForum(forumId);
}
async function showComments(forumId, postId){ const commentsSnap = await db.collection('forums').doc(forumId).collection('posts').doc(postId).collection('comments').orderBy('createdAt').get(); const comments = commentsSnap.docs.map(d=>({ id:d.id, ...d.data() })); const html = `<div class="p-4"><h4 class="font-semibold mb-3">תגובות</h4>${comments.map(c=>`<div class="p-2 border rounded mb-1"><div class="text-sm small-muted">${c.authorName||'משתמש'}:</div><div>${escapeHtml(c.body)}</div><div class="text-xs small-muted mt-1">${c.createdAt? new Date(c.createdAt.seconds*1000).toLocaleTimeString():''}</div></div>`).join('')}</div><div class="mt-3 flex gap-2"><input id="commentInput" placeholder="כתוב תגובה..." class="flex-grow p-2 border rounded" /><button class="pill btn-primary" onclick="submitComment('${forumId}','${postId}',document.getElementById('commentInput').value)">שלח</button></div><div class="mt-3"><button class="pill bg-white border" onclick="openForum('${forumId}')">חזור לפוסט</button></div>`; document.getElementById('root').innerHTML = `<div class="card p-4">${html}</div>`;
}
async function submitComment(forumId, postId, body){ if(!body.trim() || !state.user) return; await db.collection('forums').doc(forumId).collection('posts').doc(postId).collection('comments').add({ authorId: state.user.id, authorName: state.user.name, body: body.trim(), createdAt: firebase.firestore.FieldValue.serverTimestamp() }); showComments(forumId, postId);
}

/* ===================== Activity functions ===================== */
function showCreateActivityModal(){ document.getElementById('createActivityModal').classList.remove('hidden'); }
function hideCreateActivityModal(){ document.getElementById('createActivityModal').classList.add('hidden');
}
async function createActivity(){ const title = document.getElementById('actTitle').value.trim(); const date = document.getElementById('actDate').value.trim(); const location = document.getElementById('actLocation').value.trim(); const capacity = parseInt(document.getElementById('actCapacity').value) || null; const desc = document.getElementById('actDesc').value.trim(); if(!title || !date || !location || !desc) return alert('מלא את כל השדות');
 const doc = await db.collection('activities').add({ title, date, location, capacity, description: desc, ownerId: state.user ? state.user.id : null, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
state.activities.unshift({ id: doc.id, title, date, location, capacity, description: desc, ownerId: state.user?state.user.id:null }); hideCreateActivityModal(); render(); } catch(e){ console.error(e); alert('שגיאה ביצירת פעילות');
 } }
async function openActivity(id){ const doc = await db.collection('activities').doc(id).get(); if(!doc.exists) return alert('פעילות לא קיימת'); const data = doc.data();
 const attendeesSnap = await db.collection('activities').doc(id).collection('attendees').get(); const attendees = attendeesSnap.docs.map(d=>({ id:d.id, ...d.data() })); const taken = attendees.length;
 const spotsText = data.capacity ? `${taken} / ${data.capacity}` : 'ללא הגבלה';
 let html = `<div class="p-4"><div class="flex justify-between items-center mb-3"><div><h3 class="font-semibold">${escapeHtml(data.title)}</h3><div class="text-sm small-muted">${escapeHtml(data.location||'')} • ${spotsText}</div></div><div><button class="pill bg-white border" onclick="render()">חזור</button></div></div><div class="mb-3"><div class="text-sm">${escapeHtml(data.description||'')}</div></div><div class="mb-3"><div class="font-semibold">משתתפים</div>${attendees.map(a=>`<div class="p-2 border rounded mb-1">${escapeHtml(a.name || a.email)}</div>`).join('')}</div><div class="flex gap-2">`;
 if(state.user){ const isAtt = attendees.some(a=>a.id===state.user.id); if(isAtt) html += `<button class="pill bg-white border" onclick="leaveActivity('${id}')">עזוב פעילות</button>`;
 else html += `<button class="pill btn-primary" onclick="joinActivity('${id}', ${data.capacity || 'null'})">הירשם</button>`;
 if(state.user.id === data.ownerId || state.user.role==='admin'){ html += `<button class="pill btn-sec" onclick="messageActivity('${id}')">שלח הודעה לרשומים</button>`;
 } } else { html += `<button class="pill bg-white border" onclick="goTo('login')">התחבר כדי להרשם</button>`; } html += `</div></div>`;
 document.getElementById('root').innerHTML = `<div class="card p-4">${html}</div>`; }
async function joinActivity(id, capacity){ if(!state.user) return goTo('login'); const attendeesRef = db.collection('activities').doc(id).collection('attendees');
 const snap = await attendeesRef.get(); if(capacity && snap.size >= capacity) return alert('הפעילות מלאה'); await attendeesRef.doc(state.user.id).set({ name: state.user.name, email: state.user.email }); openActivity(id);
}
async function leaveActivity(id){ if(!state.user) return; await db.collection('activities').doc(id).collection('attendees').doc(state.user.id).delete(); openActivity(id);
}
async function deleteActivity(id){ if(!confirm('מחק פעילות?')) return; await db.collection('activities').doc(id).delete(); state.activities = state.activities.filter(a=>a.id!==id); render();
}

/* ===================== Help Center functions ===================== */
function showHelpModal(){ populateHelpCatSelect(); document.getElementById('helpModal').classList.remove('hidden'); }
function hideHelpModal(){ document.getElementById('helpModal').classList.add('hidden'); }
function populateHelpCatSelect(){ const sel=document.getElementById('helpCatSelect'); if(!sel) return; sel.innerHTML = (state.helpCategories||[]).map(c=>`<option value="${c.id}">${escapeHtml(c.title)}</option>`).join('');
}
async function submitHelpRequest(){ if(!state.user) return goTo('login'); const cat = document.getElementById('helpCatSelect').value; const title = document.getElementById('helpTitle').value.trim(); const body = document.getElementById('helpBody').value.trim(); if(!cat || !title || !body) return alert('מלא את כל השדות');
 await db.collection('helpRequests').add({ categoryId: cat, title, body, authorId: state.user? state.user.id : null, status:'open', createdAt: firebase.firestore.FieldValue.serverTimestamp() }); alert('הבקשה נשלחה לקהילה'); hideHelpModal(); fetchInitial();
}
/* admin help categories */
async function createHelpCategory(){ const name = document.getElementById('newHelpCat').value.trim(); if(!name) return alert('הזן שם קטגוריה');
 const doc = await db.collection('helpCenter').add({ title: name }); state.helpCategories.push({ id: doc.id, title: name }); render();
}
async function deleteHelpCategory(id){ if(!confirm('מחק קטגוריה?')) return; await db.collection('helpCenter').doc(id).delete(); state.helpCategories = state.helpCategories.filter(c=>c.id!==id); render();
}
/* ===================== Registration / Auth ===================== */
async function doRegister(){ const name = document.getElementById('regName').value.trim(); const username = document.getElementById('regUsername').value.trim();
 const email = document.getElementById('regEmail').value.trim(); const pwd = document.getElementById('regPwd').value; const age = parseInt(document.getElementById('regAge').value); const city = document.getElementById('regCity').value; const agree = document.getElementById('agreeRules').checked;
 if(!name || !email || !pwd || !age || !agree) return alert('מלא את כל השדות והסכום לתקנון');
 const hobbyChecks = Array.from(document.querySelectorAll('#hobbiesList input[type=checkbox]')).filter(i=>i.checked).map(i=>i.value); const hobbyOther = document.getElementById('hobbyOtherChk') && document.getElementById('hobbyOtherChk').checked ? document.getElementById('hobbyOtherText').value.trim() : ''; const hobbies = hobbyOther ?
 [...hobbyChecks.filter(h=>'אחר'!==h), hobbyOther] : hobbyChecks; const contribChecks = Array.from(document.querySelectorAll('#contribList input[type=checkbox]')).filter(i=>i.checked).map(i=>i.value); const contribOther = document.getElementById('contribOtherChk') && document.getElementById('contribOtherChk').checked ? document.getElementById('contribOtherText').value.trim() : '';
 const contributions = contribOther ? [...contribChecks.filter(c=>'אחר'!==c), contribOther] : contribChecks; if(age < 60) return alert('הרשמה מוגבלת לגיל 60 ומעלה. אם יש צורך בשינוי פנה למנהל.');
 try { const cred = await auth.createUserWithEmailAndPassword(email, pwd); const uid = cred.user.uid; await db.collection('users').doc(uid).set({ name, username:username||name, email, age, city, hobbies, contributions, role: (email==='meircha.ai@gmail.com')?'admin':'user', isActive:true, joinDate: firebase.firestore.FieldValue.serverTimestamp() }); goTo('home'); } catch(e){ console.error('register error', e); alert(`שגיאה בהרשמה: ${e.message}`); }
}
async function doLogin(){ const email = document.getElementById('loginEmail').value.trim(); const pwd = document.getElementById('loginPwd').value; if(!email || !pwd) return alert('הזן אימייל וסיסמה'); try { await auth.signInWithEmailAndPassword(email, pwd); goTo('home'); } catch(e){ console.error('login error', e); alert(`שגיאה בהתחברות: ${e.message}`); }
}
function showRules(){ document.getElementById('rulesModal').classList.remove('hidden'); }
function hideRules(){ document.getElementById('rulesModal').classList.add('hidden'); }
/* admin functions */
async function adminDeleteUser(userId){ if(!confirm('מחק משתמש לצמיתות?')) return; await db.collection('users').doc(userId).delete(); state.users = state.users.filter(u=>u.id!==userId); render();
}
/* admin functions - promote to senior */
async function adminPromoteToSenior(userId){ const perms = prompt('רשום הרשאות עבור משתמש בכיר (comma-separated): deleteComments, manageForums, manageActivities, handleHelpRequests', 'deleteComments,manageForums');
 const arr = perms ? perms.split(',').map(s=>s.trim()) : []; await db.collection('users').doc(userId).update({ role: 'senior', seniorPermissions: arr }); alert('עודכן'); fetchInitial();
}

/* ===================== Auth state / presence ===================== */
auth.onAuthStateChanged(async user=>{ if(user){ // ensure user doc exists const docRef = db.collection('users').doc(user.uid); const docSnap = await docRef.get(); if(!docSnap.exists){ await docRef.set({ name: user.email.split('@')[0], email:user.email, role: (user.email==='meircha.ai@gmail.com')?'admin':'user', isActive:true, joinDate: firebase.firestore.FieldValue.serverTimestamp() }); } const d = (await docRef.get()).data(); state.user = { id:user.uid, email:user.email, name: d.name || 'משתמש', role: d.role || 'user', city: d.city || '', isActive: d.isActive!==false, avatarEmoji: d.avatarEmoji || null }; // presence await db.collection('users').doc(user.uid).update({ isOnline: true }).catch(()=>{}); window.addEventListener('beforeunload', ()=>{ db.collection('users').doc(user.uid).update({ isOnline: false }).catch(()=>{}); }); window.addEventListener('blur', ()=>{ db.collection('users').doc(user.uid).update({ isOnline: false }).catch(()=>{});
 }); window.addEventListener('focus', ()=>{ db.collection('users').doc(user.uid).update({ isOnline: true }).catch(()=>{}); }); // load data await fetchInitial(); // messaging initMessagingForUser(user.uid).catch(()=>{}); state.screen = 'home'; render();
 } else { // user logged out try { if(state.user && state.user.id) await db.collection('users').doc(state.user.id).update({ isOnline: false });
 } catch(e){/*ignore*/ } state.user = null; await fetchInitial(); state.screen = 'login'; render(); } });
/* logout button handler in header */
document.addEventListener('click', function(e){ if(e.target && e.target.id === 'authBtn'){ if(state.user) auth.signOut(); else goTo('login'); } });
/* ===================== Messaging (FCM client) ===================== */
async function initMessagingForUser(uid){ try { const perm = await Notification.requestPermission();
 if(perm !== 'granted'){ console.log('notifications not granted:', perm); return; } const token = await messaging.getToken(); if(token){ console.log('FCM token:', token); await db.collection('users').doc(uid).update({ fcmToken: token }).catch(e=>console.warn('FCM token save failed', e)); } else { console.warn('No FCM token available'); } messaging.onMessage(payload=>{ console.log('Message received. ', payload); if(state.screen==='chat') updateChatBox(); updateUnreadTotal(); });
 } catch(e){ console.error('FCM init failed', e); }
}

/* ===================== Daily Tip ===================== */
const fallbackTips = [
  'הקפד/י על שתיית מים מרובה במהלך היום, גם אם אינך מרגיש/ה צמא/ה. זה חשוב לבריאות הכללית!',
  'היום זה יום טוב להתקשר לחבר ותיק שלא דיברת איתו/ה הרבה זמן.',
  'נסה/י לצאת ל-20 דקות של הליכה קלה באור יום. זה מעולה למצב הרוח ולוויטמין D.',
  'למד/י משהו חדש היום! אפילו מילה חדשה או עובדה קטנה.',
  'סדר/י מגירה אחת קטנה בבית. זה יכול לתת תחושת סיפוק והישג.',
  'בצע/י תרגילי מתיחות עדינים לצוואר ולכתפיים. זה יכול להפחית מתח וכאב.',
  'תכנן/י ארוחה שאת/ה אוהב/ת במיוחד, ואם אפשר, בשל/י אותה היום.'
];
function getDailyTip(){ return fallbackTips[Math.floor(Math.random() * fallbackTips.length)]; }
function renderDailyTipSafe(){ try { const el = document.getElementById('dailyTipContainer'); if(!el) return; if(state.dailyTips && state.dailyTips.length){ const tip = state.dailyTips[0]; el.innerHTML = escapeHtml(tip.body || getDailyTip()); const refreshBtn = document.getElementById('refreshTipBtnHeader'); if(refreshBtn) refreshBtn.onclick = ()=>{ cycleTip(); }; } else { el.innerText = getDailyTip(); const refreshBtn = document.getElementById('refreshTipBtnHeader'); if(refreshBtn) refreshBtn.onclick = ()=>{ cycleTip(); }; } } catch(e){ console.error('renderDailyTipSafe', e); } }
function cycleTip(){ if(state.dailyTips && state.dailyTips.length){ // rotate array state.dailyTips.push(state.dailyTips.shift());
 renderDailyTipSafe(); } else { // fallback random tip const el = document.getElementById('dailyTipContainer'); if(el) el.innerText = getDailyTip();
 } }
/* safe refreshTip for legacy code */
function refreshTip(text){ const el = document.getElementById('dailyTipContainer') || document.getElementById('dailyTipText');
 if(!el){ console.warn('no daily tip element'); return; } el.innerText = text || getDailyTip();
}

/* populate city filters */
function populateCityFilters(){ const cf = document.getElementById('cityFilter'); if(cf){ cf.innerHTML = `<option value="">הכל</option>${state.cities.map(c=>`<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join('')}`;
 } const cc = document.getElementById('chatCityFilter'); if(cc){ cc.innerHTML = `<option value="">הכל</option>${state.cities.map(c=>`<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join('')}`;
 } }

/* ========== Admin lists render ========== */
async function loadAdminLists(){ if(!state.user || state.user.role!=='admin') return; const usersEl = document.getElementById('adminUsersList');
 if(!usersEl) return; usersEl.innerHTML = (state.users||[]).map(u=>`<div class="p-2 border rounded mb-2 flex justify-between items-center">${u.name} - ${u.role||'user'} <div class="flex gap-2">${u.role==='user'?`<button class="pill btn-sec" onclick="adminPromoteToSenior('${u.id}')">הפוך לבכיר</button>`:''}<button class="pill bg-red-400" onclick="adminDeleteUser('${u.id}')">מחק</button></div></div>`).join(''); renderAdminHelpCats();
}

function renderAdminHelpCats(){ const el = document.getElementById('adminHelpCats'); if(!el) return; el.innerHTML = (state.helpCategories||[]).map(c=>`<div class="p-2 border rounded mb-2 flex justify-between items-center">${c.title}<button class="pill bg-red-400" onclick="deleteHelpCategory('${c.id}')">מחק</button></div>`).join('');
}
/* ===================== Admin list render (cont) ===================== */
function loadAdminActivities(){
  const el = document.getElementById('adminActivities'); if(!el) return;
  el.innerHTML = (state.activities||[]).map(a=>`<div class="p-2 border rounded mb-2 flex justify-between items-center">${a.title} - ${a.location}<button class="pill bg-red-400" onclick="deleteActivity('${a.id}')">מחק</button></div>`).join('') || '<div>אין פעילויות</div>';
}
function loadAdminHelpRequests(){
  db.collection('helpRequests').where('status', '==', 'open').onSnapshot(snap=>{
    state.helpRequests = snap.docs.map(d=>({ id:d.id, ...d.data() }));
    renderAdminHelpRequests();
  }, err=>console.error('help request listen err', err));
}
function renderAdminHelpRequests(){
  const el = document.getElementById('adminHelpRequests'); if(!el) return;
  el.innerHTML = state.helpRequests.map(r=>{
    const cat = state.helpCategories.find(c=>c.id===r.categoryId);
    const author = state.users.find(u=>u.id===r.authorId);
    return `<div class="p-2 border rounded mb-2"><div class="font-semibold">${r.title}</div><div class="text-sm small-muted">קטגוריה: ${cat?cat.title:'לא ידוע'} | מאת: ${author?author.name:'לא ידוע'}</div><div class="mt-2 flex gap-2"><button class="pill btn-primary" onclick="showHelpRequestDetails('${r.id}')">פרטים</button><button class="pill bg-yellow-400" onclick="resolveHelpRequest('${r.id}')">טפלתי</button></div></div>`;
  }).join('') || '<div>אין בקשות עזרה פתוחות</div>';
}
async function showHelpRequestDetails(id){
  const req = state.helpRequests.find(r=>r.id===id); if(!req) return;
  alert(`כותרת: ${req.title}\nגוף: ${req.body}`);
}
async function resolveHelpRequest(id){
  if(!confirm('סמן כטופל?')) return;
  await db.collection('helpRequests').doc(id).update({ status: 'resolved', resolvedAt: firebase.firestore.FieldValue.serverTimestamp() });
}

/* ===================== Init / first render ===================== */
// Initial render will be done by auth.onAuthStateChanged
// However, if the user is already logged in, the render might be delayed until data loads.
// We call render once to show initial screen state (usually 'home' or 'login' depending on auth state).
if(!state.user) goTo('home'); // Ensure some content is shown even before Firebase init if user is not yet loaded
// Note: auth.onAuthStateChanged handles the final render based on actual auth state.

/* ===================== Cloud Function note (ל־push) =====================
 אם תרצה שאשלים לך את ה-Cloud Function לפריסה, אכתוב קובץ Node.js מוכן לשים ב-functions/index.js יחד עם הוראות פריסה.
======================================================================= */

</script>

<div id="rulesModal" class="fixed inset-0 bg-black/30 hidden items-center justify-center z-60">
  <div class="bg-white p-6 rounded w-full max-w-2xl card">
    <h3 class="font-semibold mb-2">תקנון השימוש וקוד התנהגות בקהילה</h3>
    <div class="small-muted mb-4">
      <strong>הערה חשובה:</strong> מרכז העזרה מועבר על בסיס קהילתי בלבד. בעלי האתר אינם מספקים ייעוץ מקצועי ואינם אחראים על התכנים או התוצאות. פניות בתחום משפטי, רפואי או פיננסי מהוות המלצה בלבד ואין לראות בהן תחליף לייעוץ מקצועי.
    </div>
    <ol class="text-sm small-muted list-decimal ml-6">
      <li>כבדו פרטיות של חברים — אין לפרסם מידע אישי ללא הסכמה ברורה.</li>
      <li>אסור לשתף תכנים פוגעניים, גזעניים או קיצוניים.</li>
      <li>הימנעו מהצעות...</li>
    </ol>
    <div class="mt-4 text-right">
      <button class="pill btn-primary" onclick="hideRules()">סגור</button>
    </div>
  </div>
</div>

</body>
</html>
