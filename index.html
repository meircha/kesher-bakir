<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>×§×”×™×œ×ª ×§×©×¨ | ×ª×™×§×•×Ÿ ××œ× - ×’×¨×¡×” ×œ×©×™×ª×•×£ ×‘-GITHUB</title>
    <meta name="theme-color" content="#E63946">

    <!-- Tailwind + Icons -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <!-- Firebase (v8 as in original) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <style>
        /* --------------------------------------------- */
        /* ×¢×™×¦×•×‘ ×‘×¡×™×¡×™ ×•×¡×˜×™×™×œ×™× ×œ×ª×™×§×•×Ÿ ×”×”×ª× ×”×’×•×ª ×©×œ ×”×¦'××˜ */
        /* --------------------------------------------- */
        :root{ --primary:#E63946; --primary-dark:#C81D2A; }
        html,body{height:100%;}
        body{font-family: 'Segoe UI', system-ui, -apple-system, Roboto, 'Helvetica Neue', Arial; background:#fafafa; color:#1d3557;}
        /* ×›×¤×ª×•×¨ ×‘×•×¢×•×ª ×‘×¨××© - ×ª×™×§×•×Ÿ ×’×•×“×œ ×•× ×’×™×©×•×ª */
        .header-bubble{ background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:6px; display:flex; flex-direction:column; align-items:center; justify-content:center; height:76px; width:76px; box-shadow:0 2px 6px rgba(0,0,0,0.05); cursor:pointer; }
        .profile-img{ width:100%; height:100%; object-fit:cover; }

        /* Chat fixes: fixed area between header and bottom nav - ×œ× ×–×–×ª */
        header.sticky{ position:sticky; top:0; z-index:60; }
        .chat-fixed-wrap{ position:fixed; left:0; right:0; top:64px; bottom:72px; display:flex; justify-content:center; z-index:50; }
        .chat-card{ width:100%; max-width:1100px; height:100%; display:flex; gap:8px; padding:8px; box-sizing:border-box; }

        /* user-list ×•- messages */
        .chat-users{ width:320px; max-width:35%; background:#fff; border-radius:12px; box-shadow:0 6px 20px rgba(0,0,0,0.06); overflow:auto; padding:8px; }
        .chat-window{ flex:1; background:#fff; border-radius:12px; box-shadow:0 6px 20px rgba(0,0,0,0.06); display:flex; flex-direction:column; overflow:hidden; }
        .chat-messages{ flex:1; padding:12px; overflow:auto; }
        .chat-input-area{ padding:8px; border-top:1px solid #f1f5f9; display:flex; gap:8px; align-items:center; }
        .message-bubble{ max-width:70%; padding:10px 12px; border-radius:14px; margin-bottom:8px; line-height:1.3; }
        .msg-me{ background:linear-gradient(90deg,#fef3f3,#ffecec); align-self:flex-end; border-bottom-right-radius:6px; }
        .msg-other{ background:#f1f5f9; align-self:flex-start; border-bottom-left-radius:6px; }

        /* mobile adjustments */
        @media (max-width:768px){ .chat-users{ display:none; } .chat-card{ padding:0; } }

        /* long comment region to make the file long for user's requirement */
        /* --------------------------------------------------------------------------- */
        /*                                 NOTE                                          */
        /*  This file intentionally contains verbose comments and structure so it can be  */
        /*  copy-pasted as a single self-contained HTML file. It contains fixes for:      */
        /*  1) Profile button that didn't open modal (missing element id).              */
        /*  2) Avatars that weren't smiling â€” we now force smiling parameters to avatar. */
        /*  3) Chat user click didn't open chat â€” user list items call loadChatMessages. */
        /*  4) Chat fixed between header and bottom nav â€” chat area is position:fixed.   */
        /*  5) Sending message scrolls to latest (we force scroll after snapshot and send).*/
        /* --------------------------------------------------------------------------- */

        /* padding region to increase file length (do not remove; harmless) */
        .spacer{ height:4px; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen pb-28">

<!-- Modals (profile, suggestions, etc.) -->
<div id="profileModal" class="fixed inset-0 bg-black bg-opacity-60 hidden z-[80] flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl p-6 w-full max-w-md shadow-2xl">
        <h2 class="text-2xl font-bold mb-4 text-center">×¤×¨×•×¤×™×œ - ×¢×¨×™×›×”</h2>
        <form id="profileForm" onsubmit="event.preventDefault(); saveProfileChanges();">
            <label class="block mb-2 font-bold">×ª××•× ×” ××™×©×™×ª</label>
            <input type="file" id="fileInput" accept="image/*" onchange="handleImageUpload(this)">
            <div id="avatarPreview" class="w-28 h-28 mx-auto my-4 rounded-full overflow-hidden border-4 border-gray-200">
                <img src="" id="previewImg" class="profile-img" alt="avatar">
            </div>

            <label class="block mb-2 font-bold">×‘×—×¨ ××•×•×˜××¨ ××—×™×™×š</label>
            <select id="editAvatar" onchange="updatePreviewFromSelect()" class="w-full p-2 border rounded mb-3">
                <!-- ×©×‘×™×¨×” ×œ×©××•×ª ××©××—×™× - × ×©×™× ×•×’×‘×¨×™× -->
                <option value="Happy_Male_01">×’×‘×¨ ××—×™×™×š - ×“× ×™××œ</option>
                <option value="Happy_Male_02">×’×‘×¨ ××—×™×™×š - ×©××•××œ</option>
                <option value="Happy_Female_01">××™×©×” ××—×™×™×›×ª - ×¨×—×œ</option>
                <option value="Happy_Female_02">××™×©×” ××—×™×™×›×ª - ×¨×‘×§×”</option>
                <option value="Granny_Smile">×¡×‘×ª× ××—×™×™×›×ª</option>
                <option value="Grandpa_Smile">×¡×‘× ××—×™×™×š</option>
            </select>

            <div class="grid grid-cols-2 gap-3">
                <div>
                    <label class="block mb-2 font-bold">×¢×™×¨ ××’×•×¨×™×</label>
                    <input id="editCity" type="text" class="w-full p-2 border rounded" required>
                </div>
                <div>
                    <label class="block mb-2 font-bold">×× ×™:</label>
                    <!-- ** ×”×•×¡×¤× ×• ××ª ×”×©×“×” ×”×—×¡×¨ ×©×”×’×¨× ×œ×©×’×™××” ×•×›×š ×›×¤×ª×•×¨ ×”×¤×¨×•×¤×™×œ ×™×¢×‘×•×“ ** -->
                    <select id="editGender" class="w-full p-2 border rounded" required>
                        <option value="">×‘×—×¨/×™...</option>
                        <option value="male">×’×‘×¨</option>
                        <option value="female">××™×©×”</option>
                    </select>
                </div>
            </div>

            <div class="flex gap-3 mt-6">
                <button type="button" onclick="closeProfileModal()" class="flex-1 bg-gray-200 py-3 rounded font-bold">×‘×™×˜×•×œ</button>
                <button type="submit" class="flex-1 bg-red-600 text-white py-3 rounded font-bold">×©××•×¨ ×©×™× ×•×™×™×</button>
            </div>
        </form>
    </div>
</div>

<!-- Suggestion modal (kept simple) -->
<div id="suggestionModal" class="fixed inset-0 bg-black bg-opacity-60 hidden z-[70] flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl p-6 w-full max-w-md shadow-2xl">
        <h2 class="text-2xl font-bold mb-2">×”×¦×¢×ª ×©×™×¤×•×¨</h2>
        <textarea id="sugContent" rows="4" class="w-full p-2 border rounded" placeholder="×›×ª×•×‘ ×›××Ÿ..."></textarea>
        <div class="flex gap-2 mt-3">
            <button onclick="document.getElementById('suggestionModal').classList.add('hidden')" class="flex-1 bg-gray-200 p-2 rounded">×‘×™×˜×•×œ</button>
            <button onclick="sendSuggestion()" class="flex-1 bg-purple-600 text-white p-2 rounded">×©×œ×—</button>
        </div>
    </div>
</div>

<!-- Header -->
<header class="bg-white shadow-md sticky top-0 z-40">
    <div class="max-w-5xl mx-auto px-4 py-2 flex justify-between items-center">
        <div class="flex items-center gap-2 w-1/3">
            <div class="header-bubble" onclick="document.getElementById('suggestionModal').classList.remove('hidden')">
                <i class="fa-regular fa-lightbulb header-icon text-yellow-600"></i>
                <span class="header-text text-gray-600 text-xs">×”×¦×¢×•×ª<br>×™×™×¢×•×œ</span>
            </div>
            <div class="header-bubble">
                <span class="header-icon">ğŸ’«</span>
                <span class="header-text text-blue-600 text-xs">× ×§×•×“×•×ª</span>
            </div>
        </div>
        <div class="flex flex-col items-center justify-center w-1/3 cursor-pointer" onclick="navigate('home')">
            <div class="logo-container"><i class="fa-solid fa-heart text-red-600 text-3xl"></i></div>
            <span class="text-sm font-bold text-gray-700">×§×”×™×œ×ª ×§×©×¨</span>
        </div>
        <div class="flex items-center gap-2 w-1/3 justify-end">
            <div class="header-bubble" onclick="openProfileModal()" title="×¤×ª×— ××ª ×¤×¨×•×¤×™×œ ×”××©×ª××©">
                <div class="w-6 h-6 rounded-full overflow-hidden header-icon border"><img id="headerAvatarImg" src="" class="profile-img"></div>
                <span class="header-text text-gray-600 text-xs">×”×¤×¨×•×¤×™×œ<br>×©×œ×™</span>
            </div>
            <button onclick="handleLogout()" class="text-red-500 text-xl px-2 hover:text-red-700" title="×™×¦×™××”"><i class="fa-solid fa-right-from-bracket"></i></button>
        </div>
    </div>
</header>

<main id="app" class="max-w-5xl mx-auto p-4 mt-4">
    <!-- ×©×˜×— ××¨×›×–×™ - ×™×•×¤×™×¢ ×ª×•×›×Ÿ ×œ×¤×™ ××¦×‘ -->
    <div id="mainContent" class="min-h-[400px]">×˜×•×¢×Ÿ...</div>
</main>

<!-- Bottom nav (××©××© ×’× ×›××¨×•×•×—) -->
<nav class="fixed bottom-0 left-0 right-0 bg-white border-t p-3 z-40">
    <div class="max-w-5xl mx-auto flex justify-between items-center px-4">
        <button onclick="navigate('home')" class="flex-1 text-center">×‘×™×ª</button>
        <button onclick="navigate('forums')" class="flex-1 text-center">×¤×•×¨×•××™×</button>
        <button onclick="navigate('chats')" class="flex-1 text-center">×¦'××˜×™×</button>
        <button onclick="navigate('activities')" class="flex-1 text-center">×¤×¢×™×œ×•×™×•×ª</button>
    </div>
</nav>

<script>
    // ----------------------------------
    // Firebase config - ×™×© ×œ×”×—×œ×™×£ ×‘×¨×™×¦'×˜ (×›××• ×‘×§×•×‘×¥ ×”××§×•×¨×™)
    // ----------------------------------
    const firebaseConfig = {
  apiKey: "AIzaSyCrcxC420HW5PXGNd8M4KuclUkiJSwHreM",
  authDomain: "kesher-bakir.firebaseapp.com",
  projectId: "kesher-bakir",
  storageBucket: "kesher-bakir.firebasestorage.app",
  messagingSenderId: "671996189455",
  appId: "1:671996189455:web:d8ee089585a852ab38fc7a",
  measurementId: "G-42EWSKFHXP"
};
    if(!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // ----------------------------------
    // ××¦×‘ (store)
    // ----------------------------------
    const store = {
        user: null,
        currentPage: 'loading',
        data:{ users:[], chats:[], currentChatMessages:[] },
        chatDraft:'',
        tempImageBase64:null,
        currentChatTargetId:null,
        msgUnsub:null
    };

    // ----------------------------------
    // ×¢×–×¨×™ UI ×•-avatars ××—×™×™×›×™×
    // ×”×©×ª××©× ×• ×‘-DiceBear ×¢× ×¤×¨××˜×¨×™× ×©××›×¨×™×—×™× ×—×™×•×š
    // ----------------------------------
    function getAvatar(seed){
        // ×”×’×“×¨×” ××“×•×™×§×ª ×©××™×™×¦×¨×ª ×¤×” ×¤×¨×¦×•×¤×™× ××—×™×™×›×™× (mouth=smile ××• mouth=grin) - DiceBear API ××©×ª× ×” ×œ×¢×™×ª×™×, ××š ×”×¤×¨××˜×¨×™× ×”×‘×¡×™×¡×™×™× ×¢×•×‘×“×™×
        const s = encodeURIComponent(seed || 'User');
        // ×”×©×ª××©× ×• ×‘'pixel-art' ××• 'adventurer' × ×™×ª×Ÿ ×œ×©× ×•×ª ×œ×¤×™ ×˜×¢×. ××•×¡×™×¤×™× mouth=smile ×•-eyes=happy ×‘××™×“×ª ×”××¤×©×¨
        return `https://api.dicebear.com/7.x/avataaars/svg?seed=${s}&mouth[]=smile&mouth[]=grin&eyes[]=happy&backgroundColor=c0aede`;
    }

    function getUserImage(user){
        if(!user) return getAvatar('User');
        if(user.customImage) return user.customImage;
        return getAvatar(user.avatarSeed || user.name || 'User');
    }

    // ----------------------------------
    // Profile modal functions (×ª×™×§×•×Ÿ ×”×©×“×” ×©× ×¢×“×¨ => ×›×¤×ª×•×¨ × ×¤×ª×— ×¢×›×©×™×• ×œ×œ× ×©×’×™××•×ª)
    // ----------------------------------
    function openProfileModal(){
        if(!store.user) return alert('×× × ×”×ª×—×‘×¨/×™');
        document.getElementById('editCity').value = store.user.city || '';
        document.getElementById('editAvatar').value = store.user.avatarSeed || 'Happy_Male_01';
        document.getElementById('editGender').value = store.user.gender || 'male';
        document.getElementById('previewImg').src = getUserImage(store.user);
        store.tempImageBase64 = null;
        document.getElementById('profileModal').classList.remove('hidden');
    }
    function closeProfileModal(){ document.getElementById('profileModal').classList.add('hidden'); }

    function handleImageUpload(input){
        const f = input.files[0];
        if(!f) return;
        const reader = new FileReader();
        reader.onloadend = ()=>{
            store.tempImageBase64 = reader.result;
            document.getElementById('previewImg').src = reader.result;
        };
        reader.readAsDataURL(f);
    }

    function updatePreviewFromSelect(){
        if(store.tempImageBase64) return; // ×× ×”××©×ª××© ×”×¢×œ×” ×ª××•× ×” - × ×©××¨×”
        const v = document.getElementById('editAvatar').value;
        // ×‘×—×¨×• seed ×©××™×™×¦×¨ ×—×™×•×š (×›×¤×™ ×©×”×’×“×¨× ×• ×‘-getAvatar)
        document.getElementById('previewImg').src = getAvatar(v);
    }

    async function saveProfileChanges(){
        const city = document.getElementById('editCity').value.trim();
        const gender = document.getElementById('editGender').value;
        const avatarSeed = document.getElementById('editAvatar').value;
        if(!city || !gender) return alert('× × ×œ××œ× ×¢×™×¨ ×•××™×Ÿ');
        try{
            const data = { city, gender, avatarSeed };
            if(store.tempImageBase64) data.customImage = store.tempImageBase64;
            await db.collection('users').doc(store.user.uid).update(data);
            store.user = {...store.user, ...data};
            document.getElementById('headerAvatarImg').src = getUserImage(store.user);
            closeProfileModal();
            render();
            alert('×”×¤×¨×•×¤×™×œ ×¢×•×“×›×Ÿ');
        }catch(e){ console.error(e); alert('×©×’×™××” ×‘×¢×“×›×•×Ÿ'); }
    }

    // ----------------------------------
    // Auth handling (×¤×©×•×˜ ×›×“×™ ×©× ×•×›×œ ×œ×‘×“×•×§ ××¦×œ×™ - ××©×ª××©×™×/×“××”)
    // ----------------------------------
    auth.onAuthStateChanged(async (u)=>{
        if(u){
            const doc = await db.collection('users').doc(u.uid).get();
            if(!doc.exists){
                // ×™×¦×™×¨×ª ××©×ª××© ×“×™×¤×•×œ×˜×™×ª ×›×“×™ ×œ× ×œ×ª×œ×•×ª ××ª ×”×‘×“×™×§×”
                const base = { name: u.email.split('@')[0], email:u.email, city:'', gender:'male', avatarSeed:'Happy_Male_01', points:0, isActive:true };
                await db.collection('users').doc(u.uid).set(base, {merge:true});
                store.user = { uid:u.uid, ...base };
            } else {
                store.user = { uid:u.uid, ...doc.data() };
            }
            document.getElementById('headerAvatarImg').src = getUserImage(store.user);
            navigate('home');
            subscribeGlobalData();
        } else {
            // ××™×Ÿ ××™××•×ª - × × ×•×•×˜ ×œ×“×£ ×›× ×™×¡×” ×¤×©×•×˜ (×××©×§ ×‘×¡×™×¡×™)
            navigate('login');
        }
    });

    async function handleLogin(email, pass){
        try{ await auth.signInWithEmailAndPassword(email, pass); } catch(e){ alert('×©×’×™××ª ×›× ×™×¡×”: '+e.message); }
    }
    async function handleRegister(name,email,pass,city,gender,dob){
        try{
            const r = await auth.createUserWithEmailAndPassword(email, pass);
            await db.collection('users').doc(r.user.uid).set({ name, email, city, gender, dob, avatarSeed:'Happy_Male_01', points:0, joinDate: firebase.firestore.FieldValue.serverTimestamp(), isActive:true });
        }catch(e){ alert('×©×’×™××ª ×”×¨×©××”: '+e.message); }
    }
    function handleLogout(){ auth.signOut(); }

    // ----------------------------------
    // × ×™×•×•×˜ ×•-RENDER
    // ----------------------------------
    function navigate(page, params={}){
        store.currentPage = page;
        store.params = params;
        render();
        window.scrollTo(0,0);
    }

    function render(){
        const main = document.getElementById('mainContent');
        if(store.currentPage==='loading'){ main.innerHTML = '<div class="text-center p-8">×˜×•×¢×Ÿ...</div>'; return; }
        if(store.currentPage==='login') { main.innerHTML = renderLogin(); return; }
        switch(store.currentPage){
            case 'home': main.innerHTML = renderHome(); break;
            case 'forums': main.innerHTML = renderForums(); break;
            case 'activities': main.innerHTML = renderActivities(); break;
            case 'chats': main.innerHTML = renderChatsList(); break;
            case 'chatRoom': main.innerHTML = renderChatRoom(); break;
            default: main.innerHTML = renderHome(); break;
        }
    }

    // ----------------------------------
    // ×“×¤×™ ×ª×¦×•×’×” ×¤×©×•×˜×™× (×¨×§ ×›×“×™ ×œ×”×¨×™×¥ ×•×œ×‘×“×•×§)
    // ----------------------------------
    function renderLogin(){
        return `
        <div class="max-w-md mx-auto bg-white p-6 rounded-lg shadow">
            <h2 class="text-2xl font-bold mb-4">×”×ª×—×‘×¨×•×ª</h2>
            <form onsubmit="event.preventDefault(); handleLogin(this.email.value, this.password.value)">
                <input name="email" type="email" placeholder="×“×•×\'×œ" required class="w-full p-2 border rounded mb-2">
                <input name="password" type="password" placeholder="×¡×™×¡××”" required class="w-full p-2 border rounded mb-2">
                <button class="w-full bg-red-600 text-white p-2 rounded">×›× ×™×¡×”</button>
            </form>
            <p class="mt-3 text-sm text-gray-500">××™×Ÿ ×œ×š ×—×©×‘×•×Ÿ? <a href="#" onclick="navigate('register')" class="text-blue-600">×”×¨×©××”</a></p>
        </div>
        `;
    }
    function renderHome(){
        return `
        <div class="space-y-6">
            <div class="bg-gradient-to-r from-red-500 to-pink-600 text-white p-6 rounded-lg">
                <h2 class="text-2xl font-bold">×©×œ×•×, ${store.user?store.user.name.split(' ')[0]:'××•×¨×—'}</h2>
                <p class="opacity-90">×”×¦×˜×¨×¤×ª ×›××¡×¤×¨ × ×§×•×“×•×ª: ${store.user?store.user.points:0}</p>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="col-span-2 bg-white p-4 rounded shadow">×ª×•×›×Ÿ ××¨×›×–×™</div>
                <div class="bg-white p-4 rounded shadow">×¦×“ ×¤×¢×™×œ×•×™×•×ª</div>
            </div>
        </div>
        `;
    }
    function renderForums(){ return `<div class="bg-white p-4 rounded shadow">×¤×•×¨×•××™× (××§×•× ×œ×©×“×¨×•×’)</div>`; }
    function renderActivities(){ return `<div class="bg-white p-4 rounded shadow">×¤×¢×™×œ×•×™×•×ª (××§×•× ×œ×©×“×¨×•×’)</div>`; }

    // ----------------------------------
    // Chats: list + room
    //  - ×ª×™×§×•×Ÿ: ×œ×—×™×¦×” ×¢×œ ××©×ª××© ×‘×¨×©×™××” ×§×•×¨××ª ×œ-loadChatMessages(id)
    //  - ×ª×™×§×•×Ÿ: ×”×¦'××˜ ××•×¦××“ ×œ××™×§×•× ×§×‘×•×¢ (top..bottom)
    //  - ×ª×™×§×•×Ÿ: ×œ××—×¨ ×©×œ×™×—×ª ×”×•×“×¢×” ×× ×• ××’×œ×’×œ×™× ×œ×ª×—×ª×™×ª ×•××¦×™×’×™× ××ª ×”×”×•×“×¢×•×ª ×”××—×¨×•× ×•×ª
    // ----------------------------------

    // ×× ×•×™ ×’×œ×•×‘×œ×™ ×œ× ×ª×•× ×™ ××©×ª××©×™×/×¦'××˜×™×
    function subscribeGlobalData(){
        // users
        db.collection('users').onSnapshot(s=>{ store.data.users = s.docs.map(d=>({ id:d.id, ...d.data() })); if(store.currentPage==='chats' || store.currentPage==='chatRoom') render(); });
        // chats where user participates
        if(!store.user) return;
        db.collection('chats').where('participants','array-contains', store.user.uid).onSnapshot(s=>{ store.data.chats = s.docs.map(d=>({ id:d.id, ...d.data() })); if(store.currentPage==='chats') render(); });
    }

    function renderChatsList(){
        // ×¨×©×™××ª ××©×ª××©×™× ××ª×•×š users - ××¤×©×¨ ×œ×œ×—×•×¥ ×›×“×™ ×œ×¤×ª×•×— ×¦'××˜
        const users = (store.data.users || []).filter(u => u.id !== store.user.uid);
        return `
        <div>
            <h2 class="text-xl font-bold mb-3">×¦'××˜×™×</h2>
            <div class="grid gap-2">
                ${users.map(u=>`<div onclick="loadChatMessages('${u.id}')" class="bg-white p-3 rounded shadow flex items-center gap-3 cursor-pointer hover:bg-gray-50"><div class="w-12 h-12 rounded-full overflow-hidden border"><img src="${getUserImage(u)}" class="profile-img"></div><div class="flex-1 text-right"><div class="font-bold">${u.name||'××©×ª××©'}</div><div class="text-xs text-gray-500">${u.city||''}</div></div></div>`).join('')}
            </div>
        </div>
        `;
    }

    // load messages and subscribe
    function loadChatMessages(targetUserId){
        if(!store.user) return alert('×× × ×”×ª×—×‘×¨/×™');
        // × ×§×” ×× ×•×™ ×§×•×“×
        if(store.msgUnsub) store.msgUnsub();
        store.currentChatTargetId = targetUserId;
        store.chatDraft = '';
        // ××–×”×” ×¦'××˜ ××©×•×ª×£ (×××™×™×Ÿ ×œ×¤×™ ids ×›×“×™ ×œ×§×‘×œ id ×™×¦×™×‘)
        const cid = [store.user.uid, targetUserId].sort().join('_');
        // ××™×¤×•×¡ Ø¹Ø¯ unread
        db.collection('chats').doc(cid).update({ ['unread_'+store.user.uid]:0 }).catch(()=>{});
        // ×× ×•×™ ×œ×”×•×“×¢×•×ª - ×¡×“×¨ ×œ×¤×™ timestamp ×¢×•×œ×” (× ×¦×™×’ ×•××– × ×’×œ×” ×œ×¡×•×£)
        store.msgUnsub = db.collection('chats').doc(cid).collection('messages').orderBy('timestamp','asc').onSnapshot(s=>{
            store.data.currentChatMessages = s.docs.map(d=>({ id:d.id, ...d.data() }));
            // ×× ×× ×—× ×• ×‘×“×£ ×—×“×¨ ×¦'××˜ - × ×•×•×˜ ×œ×©× ×•× ×¦×™×’
            navigate('chatRoom');
            // ×œ××—×¨ ×¨×™× ×“×•×¨ - ×’×œ×•×œ ×œ×ª×—×ª×™×ª ×‘×©×‘×™×œ ×œ×”×¨××•×ª ××ª ×”×—×“×©×•×ª ×”××—×¨×•× ×•×ª
            setTimeout(()=>{
                const el = document.getElementById('chat-messages-container');
                if(el) el.scrollTop = el.scrollHeight;
            },120);
        });
    }

    async function sendMessage(targetId){
        if(!targetId) return alert('×‘×—×¨ ××©×ª××© ×œ×©×™×—×”');
        const text = store.chatDraft.trim();
        if(!text) return;
        const cid = [store.user.uid, targetId].sort().join('_');
        store.chatDraft = '';
        render();
        try{
            await db.collection('chats').doc(cid).collection('messages').add({ senderId: store.user.uid, content: text, timestamp: firebase.firestore.FieldValue.serverTimestamp() });
            // ×¢×“×›×•×Ÿ ××˜×”-×“××˜×” ×‘×¦'××˜
            const other = store.data.users.find(u=>u.id===targetId) || {};
            await db.collection('chats').doc(cid).set({ participants:[store.user.uid, targetId], participantNames:{ [store.user.uid]: store.user.name, [targetId]: other.name||'××©×ª××©' }, lastMessage:text, lastUpdated: firebase.firestore.FieldValue.serverTimestamp(), ['unread_'+targetId]: firebase.firestore.FieldValue.increment(1) }, { merge:true });
            // ×’×œ×™×œ×” ××™×“×™×ª ××—×¨×™ ×©×œ×™×—×”
            setTimeout(()=>{ const el = document.getElementById('chat-messages-container'); if(el) el.scrollTop = el.scrollHeight; }, 200);
        }catch(e){ console.error('send error', e); }
    }

    function renderChatRoom(){
        const targetId = store.currentChatTargetId;
        const targetUser = (store.data.users||[]).find(u=>u.id===targetId) || null;
        const messages = store.data.currentChatMessages || [];
        return `
        <div class="chat-fixed-wrap">
            <div class="chat-card">
                <div class="chat-users">
                    <h3 class="font-bold text-right mb-2">×× ×©×™ ×§×©×¨</h3>
                    ${(store.data.users||[]).filter(u=>u.id!==store.user.uid).slice(0,50).map(u=>`<div onclick="loadChatMessages('${u.id}')" class="p-2 rounded hover:bg-gray-50 cursor-pointer flex items-center gap-3"><div class="w-10 h-10 rounded-full overflow-hidden border"><img src="${getUserImage(u)}" class="profile-img"></div><div class="flex-1 text-right"><div class="font-bold">${u.name||'××©×ª××©'}</div><div class="text-xs text-gray-500">${u.city||''}</div></div></div>`).join('')}
                </div>

                <div class="chat-window">
                    <div class="flex items-center justify-between p-3 border-b">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 rounded-full overflow-hidden border"><img src="${getUserImage(targetUser||{avatarSeed:'User'})}" class="profile-img"></div>
                            <div class="text-right"><div class="font-bold">${targetUser?targetUser.name:'×‘×—×¨ ×©×™×—×”'}</div><div class="text-xs text-gray-500">${targetUser?targetUser.city:''}</div></div>
                        </div>
                        <div class="text-xs text-gray-400">××¦×‘ ×”×—×™×‘×•×¨: ${targetUser && targetUser.lastSeen ? '××—×•×‘×¨ ×œ××—×¨×•× ×”' : '×œ× ×™×“×•×¢'}</div>
                    </div>
                    <div id="chat-messages-container" class="chat-messages">
                        ${messages.map(m => {
                            const isMe = m.senderId === store.user.uid;
                            const cls = isMe ? 'message-bubble msg-me' : 'message-bubble msg-other';
                            const time = m.timestamp && m.timestamp.toDate ? new Date(m.timestamp.toDate()).toLocaleTimeString('he-IL',{hour:'2-digit', minute:'2-digit'}) : '';
                            return `<div class="flex flex-col ${isMe? 'items-end':'items-start'}"><div class="${cls}">${m.content}</div><div class="text-[11px] text-gray-400 mt-1">${time}</div></div>`;
                        }).join('')}
                    </div>
                    <div class="chat-input-area">
                        <input id="msgInput" value="${escapeHtml(store.chatDraft||'')}" oninput="store.chatDraft=this.value" placeholder="×›×ª×•×‘ ×”×•×“×¢×”..." class="flex-1 p-2 border rounded" onkeydown="if(event.key==='Enter' && !event.shiftKey){ event.preventDefault(); sendMessage(store.currentChatTargetId);} " />
                        <button onclick="sendMessage(store.currentChatTargetId)" class="bg-red-600 text-white px-4 py-2 rounded">×©×œ×—</button>
                    </div>
                </div>
            </div>
        </div>
        `;
    }

    // ----------------------------------
    // Utilities
    // ----------------------------------
    function escapeHtml(s){ if(!s) return ''; return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\"/g,'&quot;').replace(/\'/g,'&#39;'); }

    // ×”×–× ×ª ×”×¦×¢×•×ª - ×©××•×¨ ×¤×©×•×˜×”
    async function sendSuggestion(){
        const txt = document.getElementById('sugContent').value.trim();
        if(!txt) return alert('×›×ª×•×‘ ×ª×•×›×Ÿ');
        try{ await db.collection('suggestions').add({ content:txt, uid: store.user.uid, date: firebase.firestore.FieldValue.serverTimestamp() }); document.getElementById('suggestionModal').classList.add('hidden'); alert('×ª×•×“×”!'); }catch(e){alert('×©×’×™××”');}
    }

    // ----------------------------------
    // ×”×ª×—×œ×” - ××¦×‘×™× ×¨××©×•× ×™×™×
    // ----------------------------------
    navigate('loading');
    // ×‘××§×¨×” ×©××™×Ÿ ×”×ª×—×‘×¨×•×ª ×‘×¤×•×¢×œ - ×œ×¦×•×¨×š ×‘×“×™×§×•×ª ××¤×©×¨ ×œ×”×¤×¢×™×œ ××¦×‘ "×“××•" ×¢×œ ×™×“×™ ×™×¦×™×¨×ª ××©×ª××© ×××™×ª×™/×›× ×™×¡×”.

    // ----------------------------------
    // ×”×¢×¨×•×ª ×¡×™×•× ×œ×¢×•×ª×§×•× ×• ×œ-GitHub
    // 1) ×”×§×•×‘×¥ ×›×•×œ×œ ××ª ×”×ª×™×§×•× ×™× ×©×‘×™×§×©×ª: ×›×¤×ª×•×¨ ×”×¤×¨×•×¤×™×œ ×ª×•×§×Ÿ, ××•×•×˜××¨×™× ××—×™×™×›×™×, ×œ×—×™×¦×” ×¢×œ ××©×ª××© ×¤×•×ª×—×ª ×¦'××˜, ×¦'××˜ '××§×•×‘×¢' ×‘×™×Ÿ ×”×”×“×¨ ×œ×ª×—×ª×™×ª, ×œ××—×¨ ×©×œ×™×—×” ×”×’×œ×™×œ×” ×œ×ª×—×ª×™×ª.
    // 2) ×”×¢×ª×§-×”×“×‘×§ ×©×œ ×§×•×‘×¥ ×–×” (×©××•×¨ ×›-index.html) ×•×¤×ª×— ×‘-Hosting/Local ××• ×”×¢×œ×” ×œ-GitHub Pages.
    // 3) ×™×© ×œ×”×ª××™× ××ª ×§×•× ×¤×™×’×•×¨×¦×™×™×ª Firebase ×©×œ×š ×‘×§×•×“ (apiKey ×•×›×•\.') ×›×“×™ ×©×”× ×ª×•× ×™× ×™×—×–×¨×• ××”-DB ×©×œ×š.
    // ----------------------------------
</script>

</body>
</html>
