<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>×§×”×™×œ×ª ×§×©×¨ â€” ×§×”×™×œ×” ×ª×•××›×ª 60+</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

  <style>
    :root{
      --primary:#2B6CB0;
      --accent:#38B2AC;
      --bg:#F7FAFC;
      --card:#FFFFFF;
      --muted:#4A5568;
    }
    html,body { height:100%; }
    body{ background:var(--bg); font-family: "Segoe UI", Roboto, Arial, sans-serif; color:#1a202c; -webkit-font-smoothing:antialiased; margin:0; padding:0; }
    .card{ background:var(--card); border-radius:12px; box-shadow:0 6px 20px rgba(0,0,0,0.06); }
    .btn-primary{ background:var(--accent); color:white; }
    .btn-sec{ background:var(--primary); color:white; }
    .pill{ padding:.5rem .9rem; border-radius:999px; font-size: .95rem; }
    .clickable{ cursor:pointer; }
    input, textarea, select { font-size:1rem; }
    .fab{ position:fixed; bottom:18px; left:18px; z-index:60; border-radius:999px; width:64px; height:64px; display:flex; align-items:center; justify-content:center; box-shadow:0 10px 20px rgba(0,0,0,0.12); }
    .small-muted{ color:var(--muted); font-size:.9rem; }
    .hidden{ display:none; }
  </style>
</head>
<body>

<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/kesher-bakir/firebase-messaging-sw.js')
      .then(()=>console.log('SW registered (github pages path).'))
      .catch(e=>console.warn('SW register failed', e));
  }
</script>

<header class="bg-white shadow sticky top-0 z-50">
  <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
    <div class="flex items-center gap-3">
      <img id="siteLogo" src="https://images.unsplash.com/photo-1524504388940-b1c1722653e1?q=80&w=80&auto=format&fit=crop&ixlib=rb-4.0.3&s=3d6c2b2b5d3af9c1b8f8f1a5b7c4b2a1"
           alt="×§×”×™×œ×ª ×§×©×¨" class="w-12 h-12 rounded-full object-cover border-2">
      <div>
        <div class="text-xl font-bold" style="color:var(--primary)">×§×”×™×œ×ª ×§×©×¨</div>
        <div class="text-sm small-muted">××¨×—×‘ ×ª×•××š ×œ×‘× ×™ 60 ×•××¢×œ×”</div>
      </div>
    </div>

    <div class="flex items-center gap-2">
      <div id="greetingText" class="text-sm small-muted mr-2"></div>

      <button class="pill bg-white border" onclick="goTo('home')">×‘×™×ª</button>
      <button class="pill bg-white border" onclick="goTo('forums')">×¤×•×¨×•××™×</button>
      <button class="pill bg-white border" onclick="goTo('activities')">×¤×¢×™×œ×•×™×•×ª</button>
      <button class="pill bg-white border" onclick="goTo('helpCenter')">××¨×›×– ×¢×–×¨×”</button>
      <button class="pill bg-white border" onclick="goTo('users')">×—×‘×¨×™×</button>

      <div class="relative">
        <button id="chatBtn" class="pill bg-white border flex items-center gap-2" onclick="goTo('chat')">
          <i class="fa-solid fa-comments"></i> ×¦'××˜
          <span id="unreadBadge" class="ml-2 inline-flex items-center justify-center px-2 py-0.5 text-xs font-bold text-white bg-yellow-400 rounded-full hidden"></span>
        </button>
      </div>

      <button id="authBtn" class="pill btn-sec text-white" onclick="state.user ? auth.signOut() : goTo('login')"></button>
    </div>
  </div>
</header>

<main class="max-w-6xl mx-auto px-4 py-6" id="root"></main>

<button class="fab btn-primary card clickable" title="×¦'××˜ ××”×™×¨" onclick="goTo('chat')" aria-label="×¦'××˜ ××”×™×¨">
  <i class="fa-solid fa-comments" style="font-size:20px;"></i>
</button>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-messaging.js"></script>

<script>
/* ================== CONFIG - ×ª×•×§×Ÿ ×¢× ×”×¢×¨×›×™× ×©×œ×š ================== */
const firebaseConfig = {
    apiKey: "AIzaSyCrcxC420HW5PXGNd8M4KuclUkiJSwHreM", 
    authDomain: "kesher-bakir.firebaseapp.com",
    projectId: "kesher-bakir",
    storageBucket: "kesher-bakir.firebasestorage.app",
    messagingSenderId: "671996189455",
    appId: "1:671996189455:web:dbe089d69a85a2ab38fc7a",
    measurementId: "G-42EWSKFXW" 
};
/* ===================================================================== */

if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const messaging = firebase.messaging();

/* × ×¡×™×•×Ÿ persistence */
if (db.enablePersistence) {
  db.enablePersistence().catch(err => console.warn('persistence:', err && err.code));
}

/* ========== State ========== */
const state = {
  user:null,
  screen:'home',
  users:[],
  forums:[],
  activities:[],
  helpCategories:[],
  helpRequests:[],
  chatMessages:[],
  selectedUser:null,
  cities:[],
  unreadTotal:0,
  chatsMeta:{}, 
  listeners: {}
};

/* ========== Helpers ========== */
function el(html){ const d=document.createElement('div'); d.innerHTML=html; return d.firstElementChild; }
function escapeHtml(s){ return (s||'').toString().replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function getChatRoomId(a,b){ if(!a||!b) return null; return a < b ? `${a}_${b}` : `${b}_${a}`; }
function showToast(msg){ alert(msg); }

/* ========== Router / Render ========== */
function goTo(screen, params){ 
    // ×× ×¢×•×‘×¨×™× ×œ×¦'××˜ ××• ×œ×¤×•×¨×•×, ×™×© ×œ×‘×˜×œ ×”××–× ×” ×§×•×“××ª
    if(state.screen === 'chat' && currentChatUnsub) { currentChatUnsub(); currentChatUnsub = null; }
    if(state.screen === 'forumDetails' && currentForumUnsub) { currentForumUnsub(); currentForumUnsub = null; }
    
    state.screen = screen; 
    if(params) Object.assign(state, params); 
    render(); 
}

function render(){
  updateHeader();
  const root = document.getElementById('root');
  try {
    // ×©×œ×‘ 1: ×¨×™× ×“×•×¨ ×”××¡×’×¨×ª
    switch(state.screen){
      case 'home': root.innerHTML = renderHome(); break;
      case 'login': root.innerHTML = renderLogin(); break;
      case 'register': root.innerHTML = renderRegister(); break;
      case 'forums': root.innerHTML = renderForums(); break;
      case 'forumDetails': root.innerHTML = renderForumDetails(); break; 
      case 'activities': root.innerHTML = renderActivities(); break;
      case 'helpCenter': root.innerHTML = renderHelpCenter(); break;
      case 'users': root.innerHTML = renderUsers(); break;
      case 'chat': root.innerHTML = renderChat(); break;
      case 'admin': root.innerHTML = renderAdmin(); break;
      default: root.innerHTML = '<div>×˜×¢×•×ª × ×™×•×•×˜</div>';
    }

    // ×©×œ×‘ 2: ×§×¨×™××” ×œ×¤×•× ×§×¦×™×•×ª ×©×××œ××•×ª ××ª ×”×ª×•×›×Ÿ
    switch(state.screen){
      case 'home': afterHomeRender(); break;
      case 'forums': searchForums(); break;
      case 'forumDetails': afterForumDetailsRender(); break;
      case 'activities': renderActivitiesList(); break; 
      case 'helpCenter': renderHelpRequestsList(); break; // ×¢×“×›×•×Ÿ: ×”×•×¡×¤×ª ×¤×•× ×§×¦×™×” ×–×•
      case 'users': renderUsersList(); break;
      case 'chat': renderChatUsersList(); updateChatBox(); break;
      case 'admin': loadAdminLists(); break;
    }

  } catch(e){
    console.error('render error', e);
    // **×ª×™×§×•×Ÿ ×§×¨×™×¡×ª ×”×¨×™× ×“×•×¨ ×”×§×¨×™×˜×™:** ×”×¦×’×ª ×”×•×“×¢×ª ×©×’×™××” ×‘×¨×•×¨×” ×‘××§×•× ×§×¨×™×¡×” ××œ××”
    root.innerHTML = `<div class="p-4 card text-red-600">×©×’×™××ª ×¨×™× ×“×•×¨ ×§×¨×™×˜×™×ª: ${escapeHtml(e.message)}</div>`;
  }
}

/* ========== Header updates ========== */
function updateHeader(){
  const greeting = document.getElementById('greetingText');
  let roleText = '';
  if (state.user && state.user.role === 'admin') roleText = ' (ADMIN)';
  if (state.user && state.user.role === 'senior') roleText = ' (×‘×›×™×¨)'; 
  
  if(greeting) greeting.innerText = state.user ? `×©×œ×•×, ${state.user.name}${roleText}` : '';
  const authBtn = document.getElementById('authBtn');
  if(authBtn) authBtn.innerText = state.user ? '×”×ª× ×ª×§' : '×”×ª×—×‘×¨';
  const badge = document.getElementById('unreadBadge');
  if(badge){
    badge.style.display = state.unreadTotal > 0 ? 'inline-flex' : 'none';
    badge.innerText = state.unreadTotal > 99 ? '99+' : (state.unreadTotal || '');
  }
}

/* ===================== Home ===================== */
function renderHome(){
  // ğŸ›‘ ×ª×™×§×•×Ÿ: ×”×—×œ×¤×ª ×”×ª××•× ×” ×œ×›×ª×•×‘×ª ×ª×§×™× ×”
  return `
    <section class="card overflow-hidden mb-6">
      <div class="relative">
        <img id="heroImg" src="https://images.unsplash.com/photo-1549419137-c1d48c909e3e?q=80&w=1600&auto=format&fit=crop&ixlib=rb-4.0.3&s=7c1b5a5b5d3af9c1b8f8f1a5b7c4b2a1" alt="×× ×©×™× ××‘×•×’×¨×™× ××—×™×™×›×™× ×•× ×•×ª× ×™× ×›×™×£" class="w-full h-56 object-cover" />
        <div class="absolute inset-0 bg-gradient-to-t from-black/50 to-transparent"></div>
        <div class="absolute inset-0 flex flex-col justify-end text-white p-6">
            <div id="dailyTipContainer" class="text-lg font-bold bg-white/30 backdrop-blur-sm p-3 rounded mb-4 shadow-lg flex items-center justify-between">
                <div>×˜×•×¢×Ÿ ×˜×™×¤ ×™×•××™...</div>
                <button id="refreshTipBtnHeader" class="pill bg-white text-gray-800 text-sm py-1">×˜×¢×Ÿ ×˜×™×¤ ××—×¨</button>
            </div>
            
            <div class="text-2xl font-bold">×‘×¨×•×›×™× ×”×‘××™× â€” ×§×”×™×œ×ª ×§×©×¨</div>
            <div class="text-sm">××¨×—×‘ ×‘×˜×•×— ×•×ª×•××š ×œ×‘× ×™ 60 ×•××¢×œ×”</div>
        </div>
      </div>

      <div class="p-6 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
        <div class="card p-4 flex items-center gap-4 clickable" onclick="goTo('chat')">
          <div class="w-14 h-14 rounded-full bg-gradient-to-tr from-[#4EC7B6] to-[#2FB3A3] flex items-center justify-center text-white text-xl"><i class="fa-solid fa-comments"></i></div>
          <div>
            <div class="font-semibold text-lg">×¦'××˜</div>
            <div class="text-sm small-muted">×©×•×—×—×• ××—×“-×¢×-××—×“ ×¢× ×—×‘×¨×™×</div>
          </div>
        </div>

        <div class="card p-4 flex items-center gap-4 clickable" onclick="goTo('activities')">
          <div class="w-14 h-14 rounded-full bg-gradient-to-tr from-[#FF9AA2] to-[#FF6B6B] flex items-center justify-center text-white text-xl"><i class="fa-solid fa-calendar-day"></i></div>
          <div>
            <div class="font-semibold text-lg">×¤×¢×™×œ×•×™×•×ª</div>
            <div class="text-sm small-muted">××¤×’×©×™× ××§×•××™×™× ×•×¡×“× ××•×ª</div>
          </div>
        </div>

        <div class="card p-4 flex items-center gap-4 clickable" onclick="goTo('forums')">
          <div class="w-14 h-14 rounded-full bg-gradient-to-tr from-[#A0D8EF] to-[#6FBDE8] flex items-center justify-center text-white text-xl"><i class="fa-solid fa-users"></i></div>
          <div>
            <div class="font-semibold text-lg">×¤×•×¨×•××™×</div>
            <div class="text-sm small-muted">×©××œ×•×ª, ×¢×¦×•×ª ×•×—×•×•×™×•×ª</div>
          </div>
        </div>

        <div class="card p-4 flex items-center gap-4 clickable" onclick="goTo('helpCenter')">
          <div class="w-14 h-14 rounded-full bg-gradient-to-tr from-[#FFD27A] to-[#FFCD4D] flex items-center justify-center text-white text-xl"><i class="fa-solid fa-hands-helping"></i></div>
          <div>
            <div class="font-semibold text-lg">××¨×›×– ×¢×–×¨×”</div>
            <div class="text-sm small-muted">×¤× ×• ×œ×¢×–×¨×” ××©×¤×˜×™×ª, ×˜×¤×¡×™×, ×ª××™×›×” ×˜×›× ×™×ª ×•×¢×•×“</div>
          </div>
        </div>
      </div>
    </section>

    <section class="grid lg:grid-cols-2 gap-4">
      <div class="card p-4">
        <h3 class="font-semibold mb-3">×¤×•×¨×•××™× ××—×¨×•× ×™×</h3>
        <div id="forumsListSmall">×˜×•×¢×Ÿ...</div>
      </div>

      <div class="card p-4">
        <h3 class="font-semibold mb-3">×¤×¢×™×œ×•×™×•×ª ×§×¨×•×‘×•×ª</h3>
        <div id="activitiesListSmall">×˜×•×¢×Ÿ...</div>
      </div>
    </section>
  `;
}
function afterHomeRender(){
  renderDailyTipSafe();
  renderForumsSmall();
  renderActivitiesSmall();
}

/* ===================== Login/Register ===================== */
function renderLogin(){
  return `
    <div class="card p-6 max-w-md mx-auto">
      <h2 class="text-xl font-bold mb-2">×”×ª×—×‘×¨×•×ª</h2>
      <div class="mb-2"><label class="text-sm">××™××™×™×œ</label><input id="loginEmail" type="email" class="w-full p-2 border rounded" /></div>
      <div class="mb-4"><label class="text-sm">×¡×™×¡××”</label><input id="loginPwd" type="password" class="w-full p-2 border rounded" /></div>
      <div class="flex gap-2 justify-end">
        <button class="pill bg-white border" onclick="goTo('home')">×‘×˜×œ</button>
        <button class="pill btn-primary" onclick="doLogin()">×”×ª×—×‘×¨</button> 
      </div>
      <div class="mt-4 text-sm small-muted">××™×Ÿ ×œ×š ×—×©×‘×•×Ÿ? <button class="text-blue-600 underline" onclick="goTo('register')">×”×¨×©× ×›××Ÿ</button></div>
    </div>
  `;
}
function renderRegister(){
  const hobbies = ['×˜×™×•×œ×™×','×§×¨×™××”','×’×™× ×•×Ÿ','×‘×™×©×•×œ','×©×™×¨×”/××•×¡×™×§×”','×™×¦×™×¨×”','×¡×¤×•×¨×˜ ×¢×“×™×Ÿ','××©×—×§×™ ×§×•×¤×¡×”','×ª×¤×™×¨×”'];
  const contributions = ['×¢×–×¨×” ×˜×›× ×™×ª','××™×œ×•×™ ×˜×¤×¡×™×','×™×™×¢×•×¥ ××©×¤×˜×™','×”×¡×¢×”/×§× ×™×•×ª','×”×“×¨×›×”/×”×•×¨××”','×‘×™×©×•×œ ×œ×™×•××™×™×','×¡×™×•×¢ ×¨×’×©×™'];
  return `
    <div class="card p-6 max-w-2xl mx-auto">
      <h2 class="text-xl font-bold mb-3">×”×¨×©××”</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div><label class="text-sm">×©× ××œ×</label><input id="regName" class="w-full p-2 border rounded" /></div>
        <div><label class="text-sm">×©× ××©×ª××©</label><input id="regUsername" class="w-full p-2 border rounded" /></div>
        <div><label class="text-sm">××™××™×™×œ</label><input id="regEmail" type="email" class="w-full p-2 border rounded" /></div>
        <div><label class="text-sm">×¡×™×¡××”</label><input id="regPwd" type="password" class="w-full p-2 border rounded" /></div>
        <div><label class="text-sm">×’×™×œ</label><input id="regAge" type="number" min="18" class="w-full p-2 border rounded" /></div>
        <div><label class="text-sm">×¢×™×¨ / ×™×©×•×‘</label>
          <select id="regCity" class="w-full p-2 border rounded">
            <option value="">×‘×—×¨/×™</option>
            <option value="×ª×•×©×‘ ×—×•\"×œ">×ª×•×©×‘ ×—×•\"×œ</option>
            <option value="×ª×œ ××‘×™×‘">×ª×œ ××‘×™×‘</option>
            <option value="×™×¨×•×©×œ×™×">×™×¨×•×©×œ×™×</option>
            <option value="×—×™×¤×”">×—×™×¤×”</option>
            <option value="×‘××¨ ×©×‘×¢">×‘××¨ ×©×‘×¢</option>
            <option value="×¨××©×•×Ÿ ×œ×¦×™×•×Ÿ">×¨××©×•×Ÿ ×œ×¦×™×•×Ÿ</option>
            <option value="× ×¦×¨×ª">× ×¦×¨×ª</option>
            <option value="××—×¨">××—×¨</option>
          </select>
        </div>

        <div class="md:col-span-2">
          <label class="text-sm">×ª×—×‘×™×‘×™× (×‘×—×¨×• ××¡×¤×¨)</label>
          <div id="hobbiesList" class="grid grid-cols-2 gap-2 mt-2">
            ${hobbies.map(h=>`<label class="inline-flex items-center gap-2 border p-2 rounded"><input type="checkbox" value="${escapeHtml(h)}" /> ${escapeHtml(h)}</label>`).join('')}
            <label class="inline-flex items-center gap-2 border p-2 rounded"><input id="hobbyOtherChk" type="checkbox" value="××—×¨" /> ××—×¨: <input id="hobbyOtherText" placeholder="×›×ª×•×‘..." class="ml-2 p-1 border rounded" /></label>
          </div>
        </div>

        <div class="md:col-span-2">
          <label class="text-sm">×‘××” ×ª×•×›×œ/×™ ×œ×ª×¨×•× ×œ×§×‘×•×¦×”?</label>
          <div id="contribList" class="grid grid-cols-2 gap-2 mt-2">
            ${contributions.map(c=>`<label class="inline-flex items-center gap-2 border p-2 rounded"><input type="checkbox" value="${escapeHtml(c)}" /> ${escapeHtml(c)}</label>`).join('')}
            <label class="inline-flex items-center gap-2 border p-2 rounded"><input id="contribOtherChk" type="checkbox" value="××—×¨" /> ××—×¨: <input id="contribOtherText" placeholder="×›×ª×•×‘..." class="ml-2 p-1 border rounded" /></label>
          </div>
        </div>

        <div class="md:col-span-2">
          <label class="text-sm">×ª××•× ×ª ×¤×¨×•×¤×™×œ (××•×¤×¦×™×•× ×œ×™) â€” ×”×¢×œ×” ×ª××•× ×” ××• ×‘×—×¨ ××™××•×’'×™</label>
          <div class="mt-2 flex gap-2 items-center">
            <input id="profileImage" type="file" accept="image/*" />
            <input id="emojiChoice" placeholder="×”×§×œ×“ ××™××•×’'×™..." class="p-2 border rounded w-32" />
          </div>
        </div>

        <div class="md:col-span-2">
          <label class="inline-flex items-center gap-2"><input id="agreeRules" type="checkbox" /> ×× ×™ ×××©×¨/×ª ××ª <a href="#" onclick="showRules()" class="text-blue-600 underline">×ª×§× ×•×Ÿ ×”×©×™××•×©</a> ×•××ª ×›×œ×œ×™ ×”×”×ª× ×”×’×•×ª</label>
          <div class="text-sm small-muted mt-2">×¢×œ ×™×“×™ ×”×”×¨×©××” ××ª×” ×××©×¨ ×›×™ ×”××™×“×¢ × ×›×•×Ÿ ×•××¡×›×™× ×œ×ª× ××™ ×”×§×”×™×œ×”.</div>
        </div>
      </div>

      <div class="mt-4 flex justify-end gap-2">
        <button class="pill bg-white border" onclick="goTo('home')">×‘×™×˜×•×œ</button>
        <button class="pill btn-primary" onclick="doRegister()">×”×¨×©×</button>
      </div>
    </div>
  `;
}
async function doLogin(){
    const email = document.getElementById('loginEmail').value.trim();
    const password = document.getElementById('loginPwd').value;
    if(!email || !password) return alert('× × ×œ××œ× ××ª ×›×œ ×”×©×“×•×ª');
    try {
        await auth.signInWithEmailAndPassword(email, password);
        // auth listener handles the rest
    } catch(error){
        console.error("Login failed:", error.code, error.message);
        alert(`×”×ª×—×‘×¨×•×ª × ×›×©×œ×”: ${error.message}`);
    }
}
async function doRegister(){
    if(!document.getElementById('agreeRules').checked) return alert('× × ×œ××©×¨ ××ª ×ª×§× ×•×Ÿ ×”×©×™××•×©');

    const name = document.getElementById('regName').value.trim();
    const username = document.getElementById('regUsername').value.trim();
    const email = document.getElementById('regEmail').value.trim();
    const password = document.getElementById('regPwd').value;
    const age = parseInt(document.getElementById('regAge').value) || null;
    const city = document.getElementById('regCity').value || null;
    const emoji = document.getElementById('emojiChoice').value.trim() || null;
    
    if(!name || !username || !email || !password || password.length < 6 || !age || !city) return alert('× × ×œ××œ× ××ª ×›×œ ×”×©×“×•×ª. ×¡×™×¡××” ×—×™×™×‘×ª ×œ×”×™×•×ª ×œ×¤×—×•×ª 6 ×ª×•×•×™×.');

    const hobbies = Array.from(document.querySelectorAll('#hobbiesList input[type="checkbox"]:checked')).map(c=>c.value).filter(v=>v!=='××—×¨');
    const hOther = document.getElementById('hobbyOtherText').value.trim();
    if(document.getElementById('hobbyOtherChk').checked && hOther) hobbies.push(hOther);

    const contribs = Array.from(document.querySelectorAll('#contribList input[type="checkbox"]:checked')).map(c=>c.value).filter(v=>v!=='××—×¨');
    const cOther = document.getElementById('contribOtherText').value.trim();
    if(document.getElementById('contribOtherChk').checked && cOther) contribs.push(cOther);

    try {
        const userCredential = await auth.createUserWithEmailAndPassword(email, password);
        const userId = userCredential.user.uid;

        // Create user document in Firestore
        await db.collection('users').doc(userId).set({
            name,
            username,
            email,
            age,
            city,
            hobbies,
            contributions: contribs,
            avatarEmoji: emoji,
            isOnline: true,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            role: 'user' // Default role
        });
        
        // Log in the user immediately (handled by auth listener)
        goTo('home');
    } catch(error){
        console.error("Registration failed:", error.code, error.message);
        alert(`×”×¨×©××” × ×›×©×œ×”: ${error.message}`);
    }
}


/* ===================== Forums ===================== */
function renderForums(){
  return `
    <div class="card p-4">
      <div class="flex items-center justify-between mb-3">
        <div><h3 class="text-lg font-semibold">×¤×•×¨×•××™×</h3><div class="text-sm small-muted">×©××œ×•×ª, ×¢×¦×•×ª ×•×—×•×•×™×•×ª</div></div>
        <div class="flex gap-2">
          <input id="forumSearch" class="p-2 border rounded" placeholder="×—×¤×©..." oninput="searchForums()" />
          <button class="pill btn-primary" onclick="showCreateForumModal()">+ ×¤×ª×— ×¤×•×¨×•×</button>
        </div>
      </div>

      <div id="forumsFullList"></div>
      
      <div id="createForumModal" class="fixed inset-0 bg-black/30 hidden items-center justify-center z-50">
        <div class="bg-white p-6 rounded w-full max-w-lg card">
          <h4 class="font-semibold mb-2">×¦×•×¨ ×¤×•×¨×•× ×—×“×©</h4>
          <input id="newForumTitle" placeholder="×›×•×ª×¨×ª" class="w-full p-2 border rounded mb-2" />
          <textarea id="newForumDesc" placeholder="×ª×™××•×¨" class="w-full p-2 border rounded mb-2"></textarea>
          <div class="flex gap-2 justify-end">
            <button class="pill bg-white border" onclick="hideCreateForumModal()">×‘×™×˜×•×œ</button>
            <button class="pill btn-primary" onclick="createForum()">×¦×•×¨</button>
          </div>
        </div>
      </div>
    </div>
  `;
}
function searchForums(){
  const q = document.getElementById('forumSearch') ? document.getElementById('forumSearch').value.trim().toLowerCase() : '';
  const list = (state.forums||[]).filter(f => (f.title || '').toLowerCase().includes(q) || (f.description || '').toLowerCase().includes(q));
  const el = document.getElementById('forumsFullList'); if(!el) return;
  
  el.innerHTML = list.map(f=>`<div class="p-3 border rounded mb-2 flex items-center justify-between clickable" onclick="openForum('${f.id}')">
    <div>
      <div class="font-semibold">${escapeHtml(f.title)}</div>
      <div class="text-sm small-muted">${escapeHtml(f.description||'')}</div>
    </div>
    <div><span class="text-xs small-muted">${f.postCount||0} ×¤×•×¡×˜×™×</span></div>
  </div>`).join('') || '<div class="text-gray-500">××™×Ÿ ×¤×•×¨×•××™× ×ª×•×××™×</div>';
}
function openForum(forumId){
    goTo('forumDetails', { selectedForumId: forumId });
}
function showCreateForumModal(){ if(!state.user) return goTo('login'); document.getElementById('createForumModal').classList.remove('hidden'); }
function hideCreateForumModal(){ document.getElementById('createForumModal').classList.add('hidden'); }
async function createForum(){
  const title = document.getElementById('newForumTitle').value.trim();
  const desc = document.getElementById('newForumDesc').value.trim();
  if(!title) return alert('×”×–×Ÿ ×›×•×ª×¨×ª');
  try {
    const doc = await db.collection('forums').add({
      title, description: desc, postCount: 0,
      ownerId: state.user ? state.user.id : null,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    // Add to state and refresh list
    state.forums.unshift({ id: doc.id, title, description: desc, postCount: 0, ownerId: state.user?state.user.id:null });
    hideCreateForumModal();
    searchForums();
  } catch(e){ console.error(e); alert('×©×’×™××” ×‘×™×¦×™×¨×ª ×¤×•×¨×•×'); }
}
async function deleteForum(forumId){
    if(!state.user || !['admin','senior'].includes(state.user.role)) return alert('××™×Ÿ ×”×¨×©××”');
    if(!confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×”×¤×•×¨×•× ×”×–×” ×•××ª ×›×œ ×”×¤×•×¡×˜×™× ×©×‘×•?')) return;
    try {
        await db.collection('forums').doc(forumId).delete();
        state.forums = state.forums.filter(f => f.id !== forumId);
        goTo('forums');
    } catch(e){ console.error(e); alert('×©×’×™××” ×‘××—×™×§×ª ×¤×•×¨×•×'); }
}

let currentForumUnsub = null;
function renderForumDetails(){
    const forum = state.forums.find(f => f.id === state.selectedForumId);
    if (!forum) return `<div class="p-4 card">×”×¤×•×¨×•× ×œ× × ××¦×</div>`;

    const isPermittedToDeleteForum = state.user && ['admin', 'senior'].includes(state.user.role);

    return `
        <div class="card p-4 mb-4">
            <div class="flex items-center justify-between mb-3">
                <h2 class="text-xl font-bold">${escapeHtml(forum.title)}</h2>
                <div class="flex gap-2">
                    ${isPermittedToDeleteForum ? `<button class="pill bg-red-500 text-white" onclick="deleteForum('${forum.id}')">××—×§ ×¤×•×¨×•×</button>` : ''} 
                    <button class="pill bg-white border" onclick="goTo('forums')">×—×–×•×¨ ×œ×¤×•×¨×•××™×</button>
                </div>
            </div>
            <p class="text-sm small-muted mb-4">${escapeHtml(forum.description || '')}</p>
            <button class="pill btn-primary" onclick="showCreatePostModal()">+ ×¤×ª×— ×¤×•×¡×˜ ×—×“×©</button>
            
            <div id="forumPostsList" class="mt-4">×˜×•×¢×Ÿ ×¤×•×¡×˜×™×...</div>
        </div>
        
        <div id="createPostModal" class="fixed inset-0 bg-black/30 hidden items-center justify-center z-50">
            <div class="bg-white p-6 rounded w-full max-w-lg card">
                <h4 class="font-semibold mb-2">×¤×¨×¡×•× ×¤×•×¡×˜ ×—×“×©</h4>
                <input id="newPostTitle" placeholder="×›×•×ª×¨×ª ×”×¤×•×¡×˜" class="w-full p-2 border rounded mb-2" />
                <textarea id="newPostBody" placeholder="×ª×•×›×Ÿ ×”×¤×•×¡×˜" class="w-full p-2 border rounded mb-2"></textarea>
                <div class="flex gap-2 justify-end">
                    <button class="pill bg-white border" onclick="hideCreatePostModal()">×‘×™×˜×•×œ</button>
                    <button class="pill btn-primary" onclick="createPost()">×¤×¨×¡×</button>
                </div>
            </div>
        </div>
        <div id="viewPostModal" class="fixed inset-0 bg-black/30 hidden items-center justify-center z-50">
            <div class="bg-white p-6 rounded w-full max-w-3xl card overflow-y-auto" style="max-height: 90vh;">
                <h4 id="viewPostTitle" class="text-xl font-bold mb-2"></h4>
                <div id="viewPostBody" class="mb-4"></div>
                <div id="viewPostAuthor" class="text-sm small-muted mb-4"></div>

                <h5 class="font-semibold mb-2">×ª×’×•×‘×•×ª (<span id="commentCount">0</span>)</h5>
                <div id="postCommentsList" class="mb-4 border-t pt-2">×˜×•×¢×Ÿ ×ª×’×•×‘×•×ª...</div>

                <div id="addCommentForm" class="mt-4 border-t pt-4">
                    <textarea id="newCommentBody" placeholder="×”×•×¡×£ ×ª×’×•×‘×”..." class="w-full p-2 border rounded mb-2"></textarea>
                    <div class="flex justify-end">
                        <button class="pill btn-primary" onclick="addComment()">×”×’×‘</button>
                    </div>
                </div>
                <div class="mt-4 flex justify-end">
                    <button class="pill bg-white border" onclick="hideViewPostModal()">×¡×’×•×¨</button>
                </div>
            </div>
        </div>
    `;
}
function afterForumDetailsRender(){
    if (currentForumUnsub) currentForumUnsub();
    
    // Listen to posts in the selected forum
    currentForumUnsub = db.collection('forums').doc(state.selectedForumId).collection('posts')
        .orderBy('createdAt', 'desc')
        .onSnapshot(snap => {
            state.forumPosts = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            renderPostsList();
        }, err => console.error('Forum posts listen failed', err));
}
function renderPostsList(){
    const el = document.getElementById('forumPostsList'); if(!el) return;
    if(!state.forumPosts || state.forumPosts.length === 0){
        el.innerHTML = '<div class="text-gray-500">××™×Ÿ ×¤×•×¡×˜×™× ×‘×¤×•×¨×•× ×–×”.</div>';
        return;
    }
    
    el.innerHTML = state.forumPosts.map(p=>{
        const author = state.users.find(u => u.id === p.authorId) || { name: '××©×ª××© ×œ× ×™×“×•×¢' };
        return `
            <div class="p-3 border rounded mb-2 clickable hover:bg-gray-50" onclick="viewPost('${p.id}')">
                <div class="font-semibold">${escapeHtml(p.title)}</div>
                <div class="text-sm small-muted flex justify-between">
                    <span>×¤×•×¨×¡× ×¢"×™ ${escapeHtml(author.name)}</span>
                    <span>${p.commentCount || 0} ×ª×’×•×‘×•×ª</span>
                </div>
            </div>
        `;
    }).join('');
}
function showCreatePostModal(){ if(!state.user) return goTo('login'); document.getElementById('createPostModal').classList.remove('hidden'); }
function hideCreatePostModal(){ document.getElementById('createPostModal').classList.add('hidden'); }
async function createPost(){
    const title = document.getElementById('newPostTitle').value.trim();
    const body = document.getElementById('newPostBody').value.trim();
    if(!title || !body) return alert('× × ×œ××œ× ×›×•×ª×¨×ª ×•×ª×•×›×Ÿ');

    try {
        const postRef = await db.collection('forums').doc(state.selectedForumId).collection('posts').add({
            title, body,
            authorId: state.user.id,
            commentCount: 0,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        // Update post count on the forum document
        await db.collection('forums').doc(state.selectedForumId).update({
            postCount: firebase.firestore.FieldValue.increment(1)
        });

        hideCreatePostModal();
        viewPost(postRef.id); // Open the new post
    } catch(e){ console.error(e); alert('×©×’×™××” ×‘×¤×¨×¡×•× ×¤×•×¡×˜'); }
}
async function deletePost(postId){
    const post = state.forumPosts.find(p => p.id === postId);
    if (!state.user || !post) return alert('×©×’×™××ª ××©×ª××© ××• ×¤×•×¡×˜');
    
    // ğŸ›‘ ×”×¨×©××ª ××—×™×§×ª ×¤×•×¡×˜: ××“××™×Ÿ ××• ×‘×›×™×¨, ××• ××—×‘×¨ ×”×¤×•×¡×˜
    const canDelete = ['admin', 'senior'].includes(state.user.role) || state.user.id === post.authorId;
    if (!canDelete) return alert('××™×Ÿ ×”×¨×©××” ×œ××—×•×§ ×¤×•×¡×˜ ×–×”');

    if(!confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×”×¤×•×¡×˜ ×”×–×” ×•××ª ×›×œ ×”×ª×’×•×‘×•×ª ×©×œ×•?')) return;
    try {
        await db.collection('forums').doc(state.selectedForumId).collection('posts').doc(postId).delete();
        await db.collection('forums').doc(state.selectedForumId).update({
            postCount: firebase.firestore.FieldValue.increment(-1)
        });
        hideViewPostModal();
        renderPostsList(); // Re-render the list immediately
    } catch(e){ console.error(e); alert('×©×’×™××” ×‘××—×™×§×ª ×”×¤×•×¡×˜'); }
}

let currentCommentsUnsub = null;
let currentPostId = null;
function viewPost(postId){
    if(!state.user) return goTo('login');
    currentPostId = postId;
    const post = state.forumPosts.find(p => p.id === postId);
    if (!post) return alert('×¤×•×¡×˜ ×œ× × ××¦×');

    const author = state.users.find(u => u.id === post.authorId) || { name: '××©×ª××© ×œ× ×™×“×•×¢' };
    
    document.getElementById('viewPostTitle').innerText = escapeHtml(post.title);
    document.getElementById('viewPostBody').innerHTML = `<p>${escapeHtml(post.body.replace(/\n/g, '<br>'))}</p>`;
    
    let deleteBtn = '';
    // ğŸ›‘ ×‘×“×™×§×ª ×”×¨×©××” ×œ××—×™×§×ª ×”×¤×•×¡×˜
    const canDeletePost = ['admin', 'senior'].includes(state.user.role) || state.user.id === post.authorId;
    if (canDeletePost) {
        deleteBtn = `<button class="pill bg-red-500 text-white text-xs mr-2" onclick="deletePost('${postId}')">××—×§ ×¤×•×¡×˜</button>`;
    }
    
    document.getElementById('viewPostAuthor').innerHTML = `×¤×•×¨×¡× ×¢"×™ <strong>${escapeHtml(author.name)}</strong> ${deleteBtn}`;


    document.getElementById('viewPostModal').classList.remove('hidden');

    // Subscribe to comments
    if (currentCommentsUnsub) currentCommentsUnsub();
    currentCommentsUnsub = db.collection('forums').doc(state.selectedForumId).collection('posts').doc(postId).collection('comments')
        .orderBy('createdAt', 'asc')
        .onSnapshot(snap => {
            state.postComments = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            renderComments();
        }, err => console.error('Comments listen failed', err));
}
function hideViewPostModal(){
    document.getElementById('viewPostModal').classList.add('hidden');
    if (currentCommentsUnsub) currentCommentsUnsub();
    currentCommentsUnsub = null;
    currentPostId = null;
}
function renderComments(){
    const el = document.getElementById('postCommentsList'); if(!el) return;
    document.getElementById('commentCount').innerText = state.postComments ? state.postComments.length : 0;

    if(!state.postComments || state.postComments.length === 0){
        el.innerHTML = '<div class="text-sm small-muted">××™×Ÿ ×ª×’×•×‘×•×ª, ×”×•×¡×£/×™ ××ª ×”×¨××©×•× ×”!</div>';
        return;
    }

    el.innerHTML = state.postComments.map(c=>{
        const author = state.users.find(u => u.id === c.authorId) || { name: '××©×ª××© ×œ× ×™×“×•×¢' };
        const createdAt = c.createdAt ? new Date(c.createdAt.seconds * 1000).toLocaleDateString('he-IL') : '';
        
        let deleteBtn = '';
        // ğŸ›‘ ×”×¨×©××ª ××—×™×§×ª ×ª×’×•×‘×”: ××“××™×Ÿ ××• ×‘×›×™×¨, ××• ××—×‘×¨ ×”×ª×’×•×‘×”
        const canDeleteComment = ['admin', 'senior'].includes(state.user.role) || state.user.id === c.authorId;
        if (canDeleteComment) {
            deleteBtn = `<button class="pill bg-red-400 text-white text-xs mr-2" onclick="deleteComment('${c.id}')">××—×§</button>`;
        }
        
        return `
            <div class="p-3 border-b border-gray-100 flex items-start gap-3">
                <div class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center text-sm">${author.avatarEmoji || (author.name||'×').charAt(0)}</div>
                <div class="flex-1">
                    <div class="font-semibold text-sm">${escapeHtml(author.name)} <span class="text-xs small-muted">${createdAt}</span></div>
                    <p class="text-sm mt-1">${escapeHtml(c.body)}</p>
                    <div class="mt-2">${deleteBtn}</div> 
                </div>
            </div>
        `;
    }).join('');
}
async function addComment(){
    const body = document.getElementById('newCommentBody').value.trim();
    if(!body) return alert('× × ×œ×›×ª×•×‘ ×ª×’×•×‘×”');
    if(!currentPostId || !state.selectedForumId) return alert('×©×’×™××”: ×¤×•×¡×˜ ×œ× × ×‘×—×¨');

    try {
        await db.collection('forums').doc(state.selectedForumId).collection('posts').doc(currentPostId).collection('comments').add({
            body,
            authorId: state.user.id,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        // Update comment count on the post document
        await db.collection('forums').doc(state.selectedForumId).collection('posts').doc(currentPostId).update({
            commentCount: firebase.firestore.FieldValue.increment(1)
        });

        document.getElementById('newCommentBody').value = '';
        // The listener will re-render comments and update count
    } catch(e){ console.error(e); alert('×©×’×™××” ×‘×”×•×¡×¤×ª ×ª×’×•×‘×”'); }
}
async function deleteComment(commentId){
    const comment = state.postComments.find(c => c.id === commentId);
    if (!state.user || !comment || !currentPostId || !state.selectedForumId) return alert('×©×’×™××ª ××©×ª××© ××• ×ª×’×•×‘×”');

    // ğŸ›‘ ×‘×“×™×§×ª ×”×¨×©××” ×œ××—×™×§×ª ×ª×’×•×‘×”
    const canDelete = ['admin', 'senior'].includes(state.user.role) || state.user.id === comment.authorId;
    if (!canDelete) return alert('××™×Ÿ ×”×¨×©××” ×œ××—×•×§ ×ª×’×•×‘×” ×–×•');
    
    if(!confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ×ª×’×•×‘×” ×–×•?')) return;

    try {
        await db.collection('forums').doc(state.selectedForumId).collection('posts').doc(currentPostId).collection('comments').doc(commentId).delete();
        
        // Update comment count on the post document
        await db.collection('forums').doc(state.selectedForumId).collection('posts').doc(currentPostId).update({
            commentCount: firebase.firestore.FieldValue.increment(-1)
        });

        // The listener will re-render comments and update count
    } catch(e){ console.error(e); alert('×©×’×™××” ×‘××—×™×§×ª ×ª×’×•×‘×”'); }
}

/* ===================== Activities ===================== */
function renderActivities(){
  return `
    <div class="card p-4">
      <div class="flex items-center justify-between mb-3">
        <div><h3 class="text-lg font-semibold">×¤×¢×™×œ×•×™×•×ª</h3><div class="text-sm small-muted">×¨×©×•×/×™ ×œ×¤×¢×™×œ×•×™×•×ª ×§×¨×•×‘×•×ª</div></div>
        <div>
          ${state.user ? `<button class="pill btn-primary" onclick="showCreateActivityModal()">×”×•×¡×£ ×¤×¢×™×œ×•×ª</button>` : `<button class="pill bg-white border" onclick="goTo('login')">×”×ª×—×‘×¨ ×›×“×™ ×œ×”×•×¡×™×£</button>`}
        </div>
      </div>
      
      <div class="flex gap-2 mb-4">
          <input id="activitySearch" placeholder="×—×¤×© ×œ×¤×™ ×›×•×ª×¨×ª / ××™×§×•×..." class="p-2 border rounded flex-grow" oninput="renderActivitiesList()" />
          <select id="activityTypeFilter" class="p-2 border rounded" onchange="renderActivitiesList()">
            <option value="">×›×œ ×”×¡×•×’×™×</option>
            <option value="×˜×™×•×œ">×˜×™×•×œ</option>
            <option value="×”×¨×¦××”">×”×¨×¦××”</option>
            <option value="×¡×“× ×”">×¡×“× ×”</option>
            <option value="××¤×’×© ×—×‘×¨×ª×™">××¤×’×© ×—×‘×¨×ª×™</option>
          </select>
      </div>

      <div id="activitiesFullList"></div>

      <div id="createActivityModal" class="fixed inset-0 bg-black/30 hidden items-center justify-center z-50">
        <div class="bg-white p-6 rounded w-full max-w-lg card">
          <h4 class="font-semibold mb-2">×”×•×¡×¤×ª ×¤×¢×™×œ×•×ª</h4>
          <input id="actTitle" placeholder="×›×•×ª×¨×ª" class="w-full p-2 border rounded mb-2" />
          <input id="actDate" type="date" class="w-full p-2 border rounded mb-2" />
          <input id="actLocation" placeholder="××™×§×•×" class="w-full p-2 border rounded mb-2" />
          <input id="actType" placeholder="×¡×•×’ ×”×¤×¢×™×œ×•×ª (×œ×“×•×’××: ×˜×™×•×œ, ×”×¨×¦××”)" class="w-full p-2 border rounded mb-2" />
          <input id="actCapacity" type="number" placeholder="×›××•×ª ××§×•××•×ª (×¨×™×§ = ×œ×œ× ×”×’×‘×œ×”)" class="w-full p-2 border rounded mb-2" />
          <textarea id="actDesc" placeholder="×ª×™××•×¨" class="w-full p-2 border rounded mb-2"></textarea>
          <div class="flex gap-2 justify-end">
            <button class="pill bg-white border" onclick="hideCreateActivityModal()">×‘×™×˜×•×œ</button>
            <button class="pill btn-primary" onclick="createActivity()">×©××•×¨</button>
          </div>
        </div>
      </div>
    </div>
  `;
}
function renderActivitiesList(){
    const q = document.getElementById('activitySearch') ? document.getElementById('activitySearch').value.trim().toLowerCase() : '';
    const type = document.getElementById('activityTypeFilter') ? document.getElementById('activityTypeFilter').value : '';

    const list = (state.activities||[]).filter(a => {
        const titleMatch = (q ? (a.title || '').toLowerCase().includes(q) : true);
        const locationMatch = (q ? (a.location || '').toLowerCase().includes(q) : true);
        const typeMatch = (type === '' || (a.type && a.type === type));

        return (titleMatch || locationMatch) && typeMatch;
    });

    const el = document.getElementById('activitiesFullList'); if(!el) return;
    if(!list.length){ el.innerHTML = '<div class="text-gray-500">××™×Ÿ ×¤×¢×™×œ×•×™×•×ª ×ª×•×××•×ª</div>'; return; }
    
    list.sort((a, b) => (a.date || '').localeCompare(b.date || ''));

    el.innerHTML = list.map(a=>`<div class="p-3 border rounded mb-2"><div class="font-semibold">${escapeHtml(a.title)}</div><div class="text-sm small-muted">${escapeHtml(a.location||'')} â€¢ ${escapeHtml(a.type||'××—×¨')}</div><div class="mt-2"><button class="pill btn-primary" onclick="openActivity('${a.id}')">×¤×ª×—</button></div></div>`).join('');
}
function showCreateActivityModal(){ document.getElementById('createActivityModal').classList.remove('hidden'); }
function hideCreateActivityModal(){ document.getElementById('createActivityModal').classList.add('hidden'); }
async function createActivity(){
  const title = document.getElementById('actTitle').value.trim();
  const date = document.getElementById('actDate').value;
  const location = document.getElementById('actLocation').value.trim();
  const type = document.getElementById('actType').value.trim();
  const capacity = parseInt(document.getElementById('actCapacity').value) || null;
  const desc = document.getElementById('actDesc').value.trim();
  if(!title) return alert('×”×–×Ÿ ×›×•×ª×¨×ª');
  try {
    const doc = await db.collection('activities').add({
      title, date, location, type, capacity, description: desc,
      ownerId: state.user ? state.user.id : null,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    state.activities.unshift({ id: doc.id, title, date, location, type, capacity, description: desc, ownerId: state.user?state.user.id:null });
    hideCreateActivityModal();
    render();
  } catch(e){ console.error(e); alert('×©×’×™××” ×‘×™×¦×™×¨×ª ×¤×¢×™×œ×•×ª'); }
}
function openActivity(activityId){
    alert(`×¤×•×ª×— ×¤×¢×™×œ×•×ª: ${activityId}`);
    // Future implementation: render a dedicated activity details page
}


/* ===================== Help Center ===================== */
function renderHelpCenter(){
  return `
    <div class="card p-4">
      <div class="flex items-center justify-between mb-3">
        <div><h3 class="text-lg font-semibold">××¨×›×– ×¢×–×¨×”</h3><div class="text-sm small-muted">×”×¤×•×¨×•× ××™×•×¢×“ ×œ×¢×–×¨×” ×¢×œ ×‘×¡×™×¡ ×§×”×™×œ×ª×™ ×‘×œ×‘×“ â€” ××™×Ÿ ×‘×›×š ×™×™×¢×•×¥ ××§×¦×•×¢×™ ××˜×¢× ×‘×¢×œ×™ ×”××ª×¨.</div></div>
        <div>
          ${state.user ? `<button class="pill btn-primary" onclick="showHelpModal()">×©×œ×— ×‘×§×©×”</button>` : `<button class="pill bg-white border" onclick="goTo('login')">×”×ª×—×‘×¨</button>`}
          ${state.user && state.user.role==='admin' ? `<button class="pill btn-sec ml-2" onclick="goTo('admin')">× ×™×”×•×œ ××¨×›×– ×¢×–×¨×”</button>` : ''}
        </div>
      </div>

      <div class="mb-4">
        <button class="pill bg-white border" onclick="toggleHelpCategories()">×§×˜×’×•×¨×™×•×ª</button>
      </div>

      <div class="grid md:grid-cols-3 gap-3 mb-4 hidden" id="helpCategoriesGrid">
          ${(state.helpCategories||[]).map(c=>`<div class="p-4 card clickable" onclick="filterHelpRequests('${c.id}')">${escapeHtml(c.title||c.name||'')}</div>`).join('') || '<div class="p-4 text-sm small-muted col-span-full">×œ× ×”×•×’×“×¨×• ×§×˜×’×•×¨×™×•×ª ×¢×–×¨×” (××“××™×Ÿ × ×“×¨×© ×œ×”×’×“×™×¨).</div>'}
      </div>

      <div id="helpRequestsList"></div>

      <div id="helpModal" class="fixed inset-0 bg-black/30 hidden items-center justify-center z-50">
        <div class="bg-white p-6 rounded w-full max-w-lg card">
          <h4 class="font-semibold mb-2">×©×’×¨ ×‘×§×©×” ×œ×¢×–×¨×”</h4>
          <label class="text-sm small-muted">×‘×—×¨ ×§×˜×’×•×¨×™×”</label>
          <select id="helpCatSelect" class="w-full p-2 border rounded mb-2"></select>
          <input id="helpTitle" placeholder="×›×•×ª×¨×ª" class="w-full p-2 border rounded mb-2" />
          <textarea id="helpBody" placeholder="×ª××¨/×™ ××ª ×”×‘×§×©×”" class="w-full p-2 border rounded mb-2"></textarea>
          <div class="flex gap-2 justify-end">
            <button class="pill bg-white border" onclick="hideHelpModal()">×‘×™×˜×•×œ</button>
            <button class="pill btn-primary" onclick="submitHelpRequest()">×©×œ×—</button>
          </div>
        </div>
      </div>
    </div>
  `;
}
function toggleHelpCategories(){
    const grid = document.getElementById('helpCategoriesGrid');
    if(!grid) return;
    if(grid.classList.contains('hidden')){
        grid.classList.remove('hidden');
    } else {
        grid.classList.add('hidden');
    }
}
function renderHelpRequestsList(){
    const el = document.getElementById('helpRequestsList'); if(!el) return;
    if(!state.helpRequests || state.helpRequests.length === 0){
        el.innerHTML = '<div class="text-gray-500">××™×Ÿ ×‘×§×©×•×ª ×¢×–×¨×” ×¤×ª×•×—×•×ª ×›×¨×’×¢.</div>';
        return;
    }

    el.innerHTML = state.helpRequests.map(r=>{
        const author = state.users.find(u => u.id === r.authorId) || { name: '××©×ª××© ×œ× ×™×“×•×¢' };
        const category = state.helpCategories.find(c => c.id === r.categoryId) || { title: '×›×œ×œ×™' };
        const statusClass = r.status === 'open' ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700';

        return `
            <div class="p-3 border rounded mb-2">
                <div class="flex justify-between items-center">
                    <div class="font-semibold">${escapeHtml(r.title)}</div>
                    <span class="text-xs pill ${statusClass}">${r.status === 'open' ? '×¤×ª×•×—' : '×˜×•×¤×œ'}</span>
                </div>
                <div class="text-sm small-muted mt-1">×§×˜×’×•×¨×™×”: ${escapeHtml(category.title)} | ×××ª: ${escapeHtml(author.name)}</div>
                <div class="text-sm mt-2">${escapeHtml(r.body.substring(0, 100))}...</div>
                <div class="mt-2 text-right">
                    <button class="pill btn-primary text-xs" onclick="viewHelpRequest('${r.id}')">×¤×ª×—</button>
                </div>
            </div>
        `;
    }).join('');
}
function filterHelpRequests(categoryId){
    alert(`××¡× ×Ÿ ×‘×§×©×•×ª ×œ×¤×™ ×§×˜×’×•×¨×™×”: ${categoryId}`);
}
function showHelpModal(){ 
    if(!state.user) return goTo('login');
    document.getElementById('helpModal').classList.remove('hidden'); 
    const sel=document.getElementById('helpCatSelect'); 
    if(sel) sel.innerHTML = (state.helpCategories||[]).map(c=>`<option value="${c.id}">${escapeHtml(c.title||c.name||'')}</option>`).join('');
    if(state.helpCategories.length === 0){
        sel.innerHTML = '<option value="">(××™×Ÿ ×§×˜×’×•×¨×™×•×ª, ×¤× ×” ×œ××“××™×Ÿ)</option>';
        alert('××™×Ÿ ×§×˜×’×•×¨×™×•×ª ×¢×–×¨×” ×–××™× ×•×ª. × × ×œ×¤× ×•×ª ×œ×× ×”×œ ×”××ª×¨.');
    }
}
function hideHelpModal(){ document.getElementById('helpModal').classList.add('hidden'); }
async function submitHelpRequest(){
  const cat = document.getElementById('helpCatSelect').value;
  const title = document.getElementById('helpTitle').value.trim();
  const body = document.getElementById('helpBody').value.trim();
  if(!title||!body || !cat) return alert('××œ× ××ª ×›×œ ×”×©×“×•×ª ×•×‘×—×¨ ×§×˜×’×•×¨×™×”');
  
  try {
    await db.collection('helpRequests').add({ 
        categoryId: cat, title, body, 
        authorId: state.user? state.user.id : null, 
        status:'open', 
        createdAt: firebase.firestore.FieldValue.serverTimestamp() 
    });
    alert('×”×‘×§×©×” × ×©×œ×—×” ×œ×§×”×™×œ×”');
    hideHelpModal();
    // Fetch and re-render the list
    await db.collection('helpRequests').get().then(snap => {
        state.helpRequests = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        renderHelpRequestsList();
    });
  } catch(e) {
      console.error(e);
      alert('×©×’×™××” ×‘×©×œ×™×—×ª ×‘×§×©×ª ×¢×–×¨×”');
  }
}
function viewHelpRequest(requestId){
    alert(`×¤×•×ª×— ×‘×§×©×ª ×¢×–×¨×”: ${requestId}`);
    // Future implementation: render a dedicated help request details page
}

/* ===================== Users ===================== */
function renderUsers(){
  return `
    <div class="card p-4">
      <div class="flex items-center justify-between mb-3">
        <div><h3 class="text-lg font-semibold">×—×‘×¨×™×</h3><div class="text-sm small-muted">×¡×™× ×•×Ÿ ×œ×¤×™ ×¢×™×¨ / ×—×™×¤×•×©</div></div>
        <div class="flex gap-2">
          <select id="cityFilter" class="p-2 border rounded" onchange="renderUsersList()"><option value="">×›×œ ×”×¢×¨×™×</option></select>
          <select id="onlineFilter" class="p-2 border rounded" onchange="renderUsersList()">
            <option value="">×”×›×œ</option>
            <option value="online">××—×•×‘×¨×™×</option>
            <option value="offline">×œ× ××—×•×‘×¨×™×</option>
          </select>
          <input id="userSearch" placeholder="×—×¤×© ×©×..." class="p-2 border rounded" oninput="renderUsersList()" />
        </div>
      </div>
      <div id="usersList"></div>
    </div>
  `;
}
function renderUsersList(){
  const q = document.getElementById('userSearch') ? document.getElementById('userSearch').value.trim().toLowerCase() : '';
  const city = document.getElementById('cityFilter') ? document.getElementById('cityFilter').value : '';
  const onlineStatus = document.getElementById('onlineFilter') ? document.getElementById('onlineFilter').value : ''; 

  const list = (state.users||[]).filter(u => {
      const cityMatch = (city === '' || (u.city && u.city === city)); 
      const nameMatch = (q ? (u.name || '').toLowerCase().includes(q) : true);
      const activeMatch = (u.isActive !== false);
      
      let statusMatch = true;
      if (onlineStatus === 'online') {
          statusMatch = u.isOnline === true;
      } else if (onlineStatus === 'offline') {
          statusMatch = u.isOnline === false;
      }
      
      return cityMatch && nameMatch && activeMatch && statusMatch;
  });
  
  const el = document.getElementById('usersList'); if(!el) return;
  if(!list.length){ el.innerHTML = '<div class="text-gray-500">××™×Ÿ ××©×ª××©×™×</div>'; return; }
  el.innerHTML = list.map(u=>`<div class="p-3 border rounded mb-2 flex items-center justify-between"><div class="flex items-center gap-3"><div class="w-12 h-12 rounded-full bg-gray-200 flex items-center justify-center text-xl">${u.avatarEmoji|| (u.name||'×').charAt(0)}</div><div><div class="font-semibold">${escapeHtml(u.name)}</div><div class="text-sm small-muted">${escapeHtml(u.city||'')}</div><div class="text-sm small-muted">×ª×—×‘×™×‘×™×: ${escapeHtml((u.hobbies||[]).join(', '))}</div></div></div><div class="flex gap-2"><button class="pill btn-primary" onclick="openChat('${u.id}','${escapeHtml(u.name)}')">×¦'××˜</button>${state.user && state.user.role==='admin'?`<button class="pill bg-red-400" onclick="adminDeleteUser('${u.id}')">××—×§</button>`:''}</div></div>`).join('');
}

/* ===================== Chat ===================== */
function renderChat(){
  if(!state.user) return `<div class="card p-4">×× × ×”×ª×—×‘×¨ ×›×“×™ ×œ×”×©×ª××© ×‘×¦'××˜</div>`;
  return `
    <div class="card p-4 flex flex-col" style="height:70vh;">
      <div class="flex items-center justify-between mb-3">
        <div><h3 class="text-lg font-semibold">×¦'××˜</h3><div class="text-sm small-muted">×¡× ×Ÿ ××©×ª××©×™× ×œ×¤×™ ×¢×™×¨ ××• ×—×¤×© ×©×</div></div>
        <div><button class="pill bg-white border" onclick="goTo('users')">×—×–×•×¨</button></div>
      </div>

      <div class="flex gap-4 h-full">
        <div class="w-1/3 border rounded p-2 overflow-y-auto">
          <div class="mb-2 flex gap-2">
            <select id="chatCityFilter" class="w-full p-2 border rounded" onchange="renderChatUsersList()"><option value="">×›×œ ×”×¢×¨×™×</option></select>
            <select id="chatOnlineFilter" class="w-full p-2 border rounded" onchange="renderChatUsersList()">
                <option value="">×”×›×œ</option>
                <option value="online">××—×•×‘×¨×™×</option>
                <option value="offline">×œ× ××—×•×‘×¨×™×</option>
            </select>
          </div>
          <div id="chatUsersList"></div>
        </div>

        <div class="flex-1 flex flex-col">
          <div id="chatBox" class="flex-grow overflow-y-auto p-3 space-y-3 bg-gray-50 rounded"></div>
          <div class="mt-3 flex gap-2 items-center">
            <input id="chatInput" type="text" placeholder="×›×ª×•×‘ ×”×•×“×¢×”..." class="flex-grow p-3 border rounded" onkeydown="if(event.key==='Enter') sendMessage()" />
            <button class="pill btn-primary" onclick="sendMessage()">×©×œ×—</button>
          </div>
        </div>
      </div>
    </div>
  `;
}
function renderChatUsersList(){
  const city = document.getElementById('chatCityFilter') ? document.getElementById('chatCityFilter').value : '';
  const onlineStatus = document.getElementById('chatOnlineFilter') ? document.getElementById('chatOnlineFilter').value : ''; 

  // 1. Filter users
  let list = (state.users||[]).filter(u => {
      const cityMatch = (city === '' || (u.city && u.city === city)); 
      const selfMatch = (u.id !== (state.user ? state.user.id : ''));
      const activeMatch = (u.isActive !== false);

      let statusMatch = true;
      if (onlineStatus === 'online') {
          statusMatch = u.isOnline === true;
      } else if (onlineStatus === 'offline') {
          statusMatch = u.isOnline === false;
      }
      
      return cityMatch && selfMatch && activeMatch && statusMatch;
  });

  // 2. Merge with chat metadata 
  list = list.map(u => ({
      ...u,
      chatMeta: state.chatsMeta[u.id] || { 
          lastMessageTime: null, 
          unreadCount: 0,
          lastMessage: '×”×ª×—×œ ×©×™×—×”' 
      }
  }));

  // 3. Sort
  list.sort((a, b) => {
      // Priority 1: Users with unread messages first
      if (a.chatMeta.unreadCount > 0 && b.chatMeta.unreadCount === 0) return -1;
      if (b.chatMeta.unreadCount > 0 && a.chatMeta.unreadCount === 0) return 1;

      // Priority 2: Sort by last message time (recent first)
      const timeA = a.chatMeta.lastMessageTime ? a.chatMeta.lastMessageTime.seconds : 0;
      const timeB = b.chatMeta.lastMessageTime ? b.chatMeta.lastMessageTime.seconds : 0;
      
      return timeB - timeA; 
  });
  
  const el = document.getElementById('chatUsersList'); if(!el) return;
  if(!list.length){ el.innerHTML = '<div class="text-gray-500">××™×Ÿ ××©×ª××©×™× ×ª×•×××™×</div>'; return; }
  
  el.innerHTML = list.map(u=>{
      const unreadBadge = u.chatMeta.unreadCount > 0 
          ? `<span class="inline-flex items-center justify-center px-2 py-0.5 text-xs font-bold text-white bg-red-500 rounded-full">${u.chatMeta.unreadCount > 99 ? '99+' : u.chatMeta.unreadCount}</span>`
          : '';
      const lastMsg = u.chatMeta.lastMessage && u.chatMeta.lastMessage !== '×”×ª×—×œ ×©×™×—×”'
          ? `<div class="text-xs small-muted truncate max-w-[150px]">${escapeHtml(u.chatMeta.lastMessage)}</div>`
          : `<div class="text-xs small-muted italic">×”×ª×—×œ/×™ ×©×™×—×”</div>`;
      
      const isUnread = u.chatMeta.unreadCount > 0;

      return `<div class="p-2 border-b flex items-center justify-between clickable ${isUnread ? 'bg-yellow-50/70 font-semibold' : ''}" onclick="openChat('${u.id}','${escapeHtml(u.name}')">
          <div class="flex flex-col">
              <div class="flex items-center gap-2">
                  <span>${escapeHtml(u.name)}</span> ${unreadBadge}
              </div> 
              ${lastMsg}
          </div>
          <div>${u.isOnline?'<span class="text-green-600 text-xs">××—×•×‘×¨</span>':'<span class="text-gray-400 text-xs">×œ× ××—×•×‘×¨</span>'}</div>
      </div>`;
  }).join('');
}
// Placeholder chat functions (need to be implemented for full functionality)
let currentChatUnsub = null;
async function openChat(userId, userName){
    if(!state.user) return goTo('login');
    if(currentChatUnsub) currentChatUnsub();
    state.selectedUser = { id: userId, name: userName };
    state.chatMessages = [];
    updateChatBox();

    const roomId = getChatRoomId(state.user.id, userId);

    // 1. Mark as read
    const myUnreadField = `unread_${state.user.id}`;
    db.collection('chats').doc(roomId).update({ [myUnreadField]: 0 })
        .then(() => updateUnreadTotal())
        .catch(e => console.warn('Failed to mark chat as read:', e));

    // 2. Listen to new messages
    currentChatUnsub = db.collection('chats').doc(roomId).collection('messages')
        .orderBy('createdAt', 'asc')
        .limit(50)
        .onSnapshot(snap => {
            state.chatMessages = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            updateChatBox(); 
        }, err => console.error('Chat listen failed', err));
}
function updateChatBox(){
    const box = document.getElementById('chatBox');
    if(!box) return;
    if(!state.selectedUser) {
        box.innerHTML = '<div class="text-center text-gray-500 mt-10">×‘×—×¨ ×—×‘×¨ ×›×“×™ ×œ×”×ª×—×™×œ ×©×™×—×”.</div>';
        return;
    }

    const userName = state.selectedUser.name;
    const myId = state.user.id;
    
    let html = `<div class="text-center text-sm small-muted mb-4 border-b pb-2">×©×™×—×” ×¢× <strong>${escapeHtml(userName)}</strong></div>`;
    
    if(state.chatMessages.length === 0) {
         html += '<div class="text-center text-gray-500 mt-10">×”×©×™×—×” ××ª×—×™×œ×” ×¢×›×©×™×•!</div>';
    } else {
        html += state.chatMessages.map(m => {
            const isMe = m.authorId === myId;
            return `<div class="flex ${isMe ? 'justify-end' : 'justify-start'}">
                <div class="max-w-xs p-3 rounded-lg ${isMe ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-800'}">
                    <div class="text-xs small-muted ${isMe ? 'text-blue-100' : 'text-gray-500'} mb-1">${isMe ? '×× ×™' : escapeHtml(userName)}</div>
                    ${escapeHtml(m.body)}
                </div>
            </div>`;
        }).join('');
    }
    
    box.innerHTML = html;
    box.scrollTop = box.scrollHeight;
}
async function sendMessage(){
    const input = document.getElementById('chatInput');
    const message = input.value.trim();
    if(!message || !state.selectedUser) return;

    const myId = state.user.id;
    const otherId = state.selectedUser.id;
    const roomId = getChatRoomId(myId, otherId);

    try {
        const batch = db.batch();
        const chatRef = db.collection('chats').doc(roomId);
        const msgRef = chatRef.collection('messages').doc();
        
        // 1. Add message
        batch.set(msgRef, {
            body: message,
            authorId: myId,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        // 2. Update chat metadata (last message and unread count for *other* user)
        const otherUnreadField = `unread_${otherId}`;
        const chatMeta = {
            participants: [myId, otherId],
            lastMessage: message,
            lastMessageTime: firebase.firestore.FieldValue.serverTimestamp(),
            [otherUnreadField]: firebase.firestore.FieldValue.increment(1),
            [`unread_${myId}`]: 0 // My unread count remains 0
        };
        batch.set(chatRef, chatMeta, { merge: true });

        await batch.commit();

        input.value = ''; // Clear input
    } catch(e) {
        console.error('Failed to send message:', e);
        alert('×©×’×™××” ×‘×©×œ×™×—×ª ×”×•×“×¢×”');
    }
}
async function updateUnreadTotal(){
    if(!state.user) return;
    const myId = state.user.id;
    const myUnreadField = `unread_${myId}`;
    
    try {
        const chatsSnap = await db.collection('chats')
            .where('participants', 'array-contains', myId)
            .get();
        
        let total = 0;
        let newChatsMeta = {};
        chatsSnap.forEach(d => {
            const data = d.data();
            const unread = data[myUnreadField] || 0;
            total += unread;

            // Also update chat metadata for chat users list
            const otherId = data.participants.find(p => p !== myId);
            if (otherId) {
                newChatsMeta[otherId] = {
                    lastMessageTime: data.lastMessageTime,
                    unreadCount: unread,
                    lastMessage: data.lastMessage
                };
            }
        });

        state.unreadTotal = total;
        state.chatsMeta = newChatsMeta;
        
        // If we are on the chat screen, re-render user list to reflect unread counts
        if(state.screen === 'chat') renderChatUsersList();
        
        updateHeader();
    } catch(e){
        console.warn('Failed to update unread total:', e);
    }
}


/* ===================== Admin ===================== */
function renderAdmin(){
  if(!state.user || state.user.role !== 'admin') return goTo('home');
  return `
    <div class="card p-4">
      <h3 class="text-lg font-semibold mb-3">×œ×•×— × ×™×”×•×œ</h3>

      <div class="grid md:grid-cols-2 gap-4">
        <div class="p-3 border rounded">
          <h4 class="font-semibold mb-2">××©×ª××©×™×</h4>
          <div id="adminUsersList">×˜×•×¢×Ÿ...</div>
        </div>

        <div class="p-3 border rounded">
          <h4 class="font-semibold mb-2">× ×™×”×•×œ ××¨×›×– ×¢×–×¨×” - ×§×˜×’×•×¨×™×•×ª</h4>
          <div class="flex gap-2 mb-3"><input id="newHelpCat" placeholder="×©× ×§×˜×’×•×¨×™×”" class="p-2 border rounded" /><button class="pill btn-primary" onclick="createHelpCategory()">×”×•×¡×£</button></div>
          <div id="adminHelpCats"></div>
        </div>
      </div>

      <div class="mt-4 p-3 border rounded">
        <h4 class="font-semibold mb-2">× ×™×”×•×œ ×¤×¢×™×œ×•×™×•×ª & ×“×™×•×•×—×™×</h4>
        <div id="adminActivities"></div>
      </div>
    </div>
  `;
}
function loadAdminLists(){
    renderAdminUsersList();
    renderAdminHelpCategories();
}
function renderAdminUsersList(){
    const el = document.getElementById('adminUsersList'); if(!el) return;
    const adminList = state.users.filter(u => u.id !== state.user.id);
    
    el.innerHTML = adminList.map(u => {
        const role = u.role === 'admin' ? '××“××™×Ÿ' : (u.role === 'senior' ? '×‘×›×™×¨' : '×¨×’×™×œ');
        return `
            <div class="p-2 border-b flex justify-between items-center text-sm">
                <span>${escapeHtml(u.name)} (${role})</span>
                <button class="pill bg-red-400 text-white text-xs" onclick="adminDeleteUser('${u.id}')">××—×§</button>
            </div>
        `;
    }).join('');
}
async function adminDeleteUser(userId){
    if(!state.user || state.user.role !== 'admin') return;
    if(!confirm(`×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×”××©×ª××© ×”×–×”?`)) return;

    try {
        // In a real app, this would be a Cloud Function call to delete Auth and Firestore data.
        // Here, we just mark the user as inactive in Firestore for simplicity.
        await db.collection('users').doc(userId).update({ isActive: false, isOnline: false });
        alert('×”××©×ª××© ×¡×•××Ÿ ×›×œ× ×¤×¢×™×œ. ×™×© ×œ××—×•×§ ××•×ª×• ×’× ×-Firebase Auth ×™×“× ×™×ª.');
        await fetchInitial(); 
        renderAdminUsersList(); 
    } catch(e) {
        console.error('Admin delete failed', e);
        alert('×©×’×™××” ×‘××—×™×§×ª ××©×ª××©');
    }
}
async function createHelpCategory(){
    const title = document.getElementById('newHelpCat').value.trim();
    if(!title) return alert('× × ×œ××œ× ×©× ×§×˜×’×•×¨×™×”');

    try {
        const doc = await db.collection('helpCenter').add({ title, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
        state.helpCategories.push({ id: doc.id, title });
        document.getElementById('newHelpCat').value = '';
        renderAdminHelpCategories();
    } catch(e){
        console.error('Create help category failed', e);
        alert('×©×’×™××” ×‘×™×¦×™×¨×ª ×§×˜×’×•×¨×™×”');
    }
}
function renderAdminHelpCategories(){
    const el = document.getElementById('adminHelpCats'); if(!el) return;
    el.innerHTML = (state.helpCategories||[]).map(c => `
        <div class="p-2 border-b flex justify-between items-center text-sm">
            <span>${escapeHtml(c.title)}</span>
            <button class="pill bg-red-400 text-white text-xs" onclick="deleteHelpCategory('${c.id}')">××—×§</button>
        </div>
    `).join('') || '<div class="text-gray-500">××™×Ÿ ×§×˜×’×•×¨×™×•×ª</div>';
}
async function deleteHelpCategory(categoryId){
    if(!confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ×§×˜×’×•×¨×™×” ×–×•?')) return;

    try {
        await db.collection('helpCenter').doc(categoryId).delete();
        state.helpCategories = state.helpCategories.filter(c => c.id !== categoryId);
        renderAdminHelpCategories();
    } catch(e){
        console.error('Delete help category failed', e);
        alert('×©×’×™××” ×‘××—×™×§×ª ×§×˜×’×•×¨×™×”');
    }
}


/* ===================== Data fetch / sync ===================== */
async function fetchInitial(){
  try {
    // users
    const usersSnap = await db.collection('users').get();
    state.users = usersSnap.docs.map(d=>({ id:d.id, ...d.data() }));

    // forums
    try {
      const forumsSnap = await db.collection('forums').get();
      state.forums = forumsSnap.docs.map(d=>({ id:d.id, ...d.data() }));
    } catch(e){ console.warn('forums fetch failed', e); state.forums = []; }

    // activities
    try {
      const actsSnap = await db.collection('activities').get();
      state.activities = actsSnap.docs.map(d=>({ id:d.id, ...d.data() }));
    } catch(e){ console.warn('activities fetch failed', e); state.activities = []; }

    // helpCategories (helpCenter)
    try {
      const helpCatsSnap = await db.collection('helpCenter').get();
      state.helpCategories = helpCatsSnap.docs.map(d=>({ id:d.id, ...d.data() }));
    } catch(e){ console.warn('helpCenter categories fetch failed', e); state.helpCategories = []; }
    
    // helpRequests
    try {
      const helpReqsSnap = await db.collection('helpRequests').orderBy('createdAt', 'desc').get();
      state.helpRequests = helpReqsSnap.docs.map(d=>({ id: d.id, ...d.data() }));
    } catch(e) { console.warn('helpRequests fetch failed', e); state.helpRequests = []; }

    // daily tips
    try {
      const tipsSnap = await db.collection('dailyTips').get();
      state.dailyTips = tipsSnap.docs.map(d=>({ id:d.id, ...d.data() }));
    } catch(e){ console.warn('dailyTips fetch failed', e); state.dailyTips = []; }
    
    // chat metadata 
    state.chatsMeta = {};
    if (state.user) {
        try {
            const chatsSnap = await db.collection('chats')
                .where('participants', 'array-contains', state.user.id)
                .get();
            chatsSnap.forEach(d => {
                const data = d.data();
                const otherId = data.participants.find(p => p !== state.user.id);
                if (otherId) {
                    state.chatsMeta[otherId] = {
                        lastMessageTime: data.lastMessageTime,
                        unreadCount: data[`unread_${state.user.id}`] || 0,
                        lastMessage: data.lastMessage
                    };
                }
            });
        } catch(e){ console.warn('chatsMeta fetch failed', e); state.chatsMeta = {}; }
    }

    // populate cities
    state.cities = Array.from(new Set(state.users.map(u=>u.city).filter(Boolean))).sort();
    
    // ğŸ›‘ ×ª×™×§×•×Ÿ: ×§×¨×™××” ×œ×¤×•× ×§×¦×™×” ×”×××œ××ª ××ª ×”×¡×™× ×•× ×™× ×œ××—×¨ ××—×–×•×¨ ×”× ×ª×•× ×™×
    populateCityFilters(); 

    // update header/unread
    if(state.user) updateUnreadTotal();

  } catch(err){
    console.error('fetchInitial critical error', err);
    if(err && err.code && err.code.includes && err.code.includes('permission')) {
      document.getElementById('root').innerHTML = `<div class="card p-4 text-red-600">×©×’×™××ª ×”×¨×©××•×ª ×‘-Firestore: ××™×Ÿ ×’×™×©×” ×œ××•×¡×¤×™×. ×•×“× ×©×”-Rules × ×›×•× ×™× ×•×©×”××©×ª××© ××—×•×‘×¨.</div>`;
    }
  }
}

/* ===================== Utilities ===================== */
const TIP_LIST = ["×¦××• ×œ×”×œ×™×›×” ×§×¦×¨×” ×•×”×ª×—×‘×¨×• ×œ×˜×‘×¢.", "×”×ª×§×©×¨×• ×œ×—×‘×¨ ×•×ª×©×ª×¤×• ×–×™×›×¨×•×Ÿ × ×—××“.", "× ×¡×• ×œ×”×›×™×Ÿ ×× ×” ×—×“×©×” ×¤×©×•×˜×”.", "×¢×©×• ×ª×¨×’×™×œ×™ × ×©×™××•×ª ×©×œ 5 ×“×§×•×ª.", "×›×ª×‘×• ××›×ª×‘ ×ª×•×“×” ×œ××“× ×™×§×¨."];
function getDailyTip(){ const d = new Date(); return TIP_LIST[d.getDate() % TIP_LIST.length]; }
function renderDailyTipSafe(){
  try {
    const el = document.getElementById('dailyTipContainer').querySelector('div');
    if(!el){ console.warn('dailyTipContainer missing'); return; }
    if(state.dailyTips && state.dailyTips.length){
      el.innerText = state.dailyTips[0].text || getDailyTip();
    } else {
      el.innerText = getDailyTip();
    }
    const btn = document.getElementById('refreshTipBtnHeader');
    if(btn){ btn.onclick = ()=>{ cycleTip(); }; }
  } catch(e){ console.error('renderDailyTipSafe', e); }
}
function cycleTip(){
  if(state.dailyTips && state.dailyTips.length){
    state.dailyTips.push(state.dailyTips.shift());
    renderDailyTipSafe();
  } else {
    const el = document.getElementById('dailyTipContainer').querySelector('div');
    if(el) el.innerText = getDailyTip();
  }
}
function populateCityFilters(){
  const cf = document.getElementById('cityFilter'); 
  if(cf){ 
    cf.innerHTML = `<option value="">×›×œ ×”×¢×¨×™×</option>${state.cities.map(c=>`<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join('')}`; 
  }
  const cc = document.getElementById('chatCityFilter'); 
  if(cc){ 
    cc.innerHTML = `<option value="">×›×œ ×”×¢×¨×™×</option>${state.cities.map(c=>`<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join('')}`; 
  }
}
// Placeholder functions for small lists in home screen
function renderForumsSmall(){
    const el = document.getElementById('forumsListSmall');
    if(el) el.innerHTML = (state.forums||[]).slice(0, 3).map(f => `
        <div class="p-2 border-b last:border-b-0 clickable" onclick="openForum('${f.id}')">
            <div class="font-semibold text-sm">${escapeHtml(f.title)}</div>
            <div class="text-xs small-muted">${f.postCount||0} ×¤×•×¡×˜×™×</div>
        </div>
    `).join('') || '<div class="text-gray-500 text-sm">××™×Ÿ ×¤×•×¨×•××™× ×—×“×©×™×.</div>';
}
function renderActivitiesSmall(){
    const el = document.getElementById('activitiesListSmall');
    const today = new Date().toISOString().split('T')[0];
    const upcoming = (state.activities || []).filter(a => (a.date || '') >= today).sort((a, b) => (a.date || '').localeCompare(b.date || '')).slice(0, 3);
    
    if(el) el.innerHTML = upcoming.map(a => `
        <div class="p-2 border-b last:border-b-0">
            <div class="font-semibold text-sm">${escapeHtml(a.title)}</div>
            <div class="text-xs small-muted">${a.date || '×ª××¨×™×š ×œ× ×™×“×•×¢'} - ${escapeHtml(a.location || '×œ× ×¦×•×™×Ÿ')}</div>
        </div>
    `).join('') || '<div class="text-gray-500 text-sm">××™×Ÿ ×¤×¢×™×œ×•×™×•×ª ×§×¨×•×‘×•×ª.</div>';
}
function showRules(){
    document.getElementById('rulesModal').classList.remove('hidden');
}


/* ========== Auth Listener / App Init ========== */
async function initializeApp(){
    auth.onAuthStateChanged(async (user) => {
        if (user) {
            // **×”××©×ª××© ××—×•×‘×¨**
            try {
                // 1. ××—×–×•×¨ ×¤×¨×˜×™ ×”××©×ª××© ××”-Firestore
                const userDoc = await db.collection('users').doc(user.uid).get();

                if (userDoc.exists) {
                    state.user = { id: user.uid, ...userDoc.data() };
                    
                    // 2. ×¢×“×›×•×Ÿ ×¡×˜×˜×•×¡ ××—×•×‘×¨ (IsOnline)
                    await db.collection('users').doc(user.uid).update({ isOnline: true });

                    // 3. ××—×–×•×¨ × ×ª×•× ×™× ×¨××©×•× ×™
                    await fetchInitial(); 
                    
                    // 4. × ×™×ª×•×‘
                    if (state.screen === 'login' || state.screen === 'register') {
                        goTo('home');
                    } else {
                        render();
                    }

                } else {
                    // ×”××©×ª××© ××—×•×‘×¨ ×‘-Auth ××‘×œ ×œ× ×§×™×™× ×‘××¡××š users
                    auth.signOut();
                }
            } catch (error) {
                console.error("×©×’×™××” ×§×¨×™×˜×™×ª ×‘××—×–×•×¨ ×¤×¨×•×¤×™×œ ××©×ª××© ××• × ×ª×•× ×™×:", error);
                state.user = null;
                state.screen = 'login';
                render();
            }
        } else {
            // **×”××©×ª××© ×œ× ××—×•×‘×¨ ××• ×™×¦×**
            if(state.user && state.user.id){
                // ×× ×”××©×ª××© ×”×™×” ××—×•×‘×¨, × ×¢×“×›×Ÿ ×¡×˜×˜×•×¡ ×œ× ××—×•×‘×¨
                 db.collection('users').doc(state.user.id).update({ isOnline: false }).catch(e=>console.warn('Cannot update offline status', e));
            }
            state.user = null;
            if (state.screen !== 'register') {
                goTo('login');
            } else {
                render();
            }
        }
    });
}

// ×”×¤×¢×œ×ª ×”××¤×œ×™×§×¦×™×”
window.addEventListener('load', ()=>{
  render();
  initializeApp();
  // Safe periodic unread update
  setInterval(()=>{ if(state.user) updateUnreadTotal().catch(()=>{}); }, 25000);
});

</script>

<div id="rulesModal" class="fixed inset-0 bg-black/30 hidden items-center justify-center z-60">
  <div class="bg-white p-6 rounded w-full max-w-2xl card">
    <h3 class="font-semibold mb-2">×ª×§× ×•×Ÿ ×”×©×™××•×© ×•×§×•×“ ×”×ª× ×”×’×•×ª ×‘×§×”×™×œ×”</h3>
    <div class="small-muted mb-4">
      <strong>×”×¢×¨×” ×—×©×•×‘×”:</strong> ××¨×›×– ×”×¢×–×¨×” ××•×¢×‘×¨ ×¢×œ ×‘×¡×™×¡ ×§×”×™×œ×ª×™ ×‘×œ×‘×“. ×‘×¢×œ×™ ×”××ª×¨ ××™× × ××¡×¤×§×™× ×™×™×¢×•×¥ ××§×¦×•×¢×™ ×•××™× × ××—×¨××™× ×¢×œ ×”×ª×›× ×™× ××• ×”×ª×•×¦××•×ª. ×¤× ×™×•×ª ×‘×ª×—×•× ××©×¤×˜×™, ×¨×¤×•××™ ××• ×¤×™× × ×¡×™ ××”×•×•×ª ×”××œ×¦×” ×‘×œ×‘×“ ×•××™×Ÿ ×œ×¨××•×ª ×‘×”×Ÿ ×ª×—×œ×™×£ ×œ×™×™×¢×•×¥ ××§×¦×•×¢×™.
    </div>
    <ol class="text-sm small-muted list-decimal ml-6">
      <li>×›×‘×“×• ×¤×¨×˜×™×•×ª ×©×œ ×—×‘×¨×™× â€” ××™×Ÿ ×œ×¤×¨×¡× ××™×“×¢ ××™×©×™ ×œ×œ× ×”×¡×›××” ×‘×¨×•×¨×”.</li>
      <li>××¡×•×¨ ×œ×©×ª×£ ×ª×›× ×™× ×¤×•×’×¢× ×™×™×, ×’×–×¢× ×™×™× ××• ×§×™×¦×•× ×™×™×.</li>
      <li>×”×™×× ×¢×• ××”×¦×¢×•×ª ××¡×—×¨×™×•×ª ×œ× ××•×¨×©×•×ª ×œ×œ× ××™×©×•×¨ ×× ×”×œ ×”×§×”×™×œ×”.</li>
      <li>×”××“××™×Ÿ ×•×¦×•×•×ª ×”×§×”×™×œ×” ×¨×©××™× ×œ×”×¡×™×¨ ×ª×•×›×Ÿ ×¤×•×’×¢× ×™ ××• ×œ×©×œ×•×œ ×’×™×©×” ×‘×”×ª×× ×œ×©×™×§×•×œ ×“×¢×ª×.</li>
      <li>××™×Ÿ ×œ×¨××•×ª ×‘×ª×›× ×™× ×™×™×¢×•×¥ ××§×¦×•×¢×™; ×œ×›×œ ×¦×•×¨×š ××§×¦×•×¢×™ ×™×© ×œ×¤× ×•×ª ×œ×’×•×¨× ××•×¡××š.</li>
    </ol>
    <div class="mt-4 flex justify-end gap-2">
      <button class="pill bg-white border" onclick="document.getElementById('rulesModal').classList.add('hidden')">×¡×’×•×¨</button>
    </div>
  </div>
</div>

</body>
</html>
