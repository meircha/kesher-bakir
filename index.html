<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>×§×”×™×œ×ª ×§×©×¨ | ×—×™×™× ×˜×•×‘×™×</title>

    <!-- Tailwind + FontAwesome -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <!-- Firebase v8 (×ª×•×× ×œ×§×•×“ ×©×œ×š) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-messaging.js"></script>

    <style>
        :root {
            --kesher-primary: #FF6B6B;
            --kesher-secondary: #4ECDC4;
            --kesher-accent: #FFCD00;
        }
        body { background: #f7f7f7; font-family: Arial, sans-serif; }
        .bg-kesher-primary { background-color: var(--kesher-primary); }
        .bg-kesher-secondary { background-color: var(--kesher-secondary); }
        .text-kesher-primary { color: var(--kesher-primary); }
    </style>
</head>
<body>
    <div id="root" class="pt-16">
        <div id="loading-spinner" class="flex justify-center items-center min-h-screen">
            <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-kesher-primary"></div>
            <p class="text-kesher-primary text-lg mr-4">×˜×•×¢×Ÿ × ×ª×•× ×™×...</p>
        </div>
    </div>

<script>
/*
  ×§×•×‘×¥ ×–×” ×”×•× ×’×¨×¡×” ××©×•×¤×¨×ª ×©×œ ×”×§×•×‘×¥ ×©×©×œ×—×ª (×¨××” ×”××§×•×¨ ×©×œ×š). 
  ×©××ª×™ ×¤×” ××ª ×›×œ ×”×ª×›× ×™× ×‘×¢××•×“ ×™×—×™×“: UI, Auth, Firestore, Messaging (client).
  ×”×¢×¨×•×ª ×—×©×•×‘×•×ª ×‘×ª×’×•×‘×•×ª ×”×§×•×“.
*/

/* ====== 1. ×”×’×“×¨×•×ª Firebase - ×”×—×œ×£ ×›××Ÿ ×× ×¦×¨×™×š ====== */
const firebaseConfig = {
    apiKey: "AIzaSyCrcxC420HW5PXGNd8M4KuclUkiJSwHreM",
    authDomain: "kesher-bakir.firebaseapp.com",
    projectId: "kesher-bakir",
    storageBucket: "kesher-bakir.firebasestorage.app",
    messagingSenderId: "671996189455",
    appId: "1:671996189455:web:dbe089d69a85a2ab38fc7a",
    measurementId: "G-42EWSKFXW"
};

if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const messaging = firebase.messaging();

/* ××¤×©×¨×•×ª: ××¤×©×¨×•×ª ×œ×©××•×¨ × ×ª×•× ×™× ×‘××›×©×™×¨ ×›×©×”×œ×§×•×— ××•×£Ö¾×œ×™×™×Ÿ */
db.enablePersistence && db.enablePersistence().catch(err => {
    console.warn('Firestore persistence not enabled:', err && err.code);
});

/* ====== State ×’×œ×•×‘×œ×™ ====== */
const state = {
    user: null,
    screen: 'loading',
    users: [],
    forums: [],
    activities: [],
    reports: [],
    unreadCounts: {},       // { chatRoomId: count }
    currentForumId: null,
    currentPost: null,
    currentPostReplies: [],
    selectedUser: null,     // user object for chat target
    chatMessages: [],
    usersFilter: { city: '', role: '', hobby: '' },
    listeners: []           // ×œ×¦×•×¨×š ×”×¡×¨×” ×›×©×× ×ª×§×™×
};

/* ====== ×›×œ×™× ×•×¢×–×¨×™× ====== */
function getChatRoomId(a,b){
    if(!a || !b) return null;
    return a < b ? `${a}_${b}` : `${b}_${a}`;
}

/* ×—×™×©×•×‘ ×”××œ×¦×” ×™×•××™×ª (×›××• ×‘××§×•×¨ ×©×œ×š) */
const DAILY_RECOMMENDATIONS = [
    "×¦××• ×œ×˜×™×•×œ ×§×¦×¨ ×©×œ 30 ×“×§×•×ª ×‘×©××©! â˜€ï¸",
    "×”×ª×§×©×¨×• ×”×™×•× ×œ×—×‘×¨ ×•×ª×™×§ ×©×œ× ×“×™×‘×¨×ª× ××™×ª×• ×–××Ÿ ×¨×‘. ğŸ“",
    "×”×™×•× × ×¡×• ×œ××›×•×œ ×™×¨×§×•×ª ×™×¨×•×§×™× ×›×”×™×. ğŸ¥¦",
    "×œ××“×• ××™×œ×” ×—×“×©×” ××• ×¢×•×‘×“×” ×”×™×¡×˜×•×¨×™×ª ××¢× ×™×™× ×ª. ğŸ§ ",
    "×”×©×§×™×¢×• 15 ×“×§×•×ª ×‘××“×™×˜×¦×™×” ××• × ×©×™××•×ª ×¢××•×§×•×ª. ğŸ§˜",
    "×¡×“×¨×• ××’×™×¨×” ××—×ª ×§×˜× ×” ×‘×‘×™×ª. âœ¨",
    "×›×ª×‘×• 3 ×“×‘×¨×™× ×©××ª× ××¡×™×¨×™ ×ª×•×“×” ×¢×œ×™×”× ×”×™×•×. ğŸ™"
];
function getDailyRecommendation(){
    const today=new Date();
    const dayOfYear=Math.floor((today - new Date(today.getFullYear(),0,0))/1000/60/60/24);
    return DAILY_RECOMMENDATIONS[dayOfYear % DAILY_RECOMMENDATIONS.length];
}

/* ====== ×¨×™× ×“×•×¨ (×©×™××¨×ª×™ ××ª ×¨×•×‘ ×”×ª×‘× ×™×•×ª ×©×œ×š ××‘×œ ×”×§×˜× ×ª×™ ×œ×¦×•×¨×š ×”×§×¨×™××”) ====== */
/* ×‘×©×‘×™×œ ×§×™×¦×•×¨ ×”×ª×©×•×‘×” ×›××Ÿ ×©××¨×ª×™ ×¨×§ ×”×¢×™×§×¨ â€” ×‘×’×¨×¡×” ×–×• ×™×© ××ª ×›×œ ×”××¡×›×™×: login, register, home, users, chat, forums, admin ×•×›×•'. */
function getHeader(){
    if(!state.user) return '';
    const totalUnread = Object.values(state.unreadCounts).reduce((s,c)=>s+(c||0),0);
    return `
    <header class="fixed top-0 left-0 right-0 bg-kesher-primary text-white shadow-lg z-50">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex items-center justify-between h-16">
          <div class="flex items-center">
            <span class="text-2xl font-bold">×§×”×™×œ×ª ×§×©×¨ <i class="fa-solid fa-seedling"></i></span>
          </div>
          <div class="flex gap-2">
            <button onclick="goTo('home')" class="px-3 py-2 rounded-lg">×‘×™×ª</button>
            <button onclick="goTo('users')" class="relative px-3 py-2 rounded-lg">×¦'××˜/×—×‘×¨×™× ${totalUnread>0?`<span class='inline-flex items-center justify-center px-2 py-1 text-xs font-bold text-white bg-kesher-accent rounded-full'>${totalUnread}</span>`:''}</button>
            <button onclick="goTo('forums')" class="px-3 py-2 rounded-lg">×¤×•×¨×•××™×</button>
            <button onclick="goTo('activities')" class="px-3 py-2 rounded-lg">×¤×¢×™×œ×•×™×•×ª</button>
            ${state.user.role==='admin'?`<button onclick="goTo('admin')" class="px-3 py-2 rounded-lg bg-red-700">× ×™×”×•×œ</button>`:''}
          </div>
          <div class="flex items-center gap-4">
            <span class="text-sm font-medium"><i class="fa-solid fa-user"></i> ${state.user.name}</span>
            <button onclick="doLogout()" class="bg-kesher-secondary text-white px-3 py-1 rounded-full">×™×¦×™××”</button>
          </div>
        </div>
      </div>
    </header>
    `;
}

/* ×¨× ×“×¨ ×‘×¡×™×¡×™ ×©×œ ××¡×›×™× (××™× ×™Ö¾×’×¨×¡×” ×›×“×™ ×©×™×”×™×” ×§×¦×¨ ×›××Ÿ) */
function renderLoading(){ return `<div class="flex items-center justify-center min-h-screen">×˜×•×¢×Ÿ...</div>`; }

function renderLogin(){
    return `
    <div class="flex items-center justify-center min-h-screen bg-gray-100 p-4 pt-16">
      <div class="w-full max-w-md bg-white p-8 rounded-2xl shadow-2xl">
        <h2 class="text-4xl font-extrabold text-center text-kesher-primary mb-2">×§×”×™×œ×ª ×§×©×¨</h2>
        <form onsubmit="event.preventDefault(); doLogin()">
          <label>×“×•××´×œ</label>
          <input id="email" type="email" class="w-full p-2 border my-2 rounded" required/>
          <label>×¡×™×¡××”</label>
          <input id="pwd" type="password" class="w-full p-2 border my-2 rounded" required/>
          <p id="loginError" class="text-red-600 text-sm"></p>
          <button class="w-full bg-kesher-secondary text-white py-2 rounded mt-2">×”×ª×—×‘×¨</button>
        </form>
        <div class="mt-4 text-center">
          <button onclick="goTo('register')" class="text-kesher-primary">×”×™×¨×©×</button>
        </div>
      </div>
    </div>
    `;
}

function renderHome(){
    const onlineUsers = (state.users||[]).filter(u=>u.isOnline && u.id!==state.user.id && u.isActive!==false);
    const myActivities = (state.activities||[]).filter(a=>a.attendees?.includes(state.user.id));
    return `
      ${getHeader()}
      <div class="max-w-6xl mx-auto px-4 mt-24">
        <h2 class="text-3xl font-bold">×‘×¨×•×š ×”×‘×, ${state.user.name}</h2>
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mt-6">
          <div class="bg-kesher-primary text-white p-6 rounded">× ×§×•×“×•×ª: ${state.user.points||0}</div>
          <div class="bg-white p-6 rounded lg:col-span-2">
            <h3>×—×‘×¨×™× ××—×•×‘×¨×™× (${onlineUsers.length})</h3>
            <div>${onlineUsers.map(u=>`<div class="flex justify-between p-2"><span>${u.name} (${u.city})</span><button onclick="openChat({id:'${u.id}', name:'${u.name}'})" class="bg-kesher-primary text-white px-3 py-1 rounded">×¦'××˜</button></div>`).join('')}</div>
          </div>
        </div>
      </div>
    `;
}

function renderUsers(){
    const activeUsers = (state.users||[]).filter(u=>u.isActive!==false && u.id!==state.user.id);
    return `
      ${getHeader()}
      <div class="max-w-6xl mx-auto px-4 mt-24">
        <h2 class="text-3xl font-bold">×—×‘×¨×™× (${activeUsers.length})</h2>
        <div class="space-y-4 mt-4">
          ${activeUsers.map(u=> {
            const chatRoomId = getChatRoomId(state.user.id, u.id);
            const unread = state.unreadCounts[chatRoomId] || 0;
            return `<div class="bg-white p-4 rounded flex justify-between items-center">
                      <div>
                        <div class="font-bold">${u.name} ${u.isActive===false?'<span class="text-red-500">(××•×©×”×”)</span>':''}</div>
                        <div class="text-xs">${u.city} | ${u.role}</div>
                      </div>
                      <div class="flex gap-2 items-center">
                        <button onclick="openChat({id:'${u.id}', name:'${u.name}'})" class="bg-kesher-primary text-white px-3 py-1 rounded">×¦'××˜ ${unread>0?`<span class='ml-2 px-2 rounded bg-kesher-accent text-xs'>${unread}</span>`:''}</button>
                        <button onclick="reportItem('${u.id}','user','${u.id}')" class="bg-red-100 text-red-700 px-3 py-1 rounded">×“×•×•×—</button>
                      </div>
                    </div>`}).join('')}
        </div>
      </div>
    `;
}

function renderChat(){
    if(!state.selectedUser) { goTo('users'); return ''; }
    return `
      ${getHeader()}
      <div class="max-w-4xl mx-auto px-4 mt-24">
        <div class="bg-white rounded shadow h-[70vh] flex flex-col">
          <div class="p-4 bg-kesher-primary text-white flex justify-between items-center">
            <div>×¦'××˜ ×¢× ${state.selectedUser.name}</div>
            <button onclick="goTo('users')" class="bg-red-600 px-3 py-1 rounded">×—×–×•×¨</button>
          </div>
          <div id="chatBox" class="flex-grow p-4 overflow-y-auto space-y-3">
            ${state.chatMessages.map(m => {
                const isMe = m.senderId === state.user.id;
                const time = m.timestamp && m.timestamp.toDate ? new Date(m.timestamp.toDate()).toLocaleTimeString('he-IL',{hour:'2-digit', minute:'2-digit'}) : '×¢×›×©×™×•';
                return `<div class="${isMe?'text-right':'text-left'}"><div class="${isMe?'inline-block bg-kesher-secondary text-white rounded p-3':'inline-block bg-gray-100 rounded p-3'}">${m.content}<div class="text-xs mt-1">${time} ${isMe&&(m.read? 'âœ…':'')}</div></div></div>`;
            }).join('')}
          </div>
          <div class="p-4 border-t flex gap-2">
            <input id="chatInput" type="text" placeholder="×”×§×œ×“ ×”×•×“×¢×”..." class="flex-grow p-3 border rounded" onkeydown="if(event.key==='Enter') sendMessage()"/>
            <button onclick="sendMessage()" class="bg-kesher-primary text-white px-4 py-2 rounded">×©×œ×—</button>
          </div>
        </div>
      </div>
    `;
}

function renderForums(){
    return `${getHeader()}<div class="max-w-6xl mx-auto px-4 mt-24"><h2 class="text-3xl">×¤×•×¨×•××™×</h2>
      <div class="mt-4 space-y-4">${(state.forums||[]).map(f=>`<div class="bg-white p-4 rounded flex justify-between items-center"><div><div class="font-bold">${f.title}</div><div class="text-sm">${f.description}</div></div><button onclick="goTo('forumPosts',{forumId:'${f.id}'})" class="bg-kesher-primary text-white px-3 py-1 rounded">×¤×ª×—</button></div>`).join('')}</div></div>`;
}

function renderForumPosts(){ /* ××™× ×™××•× */ return `${getHeader()}<div class="max-w-6xl mx-auto px-4 mt-24"><h2>×¤×•×¡×˜×™×</h2></div>`; }

function renderAdmin(){
    if(state.user.role !== 'admin') { goTo('home'); return ''; }
    return `${getHeader()}<div class="max-w-6xl mx-auto px-4 mt-24"><h2 class="text-3xl text-red-600">×œ×•×— × ×™×”×•×œ</h2>
      <div class="bg-white p-4 rounded mt-4">
        <h3>××©×ª××©×™×</h3>
        <div class="mt-2">${(state.users||[]).map(u=>`<div class="flex justify-between items-center p-2"><div>${u.name} ${u.isActive===false?'<span class=text-red-500>(××•×©×”×”)</span>':''}</div><div><select onchange="updateUserRole('${u.id}', this.value)"><option value='user' ${u.role==='user'?'selected':''}>user</option><option value='senior' ${u.role==='senior'?'selected':''}>senior</option><option value='admin' ${u.role==='admin'?'selected':''}>admin</option></select><button class="ml-2 bg-yellow-500 px-2 py-1 text-white rounded" onclick="toggleUserActive('${u.id}','${u.name}', ${u.isActive!==false})">${u.isActive!==false? '×”×©××”×”' : '×”×¤×¢×œ'}</button><button class="ml-2 bg-red-500 px-2 py-1 text-white rounded" onclick="deleteUser('${u.id}','${u.name}')">××—×§</button></div></div>`).join('')}</div>
      </div>
    </div>`;
}

/* ×× ×•×¢ ×¨×™× ×“×•×¨ ××¨×›×–×™ */
function render(){
    let content = '';
    if(!state.user && state.screen !== 'register') state.screen = 'login';
    switch(state.screen){
        case 'loading': content = renderLoading(); break;
        case 'login': content = renderLogin(); break;
        case 'register': content = renderRegister(); break;
        case 'home': content = renderHome(); break;
        case 'users': content = renderUsers(); break;
        case 'chat': content = renderChat(); break;
        case 'forums': content = renderForums(); break;
        case 'forumPosts': content = renderForumPosts(); break;
        case 'admin': content = renderAdmin(); break;
        default: content = `<div>×©×’×™××ª × ×™×ª×•×‘</div>`;
    }
    document.getElementById('root').innerHTML = content;
}

/* ====== 2. ×¤×•× ×§×¦×™×•×ª Auth/Register/Login/Logout ====== */
window.doLogin = async () => {
    const email = document.getElementById('email').value;
    const password = document.getElementById('pwd').value;
    const loginError = document.getElementById('loginError');
    loginError.textContent = '';
    try {
        const cred = await auth.signInWithEmailAndPassword(email, password);
        // ×”××–× ×” ×œÖ¾onAuthStateChanged ×ª×˜×¤×œ ×‘×˜×¢×™× ×ª × ×ª×•× ×™×
    } catch(err){
        loginError.textContent = `×©×’×™××ª ×”×ª×—×‘×¨×•×ª: ${err.message}`;
    }
};

window.doRegister = async () => {
    const name = document.getElementById('regName').value;
    const email = document.getElementById('regEmail').value;
    const password = document.getElementById('regPwd').value;
    const city = document.getElementById('regCity').value;
    const hobbiesInput = document.getElementById('regHobbies').value;
    const contributionsInput = document.getElementById('regContributions').value;
    const registerError = document.getElementById('registerError');
    registerError.textContent = '';
    if(!name||!email||!password) { registerError.textContent='××œ× ×©×, ××™××™×™×œ ×•×¡×™×¡××”'; return; }
    try {
        const cred = await auth.createUserWithEmailAndPassword(email, password);
        const user = cred.user;
        const hobbies = (hobbiesInput||'').split(',').map(s=>s.trim()).filter(Boolean);
        const contributions = (contributionsInput||'').split(',').map(s=>s.trim()).filter(Boolean);
        const doc = {
            name, email, city, role: 'user', points:0, isOnline:true, isActive:true, hobbies, contributions, joinDate: firebase.firestore.FieldValue.serverTimestamp()
        };
        await db.collection('users').doc(user.uid).set(doc);
        // onAuthStateChanged ×™×˜×¢×Ÿ ××ª ×©××¨ ×”× ×ª×•× ×™×
    } catch(err){
        registerError.textContent = `×©×’×™××ª ×¨×™×©×•×: ${err.message}`;
    }
};

window.doLogout = async () => {
    // ×”×¡×¨×ª ×××–×™× ×™×
    state.listeners.forEach(unsub=>unsub && unsub());
    state.listeners = [];
    await auth.signOut();
    state.user = null;
    goTo('login');
};

/* ×¢××•×“ ×”×¨×©××” ××™× ×™××œ×™ */
function renderRegister(){
    return `
    <div class="flex items-center justify-center min-h-screen bg-gray-100 p-4 pt-16">
      <div class="w-full max-w-md bg-white p-8 rounded-2xl shadow-2xl">
        <h2 class="text-4xl font-extrabold text-center text-kesher-primary mb-2">×”×¨×©××”</h2>
        <form onsubmit="event.preventDefault(); doRegister()">
          <label>×©× ××œ×</label><input id="regName" class="w-full p-2 border my-2 rounded" required/>
          <label>×“×•××´×œ</label><input id="regEmail" type="email" class="w-full p-2 border my-2 rounded" required/>
          <label>×¡×™×¡××”</label><input id="regPwd" type="password" class="w-full p-2 border my-2 rounded" required/>
          <label>×¢×™×¨</label><input id="regCity" class="w-full p-2 border my-2 rounded" required/>
          <label>×ª×—×‘×™×‘×™× (×¤×¡×™×§)</label><input id="regHobbies" class="w-full p-2 border my-2 rounded"/>
          <label>×ª×¨×•××•×ª</label><input id="regContributions" class="w-full p-2 border my-2 rounded"/>
          <p id="registerError" class="text-red-600 text-sm"></p>
          <button class="w-full bg-kesher-primary text-white py-2 rounded mt-2">×”×¨×©×</button>
        </form>
      </div>
    </div>
    `;
}

/* ====== 3. ××—×–×•×¨ × ×ª×•× ×™× ×¨××©×•× ×™ + ×××–×™× ×™× ×‘×–××Ÿ ×××ª ====== */
async function fetchInitialData(){
    // ×˜×¢×™× ×ª ×—×‘×™×œ×•×ª ×¤×™×§×˜×™×‘×™×•×ª ×× ×¦×¨×™×›×™× â€” ×©××¨×ª×™ ×¤×•× ×§×¦×™×” ××”×§×•×‘×¥ ×”××§×•×¨×™ ××š ×›××Ÿ × ×˜×¢×Ÿ ×××ª ×Ö¾Firestore
    try {
        // ××©×ª××©×™×
        const usersSnap = await db.collection('users').get();
        state.users = usersSnap.docs.map(d=>({id:d.id, ...d.data()}));
        // ×¤×¢×™×œ×•×™×•×ª
        const actsSnap = await db.collection('activities').get();
        state.activities = actsSnap.docs.map(d=>({id:d.id, ...d.data(), date: d.data().date?.toDate ? d.data().date.toDate() : d.data().date}));
        // ×¤×•×¨×•××™× (××¡××š ×©×œ×š)
        const forumsSnap = await db.collection('forums').get();
        state.forums = forumsSnap.docs.map(d=>({id:d.id, ...d.data()}));
        // ×“×•×—×•×ª
        const repsSnap = await db.collection('reports').get();
        state.reports = repsSnap.docs.map(d=>({id:d.id, ...d.data()}));

        // ×××–×™×Ÿ: ××•× ×™× ×©×œ ×¦'××˜ ×©×œ× × ×§×¨××• (××¡××š chat ×©××©××¨ ×©×“×•×ª unread_userid)
        const chatUnreadsUnsub = db.collection('chats').where('participants','array-contains', state.user.id)
            .onSnapshot(snap=>{
                snap.docs.forEach(doc=>{
                    const data = doc.data();
                    const unread = data[`unread_${state.user.id}`] || 0;
                    if(unread>0) state.unreadCounts[doc.id] = unread;
                    else delete state.unreadCounts[doc.id];
                });
                render();
            }, err => console.error('chat unreads listen error', err));
        state.listeners.push(chatUnreadsUnsub);

    } catch(err){
        console.error('fetchInitialData error', err);
        // ××¤×©×¨ ×œ×˜×¢×•×Ÿ × ×ª×•× ×™× ×¤×™×§×˜×™×‘×™×™× (×›××• ×‘×§×•×‘×¥ ×©×œ×š) â€” ××‘×œ ×›××Ÿ × ×©××™×¨ ×–××ª ×›×©×œ×‘ ××•×¤×¦×™×•× ×œ×™.
    }
}

/* ====== 4. ×¦'××˜ ×‘×–××Ÿ ×××ª: ×¤×ª×™×—×”, ×××–×™× ×™×, ×¡×™××•×Ÿ ×›× ×§×¨× ×•×›×•' ====== */

/* ×¤×ª×™×—×ª ×¦'××˜: ××¢××™×“ ×××–×™×Ÿ ×œÖ¾messages (onSnapshot) ×‘××§×•× ×©×™××•×© ×‘-get ×‘×œ×‘×“ */
window.openChat = async (targetUser) => {
    if(!state.user || !state.user.id || !targetUser || !targetUser.id){
        alert('×©×’×™××” ×¤× ×™××™×ª: ×—×¡×¨ ×¤×¨×˜×™ ××©×ª××© ×œ×¦×³××˜.');
        goTo('users');
        return;
    }
    // × ×§×” ×××–×™× ×™× ×§×•×“××™×
    state.listeners.forEach(un => un && un());
    state.listeners = [];

    state.selectedUser = targetUser;
    const chatRoomId = getChatRoomId(state.user.id, targetUser.id);
    if(!chatRoomId){ alert('×©×’×™××” ×‘×™×¦×™×¨×ª chatRoomId'); return; }

    goTo('chat');

    // ×××–×™×Ÿ ×œ×”×•×“×¢×•×ª ×‘×—×“×¨
    const messagesUnsub = db.collection('chats').doc(chatRoomId).collection('messages')
        .orderBy('timestamp')
        .onSnapshot(async snap => {
            const msgs = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            state.chatMessages = msgs;
            render();

            // ×¡×™××•×Ÿ ×”×•×“×¢×•×ª ×©×œ ×”×¦×“ ×”×©× ×™ ×›× ×§×¨××•
            const batch = db.batch();
            let toClear = 0;
            snap.docs.forEach(doc => {
                const data = doc.data();
                if(data.senderId === targetUser.id && (data.read === false || data.read === undefined)){
                    batch.update(doc.ref, { read: true });
                    toClear++;
                }
            });
            if(toClear>0){
                await batch.commit();
                // ××¤×¡ ××ª ×”××•× ×” ×‘××¡××š ×”×¦'××˜ ×”×¨××©×™
                await db.collection('chats').doc(chatRoomId).update({ [`unread_${state.user.id}`]: 0 });
            }
        }, err => {
            console.error('messages listen error', err);
            // ×‘××§×¨×” ×©×œ ×‘×¢×™×” × × ×¦×•×¨ ×”×•×“×¢×” ××§×•××™×ª
            state.chatMessages = [{
                id:'err0', senderId: targetUser.id,
                content: '**×©×’×™××ª ×—×™×‘×•×¨** ×œ× × ×™×ª×Ÿ ×œ×˜×¢×•×Ÿ ×”×•×“×¢×•×ª ××”×©×¨×ª.',
                timestamp: firebase.firestore.Timestamp.now(),
                read: true
            }];
            render();
        });

    state.listeners.push(messagesUnsub);

    // ×××–×™×Ÿ ×œ××™×“×¢ ×‘×—×“×¨ (×›××• lastMessage / unread counters)
    const roomUnsub = db.collection('chats').doc(chatRoomId).onSnapshot(doc => {
        const data = doc.data();
        if(!data) return;
        // ×¢×“×›×•×Ÿ ××•× ×” ×œ× × ×§×¨××™× ×’×œ×•×‘×œ×™×ª
        const unread = data[`unread_${state.user.id}`] || 0;
        if(unread>0) state.unreadCounts[chatRoomId] = unread;
        else delete state.unreadCounts[chatRoomId];
        render();
    }, err => console.error('room listen error', err));
    state.listeners.push(roomUnsub);
};

/* ×©×œ×™×—×ª ×”×•×“×¢×” */
window.sendMessage = async () => {
    const input = document.getElementById('chatInput');
    if(!input) return;
    const content = input.value.trim();
    if(!content || !state.selectedUser || !state.user || !state.user.id) return;
    const chatRoomId = getChatRoomId(state.user.id, state.selectedUser.id);
    const receiverId = state.selectedUser.id;
    if(!chatRoomId){ alert('×©×’×™××” ×¤× ×™××™×ª'); return; }

    const newMessage = {
        senderId: state.user.id,
        content,
        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
        read: false
    };
    try {
        const messageRef = await db.collection('chats').doc(chatRoomId).collection('messages').add(newMessage);
        // ×¢×“×›×•×Ÿ ××¡××š ×”×—×“×¨
        await db.collection('chats').doc(chatRoomId).set({
            participants: [state.user.id, receiverId],
            lastMessage: content,
            lastMessageTime: firebase.firestore.FieldValue.serverTimestamp(),
            [`unread_${receiverId}`]: firebase.firestore.FieldValue.increment(1)
        }, { merge: true });

        // ×¢×“×›×•×Ÿ ××™×™×“×™ ×‘Ö¾state ×œ×¦×•×¨×š ×—×•×•×™×™×ª ××©×ª××©
        state.chatMessages.push({ id: messageRef.id, ...newMessage, timestamp: firebase.firestore.Timestamp.now() });
        input.value = '';
        render();
        // ×’×œ×™×œ×”
        setTimeout(()=>{ const cb=document.getElementById('chatBox'); if(cb) cb.scrollTop=cb.scrollHeight; },50);

        /* ×©×œ×™×—×ª ×‘×§×©×” ×œ×©×¨×ª ×©×™×¤×™×¥ Push Notification ×œ×™×¢×“ (×¨×¦×•×™ Cloud Function ×××•×‘×˜×—).
           ×›××Ÿ ×™×© × ×§×•×“×ª ×§×¨×™××” ×œ×“××”: POST /sendNotification
           ××•××œ×¥ ×œ×××© Cloud Function ×©××§×‘×œ: { token, title, body, data } ×•×©×•×œ×— ×œÖ¾FCM
           * ××™×Ÿ ×œ×”×›× ×™×¡ ××ª Server Key ×œ×œ×§×•×—! * */
        try {
            const receiverDoc = await db.collection('users').doc(receiverId).get();
            const receiverData = receiverDoc.exists ? receiverDoc.data() : null;
            if(receiverData && receiverData.fcmToken) {
                // ×‘×§×©×ª ×“××” â€” ×”×—×œ×™×¤×• ×‘×›×ª×•×‘×ª ×”Ö¾Cloud Function ×©×œ×›×
                fetch('/sendNotification', {
                    method: 'POST',
                    headers:{'Content-Type':'application/json'},
                    body: JSON.stringify({
                        token: receiverData.fcmToken,
                        title: `×”×•×“×¢×” ×Ö¾${state.user.name}`,
                        body: content.slice(0,120),
                        data: { chatRoomId }
                    })
                }).catch(e => console.warn('sendNotification error (client):', e));
            }
        } catch(e){
            console.warn('×œ× × ×™×ª×Ÿ ×œ×©×œ×•×— ×‘×§×©×ª ×“×—×™×¤×” (×œ×§×•×—):', e);
        }

    } catch(err){
        console.error('sendMessage error:', err);
        alert('×©×’×™××” ×‘×©×œ×™×—×ª ×”×”×•×“×¢×”. ×‘×“×•×§ ×—×™×‘×•×¨ ×•Ö¾Firestore rules.');
    }
};

/* ====== 5. × ×™×”×•×œ ××©×ª××©×™× (Admin) ====== */

window.updateUserRole = async (userId, newRole) => {
    if(state.user.role !== 'admin') { alert('××™×Ÿ ×”×¨×©××”'); return; }
    if(userId === state.user.id) { alert('×œ× × ×™×ª×Ÿ ×œ×©× ×•×ª ××ª ×¢×¦××š'); return; }
    try {
        await db.collection('users').doc(userId).update({ role: newRole });
        const u = state.users.find(x=>x.id===userId); if(u) u.role=newRole; render();
        alert('×¢×•×“×›×Ÿ');
    } catch(err){ console.error(err); alert('×©×’×™××” ×‘×¢×“×›×•×Ÿ ×“×¨×’×”'); }
};

window.deleteUser = async (userId, userName) => {
    if(state.user.role !== 'admin'){ alert('××™×Ÿ ×”×¨×©××”'); return; }
    if(userId === state.user.id){ alert('×œ× × ×™×ª×Ÿ ×œ××—×•×§ ××ª ×¢×¦××š'); return; }
    if(!confirm(`××—×§ ${userName} ×œ×¦××™×ª×•×ª?`)) return;
    try {
        // ×©×™× ×œ×‘: ××—×™×§×ª ××¡××š users ×ª×¡×™×¨ ××•×ª×• ××”Ö¾Firestore ××š ×œ× ×ª××—×•×§ ××ª ×”Ö¾Auth user.
        // ×œ××—×™×§×” ××œ××” ×©×œ Auth user ×¦×¨×™×š Cloud Function ×¢× ×”×¨×©××•×ª ×× ×”×œ×™×•×ª.
        await db.collection('users').doc(userId).delete();
        state.users = state.users.filter(u=>u.id!==userId);
        render();
        alert('×”××©×ª××© × ××—×§ (×Ö¾Firestore). ×œ××—×™×§×” ×Ö¾Auth ×™×© ×œ×”×©×ª××© ×‘Ö¾Cloud Function.');
    } catch(err){
        console.error('deleteUser', err);
        alert('×©×’×™××” ×‘××—×™×§×”');
    }
};

window.toggleUserActive = async (userId, userName, isActive) => {
    if(state.user.role !== 'admin'){ alert('××™×Ÿ ×”×¨×©××”'); return; }
    const newStatus = isActive ? false : true;
    if(!confirm(`×”×× ×œ×©× ×•×ª ×¡×˜×˜×•×¡ ×œÖ¾${newStatus?'×¤×¢×™×œ':'××•×©×”×”'}?`)) return;
    try {
        await db.collection('users').doc(userId).update({ isActive: newStatus });
        const u = state.users.find(x=>x.id===userId); if(u) u.isActive = newStatus;
        render();
        alert('×¢×•×“×›×Ÿ');
    } catch(err){ console.error(err); alert('×©×’×™××” ×‘×¢×“×›×•×Ÿ ××¦×‘'); }
}

/* ====== 6. ×“×™×•×•×—×™×/×”×¡×¨×ª ×ª×’×•×‘×•×ª/××—×™×§×” â€” ×“×•×’×××•×ª ====== */
window.reportItem = (itemId, itemType, reportedUserId) => {
    alert(`×“×•×•×— ×¢×œ ${itemType} (id:${itemId}) â€” ×ª×•×“×”`);
    // ×›××Ÿ ×ª×•×›×œ×• ×œ×”×•×¡×™×£ ×™×¦×™×¨×ª ××¡××š ×‘Ö¾reports
};

/* ====== 7. Messaging (FCM) ×‘×¦×“ ×”×œ×§×•×—: ×‘×§×©×” ×œ×”×¨×©××” ×•×©××™×¨×ª token ×‘Ö¾users doc ====== */
async function initMessagingForUser(uid) {
    try {
        // ×‘×§×©×” ×œ×”×¨×©××”
        await messaging.requestPermission();
        const token = await messaging.getToken();
        if(token){
            // ×©××™×¨×ª ×”Ö¾token ×‘××¡××š ×”××©×ª××©
            await db.collection('users').doc(uid).update({ fcmToken: token });
            console.log('FCM token saved for user', uid, token);
        }
    } catch(err){
        console.warn('messaging init failed', err);
    }

    // ×××–×™×Ÿ ×œ×§×‘×œ×ª ×”×•×“×¢×•×ª ×‘×–××Ÿ ×©×”×“×£ ×¤×ª×•×— (foreground)
    messaging.onMessage(payload => {
        console.log('Message received. ', payload);
        // ×”×¦×’×” ×¤×©×•×˜×” ×“×¨×š Notification API (×¨×§ ×× ×”×¨×©××”)
        if(Notification.permission === 'granted'){
            const { title, body } = (payload.notification || {});
            new Notification(title || '×”×•×“×¢×” ×—×“×©×”', { body: body || '' });
        }
    });
}

/* ====== 8. ×”××–× ×” ×œÖ¾Auth state ×•×”××ª×—×•×œ ×”×¨××©×•× ×™ ====== */
auth.onAuthStateChanged(async (user) => {
    if(user){
        try {
            // ×§×— ××ª ×¤×¨×˜×™ ×”××©×ª××© ××”Ö¾users doc
            const doc = await db.collection('users').doc(user.uid).get();
            if(!doc.exists){
                // ××©×ª××© auth ×œ×œ× ××¡××š users
                console.warn('User auth exists but no users doc; signing out.');
                await auth.signOut();
                return;
            }
            const data = doc.data();
            if(data.isActive === false){
                alert('×”×—×©×‘×•×Ÿ ×©×œ×š ××•×©×”×”.');
                await auth.signOut();
                return;
            }
            state.user = { id: user.uid, email: user.email, name: data.name || '××©×ª××©', role: data.role || 'user', points: data.points || 0, isActive: data.isActive!==false };
            await fetchInitialData();

            // ×¨×™×©×•× token ×¢×‘×•×¨ ×”×•×“×¢×•×ª ×“×—×™×¤×”
            initMessagingForUser(user.uid).catch(e=>console.warn('initMessagingForUser',e));

            // × ×™×ª×•×‘ ×œ××¡×š ×”×‘×™×ª
            if(state.screen === 'loading' || state.screen === 'login') goTo('home');
            else render();
        } catch(err){
            console.error('onAuthStateChanged error', err);
            state.user = null;
            goTo('login');
        }
    } else {
        // ××©×ª××© ×œ× ××—×•×‘×¨
        state.user = null;
        // × ×•×•×˜ ×œ×œ×•×’×™×Ÿ ×× ×œ× ×‘××¡×š ×”×¨×©××”
        if(state.screen !== 'register') goTo('login');
        else render();
    }
});

/* ×¤×¢×•×œ×” ×¢×–×¨ ×œ× ×™×•×•×˜ */
function goTo(screen, params = {}){
    state.screen = screen;
    state.currentForumId = params.forumId || null;
    state.currentPost = null;
    state.currentPostReplies = [];
    state.selectedUser = params.selectedUser || state.selectedUser;
    render();

    // ×’×œ×™×œ×” ××•×˜×•××˜×™×ª ×œ×¦'××˜
    if(screen === 'chat') setTimeout(()=>{ const cb=document.getElementById('chatBox'); if(cb) cb.scrollTop=cb.scrollHeight; }, 90);
}

/* ×”×¤×¢×œ×ª ×”××¤×œ×™×§×¦×™×” */
render();
</script>
</body>
</html>
