<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>拽转 拽砖专 |  </title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <style>
        /* --- 1. 注爪 砖 爪注 (转 拽 专) --- */
        :root {
            --kesher-primary: #FF6B6B; /* Vibrant Coral - , 专 */
            --kesher-secondary: #4ECDC4; /* Bright Aqua/Teal - 专注, 专 */
            --kesher-accent: #FFCD00; /* Gold/Yellow - 驻转, 拽 */
            --kesher-text: #333;
        }
        .bg-kesher-primary { background-color: var(--kesher-primary); }
        .hover\:bg-kesher-primary:hover { background-color: #f05a5a; }
        .text-kesher-primary { color: var(--kesher-primary); }
        .bg-kesher-secondary { background-color: var(--kesher-secondary); }
        .hover\:bg-kesher-secondary:hover { background-color: #43c1b8; }
        .text-kesher-secondary { color: var(--kesher-secondary); }

        /* 住转专 砖 住 */
        .screen { display: none; }
        .screen.active { display: flex; }

        /*    转转 砖转 */
        body, html, #app-container {
            height: 100%;
        }
        .overflow-y-auto::-webkit-scrollbar {
            width: 8px;
        }
        .overflow-y-auto::-webkit-scrollbar-thumb {
            background-color: #ccc;
            border-radius: 10px;
        }
        .overflow-y-auto::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        
        /* 住 驻转专 专砖 */
        .btn-primary {
            background-color: var(--kesher-primary);
            color: white;
            padding: 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background-color 0.15s;
        }
        .btn-primary:hover {
            background-color: #f05a5a;
        }
        
        /* 住 拽 */
        input[type="email"], input[type="password"], input[type="text"] {
            padding: 0.75rem;
            border: 1px solid #ccc;
            border-radius: 0.5rem;
            transition: border-color 0.15s, box-shadow 0.15s;
        }
        input:focus {
            border-color: var(--kesher-secondary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(78, 205, 196, 0.5); /* 爪 转 爪注 专砖 */
        }
        
        /*  转 驻专驻 */
        .profile-pic {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 50%;
            border: 3px solid var(--kesher-secondary);
        }

    </style>
</head>
<body class="bg-gray-100 h-full">
    <div id="app-container" class="flex flex-col h-full mx-auto max-w-lg shadow-2xl bg-white">
        
        <header id="main-header" class="p-4 border-b border-gray-200 bg-white shadow-md flex justify-between items-center z-10" style="display: none;">
            <button onclick="logout()" class="text-sm text-gray-500 hover:text-red-500 flex items-center">
                <i class="fas fa-sign-out-alt ml-1"></i> 转转拽
            </button>
            <div id="header-user-info" class="text-lg font-bold text-kesher-primary"></div>
        </header>

        <main id="screen-container" class="flex-grow overflow-hidden relative">
            
            <div id="loading-screen" class="screen absolute inset-0 items-center justify-center flex-col active">
                <i class="fas fa-heart fa-beat-fade text-kesher-primary text-5xl mb-4" style="--fa-animation-duration: 2s;"></i>
                <p class="text-gray-600 font-semibold">注 拽...</p>
            </div>

            <div id="login-screen" class="screen absolute inset-0 items-center justify-center p-8 flex-col bg-white">
                <img src="https://i.imgur.com/k9m9w2m.png" alt=" 拽砖专" class="w-24 mb-6">
                <h2 class="text-3xl font-extrabold text-kesher-primary mb-8">专 </h2>
                <div id="login-error" class="text-red-500 mb-4 hidden font-medium p-2 bg-red-100 rounded-lg w-full"></div>
                <input type="email" id="login-email" class="w-full p-3 mb-4" placeholder="专 拽专">
                <input type="password" id="login-password" class="w-full p-3 mb-6" placeholder="住住">
                <button onclick="login()" class="w-full btn-primary hover:shadow-lg transition duration-200">
                    转专转 拽
                </button>
                <button onclick="goTo('register')" class="mt-6 text-sm text-gray-600 hover:text-kesher-primary font-semibold">
                      砖? <span class="underline">专砖 </span>
                </button>
            </div>

            <div id="register-screen" class="screen absolute inset-0 items-center justify-center p-8 flex-col bg-white">
                <h2 class="text-3xl font-extrabold text-kesher-secondary mb-6">专砖 专</h2>
                <div id="register-error" class="text-red-500 mb-4 hidden font-medium p-2 bg-red-100 rounded-lg w-full"></div>
                <input type="text" id="register-name" class="w-full p-3 mb-4" placeholder="砖 ">
                <input type="email" id="register-email" class="w-full p-3 mb-4" placeholder="专 拽专">
                <input type="password" id="register-password" class="w-full p-3 mb-6" placeholder="住住 (驻转 6 转)">
                <button onclick="register()" class="w-full bg-kesher-secondary text-white p-3 rounded-lg font-semibold hover:bg-43c1b8 transition duration-150 hover:shadow-lg">
                     驻! (爪专 砖)
                </button>
                <button onclick="goTo('login')" class="mt-6 text-sm text-gray-600 hover:text-kesher-secondary font-semibold">
                    专 专? <span class="underline">转专 注砖</span>
                </button>
            </div>

            <div id="home-screen" class="screen absolute inset-0 flex-col bg-gray-50">
                <div class="p-4 bg-white border-b border-gray-200 w-full">
                    <h2 class="text-2xl font-bold text-gray-800">砖, <span id="home-user-name" class="text-kesher-primary"></span> </h2>
                    <p class="text-sm text-gray-500"> 专  砖 .</p>
                </div>
                
                <div class="p-4 flex-grow overflow-y-auto">
                    
                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <div class="bg-white p-4 rounded-xl shadow-md border-r-4 border-kesher-primary">
                            <i class="fas fa-star text-xl text-kesher-primary mb-2"></i>
                            <p class="text-sm text-gray-600">拽转 拽</p>
                            <p id="home-user-points" class="text-2xl font-extrabold text-gray-800 mt-1">0</p>
                        </div>
                        <div class="bg-white p-4 rounded-xl shadow-md border-r-4 border-kesher-secondary">
                            <i class="fas fa-handshake text-xl text-kesher-secondary mb-2"></i>
                            <p class="text-sm text-gray-600">转驻拽</p>
                            <p id="home-user-role" class="text-2xl font-extrabold text-gray-800 mt-1">砖转砖</p>
                        </div>
                    </div>
                    
                    <h3 class="text-xl font-bold text-gray-800 mb-3 border-b pb-2"> 专</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <button onclick="goTo('users')" class="flex flex-col items-center justify-center p-6 bg-white rounded-xl shadow-md hover:shadow-lg transition duration-200 border-b-4 border-kesher-primary">
                            <i class="fas fa-users text-4xl text-kesher-primary mb-2"></i>
                            <span class="text-lg font-semibold">专 (爪')</span>
                        </button>
                        <button onclick="goTo('activities')" class="flex flex-col items-center justify-center p-6 bg-white rounded-xl shadow-md hover:shadow-lg transition duration-200 border-b-4 border-kesher-secondary">
                            <i class="fas fa-calendar-alt text-4xl text-kesher-secondary mb-2"></i>
                            <span class="text-lg font-semibold">驻注转</span>
                        </button>
                        <button onclick="goTo('forums')" class="flex flex-col items-center justify-center p-6 bg-white rounded-xl shadow-md hover:shadow-lg transition duration-200 border-b-4 border-kesher-primary">
                            <i class="fas fa-comments text-4xl text-kesher-primary mb-2"></i>
                            <span class="text-lg font-semibold">驻专</span>
                        </button>
                        <button onclick="goTo('profile')" class="flex flex-col items-center justify-center p-6 bg-white rounded-xl shadow-md hover:shadow-lg transition duration-200 border-b-4 border-kesher-secondary">
                            <i class="fas fa-user-circle text-4xl text-kesher-secondary mb-2"></i>
                            <span class="text-lg font-semibold">驻专驻 砖</span>
                        </button>
                    </div>
                </div>
            </div>

            <div id="users-screen" class="screen absolute inset-0 flex-col">
                <div class="p-4 border-b border-gray-200 flex items-center justify-between bg-white shadow-sm">
                    <button class="text-kesher-primary font-semibold" onclick="goTo('home')">
                        <i class="fas fa-arrow-right"></i> 专
                    </button>
                    <h2 class="text-xl font-bold">专 拽</h2>
                    <div></div> 
                </div>
                <div class="flex-grow overflow-y-auto p-4 bg-gray-50">
                    <div id="users-list" class="space-y-3">
                        </div>
                </div>
            </div>

            <div id="chat-screen" class="screen absolute inset-0 flex-col bg-gray-50">
                </div>

            <div id="activities-screen" class="screen absolute inset-0 flex-col">
                <div class="p-4 border-b border-gray-200 flex items-center justify-between bg-white shadow-sm">
                    <button class="text-kesher-primary font-semibold" onclick="goTo('home')">
                        <i class="fas fa-arrow-right"></i> 专
                    </button>
                    <h2 class="text-xl font-bold">驻注转 拽</h2>
                    <div></div> 
                </div>
                <div class="flex-grow overflow-y-auto p-4 bg-gray-50">
                    <p class="text-center text-gray-500">注  驻注转 转转.</p>
                </div>
            </div>
            
            <div id="forums-screen" class="screen absolute inset-0 flex-col">
                <div class="p-4 border-b border-gray-200 flex items-center justify-between bg-white shadow-sm">
                    <button class="text-kesher-primary font-semibold" onclick="goTo('home')">
                        <i class="fas fa-arrow-right"></i> 专
                    </button>
                    <h2 class="text-xl font-bold">驻专 </h2>
                    <div></div> 
                </div>
                <div class="flex-grow overflow-y-auto p-4 bg-gray-50">
                    <p class="text-center text-gray-500"> 驻注 .</p>
                </div>
            </div>

             <div id="profile-screen" class="screen absolute inset-0 flex-col">
                <div class="p-4 border-b border-gray-200 flex items-center justify-between bg-white shadow-sm">
                    <button class="text-kesher-primary font-semibold" onclick="goTo('home')">
                        <i class="fas fa-arrow-right"></i> 专
                    </button>
                    <h2 class="text-xl font-bold">驻专驻 砖 砖</h2>
                    <button onclick="saveProfile()" class="text-kesher-secondary font-semibold">砖专</button>
                </div>
                <div class="flex-grow overflow-y-auto p-6 bg-gray-50">
                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <div class="flex flex-col items-center mb-6">
                            <img id="profile-pic" src="https://via.placeholder.com/80" alt="转转 驻专驻" class="profile-pic mb-3">
                            <input type="file" id="profile-pic-upload" class="hidden" accept="image/*">
                            <button onclick="document.getElementById('profile-pic-upload').click()" class="text-sm text-kesher-primary font-semibold hover:underline">砖 转</button>
                        </div>

                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-1">砖 </label>
                            <input type="text" id="profile-name" class="w-full p-2 border rounded-lg" disabled>
                        </div>

                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-1">"</label>
                            <input type="email" id="profile-email" class="w-full p-2 border rounded-lg" disabled>
                        </div>
                        
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-1">转 注 (驻专 驻住拽)</label>
                            <input type="text" id="profile-hobbies" class="w-full p-2 border rounded-lg">
                        </div>
                        
                        <div class="mt-6 border-t pt-4">
                            <h3 class="text-lg font-bold text-gray-800">住 转专转</h3>
                            <p id="profile-contributions-summary" class="text-sm text-gray-600 mt-2">住" 0 转专转. 拽转: 0</p>
                            <p class="text-xs text-gray-400 mt-2">专砖: <span id="profile-role"></span></p>
                        </div>
                    </div>
                </div>
            </div>

        </main>
        
    </div>

    <script>
        // 驻专 拽驻专爪 砖 Firebase - 砖 祝 转 砖!
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT_ID.appspot.com",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // 转 Firebase (专拽 驻注 转)
        let initialized = false;
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
            initialized = true;
        } else {
            firebase.app(); //  专 转, 砖转砖 拽 拽
            initialized = true;
        }
        
        const auth = firebase.auth();
        const db = firebase.firestore();

        // 爪 驻拽爪 
        const state = {
            user: null, // 驻专 砖转砖 专
            users: [],  // 专砖转  砖转砖 拽
            activeChat: null, // 驻专 爪' 
            chatListener: null, //  -Realtime 爪'
            screen: 'loading' // 住 
        };

        // ------------------ 拽转  专专  ------------------

        function goTo(screenId) {
            state.screen = screenId;
            render();
        }

        function render() {
            const screens = document.querySelectorAll('.screen');
            screens.forEach(screen => {
                screen.classList.remove('active');
            });
            const targetScreen = document.getElementById(state.screen + '-screen');
            if (targetScreen) {
                targetScreen.classList.add('active');
            }

            // 注 转专转 专砖转 
            const header = document.getElementById('main-header');
            if (state.screen === 'login' || state.screen === 'register' || state.screen === 'loading') {
                header.style.display = 'none';
            } else {
                header.style.display = 'flex';
                updateHeader();
            }

            // 驻注转 驻拽爪转 注转 转 住驻爪驻转 住
            if (state.screen === 'home') renderHomeScreen();
            if (state.screen === 'users') loadUsers();
            if (state.screen === 'profile') renderProfileScreen();
            
            //   拽  注 转 住 爪'
            if (state.screen !== 'chat' && state.chatListener) {
                state.chatListener();
                state.chatListener = null;
                state.activeChat = null;
            }
        }

        function updateHeader() {
            const userInfo = document.getElementById('header-user-info');
            if (state.user) {
                userInfo.textContent = state.user.name;
            } else {
                userInfo.textContent = '专';
            }
        }

        // ------------------ 拽转 转 ------------------

        function displayError(screenPrefix, message) {
            const errorElement = document.getElementById(screenPrefix + '-error');
            if (errorElement) {
                errorElement.textContent = message;
                errorElement.classList.remove('hidden');
                setTimeout(() => errorElement.classList.add('hidden'), 5000);
            }
        }

        async function login() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            displayError('login', '');

            try {
                await auth.signInWithEmailAndPassword(email, password);
                //  onAuthStateChanged 驻  'home'
            } catch (error) {
                console.error("砖转 转专转:", error);
                displayError('login', '砖 砖转砖  住住 砖. 住 砖.');
            }
        }

        async function register() {
            const name = document.getElementById('register-name').value;
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            displayError('register', '');

            if (!name || !email || !password) {
                displayError('register', '  转  砖转.');
                return;
            }

            try {
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;

                // 爪专转 住 砖转砖 -Firestore
                await db.collection('users').doc(user.uid).set({
                    name: name,
                    email: email,
                    role: 'user', // 转驻拽 专专转 
                    points: 0,
                    hobbies: [],
                    contributions: [],
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                //  onAuthStateChanged 驻  'home'
            } catch (error) {
                console.error("砖转 专砖:", error);
                if (error.code === 'auth/email-already-in-use') {
                    displayError('register', '转转 "  专 拽转 注专转.');
                } else if (error.code === 'auth/weak-password') {
                    displayError('register', '住住 砖 . 砖转砖 驻转 -6 转.');
                } else {
                    displayError('register', '专注 砖 注转 专砖. 住 砖.');
                }
            }
        }

        function logout() {
            auth.signOut();
        }

        function renderHomeScreen() {
            if (state.user) {
                document.getElementById('home-user-name').textContent = state.user.name;
                document.getElementById('home-user-points').textContent = state.user.points.toString();
                document.getElementById('home-user-role').textContent = state.user.role === 'admin' ? '' : '专 拽';
            }
        }

        // ------------------ 拽转 驻专驻 ------------------

        function renderProfileScreen() {
            if (!state.user) return;
            
            document.getElementById('profile-name').value = state.user.name;
            document.getElementById('profile-email').value = state.user.email;
            document.getElementById('profile-hobbies').value = state.user.hobbies.join(', ');
            document.getElementById('profile-role').textContent = state.user.role === 'admin' ? ' 注专转' : '专 拽';
            
            const totalContributions = state.user.contributions.length;
            document.getElementById('profile-contributions-summary').textContent = `住" ${totalContributions} 转专转. 拽转: ${state.user.points}`;
        }

        async function saveProfile() {
            if (!state.user) return;
            
            const hobbiesInput = document.getElementById('profile-hobbies').value;
            const newHobbies = hobbiesInput.split(',').map(h => h.trim()).filter(h => h.length > 0);
            
            try {
                await db.collection('users').doc(state.user.id).update({
                    hobbies: newHobbies
                });
                
                // 注 -state
                state.user.hobbies = newHobbies;
                alert('驻专驻 注 爪!');
            } catch (error) {
                console.error("砖 砖专转 驻专驻:", error);
                alert('砖 砖专转 驻专驻.');
            }
        }

        // ------------------ 拽转 专 ------------------

        async function loadUsers() {
            const usersListElement = document.getElementById('users-list');
            usersListElement.innerHTML = '<p class="text-center text-gray-500">注 专...</p>';

            try {
                const snapshot = await db.collection('users').orderBy('name').get();
                state.users = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                // 住 转 砖转砖  专砖转 专
                const otherUsers = state.users.filter(user => user.id !== state.user.id);
                
                usersListElement.innerHTML = otherUsers.map(user => `
                    <div class="flex items-center justify-between p-4 bg-white rounded-xl shadow-md border-b-2 border-kesher-secondary hover:shadow-lg transition duration-200">
                        <div class="flex items-center">
                            <img src="https://via.placeholder.com/40" alt="${user.name}" class="profile-pic w-10 h-10 border-kesher-primary">
                            <div class="mr-3">
                                <p class="font-semibold text-gray-800">${user.name}</p>
                                <p class="text-xs text-gray-500">${user.role === 'admin' ? '' : '专 拽'} | 拽转: ${user.points}</p>
                            </div>
                        </div>
                        <button class="bg-kesher-primary text-white px-4 py-2 rounded-lg text-sm font-semibold hover:bg-f05a5a transition duration-150" onclick="openChat('${user.id}')">
                            <i class="fas fa-comment-dots ml-1"></i> 砖 注
                        </button>
                    </div>
                `).join('');

            } catch (error) {
                console.error("砖 注转 砖转砖:", error);
                usersListElement.innerHTML = '<p class="text-center text-red-500 font-semibold mt-4"><i class="fas fa-exclamation-triangle ml-1"></i> 砖 注转 专.</p>';
            }
        }

        // ------------------ 拽转 爪' ------------------

        function getChatId(otherUserId) {
            // 爪专转 ID 爪' 拽注 注  砖 砖 -UIDs 住专 驻转
            const ids = [state.user.id, otherUserId].sort();
            return ids.join('_');
        }
async function openChat(otherUserId) {
            if (state.chatListener) {
                state.chatListener(); //   拽
            }
            goTo('chat'); //  住 爪'

            const chatId = getChatId(otherUserId);
            state.activeChat = { id: chatId, partnerId: otherUserId };

            const chatRef = db.collection('chats').doc(chatId);
            const messagesRef = chatRef.collection('messages'); // 驻 转转-住祝 注转

            try {
                // 砖 1:  砖住 爪' 专砖 拽.  , 爪专 转.
                await db.runTransaction(async (transaction) => {
                    const doc = await transaction.get(chatRef);
                    if (!doc.exists) {
                        transaction.set(chatRef, {
                            participants: [state.user.id, otherUserId],
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            // 转 住祝  lastMessage -lastMessageTimestamp -null/专拽
                        });
                        console.log("爪专 住 爪' 砖:", chatId);
                    }
                });

                // 砖 2: 转转  砖  转 转 爪'
                state.chatListener = chatRef.onSnapshot(docSnapshot => {
                    if (docSnapshot.exists) {
                        const chatData = docSnapshot.data();
                        
                        // 注  转 注转 爪' (砖 转转-住祝)
                        // **砖:** 砖转砖 -messagesRef 砖爪专 拽
                        messagesRef.orderBy('timestamp').get().then(messagesSnapshot => {
                            const messages = messagesSnapshot.docs.map(msgDoc => ({ id: msgDoc.id, ...msgDoc.data() }));
                            chatData.messages = messages; // 住祝 转 注转 拽 -chatData
                            renderChatScreen(chatData);
                        }).catch(error => {
                            console.error("砖 注转 注转:", error);
                            renderChatScreen({ participants: [state.user.id, otherUserId], messages: null, error: "砖 注转 注转." }); 
                        });
                    } else {
                        // 爪' 注  爪专 (专 拽专转 专拽 专注 拽爪专  专拽爪  住转)
                        renderChatScreen({ participants: [state.user.id, otherUserId], messages: [] });
                    }
                }, error => {
                    console.error("砖转 专  转 爪':", error);
                    const chatScreen = document.getElementById('chat-screen');
                    chatScreen.innerHTML = `<div class="p-6 text-center text-red-500 font-semibold">砖转 专 爪'!</div>`;
                });

            } catch (error) {
                console.error("砖 拽专转 驻转转 爪':", error);
                alert("专注 砖 拽专转 驻转转 爪'.");
            }
        }  
            

            // 转转  砖  转 转 爪'
            state.chatListener = chatRef.onSnapshot(docSnapshot => {
                if (docSnapshot.exists) {
                    const chatData = docSnapshot.data();
                    
                    // 注  转 注转 爪' (砖 转转-住祝)
                    db.collection('chats').doc(chatId).collection('messages').orderBy('timestamp').get().then(messagesSnapshot => {
                        const messages = messagesSnapshot.docs.map(msgDoc => ({ id: msgDoc.id, ...msgDoc.data() }));
                        chatData.messages = messages; // 住祝 转 注转 拽 -chatData
                        renderChatScreen(chatData);
                    }).catch(error => {
                        console.error("砖 注转 注转:", error);
                        // 爪 住 爪' 注 注转 砖
                        renderChatScreen({ participants: [state.user.id, otherUserId], messages: null, error: "砖 注转 注转." }); 
                    });
                } else {
                    // 爪' 注  爪专 (专 拽专转 专拽 专注 拽爪专)
                    renderChatScreen({ participants: [state.user.id, otherUserId], messages: null });
                }
            }, error => {
                console.error("砖转 专  转 爪':", error);
                // 爪 注转 砖 砖转砖 
                const chatScreen = document.getElementById('chat-screen');
                chatScreen.innerHTML = `<div class="p-6 text-center text-red-500 font-semibold">砖转 专 爪'! (拽 转 -Firebase Rules 砖).</div>`;
            });
        }

// **************** 驻拽爪 renderChatScreen 转拽转 ****************
        // 转拽 拽专  拽 砖 msg.timestamp
        function renderChatScreen(chatData) {
            const chatScreen = document.getElementById('chat-screen');
            if (!chatScreen) return;
            
            // 爪转 砖转祝 爪'
            const chatPartnerId = chatData.participants.find(id => id !== state.user.id);
            const chatPartner = state.users.find(u => u.id === chatPartnerId);

            let headerHTML = `
                <div class="p-4 border-b border-gray-200 flex items-center justify-between bg-white shadow-sm">
                    <button class="text-kesher-primary font-semibold" onclick="goTo('users')">
                        <i class="fas fa-arrow-right"></i> 专
                    </button>
                    <h3 class="text-xl font-bold">${chatPartner ? chatPartner.name : '爪  注'}</h3>
                    <div></div> 
                </div>
            `;
            
            // 转拽: (chatData.messages || [])  驻 爪' 砖, 驻 砖转拽 拽.
            const messagesHTML = (chatData.messages || []).map(msg => {
                
                // **转拽 砖 注转 -timestamp:**
                let timestamp;
                if (msg.timestamp && msg.timestamp.seconds) {
                    // 拽 转拽 砖 Firebase Timestamp
                    timestamp = new Date(msg.timestamp.seconds * 1000);
                } else if (msg.timestamp instanceof firebase.firestore.Timestamp) {
                    // 拽 Firebase Timestamp 砖砖祝 爪专 注 砖
                    timestamp = msg.timestamp.toDate();
                } 
                else {
                    // 专专转   -timestamp 住专/ 转拽 (注转 砖转)
                    timestamp = new Date();
                }

                const timeString = timestamp.toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit' });

                const isMe = msg.senderId === state.user.id;
                return `
                    <div class="flex ${isMe ? 'justify-end' : 'justify-start'} mb-3">
                        <div class="max-w-xs lg:max-w-md p-3 rounded-xl shadow-md ${isMe ? 'bg-kesher-secondary text-white rounded-tr-none' : 'bg-gray-200 text-gray-800 rounded-tl-none'}">
                            <p class="text-sm">${msg.content}</p>
                            <span class="text-xs opacity-80 block mt-1 text-right ${isMe ? 'text-white/70' : 'text-gray-500'}">${timeString}</span>
                        </div>
                    </div>
                `;
            }).join('');
            
            let chatContentHTML = `
                <div class="flex flex-col h-full">
                    <div class="flex-grow p-4 overflow-y-auto" id="messages-container">
                        ${chatData.error ? `<p class="text-center text-red-500 font-semibold">${chatData.error}</p>` : ''}
                        ${messagesHTML.length > 0 ? messagesHTML : '<p class="text-center text-gray-500 mt-4"> 注转. 砖 转 注 专砖!</p>'}
                    </div>
                    <div class="p-4 border-t border-gray-200 bg-white">
                        <div class="flex space-x-2 rtl:space-x-reverse">
                            <input type="text" id="message-input" class="flex-grow p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-kesher-secondary" placeholder="拽 注...">
                            <button class="bg-kesher-primary text-white p-3 rounded-lg hover:bg-f05a5a transition duration-150 font-semibold" onclick="sendMessage()">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;

            chatScreen.innerHTML = headerHTML + chatContentHTML;
            //  转 
            const messagesContainer = document.getElementById('messages-container');
            if (messagesContainer) {
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
        }
        // **************************************************

        async function sendMessage() {
            if (!state.activeChat || !state.user) return;

            const inputElement = document.getElementById('message-input');
            const content = inputElement.value.trim();

            if (content === '') return;

            const chatId = state.activeChat.id;

            try {
                // 1. 住驻转 注 转转-住祝 messages
                await db.collection('chats').doc(chatId).collection('messages').add({
                    senderId: state.user.id,
                    content: content,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // 2. 注 住 爪' 专砖 (注专 转爪 拽 注转转)
                await db.collection('chats').doc(chatId).update({
                    lastMessage: content,
                    lastMessageTimestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    participants: [state.user.id, state.activeChat.partnerId] //  砖砖转转驻 转 注
                });

                inputElement.value = ''; // 拽 砖 拽
                inputElement.focus(); // 专转 拽

            } catch (error) {
                console.error("砖 砖转 注:", error);
                alert('砖 砖转 注. 拽 转 -Console 驻专 住驻.');
            }
        }

        // ------------------ 拽转 转 ------------------

        function initializeApp() {
            goTo('loading'); // 爪 住 注 转
            
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    try {
                        // 1. 注 转 驻专 砖转砖 -Firestore
                        const userDoc = await db.collection('users').doc(user.uid).get();
                        if (userDoc.exists) {
                            const userData = userDoc.data();
                            state.user = { 
                                id: user.uid, 
                                email: user.email, 
                                name: userData.name, 
                                role: userData.role || 'user', 
                                points: userData.points || 0,
                                hobbies: userData.hobbies || [], 
                                contributions: userData.contributions || [] 
                            };
                            
                            // 2. 转 住 转 专拽   转 砖 拽专转
                            if (state.screen === 'loading' || state.screen === 'login' || state.screen === 'register') {
                                goTo('home');
                            } else {
                                render(); //  砖转砖 专 住 砖, 专专 砖
                            }
                        } else {
                            // 砖转砖 专 -Auth   拽 住 users (专 拽)
                            auth.signOut();
                        }
                    } catch (error) {
                        console.error("砖 拽专转 专 驻专驻 砖转砖  转 (Firebase/Config):", error);
                         //  砖 砖 专 -Firebase,  专 
                        state.user = null;
                        state.screen = 'login';
                        render();
                        alert("砖 专 砖专转  专 转. 住 转专 砖.");
                    }
                } else {
                    // **砖转砖  专  爪**
                    state.user = null;
                    if (state.screen !== 'register') {
                        goTo('login');
                    } else {
                        render();
                    }
                }
            });
        }

        // 驻注转 驻拽爪
        initializeApp(); 
    </script>
</body>
</html>
