<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×§×”×™×œ×ª ×§×©×¨ | ×”×—×™×™× ×”×˜×•×‘×™×</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <style>
        /* --- 1. ×¢×™×¦×•×‘ ×—×“×© ×•×¦×‘×¢×•× ×™ (××•×ª×× ×œ×§×”×œ ××‘×•×’×¨) --- */
        :root {
            --kesher-primary: #FF6B6B; /* Vibrant Coral - ×—×, ×× ×¨×’×˜×™ */
            --kesher-secondary: #4ECDC4; /* Bright Aqua/Teal - ××¨×¢× ×Ÿ, ×‘×”×™×¨ */
            --kesher-accent: #FFCD00; /* Gold/Yellow - ××•×¤×˜×™××™×•×ª, × ×™×§×•×“ */
            --kesher-text: #333;
        }
        .bg-kesher-primary { background-color: var(--kesher-primary); }
        .hover\:bg-kesher-primary:hover { background-color: #e56060; }
        .text-kesher-primary { color: var(--kesher-primary); }
        
        .bg-kesher-secondary { background-color: var(--kesher-secondary); }
        .hover\:bg-kesher-secondary:hover { background-color: #40b0aa; }
        .text-kesher-secondary { color: var(--kesher-secondary); }

        body {
            background-color: #f7f7f7; /* ×¨×§×¢ ×‘×”×™×¨ ×•× ×¢×™× */
            font-family: 'Arial', sans-serif;
        }
        #root {
            min-height: 100vh;
            padding-bottom: 4rem;
        }
    </style>
</head>
<body>
    <div id="root" class="pt-16">
        <div id="loading-spinner" class="flex justify-center items-center min-h-screen">
             <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-kesher-primary"></div>
             <p class="text-kesher-primary text-lg mr-4">×˜×•×¢×Ÿ × ×ª×•× ×™×...</p>
        </div>
    </div>

    <script>
        // --- 1. ×”×’×“×¨×•×ª Firebase ×•××™×—×–×•×¨ × ×ª×•× ×™× ---
        
        // **×•×•×“× ×©×–×”×• ×”-CONFIG ×”××“×•×™×§ ×©×œ×š!**
        const firebaseConfig = {
            apiKey: "AIzaSyCrcxC420HW5PXGNd8M4KuclUkiJSwHreM", 
            authDomain: "kesher-bakir.firebaseapp.com",
            projectId: "kesher-bakir",
            storageBucket: "kesher-bakir.firebasestorage.app",
            messagingSenderId: "671996189455",
            appId: "1:671996189455:web:dbe089d69a85a2ab38fc7a",
            measurementId: "G-42EWSKFXW" 
        };
        
        // ××ª×—×•×œ Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        
        const auth = firebase.auth();
        const db = firebase.firestore();
        const FieldValue = firebase.firestore.FieldValue; // ×§×™×¦×•×¨ × ×•×— ×™×•×ª×¨

        // ××¦×‘ ×’×œ×•×‘×œ×™ (State Management)
        const state = {
            user: null, 
            screen: 'loading', // ×”×ª×—×œ ×‘-loading
            users: [], 
            forums: [],
            activities: [],
            reports: [],
            
            // --- ×—×“×©: × ×ª×•× ×™× ×œ×¦'××˜ ---
            unreadCounts: {}, // { 'chat_room_id': count }
            
            // ××©×ª× ×™× ×¡×¤×¦×™×¤×™×™× ×œ××¡×š
            currentForumId: null,
            currentPost: null,
            currentPostReplies: [],
            selectedUser: null,
            chatMessages: [],
            chatListenerUnsubscribe: null, // <--- ×× ×•×™ ×œ×”×•×“×¢×•×ª ×‘×–××Ÿ ×××ª (×¤×•× ×§×¦×™×” ×©××‘×˜×œ×ª ×”××–× ×”)
            usersFilter: { city: '', role: '', hobby: '' },
        };
        
        // --- ×¨×©×™××ª ×”××œ×¦×•×ª ×™×•××™×ª ---
        const DAILY_RECOMMENDATIONS = [
            "×¦××• ×œ×˜×™×•×œ ×§×¦×¨ ×©×œ 30 ×“×§×•×ª ×‘×©××©! â˜€ï¸ ×—×™×•× ×™ ×œ×•×•×™×˜××™×Ÿ D ×•×œ××¦×‘ ×¨×•×— ×˜×•×‘.",
            "×”×ª×§×©×¨×• ×”×™×•× ×œ×—×‘×¨ ×•×ª×™×§ ×©×œ× ×“×™×‘×¨×ª× ××™×ª×• ×–××Ÿ ×¨×‘. ğŸ“ ×§×©×¨×™× ×—×‘×¨×ª×™×™× ×”× ×”××¤×ª×— ×œ××•×©×¨.",
            "×”×™×•× × ×¡×• ×œ××›×•×œ ×™×¨×§×•×ª ×™×¨×•×§×™× ×›×”×™×. ğŸ¥¦ ×”× ×¢×©×™×¨×™× ×‘×¡×™×“×Ÿ ×•×‘×¨×™××™× ×œ×œ×‘.",
            "×œ××“×• ××™×œ×” ×—×“×©×” ××• ×¢×•×‘×“×” ×”×™×¡×˜×•×¨×™×ª ××¢× ×™×™× ×ª. ğŸ§  ×©××¨×• ×¢×œ ×”××•×— ×—×“ ×•×¤×¢×™×œ.",
            "×”×©×§×™×¢×• 15 ×“×§×•×ª ×‘××“×™×˜×¦×™×” ××• × ×©×™××•×ª ×¢××•×§×•×ª. ğŸ§˜ ×–×” ××•×¨×™×“ ×œ×—×¥ ×“× ×•××—×–×§ ××ª ×”× ×¤×©.",
            "×¡×“×¨×• ××’×™×¨×” ××—×ª ×§×˜× ×” ×‘×‘×™×ª. ××¨×’×•×Ÿ ××©×—×¨×¨ ×•××‘×™× ×¡×™×¤×•×§! âœ¨",
            "×›×ª×‘×• 3 ×“×‘×¨×™× ×©××ª× ××¡×™×¨×™ ×ª×•×“×” ×¢×œ×™×”× ×”×™×•×. ğŸ™ ×ª×¨×’×•×œ ×”×›×¨×ª ×ª×•×“×” ××©×¤×¨ ××ª ××™×›×•×ª ×”×—×™×™×."
        ];
        
        /**
         * ×¤×•× ×§×¦×™×” ×œ×—×™×©×•×‘ ×”×”××œ×¦×” ×”×™×•××™×ª (××©×ª× ×” ×›×œ ×™×•×)
         */
        function getDailyRecommendation() {
            const today = new Date();
            const dayOfYear = Math.floor((today - new Date(today.getFullYear(), 0, 0)) / 1000 / 60 / 60 / 24);
            const index = dayOfYear % DAILY_RECOMMENDATIONS.length;
            return DAILY_RECOMMENDATIONS[index];
        }
        
        /**
         * ×¤×•× ×§×¦×™×™×ª ×¢×–×¨ ×œ×™×™×¦×•×¨ ID ×—×“×¨ ×¦'××˜ ×¢×§×‘×™ (A_B ××• B_A)
         */
        function getChatRoomId(uid1, uid2) {
             if (!uid1 || !uid2) {
                console.error("×©×’×™××”: ×—×¡×¨ UID ×œ×¦×•×¨×š ×™×¦×™×¨×ª ×—×“×¨ ×¦'××˜.", { uid1, uid2 });
                return null; 
            }
            return uid1 < uid2 ? `${uid1}_${uid2}` : `${uid2}_${uid1}`;
        }

        /**
         * ×¤×•× ×§×¦×™×™×ª ×˜×¢×™× ×ª × ×ª×•× ×™× ×¤×™×§×˜×™×‘×™×™× ×œ××‘× ×™× (×¤×•×¨×•×, ×¤×¢×™×œ×•×™×•×ª)
         */
        function loadFakeForumData(forceUserFakes = false) {
            const now = firebase.firestore.Timestamp.now();
            const post1Replies = [
                { id: 'r1', content: '××¡×›×™×! ×”×—×©×™×¤×” ×œ××ª× ×“×‘×™× ×—×“×©×™× ×”×™× ××ª×’×¨ ×××™×ª×™.', creatorId: 'user2', creatorName: '×“× ×™××œ ×›×”×Ÿ', createdAt: now },
                { id: 'r2', content: '××•×œ×™ ×›×“××™ ×œ×™×¦×•×¨ ×“×£ × ×—×™×ª×” ×™×™×¢×•×“×™?', creatorId: 'user1', creatorName: '××•×¨×™×ª ×œ×•×™', createdAt: now },
            ];
            state.forums = [
                { id: 'f1', title: '×”×ª× ×“×‘×•×ª ×•×§×”×™×œ×”', description: '×“×™×•× ×™× ×¢×œ ×™×•×–××•×ª ×—×‘×¨×ª×™×•×ª ×—×“×©×•×ª.', icon: '<i class="fa-solid fa-users"></i>', posts: [
                    { id: 'p1', title: '××™×š ××’×™×™×¡×™× ××ª× ×“×‘×™× ×—×“×©×™×?', content: '×× ×™ ×× ×”×œ ×§×‘×•×¦×” ×§×˜× ×” ×•××—×¤×© ×“×¨×›×™× ×™×¦×™×¨×ª×™×•×ª ×œ×’×™×™×¡ ×¢×•×“ ×—×‘×¨×™× ×¤×¢×™×œ×™×.', creatorId: 'user1', creatorName: '××•×¨×™×ª ×œ×•×™', createdAt: now, likes: ['user2', 'user3'], replies: post1Replies },
                ]},
                { id: 'f2', title: '×˜×™×•×œ×™× ×•×˜×‘×¢', description: '××¡×œ×•×œ×™× ××•××œ×¦×™× ×•×¦×™×•×“ ×§××¤×™× ×’.', icon: '<i class="fa-solid fa-mountain-sun"></i>', posts: [] },
                { id: 'f3', title: '×‘×¨×™××•×ª ×•×›×•×©×¨', description: '×˜×™×¤×™× ×•×“×™×•× ×™× ×¢×œ ×©××™×¨×” ×¢×œ ×›×•×©×¨ ×‘×’×™×œ ×”×©×œ×™×©×™.', icon: '<i class="fa-solid fa-heart-pulse"></i>', posts: [] },
            ];
            
            // ×˜×¢×™× ×ª ××©×ª××©×™× ×¤×™×§×˜×™×‘×™×™× ×× ××™×Ÿ ××£ ××©×ª××© ×‘××¢×¨×›×ª ××• × ×›×©×œ ××™×—×–×•×¨
            if (forceUserFakes || state.users.length === 0) {
                 state.users = [
                    { id: 'user1', name: '××•×¨×™×ª ×œ×•×™', email: 'orit@example.com', city: '×ª×œ ××‘×™×‘', role: 'admin', points: 150, isOnline: true, hobbies: ['×‘×™×©×•×œ', '×˜×™×•×œ×™×'], contributions: ['×™×™×¢×•×¥ ×¢×¡×§×™', '××¨×’×•×Ÿ ××™×¨×•×¢×™×'], isActive: true },
                    { id: 'user2', name: '×“× ×™××œ ×›×”×Ÿ', email: 'daniel@example.com', city: '×™×¨×•×©×œ×™×', role: 'senior', points: 300, isOnline: false, hobbies: ['×¡×¤×•×¨×˜', '×¦×™×œ×•×'], contributions: ['×¢×–×¨×” ×˜×›× ×™×ª', '×”×“×¨×›×”'], isActive: true },
                    { id: 'user3', name: '×××™×” ××œ×•×Ÿ', email: 'maya@example.com', city: '×—×™×¤×”', role: 'user', points: 900, isOnline: true, hobbies: ['×¦×™×œ×•×', '××¤×™×™×”'], contributions: ['× ×™×”×•×œ ×§×”×™×œ×”', '×’×¨×¤×™×§×”'], isActive: true },
                    { id: 'user4', name: '×™×•×¡×£ ××•×©×”×”', email: 'yosef@example.com', city: '×—×™×¤×”', role: 'user', points: 10, isOnline: false, hobbies: ['×©×—××˜'], contributions: ['×¤× ×¡×™×”'], isActive: false },
                ];
            }

            // ×˜×¢×™× ×ª ×¤×¢×™×œ×•×™×•×ª ×¤×™×§×˜×™×‘×™×•×ª ×× ×œ× × ×˜×¢× ×• ×-Firebase
            if (state.activities.length === 0) {
                 state.activities = [
                    { id: 'a1', title: '×˜×™×•×œ ×¨×’×œ×™ ×‘×’×Ÿ ×”×‘×•×˜× ×™', description: '××¡×œ×•×œ ×§×œ ××ª××™× ×œ×›×•×œ×.', date: new Date(new Date().getTime() + 86400000 * 5), location: '×ª×œ ××‘×™×‘', creatorName: '××•×¨×™×ª ×œ×•×™', attendees: ['user1', 'user3'] },
                    { id: 'a2', title: '×¡×“× ×ª ××¤×™×™×” ×œ××ª×§×“××™×', description: '× ××¤×” ×¢×•×’×•×ª ×©××¨×™× ××™×•×—×“×•×ª.', date: new Date(new Date().getTime() + 86400000 * 10), location: '×™×¨×•×©×œ×™×', creatorName: '×××™×” ××œ×•×Ÿ', attendees: ['user3'] },
                ];
            }

            state.reports = [
                { id: 'rep1', itemId: 'p1', itemType: 'post', reason: '×©×¤×” ×‘×•×˜×”', reporterName: '×“× ×™××œ ×›×”×Ÿ', reportedUserId: 'user1', status: '×—×“×©' },
            ];
        }
        
        /**
         * ××—×–×•×¨ × ×ª×•× ×™× ×¨××©×•× ×™ ×-Firestore (×—×™×•× ×™ ×œ×× ×™×¢×ª ×”××¡×š ×”×œ×‘×Ÿ) - **×ª×•×§×Ÿ ×œ×˜×™×¤×•×œ ×‘×©×’×™××•×ª**
         */
        async function fetchInitialData() {
            // **×©×œ×‘ 1: ×˜×¢×™× ×ª × ×ª×•× ×™× ×¤×™×§×˜×™×‘×™×™× ×§×•×“× (×›×‘×¨×™×¨×ª ××—×“×œ)**
            loadFakeForumData(false); 
            
            try {
                // 2.1. ××—×–×•×¨ ×¨×©×™××ª ××©×ª××©×™×
                const usersSnapshot = await db.collection('users').get();
                if (!usersSnapshot.empty) {
                    state.users = usersSnapshot.docs.map(doc => ({ 
                        id: doc.id, 
                        ...doc.data(), 
                        isOnline: doc.data().isOnline || false,
                        role: doc.data().role || 'user',
                        isActive: doc.data().isActive !== false
                    }));
                } else {
                    // ×× ××™×Ÿ ××©×ª××©×™× ×‘-Firestore, ×˜×¢×Ÿ ×¤×™×§×˜×™×‘×™×™× (forceUserFakes = true)
                    loadFakeForumData(true); 
                }
                
                // 2.2. ××—×–×•×¨ ×¤×¢×™×œ×•×™×•×ª
                try {
                    const activitiesSnapshot = await db.collection('activities').get();
                    state.activities = activitiesSnapshot.docs.map(doc => ({ 
                        id: doc.id, 
                        ...doc.data(), 
                        date: doc.data().date?.toDate() || new Date() 
                    }));
                } catch (error) {
                    console.warn("××–×”×¨×”: ×©×’×™××” ×‘××—×–×•×¨ ×¤×¢×™×œ×•×™×•×ª. × ×˜×¢× ×• ×¤×¢×™×œ×•×™×•×ª ×¤×™×§×˜×™×‘×™×•×ª.", error.message);
                    // ×”× ×ª×•× ×™× ×”×¤×™×§×˜×™×‘×™×™× ×›×‘×¨ × ×˜×¢× ×• ×‘-loadFakeForumData(false)
                }
                
                // 2.3. ××—×–×•×¨ ××•× ×” ×”×•×“×¢×•×ª ×©×œ× × ×§×¨××• - **×¨×§ ×× ×”××©×ª××© ××—×•×‘×¨**
                if (state.user && state.user.id) {
                    try {
                        // ××—×–×•×¨ ×›×œ ×—×“×¨×™ ×”×¦'××˜ ×‘×”× ×”××©×ª××© ××©×ª×ª×£
                        const myChatsSnapshot = await db.collection('chats')
                            .where('participants', 'array-contains', state.user.id)
                            .get();

                        state.unreadCounts = {};
                        for (const chatDoc of myChatsSnapshot.docs) {
                            // ×”××¤×ª×— ×”×•× 'unread_UID_×©×œ×™'
                            const unreadCountForMe = chatDoc.data()[`unread_${state.user.id}`] || 0;
                            if (unreadCountForMe > 0) {
                                state.unreadCounts[chatDoc.id] = unreadCountForMe;
                            }
                        }
                    } catch (error) {
                         console.warn("××–×”×¨×”: ×©×’×™××” ×‘××—×–×•×¨ ××•× ×™ ×”×•×“×¢×•×ª ×¦'××˜ (××•×œ×™ ×‘×’×œ×œ ×›×œ×œ×™ ××‘×˜×—×”). ××•× ×” ×”×¦'××˜×™× × ×©××¨ 0.", error.message);
                         state.unreadCounts = {}; // × ×§×” ×œ××§×¨×” ×©×”×™×™×ª×” ×©×’×™××” ×—×œ×§×™×ª
                    }
                }
                
            } catch (error) {
                // ×©×’×™××” ×›×œ×œ×™×ª (×›× ×¨××” ×‘×©×œ×‘ ×”-users) - ×”×©×ª××© ×‘× ×ª×•× ×™× ×”×¤×™×§×˜×™×‘×™×™× ×©× ×©××¨×• ×‘×”×ª×—×œ×”
                console.error("×©×’×™××” ×§×¨×™×˜×™×ª ×‘××—×–×•×¨ × ×ª×•× ×™× ×¨××©×™ ×-Firebase. ×©×™××•×© ×‘× ×ª×•× ×™× ×¤×™×§×˜×™×‘×™×™× ×‘×œ×‘×“:", error);
                loadFakeForumData(true); // ×× ×™×© ×©×’×™××” ×§×¨×™×˜×™×ª, ×•×•×“× ×˜×¢×™× ×” ×›×¤×•×™×” ×©×œ ××©×ª××©×™× ×¤×™×§×˜×™×‘×™×™×
            }
        }
        
        // ×¤×•× ×§×¦×™×™×ª ×˜×¢×™× ×ª × ×ª×•× ×™× ×¤×™×§×˜×™×‘×™×™× ×œ××‘× ×™× (×¤×•×¨×•×, ×¤×¢×™×œ×•×™×•×ª) - ×œ×•×’×™×§×” ×”×•×¢×‘×¨×” ××¢×œ×”
        // ...
        
        /**
         * ×¤×•× ×§×¦×™×™×ª × ×™×ª×•×‘ ×‘×¡×™×¡×™×ª
         */
        function goTo(screen, params = {}) {
            // **×‘×˜×œ ×× ×•×™ ×¦'××˜ ×× ×¢×•×–×‘×™× ××ª ×”××¡×š** if (state.chatListenerUnsubscribe && screen !== 'chat') {
                state.chatListenerUnsubscribe();
                state.chatListenerUnsubscribe = null;
                state.chatMessages = []; // × ×§×” ×”×•×“×¢×•×ª ××§×•××™×•×ª
            }
            
            state.screen = screen;
            state.currentForumId = params.forumId || null;
            state.currentPost = null;
            state.currentPostReplies = [];
            state.selectedUser = null; 

            if (screen === 'forumPosts' && params.forumId) {
                state.currentForumId = params.forumId;
            } else if (screen === 'postDetails' && params.postId) {
                const forum = state.forums.find(f => f.posts?.some(p => p.id === params.postId));
                if (forum) {
                    state.currentPost = forum.posts.find(p => p.id === params.postId);
                    state.currentPostReplies = state.currentPost.replies || [];
                    state.currentForumId = forum.id;
                } else {
                    console.error('×©×’×™××”: ×”×¤×•×¡×˜ ×œ× × ××¦×', params.postId);
                    goTo('forums');
                }
            }
            render();
            // ×’×œ×™×œ×” ××•×˜×•××˜×™×ª ×œ××˜×” ×‘×¦'××˜ (××‘×•×¦×¢×ª ×©×•×‘ ×‘-openChat)
            if (screen === 'chat') {
                setTimeout(() => {
                    const chatBox = document.getElementById('chatBox');
                    if (chatBox) chatBox.scrollTop = chatBox.scrollHeight;
                }, 50);
            }
        }

        /**
         * ×¤×ª×™×—×ª ×¦'××˜ ×•××—×–×•×¨ ×”×•×“×¢×•×ª ×‘×–××Ÿ ×××ª (onSnapshot) - **×”×¤×•× ×§×¦×™×” ×ª×•×§× ×” ×œ×–×¨×™××” ×—×œ×§×” ×™×•×ª×¨**
         */
        window.openChat = (targetUser) => {
            // **×‘×“×™×§×ª × ×ª×•× ×™× ×§×¨×™×˜×™×ª ×œ×× ×™×¢×ª ×§×¨×™×¡×”**
            if (!state.user || !state.user.id || !targetUser || !targetUser.id) {
                console.error("×©×’×™××”: ×—×¡×¨ ××©×ª××© ××—×•×‘×¨ ××• ××©×ª××© ×™×¢×“ ×œ×¦'××˜.", { user: state.user, target: targetUser });
                alert("×©×’×™××” ×¤× ×™××™×ª: ×œ× × ×™×ª×Ÿ ×œ×¤×ª×•×— ×¦'××˜. ×—×¡×¨ ×¤×¨×˜×™ ××©×ª××©.");
                goTo('users');
                return;
            }
            
            // ×‘×˜×œ ×× ×•×™ ×§×•×“× ×× ×§×™×™× (×œ××§×¨×” ×©×œ ××¢×‘×¨ ×‘×™×Ÿ ×¦'××˜×™×)
            if (state.chatListenerUnsubscribe) {
                 state.chatListenerUnsubscribe();
            }

            state.selectedUser = targetUser;
            const chatRoomId = getChatRoomId(state.user.id, targetUser.id);
            state.chatMessages = [];
            
            if (!chatRoomId) {
                 console.error("×©×’×™××”: ×œ× × ×™×ª×Ÿ ×œ×™×¦×•×¨ Chat Room ID. ×—×•×–×¨ ×œ××¡×š ×—×‘×¨×™×.");
                 goTo('users');
                 return;
            }
            
            // × ×™×ª×•×‘ ××™×™×“×™ ×œ××¡×š ×”×¦'××˜ ×¢× ×”×•×“×¢×ª ×˜×¢×™× ×”
            goTo('chat'); 
            
            // **×”×¤×¢×œ×ª Listener ×‘×–××Ÿ ×××ª (onSnapshot) ×•×¢×“×›×•×Ÿ ×”-state**
            const chatDocRef = db.collection('chats').doc(chatRoomId);
            const messagesRef = chatDocRef.collection('messages');
            
            state.chatListenerUnsubscribe = messagesRef
                .orderBy('timestamp')
                .onSnapshot(async (snapshot) => {
                    // ×¢×“×›×•×Ÿ ×”×•×“×¢×•×ª ×”×¦'××˜ ×‘-State
                    state.chatMessages = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    
                    // × ×™×§×•×™ ××•× ×” ×”×”×•×“×¢×•×ª ×©×œ× × ×§×¨××• ×¢×‘×•×¨ ×”××©×ª××© ×”× ×•×›×—×™
                    if (state.user && state.user.id) {
                        const unreadCountKey = `unread_${state.user.id}`;
                        
                        // ×‘×“×™×§×” ×”×× ×™×© ×¦×•×¨×š ×‘××¤×¡ ××ª ×”××•× ×”
                        // ××™×Ÿ ×¦×•×¨×š ×œ×—×›×•×ª ×œ-get ×›××Ÿ, ××¤×©×¨ ×œ× ×¡×•×ª ×œ×¢×“×›×Ÿ ×™×©×¨
                        
                        try {
                            // ××™×¤×•×¡ ×”××•× ×” ×‘-Firestore (set ×¢× Merge ×× ×”××¡××š ×œ× ×§×™×™×)
                            await chatDocRef.set({ 
                                [unreadCountKey]: 0,
                                participants: [state.user.id, targetUser.id], // ×œ×•×•×“× ×©××©×ª×ª×¤×™× ×ª××™×“ ×§×™×™××™×
                            }, { merge: true });
                            
                            // ××™×¤×•×¡ ×”××•× ×” ×‘-State ×”××§×•××™ ×•×”×¤×¢×œ×ª ×¨× ×“×•×¨ ×œ×¢×“×›×•×Ÿ ××•× ×” ×”×”×•×“×¢×•×ª ×‘×›×•×ª×¨×ª
                            if (state.unreadCounts[chatRoomId] > 0) {
                                delete state.unreadCounts[chatRoomId];
                                console.log(`××•× ×” ×”×•×“×¢×•×ª ${chatRoomId} ××•×¤×¡ ×‘×”×¦×œ×—×”.`);
                            }
                            
                        } catch (e) {
                            // ×× ×™×© ×‘×¢×™×” ×‘×›×ª×™×‘×” ×œ-Firestore (×œ××©×œ, ×›×œ×œ×™ ××‘×˜×—×”), ×”×¦'××˜ ×¢×“×™×™×Ÿ ×™×¨×•×¥ ×¢× ×”-onSnapshot
                            console.warn("××–×”×¨×”: ×œ× × ×™×ª×Ÿ ×œ××¤×¡ ××ª ××•× ×” ×”×”×•×“×¢×•×ª ×©×œ× × ×§×¨××•.", e.message);
                        }
                    }

                    // ×’×œ×™×œ×” ××•×˜×•××˜×™×ª ×œ×ª×—×ª×™×ª ×”×¦'××˜ ×œ××—×¨ ×˜×¢×™× ×ª ×”×”×•×“×¢×•×ª
                    render(); // ×¨× ×“×•×¨ ×œ××—×¨ ×¢×“×›×•×Ÿ state.chatMessages
                    setTimeout(() => {
                        const chatBox = document.getElementById('chatBox');
                        if (chatBox) chatBox.scrollTop = chatBox.scrollHeight;
                    }, 50);

                }, (error) => {
                    console.error("×©×’×™××” ×‘-onSnapshot ×©×œ ×”×¦'××˜:", error);
                    // ×”×¦×’×ª ×”×•×“×¢×ª ×©×’×™××” ×‘×ª×•×š ×”×¦'××˜ ×‘××§×•× ×§×¨×™×¡×”
                    state.chatMessages = [{ 
                        id: 'm0', 
                        senderId: targetUser.id, 
                        content: `**×©×’×™××ª ×—×™×‘×•×¨ ×§×¨×™×˜×™×ª!** ×œ× × ×™×ª×Ÿ ×œ×˜×¢×•×Ÿ ×”×•×“×¢×•×ª ×‘×–××Ÿ ×××ª. ×™×™×ª×›×Ÿ ×©×™×© ×‘×¢×™×” ×‘×”×’×“×¨×•×ª Firebase (Rules/Config).`, 
                        timestamp: firebase.firestore.Timestamp.now() 
                    }];
                    render();
                });
        };


        // --- 2. ×¤×•× ×§×¦×™×•×ª Firebase (×”×ª×—×‘×¨×•×ª, ×¨×™×©×•×, ×©×—×–×•×¨) ---
        
        window.doLogin = async () => {
            const email = document.getElementById('email').value;
            const password = document.getElementById('pwd').value;
            const errorElement = document.getElementById('loginError');
            errorElement.textContent = '';
            
            try {
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                const user = userCredential.user;
                const userDoc = await db.collection('users').doc(user.uid).get();
                
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    
                    // ×‘×“×™×§×ª ×¡×˜×˜×•×¡ ×”×©×¢×™×” (isActive: false)
                    if (userData.isActive === false) {
                        errorElement.textContent = '×—×©×‘×•× ×š ××•×©×”×” ×¢×œ ×™×“×™ ×× ×”×œ ×”××¢×¨×›×ª.';
                        auth.signOut();
                        return;
                    }

                    state.user = { 
                        id: user.uid, 
                        email: user.email, 
                        name: userData.name, 
                        role: userData.role || 'user', 
                        points: userData.points || 0,
                        hobbies: userData.hobbies || [], 
                        contributions: userData.contributions || [],
                        isActive: userData.isActive !== false
                    };
                    await fetchInitialData(); 
                    goTo('home');
                } else {
                    errorElement.textContent = '×©×’×™××”: ×”×¤×¨×•×¤×™×œ ×œ× × ××¦× ×‘××¡×“ ×”× ×ª×•× ×™×.';
                    auth.signOut();
                }
            } catch (error) {
                errorElement.textContent = `×©×’×™××ª ×”×ª×—×‘×¨×•×ª: ${error.message}`;
            }
        };

        window.doRegister = async () => {
            const name = document.getElementById('regName').value;
            const email = document.getElementById('regEmail').value;
            const password = document.getElementById('regPwd').value;
            const city = document.getElementById('regCity').value;
            const hobbiesInput = document.getElementById('regHobbies').value;
            const contributionsInput = document.getElementById('regContributions').value;
            const errorElement = document.getElementById('registerError');
            errorElement.textContent = '';
            if (!name || !email || !password || !city || !hobbiesInput || !contributionsInput) {
                errorElement.textContent = '×™×© ×œ××œ× ××ª ×›×œ ×”×©×“×•×ª.';
                return;
            }
            
            const hobbiesArray = hobbiesInput.split(',').map(item => item.trim()).filter(item => item !== '');
            const contributionsArray = contributionsInput.split(',').map(item => item.trim()).filter(item => item !== '');

            try {
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;
                
                const newUserData = {
                    name: name,
                    city: city,
                    role: 'user', // ×‘×¨×™×¨×ª ××—×“×œ: ××©×ª××© ×¨×’×™×œ
                    points: 0,
                    isOnline: true,
                    isActive: true, // ××©×ª××© ×—×“×© ×¤×¢×™×œ ×›×‘×¨×™×¨×ª ××—×“×œ
                    hobbies: hobbiesArray, 
                    contributions: contributionsArray,
                    email: email,
                    joinDate: FieldValue.serverTimestamp()
                };
                await db.collection('users').doc(user.uid).set(newUserData);
                
                state.user = { id: user.uid, email: user.email, ...newUserData };
                await fetchInitialData();
                goTo('home');
                
            } catch (error) {
                 errorElement.textContent = `×©×’×™××ª ×¨×™×©×•×: ${error.message}`;
            }
        };

        window.doLogout = () => {
            auth.signOut().then(() => {
                state.user = null;
                goTo('login');
            });
        };


        // --- 3. ×¤×•× ×§×¦×™×•×ª ×¢×–×¨ ×•××™× ×˜×¨××§×¦×™×” ---
        
        /**
         * ×¤×•× ×§×¦×™×™×ª ×©×œ×™×—×ª ×”×•×“×¢×” - ×©××™×¨×” ×‘-Firestore
         */
        window.sendMessage = async () => {
            const input = document.getElementById('chatInput');
            const content = input.value.trim();
            if (!content || !state.selectedUser || !state.user || !state.user.id) return;
            
            const chatRoomId = getChatRoomId(state.user.id, state.selectedUser.id);
            const receiverId = state.selectedUser.id;
            
            if (!chatRoomId) {
                alert("×©×’×™××” ×¤× ×™××™×ª: ×œ× × ×™×ª×Ÿ ×œ×©×œ×•×— ×”×•×“×¢×”.");
                return;
            }

            const newMessage = {
                senderId: state.user.id,
                content: content,
                timestamp: FieldValue.serverTimestamp(),
                read: false,
            };
            
            try {
                // ×”×•×¡×¤×ª ×”×”×•×“×¢×” ×œ××•×¡×£ Messages
                // ×”×¢×¨×”: ××™×Ÿ ×¦×•×¨×š ×œ×¢×“×›×Ÿ ××ª ×”-state ×”××§×•××™ ×›××Ÿ, ××›×™×•×•×Ÿ ×©×”-onSnapshot ××˜×¤×œ ×‘×›×š ×‘×–××Ÿ ×××ª.
                await db.collection('chats').doc(chatRoomId).collection('messages').add(newMessage);
                
                // ×¢×“×›×•×Ÿ (××• ×™×¦×™×¨×ª) ××¡××š ×”×¦'××˜ ×”×¨××©×™
                // **×”×’×‘×¨×ª ××•× ×” ×”×”×•×“×¢×•×ª ×©×œ× × ×§×¨××• ×¢×‘×•×¨ ×”××©×ª××© ×”××§×‘×œ**
                await db.collection('chats').doc(chatRoomId).set({
                    participants: [state.user.id, receiverId],
                    lastMessage: content,
                    lastMessageTime: FieldValue.serverTimestamp(),
                    [`unread_${receiverId}`]: FieldValue.increment(1), // <--- ×©×™× ×•×™ ×§×¨×™×˜×™! ×”×’×“×œ×ª ×”××•× ×”
                }, { merge: true });

                
                input.value = '';
                // ×’×œ×™×œ×” ×œ×ª×—×ª×™×ª ×”×¦'××˜ ×‘××•×¤×Ÿ ××™×™×“×™ - ×”-onSnapshot ×™×¤×¢×™×œ ×¨× ×“×•×¨ × ×•×¡×£
                setTimeout(() => {
                    const chatBox = document.getElementById('chatBox');
                    if (chatBox) chatBox.scrollTop = chatBox.scrollHeight;
                }, 0); 
                
            } catch (error) {
                console.error("×©×’×™××” ×‘×©×œ×™×—×ª ×”×•×“×¢×” (Firebase/Config):", error);
                alert("×©×’×™××” ×‘×©×œ×™×—×ª ×”×”×•×“×¢×”. ×‘×“×•×§ ××ª ×”×—×™×‘×•×¨ ×œ-Firebase ×•×›×œ×œ×™ ×”××‘×˜×—×”.");
            }
        };

        window.createPost = () => { alert('×”×¤×•× ×§×¦×™×” ×œ×™×¦×™×¨×ª ×¤×•×¡×˜ ×˜×¨× ××•××©×” ×‘××•×¤×Ÿ ××œ×.'); };
        window.addReply = () => { alert('×”×¤×•× ×§×¦×™×” ×œ×”×•×¡×¤×ª ×ª×’×•×‘×” ×˜×¨× ××•××©×” ×‘××•×¤×Ÿ ××œ×.'); };
        window.toggleLike = (postId) => { alert('×”×¤×•× ×§×¦×™×” ×œ×œ×™×™×§ ×˜×¨× ××•××©×” ×‘××•×¤×Ÿ ××œ×.'); };
        window.createActivity = async () => { alert('×”×¤×•× ×§×¦×™×” ×œ×™×¦×™×¨×ª ×¤×¢×™×œ×•×ª ×˜×¨× ××•××©×” ×‘××•×¤×Ÿ ××œ×.'); };
        window.registerForActivity = async (activityId) => { alert('×”×”×¨×©××” ×œ×¤×¢×™×œ×•×ª ×˜×¨× ××•××©×” ×‘××•×¤×Ÿ ××œ×.'); };
        window.reportItem = (itemId, itemType, reportedUserId) => { alert(`×“×•×•×— ×¢×œ ${itemType} (ID: ${itemId}) ×¢×§×‘ ×ª×•×›×Ÿ ×œ× ×¨××•×™. ×ª×•×“×” ×¢×œ ×”×“×™×•×•×—!`); };
        window.updateReportStatus = (reportId, newStatus) => { alert(`×¡×˜×˜×•×¡ ×”×“×™×•×•×— ${reportId} ×¢×•×“×›×Ÿ ×œ: ${newStatus}`); };

        /**
         * ×¤×•× ×§×¦×™×™×ª ××—×™×§×ª ×¤×•×¡×˜ (×¢× ×”×¨×©××•×ª)
         */
        window.deletePost = async (postId) => {
            if (state.user.role !== 'admin' && state.user.role !== 'senior') {
                alert('××™×Ÿ ×œ×š ×”×¨×©××” ×œ××—×•×§ ×¤×•×¡×˜×™×.');
                return;
            }
            if (!confirm("×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×”×¤×•×¡×˜ ×”×–×”?")) return;

            // ×¢×“×›×•×Ÿ ×”-state ×”××§×•××™
            const forum = state.forums.find(f => f.posts?.some(p => p.id === postId));
            if (forum) {
                forum.posts = forum.posts.filter(p => p.id !== postId);
                state.currentPost = null;
                alert('×”×¤×•×¡×˜ × ××—×§ ×‘×”×¦×œ×—×”.');
                goTo('forumPosts', { forumId: forum.id });
                // ×‘××¢×¨×›×ª ×××™×ª×™×ª, × ××—×§ ×›××Ÿ ×-Firestore
            }
        };

        /**
         * ×¤×•× ×§×¦×™×™×ª ×¢×“×›×•×Ÿ ×“×¨×’×ª ××©×ª××© (×‘××¡×š × ×™×”×•×œ)
         */
        window.updateUserRole = async (userId, newRole) => {
            if (state.user.role !== 'admin') {
                alert('×¨×§ ××“××™×Ÿ ×™×›×•×œ ×œ×©× ×•×ª ×“×¨×’×•×ª.');
                return;
            }
            if (userId === state.user.id) {
                alert('××™× ×š ×™×›×•×œ ×œ×©× ×•×ª ××ª ×”×“×¨×’×” ×©×œ ×¢×¦××š.');
                return;
            }
            
            try {
                await db.collection('users').doc(userId).update({ role: newRole });
                const userToUpdate = state.users.find(u => u.id === userId);
                if (userToUpdate) {
                    userToUpdate.role = newRole;
                    alert(`×“×¨×’×ª ×”××©×ª××© ${userToUpdate.name} ×¢×•×“×›× ×” ×œ: ${newRole}`);
                }
                render();
            } catch (error) {
                console.error("×©×’×™××” ×‘×¢×“×›×•×Ÿ ×“×¨×’×”:", error);
                alert("×©×’×™××” ×‘×¢×“×›×•×Ÿ ×“×¨×’×” ×‘-Firestore. ×‘×“×•×§ ××ª ×”×—×™×‘×•×¨ ×•×›×œ×œ×™ ×”××‘×˜×—×”.");
            }
        };

        /**
         * ××—×™×§×ª ××©×ª××© ×œ×¦××™×ª×•×ª (Admin only)
         */
        window.deleteUser = async (userId, userName) => {
            if (state.user.role !== 'admin') {
                alert('×¨×§ ××“××™×Ÿ ×™×›×•×œ ×œ××—×•×§ ××©×ª××©×™×.');
                return;
            }
            if (userId === state.user.id) {
                alert('××™× ×š ×™×›×•×œ ×œ××—×•×§ ××ª ×”×—×©×‘×•×Ÿ ×©×œ×š ×“×¨×š ×”×××©×§ ×”×–×”.');
                return;
            }
            if (!confirm(`×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ×œ×¦××™×ª×•×ª ××ª ×”××©×ª××© ${userName}? ×¤×¢×•×œ×” ×–×• ×‘×œ×ª×™ ×”×¤×™×›×”.`)) return;
            try {
                // **×”×¢×¨×” ×—×©×•×‘×”: ××—×™×§×” ×××™×ª×™×ª ×©×œ ××©×ª××© Auth ×“×•×¨×©×ª ×¤×•× ×§×¦×™×™×ª ×¦×“ ×©×¨×ª (Cloud Function)**
                // ×‘××•×“×œ ×”× ×•×›×—×™, × ××—×§ ×-Firestore ×•× ××ª×—×œ ××ª ×”-state.
                await db.collection('users').doc(userId).delete();
                // ×¢×“×›×•×Ÿ ×”-state ×”××§×•××™
                state.users = state.users.filter(u => u.id !== userId);
                alert(`×”××©×ª××© ${userName} × ××—×§ ×‘×”×¦×œ×—×” (×-Firestore ×‘×œ×‘×“).`);
                render();
            } catch (error) {
                console.error("×©×’×™××” ×‘××—×™×§×ª ××©×ª××©:", error);
                alert("×©×’×™××” ×‘××—×™×§×ª ×”××©×ª××©. ×‘×“×•×§ ×›×œ×œ×™ ××‘×˜×—×”.");
            }
        };

        /**
         * ×”×©×”×™×” ××• ×”×¤×¢×œ×” ××—×“×© ×©×œ ××©×ª××© (Admin only)
         */
        window.toggleUserActive = async (userId, userName, isActive) => {
            if (state.user.role !== 'admin') {
                alert('×¨×§ ××“××™×Ÿ ×™×›×•×œ ×œ×”×©×”×•×ª ××©×ª××©×™×.');
                return;
            }
            const newStatus = isActive ? false : true; // ×× ×¤×¢×™×œ ×›×¨×’×¢, ×”×¤×•×š ×œ×œ× ×¤×¢×™×œ (false)
            const actionText = newStatus ? '×”×¤×¢×œ×” ××—×“×©' : '×”×©×”×™×”';
            if (!confirm(`×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ×‘×¦×¢ ${actionText} ×œ××©×ª××© ${userName}?`)) return;
            try {
                await db.collection('users').doc(userId).update({ isActive: newStatus });
                const userToUpdate = state.users.find(u => u.id === userId);
                if (userToUpdate) {
                    userToUpdate.isActive = newStatus;
                    alert(`${actionText} ×‘×•×¦×¢×” ×‘×”×¦×œ×—×” ×œ××©×ª××© ${userName}.`);
                }
                render();
            } catch (error) {
                console.error("×©×’×™××” ×‘×”×©×”×™×™×ª/×”×¤×¢×œ×ª ××©×ª××©:", error);
                alert("×©×’×™××” ×‘×”×©×”×™×™×ª/×”×¤×¢×œ×ª ××©×ª××©. ×‘×“×•×§ ××ª ×”×—×™×‘×•×¨ ×•×›×œ×œ×™ ×”××‘×˜×—×”.");
            }
        };


        // --- 4. ×¤×•× ×§×¦×™×•×ª ×¢×–×¨ ×œ-UI ×•×œ×–××Ÿ ---

        /**
         * ×¤×•× ×§×¦×™×™×ª ×¢×–×¨ ×œ×”×¦×’×ª ×–××Ÿ ×©×¢×‘×¨
         */
        function timeSince(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            let interval = seconds / 31536000;
            if (interval > 1) return Math.floor(interval) + " ×©× ×™×";
            interval = seconds / 2592000;
            if (interval > 1) return Math.floor(interval) + " ×—×•×“×©×™×";
            interval = seconds / 86400;
            if (interval > 1) return Math.floor(interval) + " ×™××™×";
            interval = seconds / 3600;
            if (interval > 1) return Math.floor(interval) + " ×©×¢×•×ª";
            interval = seconds / 60;
            if (interval > 1) return Math.floor(interval) + " ×“×§×•×ª";
            return "×”×¨×’×¢";
        }


        // --- 5. ×¨×›×™×‘×™ UI (Render Functions) ---

        /**
         * ×¨×›×™×‘ Header ×¢×œ×™×•×Ÿ
         */
        const getHeader = () => {
            if (!state.user) return '';
            const isCurrent = (screenName) => state.screen === screenName ? 'bg-white text-kesher-primary' : 'hover:bg-kesher-primary/80';
            const totalUnread = Object.values(state.unreadCounts).reduce((sum, count) => sum + count, 0);
            
            return `
                <header class="fixed top-0 left-0 right-0 bg-kesher-primary text-white shadow-lg z-50">
                    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                        <div class="flex items-center justify-between h-16">
                            <div class="flex items-center">
                                <span class="text-2xl font-bold">×§×”×™×œ×ª ×§×©×¨ <i class="fa-solid fa-seedling"></i></span>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="goTo('home')" class="px-3 py-2 rounded-lg font-medium transition ${isCurrent('home')}">
                                    <i class="fa-solid fa-house"></i> ×‘×™×ª
                                </button>
                                <button onclick="goTo('users')" class="relative px-3 py-2 rounded-lg font-medium transition ${isCurrent('users') || isCurrent('chat')}">
                                    <i class="fa-solid fa-user-group"></i> ×¦'××˜/×—×‘×¨×™×
                                    ${totalUnread > 0 ? `<span class="absolute top-0 right-0 inline-flex items-center justify-center px-2 py-1 text-xs font-bold leading-none text-white transform translate-x-1/2 -translate-y-1/2 bg-kesher-accent rounded-full">${totalUnread}</span>` : ''}
                                </button>
                                <button onclick="goTo('forums')" class="px-3 py-2 rounded-lg font-medium transition ${isCurrent('forums') || isCurrent('forumPosts') || isCurrent('newPost') || isCurrent('postDetails')}">
                                    <i class="fa-solid fa-comments"></i> ×¤×•×¨×•××™×
                                </button>
                                <button onclick="goTo('activities')" class="px-3 py-2 rounded-lg font-medium transition ${isCurrent('activities') || isCurrent('newActivity')}">
                                    <i class="fa-solid fa-calendar-check"></i> ×¤×¢×™×œ×•×™×•×ª
                                </button>
                                ${state.user.role === 'admin' ? `
                                    <button onclick="goTo('admin')" class="px-3 py-2 rounded-lg font-medium transition ${isCurrent('admin')}">
                                        <i class="fa-solid fa-shield-halved"></i> × ×™×”×•×œ
                                    </button>
                                ` : ''}
                            </div>
                            <div>
                                <button onclick="doLogout()" class="bg-white text-kesher-primary hover:bg-gray-100 px-3 py-1 rounded-lg font-semibold transition shadow">
                                    <i class="fa-solid fa-sign-out-alt ml-1"></i> ×™×¦×™××”
                                </button>
                            </div>
                        </div>
                    </div>
                </header>
            `;
        };

        const renderLoading = () => {
            return `<div class="flex justify-center items-center min-h-screen">
                        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-kesher-primary"></div>
                        <p class="text-kesher-primary text-lg mr-4">×˜×•×¢×Ÿ × ×ª×•× ×™×...</p>
                    </div>`;
        };
        
        const renderLogin = () => {
             return `
                <div class="flex items-center justify-center min-h-screen bg-gray-100 p-4 pt-16">
                    <div class="w-full max-w-md bg-white p-8 rounded-2xl shadow-2xl">
                        <h2 class="text-4xl font-extrabold text-center text-kesher-primary mb-8">×›× ×™×¡×” ×œ×§×”×™×œ×”</h2>
                        <form onsubmit="event.preventDefault(); doLogin()" class="space-y-6">
                            <div>
                                <label for="email" class="block text-sm font-medium text-gray-700">×“×•×"×œ</label>
                                <input type="email" id="email" class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm" required>
                            </div>
                            <div>
                                <label for="pwd" class="block text-sm font-medium text-gray-700">×¡×™×¡××”</label>
                                <input type="password" id="pwd" class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm" required>
                            </div>
                            <p id="loginError" class="text-red-500 text-center font-medium"></p>
                            <button type="submit" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-lg font-bold text-white bg-kesher-primary hover:bg-kesher-primary focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-kesher-primary transition">
                                <i class="fa-solid fa-sign-in-alt ml-2"></i> ×›× ×™×¡×”
                            </button>
                        </form>
                        <div class="mt-6 text-center">
                            <p class="text-sm text-gray-600">
                                ××™×Ÿ ×œ×š ×—×©×‘×•×Ÿ? <button onclick="goTo('register')" class="font-medium text-kesher-secondary hover:text-teal-700 transition">×”×™×¨×©× ×›××Ÿ</button>
                            </p>
                        </div>
                        <div class="mt-6 text-xs text-gray-400 text-center border-t pt-4">
                        ×œ×¦×•×¨×š ×‘×“×™×§×”: <br>
                        ××“××™×Ÿ: **orit@example.com** / **123456** (×× ×”× ×ª×•× ×™× ×”×¤×™×§×˜×™×‘×™×™× × ×˜×¢× ×•)
                        </div>
                    </div>
                </div>
            `;
        };

        const renderRegister = () => {
             return `
                <div class="flex items-center justify-center min-h-screen bg-gray-100 p-4 pt-16">
                    <div class="w-full max-w-md bg-white p-8 rounded-2xl shadow-2xl">
                        <h2 class="text-4xl font-extrabold text-center text-kesher-primary mb-8">×”×¨×©××” ×œ×§×”×™×œ×”</h2>
                        <form onsubmit="event.preventDefault(); doRegister()" class="space-y-6">
                            <div>
                                <label for="regName" class="block text-sm font-medium text-gray-700">×©× ××œ×</label>
                                <input type="text" id="regName" class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm" required>
                            </div>
                            <div>
                                <label for="regEmail" class="block text-sm font-medium text-gray-700">×“×•×"×œ</label>
                                <input type="email" id="regEmail" class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm" required>
                            </div>
                            <div>
                                <label for="regPwd" class="block text-sm font-medium text-gray-700">×¡×™×¡××” (6 ×ª×•×•×™× ×œ×¤×—×•×ª)</label>
                                <input type="password" id="regPwd" class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm" required>
                            </div>
                            <div>
                                <label for="regCity" class="block text-sm font-medium text-gray-700">×¢×™×¨ ××’×•×¨×™×</label>
                                <input type="text" id="regCity" class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm" required>
                            </div>
                            <div>
                                <label for="regHobbies" class="block text-sm font-medium text-gray-700">×ª×—×‘×™×‘×™× (××•×¤×¨×“×™× ×‘×¤×¡×™×§)</label>
                                <input type="text" id="regHobbies" class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm" placeholder="×œ××©×œ: ×¦×™×œ×•×, ×‘×™×©×•×œ, ×©×—××˜" required>
                            </div>
                            <div>
                                <label for="regContributions" class="block text-sm font-medium text-gray-700">×ª×—×•××™× ×‘×”× ×× ×™ ×™×›×•×œ/×” ×œ×ª×¨×•× (××•×¤×¨×“×™× ×‘×¤×¡×™×§)</label>
                                <input type="text" id="regContributions" class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm" placeholder="×œ××©×œ: ×™×™×¢×•×¥ ×›×œ×›×œ×™, ×¢×–×¨×” ×˜×›× ×™×ª" required>
                            </div>
                            <p id="registerError" class="text-red-500 text-center font-medium"></p>
                            <button type="submit" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-lg font-bold text-white bg-kesher-secondary hover:bg-kesher-secondary focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-kesher-secondary transition">
                                <i class="fa-solid fa-user-plus ml-2"></i> ×”×™×¨×©×
                            </button>
                        </form>
                        <div class="mt-6 text-center">
                            <p class="text-sm text-gray-600">
                                ×›×‘×¨ ×™×© ×œ×š ×—×©×‘×•×Ÿ? <button onclick="goTo('login')" class="font-medium text-kesher-primary hover:text-red-700 transition">×”×™×›× ×¡ ×›××Ÿ</button>
                            </p>
                        </div>
                    </div>
                </div>
            `;
        };

        const renderHome = () => {
            const onlineUsers = state.users.filter(u => u.isOnline && u.id !== state.user.id);
            const recommendation = getDailyRecommendation();
            return `
                ${getHeader()}
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-8">
                    <h1 class="text-4xl font-extrabold text-kesher-primary mb-8">
                        ×©×œ×•×, ${state.user.name}! ğŸ‘‹
                    </h1>

                    <div class="bg-kesher-accent/20 p-5 rounded-2xl shadow-md mb-8 flex items-center gap-4 border-r-8 border-kesher-accent">
                        <i class="fa-solid fa-lightbulb text-kesher-accent text-3xl shrink-0"></i>
                        <div>
                            <p class="text-lg font-semibold text-gray-800">×”××œ×¦×ª ×”×™×•×:</p>
                            <p class="text-gray-700">${recommendation}</p>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="bg-kesher-primary text-white p-6 rounded-2xl shadow-xl lg:col-span-1 flex flex-col justify-between">
                            <h3 class="text-2xl font-bold mb-2"><i class="fa-solid fa-star"></i> ×”× ×™×§×•×“ ×©×œ×™</h3>
                            <p class="text-5xl font-extrabold mb-4">${state.user.points || 0}</p>
                            <p class="text-sm">×¦×‘×•×¨ × ×§×•×“×•×ª ×¢×œ ×™×“×™ ×ª×’×•×‘×•×ª ×•×¢×–×¨×” ×œ××—×¨×™×.</p>
                        </div>

                        <div class="bg-white p-6 rounded-2xl shadow-xl lg:col-span-2">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-xl font-bold text-kesher-primary"><i class="fa-solid fa-user-group"></i> ×—×‘×¨×™× ××—×•×‘×¨×™× ( ${onlineUsers.length} )</h3>
                                <button onclick="goTo('users')" class="text-kesher-primary hover:text-red-700 text-sm font-medium">×”×¦×’ ××ª ×›×œ ×”×—×‘×¨×™× <i class="fa-solid fa-arrow-right"></i></button>
                            </div>
                            <div class="space-y-3 max-h-48 overflow-y-auto">
                                ${onlineUsers.length > 0 ? onlineUsers.slice(0, 5).map(u => `
                                    <button onclick="openChat({ id: '${u.id}', name: '${u.name}' })" class="flex items-center gap-2 p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100 transition w-full text-right">
                                        <div class="w-2 h-2 bg-kesher-secondary rounded-full shrink-0"></div>
                                        <span class="text-sm font-medium">${u.name} (${u.city})</span>
                                    </button>
                                `).join('') : '<p class="text-gray-500 text-center mt-4">××£ ××—×“ ×œ× ××—×•×‘×¨ ×›×¨×’×¢. ğŸ˜´</p>'}
                            </div>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-2xl shadow-xl mt-6">
                         <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold text-kesher-secondary"><i class="fa-solid fa-calendar-alt"></i> ×”×¤×¢×™×œ×•×™×•×ª ×”×§×¨×•×‘×•×ª</h3>
                            <button onclick="goTo('activities')" class="text-kesher-secondary hover:text-teal-700 text-sm font-medium">×”×¦×’ ××ª ×›×œ ×”×¤×¢×™×œ×•×™×•×ª <i class="fa-solid fa-arrow-right"></i></button>
                        </div>
                        <div class="space-y-4">
                            ${state.activities.length > 0 ? state.activities.slice(0, 3).map(a => `
                                <div class="p-3 border-b last:border-b-0">
                                    <h4 class="font-semibold text-gray-800">${a.title}</h4>
                                    <p class="text-sm text-gray-600">
                                        <i class="fa-solid fa-calendar-day"></i> ${a.date.toLocaleDateString('he-IL')} 
                                        <span class="mr-2 ml-2">|</span> 
                                        <i class="fa-solid fa-map-marker-alt"></i> ${a.location}
                                    </p>
                                </div>
                            `).join('') : '<p class="text-gray-500 text-center mt-4">××™×Ÿ ×¤×¢×™×œ×•×™×•×ª ×§×¨×•×‘×•×ª ××ª×•×›× × ×•×ª.</p>'}
                        </div>
                    </div>
                </div>
            `;
        };

        const renderUsers = () => {
            const allCities = [...new Set(state.users.map(u => u.city))].sort();
            const allHobbies = [...new Set(state.users.flatMap(u => u.hobbies))].filter(h => h).sort();

            const filteredUsers = state.users.filter(u => {
                if (state.usersFilter.city && u.city !== state.usersFilter.city) return false;
                if (state.usersFilter.role && u.role !== state.usersFilter.role) return false;
                if (state.usersFilter.hobby) {
                    return u.hobbies?.includes(state.usersFilter.hobby);
                }
                return true;
            });

            return `
                ${getHeader()}
                <div class="max-w-6xl mx-auto px-4 mt-8">
                    <h2 class="text-3xl font-bold text-kesher-secondary mb-6"><i class="fa-solid fa-user-group"></i> ×—×‘×¨×™× ×‘×§×”×™×œ×” (${filteredUsers.length} × ××¦××•)</h2>
                    
                    <div class="bg-white p-4 rounded-xl shadow-md mb-6 flex flex-wrap gap-4 items-center">
                        <span class="font-medium text-gray-700">×¡×™× ×•×Ÿ:</span>
                        
                        <select onchange="state.usersFilter.city = this.value; render()" class="p-2 border rounded-lg">
                            <option value="">×›×œ ×”×¢×¨×™×</option>
                            ${allCities.map(c => `<option value="${c}" ${state.usersFilter.city === c ? 'selected' : ''}>${c}</option>`).join('')}
                        </select>
                        
                        <select onchange="state.usersFilter.role = this.value; render()" class="p-2 border rounded-lg">
                            <option value="">×›×œ ×”×ª×¤×§×™×“×™×</option>
                            <option value="user" ${state.usersFilter.role === 'user' ? 'selected' : ''}>××©×ª××© ×¨×’×™×œ</option>
                            <option value="senior" ${state.usersFilter.role === 'senior' ? 'selected' : ''}>××©×ª××© ×‘×›×™×¨</option>
                            <option value="admin" ${state.usersFilter.role === 'admin' ? 'selected' : ''}>×× ×”×œ</option>
                        </select>

                        <select onchange="state.usersFilter.hobby = this.value; render()" class="p-2 border rounded-lg">
                            <option value="">×›×œ ×”×ª×—×‘×™×‘×™×</option>
                            ${allHobbies.map(h => `<option value="${h}" ${state.usersFilter.hobby === h ? 'selected' : ''}>${h}</option>`).join('')}
                        </select>
                    </div>

                    <div class="space-y-4" id="usersList">
                        ${filteredUsers.map(u => {
                            if (u.id === state.user.id) return ''; // ××œ ×ª×¦×™×’ ××ª ×”××©×ª××© ×”× ×•×›×—×™ ×‘×¨×©×™××”
                            const chatRoomId = getChatRoomId(state.user.id, u.id);
                            const unreadCount = state.unreadCounts[chatRoomId] || 0;

                            return `
                                <div class="bg-white p-4 rounded-xl shadow-md flex justify-between items-center hover:bg-gray-50 transition ${u.isActive === false ? 'opacity-50' : ''}">
                                    <div class="flex items-center gap-4">
                                        <div class="w-10 h-10 ${u.isOnline ? 'bg-kesher-secondary' : 'bg-gray-400'} rounded-full flex items-center justify-center text-white font-bold text-lg shrink-0" title="${u.isOnline ? '××—×•×‘×¨' : '×× ×•×ª×§'}">
                                            ${u.name[0]}
                                        </div>
                                        <div>
                                            <h3 class="text-lg font-bold text-gray-800">${u.name} ${u.isActive === false ? '<span class="text-red-500 font-bold">(××•×©×”×”)</span>' : ''}</h3>
                                            <p class="text-sm text-gray-600">
                                                <i class="fa-solid fa-location-dot"></i> ${u.city} | 
                                                <i class="fa-solid fa-briefcase"></i> ${u.role === 'admin' ? '×× ×”×œ' : u.role === 'senior' ? '×‘×›×™×¨' : '×—×‘×¨'}
                                            </p>
                                            <p class="text-xs text-gray-500 mt-1">
                                                ×ª×—×‘×™×‘×™×: ${u.hobbies?.join(', ') || '××™×Ÿ'}
                                            </p>
                                        </div>
                                    </div>
                                    <div class="flex items-center gap-3">
                                        ${unreadCount > 0 ? `<span class="inline-flex items-center justify-center px-3 py-1 text-sm font-bold leading-none text-white bg-kesher-accent rounded-full">${unreadCount}</span>` : ''}
                                        
                                        <button onclick="openChat({ id: '${u.id}', name: '${u.name}' })" class="bg-kesher-primary hover:bg-red-700 text-white px-4 py-2 rounded-lg font-medium transition text-sm">
                                            <i class="fa-solid fa-paper-plane ml-1"></i> ×©×œ×— ×”×•×“×¢×”
                                        </button>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        };
        
        const renderChat = () => {
            if (!state.selectedUser) {
                // ×§×•×¨×” ×× ××©×ª××© × ×•×•×˜ ×™×©×™×¨×•×ª ×œ-chat
                goTo('users');
                return '';
            }

            const targetUser = state.selectedUser;
            
            return `
                ${getHeader()}
                <div class="max-w-3xl mx-auto px-4 mt-8 flex flex-col h-[calc(100vh-8rem)]">
                    <div class="bg-white p-4 rounded-xl shadow-lg flex justify-between items-center mb-4 sticky top-16 z-10">
                        <h2 class="text-2xl font-bold text-kesher-secondary">×¦'××˜ ×¢× ${targetUser.name}</h2>
                        <button onclick="goTo('users')" class="bg-red-600 hover:bg-red-700 px-3 py-1 rounded transition text-sm text-white">×—×–×¨×” ×œ×—×‘×¨×™×</button>
                    </div>

                    <div id="chatBox" class="flex-grow p-4 overflow-y-auto space-y-3 bg-gray-100 rounded-xl shadow-inner">
                        ${state.chatMessages.map(msg => {
                            const isMe = msg.senderId === state.user.id;
                            
                            // ×œ×•×’×™×§×” ×—×–×§×” ×™×•×ª×¨ ×œ×”×¦×’×ª ×–××Ÿ:
                            let time = '×¢×›×©×™×•';
                            let isError = false;

                            if (msg.content.includes('×©×’×™××ª ×—×™×‘×•×¨!')) {
                                isError = true;
                            } else if (msg.timestamp && typeof msg.timestamp.toDate === 'function') {
                                try {
                                    time = new Date(msg.timestamp.toDate()).toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit' });
                                } catch (e) {
                                    console.error("×©×’×™××” ×‘×”××¨×ª ×–××Ÿ:", e);
                                    time = '×–××Ÿ ×œ× ×ª×§×™×Ÿ';
                                }
                            }
                            
                            // ×”×•×¡×¤×ª ×¡×™××Ÿ ×§×¨×™××” ×§×˜×Ÿ ×œ×–××Ÿ ×× ×™×© ×©×’×™××” ×§×¨×™×˜×™×ª
                            const timeDisplay = isError ? 'âš ï¸' : time; 
                            
                            return `
                                <div class="flex ${isMe ? 'justify-end' : 'justify-start'}">
                                    <div class="${isError ? 'bg-red-100 border border-red-400 text-red-800' : isMe ? 'bg-kesher-secondary text-white rounded-tr-none' : 'bg-gray-200 text-gray-800 rounded-tl-none'} max-w-xs p-3 rounded-xl shadow-md">
                                        <p class="text-sm">${msg.content}</p>
                                        <div class="text-xs mt-1 flex justify-between items-center">
                                            <span class="${isError ? 'text-red-500' : isMe ? 'text-teal-200' : 'text-gray-500'}">${timeDisplay}</span>
                                            ${!isMe && !isError ? `<button onclick="reportItem('${msg.id}', 'message', '${msg.senderId}')" class="text-red-400 hover:text-red-600 mr-2"><i class="fa-solid fa-flag"></i> ×“×•×•×—</button>` : ''}
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>

                    <div class="mt-4 flex gap-2 shrink-0">
                        <input type="text" id="chatInput" placeholder="×”×§×œ×“ ×”×•×“×¢×”..." class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-kesher-secondary" onkeydown="if(event.key === 'Enter') sendMessage()">
                        <button onclick="sendMessage()" class="bg-kesher-primary hover:bg-red-700 text-white px-5 py-3 rounded-lg font-bold transition">
                            <i class="fa-solid fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            `;
        };
        
        const renderForums = () => {
            return `
                ${getHeader()}
                <div class="max-w-5xl mx-auto px-4 mt-8">
                    <h2 class="text-3xl font-bold text-kesher-primary mb-6"><i class="fa-solid fa-comments"></i> ×¤×•×¨×•××™× ×•×“×™×•× ×™×</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        ${state.forums.map(f => `
                            <div onclick="goTo('forumPosts', { forumId: '${f.id}' })" class="bg-white p-6 rounded-2xl shadow-xl border-r-8 border-kesher-secondary hover:shadow-2xl transition cursor-pointer">
                                <div class="flex items-center gap-4 mb-3">
                                    <span class="text-4xl text-kesher-secondary">${f.icon}</span>
                                    <h3 class="text-2xl font-bold text-gray-800">${f.title}</h3>
                                </div>
                                <p class="text-gray-600">${f.description}</p>
                                <div class="mt-4 text-sm text-gray-500">
                                    ${f.posts.length} ×¤×•×¡×˜×™×
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        };

        const renderForumPosts = () => {
            const forum = state.forums.find(f => f.id === state.currentForumId);
            if (!forum) { goTo('forums'); return ''; }

            const sortedPosts = (forum.posts || []).sort((a, b) => b.createdAt.toDate() - a.createdAt.toDate());

            return `
                ${getHeader()}
                <div class="max-w-4xl mx-auto px-4 mt-8">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-3xl font-bold text-kesher-secondary">${forum.icon} ${forum.title}</h2>
                        <button onclick="alert('×™×¦×™×¨×ª ×¤×•×¡×˜...')" class="bg-kesher-primary hover:bg-red-700 text-white px-4 py-2 rounded-lg font-medium transition"><i class="fa-solid fa-plus"></i> ×¤×ª×— ×“×™×•×Ÿ ×—×“×©</button>
                    </div>

                    <div class="space-y-4">
                        ${sortedPosts.length > 0 ? sortedPosts.map(p => `
                            <div onclick="goTo('postDetails', { postId: '${p.id}' })" class="bg-white p-5 rounded-xl shadow-md hover:shadow-lg transition cursor-pointer border-r-4 border-kesher-primary">
                                <h3 class="text-xl font-bold text-gray-800 mb-1">${p.title}</h3>
                                <p class="text-sm text-gray-600 mb-3">${p.content.substring(0, 100)}...</p>
                                <div class="flex justify-between items-center text-sm">
                                    <p class="text-gray-500">×¢×œ ×™×“×™: ${p.creatorName} | ×œ×¤× ×™: ${timeSince(p.createdAt.toDate())}</p>
                                    <div class="flex gap-4 text-gray-500">
                                        <span><i class="fa-solid fa-heart"></i> ${p.likes?.length || 0}</span>
                                        <span><i class="fa-solid fa-comment-dots"></i> ${p.replies?.length || 0}</span>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        };

        const renderPostDetails = () => {
            const post = state.currentPost;
            if (!post) { goTo('forums'); return ''; }
            const forum = state.forums.find(f => f.id === state.currentForumId);

            const isLiked = post.likes?.includes(state.user.id);
            const likeIcon = isLiked ? '<i class="fa-solid fa-heart"></i>' : '<i class="fa-regular fa-heart"></i>';
            const likeColor = isLiked ? 'text-white bg-kesher-primary hover:bg-red-700' : 'text-kesher-primary bg-white border border-kesher-primary hover:bg-gray-100';
            const canDelete = state.user.role === 'admin' || state.user.role === 'senior' || post.creatorId === state.user.id;
            const canDeleteReply = state.user.role === 'admin' || state.user.role === 'senior';

            return `
                ${getHeader()}
                <div class="max-w-4xl mx-auto px-4 mt-8">
                    <button onclick="goTo('forumPosts', { forumId: state.currentForumId })" class="text-kesher-secondary hover:text-teal-700 font-medium mb-4 flex items-center gap-1">
                        <i class="fa-solid fa-arrow-right-from-bracket rotate-180"></i> ×—×–×¨×” ×œ×¤×•×¨×•× ${forum.title}
                    </button>

                    <div class="bg-white p-6 rounded-2xl shadow-xl mb-6">
                        <h1 class="text-3xl font-extrabold text-gray-800 mb-2">${post.title}</h1>
                        <p class="text-sm text-gray-500 mb-4">
                            ×¤×•×¨×¡× ×¢×œ ×™×“×™: **${post.creatorName}** | ×œ×¤× ×™: ${timeSince(post.createdAt.toDate())}
                        </p>
                        <hr class="mb-4">
                        <p class="text-lg text-gray-700 leading-relaxed whitespace-pre-wrap">${post.content}</p>

                        <div class="mt-6 flex justify-between items-center border-t pt-4">
                            <div class="flex gap-3 items-center">
                                <button onclick="toggleLike('${post.id}')" class="flex items-center gap-2 px-4 py-2 rounded-full font-semibold transition shadow-md ${likeColor}">
                                    ${likeIcon} ${post.likes?.length || 0}
                                </button>
                                ${canDelete ? `
                                    <button onclick="deletePost('${post.id}')" class="text-red-500 hover:text-red-700 text-lg ml-3">
                                        <i class="fa-solid fa-trash-alt"></i> ××—×§
                                    </button>
                                ` : ''}
                            </div>
                            <button onclick="reportItem('${post.id}', 'post', '${post.creatorId}')" class="text-red-400 hover:text-red-600 text-sm">
                                <i class="fa-solid fa-flag ml-1"></i> ×“×•×•×— ×¢×œ ×¤×•×¡×˜
                            </button>
                        </div>
                    </div>

                    <h2 class="text-2xl font-bold text-kesher-primary mb-4"><i class="fa-solid fa-comment-dots"></i> ×ª×’×•×‘×•×ª (${state.currentPostReplies.length})</h2>
                    <div class="bg-white p-4 rounded-xl shadow-md space-y-4 mb-6">
                        ${state.currentPostReplies.length > 0 ? state.currentPostReplies.map(reply => `
                            <div class="border-b pb-3 last:border-b-0">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <p class="font-semibold text-gray-800">${reply.creatorName}</p>
                                        <p class="text-sm text-gray-600 leading-snug">${reply.content}</p>
                                    </div>
                                    <p class="text-xs text-gray-500 shrink-0 mr-4">
                                        ${timeSince(reply.createdAt.toDate())}
                                        ${canDeleteReply ? `
                                            <button onclick="alert('××—×§ ×ª×’×•×‘×” ${reply.id}')" class="text-red-400 hover:text-red-600 mr-2"><i class="fa-solid fa-trash-alt"></i></button>
                                        ` : ''}
                                    </p>
                                </div>
                            </div>
                        `).join('') : '<p class="text-gray-500 text-center py-4">×˜×¨× × ×›×ª×‘×• ×ª×’×•×‘×•×ª.</p>'}
                    </div>

                    <div class="bg-white p-4 rounded-xl shadow-md">
                        <h3 class="text-xl font-bold text-kesher-secondary mb-3">×”×•×¡×£ ×ª×’×•×‘×”</h3>
                        <textarea id="replyInput" class="w-full p-3 border border-gray-300 rounded-lg" rows="3" placeholder="×›×ª×•×‘ ××ª ×”×ª×’×•×‘×” ×©×œ×š..."></textarea>
                        <button onclick="addReply()" class="bg-kesher-secondary hover:bg-teal-700 text-white px-4 py-2 rounded-lg font-medium mt-3 transition">
                            ×©×œ×— ×ª×’×•×‘×”
                        </button>
                    </div>
                </div>
            `;
        };

        const renderActivities = () => {
            const upcomingActivities = (state.activities || []).sort((a, b) => a.date - b.date).filter(a => a.date >= new Date());
            const canDeleteActivity = state.user.role === 'admin' || state.user.role === 'senior';
            
            return `
                ${getHeader()}
                <div class="max-w-6xl mx-auto px-4 mt-8">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-3xl font-bold text-kesher-primary"><i class="fa-solid fa-calendar-check"></i> ×¤×¢×™×œ×•×™×•×ª ×§×”×™×œ×ª×™×•×ª</h2>
                        ${state.user.role === 'admin' || state.user.role === 'senior' ? `
                            <button onclick="createActivity()" class="bg-kesher-secondary hover:bg-teal-700 text-white px-4 py-2 rounded-lg font-medium transition"><i class="fa-solid fa-plus"></i> ×”×¦×¢ ×¤×¢×™×œ×•×ª</button>
                        ` : ''}
                    </div>

                    <div class="space-y-4">
                        ${upcomingActivities.length > 0 ? upcomingActivities.map(a => {
                            const isRegistered = a.attendees.includes(state.user.id);
                            const actionButton = isRegistered ? 
                                `<span class="text-sm font-semibold px-3 py-1 rounded-full bg-kesher-secondary text-white">×¨×©×•×</span>` : 
                                `<button onclick="registerForActivity('${a.id}')" class="bg-kesher-primary hover:bg-red-700 text-white px-4 py-2 rounded-lg transition text-sm">×”×¨×©×</button>`;
                            
                            return `
                                <div class="bg-white p-6 rounded-xl shadow-md hover:shadow-lg transition flex flex-col md:flex-row justify-between items-start md:items-center">
                                    <div class="mb-4 md:mb-0">
                                        <h3 class="text-2xl font-bold text-gray-800">${a.title}</h3>
                                        <p class="text-gray-600 mb-2">${a.description}</p>
                                        <p class="text-sm text-gray-500">
                                            <i class="fa-solid fa-calendar-day ml-1"></i> **${a.date.toLocaleDateString('he-IL')}** <span class="mr-2 ml-2">|</span> 
                                            <i class="fa-solid fa-map-marker-alt ml-1"></i> ${a.location}
                                            <span class="mr-2 ml-2">|</span> 
                                            <i class="fa-solid fa-user ml-1"></i> ${a.attendees.length} ××©×ª×ª×¤×™×
                                        </p>
                                    </div>
                                    <div class="flex flex-col items-end gap-2 shrink-0">
                                        ${actionButton}
                                        ${canDeleteActivity ? `
                                            <button onclick="alert('××—×§ ×¤×¢×™×œ×•×ª ${a.id}')" class="text-red-400 hover:text-red-600 text-sm">
                                                <i class="fa-solid fa-trash-alt ml-1"></i> ××—×§
                                            </button>
                                        ` : ''}
                                    </div>
                                </div>
                            `;
                        }).join('') : '<p class="text-center text-gray-500 p-8 bg-white rounded-xl shadow-md">××™×Ÿ ×¤×¢×™×œ×•×™×•×ª ×§×¨×•×‘×•×ª ××ª×•×›× × ×•×ª.</p>'}
                    </div>
                </div>
            `;
        };
        
        const renderAdmin = () => {
            if (state.user.role !== 'admin') {
                goTo('home');
                return '';
            }

            return `
                ${getHeader()}
                <div class="max-w-7xl mx-auto px-4 mt-8">
                    <h2 class="text-3xl font-bold text-red-600 mb-8"><i class="fa-solid fa-shield-halved"></i> ×œ×•×— ×‘×§×¨×” ×œ×× ×”×œ×™×</h2>

                    <div class="bg-white p-6 rounded-2xl shadow-xl mb-8">
                        <h3 class="text-2xl font-bold text-kesher-primary mb-4">× ×™×”×•×œ ××©×ª××©×™×</h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">×©×</th>
                                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">×¢×™×¨</th>
                                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">×“×¨×’×” × ×•×›×—×™×ª</th>
                                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">×©× ×” ×“×¨×’×”</th>
                                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">×¤×¢×•×œ×•×ª</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    ${(state.users || []).map(u => `
                                        <tr>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                                ${u.name} ${u.id === state.user.id ? '(×× ×™)' : ''} ${u.isActive === false ? ' <span class="text-red-500 font-bold">(××•×©×”×”)</span>' : ''}
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${u.city}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold">
                                                <span class="${u.role === 'admin' ? 'text-red-600' : u.role === 'senior' ? 'text-kesher-secondary' : 'text-gray-500'}">${u.role}</span>
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                                ${u.id === state.user.id ? '××™×Ÿ ×©×™× ×•×™' : `
                                                    <select onchange="updateUserRole('${u.id}', this.value)" class="p-1 border rounded-lg">
                                                        <option value="user" ${u.role === 'user' ? 'selected' : ''}>User</option>
                                                        <option value="senior" ${u.role === 'senior' ? 'selected' : ''}>Senior</option>
                                                        <option value="admin" ${u.role === 'admin' ? 'selected' : ''}>Admin</option>
                                                    </select>
                                                `}
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium flex gap-2">
                                                ${u.id === state.user.id ? '' : `
                                                    <button onclick="toggleUserActive('${u.id}', '${u.name}', ${u.isActive})" class="${u.isActive ? 'text-orange-500 hover:text-orange-700' : 'text-kesher-secondary hover:text-teal-700'}">
                                                        ${u.isActive ? '<i class="fa-solid fa-pause ml-1"></i> ×”×©×”×”' : '<i class="fa-solid fa-check-circle ml-1"></i> ×”×¤×¢×œ'}
                                                    </button>
                                                    <button onclick="deleteUser('${u.id}', '${u.name}')" class="text-red-500 hover:text-red-700 mr-2">
                                                        <i class="fa-solid fa-user-times ml-1"></i> ××—×§
                                                    </button>
                                                `}
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-2xl shadow-xl">
                        <h3 class="text-2xl font-bold text-kesher-primary mb-4">×“×™×•×•×—×™× ( ${state.reports.length} )</h3>
                        <div class="space-y-4">
                            ${state.reports.length > 0 ? state.reports.map(r => `
                                <div class="p-4 border-r-4 ${r.status === '×—×“×©' ? 'border-red-500' : 'border-gray-400'} bg-gray-50 rounded-lg flex justify-between items-center">
                                    <div>
                                        <p class="font-semibold text-gray-800">×¤×¨×™×˜: ${r.itemType} (ID: ${r.itemId})</p>
                                        <p class="text-sm text-gray-600">×¡×™×‘×”: ${r.reason} | ×“×•×•×— ×¢×œ ×™×“×™: ${r.reporterName}</p>
                                        <p class="text-xs text-gray-500 mt-1">×¡×˜×˜×•×¡ × ×•×›×—×™: **${r.status}**</p>
                                    </div>
                                    <div class="flex gap-2 items-center">
                                        <select onchange="updateReportStatus('${r.id}', this.value)" class="p-1 border rounded-lg text-sm">
                                            <option value="×—×“×©" ${r.status === '×—×“×©' ? 'selected' : ''}>×—×“×©</option>
                                            <option value="×‘×˜×™×¤×•×œ" ${r.status === '×‘×˜×™×¤×•×œ' ? 'selected' : ''}>×‘×˜×™×¤×•×œ</option>
                                            <option value="×˜×•×¤×œ" ${r.status === '×˜×•×¤×œ' ? 'selected' : ''}>×˜×•×¤×œ</option>
                                            <option value="× ×“×—×”" ${r.status === '× ×“×—×”' ? 'selected' : ''}>× ×“×—×”</option>
                                        </select>
                                        <button onclick="alert('×‘×“×™×§×ª ×¤×¨×™×˜ ${r.itemId}')" class="text-kesher-secondary hover:text-teal-700">
                                            <i class="fa-solid fa-search"></i> ×‘×“×•×§
                                        </button>
                                    </div>
                                </div>
                            `).join('') : '<p class="text-gray-500 text-center py-4">××™×Ÿ ×“×™×•×•×—×™× ×¤×ª×•×—×™×.</p>'}
                        </div>
                    </div>

                </div>
            `;
        };

        // --- 6. ×× ×•×¢ ×¨×™× ×“×•×¨ ×•×˜×¢×™× ×” ×¨××©×•× ×™×ª ---

        function render() {
            let content = '';
            if (!state.user && state.screen !== 'register') {
                state.screen = 'login';
            }
            switch (state.screen) {
                case 'loading': content = renderLoading(); break; // ××¡×š ×˜×¢×™× ×”
                case 'login': content = renderLogin(); break;
                case 'register': content = renderRegister(); break;
                case 'home': content = renderHome(); break;
                case 'users': content = renderUsers(); break;
                case 'chat': content = renderChat(); break;
                case 'forums': content = renderForums(); break;
                case 'forumPosts': content = renderForumPosts(); break;
                case 'newPost': content = '<h1>×™×¦×™×¨×ª ×¤×•×¡×˜ ×—×“×© - ×œ× ×××•××©</h1>'; break;
                case 'postDetails': content = renderPostDetails(); break;
                case 'activities': content = renderActivities(); break;
                case 'newActivity': content = '<h1>×™×¦×™×¨×ª ×¤×¢×™×œ×•×ª ×—×“×©×” - ×œ× ×××•××©</h1>'; break;
                case 'admin': content = renderAdmin(); break;
                default: content = renderHome(); break;
            }
            document.getElementById('root').innerHTML = content;
        }

        /**
         * ×¤×•× ×§×¦×™×” ×¨××©×™×ª ×œ××ª×—×•×œ (× ×§×¨××ª ×¤×¢× ××—×ª)
         */
        async function initializeApp() {
            render(); // ×”×¦×’ ××¡×š ×˜×¢×™× ×”

            // ×”××–× ×” ×œ×©×™× ×•×™ ×¡×˜×˜×•×¡ ×”×ª×—×‘×¨×•×ª
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    // **×”××©×ª××© ××—×•×‘×¨**
                    try {
                        const userDoc = await db.collection('users').doc(user.uid).get();
                        if (userDoc.exists) {
                            const userData = userDoc.data();
                            
                            // ×‘×“×™×§×ª ×¡×˜×˜×•×¡ ×”×©×¢×™×”
                            if (userData.isActive === false) {
                                auth.signOut(); // × ×ª×§ ××©×ª××© ××•×©×”×”
                                return;
                            }
                            
                            state.user = { 
                                id: user.uid, 
                                email: user.email, 
                                name: userData.name, 
                                role: userData.role || 'user', 
                                points: userData.points || 0,
                                hobbies: userData.hobbies || [], 
                                contributions: userData.contributions || [],
                                isActive: userData.isActive !== false
                            };
                            
                            await fetchInitialData(); 
                            
                            // 3. × ×™×ª×•×‘ ×œ××¡×š ×”×‘×™×ª ×¨×§ ×× ×œ× ×”×™×ª×” ×©×’×™××” ×§×¨×™×˜×™×ª
                            if (state.screen === 'loading' || state.screen === 'login') {
                                goTo('home');
                            } else {
                                render(); // ×× ×”××©×ª××© ×›×‘×¨ ×‘××¡×š ×›×œ×©×”×• (×›××• ×¤×•×¨×•×), ×¨× ×“×¨ ××—×“×©
                            }
                        } else {
                            // ×”××©×ª××© ××—×•×‘×¨ ×‘-Auth ××‘×œ ×œ× ×§×™×™× ×‘××¡××š users (×›× ×¨××” × ××—×§)
                            console.error("×©×’×™××”: ××©×ª××© ×§×™×™× ×‘-Auth ××š ×—×¡×¨ ×‘-Firestore. ×—×–×¨×” ×œ×œ×•×’×™×Ÿ.");
                            auth.signOut();
                        }
                    } catch (error) {
                        console.error("×©×’×™××” ×§×¨×™×˜×™×ª ×‘××—×–×•×¨ ×¤×¨×•×¤×™×œ ××©×ª××© ××• × ×ª×•× ×™×:", error);
                         // ×× ×™×© ×©×’×™××” ×‘×—×™×‘×•×¨ ×œ-Firebase, ×× ×• ×—×•×–×¨×™× ×œ×œ×•×’×™×Ÿ
                        state.user = null;
                        state.screen = 'login';
                        render();
                        alert("×©×’×™××” ×§×¨×™×˜×™×ª ×‘××—×–×•×¨ × ×ª×•× ×™×. ×× × × ×¡×” ×œ×”×ª×—×‘×¨ ×©×•×‘.");
                    }
                } else {
                    // **×”××©×ª××© ×œ× ××—×•×‘×¨ ××• ×™×¦×**
                    state.user = null;
                    if (state.screen !== 'register') {
                        goTo('login');
                    } else {
                        render();
                    }
                }
            });
        }

        // ×”×¤×¢×œ×ª ×”××¤×œ×™×§×¦×™×”
        initializeApp(); 
    </script>
</body>
</html>
