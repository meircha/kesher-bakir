<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×§×©×¨ ×‘×›×™×¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>
<body class="bg-gradient-to-br from-green-50 to-blue-50 min-h-screen">
    <div id="root"></div>
    
    <script>
        // Firebase Init
        firebase.initializeApp({
            apiKey: "AIzaSyCrcxC420HW5PXGNd8M4KuclUkiJSwHreM",
            authDomain: "kesher-bakir.firebaseapp.com",
            projectId: "kesher-bakir",
            storageBucket: "kesher-bakir.firebasestorage.app",
            messagingSenderId: "671996189455",
            appId: "1:671996189455:web:d8ee089585a852ab38fc7a"
        });
        
        const auth = firebase.auth();
        const db = firebase.firestore();
        
        // State
        let state = {
            user: null,
            screen: 'login',
            users: [],
            forums: []
        };
        
        // Initialize Default Forums
        async function initForums() {
            const forumsSnap = await db.collection('forums').get();
            if (forumsSnap.empty) {
                const defaultForums = [
                    { title: '×¢×–×¨×” ×‘× ×•×©××™× ×˜×›× ×•×œ×•×’×™×™×', icon: 'ğŸ’»', description: '×©××œ×•×ª ×•×ª×©×•×‘×•×ª', posts: [] },
                    { title: '×©××™×¨×” ×¢×œ ×›×•×©×¨', icon: 'ğŸƒâ€â™‚ï¸', description: '×ª×¨×’×™×œ×™× ×•×˜×™×¤×™×', posts: [] },
                    { title: '××ª×›×•× ×™× ×•×‘×™×©×•×œ', icon: 'ğŸ³', description: '×©×™×ª×•×£ ××ª×›×•× ×™×', posts: [] },
                    { title: '×˜×™×•×œ×™× ×•×˜×‘×¢', icon: 'ğŸŒ„', description: '×”××œ×¦×•×ª ×˜×™×•×œ×™×', posts: [] }
                ];
                for (const forum of defaultForums) {
                    await db.collection('forums').add(forum);
                }
            }
        }
        
        // Load Data
        async function loadData() {
            const usersSnap = await db.collection('users').get();
            state.users = usersSnap.docs.map(d => ({id: d.id, ...d.data()}));
            
            const forumsSnap = await db.collection('forums').get();
            state.forums = forumsSnap.docs.map(d => ({id: d.id, ...d.data()}));
            
            render();
        }
        
        // Auth Listener
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                const doc = await db.collection('users').doc(user.uid).get();
                if (doc.exists) {
                    state.user = {id: user.uid, ...doc.data()};
                    state.screen = 'home';
                    await initForums();
                    await loadData();
                }
            } else {
                state.user = null;
                state.screen = 'login';
                render();
            }
        });
        
        // Functions
        async function doLogin() {
            const email = document.getElementById('email').value;
            const pwd = document.getElementById('pwd').value;
            try {
                await auth.signInWithEmailAndPassword(email, pwd);
            } catch(e) {
                alert('×©×’×™××”: ' + e.message);
            }
        }
        
        async function doRegister() {
            const name = document.getElementById('rName').value;
            const email = document.getElementById('rEmail').value;
            const pwd = document.getElementById('rPwd').value;
            const age = document.getElementById('rAge').value;
            const city = document.getElementById('rCity').value;
            
            if (!name || !email || !pwd || !age || !city) {
                alert('××œ× ××ª ×›×œ ×”×©×“×•×ª');
                return;
            }
            if (parseInt(age) < 60) {
                alert('×’×™×œ ××™× ×™××œ×™: 60');
                return;
            }
            
            try {
                const cred = await auth.createUserWithEmailAndPassword(email, pwd);
                await db.collection('users').doc(cred.user.uid).set({
                    name, email, age: parseInt(age), city,
                    role: 'user', points: 0,
                    joinDate: new Date().toISOString()
                });
                alert('âœ… × ×¨×©××ª ×‘×”×¦×œ×—×”!');
            } catch(e) {
                alert('×©×’×™××”: ' + e.message);
            }
        }
        
        async function doLogout() {
            await auth.signOut();
        }
        
        async function changeRole(userId, newRole) {
            await db.collection('users').doc(userId).update({role: newRole});
            alert('âœ… ×¢×•×“×›×Ÿ!');
            await loadData();
        }
        
        async function deleteUser(userId) {
            if (!confirm('×œ××—×•×§?')) return;
            await db.collection('users').doc(userId).delete();
            alert('âœ… × ××—×§');
            await loadData();
        }
        
        function goTo(screen) {
            state.screen = screen;
            render();
        }
        
        // Render
        function render() {
            const root = document.getElementById('root');
            
            if (state.screen === 'login') {
                root.innerHTML = `
                    <div class="min-h-screen flex items-center justify-center p-4">
                        <div class="bg-white rounded-2xl shadow-xl p-8 w-full max-w-md">
                            <h1 class="text-3xl font-bold text-center text-green-700 mb-8">×§×©×¨ ×‘×›×™×¨</h1>
                            <input id="email" type="email" placeholder="××™×™×œ" class="w-full p-3 border-2 rounded-lg mb-4" />
                            <input id="pwd" type="password" placeholder="×¡×™×¡××”" class="w-full p-3 border-2 rounded-lg mb-6" />
                            <button onclick="doLogin()" class="w-full bg-green-600 text-white p-3 rounded-lg font-bold mb-3">×›× ×™×¡×”</button>
                            <button onclick="goTo('register')" class="w-full bg-amber-200 text-amber-900 p-3 rounded-lg font-bold">×”×¨×©××”</button>
                        </div>
                    </div>
                `;
            }
            
            else if (state.screen === 'register') {
                root.innerHTML = `
                    <div class="min-h-screen flex items-center justify-center p-4">
                        <div class="bg-white rounded-2xl shadow-xl p-8 w-full max-w-md">
                            <h1 class="text-2xl font-bold text-center text-green-700 mb-6">×”×¨×©××”</h1>
                            <input id="rName" type="text" placeholder="×©× ××œ×" class="w-full p-3 border-2 rounded-lg mb-3" />
                            <input id="rEmail" type="email" placeholder="××™×™×œ" class="w-full p-3 border-2 rounded-lg mb-3" />
                            <input id="rPwd" type="password" placeholder="×¡×™×¡××” (6+ ×ª×•×•×™×)" class="w-full p-3 border-2 rounded-lg mb-3" />
                            <input id="rAge" type="number" placeholder="×’×™×œ (60+)" class="w-full p-3 border-2 rounded-lg mb-3" />
                            <input id="rCity" type="text" placeholder="×¢×™×¨" class="w-full p-3 border-2 rounded-lg mb-6" />
                            <button onclick="doRegister()" class="w-full bg-green-600 text-white p-3 rounded-lg font-bold mb-3">×”×¨×©××”</button>
                            <button onclick="goTo('login')" class="w-full bg-gray-300 p-3 rounded-lg font-bold">×‘×™×˜×•×œ</button>
                        </div>
                    </div>
                `;
            }
            
            else if (state.screen === 'home') {
                root.innerHTML = `
                    <header class="bg-white shadow p-4 mb-6">
                        <div class="max-w-6xl mx-auto flex justify-between items-center">
                            <h1 class="text-2xl font-bold text-green-700">×§×©×¨ ×‘×›×™×¨</h1>
                            <div class="flex gap-3 items-center">
                                <span class="font-medium">${state.user.name}</span>
                                ${state.user.role === 'admin' ? '<span class="bg-amber-200 px-3 py-1 rounded-full text-sm">×× ×”×œ</span>' : ''}
                                <button onclick="doLogout()" class="bg-red-500 text-white px-4 py-2 rounded-lg">×™×¦×™××”</button>
                            </div>
                        </div>
                    </header>
                    
                    <div class="max-w-6xl mx-auto px-4">
                        <nav class="bg-white rounded-xl shadow p-3 flex gap-3 mb-6 overflow-x-auto">
                            <button onclick="goTo('home')" class="px-4 py-2 bg-green-100 text-green-800 rounded-lg font-medium whitespace-nowrap">ğŸ  ×‘×™×ª</button>
                            <button onclick="goTo('forums')" class="px-4 py-2 hover:bg-gray-100 rounded-lg font-medium whitespace-nowrap">ğŸ’¬ ×¤×•×¨×•××™×</button>
                            ${state.user.role === 'admin' ? '<button onclick="goTo(\'admin\')" class="px-4 py-2 hover:bg-gray-100 rounded-lg font-medium whitespace-nowrap">âš™ï¸ × ×™×”×•×œ</button>' : ''}
                        </nav>
                        
                        <div class="bg-white p-8 rounded-xl shadow-lg text-center">
                            <h2 class="text-3xl font-bold text-green-700 mb-4">×‘×¨×•×š ×”×‘× ${state.user.name}!</h2>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-6">
                                <div class="bg-green-50 p-6 rounded-lg">
                                    <p class="text-4xl font-bold text-green-700">${state.users.length}</p>
                                    <p class="text-gray-600">××©×ª××©×™×</p>
                                </div>
                                <div class="bg-blue-50 p-6 rounded-lg">
                                    <p class="text-4xl font-bold text-blue-700">${state.forums.length}</p>
                                    <p class="text-gray-600">×¤×•×¨×•××™×</p>
                                </div>
                                <div class="bg-amber-50 p-6 rounded-lg">
                                    <p class="text-4xl font-bold text-amber-700">âœ…</p>
                                    <p class="text-gray-600">×”××¢×¨×›×ª ×¤×•×¢×œ×ª</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            else if (state.screen === 'forums') {
                root.innerHTML = `
                    <header class="bg-white shadow p-4 mb-6">
                        <div class="max-w-6xl mx-auto flex justify-between items-center">
                            <h1 class="text-2xl font-bold text-green-700">×¤×•×¨×•××™×</h1>
                            <button onclick="goTo('home')" class="bg-gray-500 text-white px-4 py-2 rounded-lg">â† ×—×–×¨×”</button>
                        </div>
                    </header>
                    
                    <div class="max-w-6xl mx-auto px-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            ${state.forums.map(f => `
                                <div class="bg-white p-6 rounded-xl shadow-lg hover:shadow-xl transition">
                                    <div class="flex items-center gap-4 mb-3">
                                        <span class="text-5xl">${f.icon}</span>
                                        <div>
                                            <h3 class="text-xl font-bold">${f.title}</h3>
                                            <p class="text-gray-600 text-sm">${f.description}</p>
                                        </div>
                                    </div>
                                    <p class="text-sm text-gray-500">${f.posts?.length || 0} ×¤×•×¡×˜×™×</p>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            else if (state.screen === 'admin' && state.user.role === 'admin') {
                root.innerHTML = `
                    <header class="bg-white shadow p-4 mb-6">
                        <div class="max-w-6xl mx-auto flex justify-between items-center">
                            <h1 class="text-2xl font-bold text-green-700">× ×™×”×•×œ ××¢×¨×›×ª</h1>
                            <button onclick="goTo('home')" class="bg-gray-500 text-white px-4 py-2 rounded-lg">â† ×—×–×¨×”</button>
                        </div>
                    </header>
                    
                    <div class="max-w-6xl mx-auto px-4">
                        <div class="bg-white p-6 rounded-xl shadow-lg">
                            <h3 class="text-xl font-bold mb-4">××©×ª××©×™× (${state.users.length})</h3>
                            <div class="space-y-3">
                                ${state.users.map(u => `
                                    <div class="flex justify-between items-center p-4 bg-gray-50 rounded-lg">
                                        <div>
                                            <p class="font-bold">${u.name}</p>
                                            <p class="text-sm text-gray-600">${u.email} â€¢ ${u.city}</p>
                                        </div>
                                        <div class="flex gap-2 items-center">
                                            <span class="px-3 py-1 rounded-full text-sm ${
                                                u.role === 'admin' ? 'bg-amber-200 text-amber-900' :
                                                u.role === 'senior' ? 'bg-purple-200 text-purple-900' :
                                                'bg-blue-200 text-blue-900'
                                            }">
                                                ${u.role === 'admin' ? '×× ×”×œ' : u.role === 'senior' ? '×‘×›×™×¨' : '××©×ª××©'}
                                            </span>
                                            ${u.id !== state.user.id ? `
                                                ${u.role === 'user' ? `<button onclick="changeRole('${u.id}','senior')" class="bg-purple-500 text-white px-3 py-1 rounded text-sm">â†‘ ×‘×›×™×¨</button>` : ''}
                                                ${u.role === 'senior' ? `<button onclick="changeRole('${u.id}','user')" class="bg-gray-500 text-white px-3 py-1 rounded text-sm">â†“ ××©×ª××©</button>` : ''}
                                                <button onclick="deleteUser('${u.id}')" class="bg-red-500 text-white px-3 py-1 rounded text-sm">××—×§</button>
                                            ` : ''}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
            }
        }
        
        // Expose functions
        window.doLogin = doLogin;
        window.doRegister = doRegister;
        window.doLogout = doLogout;
        window.goTo = goTo;
        window.changeRole = changeRole;
        window.deleteUser = deleteUser;
        
        render();
    </script>
</body>
</html>
