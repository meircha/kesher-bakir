<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×§×”×™×œ×ª ×§×©×¨ | ×”×—×™×™× ×”×˜×•×‘×™×</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <style>
        /* --- 1. ×¢×™×¦×•×‘ ×—×“×© ×•×¦×‘×¢×•× ×™ (××•×ª×× ×œ×§×”×œ ××‘×•×’×¨) --- */
        :root {
            --kesher-primary: #FF6B6B; /* Vibrant Coral - ×—×, ×× ×¨×’×˜×™ */
            --kesher-secondary: #4ECDC4; /* Bright Aqua/Teal - ××¨×¢× ×Ÿ, ×‘×”×™×¨ */
            --kesher-accent: #FFCD00; /* Gold/Yellow - ××•×¤×˜×™××™×•×ª, × ×™×§×•×“ */
            --kesher-text: #333;
        }
        .bg-kesher-primary { background-color: var(--kesher-primary); }
        .bg-kesher-secondary { background-color: var(--kesher-secondary); }
        .text-kesher-primary { color: var(--kesher-primary); }
        .text-kesher-secondary { color: var(--kesher-secondary); }
        .border-kesher-primary { border-color: var(--kesher-primary); }
        .border-kesher-secondary { border-color: var(--kesher-secondary); }
        .hover\:bg-kesher-primary:hover { background-color: var(--kesher-primary); }

        /* ×›×¤×ª×•×¨ ×’×œ×•×‘×œ×™ */
        .btn-primary {
            background-color: var(--kesher-primary);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background-color 0.2s;
        }
        .btn-primary:hover {
            background-color: #FF4A4A; /* Darker coral */
        }
        
        /* ×©×“×•×ª ×§×œ×˜ */
        .input-field {
            padding: 0.75rem 1rem;
            border: 1px solid #ddd;
            border-radius: 0.5rem;
            width: 100%;
            box-sizing: border-box;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .input-field:focus {
            outline: none;
            border-color: var(--kesher-secondary);
            box-shadow: 0 0 0 3px rgba(78, 205, 196, 0.5);
        }

        /* ×¡×¨×’×œ ×¦×“×“×™ */
        .sidebar {
            width: 280px;
            background-color: #34495E; /* ×›×—×•×œ ×›×”×” × ×¢×™× */
            color: white;
            height: 100vh;
            position: fixed;
            right: 0;
            top: 0;
            padding: 1.5rem 1rem;
            box-shadow: -4px 0 10px rgba(0,0,0,0.1);
            z-index: 10;
            display: flex;
            flex-direction: column;
        }
        .main-content {
            margin-right: 280px; /* ××¤× ×” ××§×•× ×œ×¡×¨×’×œ ×”×¦×“ */
            padding: 1.5rem;
        }
        .sidebar-item {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            margin-bottom: 0.5rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s, transform 0.1s;
            cursor: pointer;
        }
        .sidebar-item:hover {
            background-color: #2C3E50;
        }
        .sidebar-item.active {
            background-color: var(--kesher-secondary);
            font-weight: bold;
        }
        .sidebar-item i {
            margin-left: 0.75rem;
            width: 20px;
            text-align: center;
        }
        
        /* ×›×¨×˜×™×¡×™ ×¤×•×¨×•× */
        .forum-card {
            background-color: white;
            border-radius: 1rem;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            padding: 1.5rem;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .forum-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.1);
        }

    </style>
</head>
<body class="bg-gray-100">
    <div id="app">
        </div>

    <script>
        // --- 0. ×§×•× ×¤×™×’×•×¨×¦×™×” ×•×”×ª×—×œ×ª×™×•×ª ---
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY", // <--- ×—×•×‘×” ×œ×”×—×œ×™×£ ××ª ×–×”!
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com", // <--- ×—×•×‘×” ×œ×”×—×œ×™×£ ××ª ×–×”!
            projectId: "YOUR_PROJECT_ID", // <--- ×—×•×‘×” ×œ×”×—×œ×™×£ ××ª ×–×”!
            storageBucket: "YOUR_PROJECT_ID.appspot.com",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID" // <--- ×—×•×‘×” ×œ×”×—×œ×™×£ ××ª ×–×”!
        };
        firebase.initializeApp(firebaseConfig);

        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- State Management ---
        const state = {
            user: null,
            screen: 'loading', // login, register, home, forum, post, chat, users, admin
            forums: [],
            users: [],
            selectedForum: null,
            selectedPost: null,
            selectedUser: null, // ×”××©×ª××© ×©×‘×•×—×¨×™× ×‘×¦'××˜
            chatMessages: [], // ×”×•×“×¢×•×ª ×”×¦'××˜ ×”× ×•×›×—×™
            chatListener: null, // Listener ×¢×‘×•×¨ ×”×¦'××˜ ×‘×–××Ÿ ×××ª
            forumListener: null, // Listener ×¢×‘×•×¨ ×”×¤×•×¨×•× ×‘×–××Ÿ ×××ª
            usersListener: null, // Listener ×¢×‘×•×¨ ××©×ª××©×™× ×‘×–××Ÿ ×××ª
        };

        // --- ×¤×•× ×§×¦×™×•×ª ×¢×–×¨ ×’×œ×•×‘×œ×™×•×ª ---

        function goTo(screenName) {
            state.screen = screenName;
            
            // ×× ×¢×•×‘×¨×™× ×××¡×š ×¦'××˜, ×× ×§×™× ××ª ×”×œ×™×¡× ×¨ ×©×œ×•
            if (state.chatListener && screenName !== 'chat') {
                state.chatListener();
                state.chatListener = null;
                state.selectedUser = null;
                state.chatMessages = [];
            }
            render();
        }

        function scrollToBottom(id) {
            const element = document.getElementById(id);
            if (element) {
                element.scrollTop = element.scrollHeight;
            }
        }

        // --- 1. ××•×˜× ×˜×™×§×¦×™×” ---

        async function register() {
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            const name = document.getElementById('register-name').value;
            
            if (password.length < 8) {
                alert("×”×¡×™×¡××” ×—×™×™×‘×ª ×œ×”×™×•×ª ×œ×¤×—×•×ª 8 ×ª×•×•×™×.");
                return;
            }

            try {
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;

                // ×™×¦×™×¨×ª ××¡××š ××©×ª××© ×‘-Firestore
                await db.collection('users').doc(user.uid).set({
                    email: email,
                    displayName: name,
                    role: 'user', // ×‘×¨×™×¨×ª ××—×“×œ: ××©×ª××© ×¨×’×™×œ
                    isOnline: true,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                });

                alert("×”×¨×©××” ××•×¦×œ×—×ª! ××•×¢×‘×¨ ×œ××¡×š ×”×‘×™×ª.");
                // onAuthStateChanged ×™×˜×¤×œ ×‘××¢×‘×¨ ×œ-home
            } catch (error) {
                alert(`×©×’×™××ª ×”×¨×©××”: ${error.message}`);
            }
        }

        async function login() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;

            try {
                await auth.signInWithEmailAndPassword(email, password);
                // onAuthStateChanged ×™×˜×¤×œ ×‘××¢×‘×¨ ×œ-home
            } catch (error) {
                alert(`×©×’×™××ª ×›× ×™×¡×”: ${error.message}`);
            }
        }

        async function logout() {
            try {
                // ×¢×“×›×•×Ÿ ×¡×˜×˜×•×¡ ×œ× ××—×•×‘×¨
                if (state.user) {
                    await db.collection('users').doc(state.user.id).update({
                        isOnline: false,
                        lastSeen: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
                
                // × ×™×ª×•×§ ×‘×¤×•×¢×œ
                await auth.signOut();
                // onAuthStateChanged ×™×˜×¤×œ ×‘××¢×‘×¨ ×œ-login
            } catch (error) {
                console.error("×©×’×™××ª ×™×¦×™××”:", error);
                alert("××™×¨×¢×” ×©×’×™××” ×‘××”×œ×š ×”×™×¦×™××”.");
            }
        }

        // --- 2. ××—×–×•×¨ × ×ª×•× ×™× ×¨××©×•× ×™×™× ---

        async function fetchInitialData() {
            // × ×™×§×•×™ ×œ×™×¡× ×¨×™× ×§×•×“××™×
            if (state.forumListener) state.forumListener();
            if (state.usersListener) state.usersListener();

            // 1. ×œ×™×¡× ×¨ ××©×ª××©×™× (×‘×–××Ÿ ×××ª)
            state.usersListener = db.collection('users')
                .onSnapshot(snapshot => {
                    state.users = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    render(); // ×¨× ×“×•×¨ ××—×“×© ×¢× ×¡×˜×˜×•×¡ ×”××©×ª××©×™× ×”××¢×•×“×›×Ÿ
                }, error => {
                    console.error("×©×’×™××” ×‘×œ×™×¡× ×¨ ××©×ª××©×™×:", error);
                });

            // 2. ×œ×™×¡× ×¨ ×¤×•×¨×•××™×
            state.forumListener = db.collection('forums')
                .orderBy('createdAt', 'desc')
                .onSnapshot(snapshot => {
                    state.forums = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    // ×× ×”××©×ª××© ×›×‘×¨ ×‘××¡×š home/forum, ×¨× ×“×¨ ××—×“×© ×›×“×™ ×œ×¢×“×›×Ÿ
                    if (state.screen === 'home' || state.screen === 'forum') {
                        render();
                    }
                }, error => {
                    console.error("×©×’×™××” ×‘×œ×™×¡× ×¨ ×¤×•×¨×•××™×:", error);
                });
        }


        // --- 3. ×œ×•×’×™×§×ª ×¤×•×¨×•× ---

        async function createForum() {
            const title = prompt("×”×›× ×¡ ×©× ×œ×¤×•×¨×•× ×”×—×“×©:");
            if (title && title.trim()) {
                try {
                    await db.collection('forums').add({
                        title: title.trim(),
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        createdBy: state.user.displayName,
                        createdByUid: state.user.id,
                        postCount: 0
                    });
                    alert("×”×¤×•×¨×•× × ×•×¦×¨ ×‘×”×¦×œ×—×”!");
                } catch (error) {
                    alert(`×©×’×™××” ×‘×™×¦×™×¨×ª ×¤×•×¨×•×: ${error.message}`);
                }
            }
        }
        
        async function deleteForum(forumId) {
            if (state.user.role !== 'admin') {
                alert("××™×Ÿ ×œ×š ×”×¨×©××” ×œ××—×•×§ ×¤×•×¨×•×.");
                return;
            }
            if (confirm("×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ×¤×•×¨×•× ×–×”? ×›×œ ×”×¤×•×¡×˜×™× ×‘×ª×•×›×• ×™×™××—×§×•!")) {
                try {
                    // ××—×™×§×ª ×›×œ ×”×¤×•×¡×˜×™× ×‘×¤×•×¨×•×
                    const posts = await db.collection('forums').doc(forumId).collection('posts').get();
                    const batch = db.batch();
                    posts.docs.forEach(post => {
                        batch.delete(post.ref);
                    });
                    await batch.commit();

                    // ××—×™×§×ª ×”×¤×•×¨×•× ×¢×¦××•
                    await db.collection('forums').doc(forumId).delete();
                    goTo('home');
                    alert("×”×¤×•×¨×•× × ××—×§ ×‘×”×¦×œ×—×”.");
                } catch (error) {
                    alert(`×©×’×™××” ×‘××—×™×§×ª ×¤×•×¨×•×: ${error.message}`);
                }
            }
        }
        
        async function viewForum(forumId) {
            state.selectedForum = state.forums.find(f => f.id === forumId);
            
            // ×˜×¢×™× ×ª ×¤×•×¡×˜×™× ×‘×–××Ÿ ×××ª
            if (state.forumListener) state.forumListener(); // ×× ×§×™× ××ª ×œ×™×¡× ×¨ ×”×¤×•×¨×•××™× ×”×¨××©×™

            state.forumListener = db.collection('forums').doc(forumId).collection('posts')
                .orderBy('createdAt', 'desc')
                .onSnapshot(snapshot => {
                    state.selectedForum.posts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    render();
                }, error => {
                    console.error("×©×’×™××” ×‘×œ×™×¡× ×¨ ×¤×•×¡×˜×™×:", error);
                });

            goTo('forum');
        }

        async function createPost() {
            const title = prompt("×”×›× ×¡ ×›×•×ª×¨×ª ×œ×¤×•×¡×˜:");
            const content = prompt("×”×›× ×¡ ×ª×•×›×Ÿ ×œ×¤×•×¡×˜:");
            
            if (title && title.trim() && content && content.trim()) {
                try {
                    await db.collection('forums').doc(state.selectedForum.id).collection('posts').add({
                        title: title.trim(),
                        content: content.trim(),
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        createdBy: state.user.displayName,
                        createdByUid: state.user.id,
                        commentCount: 0
                    });

                    // ×¢×“×›×•×Ÿ ××•× ×” ×”×¤×•×¡×˜×™× ×‘×¤×•×¨×•× ×”×¨××©×™
                    await db.collection('forums').doc(state.selectedForum.id).update({
                        postCount: firebase.firestore.FieldValue.increment(1)
                    });
                    
                    alert("×”×¤×•×¡×˜ × ×•×¦×¨ ×‘×”×¦×œ×—×”!");
                } catch (error) {
                    alert(`×©×’×™××” ×‘×™×¦×™×¨×ª ×¤×•×¡×˜: ${error.message}`);
                }
            }
        }
        
        async function viewPost(postId) {
            state.selectedPost = state.selectedForum.posts.find(p => p.id === postId);

            // ×˜×¢×™× ×ª ×ª×’×•×‘×•×ª ×‘×–××Ÿ ×××ª
            if (state.forumListener) state.forumListener(); // ×× ×§×™× ××ª ×œ×™×¡× ×¨ ×”×¤×•×¡×˜×™×

            state.forumListener = db.collection('forums').doc(state.selectedForum.id).collection('posts').doc(postId).collection('comments')
                .orderBy('createdAt', 'asc')
                .onSnapshot(snapshot => {
                    state.selectedPost.comments = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    render();
                    scrollToBottom('commentBox');
                }, error => {
                    console.error("×©×’×™××” ×‘×œ×™×¡× ×¨ ×ª×’×•×‘×•×ª:", error);
                });

            goTo('post');
        }
        
        async function addComment() {
            const content = document.getElementById('commentInput').value;

            if (content.trim()) {
                try {
                    await db.collection('forums').doc(state.selectedForum.id).collection('posts').doc(state.selectedPost.id).collection('comments').add({
                        content: content.trim(),
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        createdBy: state.user.displayName,
                        createdByUid: state.user.id,
                    });

                    // ×¢×“×›×•×Ÿ ××•× ×” ×”×ª×’×•×‘×•×ª ×‘×¤×•×¡×˜
                    await db.collection('forums').doc(state.selectedForum.id).collection('posts').doc(state.selectedPost.id).update({
                        commentCount: firebase.firestore.FieldValue.increment(1)
                    });

                    document.getElementById('commentInput').value = '';
                } catch (error) {
                    alert(`×©×’×™××” ×‘×”×•×¡×¤×ª ×ª×’×•×‘×”: ${error.message}`);
                }
            }
        }
        
        // --- 4. ×œ×•×’×™×§×ª ×¦'××˜ ---

        async function getChatId(user1Id, user2Id) {
            // ×™×•×¦×¨ ID ×¦'××˜ ×™×—×™×“ ×¢×œ ×™×“×™ ××™×•×Ÿ ×”-UID
            return [user1Id, user2Id].sort().join('_');
        }

        async function enterChat(partnerId) {
            // × ×™×§×•×™ ×œ×™×¡× ×¨ ×¦'××˜ ×§×•×“×
            if (state.chatListener) {
                state.chatListener();
                state.chatListener = null;
            }
            
            // × ×™×§×•×™ × ×ª×•× ×™ ×¦'××˜ ×§×•×“××™×
            state.chatMessages = [];
            
            const chatId = await getChatId(state.user.id, partnerId);
            
            // ×”×’×“×¨×ª ×œ×™×¡× ×¨ ×”×¦'××˜ ×œ×¤× ×™ ×”× ×™×•×•×˜, ×›×“×™ ×©× ×ª×—×™×œ ×œ×§×‘×œ × ×ª×•× ×™× ××™×™×“×™×ª
            state.chatListener = db.collection('chats').doc(chatId).collection('messages')
                .orderBy('timestamp', 'asc')
                .limit(50)
                .onSnapshot(snapshot => {
                    state.chatMessages = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    render(); // ×¨× ×“×•×¨ ××—×“×© ×¢× ×”×”×•×“×¢×•×ª ×”×—×“×©×•×ª
                    scrollToBottom('chatBox');
                }, error => {
                    console.error("×©×’×™××” ×‘×œ×™×¡× ×¨ ×¦'××˜:", error);
                    // ×× ×™×© ×©×’×™××” (×›××• ×—×•×¡×¨ ×”×¨×©××•×ª), ×× ×• ×× ×ª×§×™× ××ª ×”×œ×™×¡× ×¨ ×•××•×“×™×¢×™× ×œ××©×ª××©
                    if (state.chatListener) {
                         state.chatListener();
                         state.chatListener = null;
                         goTo('users');
                         alert("×©×’×™××” ×‘××—×–×•×¨ ×”×•×“×¢×•×ª ×”×¦'××˜. ×× × ×‘×“×•×§ ×”×¨×©××•×ª Firestore.");
                    }
                });

            // ×©××™×¨×ª ×”××©×ª××© ×©×‘×¦'××˜
            state.selectedUser = state.users.find(u => u.id === partnerId);
            
            // ××¢×‘×¨ ×œ××¡×š ×”×¦'××˜
            goTo('chat'); 
        }

        async function sendMessage() {
            const inputElement = document.getElementById('chatInput');
            const content = inputElement.value.trim();
            
            if (!content || !state.selectedUser) return; // ×œ× ×©×•×œ×—×™× ×”×•×“×¢×” ×¨×™×§×” ××• ×›×©××™×Ÿ ××©×ª××© ×™×¢×“

            const partnerId = state.selectedUser.id;
            const chatId = await getChatId(state.user.id, partnerId);
            
            try {
                // ×©××™×¨×ª ×”×”×•×“×¢×” ×‘-Firestore
                await db.collection('chats').doc(chatId).collection('messages').add({
                    senderId: state.user.id,
                    content: content,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    read: false, // ×¡×˜×˜×•×¡ ×§×¨×™××”
                });

                inputElement.value = ''; // × ×™×§×•×™ ×©×“×” ×”×§×œ×˜

            } catch (error) {
                console.error("×©×’×™××” ×‘×©×œ×™×—×ª ×”×•×“×¢×”:", error);
                alert("×©×’×™××” ×‘×©×œ×™×—×ª ×”×”×•×“×¢×”.");
            }
        }
        
        // --- 5. ×œ×•×’×™×§×ª × ×™×”×•×œ (Admin) ---

        async function reportItem(itemId, itemType, reporterId) {
            if (!confirm("×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ×“×•×•×— ×¢×œ ×¤×¨×™×˜ ×–×”?")) return;

            try {
                await db.collection('reports').add({
                    itemId: itemId,
                    itemType: itemType, // post, comment, message
                    reporterId: state.user.id,
                    reportedUserId: reporterId,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    status: 'open'
                });
                alert("×”×“×™×•×•×— × ×©×œ×— ×œ×× ×”×œ×™×.");
            } catch (error) {
                alert(`×©×’×™××” ×‘×©×œ×™×—×ª ×“×™×•×•×—: ${error.message}`);
            }
        }
        
        // --- 6. ×¨×›×™×‘×™ UI ---

        const getHeader = () => {
             // ğŸ›‘ ×ª×™×§×•×Ÿ: ×× ×”××©×ª××© ×œ× ××—×•×‘×¨, ××œ ×ª× ×¡×” ×œ×§×¨×•× ××ª state.user
            if (!state.user) return '';

            // × ×™×•×•×˜ ×œ××“××™×Ÿ ×¨×§ ×œ×× ×”×œ×™×
            const adminButton = state.user.role === 'admin' 
                ? `<div onclick="goTo('admin')" class="sidebar-item ${state.screen === 'admin' ? 'active' : ''}">
                        <i class="fa-solid fa-user-gear"></i>
                        <span>× ×™×”×•×œ (Admin)</span>
                    </div>`
                : '';

            return `
                <div class="sidebar">
                    <div class="text-3xl font-bold mb-8 text-kesher-accent">×§×”×™×œ×ª ×§×©×¨</div>
                    
                    <div class="flex-grow">
                        <div onclick="goTo('home')" class="sidebar-item ${state.screen === 'home' || state.screen === 'forum' || state.screen === 'post' ? 'active' : ''}">
                            <i class="fa-solid fa-comments"></i>
                            <span>×¤×•×¨×•××™×</span>
                        </div>
                        <div onclick="goTo('users')" class="sidebar-item ${state.screen === 'users' || state.screen === 'chat' ? 'active' : ''}">
                            <i class="fa-solid fa-users"></i>
                            <span>×—×‘×¨×™× ×•×¦'××˜</span>
                        </div>
                        ${adminButton}
                    </div>

                    <div class="mt-auto pt-4 border-t border-gray-600">
                        <div class="text-sm font-semibold mb-2">×©×œ×•×, ${state.user.displayName}</div>
                        <button onclick="logout()" class="w-full bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded transition font-medium">
                            <i class="fa-solid fa-right-from-bracket mr-2"></i>
                            ×™×¦×™××”
                        </button>
                    </div>
                </div>
            `;
        };

        // --- 7. ××¡×š ×˜×¢×™× ×” ---

        const renderLoading = () => `
            <div class="flex items-center justify-center min-h-screen">
                <div class="text-center">
                    <i class="fa-solid fa-spinner fa-spin-pulse text-6xl text-kesher-secondary"></i>
                    <h1 class="text-3xl font-bold mt-4 text-kesher-text">×˜×•×¢×Ÿ ×§×”×™×œ×”...</h1>
                </div>
            </div>
        `;

        // --- 8. ××¡×›×™ ××•×˜× ×˜×™×§×¦×™×” ---

        const renderLoginPage = () => `
            <div class="flex items-center justify-center min-h-screen bg-gray-50">
                <div class="bg-white p-10 rounded-xl shadow-2xl w-full max-w-md">
                    <h1 class="text-4xl font-extrabold mb-8 text-center text-kesher-primary">×‘×¨×•×š ×”×‘× ×œ×§×”×™×œ×ª ×§×©×¨</h1>
                    <div class="space-y-6">
                        <input type="email" id="login-email" placeholder="×“×•××¨ ××œ×§×˜×¨×•× ×™" class="input-field mb-4" value="">
                        <input type="password" id="login-password" placeholder="×¡×™×¡××”" class="input-field mb-6" value="">
                        <button onclick="login()" class="w-full btn-primary text-xl">×”×ª×—×‘×¨×•×ª</button>
                    </div>
                    <p class="text-center mt-6 text-gray-600">
                        ××™×Ÿ ×œ×š ×—×©×‘×•×Ÿ? 
                        <a href="#" onclick="goTo('register')" class="text-kesher-secondary hover:text-kesher-primary font-semibold">×”×™×¨×©× ×›××Ÿ</a>
                    </p>
                </div>
            </div>
        `;

        const renderRegisterPage = () => `
            <div class="flex items-center justify-center min-h-screen bg-gray-50">
                <div class="bg-white p-10 rounded-xl shadow-2xl w-full max-w-md">
                    <h1 class="text-4xl font-extrabold mb-8 text-center text-kesher-secondary">×”×¨×©××” ×œ×§×”×™×œ×”</h1>
                    <div class="space-y-6">
                        <input type="text" id="register-name" placeholder="×©× ××œ×" class="input-field">
                        <input type="email" id="register-email" placeholder="×“×•××¨ ××œ×§×˜×¨×•× ×™" class="input-field">
                        <input type="password" id="register-password" placeholder="×¡×™×¡××” (×œ×¤×—×•×ª 8 ×ª×•×•×™×)" class="input-field">
                        <button onclick="register()" class="w-full btn-primary text-xl bg-kesher-secondary hover:bg-teal-500">×”×™×¨×©×</button>
                    </div>
                    <p class="text-center mt-6 text-gray-600">
                        ×›×‘×¨ ×¨×©×•×? 
                        <a href="#" onclick="goTo('login')" class="text-kesher-primary hover:text-kesher-secondary font-semibold">×”×ª×—×‘×¨</a>
                    </p>
                </div>
            </div>
        `;
        
        // --- 9. ××¡×š ×¦'××˜ ---
        const renderChat = () => {
            const partner = state.selectedUser;
            
            // ğŸ›‘ ×”×ª×™×§×•×Ÿ ×”×§×¨×™×˜×™: ×‘×“×™×§×•×ª ×™×¦×™××” ×‘×˜×•×—×•×ª ×œ×× ×™×¢×ª ×§×¨×™×¡×” (×©×’×™××ª ×”×¦'××˜)
            if (!partner || !Array.isArray(state.chatMessages)) {
                 // ×‘××§×¨×” ×–×”, × ×—×–×™×¨ ××¡×š ×˜×¢×™× ×” ×™×“×™×“×•×ª×™ ×¢×“ ×©×”×œ×™×¡× ×¨ ×™×¡×™×™× ×œ×¢×‘×•×“
                return `
                    ${getHeader()}
                    <div class="main-content">
                        <div class="max-w-4xl mx-auto px-4 mt-8 p-8 text-center text-gray-500 bg-white rounded-xl shadow-lg">
                            <i class="fa-solid fa-spinner fa-spin-pulse text-4xl text-kesher-secondary"></i>
                            <h2 class="mt-3 text-xl">×˜×•×¢×Ÿ ×©×™×—×”...</h2>
                        </div>
                    </div>
                `;
            }

            const partnerName = partner.displayName || partner.email || '××©×ª××© ×œ× ×™×“×•×¢';
            
            // ×™×¦×™×¨×ª ×ª×•×›×Ÿ ×”×¦'××˜, ×›×•×œ×œ ×”×•×“×¢×ª ×¤×ª×™×—×” ×× ××™×Ÿ ×”×•×“×¢×•×ª.
            const chatContent = state.chatMessages.length === 0 
                ? '<div class="text-center text-gray-500 mt-10">××™×Ÿ ×¢×“×™×™×Ÿ ×”×•×“×¢×•×ª. ×”×ª×—×œ ×©×™×—×”!</div>'
                : state.chatMessages.map(msg => { 
                    const isMe = msg.senderId === state.user.id;
                    // ğŸ›‘ ×‘×“×™×§×ª ×‘×˜×™×—×•×ª ×œ-timestamp (×ª×™×§×•×Ÿ ×©×’×™××ª toDate)
                    const time = msg.timestamp && typeof msg.timestamp.toDate === 'function' ? new Date(msg.timestamp.toDate()).toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit' }) : '×¢×›×©×™×•';
                    const isError = msg.content.includes('×©×’×™××ª ×—×™×‘×•×¨!');

                    return `
                        <div class="flex ${isMe ? 'justify-end' : 'justify-start'}">
                            <div class="${isError ? 'bg-red-100 border border-red-400 text-red-800' : isMe ? 'bg-kesher-secondary text-white rounded-tr-none' : 'bg-gray-200 text-gray-800 rounded-tl-none'} max-w-xs p-3 rounded-xl shadow-md">
                                <p class="text-sm">${msg.content}</p>
                                <div class="text-xs mt-1 flex justify-between items-center">
                                    <span class="${isError ? 'text-red-500' : isMe ? 'text-teal-200' : 'text-gray-500'}">${time} ${isMe && msg.read ? 'âœ…' : isMe ? '...' : ''}</span>
                                    ${!isMe && !isError ? `<button onclick="reportItem('${msg.id}', 'message', '${msg.senderId}')" class="text-red-400 hover:text-red-600 mr-2"><i class="fa-solid fa-flag"></i></button>` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            
            return `
                ${getHeader()}
                <div class="main-content">
                    <div class="max-w-4xl mx-auto px-4 mt-8 flex flex-col h-[calc(100vh-10rem)]">
                        <div class="bg-white p-4 rounded-t-xl shadow-md flex items-center justify-between">
                            <h2 class="text-2xl font-bold text-kesher-secondary">×¦'××˜ ×¢× ${partnerName}</h2>
                            <button onclick="goTo('users')" class="bg-red-600 hover:bg-red-700 px-3 py-1 rounded transition text-sm">×—×–×¨×” ×œ×—×‘×¨×™×</button>
                        </div>
                        
                        <div id="chatBox" class="flex-grow p-4 overflow-y-auto space-y-3 bg-gray-50 border-x border-b rounded-b-xl">
                            ${chatContent}
                        </div>
                        
                        <div class="bg-white p-4 rounded-b-xl shadow-lg border-t">
                            <div class="flex">
                                <input type="text" id="chatInput" placeholder="×›×ª×•×‘ ×”×•×“×¢×”..." class="flex-grow p-3 border border-gray-300 rounded-lg focus:outline-none focus:border-kesher-secondary" onkeydown="if(event.key === 'Enter') sendMessage()">
                                <button onclick="sendMessage()" class="bg-kesher-primary hover:bg-red-700 text-white px-6 py-3 rounded-lg mr-2 font-medium transition shrink-0">×©×œ×— <i class="fa-solid fa-paper-plane"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        };


        // --- 10. ××¡×š ×—×‘×¨×™× ---
        const renderUsers = () => {
            const onlineUsers = state.users
                .filter(u => u.id !== state.user.id && u.isOnline)
                .sort((a, b) => (a.displayName || '').localeCompare(b.displayName || '', 'he'));

            const offlineUsers = state.users
                .filter(u => u.id !== state.user.id && !u.isOnline)
                .sort((a, b) => (a.displayName || '').localeCompare(b.displayName || '', 'he'));

            const renderUserCard = (u) => {
                // ğŸ›‘ ×”×ª×™×§×•×Ÿ ×”×©× ×™: ×‘×“×™×§×ª ×‘×˜×™×—×•×ª ×œ-lastSeen ×œ×× ×™×¢×ª ×©×’×™××ª toDate()
                const lastSeen = u.lastSeen && typeof u.lastSeen.toDate === 'function' 
                    ? `× ×¨××” ×œ××—×¨×•× ×”: ${new Date(u.lastSeen.toDate()).toLocaleString('he-IL')}`
                    : '';
                
                return `
                    <div class="bg-white p-4 rounded-xl shadow-md flex items-center justify-between border ${u.isOnline ? 'border-green-400' : 'border-gray-300'}">
                        <div class="flex items-center">
                            <div class="w-3 h-3 rounded-full ${u.isOnline ? 'bg-green-500' : 'bg-gray-400'} mr-3"></div>
                            <div>
                                <h3 class="text-lg font-semibold text-kesher-text">${u.displayName} (${u.role})</h3>
                                <p class="text-sm text-gray-500">${u.email}</p>
                                <p class="text-xs text-gray-500">${lastSeen}</p>
                            </div>
                        </div>
                        <button onclick="enterChat('${u.id}')" class="bg-kesher-secondary hover:bg-teal-500 text-white px-4 py-2 rounded transition font-medium">
                            <i class="fa-solid fa-envelope"></i> ×©×œ×— ×”×•×“×¢×”
                        </button>
                    </div>
                `;
            };

            return `
                ${getHeader()}
                <div class="main-content">
                    <h1 class="text-3xl font-bold mb-6 text-kesher-primary">×—×‘×¨×™ ×§×”×™×œ×”</h1>
                    
                    <h2 class="text-xl font-semibold mt-8 mb-4 border-b pb-2 text-green-600">××—×•×‘×¨×™× (${onlineUsers.length})</h2>
                    <div class="space-y-4">
                        ${onlineUsers.length > 0 ? onlineUsers.map(renderUserCard).join('') : '<p class="text-gray-500">××™×Ÿ ×—×‘×¨×™× ××—×•×‘×¨×™× ×›×¨×’×¢.</p>'}
                    </div>

                    <h2 class="text-xl font-semibold mt-8 mb-4 border-b pb-2 text-gray-600">×œ× ××—×•×‘×¨×™× (${offlineUsers.length})</h2>
                    <div class="space-y-4">
                        ${offlineUsers.map(renderUserCard).join('')}
                    </div>
                </div>
            `;
        };


        // --- 11. ××¡×š ×”×‘×™×ª (×¤×•×¨×•××™×) ---
        const renderHome = () => `
            ${getHeader()}
            <div class="main-content">
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-4xl font-extrabold text-kesher-primary">×œ×•×— ×¤×•×¨×•××™×</h1>
                    ${state.user.role === 'admin' ? 
                        `<button onclick="createForum()" class="btn-primary flex items-center">
                            <i class="fa-solid fa-plus ml-2"></i>
                            ×¤×ª×— ×¤×•×¨×•× ×—×“×©
                        </button>` 
                        : ''}
                </div>
                
                <div class="space-y-6">
                    ${state.forums.map(forum => `
                        <div class="forum-card flex justify-between items-center" onclick="viewForum('${forum.id}')">
                            <div>
                                <h3 class="text-2xl font-bold text-kesher-secondary hover:text-kesher-primary cursor-pointer">${forum.title}</h3>
                                <p class="text-sm text-gray-500 mt-1">× ×•×¦×¨ ×¢"×™: ${forum.createdBy} | ×¤×•×¡×˜×™×: ${forum.postCount || 0}</p>
                            </div>
                            ${state.user.role === 'admin' ? 
                                `<button onclick="event.stopPropagation(); deleteForum('${forum.id}')" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded transition text-sm">
                                    <i class="fa-solid fa-trash"></i> ××—×§
                                </button>`
                                : ''}
                        </div>
                    `).join('')}
                    ${state.forums.length === 0 ? '<p class="text-gray-500 text-center p-8 bg-white rounded-xl">××™×Ÿ ×¤×•×¨×•××™× ×›×¨×’×¢. ×¦×•×¨ ××—×“ ×›×“×™ ×œ×”×ª×—×™×œ!</p>' : ''}
                </div>
            </div>
        `;

        // --- 12. ××¡×š ×¤×•×¨×•× (×¤×•×¡×˜×™×) ---
        const renderForum = () => {
            if (!state.selectedForum) {
                goTo('home');
                return '';
            }

            return `
                ${getHeader()}
                <div class="main-content">
                    <button onclick="goTo('home')" class="text-kesher-secondary hover:text-kesher-primary mb-4 block"><i class="fa-solid fa-arrow-right mr-2"></i> ×—×–×¨×” ×œ×¤×•×¨×•××™×</button>
                    <div class="flex justify-between items-center mb-6 border-b pb-3">
                        <h1 class="text-3xl font-extrabold text-kesher-primary">${state.selectedForum.title}</h1>
                        <button onclick="createPost()" class="btn-primary flex items-center">
                            <i class="fa-solid fa-pen-to-square ml-2"></i>
                            ×¤×•×¡×˜ ×—×“×©
                        </button>
                    </div>

                    <div class="space-y-4">
                        ${state.selectedForum.posts && state.selectedForum.posts.length > 0 ? state.selectedForum.posts.map(post => `
                            <div class="bg-white p-4 rounded-xl shadow-md cursor-pointer hover:bg-gray-50 transition" onclick="viewPost('${post.id}')">
                                <h3 class="text-xl font-bold text-kesher-secondary">${post.title}</h3>
                                <p class="text-gray-700 mt-1 line-clamp-2">${post.content}</p>
                                <div class="text-sm text-gray-500 mt-2 flex justify-between">
                                    <span>× ×›×ª×‘ ×¢"×™: ${post.createdBy} | ×ª×’×•×‘×•×ª: ${post.commentCount || 0}</span>
                                    <span>${post.createdAt && typeof post.createdAt.toDate === 'function' ? new Date(post.createdAt.toDate()).toLocaleDateString('he-IL') : '××™×Ÿ ×ª××¨×™×š'}</span>
                                </div>
                            </div>
                        `).join('') : '<p class="text-gray-500 text-center p-8 bg-white rounded-xl">××™×Ÿ ×¢×“×™×™×Ÿ ×¤×•×¡×˜×™× ×‘×¤×•×¨×•× ×–×”.</p>'}
                    </div>
                </div>
            `;
        };

        // --- 13. ××¡×š ×¤×•×¡×˜ (×ª×’×•×‘×•×ª) ---
        const renderPost = () => {
            if (!state.selectedForum || !state.selectedPost) {
                goTo('home');
                return '';
            }
            
            const post = state.selectedPost;

            return `
                ${getHeader()}
                <div class="main-content">
                    <button onclick="viewForum('${state.selectedForum.id}')" class="text-kesher-secondary hover:text-kesher-primary mb-4 block"><i class="fa-solid fa-arrow-right mr-2"></i> ×—×–×¨×” ×œ×¤×•×¡×˜×™×</button>
                    
                    <div class="bg-white p-6 rounded-xl shadow-lg mb-6">
                        <h1 class="text-3xl font-extrabold text-kesher-primary">${post.title}</h1>
                        <div class="text-sm text-gray-500 mt-2 mb-4 border-b pb-2">
                            × ×›×ª×‘ ×¢"×™: ${post.createdBy} | ${post.createdAt && typeof post.createdAt.toDate === 'function' ? new Date(post.createdAt.toDate()).toLocaleDateString('he-IL') : '××™×Ÿ ×ª××¨×™×š'}
                        </div>
                        <p class="text-gray-700 leading-relaxed whitespace-pre-wrap">${post.content}</p>
                        <button onclick="reportItem('${post.id}', 'post', '${post.createdByUid}')" class="text-red-400 hover:text-red-600 mt-4 text-sm float-left">
                            <i class="fa-solid fa-flag mr-1"></i> ×“×•×•×—
                        </button>
                    </div>

                    <h2 class="text-2xl font-bold mt-8 mb-4 text-kesher-secondary">×ª×’×•×‘×•×ª (${post.comments ? post.comments.length : 0})</h2>
                    <div id="commentBox" class="space-y-4 max-h-96 overflow-y-auto pr-2">
                        ${post.comments && post.comments.length > 0 ? post.comments.map(comment => `
                            <div class="bg-white p-4 rounded-xl shadow-md border-r-4 border-kesher-secondary relative">
                                <p class="font-semibold text-kesher-text">${comment.createdBy} <span class="text-xs text-gray-500 ml-2">${comment.createdAt && typeof comment.createdAt.toDate === 'function' ? new Date(comment.createdAt.toDate()).toLocaleString('he-IL') : '××™×Ÿ ×ª××¨×™×š'}</span></p>
                                <p class="text-gray-700 mt-1">${comment.content}</p>
                                <button onclick="reportItem('${comment.id}', 'comment', '${comment.createdByUid}')" class="text-red-400 hover:text-red-600 absolute top-4 left-4 text-sm">
                                    <i class="fa-solid fa-flag"></i>
                                </button>
                            </div>
                        `).join('') : '<p class="text-gray-500">××™×Ÿ ×¢×“×™×™×Ÿ ×ª×’×•×‘×•×ª. ×”×™×” ×”×¨××©×•×Ÿ ×œ×”×’×™×‘!</p>'}
                    </div>

                    <div class="mt-6 bg-white p-4 rounded-xl shadow-lg border-t-4 border-kesher-primary">
                        <h3 class="text-xl font-bold mb-3 text-kesher-primary">×”×•×¡×£ ×ª×’×•×‘×”</h3>
                        <textarea id="commentInput" rows="3" placeholder="×›×ª×•×‘ ××ª ×”×ª×’×•×‘×” ×©×œ×š ×›××Ÿ..." class="input-field mb-3"></textarea>
                        <button onclick="addComment()" class="btn-primary flex items-center">
                            <i class="fa-solid fa-reply ml-2"></i>
                            ×©×œ×— ×ª×’×•×‘×”
                        </button>
                    </div>
                </div>
            `;
        };

        // --- 14. ××¡×š × ×™×”×•×œ (Admin) ---
        const renderAdmin = () => `
            ${getHeader()}
            <div class="main-content">
                <h1 class="text-4xl font-extrabold text-kesher-primary mb-6">×¤×× ×œ × ×™×”×•×œ</h1>
                <p class="text-xl text-gray-700">×‘× ×™×™×ª ××¢×¨×›×ª ×”×“×™×•×•×—×™× ×•×××©×§ ×”× ×™×”×•×œ ×ª×ª×‘×¦×¢ ×‘×©×œ×‘ ×”×‘×.</p>
            </div>
        `;
        
        // --- 15. ×¤×•× ×§×¦×™×™×ª ×”×¨×™× ×“×•×¨ ×”×¨××©×™×ª ---

        const render = () => {
            let htmlContent = '';
            
            switch (state.screen) {
                case 'loading':
                    htmlContent = renderLoading();
                    break;
                case 'login':
                    htmlContent = renderLoginPage();
                    break;
                case 'register':
                    htmlContent = renderRegisterPage();
                    break;
                case 'home':
                    htmlContent = renderHome();
                    break;
                case 'forum':
                    htmlContent = renderForum();
                    break;
                case 'post':
                    htmlContent = renderPost();
                    break;
                case 'users':
                    htmlContent = renderUsers();
                    break;
                case 'chat':
                    htmlContent = renderChat(); // ××¨×™× ×“×¨ ××ª ××¡×š ×”×¦'××˜
                    break;
                case 'admin':
                    htmlContent = renderAdmin();
                    break;
                default:
                    htmlContent = renderHome();
            }

            document.getElementById('app').innerHTML = htmlContent;

            // ×’×œ×™×œ×” ×œ×ª×—×ª×™×ª ×”×¦'××˜ ×œ××—×¨ ×¨×™× ×“×•×¨
            if (state.screen === 'chat') {
                scrollToBottom('chatBox');
            }
        };

        // --- 16. ××ª×—×•×œ ×”××¤×œ×™×§×¦×™×” (Authentication State Observer) ---

        function initializeApp() {
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    // **××©×ª××© ××—×•×‘×¨**
                    try {
                        // 1. ××—×–×•×¨ ×¤×¨×˜×™ ××©×ª××© ×-Firestore
                        const userDoc = await db.collection('users').doc(user.uid).get();

                        if (userDoc.exists) {
                            state.user = { id: user.uid, ...userDoc.data() };
                            
                            // 2. ×¢×“×›×•×Ÿ ×¡×˜×˜×•×¡ ×œ-Online ×•×˜×¢×™× ×ª × ×ª×•× ×™× ×¨××©×•× ×™×™×
                            await db.collection('users').doc(user.uid).update({ 
                                isOnline: true, 
                                lastSeen: firebase.firestore.FieldValue.serverTimestamp() // ×¢×“×›×•×Ÿ ×–××Ÿ ××—×¨×•×Ÿ ×©× ×¨××”
                            });
                            
                            await fetchInitialData(); 
                            
                            // 3. × ×™×ª×•×‘ ×œ××¡×š ×”×‘×™×ª ×¨×§ ×× ×œ× ×”×™×ª×” ×©×’×™××” ×§×¨×™×˜×™×ª
                            if (state.screen === 'loading' || state.screen === 'login' || state.screen === 'register') {
                                goTo('home');
                            } else {
                                render(); // ×× ×”××©×ª××© ×›×‘×¨ ×‘××¡×š ×›×œ×©×”×• (×›××• ×¤×•×¨×•×), ×¨× ×“×¨ ××—×“×©
                            }
                        } else {
                            // ×”××©×ª××© ××—×•×‘×¨ ×‘-Auth ××‘×œ ×œ× ×§×™×™× ×‘××¡××š users (×›× ×¨××” × ××—×§)
                            auth.signOut();
                        }
                    } catch (error) {
                        console.error("×©×’×™××” ×§×¨×™×˜×™×ª ×‘××—×–×•×¨ ×¤×¨×•×¤×™×œ ××©×ª××© ××• × ×ª×•× ×™× (Firebase/Config):", error);
                         // ×× ×™×© ×©×’×™××” ×‘×—×™×‘×•×¨ ×œ-Firebase, ×× ×• ×—×•×–×¨×™× ×œ×œ×•×’×™×Ÿ
                        state.user = null;
                        state.screen = 'login';
                        render();
                        alert("×©×’×™××” ×‘×—×™×‘×•×¨ ×œ×©×¨×ª ××• ×‘××—×–×•×¨ × ×ª×•× ×™×. × ×¡×” ×œ×”×ª×—×‘×¨ ×©×•×‘.");
                    }
                } else {
                    // **×”××©×ª××© ×œ× ××—×•×‘×¨ ××• ×™×¦×**
                    state.user = null;
                    
                    // × ×™×§×•×™ ×œ×™×¡× ×¨×™× ×©×œ ×¦'××˜
                    if (state.chatListener) {
                        state.chatListener();
                        state.chatListener = null;
                    }

                    if (state.screen !== 'register') {
                        goTo('login');
                    } else {
                        render();
                    }
                }
            });
        }

        // ×”×¤×¢×œ×ª ×”××¤×œ×™×§×¦×™×”
        initializeApp(); 
    </script>
</body>
</html>
