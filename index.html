<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×§×”×™×œ×ª ×§×©×¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <style>
        /* ×”×’×“×¨×•×ª ×˜×™×™×œ×•×™× ×“ ×‘×¡×™×¡×™×•×ª ×•×¦×‘×¢×™× ××•×ª×××™× ××™×©×™×ª */
        :root {
            --kesher-blue: #3b82f6; /* Blue 500 */
            --kesher-green: #10b981; /* Emerald 500 */
        }
        .bg-kesher-blue { background-color: var(--kesher-blue); }
        .hover\:bg-kesher-blue:hover { background-color: #2563eb; } /* Blue 600 */
        .text-kesher-blue { color: var(--kesher-blue); }
        .bg-kesher-green { background-color: var(--kesher-green); }
        .hover\:bg-kesher-green:hover { background-color: #059669; } /* Emerald 600 */
        .text-kesher-green { color: var(--kesher-green); }
        body {
            background-color: #f3f4f6; /* Gray 100 */
            font-family: 'Arial', sans-serif;
        }
        #root {
            min-height: 100vh;
            padding-bottom: 2rem;
        }
    </style>
</head>
<body>
    <div id="root" class="pt-16">
        </div>

    <script>
        // --- 1. ×”×’×“×¨×•×ª Firebase ×•××™×—×–×•×¨ × ×ª×•× ×™× ×¤×™×§×˜×™×‘×™×™× ---
        
        // ×”×’×“×¨×•×ª Firebase (×™×© ×œ×”×—×œ×™×£ ×‘× ×ª×•× ×™× ×”×××™×ª×™×™× ×©×œ×š)
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };
        
        // ××ª×—×•×œ Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        
        const auth = firebase.auth();
        const db = firebase.firestore();

        // ××¦×‘ ×’×œ×•×‘×œ×™ (State Management)
        const state = {
            user: null, // ×”××©×ª××© ×”× ×•×›×—×™ ×”××—×•×‘×¨
            screen: 'login', // ×”××¡×š ×”××•×¦×’ ×›×¢×ª ('login', 'register', 'home', 'users', 'chat', 'forums', 'forumPosts', 'postDetails', 'activities', 'newActivity', 'admin')
            users: [], // ×¨×©×™××ª ×›×œ ×”××©×ª××©×™×
            forums: [], // ×¨×©×™××ª ×”×¤×•×¨×•××™×
            activities: [], // ×¨×©×™××ª ×”×¤×¢×™×œ×•×™×•×ª
            reports: [], // ×¨×©×™××ª ×“×™×•×•×—×™× (×œ×¦×•×¨×š × ×™×”×•×œ)
            
            // ××©×ª× ×™× ×¡×¤×¦×™×¤×™×™× ×œ××¡×š
            currentForumId: null,
            currentPost: null, // ×”×¤×•×¡×˜ ×”××•×¦×’ ×‘××¡×š ×¤×¨×˜×™ ×¤×•×¡×˜
            currentPostReplies: [],
            selectedUser: null, // ×”××©×ª××© ×‘×¦'××˜
            chatMessages: [],
            usersFilter: { city: '', role: '', hobby: '' }, // ×¡×™× ×•×Ÿ ×‘××¡×š ××©×ª××©×™× (× ×•×¡×£ ×ª×—×‘×™×‘)
        };

        // × ×ª×•× ×™× ×¤×™×§×˜×™×‘×™×™× (×œ×¦×•×¨×š ×”×“×’××”)
        function loadFakeData() {
            const now = firebase.firestore.Timestamp.now();
            
            // × ×ª×•× ×™ ××©×ª××©×™× ××¢×•×“×›× ×™× ×›×•×œ×œ×™× hobbies ×•-contributions
            state.users = [
                { id: 'user1', name: '××•×¨×™×ª ×œ×•×™', email: 'orit@example.com', city: '×ª×œ ××‘×™×‘', role: 'user', points: 150, isOnline: true, hobbies: ['×‘×™×©×•×œ', '×˜×™×•×œ×™×'], contributions: ['×™×™×¢×•×¥ ×¢×¡×§×™', '××¨×’×•×Ÿ ××™×¨×•×¢×™×'] },
                { id: 'user2', name: '×“× ×™××œ ×›×”×Ÿ', email: 'daniel@example.com', city: '×™×¨×•×©×œ×™×', role: 'user', points: 320, isOnline: false, hobbies: ['×§×¨×™××”', '×¨×™×¦×”'], contributions: ['×ª×¨×’×•×', '×§×™×“×•×“'] },
                { id: 'user3', name: '×××™×” ××œ×•×Ÿ', email: 'maya@example.com', city: '×—×™×¤×”', role: 'admin', points: 900, isOnline: true, hobbies: ['×¦×™×œ×•×', '××¤×™×™×”'], contributions: ['× ×™×”×•×œ ×§×”×™×œ×”', '×’×¨×¤×™×§×”'] },
                { id: 'user4', name: '×™×•×¡×™ ×©×§×“', email: 'yossi@example.com', city: '×ª×œ ××‘×™×‘', role: 'user', points: 50, isOnline: true, hobbies: ['×¡×¤×•×¨×˜', '××•×–×™×§×”'], contributions: ['×ª×™×§×•× ×™× ×§×œ×™×', '×”×•×‘×œ×•×ª ×§×˜× ×•×ª'] },
                { id: 'user5', name: '×©×œ×•××™×ª ×•×§× ×™×Ÿ', email: 'shlomit@example.com', city: '×‘××¨ ×©×‘×¢', role: 'user', points: 280, isOnline: false, hobbies: ['×’×™× ×•×Ÿ'], contributions: ['×™×™×¢×•×¥ ××©×¤×˜×™'] },
            ];

            const post1Replies = [
                { id: 'r1', content: '××¡×›×™×! ×”×—×©×™×¤×” ×œ××ª× ×“×‘×™× ×—×“×©×™× ×”×™× ××ª×’×¨ ×××™×ª×™.', creatorId: 'user2', creatorName: '×“× ×™××œ ×›×”×Ÿ', createdAt: now },
                { id: 'r2', content: '××•×œ×™ ×›×“××™ ×œ×™×¦×•×¨ ×“×£ × ×—×™×ª×” ×™×™×¢×•×“×™?', creatorId: 'user1', creatorName: '××•×¨×™×ª ×œ×•×™', createdAt: now },
            ];
            
            state.forums = [
                { id: 'f1', title: '×”×ª× ×“×‘×•×ª ×•×§×”×™×œ×”', description: '×“×™×•× ×™× ×¢×œ ×™×•×–××•×ª ×—×‘×¨×ª×™×•×ª ×—×“×©×•×ª.', icon: 'ğŸ¤', posts: [
                    { id: 'p1', title: '××™×š ××’×™×™×¡×™× ××ª× ×“×‘×™× ×—×“×©×™×?', content: '×× ×™ ×× ×”×œ ×§×‘×•×¦×” ×§×˜× ×” ×•××—×¤×© ×“×¨×›×™× ×™×¦×™×¨×ª×™×•×ª ×œ×’×™×™×¡ ×¢×•×“ ×—×‘×¨×™× ×¤×¢×™×œ×™×.', creatorId: 'user1', creatorName: '××•×¨×™×ª ×œ×•×™', createdAt: now, likes: ['user2', 'user3'], replies: post1Replies },
                ]},
                { id: 'f2', title: '×˜×™×•×œ×™× ×•×˜×‘×¢', description: '××¡×œ×•×œ×™× ××•××œ×¦×™× ×•×¦×™×•×“ ×§××¤×™× ×’.', icon: 'ğŸŒ²', posts: [] },
                { id: 'f3', title: '×˜×›× ×•×œ×•×’×™×” ×•×’××“×’×˜×™×', description: '××” ×—×“×© ×‘×¢×•×œ× ×”×“×™×’×™×˜×œ×™.', icon: 'ğŸ’»', posts: [] },
                { id: 'f4', title: '××ª×›×•× ×™× ×•×©×¤×™×', description: '×©×™×œ×•×‘×™× ×× ×¦×—×™× ×‘××˜×‘×—.', icon: 'ğŸ²', posts: [] },
            ];
            
            state.activities = [
                { id: 'a1', title: '×˜×™×•×œ ×¨×’×œ×™ ×‘×¤××¨×§ ×”×™×¨×§×•×Ÿ', description: '××¤×’×© ×—×‘×¨×ª×™ ×§×œ×™×œ ×¢× ×¤×™×§× ×™×§ ×‘×¡×•×£.', location: '×ª×œ ××‘×™×‘', date: new Date(Date.now() + 86400000 * 3), creatorId: 'user1', creatorName: '××•×¨×™×ª ×œ×•×™', attendees: ['user1', 'user3'] },
                { id: 'a2', title: '×¡×“× ×ª ××¤×™×™×” ×œ××ª×—×™×œ×™×', description: '× ×œ××“ ×œ×”×›×™×Ÿ ×œ×—××™ ××—××¦×ª ×‘×¡×™×¡×™×™×.', location: '×—×™×¤×”', date: new Date(Date.now() + 86400000 * 10), creatorId: 'user3', creatorName: '×××™×” ××œ×•×Ÿ', attendees: ['user3'] },
                { id: 'a3', title: '×”×¨×¦××” ×¢×œ ×‘×™× ×” ××œ××›×•×ª×™×ª', description: '××‘×˜ ×œ×¢×ª×™×“ ×©×œ AI.', location: '×–×•× ××•× ×œ×™×™×Ÿ', date: new Date(Date.now() - 86400000 * 2), creatorId: 'user2', creatorName: '×“× ×™××œ ×›×”×Ÿ', attendees: ['user1', 'user2', 'user3', 'user4'] },
            ];

            state.reports = [
                { id: 'rep1', itemId: 'p1', itemType: 'post', reason: '×©×¤×” ×‘×•×˜×”', reporterName: '×“× ×™××œ ×›×”×Ÿ', reportedUserId: 'user1', status: '×—×“×©' },
                { id: 'rep2', itemId: 'user4', itemType: 'user', reason: '×”×˜×¨×“×” ×‘×¦\'××˜', reporterName: '××•×¨×™×ª ×œ×•×™', reportedUserId: 'user4', status: '×‘×˜×™×¤×•×œ' },
            ];

            // ×”×’×“×¨×ª ××©×ª××© ×”×ª×—×‘×¨×•×ª ×¤×™×§×˜×™×‘×™ ×›×‘×¨×™×¨×ª ××—×“×œ
            if (state.user) {
                const existingUser = state.users.find(u => u.email === state.user.email);
                if (existingUser) {
                    state.user = { ...state.user, ...existingUser };
                }
            }
        }
        
        loadFakeData(); // ×˜×¢×™× ×ª ×”× ×ª×•× ×™×

        // --- 2. ×¤×•× ×§×¦×™×•×ª × ×™×ª×•×‘ ×•× ×™×”×•×œ ××¦×‘ (Routing & State) ---

        function goTo(screen, params = {}) {
            state.screen = screen;
            // × ×™×§×•×™ ××• ×”×’×“×¨×ª ××©×ª× ×™× ×’×œ×•×‘×œ×™×™× ×‘×”×ª×× ×œ××¡×š
            state.currentForumId = params.forumId || null;
            state.currentPost = null;
            state.currentPostReplies = [];

            if (screen === 'forumPosts' && params.forumId) {
                state.currentForumId = params.forumId;
            } else if (screen === 'postDetails' && params.postId) {
                // ××¦× ××ª ×”×¤×•×¡×˜ ×”×¨×œ×•×•× ×˜×™
                const forum = state.forums.find(f => f.posts?.some(p => p.id === params.postId));
                if (forum) {
                    state.currentPost = forum.posts.find(p => p.id === params.postId);
                    // × × ×™×— ×©×”×ª×’×•×‘×•×ª ×‘×ª×•×š ×”×¤×•×¡×˜, ××—×¨×ª × ×¦×˜×¨×š ×œ×˜×¢×•×Ÿ ××•×ª×Ÿ ×‘× ×¤×¨×“ ×-DB
                    state.currentPostReplies = state.currentPost.replies || [];
                    state.currentForumId = forum.id;
                } else {
                    alert('×©×’×™××”: ×”×¤×•×¡×˜ ×œ× × ××¦×');
                    goTo('forums');
                }
            }
            render();
            // ×’×œ×™×œ×” ××•×˜×•××˜×™×ª ×œ××˜×” ×‘×¦'××˜
            if (screen === 'chat') {
                setTimeout(() => {
                    const chatBox = document.getElementById('chatBox');
                    if (chatBox) chatBox.scrollTop = chatBox.scrollHeight;
                }, 50);
            }
        }

        function openChat(targetUser) {
            state.selectedUser = targetUser;
            // ×˜×¢×™× ×ª ×”×•×“×¢×•×ª ×¤×™×§×˜×™×‘×™×•×ª
            state.chatMessages = [
                { id: 'm1', senderId: targetUser.id, content: `×”×™×™ ${state.user.name}, ×‘×¨×•×š ×”×‘× ×œ×¦'××˜!`, timestamp: firebase.firestore.Timestamp.now() },
                { id: 'm2', senderId: state.user.id, content: `×”×™×™ ${targetUser.name}, ××™×–×” ×›×™×£ ×œ×”×™×•×ª ×›××Ÿ!`, timestamp: firebase.firestore.Timestamp.now() },
            ];
            goTo('chat');
        }

        // --- 3. ×¤×•× ×§×¦×™×•×ª Firebase (Authentication & Firestore) ---
        
        // ×¤×•× ×§×¦×™×” ××¢×•×“×›× ×ª: ×”×ª×—×‘×¨×•×ª
        window.doLogin = async () => {
            const email = document.getElementById('email').value;
            const password = document.getElementById('pwd').value;
            const errorElement = document.getElementById('loginError');

            // ××™×¤×•×¡ ×”×•×“×¢×ª ×©×’×™××” ×§×•×“××ª ××©×—×–×•×¨ ×¡×™×¡××”
            errorElement.style.color = 'red'; 
            errorElement.textContent = ''; 

            if (!email || !password) {
                errorElement.textContent = '×™×© ×œ××œ× ××ª ×›×œ ×”×©×“×•×ª.';
                return;
            }

            try {
                // ×”×“××™×™×ª ×›× ×™×¡×”: ×‘×“×™×§×” ××•×œ × ×ª×•× ×™× ×¤×™×§×˜×™×‘×™×™×
                const fakeUser = state.users.find(u => u.email === email);

                if (fakeUser) {
                    // ×‘××¦×™××•×ª × ×•×•×“× ×¡×™×¡××” (××š ×–×”×• ×§×•×“ ×“××”)
                    state.user = { 
                        id: fakeUser.id, 
                        email: fakeUser.email, 
                        name: fakeUser.name, 
                        role: fakeUser.role, 
                        points: fakeUser.points,
                        hobbies: fakeUser.hobbies, 
                        contributions: fakeUser.contributions 
                    };
                    errorElement.textContent = '';
                    goTo('home');
                    // ×¢×“×›×•×Ÿ ×¡×˜×˜×•×¡ ××•× ×œ×™×™×Ÿ
                    fakeUser.isOnline = true;
                    render();
                } else {
                    errorElement.textContent = '×©× ××©×ª××© ××• ×¡×™×¡××” ×©×’×•×™×™×.';
                }

            } catch (error) {
                // ×›××Ÿ × ×˜×¤×œ ×‘×©×’×™××•×ª Firebase
                errorElement.textContent = `×©×’×™××ª ×”×ª×—×‘×¨×•×ª: ${error.message}`;
            }
        };

        // ×¤×•× ×§×¦×™×” ××¢×•×“×›× ×ª: ×¨×™×©×•×
        window.doRegister = async () => {
            const name = document.getElementById('regName').value;
            const email = document.getElementById('regEmail').value;
            const password = document.getElementById('regPwd').value;
            const city = document.getElementById('regCity').value;
            const hobbiesInput = document.getElementById('regHobbies').value;
            const contributionsInput = document.getElementById('regContributions').value;
            const errorElement = document.getElementById('registerError');

            if (!name || !email || !password || !city || !hobbiesInput || !contributionsInput) {
                errorElement.textContent = '×™×© ×œ××œ× ××ª ×›×œ ×”×©×“×•×ª.';
                return;
            }
            
            // ×”××¨×ª ×©×“×•×ª ×”××•×¤×¨×“×™× ×‘×¤×¡×™×§×™× ×œ××¢×¨×š
            const hobbiesArray = hobbiesInput.split(',').map(item => item.trim()).filter(item => item !== '');
            const contributionsArray = contributionsInput.split(',').map(item => item.trim()).filter(item => item !== '');

            // ×”×“××™×™×ª ×¨×™×©×•×
            const newUserId = 'user' + (state.users.length + 1);
            const newUser = {
                id: newUserId,
                name: name,
                email: email,
                city: city,
                role: 'user',
                points: 0,
                isOnline: true,
                hobbies: hobbiesArray, 
                contributions: contributionsArray,
            };

            state.users.push(newUser);
            state.user = newUser; // ×›× ×™×¡×” ××•×˜×•××˜×™×ª
            errorElement.textContent = '';
            goTo('home');
            render();
        };

        // ×¤×•× ×§×¦×™×” ×—×¡×¨×”: ×™×¦×™××”
        window.doLogout = () => {
            if (state.user) {
                // ×¢×“×›×•×Ÿ ×¡×˜×˜×•×¡ ××•× ×œ×™×™×Ÿ (×¤×™×§×˜×™×‘×™)
                const loggedOutUser = state.users.find(u => u.id === state.user.id);
                if (loggedOutUser) {
                    loggedOutUser.isOnline = false;
                }
                
                // ×‘××¦×™××•×ª: × ×©×ª××© ×‘-auth.signOut();
                state.user = null;
                goTo('login');
                render();
            }
        };

        // ×¤×•× ×§×¦×™×” ××¢×•×“×›× ×ª: ××™×¤×•×¡ ×¡×™×¡××” (×”×“××™×”)
        window.doResetPassword = () => {
            const email = document.getElementById('email').value;
            const errorElement = document.getElementById('loginError');

            if (!email) {
                errorElement.textContent = '×™×© ×œ×”×–×™×Ÿ ×›×ª×•×‘×ª ×“×•×"×œ ×‘×©×“×” ×”××™×™×œ ×›×“×™ ×œ×©×—×–×¨ ×¡×™×¡××”.';
                errorElement.style.color = 'red';
                return;
            }
            
            // ×‘×“×™×§×” ×”×× ×”××™×™×œ ×§×™×™× (×¤×™×§×˜×™×‘×™)
            const userExists = state.users.some(u => u.email === email);
            
            if (userExists) {
                // ×”×“××™×™×ª ×©×œ×™×—×ª ××™×™×œ
                errorElement.textContent = 'ğŸ‘ × ×©×œ×— ×§×™×©×•×¨ ×œ××™×¤×•×¡ ×¡×™×¡××” ×œ×›×ª×•×‘×ª ' + email;
                errorElement.style.color = 'green';
            } else {
                errorElement.textContent = '×›×ª×•×‘×ª ×”××™×™×œ ××™× ×” ×§×™×™××ª ×‘××¢×¨×›×ª.';
                errorElement.style.color = 'red';
            }
            // ××—×¨×™ ×›××” ×©× ×™×•×ª × × ×§×” ××ª ×”×”×•×“×¢×”
            setTimeout(() => {
                errorElement.textContent = '';
                errorElement.style.color = 'red';
            }, 5000);
        };


        // --- 4. ×¤×•× ×§×¦×™×•×ª ×¦'××˜ (×“×¨×™×©×” 4) ---
        
        window.sendMessage = () => {
            const input = document.getElementById('chatInput');
            const content = input.value.trim();
            if (!content || !state.selectedUser || !state.user) return;

            const newMessage = {
                id: 'm' + (state.chatMessages.length + 1),
                senderId: state.user.id,
                content: content,
                timestamp: firebase.firestore.Timestamp.now(),
            };
            
            state.chatMessages.push(newMessage);
            input.value = '';
            render(); // ×¨× ×“×•×¨ ××—×“×© ×™×¦×™×’ ××ª ×”×”×•×“×¢×” ×”×—×“×©×”
        };

        // --- 5. ×¤×•× ×§×¦×™×•×ª ×¤×•×¨×•× (×“×¨×™×©×” 2) ---

        window.createPost = () => {
            const title = document.getElementById('postTitle').value.trim();
            const content = document.getElementById('postContent').value.trim();
            const forum = state.forums.find(f => f.id === state.currentForumId);

            if (!title || !content || !forum) {
                alert('×™×© ×œ××œ× ×›×•×ª×¨×ª ×•×ª×•×›×Ÿ.');
                return;
            }

            const newPost = {
                id: 'p' + (Math.random() * 1000).toFixed(0),
                title: title,
                content: content,
                creatorId: state.user.id,
                creatorName: state.user.name,
                createdAt: firebase.firestore.Timestamp.now(),
                likes: [],
                replies: []
            };

            if (!forum.posts) forum.posts = [];
            forum.posts.unshift(newPost);
            
            alert('×”×¤×•×¡×˜ ×¤×•×¨×¡× ×‘×”×¦×œ×—×”!');
            goTo('forumPosts', { forumId: state.currentForumId });
        };

        window.addReply = () => {
            const content = document.getElementById('replyContent').value.trim();
            const post = state.currentPost;
            
            if (!content || !post) return;

            const newReply = {
                id: 'r' + (Math.random() * 1000).toFixed(0),
                content: content,
                creatorId: state.user.id,
                creatorName: state.user.name,
                createdAt: firebase.firestore.Timestamp.now(),
            };

            if (!post.replies) post.replies = [];
            post.replies.push(newReply);
            state.currentPostReplies.push(newReply); // ×¢×“×›×•×Ÿ ××™×™×“×™ ×©×œ ×”××¦×‘

            // ×¢×“×›×•×Ÿ × ×™×§×•×“ (×“×¨×™×©×” 1)
            state.user.points = (state.user.points || 0) + 5;
            const creator = state.users.find(u => u.id === state.user.id);
            if(creator) creator.points = state.user.points; // ×¢×“×›×•×Ÿ ×‘× ×ª×•× ×™× ×”×¤×™×§×˜×™×‘×™×™× ×”×›×œ×œ×™×™×

            document.getElementById('replyContent').value = '';
            render();
        };

        window.toggleLike = (postId) => {
            const post = state.currentPost;
            if (!post) return;

            if (!post.likes) post.likes = [];

            const userIndex = post.likes.indexOf(state.user.id);

            if (userIndex > -1) {
                // ×”×¡×¨×” (Un-like)
                post.likes.splice(userIndex, 1);
            } else {
                // ×”×•×¡×¤×” (Like)
                post.likes.push(state.user.id);
                // ×¢×“×›×•×Ÿ × ×™×§×•×“ (×“×¨×™×©×” 1) - × ×§×•×“×” ××—×ª ×œ×›×œ ×œ×™×™×§ ×¢×œ ×¤×•×¡×˜
                state.user.points = (state.user.points || 0) + 1;
                const userInList = state.users.find(u => u.id === state.user.id);
                if(userInList) userInList.points = state.user.points;
            }
            render();
        };

        // --- 6. ×¤×•× ×§×¦×™×•×ª ×¤×¢×™×œ×•×™×•×ª (×“×¨×™×©×” 3) ---

        window.createActivity = () => {
            const title = document.getElementById('activityTitle').value.trim();
            const description = document.getElementById('activityDescription').value.trim();
            const date = document.getElementById('activityDate').value;
            const location = document.getElementById('activityLocation').value.trim();

            if (!title || !description || !date || !location) {
                alert('×™×© ×œ××œ× ××ª ×›×œ ×¤×¨×˜×™ ×”×¤×¢×™×œ×•×ª.');
                return;
            }

            const newActivity = {
                id: 'a' + (Math.random() * 1000).toFixed(0),
                title: title,
                description: description,
                date: new Date(date),
                location: location,
                creatorId: state.user.id,
                creatorName: state.user.name,
                attendees: [state.user.id] // ××•×˜×•××˜×™×ª ×”×××¨×’×Ÿ × ×¨×©×
            };

            state.activities.push(newActivity);
            alert('×”×¤×¢×™×œ×•×ª ×¤×•×¨×¡××” ×‘×”×¦×œ×—×”!');
            goTo('activities');
        };

        window.registerForActivity = (activityId) => {
            const activity = state.activities.find(a => a.id === activityId);
            if (!activity || activity.attendees.includes(state.user.id)) return;

            activity.attendees.push(state.user.id);
            alert(`× ×¨×©××ª ×‘×”×¦×œ×—×” ×œ×¤×¢×™×œ×•×ª: ${activity.title}!`);
            render();
        };
        
        // --- 7. ×¤×•× ×§×¦×™×•×ª × ×™×”×•×œ (×“×¨×™×©×” 5) ---

        window.reportItem = (itemId, itemType, reportedUserId) => {
            const reason = prompt(`×“×•×•×— ×¢×œ ${itemType} (ID: ${itemId}). ×× × ×¦×™×™×Ÿ ×¡×™×‘×”:`);
            if (reason) {
                const newReport = {
                    id: 'rep' + (Math.random() * 1000).toFixed(0),
                    itemId: itemId,
                    itemType: itemType,
                    reason: reason,
                    reporterName: state.user.name,
                    reportedUserId: reportedUserId,
                    status: '×—×“×©'
                };
                state.reports.push(newReport);
                alert('×”×“×™×•×•×— × ×©×œ×— ×‘×”×¦×œ×—×” ×œ×¦×•×•×ª ×”× ×™×”×•×œ.');
                render();
            }
        };

        window.updateReportStatus = (reportId, newStatus) => {
            const report = state.reports.find(r => r.id === reportId);
            if (report) {
                report.status = newStatus;
                alert(`×¡×˜×˜×•×¡ ×“×™×•×•×— ${reportId.substring(0, 5)}... ×¢×•×“×›×Ÿ ×œ: ${newStatus}`);
                render();
            }
        };
        
        // --- 8. ×¨×›×™×‘×™× ×—×–×•×ª×™×™× (Rendering Components) ---
        
        const getHeader = () => `
            <header class="bg-kesher-blue text-white shadow-lg fixed w-full top-0 z-10">
                <div class="max-w-6xl mx-auto px-4 py-3 flex justify-between items-center">
                    <h1 class="text-2xl font-bold cursor-pointer" onclick="goTo('home')">
                        ğŸ¤ ×§×”×™×œ×ª ×§×©×¨
                    </h1>
                    <nav class="flex items-center gap-4">
                        <button onclick="goTo('home')" class="hover:text-amber-300 transition ${state.screen === 'home' ? 'text-amber-300 font-bold' : ''}">×‘×™×ª</button>
                        <button onclick="goTo('users')" class="hover:text-amber-300 transition ${state.screen === 'users' || state.screen === 'chat' ? 'text-amber-300 font-bold' : ''}">×—×‘×¨×™×</button>
                        <button onclick="goTo('forums')" class="hover:text-amber-300 transition ${state.screen === 'forums' || state.screen.includes('Post') ? 'text-amber-300 font-bold' : ''}">×¤×•×¨×•×</button>
                        <button onclick="goTo('activities')" class="hover:text-amber-300 transition ${state.screen === 'activities' || state.screen === 'newActivity' ? 'text-amber-300 font-bold' : ''}">×¤×¢×™×œ×•×™×•×ª</button>
                        ${state.user?.role === 'admin' ? 
                            `<button onclick="goTo('admin')" class="hover:text-red-300 transition ${state.screen === 'admin' ? 'text-red-300 font-bold' : ''}">× ×™×”×•×œ âš™ï¸</button>` : ''}
                        
                        <span class="mx-2 text-gray-300">|</span>
                        
                        <div class="text-sm">
                            ×©×œ×•×, <span class="font-bold">${state.user?.name || '××•×¨×—'}</span>
                            <span class="ml-2 text-xs">â­ ${state.user?.points || 0}</span>
                        </div>
                        <button onclick="doLogout()" class="bg-red-500 hover:bg-red-600 px-3 py-1 rounded-full text-sm font-bold transition">×™×¦×™××”</button>
                    </nav>
                </div>
            </header>
        `;

        const renderLogin = () => `
            <div class="flex items-center justify-center min-h-screen bg-gray-100 p-4 pt-16">
                <div class="w-full max-w-md bg-white p-8 rounded-2xl shadow-2xl">
                    <h2 class="text-4xl font-extrabold text-center text-kesher-blue mb-8">×‘×¨×•×›×™× ×”×‘××™× ×œ×§×”×™×œ×ª ×§×©×¨</h2>
                    <form onsubmit="event.preventDefault(); doLogin()" class="space-y-6">
                        <div>
                            <label for="email" class="block text-sm font-medium text-gray-700">×“×•×"×œ</label>
                            <input type="email" id="email" class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:ring-kesher-blue focus:border-kesher-blue" required>
                        </div>
                        <div>
                            <label for="pwd" class="block text-sm font-medium text-gray-700">×¡×™×¡××”</label>
                            <input type="password" id="pwd" class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:ring-kesher-blue focus:border-kesher-blue" required>
                        </div>
                        <p id="loginError" class="text-red-600 text-sm text-center"></p>
                        <button type="submit" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-lg font-bold text-white bg-kesher-green hover:bg-green-700 transition">
                            ×”×ª×—×‘×¨
                        </button>
                        <button type="button" onclick="doResetPassword()" class="w-full text-sm text-kesher-blue hover:text-blue-700 mt-2">
                            ×©×›×—×ª×™ ×¡×™×¡××”
                        </button>
                    </form>
                    <div class="mt-6 text-center">
                        <p class="text-sm text-gray-600">
                            ××™×Ÿ ×œ×š ×—×©×‘×•×Ÿ? 
                            <button onclick="goTo('register')" class="font-medium text-kesher-blue hover:text-blue-700">×”×™×¨×©× ×›××Ÿ</button>
                        </p>
                    </div>
                </div>
            </div>
        `;

        // ×¨×›×™×‘ ×¨×™×©×•× ××¢×•×“×›×Ÿ
        const renderRegister = () => `
            <div class="flex items-center justify-center min-h-screen bg-gray-100 p-4 pt-16">
                <div class="w-full max-w-md bg-white p-8 rounded-2xl shadow-2xl">
                    <h2 class="text-4xl font-extrabold text-center text-kesher-green mb-8">×”×¨×©××” ×œ×§×”×™×œ×”</h2>
                    <form onsubmit="event.preventDefault(); doRegister()" class="space-y-6">
                        <div>
                            <label for="regName" class="block text-sm font-medium text-gray-700">×©× ××œ×</label>
                            <input type="text" id="regName" class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm" required>
                        </div>
                        <div>
                            <label for="regEmail" class="block text-sm font-medium text-gray-700">×“×•×"×œ</label>
                            <input type="email" id="regEmail" class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm" required>
                        </div>
                        <div>
                            <label for="regPwd" class="block text-sm font-medium text-gray-700">×¡×™×¡××” (6 ×ª×•×•×™× ×œ×¤×—×•×ª)</label>
                            <input type="password" id="regPwd" class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm" required>
                        </div>
                        <div>
                            <label for="regCity" class="block text-sm font-medium text-gray-700">×¢×™×¨ ××’×•×¨×™×</label>
                            <input type="text" id="regCity" class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm" required>
                        </div>
                        
                        <div>
                            <label for="regHobbies" class="block text-sm font-medium text-gray-700">×ª×—×‘×™×‘×™× (×”×¤×¨×“ ×‘×¤×¡×™×§, ×œ×“×•×’××”: ×¡×¤×•×¨×˜, ×‘×™×©×•×œ)</label>
                            <input type="text" id="regHobbies" placeholder="×œ×“×•×’××”: ×’×™× ×•×Ÿ, ×§×¨×™××”, ×˜×™×•×œ×™×" class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm" required>
                        </div>
                        
                        <div>
                            <label for="regContributions" class="block text-sm font-medium text-gray-700">×ª×—×•××™× ×‘×”× ×× ×™ ×™×›×•×œ/×” ×œ×ª×¨×•× (×”×¤×¨×“ ×‘×¤×¡×™×§, ×œ×“×•×’××”: ×™×™×¢×•×¥ ××©×¤×˜×™, × ×’×¨×•×ª)</label>
                            <input type="text" id="regContributions" placeholder="×œ×“×•×’××”: ×¢×–×¨×” ×˜×›× ×™×ª, ×©×™×¢×•×¨×™ ×¢×–×¨, ×™×™×¢×•×¥" class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm" required>
                        </div>

                        <p id="registerError" class="text-red-600 text-sm text-center"></p>
                        <button type="submit" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-lg font-bold text-white bg-kesher-blue hover:bg-blue-600 transition">
                            ×”×©×œ× ×”×¨×©××”
                        </button>
                    </form>
                    <div class="mt-6 text-center">
                        <p class="text-sm text-gray-600">
                            ×›×‘×¨ ×™×© ×œ×š ×—×©×‘×•×Ÿ? 
                            <button onclick="goTo('login')" class="font-medium text-kesher-green hover:text-green-700">×”×ª×—×‘×¨ ×›××Ÿ</button>
                        </p>
                    </div>
                </div>
            </div>
        `;

        // ×“×¨×™×©×” 1: ××¡×š ×—×‘×¨×™× - ×¢×•×“×›×Ÿ ×œ×”×¦×’×ª × ×ª×•× ×™ ×¤×¨×•×¤×™×œ ×•×¡×™× ×•×Ÿ
        const renderUsers = () => {
            const filteredUsers = state.users.filter(u => 
                u.id !== state.user.id && // ×œ× ×œ×”×¦×™×’ ××ª ×”××©×ª××© ×”× ×•×›×—×™
                (state.usersFilter.city === '' || u.city === state.usersFilter.city) &&
                (state.usersFilter.role === '' || u.role === state.usersFilter.role) &&
                (state.usersFilter.hobby === '' || u.hobbies?.includes(state.usersFilter.hobby))
            );

            const cities = [...new Set(state.users.map(u => u.city))];
            const allHobbies = [...new Set(state.users.flatMap(u => u.hobbies || []))];
            
            return `
                ${getHeader()}
                <div class="max-w-6xl mx-auto px-4">
                    <h2 class="text-3xl font-bold text-kesher-blue mb-6">ğŸ§‘â€ğŸ¤â€ğŸ§‘ ×—×‘×¨×™× ×‘×§×”×™×œ×” (${filteredUsers.length} × ××¦××•)</h2>
                    
                    <div class="bg-white p-4 rounded-xl shadow-md mb-6 flex flex-wrap gap-4 items-center">
                        <span class="font-medium text-gray-700">×¡×™× ×•×Ÿ:</span>
                        
                        <select onchange="state.usersFilter.city = this.value; render()" class="p-2 border rounded-lg">
                            <option value="">×›×œ ×”×¢×¨×™×</option>
                            ${cities.map(c => `<option value="${c}" ${state.usersFilter.city === c ? 'selected' : ''}>${c}</option>`).join('')}
                        </select>
                        
                        <select onchange="state.usersFilter.role = this.value; render()" class="p-2 border rounded-lg">
                            <option value="">×›×œ ×”×ª×¤×§×™×“×™×</option>
                            <option value="user" ${state.usersFilter.role === 'user' ? 'selected' : ''}>××©×ª××© ×¨×’×™×œ</option>
                            <option value="admin" ${state.usersFilter.role === 'admin' ? 'selected' : ''}>×× ×”×œ</option>
                        </select>
                        
                        <select onchange="state.usersFilter.hobby = this.value; render()" class="p-2 border rounded-lg">
                            <option value="">×›×œ ×”×ª×—×‘×™×‘×™×</option>
                            ${allHobbies.map(h => `<option value="${h}" ${state.usersFilter.hobby === h ? 'selected' : ''}>${h}</option>`).join('')}
                        </select>
                    </div>

                    <div class="space-y-4">
                        ${filteredUsers.length > 0 ? filteredUsers.map(u => `
                            <div class="bg-white p-6 rounded-xl shadow-md flex flex-col md:flex-row justify-between items-start md:items-center hover:shadow-lg transition">
                                <div class="flex items-start gap-4 mb-4 md:mb-0">
                                    <div class="w-12 h-12 bg-gray-200 rounded-full flex items-center justify-center text-xl font-bold text-kesher-blue shrink-0">${u.name[0]}</div>
                                    <div class="flex-grow">
                                        <h3 class="text-xl font-bold text-gray-800">${u.name}</h3>
                                        <p class="text-sm text-gray-600">${u.city} | â­ ${u.points || 0} × ×§×•×“×•×ª</p>
                                        
                                        <div class="mt-2 text-xs">
                                            <p class="font-semibold text-kesher-green">×ª×—×‘×™×‘×™×: <span class="font-normal text-gray-700">${u.hobbies?.join(', ') || '×œ× ×¦×•×™×Ÿ'}</span></p>
                                            <p class="font-semibold text-kesher-blue">×™×›×•×œ/×” ×œ×ª×¨×•×: <span class="font-normal text-gray-700">${u.contributions?.join(', ') || '×œ× ×¦×•×™×Ÿ'}</span></p>
                                        </div>
                                    </div>
                                </div>
                                <div class="flex gap-2 items-center">
                                    <span class="text-xs font-semibold px-3 py-1 rounded-full ${u.isOnline ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-500'}">${u.isOnline ? 'ğŸŸ¢ ××—×•×‘×¨' : 'âš« ×œ× ××—×•×‘×¨'}</span>
                                    <button onclick="openChat({ id: '${u.id}', name: '${u.name}' })" class="bg-kesher-blue hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition text-sm">×©×œ×— ×”×•×“×¢×”</button>
                                    <button onclick="reportItem('${u.id}', 'user', '${u.id}')" class="bg-red-100 text-red-700 hover:bg-red-200 px-3 py-2 rounded-lg transition text-sm">×“×•×•×— ğŸš©</button>
                                </div>
                            </div>
                        `).join('') : '<p class="text-center text-gray-500 p-8 bg-white rounded-xl shadow-md">×œ× × ××¦××• ×—×‘×¨×™× ×”×ª×•×××™× ×œ×¡×™× ×•×Ÿ.</p>'}
                    </div>
                </div>
            `;
        };
        
        // ×“×¨×™×©×” 4: ××¡×š ×¦'××˜
        const renderChat = () => {
            const targetUser = state.selectedUser;
            if (!targetUser) return goTo('users');

            return `
                ${getHeader()}
                <div class="max-w-4xl mx-auto px-4">
                    <div class="bg-white rounded-2xl shadow-xl overflow-hidden h-[70vh] flex flex-col">
                        <div class="bg-kesher-blue text-white p-4 flex justify-between items-center">
                            <h2 class="text-xl font-bold">ğŸ’¬ ×¦'××˜ ×¢× ${targetUser.name}</h2>
                            <button onclick="goTo('users')" class="bg-blue-600 hover:bg-blue-700 px-3 py-1 rounded transition text-sm">×—×–×¨×” ×œ×—×‘×¨×™×</button>
                        </div>

                        <div id="chatBox" class="flex-grow p-4 overflow-y-auto space-y-3">
                            ${state.chatMessages.map(msg => {
                                const isMe = msg.senderId === state.user.id;
                                const time = msg.timestamp ? new Date(msg.timestamp.seconds * 1000).toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit' }) : '×¢×›×©×™×•';
                                return `
                                    <div class="flex ${isMe ? 'justify-end' : 'justify-start'}">
                                        <div class="${isMe ? 'bg-kesher-green text-white rounded-tr-none' : 'bg-gray-200 text-gray-800 rounded-tl-none'} max-w-xs p-3 rounded-xl shadow-md">
                                            <p class="text-sm">${msg.content}</p>
                                            <span class="block text-xs mt-1 ${isMe ? 'text-green-200' : 'text-gray-500'} text-left">${time}</span>
                                        </div>
                                        ${!isMe ? `<button onclick="reportItem('${msg.id}', 'message', '${msg.senderId}')" class="text-red-400 hover:text-red-600 p-2 text-xl">ğŸš©</button>` : ''}
                                    </div>
                                `;
                            }).join('')}
                        </div>

                        <div class="p-4 border-t flex gap-2">
                            <input id="chatInput" type="text" placeholder="×›×ª×•×‘ ×”×•×“×¢×”..." class="flex-grow p-3 border-2 rounded-lg" onkeyup="if(event.key === 'Enter') sendMessage()" />
                            <button onclick="sendMessage()" class="bg-kesher-green hover:bg-green-700 text-white p-3 rounded-lg font-bold">×©×œ×—</button>
                        </div>
                    </div>
                </div>
            `;
        };

        const renderHome = () => {
            // ××¦×™××ª ×—×‘×¨×™× ××•× ×œ×™×™×Ÿ (×œ××¢×˜ ×”××©×ª××© ×”× ×•×›×—×™)
            const onlineUsers = state.users.filter(u => u.isOnline && u.id !== state.user.id).slice(0, 5);

            // ×“×•×’××” ×œ×¤×•×¨×•××™× ××—×¨×•× ×™×
            const featuredForums = state.forums.slice(0, 4);

            // ×“×•×’××” ×œ×¤×¢×™×œ×•×™×•×ª ×§×¨×•×‘×•×ª (×“×¨×™×©×” 3)
            const upcomingActivities = state.activities
                .filter(a => new Date(a.date) > new Date())
                .sort((a, b) => new Date(a.date) - new Date(b.date))
                .slice(0, 3);

            return `
                ${getHeader()}
                <div class="max-w-6xl mx-auto px-4">
                    <h2 class="text-3xl font-bold text-gray-800 mb-8">×‘×¨×•×š ×”×‘×, ${state.user.name}! ğŸ˜Š</h2>

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        
                        <div class="bg-kesher-green text-white p-6 rounded-2xl shadow-xl lg:col-span-1 flex flex-col justify-between">
                            <h3 class="text-2xl font-bold mb-2">â­ ×”× ×™×§×•×“ ×©×œ×™</h3>
                            <p class="text-5xl font-extrabold mb-4">${state.user.points || 0}</p>
                            <p class="text-sm">×¦×‘×•×¨ × ×§×•×“×•×ª ×¢×œ ×™×“×™ ×ª×’×•×‘×•×ª ×•×¢×–×¨×” ×œ××—×¨×™×.</p>
                        </div>

                        <div class="bg-white p-6 rounded-2xl shadow-xl lg:col-span-2">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-xl font-bold text-kesher-blue">ğŸ—“ï¸ ×¤×¢×™×œ×•×™×•×ª ×§×¨×•×‘×•×ª</h3>
                                <button onclick="goTo('activities')" class="text-kesher-blue hover:text-blue-700 text-sm font-medium">×”×›×œ Â»</button>
                            </div>
                            ${upcomingActivities.length > 0 ? `<div class="space-y-3">
                                ${upcomingActivities.map(a => `
                                    <div class="border-r-4 border-kesher-blue p-3 bg-gray-50 rounded flex justify-between items-center">
                                        <div>
                                            <p class="font-medium">${a.title}</p>
                                            <p class="text-xs text-gray-600">${new Date(a.date).toLocaleDateString('he-IL')} | ${a.location}</p>
                                        </div>
                                        ${a.attendees.includes(state.user.id) ? '<span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full">×¨×©×•×</span>' : `<button onclick="registerForActivity('${a.id}')" class="bg-kesher-green text-white text-xs px-3 py-1 rounded hover:bg-green-700">×”×™×¨×©×</button>`}
                                    </div>
                                `).join('')}
                            </div>` : '<p class="text-gray-500">××™×Ÿ ×¤×¢×™×œ×•×™×•×ª ×§×¨×•×‘×•×ª ××ª×•×›× × ×•×ª.</p>'}
                        </div>

                        <div class="lg:col-span-3 bg-white p-6 rounded-2xl shadow-xl">
                            <h3 class="text-xl font-bold text-kesher-blue mb-4">ğŸŸ¢ ××™ ××—×•×‘×¨ ×¢×›×©×™×•?</h3>
                            <div class="flex flex-wrap gap-4">
                                ${onlineUsers.length > 0 ? onlineUsers.map(u => `
                                    <div onclick="openChat({ id: '${u.id}', name: '${u.name}' })" class="flex items-center gap-2 p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100 transition">
                                        <div class="w-2 h-2 bg-green-500 rounded-full"></div>
                                        <span class="text-sm font-medium">${u.name} (${u.city})</span>
                                    </div>
                                `).join('') : '<p class="text-gray-500">××™×Ÿ ×—×‘×¨×™× ××—×•×‘×¨×™× ×›×¨×’×¢.</p>'}
                                <button onclick="goTo('users')" class="text-kesher-blue hover:text-blue-700 text-sm font-medium p-3">×¦×¤×” ×‘×›×œ ×”×—×‘×¨×™× Â»</button>
                            </div>
                        </div>

                        <div class="lg:col-span-3 bg-white p-6 rounded-2xl shadow-xl">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-xl font-bold text-kesher-blue">ğŸ—£ï¸ ×¤×•×¨×•××™× ×¤×•×¤×•×œ×¨×™×™×</h3>
                                <button onclick="goTo('forums')" class="text-kesher-blue hover:text-blue-700 text-sm font-medium">×”×›×œ Â»</button>
                            </div>
                            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4">
                                ${featuredForums.map(f => `
                                    <div onclick="goTo('forumPosts', { forumId: '${f.id}' })" class="bg-gray-50 p-4 rounded-xl shadow-sm hover:shadow-md transition cursor-pointer">
                                        <div class="text-3xl mb-2">${f.icon}</div>
                                        <p class="font-bold text-kesher-green">${f.title}</p>
                                        <p class="text-xs text-gray-500">${f.description}</p>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        };

        // ×“×¨×™×©×” 2: ××¡×š ×¤×•×¨×•××™×
        const renderForums = () => `
            ${getHeader()}
            <div class="max-w-6xl mx-auto px-4">
                <h2 class="text-3xl font-bold text-kesher-blue mb-6">ğŸ’¬ ×¤×•×¨×•××™× ×§×”×™×œ×ª×™×™×</h2>
                ${state.user.role === 'admin' ? `
                    <div class="mb-4">
                        <button onclick="alert('×¤×•× ×§×¦×™×™×ª ×”×•×¡×¤×ª ×¤×•×¨×•× ×œ× ××•××©×”')" class="bg-kesher-green hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium">â• ×”×•×¡×£ ×¤×•×¨×•× ×—×“×©</button>
                    </div>
                ` : ''}
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                    ${state.forums.map(f => `
                        <div class="bg-white p-6 rounded-2xl shadow-xl hover:shadow-2xl transition flex flex-col justify-between">
                            <div class="flex items-start mb-4">
                                <div class="text-5xl mr-4">${f.icon}</div>
                                <div>
                                    <h3 class="text-xl font-bold text-gray-800">${f.title}</h3>
                                    <p class="text-sm text-gray-600">${f.description}</p>
                                </div>
                            </div>
                            <div class="flex justify-between items-center">
                                <button onclick="goTo('forumPosts', { forumId: '${f.id}' })" class="bg-kesher-blue hover:bg-blue-600 text-white px-4 py-2 rounded-lg font-medium transition">×›× ×¡ ×œ×¤×•×¨×•×</button>
                                ${state.user.role === 'admin' ? `
                                    <div class="flex gap-2 text-sm">
                                        <button onclick="alert('×¤×•× ×§×¦×™×™×ª ×¢×¨×™×›×” ×œ× ××•××©×”')" class="text-blue-500 hover:text-blue-700">×¢×¨×•×š</button>
                                        <button onclick="alert('×¤×•× ×§×¦×™×™×ª ××—×™×§×” ×œ× ××•××©×”')" class="text-red-500 hover:text-red-700">××—×§</button>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;

        // ×“×¨×™×©×” 2: ××¡×š ×¤×•×¡×˜×™× ×‘×¤×•×¨×•×
        const renderForumPosts = () => {
            const forum = state.forums.find(f => f.id === state.currentForumId);
            if (!forum) return goTo('forums');

            return `
                ${getHeader()}
                <div class="max-w-6xl mx-auto px-4">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-3xl font-bold text-kesher-green">${forum.icon} ${forum.title}</h2>
                        <button onclick="goTo('newPost')" class="bg-kesher-blue hover:bg-blue-600 text-white px-4 py-2 rounded-lg font-medium transition">â• ×¤×ª×— × ×•×©× ×—×“×©</button>
                    </div>

                    ${forum.posts?.length > 0 ? `<div class="space-y-4">
                        ${forum.posts.map(p => `
                            <div onclick="goTo('postDetails', { postId: '${p.id}' })" class="bg-white p-5 rounded-xl shadow-md cursor-pointer hover:shadow-lg transition flex justify-between items-center">
                                <div>
                                    <h3 class="text-xl font-bold text-gray-800">${p.title}</h3>
                                    <p class="text-sm text-gray-600">× ×¤×ª×— ×¢×œ ×™×“×™: ${p.creatorName} | ×œ×¤× ×™: ${timeSince(p.createdAt.toDate())}</p>
                                </div>
                                <div class="flex gap-4 text-gray-500">
                                    <span>â¤ï¸ ${p.likes?.length || 0}</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>` : '<p class="text-center text-gray-500 p-8 bg-white rounded-xl shadow-md">××™×Ÿ ×¤×•×¡×˜×™× ×‘×¤×•×¨×•× ×–×” ×›×¨×’×¢. ×”×ª×—×œ ××ª ×”×“×™×•×Ÿ ×”×¨××©×•×Ÿ!</p>'}
                </div>
            `;
        };
        
        // ×¤×•× ×§×¦×™×” ×œ×¢×™×¦×•×‘ ×–××Ÿ (×©×™××•×©×™×ª ×œ×¤×•×¨×•×)
        function timeSince(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            let interval = seconds / 31536000;
            if (interval > 1) return Math.floor(interval) + " ×©× ×™×";
            interval = seconds / 2592000;
            if (interval > 1) return Math.floor(interval) + " ×—×•×“×©×™×";
            interval = seconds / 86400;
            if (interval > 1) return Math.floor(interval) + " ×™××™×";
            interval = seconds / 3600;
            if (interval > 1) return Math.floor(interval) + " ×©×¢×•×ª";
            interval = seconds / 60;
            if (interval > 1) return Math.floor(interval) + " ×“×§×•×ª";
            return "×¢×›×©×™×•";
        }

        // ×“×¨×™×©×” 2: ×™×¦×™×¨×ª ×¤×•×¡×˜ ×—×“×©
        const renderNewPost = () => {
            const forum = state.forums.find(f => f.id === state.currentForumId);
            if (!forum) return goTo('forums');
            
            return `
                ${getHeader()}
                <div class="max-w-4xl mx-auto px-4">
                    <h2 class="text-3xl font-bold text-kesher-green mb-6">ğŸ“ ×¤×ª×™×—×ª × ×•×©× ×—×“×© ×‘×¤×•×¨×•× ${forum.title}</h2>
                    <div class="bg-white p-6 rounded-2xl shadow-xl space-y-4">
                        <input id="postTitle" type="text" placeholder="×›×•×ª×¨×ª ×”× ×•×©×" class="w-full p-3 border-2 rounded-lg text-lg font-medium" />
                        <textarea id="postContent" placeholder="×ª×•×›×Ÿ ×”×¤×•×¡×˜ ×”××œ×..." rows="8" class="w-full p-3 border-2 rounded-lg"></textarea>
                        <div class="flex justify-end gap-3">
                            <button onclick="goTo('forumPosts', { forumId: state.currentForumId })" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded-lg font-bold">×‘×™×˜×•×œ</button>
                            <button onclick="createPost()" class="bg-kesher-green hover:bg-green-700 text-white px-4 py-2 rounded-lg font-bold">×¤×¨×¡×</button>
                        </div>
                    </div>
                </div>
            `;
        };
        
        // ×“×¨×™×©×” 2: ××¡×š ×¤×¨×˜×™ ×¤×•×¡×˜ ×•×ª×’×•×‘×•×ª
        const renderPostDetails = () => {
            const post = state.currentPost;
            const replies = state.currentPostReplies || [];
            if (!post) return goTo('forums');

            const isMyPost = post.creatorId === state.user.id;
            const canManage = isMyPost || state.user.role === 'admin';
            const liked = post.likes?.includes(state.user.id);
            
            return `
                ${getHeader()}
                <div class="max-w-4xl mx-auto px-4">
                    <button onclick="goTo('forumPosts', { forumId: '${post.forumId}' })" class="text-kesher-blue hover:text-blue-700 font-medium mb-4 flex items-center">â† ×—×–×¨×” ×œ×¤×•×¨×•×</button>

                    <div class="bg-white p-6 rounded-2xl shadow-xl mb-6">
                        <h2 class="text-3xl font-bold text-gray-800 mb-4">${post.title}</h2>
                        <p class="text-gray-700 whitespace-pre-wrap">${post.content}</p>
                        <div class="border-t mt-4 pt-4 flex justify-between items-center text-sm text-gray-500">
                            <div>
                                ×¤×•×¨×¡× ×¢×œ ×™×“×™: <span class="font-medium text-kesher-blue">${post.creatorName}</span>
                                <span class="mx-2">â€¢</span> ${new Date(post.createdAt.toDate()).toLocaleDateString('he-IL')}
                            </div>
                            <div class="flex gap-2">
                                <button onclick="toggleLike('${post.id}')" class="flex items-center gap-1 ${liked ? 'text-red-500' : 'text-gray-500 hover:text-red-500'}">
                                    ${liked ? 'â¤ï¸' : 'ğŸ¤'} ${post.likes?.length || 0}
                                </button>
                                ${canManage ? `<button onclick="alert('×¤×•× ×§×¦×™×™×ª ×¢×¨×™×›×” ×œ× ××•××©×”')" class="text-blue-500 hover:text-blue-700">×¢×¨×•×š</button>` : ''}
                                ${canManage ? `<button onclick="alert('×¤×•× ×§×¦×™×™×ª ××—×™×§×” ×œ× ××•××©×”')" class="text-red-500 hover:text-red-700">××—×§</button>` : ''}
                                ${!isMyPost ? `<button onclick="reportItem('${post.id}', 'post', '${post.creatorId}')" class="text-red-400 hover:text-red-600">×“×•×•×— ğŸš©</button>` : ''}
                            </div>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-2xl shadow-xl mb-6">
                        <h3 class="text-xl font-bold text-kesher-blue mb-3">×”×•×¡×£ ×ª×’×•×‘×”:</h3>
                        <textarea id="replyContent" placeholder="×”×ª×’×•×‘×” ×©×œ×š..." rows="3" class="w-full p-3 border-2 rounded-lg mb-3"></textarea>
                        <button onclick="addReply()" class="bg-kesher-green hover:bg-green-700 text-white px-4 py-2 rounded-lg font-bold">×©×œ×— ×ª×’×•×‘×”</button>
                    </div>

                    <h3 class="text-2xl font-bold text-gray-800 mb-4">${replies.length} ×ª×’×•×‘×•×ª</h3>
                    <div class="space-y-4">
                        ${replies.map(r => `
                            <div class="bg-white p-4 rounded-xl shadow-md border-r-4 ${r.creatorId === post.creatorId ? 'border-amber-400' : 'border-gray-200'}">
                                <p class="font-medium mb-1">${r.creatorName} ${r.creatorId === post.creatorId ? ' (×›×•×ª×‘ ×”×¤×•×¡×˜)' : ''}</p>
                                <p class="text-gray-700 whitespace-pre-wrap">${r.content}</p>
                                <div class="text-xs text-gray-500 mt-2 flex justify-between items-center">
                                    <span>${new Date(r.createdAt.toDate()).toLocaleString('he-IL')}</span>
                                    ${r.creatorId === state.user.id || state.user.role === 'admin' ? `<button onclick="alert('×¤×•× ×§×¦×™×™×ª ××—×™×§×” ×œ× ××•××©×”')" class="text-red-500 hover:text-red-700">××—×§</button>` : `<button onclick="reportItem('${r.id}', 'reply', '${r.creatorId}')" class="text-red-400 hover:text-red-600">×“×•×•×— ğŸš©</button>`}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        };

        // ×“×¨×™×©×” 3: ××¡×š ×¤×¢×™×œ×•×™×•×ª
        const renderActivities = () => `
            ${getHeader()}
            <div class="max-w-6xl mx-auto px-4">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold text-kesher-blue">ğŸ—“ï¸ ×¤×¢×™×œ×•×™×•×ª ×§×”×™×œ×ª×™×•×ª</h2>
                    <button onclick="goTo('newActivity')" class="bg-kesher-green hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium transition">â• ×”×¦×¢ ×¤×¢×™×œ×•×ª</button>
                </div>
                <div class="space-y-6">
                    ${state.activities.length > 0 ? state.activities.sort((a, b) => new Date(a.date) - new Date(b.date)).map(a => `
                        <div class="bg-white p-6 rounded-2xl shadow-xl flex flex-col md:flex-row justify-between items-start md:items-center">
                            <div class="mb-4 md:mb-0">
                                <h3 class="text-xl font-bold text-gray-800">${a.title}</h3>
                                <p class="text-kesher-green font-medium">${a.location} â€¢ ${new Date(a.date).toLocaleDateString('he-IL')} ×‘×©×¢×” ${new Date(a.date).toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit' })}</p>
                                <p class="text-sm text-gray-600 mt-2">${a.description}</p>
                                <p class="text-xs text-gray-500 mt-2">×××¨×’×Ÿ: ${a.creatorName} | × ×¨×©××™×: ${a.attendees.length}</p>
                            </div>
                            
                            <div class="flex gap-3">
                                ${a.attendees.includes(state.user.id) ? 
                                    '<span class="bg-green-100 text-green-800 px-4 py-2 rounded-lg font-bold whitespace-nowrap">âœ… ×¨×©×•×</span>' :
                                    `<button onclick="registerForActivity('${a.id}')" class="bg-kesher-blue hover:bg-blue-600 text-white px-4 py-2 rounded-lg font-bold transition whitespace-nowrap">×”×™×¨×©×</button>`}
                            </div>
                        </div>
                    `).join('') : '<p class="text-center text-gray-500 p-8 bg-white rounded-xl shadow-md">××™×Ÿ ×¤×¢×™×œ×•×™×•×ª ××ª×•×›× × ×•×ª ×›×¨×’×¢. ×”×¦×¢ ×¤×¢×™×œ×•×ª!</p>'}
                </div>
            </div>
        `;

        // ×“×¨×™×©×” 3: ×™×¦×™×¨×ª ×¤×¢×™×œ×•×ª ×—×“×©×”
        const renderNewActivity = () => `
            ${getHeader()}
            <div class="max-w-4xl mx-auto px-4">
                <h2 class="text-3xl font-bold text-kesher-green mb-6">ğŸ“¢ ×¤×¨×¡×•× ×¤×¢×™×œ×•×ª ×—×“×©×”</h2>
                <div class="bg-white p-6 rounded-2xl shadow-xl space-y-4">
                    <input id="activityTitle" type="text" placeholder="×›×•×ª×¨×ª ×”×¤×¢×™×œ×•×ª (×œ×“×•×’××”: ×˜×™×•×œ ×§×œ×™×œ ×‘×©×¤×œ×ª ×™×”×•×“×”)" class="w-full p-3 border-2 rounded-lg text-lg font-medium" />
                    <textarea id="activityDescription" placeholder="×ª×™××•×¨ ××œ× ×©×œ ×”×¤×¢×™×œ×•×ª, ×“×¨×™×©×•×ª, ×•×¦×™×•×“ × ×“×¨×©..." rows="5" class="w-full p-3 border-2 rounded-lg"></textarea>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">×ª××¨×™×š ×•×©×¢×”:</label>
                            <input id="activityDate" type="datetime-local" class="w-full p-3 border-2 rounded-lg" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">××™×§×•× (×¢×™×¨/××§×•× ××¤×’×©):</label>
                            <input id="activityLocation" type="text" placeholder="×œ×“×•×’××”: ×ª×œ ××‘×™×‘, ×¤××¨×§ ×”×™×¨×§×•×Ÿ" class="w-full p-3 border-2 rounded-lg" />
                        </div>
                    </div>
                    <div class="flex justify-end gap-3">
                        <button onclick="goTo('activities')" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded-lg font-bold">×‘×™×˜×•×œ</button>
                        <button onclick="createActivity()" class="bg-kesher-green hover:bg-green-700 text-white px-4 py-2 rounded-lg font-bold">×¤×¨×¡× ×¤×¢×™×œ×•×ª</button>
                    </div>
                </div>
            </div>
        `;

        // ×“×¨×™×©×” 5: ××¡×š × ×™×”×•×œ ×•×“×™×•×•×—×™×
        const renderAdmin = () => {
            if (state.user?.role !== 'admin') return goTo('home');

            const reportsToReview = state.reports.filter(r => r.status === '×—×“×©');
            
            return `
                ${getHeader()}
                <div class="max-w-6xl mx-auto px-4">
                    <h2 class="text-3xl font-bold text-red-600 mb-6">âš™ï¸ ×œ×•×— ×‘×§×¨×” ×œ×× ×”×œ</h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                        <div class="bg-white p-5 rounded-xl shadow-lg border-r-4 border-kesher-blue">
                            <p class="text-xs text-gray-500">×¡×”"×› ××©×ª××©×™×</p>
                            <p class="text-3xl font-bold text-kesher-blue">${state.users.length}</p>
                        </div>
                        <div class="bg-white p-5 rounded-xl shadow-lg border-r-4 border-kesher-green">
                            <p class="text-xs text-gray-500">×¤×•×¨×•××™× ×¤×¢×™×œ×™×</p>
                            <p class="text-3xl font-bold text-kesher-green">${state.forums.length}</p>
                        </div>
                        <div class="bg-white p-5 rounded-xl shadow-lg border-r-4 border-red-500">
                            <p class="text-xs text-gray-500">×“×™×•×•×—×™× ×—×“×©×™×</p>
                            <p class="text-3xl font-bold text-red-500">${reportsToReview.length}</p>
                        </div>
                    </div>
                    
                    <div class="bg-white p-6 rounded-2xl shadow-xl">
                        <h3 class="text-2xl font-bold text-red-600 mb-4">ğŸš© × ×™×”×•×œ ×“×™×•×•×—×™×</h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">×¡×˜×˜×•×¡</th>
                                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">×¡×•×’</th>
                                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">×¡×™×‘×”</th>
                                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">××“×•×•×—</th>
                                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">×¤×¢×•×œ×•×ª</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    ${state.reports.map(r => `
                                        <tr>
                                            <td class="px-6 py-4 whitespace-nowrap">
                                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${r.status === '×—×“×©' ? 'bg-red-100 text-red-800' : r.status === '×‘×˜×™×¤×•×œ' ? 'bg-yellow-100 text-yellow-800' : 'bg-green-100 text-green-800'}">
                                                    ${r.status}
                                                </span>
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${r.itemType} (ID: ${r.itemId.substring(0, 5)}...)</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${r.reason}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${r.reporterName}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium flex gap-2">
                                                ${r.status === '×—×“×©' ? `<button onclick="updateReportStatus('${r.id}', '×‘×˜×™×¤×•×œ')" class="text-yellow-600 hover:text-yellow-900">×˜×¤×œ</button>` : ''}
                                                ${r.status !== '×˜×•×¤×œ' ? `<button onclick="updateReportStatus('${r.id}', '×˜×•×¤×œ')" class="text-green-600 hover:text-green-900">×¡×’×•×¨</button>` : ''}
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        };

        // --- ×¤×•× ×§×¦×™×™×ª Render ×”×¨××©×™×ª ---

        function render() {
            const root = document.getElementById('root');
            let content = '';

            switch (state.screen) {
                case 'login':
                    content = renderLogin();
                    break;
                case 'register':
                    content = renderRegister();
                    break;
                case 'home':
                    content = renderHome();
                    break;
                case 'users':
                    content = renderUsers();
                    break;
                case 'chat':
                    content = renderChat();
                    break;
                case 'forums':
                    content = renderForums();
                    break;
                case 'forumPosts':
                    content = renderForumPosts();
                    break;
                case 'newPost':
                    content = renderNewPost();
                    break;
                case 'postDetails':
                    content = renderPostDetails();
                    break;
                case 'activities':
                    content = renderActivities();
                    break;
                case 'newActivity':
                    content = renderNewActivity();
                    break;
                case 'admin':
                    content = renderAdmin();
                    break;
                default:
                    content = renderLogin();
            }

            root.innerHTML = content;
        }

        // --- × ×™×”×•×œ ××¦×‘ ××©×ª××© ×•×”×¤×¢×œ×” ×¨××©×•× ×™×ª ---
        
        // ×¤×•× ×§×¦×™×” ×œ×”××–× ×” ×œ××¦×‘ ×”×”×ª×—×‘×¨×•×ª (×‘××¦×™××•×ª)
        // ×œ×¦×•×¨×š ×”×”×“××™×”, × ×“××” ×›× ×™×¡×” ××•×˜×•××˜×™×ª ×× ×™×© ××©×ª××© "××“××™×Ÿ"
        function initializeApp() {
            // ×× ××™×Ÿ ××©×ª××© ××—×•×‘×¨, × ×“××” ×›× ×™×¡×” ×©×œ ××©×ª××© ×¤×™×§×˜×™×‘×™ "××“××™×Ÿ" ×œ×¦×•×¨×š ×”×“×’××”
            const adminUser = state.users.find(u => u.role === 'admin');
            if (!state.user && adminUser) {
                state.user = adminUser;
                goTo('home');
            } else {
                goTo('login');
            }
        }

        initializeApp(); // ×”×¤×¢×œ×ª ×”××¤×œ×™×§×¦×™×”
    </script>
</body>
</html>
