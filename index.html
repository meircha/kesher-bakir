<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>×§×”×™×œ×ª ×§×©×¨ â€” ×§×”×™×œ×” ×ª×•××›×ª 60+</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

  <style>
    :root{
      --primary:#2B6CB0;
      --accent:#38B2AC;
      --bg:#F7FAFC;
      --card:#FFFFFF;
      --muted:#4A5568;
    }
    html,body { height:100%; }
    body{ background:var(--bg); font-family: "Segoe UI", Roboto, Arial, sans-serif; color:#1a202c; -webkit-font-smoothing:antialiased; margin:0; padding:0; }
    .card{ background:var(--card); border-radius:12px; box-shadow:0 6px 20px rgba(0,0,0,0.06); }
    .btn-primary{ background:var(--accent); color:white; }
    .btn-sec{ background:var(--primary); color:white; }
    .pill{ padding:.5rem .9rem; border-radius:999px; font-size: .95rem; }
    .clickable{ cursor:pointer; }
    input, textarea, select { font-size:1rem; }
    .fab{ position:fixed; bottom:18px; left:18px; z-index:60; border-radius:999px; width:64px; height:64px; display:flex; align-items:center; justify-content:center; box-shadow:0 10px 20px rgba(0,0,0,0.12); }
    .small-muted{ color:var(--muted); font-size:.9rem; }
    .hidden{ display:none; }
  </style>
</head>
<body>

<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/kesher-bakir/firebase-messaging-sw.js')
      .then(()=>console.log('SW registered (github pages path).'))
      .catch(e=>console.warn('SW register failed', e));
  }
</script>

<header class="bg-white shadow sticky top-0 z-50">
  <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
    <div class="flex items-center gap-3">
      <img id="siteLogo" src="https://images.unsplash.com/photo-1524504388940-b1c1722653e1?q=80&w=80&auto=format&fit=crop&ixlib=rb-4.0.3&s=3d6c2b2b5d3af9c1b8f8f1a5b7c4b2a1"
           alt="×§×”×™×œ×ª ×§×©×¨" class="w-12 h-12 rounded-full object-cover border-2">
      <div>
        <div class="text-xl font-bold" style="color:var(--primary)">×§×”×™×œ×ª ×§×©×¨</div>
        <div class="text-sm small-muted">××¨×—×‘ ×ª×•××š ×œ×‘× ×™ 60 ×•××¢×œ×”</div>
      </div>
    </div>

    <div class="flex items-center gap-2">
      <div id="greetingText" class="text-sm small-muted mr-2"></div>

      <button class="pill bg-white border" onclick="goTo('home')">×‘×™×ª</button>
      <button class="pill bg-white border" onclick="goTo('forums')">×¤×•×¨×•××™×</button>
      <button class="pill bg-white border" onclick="goTo('activities')">×¤×¢×™×œ×•×™×•×ª</button>
      <button class="pill bg-white border" onclick="goTo('helpCenter')">××¨×›×– ×¢×–×¨×”</button>
      <button class="pill bg-white border" onclick="goTo('users')">×—×‘×¨×™×</button>

      <div class="relative">
        <button id="chatBtn" class="pill bg-white border flex items-center gap-2" onclick="goTo('chat')">
          <i class="fa-solid fa-comments"></i> ×¦'××˜
          <span id="unreadBadge" class="ml-2 inline-flex items-center justify-center px-2 py-0.5 text-xs font-bold text-white bg-yellow-400 rounded-full hidden"></span>
        </button>
      </div>

      <button id="authBtn" class="pill btn-sec text-white"></button>
    </div>
  </div>
</header>

<main class="max-w-6xl mx-auto px-4 py-6" id="root"></main>

<button class="fab btn-primary card clickable" title="×¦'××˜ ××”×™×¨" onclick="goTo('chat')" aria-label="×¦'××˜ ××”×™×¨">
  <i class="fa-solid fa-comments" style="font-size:20px;"></i>
</button>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-messaging.js"></script>

<script>
/* ================== CONFIG - ×ª×•×§×Ÿ ×¢× ×”×¢×¨×›×™× ×©×œ×š ================== */
const firebaseConfig = {
    apiKey: "AIzaSyCrcxC420HW5PXGNd8M4KuclUkiJSwHreM", 
    authDomain: "kesher-bakir.firebaseapp.com",
    projectId: "kesher-bakir",
    storageBucket: "kesher-bakir.firebasestorage.app",
    messagingSenderId: "671996189455",
    appId: "1:671996189455:web:dbe089d69a85a2ab38fc7a",
    measurementId: "G-42EWSKFXW" 
};
/* ===================================================================== */

if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const messaging = firebase.messaging();

/* × ×¡×™×•×Ÿ persistence */
if (db.enablePersistence) {
  db.enablePersistence().catch(err => console.warn('persistence:', err && err.code));
}

/* ========== State ========== */
const state = {
  user:null,
  screen:'home',
  users:[],
  forums:[],
  activities:[],
  helpCategories:[],
  helpRequests:[],
  chatMessages:[],
  selectedUser:null,
  cities:[],
  unreadTotal:0,
  listeners: {}
};

/* ========== Helpers ========== */
function el(html){ const d=document.createElement('div'); d.innerHTML=html; return d.firstElementChild; }
function escapeHtml(s){ return (s||'').toString().replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function getChatRoomId(a,b){ if(!a||!b) return null; return a < b ? `${a}_${b}` : `${b}_${a}`; }
function showToast(msg){ alert(msg); }

/* ========== Router / Render ========== */
function goTo(screen, params){ state.screen = screen; if(params) Object.assign(state, params); render(); }

// ğŸ›‘ ==================== ×”×ª×™×§×•×Ÿ ×›××Ÿ ==================== ğŸ›‘
// ×”×•×¡×¤× ×• ×§×¨×™××•×ª ×œ×¤×•× ×§×¦×™×•×ª ×”××™×œ×•×™ (×›××• renderUsersList) ×œ××—×¨ ×¨×™× ×“×•×¨ ×”××¡×’×¨×ª
function render(){
  updateHeader();
  const root = document.getElementById('root');
  try {
    // ×©×œ×‘ 1: ×¨×™× ×“×•×¨ ×”××¡×’×¨×ª
    switch(state.screen){
      case 'home': root.innerHTML = renderHome(); break;
      case 'login': root.innerHTML = renderLogin(); break;
      case 'register': root.innerHTML = renderRegister(); break;
      case 'forums': root.innerHTML = renderForums(); break;
      case 'activities': root.innerHTML = renderActivities(); break;
      case 'helpCenter': root.innerHTML = renderHelpCenter(); break;
      case 'users': root.innerHTML = renderUsers(); break;
      case 'chat': root.innerHTML = renderChat(); break;
      case 'admin': root.innerHTML = renderAdmin(); break;
      default: root.innerHTML = '<div>×˜×¢×•×ª × ×™×•×•×˜</div>';
    }

    // ×©×œ×‘ 2: ×§×¨×™××” ×œ×¤×•× ×§×¦×™×•×ª ×©×××œ××•×ª ××ª ×”×ª×•×›×Ÿ
    // (×–×” ×”×ª×™×§×•×Ÿ ×œ×‘×¢×™×™×ª ×”×¨×©×™××•×ª ×”×¨×™×§×•×ª)
    switch(state.screen){
      case 'home': afterHomeRender(); break;
      case 'forums': searchForums(); break;
      // case 'activities': renderActivitiesList(); break; // (×¤×•× ×§×¦×™×” ×–×• ×˜×¨× × ×›×ª×‘×” ×‘×§×•×“ ×©×œ×š)
      // case 'helpCenter': renderHelpRequestsList(); break; // (×¤×•× ×§×¦×™×” ×–×• ×˜×¨× × ×›×ª×‘×” ×‘×§×•×“ ×©×œ×š)
      case 'users': renderUsersList(); break;
      case 'chat': renderChatUsersList(); updateChatBox(); break;
      case 'admin': loadAdminLists(); break;
    }

  } catch(e){
    console.error('render error', e);
    root.innerHTML = `<div class="p-4 card">×©×’×™××” ×‘×”×¦×’×”: ${escapeHtml(e.message)}</div>`;
  }
}
// ğŸ›‘ ==================== ×¡×•×£ ×”×ª×™×§×•×Ÿ ==================== ğŸ›‘

/* ========== Header updates ========== */
function updateHeader(){
  const greeting = document.getElementById('greetingText');
  if(greeting) greeting.innerText = state.user ? `×©×œ×•×, ${state.user.name}${state.user.role==='admin' ? ' (ADMIN)' : ''}` : '';
  const authBtn = document.getElementById('authBtn');
  if(authBtn) authBtn.innerText = state.user ? '×”×ª× ×ª×§' : '×”×ª×—×‘×¨';
  const badge = document.getElementById('unreadBadge');
  if(badge){
    badge.style.display = state.unreadTotal > 0 ? 'inline-flex' : 'none';
    badge.innerText = state.unreadTotal > 99 ? '99+' : (state.unreadTotal || '');
  }
}

/* ===================== Home ===================== */
function renderHome(){
  return `
    <section class="card overflow-hidden mb-6">
      <div class="relative">
        <img id="heroImg" src="https://images.unsplash.com/photo-1524504388940-b1c1722653e1?q=80&w=1600&auto=format&fit=crop&ixlib=rb-4.0.3&s=3d6c2b2b5d3af9c1b8f8f1a5b7c4b2a1" alt="×§×”×™×œ×”" class="w-full h-56 object-cover" />
        <div class="absolute inset-0 bg-gradient-to-t from-black/30 to-transparent"></div>
        <div class="absolute left-6 bottom-6 text-white">
          <div class="text-2xl font-bold">×‘×¨×•×›×™× ×”×‘××™× â€” ×§×”×™×œ×ª ×§×©×¨</div>
          <div class="text-sm">××¨×—×‘ ×‘×˜×•×— ×•×ª×•××š ×œ×‘× ×™ 60 ×•××¢×œ×”</div>
        </div>
      </div>

      <div class="p-6 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
        <div class="card p-4 flex items-center gap-4 clickable" onclick="goTo('chat')">
          <div class="w-14 h-14 rounded-full bg-gradient-to-tr from-[#4EC7B6] to-[#2FB3A3] flex items-center justify-center text-white text-xl"><i class="fa-solid fa-comments"></i></div>
          <div>
            <div class="font-semibold text-lg">×¦'××˜</div>
            <div class="text-sm small-muted">×©×•×—×—×• ××—×“-×¢×-××—×“ ×¢× ×—×‘×¨×™×</div>
          </div>
        </div>

        <div class="card p-4 flex items-center gap-4 clickable" onclick="goTo('activities')">
          <div class="w-14 h-14 rounded-full bg-gradient-to-tr from-[#FF9AA2] to-[#FF6B6B] flex items-center justify-center text-white text-xl"><i class="fa-solid fa-calendar-day"></i></div>
          <div>
            <div class="font-semibold text-lg">×¤×¢×™×œ×•×™×•×ª</div>
            <div class="text-sm small-muted">××¤×’×©×™× ××§×•××™×™× ×•×¡×“× ××•×ª</div>
          </div>
        </div>

        <div class="card p-4 flex items-center gap-4 clickable" onclick="goTo('forums')">
          <div class="w-14 h-14 rounded-full bg-gradient-to-tr from-[#A0D8EF] to-[#6FBDE8] flex items-center justify-center text-white text-xl"><i class="fa-solid fa-users"></i></div>
          <div>
            <div class="font-semibold text-lg">×¤×•×¨×•××™×</div>
            <div class="text-sm small-muted">×©××œ×•×ª, ×¢×¦×•×ª ×•×—×•×•×™×•×ª</div>
          </div>
        </div>

        <div class="card p-4 flex items-center gap-4 clickable" onclick="goTo('helpCenter')">
          <div class="w-14 h-14 rounded-full bg-gradient-to-tr from-[#FFD27A] to-[#FFCD4D] flex items-center justify-center text-white text-xl"><i class="fa-solid fa-hands-helping"></i></div>
          <div>
            <div class="font-semibold text-lg">××¨×›×– ×¢×–×¨×”</div>
            <div class="text-sm small-muted">×¤× ×• ×œ×¢×–×¨×” ××©×¤×˜×™×ª, ×˜×¤×¡×™×, ×ª××™×›×” ×˜×›× ×™×ª ×•×¢×•×“</div>
          </div>
        </div>

        <div class="card p-4 col-span-full">
          <div class="flex items-center justify-between">
            <div>
              <div class="text-lg font-bold">×˜×™×¤ ×™×•××™</div>
              <div id="dailyTipContainer" class="text-md small-muted mt-2">×˜×•×¢×Ÿ...</div>
            </div>
            <div>
              <button id="refreshTipBtnHeader" class="pill btn-primary">×˜×¢×Ÿ ×˜×™×¤ ××—×¨</button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="grid lg:grid-cols-2 gap-4">
      <div class="card p-4">
        <h3 class="font-semibold mb-3">×¤×•×¨×•××™× ××—×¨×•× ×™×</h3>
        <div id="forumsListSmall">×˜×•×¢×Ÿ...</div>
      </div>

      <div class="card p-4">
        <h3 class="font-semibold mb-3">×¤×¢×™×œ×•×™×•×ª ×§×¨×•×‘×•×ª</h3>
        <div id="activitiesListSmall">×˜×•×¢×Ÿ...</div>
      </div>
    </section>
  `;
}
function afterHomeRender(){
  // safe update of daily tip
  renderDailyTipSafe();
  renderForumsSmall();
  renderActivitiesSmall();
}

/* ===================== Login/Register ===================== */
function renderLogin(){
  return `
    <div class="card p-6 max-w-md mx-auto">
      <h2 class="text-xl font-bold mb-2">×”×ª×—×‘×¨×•×ª</h2>
      <div class="mb-2"><label class="text-sm">××™××™×™×œ</label><input id="loginEmail" type="email" class="w-full p-2 border rounded" /></div>
      <div class="mb-4"><label class="text-sm">×¡×™×¡××”</label><input id="loginPwd" type="password" class="w-full p-2 border rounded" /></div>
      <div class="flex gap-2 justify-end">
        <button class="pill bg-white border" onclick="goTo('home')">×‘×˜×œ</button>
        <button class="pill btn-primary" onclick="doLogin()">×”×ª×—×‘×¨</button>
      </div>
      <div class="mt-4 text-sm small-muted">××™×Ÿ ×œ×š ×—×©×‘×•×Ÿ? <button class="text-blue-600 underline" onclick="goTo('register')">×”×¨×©× ×›××Ÿ</button></div>
    </div>
  `;
}
function renderRegister(){
  const hobbies = ['×˜×™×•×œ×™×','×§×¨×™××”','×’×™× ×•×Ÿ','×‘×™×©×•×œ','×©×™×¨×”/××•×¡×™×§×”','×™×¦×™×¨×”','×¡×¤×•×¨×˜ ×¢×“×™×Ÿ','××©×—×§×™ ×§×•×¤×¡×”','×ª×¤×™×¨×”'];
  const contributions = ['×¢×–×¨×” ×˜×›× ×™×ª','××™×œ×•×™ ×˜×¤×¡×™×','×™×™×¢×•×¥ ××©×¤×˜×™','×”×¡×¢×”/×§× ×™×•×ª','×”×“×¨×›×”/×”×•×¨××”','×‘×™×©×•×œ ×œ×™×•××™×™×','×¡×™×•×¢ ×¨×’×©×™'];
  return `
    <div class="card p-6 max-w-2xl mx-auto">
      <h2 class="text-xl font-bold mb-3">×”×¨×©××”</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div><label class="text-sm">×©× ××œ×</label><input id="regName" class="w-full p-2 border rounded" /></div>
        <div><label class="text-sm">×©× ××©×ª××©</label><input id="regUsername" class="w-full p-2 border rounded" /></div>
        <div><label class="text-sm">××™××™×™×œ</label><input id="regEmail" type="email" class="w-full p-2 border rounded" /></div>
        <div><label class="text-sm">×¡×™×¡××”</label><input id="regPwd" type="password" class="w-full p-2 border rounded" /></div>
        <div><label class="text-sm">×’×™×œ</label><input id="regAge" type="number" min="18" class="w-full p-2 border rounded" /></div>
        <div><label class="text-sm">×¢×™×¨ / ×™×©×•×‘</label>
          <select id="regCity" class="w-full p-2 border rounded">
            <option value="">×‘×—×¨/×™</option>
            <option value="×ª×•×©×‘ ×—×•\"×œ">×ª×•×©×‘ ×—×•\"×œ</option>
            <option value="×ª×œ ××‘×™×‘">×ª×œ ××‘×™×‘</option>
            <option value="×™×¨×•×©×œ×™×">×™×¨×•×©×œ×™×</option>
            <option value="×—×™×¤×”">×—×™×¤×”</option>
            <option value="×‘××¨ ×©×‘×¢">×‘××¨ ×©×‘×¢</option>
            <option value="×¨××©×•×Ÿ ×œ×¦×™×•×Ÿ">×¨××©×•×Ÿ ×œ×¦×™×•×Ÿ</option>
            <option value="× ×¦×¨×ª">× ×¦×¨×ª</option>
            <option value="××—×¨">××—×¨</option>
          </select>
        </div>

        <div class="md:col-span-2">
          <label class="text-sm">×ª×—×‘×™×‘×™× (×‘×—×¨×• ××¡×¤×¨)</label>
          <div id="hobbiesList" class="grid grid-cols-2 gap-2 mt-2">
            ${hobbies.map(h=>`<label class="inline-flex items-center gap-2 border p-2 rounded"><input type="checkbox" value="${escapeHtml(h)}" /> ${escapeHtml(h)}</label>`).join('')}
            <label class="inline-flex items-center gap-2 border p-2 rounded"><input id="hobbyOtherChk" type="checkbox" value="××—×¨" /> ××—×¨: <input id="hobbyOtherText" placeholder="×›×ª×•×‘..." class="ml-2 p-1 border rounded" /></label>
          </div>
        </div>

        <div class="md:col-span-2">
          <label class="text-sm">×‘××” ×ª×•×›×œ/×™ ×œ×ª×¨×•× ×œ×§×‘×•×¦×”?</label>
          <div id="contribList" class="grid grid-cols-2 gap-2 mt-2">
            ${contributions.map(c=>`<label class="inline-flex items-center gap-2 border p-2 rounded"><input type="checkbox" value="${escapeHtml(c)}" /> ${escapeHtml(c)}</label>`).join('')}
            <label class="inline-flex items-center gap-2 border p-2 rounded"><input id="contribOtherChk" type="checkbox" value="××—×¨" /> ××—×¨: <input id="contribOtherText" placeholder="×›×ª×•×‘..." class="ml-2 p-1 border rounded" /></label>
          </div>
        </div>

        <div class="md:col-span-2">
          <label class="text-sm">×ª××•× ×ª ×¤×¨×•×¤×™×œ (××•×¤×¦×™×•× ×œ×™) â€” ×”×¢×œ×” ×ª××•× ×” ××• ×‘×—×¨ ××™××•×’'×™</label>
          <div class="mt-2 flex gap-2 items-center">
            <input id="profileImage" type="file" accept="image/*" />
            <input id="emojiChoice" placeholder="×”×§×œ×“ ××™××•×’'×™..." class="p-2 border rounded w-32" />
          </div>
        </div>

        <div class="md:col-span-2">
          <label class="inline-flex items-center gap-2"><input id="agreeRules" type="checkbox" /> ×× ×™ ×××©×¨/×ª ××ª <a href="#" onclick="showRules()" class="text-blue-600 underline">×ª×§× ×•×Ÿ ×”×©×™××•×©</a> ×•××ª ×›×œ×œ×™ ×”×”×ª× ×”×’×•×ª</label>
          <div class="text-sm small-muted mt-2">×¢×œ ×™×“×™ ×”×”×¨×©××” ××ª×” ×××©×¨ ×›×™ ×”××™×“×¢ × ×›×•×Ÿ ×•××¡×›×™× ×œ×ª× ××™ ×”×§×”×™×œ×”.</div>
        </div>
      </div>

      <div class="mt-4 flex justify-end gap-2">
        <button class="pill bg-white border" onclick="goTo('home')">×‘×™×˜×•×œ</button>
        <button class="pill btn-primary" onclick="doRegister()">×”×¨×©×</button>
      </div>
    </div>
  `;
}

/* ===================== Forums ===================== */
function renderForums(){
  return `
    <div class="card p-4">
      <div class="flex items-center justify-between mb-3">
        <div><h3 class="text-lg font-semibold">×¤×•×¨×•××™×</h3><div class="text-sm small-muted">×©××œ×•×ª, ×¢×¦×•×ª ×•×—×•×•×™×•×ª</div></div>
        <div class="flex gap-2">
          <input id="forumSearch" class="p-2 border rounded" placeholder="×—×¤×©..." oninput="searchForums()" />
          ${state.user && state.user.role==='admin' ? `<button class="pill btn-sec" onclick="showCreateForumModal()">×¦×•×¨ ×¤×•×¨×•×</button>` : ''}
        </div>
      </div>

      <div id="forumsFullList"></div>

      <div id="createForumModal" class="fixed inset-0 bg-black/30 hidden items-center justify-center z-50">
        <div class="bg-white p-6 rounded w-full max-w-lg card">
          <h4 class="font-semibold mb-2">×¦×•×¨ ×¤×•×¨×•× ×—×“×©</h4>
          <input id="newForumTitle" placeholder="×›×•×ª×¨×ª" class="w-full p-2 border rounded mb-2" />
          <textarea id="newForumDesc" placeholder="×ª×™××•×¨" class="w-full p-2 border rounded mb-2"></textarea>
          <div class="flex gap-2 justify-end">
            <button class="pill bg-white border" onclick="hideCreateForumModal()">×‘×™×˜×•×œ</button>
            <button class="pill btn-primary" onclick="createForum()">×¦×•×¨</button>
          </div>
        </div>
      </div>
    </div>
  `;
}

/* ===================== Activities ===================== */
function renderActivities(){
  return `
    <div class="card p-4">
      <div class="flex items-center justify-between mb-3">
        <div><h3 class="text-lg font-semibold">×¤×¢×™×œ×•×™×•×ª</h3><div class="text-sm small-muted">×¨×©×•×/×™ ×œ×¤×¢×™×œ×•×™×•×ª ×§×¨×•×‘×•×ª</div></div>
        <div>
          ${state.user ? `<button class="pill btn-primary" onclick="showCreateActivityModal()">×”×•×¡×£ ×¤×¢×™×œ×•×ª</button>` : `<button class="pill bg-white border" onclick="goTo('login')">×”×ª×—×‘×¨ ×›×“×™ ×œ×”×•×¡×™×£</button>`}
        </div>
      </div>

      <div id="activitiesFullList"></div>

      <div id="createActivityModal" class="fixed inset-0 bg-black/30 hidden items-center justify-center z-50">
        <div class="bg-white p-6 rounded w-full max-w-lg card">
          <h4 class="font-semibold mb-2">×”×•×¡×¤×ª ×¤×¢×™×œ×•×ª</h4>
          <input id="actTitle" placeholder="×›×•×ª×¨×ª" class="w-full p-2 border rounded mb-2" />
          <input id="actDate" type="date" class="w-full p-2 border rounded mb-2" />
          <input id="actLocation" placeholder="××™×§×•×" class="w-full p-2 border rounded mb-2" />
          <input id="actCapacity" type="number" placeholder="×›××•×ª ××§×•××•×ª (×¨×™×§ = ×œ×œ× ×”×’×‘×œ×”)" class="w-full p-2 border rounded mb-2" />
          <textarea id="actDesc" placeholder="×ª×™××•×¨" class="w-full p-2 border rounded mb-2"></textarea>
          <div class="flex gap-2 justify-end">
            <button class="pill bg-white border" onclick="hideCreateActivityModal()">×‘×™×˜×•×œ</button>
            <button class="pill btn-primary" onclick="createActivity()">×©××•×¨</button>
          </div>
        </div>
      </div>
    </div>
  `;
}

/* ===================== Help Center ===================== */
function renderHelpCenter(){
  return `
    <div class="card p-4">
      <div class="flex items-center justify-between mb-3">
        <div><h3 class="text-lg font-semibold">××¨×›×– ×¢×–×¨×”</h3><div class="text-sm small-muted">×”×¤×•×¨×•× ××™×•×¢×“ ×œ×¢×–×¨×” ×¢×œ ×‘×¡×™×¡ ×§×”×™×œ×ª×™ ×‘×œ×‘×“ â€” ××™×Ÿ ×‘×›×š ×™×™×¢×•×¥ ××§×¦×•×¢×™ ××˜×¢× ×‘×¢×œ×™ ×”××ª×¨.</div></div>
        <div>
          ${state.user ? `<button class="pill btn-primary" onclick="showHelpModal()">×©×œ×— ×‘×§×©×”</button>` : `<button class="pill bg-white border" onclick="goTo('login')">×”×ª×—×‘×¨</button>`}
          ${state.user && state.user.role==='admin' ? `<button class="pill btn-sec ml-2" onclick="goTo('admin')">× ×™×”×•×œ ××¨×›×– ×¢×–×¨×”</button>` : ''}
        </div>
      </div>

      <div class="grid md:grid-cols-3 gap-3 mb-4" id="helpCategoriesGrid"></div>

      <div id="helpRequestsList"></div>

      <div id="helpModal" class="fixed inset-0 bg-black/30 hidden items-center justify-center z-50">
        <div class="bg-white p-6 rounded w-full max-w-lg card">
          <h4 class="font-semibold mb-2">×©×’×¨ ×‘×§×©×” ×œ×¢×–×¨×”</h4>
          <label class="text-sm small-muted">×‘×—×¨ ×§×˜×’×•×¨×™×”</label>
          <select id="helpCatSelect" class="w-full p-2 border rounded mb-2"></select>
          <input id="helpTitle" placeholder="×›×•×ª×¨×ª" class="w-full p-2 border rounded mb-2" />
          <textarea id="helpBody" placeholder="×ª××¨/×™ ××ª ×”×‘×§×©×”" class="w-full p-2 border rounded mb-2"></textarea>
          <div class="flex gap-2 justify-end">
            <button class="pill bg-white border" onclick="hideHelpModal()">×‘×™×˜×•×œ</button>
            <button class="pill btn-primary" onclick="submitHelpRequest()">×©×œ×—</button>
          </div>
        </div>
      </div>
    </div>
  `;
}

/* ===================== Users ===================== */
function renderUsers(){
  return `
    <div class="card p-4">
      <div class="flex items-center justify-between mb-3">
        <div><h3 class="text-lg font-semibold">×—×‘×¨×™×</h3><div class="text-sm small-muted">×¡×™× ×•×Ÿ ×œ×¤×™ ×¢×™×¨ / ×—×™×¤×•×©</div></div>
        <div class="flex gap-2">
          <select id="cityFilter" class="p-2 border rounded" onchange="renderUsersList()"><option value="">×›×œ ×”×¢×¨×™×</option></select>
          <select id="onlineFilter" class="p-2 border rounded" onchange="renderUsersList()">
            <option value="">×”×›×œ</option>
            <option value="online">××—×•×‘×¨×™×</option>
            <option value="offline">×œ× ××—×•×‘×¨×™×</option>
          </select>
          <input id="userSearch" placeholder="×—×¤×© ×©×..." class="p-2 border rounded" oninput="renderUsersList()" />
        </div>
      </div>
      <div id="usersList"></div>
    </div>
  `;
}

/* ===================== Chat ===================== */
function renderChat(){
  if(!state.user) return `<div class="card p-4">×× × ×”×ª×—×‘×¨ ×›×“×™ ×œ×”×©×ª××© ×‘×¦'××˜</div>`;
  return `
    <div class="card p-4 flex flex-col" style="height:70vh;">
      <div class="flex items-center justify-between mb-3">
        <div><h3 class="text-lg font-semibold">×¦'××˜</h3><div class="text-sm small-muted">×¡× ×Ÿ ××©×ª××©×™× ×œ×¤×™ ×¢×™×¨ ××• ×—×¤×© ×©×</div></div>
        <div><button class="pill bg-white border" onclick="goTo('users')">×—×–×•×¨</button></div>
      </div>

      <div class="flex gap-4 h-full">
        <div class="w-1/3 border rounded p-2 overflow-y-auto">
          <div class="mb-2 flex gap-2">
            <select id="chatCityFilter" class="w-full p-2 border rounded" onchange="renderChatUsersList()"><option value="">×›×œ ×”×¢×¨×™×</option></select>
            <select id="chatOnlineFilter" class="w-full p-2 border rounded" onchange="renderChatUsersList()">
                <option value="">×”×›×œ</option>
                <option value="online">××—×•×‘×¨×™×</option>
                <option value="offline">×œ× ××—×•×‘×¨×™×</option>
            </select>
          </div>
          <div id="chatUsersList"></div>
        </div>

        <div class="flex-1 flex flex-col">
          <div id="chatBox" class="flex-grow overflow-y-auto p-3 space-y-3 bg-gray-50 rounded"></div>
          <div class="mt-3 flex gap-2 items-center">
            <input id="chatInput" type="text" placeholder="×›×ª×•×‘ ×”×•×“×¢×”..." class="flex-grow p-3 border rounded" onkeydown="if(event.key==='Enter') sendMessage()" />
            <button class="pill btn-primary" onclick="sendMessage()">×©×œ×—</button>
          </div>
        </div>
      </div>
    </div>
  `;
}

/* ===================== Admin ===================== */
function renderAdmin(){
  if(!state.user || state.user.role !== 'admin') return goTo('home');
  return `
    <div class="card p-4">
      <h3 class="text-lg font-semibold mb-3">×œ×•×— × ×™×”×•×œ</h3>

      <div class="grid md:grid-cols-2 gap-4">
        <div class="p-3 border rounded">
          <h4 class="font-semibold mb-2">××©×ª××©×™×</h4>
          <div id="adminUsersList"></div>
        </div>

        <div class="p-3 border rounded">
          <h4 class="font-semibold mb-2">× ×™×”×•×œ ××¨×›×– ×¢×–×¨×” - ×§×˜×’×•×¨×™×•×ª</h4>
          <div class="flex gap-2 mb-3"><input id="newHelpCat" placeholder="×©× ×§×˜×’×•×¨×™×”" class="p-2 border rounded" /><button class="pill btn-primary" onclick="createHelpCategory()">×”×•×¡×£</button></div>
          <div id="adminHelpCats"></div>
        </div>
      </div>

      <div class="mt-4 p-3 border rounded">
        <h4 class="font-semibold mb-2">× ×™×”×•×œ ×¤×¢×™×œ×•×™×•×ª & ×“×™×•×•×—×™×</h4>
        <div id="adminActivities"></div>
      </div>
    </div>
  `;
}

/* ===================== Data fetch / sync ===================== */

async function fetchInitial(){
  // fetch essential collections. Each fetch is wrapped to avoid total fail if one collection lacks permissions
  try {
    // users
    const usersSnap = await db.collection('users').get();
    state.users = usersSnap.docs.map(d=>({ id:d.id, ...d.data() }));

    // forums
    try {
      const forumsSnap = await db.collection('forums').get();
      state.forums = forumsSnap.docs.map(d=>({ id:d.id, ...d.data() }));
    } catch(e){ console.warn('forums fetch failed', e); state.forums = []; }

    // activities
    try {
      const actsSnap = await db.collection('activities').get();
      state.activities = actsSnap.docs.map(d=>({ id:d.id, ...d.data() }));
    } catch(e){ console.warn('activities fetch failed', e); state.activities = []; }

    // helpCategories (helpCenter)
    try {
      const helpSnap = await db.collection('helpCenter').get();
      state.helpCategories = helpSnap.docs.map(d=>({ id:d.id, ...d.data() }));
    } catch(e){ console.warn('helpCenter fetch failed', e); state.helpCategories = []; }

    // daily tips
    try {
      const tipsSnap = await db.collection('dailyTips').get();
      state.dailyTips = tipsSnap.docs.map(d=>({ id:d.id, ...d.data() }));
    } catch(e){ console.warn('dailyTips fetch failed', e); state.dailyTips = []; }

    // populate cities
    state.cities = Array.from(new Set(state.users.map(u=>u.city).filter(Boolean))).sort();
    populateCityFilters();

    // update header/unread
    if(state.user) updateUnreadTotal();

  } catch(err){
    console.error('fetchInitial critical error', err);
    // if a permissions error occurs, show a clear message in UI
    if(err && err.code && err.code.includes && err.code.includes('permission')) {
      document.getElementById('root').innerHTML = `<div class="card p-4 text-red-600">×©×’×™××ª ×”×¨×©××•×ª ×‘-Firestore: ××™×Ÿ ×’×™×©×” ×œ××•×¡×¤×™×. ×•×“× ×©×”Ö¾Rules × ×›×•× ×™× ×•×©×”××©×ª××© ××—×•×‘×¨.</div>`;
    }
  }
}

/* ===================== Render helpers ===================== */

function renderForumsSmall(){ const el=document.getElementById('forumsListSmall'); if(!el) return; el.innerHTML = (state.forums||[]).slice(0,4).map(f=>`<div class="p-3 border rounded mb-2"><div class="font-semibold">${escapeHtml(f.title)}</div><div class="text-sm small-muted">${escapeHtml(f.description||'')}</div><div class="mt-2"><button class="pill btn-primary" onclick="openForum('${f.id}')">×¤×ª×—</button></div></div>`).join('') || '<div class="text-gray-500">××™×Ÿ ×¤×•×¨×•××™×</div>'; }
function renderActivitiesSmall(){ const el=document.getElementById('activitiesListSmall'); if(!el) return; el.innerHTML = (state.activities||[]).slice(0,4).map(a=>`<div class="p-3 border rounded mb-2"><div class="font-semibold">${escapeHtml(a.title)}</div><div class="text-sm small-muted">${escapeHtml(a.location||'')}</div><div class="mt-2"><button class="pill btn-primary" onclick="openActivity('${a.id}')">×¤×ª×—</button></div></div>`).join('') || '<div class="text-gray-500">××™×Ÿ ×¤×¢×™×œ×•×™×•×ª</div>'; }

// ğŸ›‘ ==================== ×”×ª×™×§×•×Ÿ ×›××Ÿ ==================== ğŸ›‘
// ×”×•×¡×¤× ×• ×¡×™× ×•×Ÿ ×œ×¤×™ ××—×•×‘×¨/×œ× ××—×•×‘×¨
function renderUsersList(){
  const q = document.getElementById('userSearch') ? document.getElementById('userSearch').value.trim().toLowerCase() : '';
  const city = document.getElementById('cityFilter') ? document.getElementById('cityFilter').value : '';
  // ×§×¨×™××ª ×”×¢×¨×š ××”×¤×™×œ×˜×¨ ×”×—×“×©
  const onlineStatus = document.getElementById('onlineFilter') ? document.getElementById('onlineFilter').value : ''; 

  const list = (state.users||[]).filter(u => {
      const cityMatch = (city ? u.city === city : true);
      const nameMatch = (q ? (u.name || '').toLowerCase().includes(q) : true);
      const activeMatch = (u.isActive !== false);
      
      // ×œ×•×’×™×§×ª ×¡×™× ×•×Ÿ ×¡×˜×˜×•×¡
      let statusMatch = true;
      if (onlineStatus === 'online') {
          statusMatch = u.isOnline === true;
      } else if (onlineStatus === 'offline') {
          statusMatch = u.isOnline === false;
      }
      
      return cityMatch && nameMatch && activeMatch && statusMatch;
  });
  
  const el = document.getElementById('usersList'); if(!el) return;
  if(!list.length){ el.innerHTML = '<div class="text-gray-500">××™×Ÿ ××©×ª××©×™×</div>'; return; }
  el.innerHTML = list.map(u=>`<div class="p-3 border rounded mb-2 flex items-center justify-between"><div class="flex items-center gap-3"><div class="w-12 h-12 rounded-full bg-gray-200 flex items-center justify-center text-xl">${u.avatarEmoji|| (u.name||'×').charAt(0)}</div><div><div class="font-semibold">${escapeHtml(u.name)}</div><div class="text-sm small-muted">${escapeHtml(u.city||'')}</div><div class="text-sm small-muted">×ª×—×‘×™×‘×™×: ${escapeHtml((u.hobbies||[]).join(', '))}</div></div></div><div class="flex gap-2"><button class="pill btn-primary" onclick="openChat('${u.id}','${escapeHtml(u.name)}')">×¦'××˜</button>${state.user && state.user.role==='admin'?`<button class="pill bg-red-400" onclick="adminDeleteUser('${u.id}')">××—×§</button>`:''}</div></div>`).join('');
}

/* Chat users list (left pane) */
function renderChatUsersList(){
  const city = document.getElementById('chatCityFilter') ? document.getElementById('chatCityFilter').value : '';
  // ×§×¨×™××ª ×”×¢×¨×š ××”×¤×™×œ×˜×¨ ×”×—×“×©
  const onlineStatus = document.getElementById('chatOnlineFilter') ? document.getElementById('chatOnlineFilter').value : ''; 

  const list = (state.users||[]).filter(u => {
      const cityMatch = (city ? u.city === city : true);
      const selfMatch = (u.id !== (state.user ? state.user.id : ''));
      const activeMatch = (u.isActive !== false);

      // ×œ×•×’×™×§×ª ×¡×™× ×•×Ÿ ×¡×˜×˜×•×¡
      let statusMatch = true;
      if (onlineStatus === 'online') {
          statusMatch = u.isOnline === true;
      } else if (onlineStatus === 'offline') {
          statusMatch = u.isOnline === false;
      }
      
      return cityMatch && selfMatch && activeMatch && statusMatch;
  });
  
  const el = document.getElementById('chatUsersList'); if(!el) return;
  el.innerHTML = list.map(u=>`<div class="p-2 border-b flex items-center justify-between clickable" onclick="openChat('${u.id}','${escapeHtml(u.name)}')"><div>${escapeHtml(u.name)} <div class="text-xs small-muted">${escapeHtml(u.city||'')}</div></div><div>${u.isOnline?'<span class="text-green-600 text-xs">××—×•×‘×¨</span>':'<span class="text-gray-400 text-xs">×œ× ××—×•×‘×¨</span>'}</div></div>`).join('');
}
// ğŸ›‘ ==================== ×¡×•×£ ×”×ª×™×§×•×Ÿ ==================== ğŸ›‘


/* ===================== Chat realtime ===================== */
let currentChatUnsub = null;
function openChat(userId, userName){
  if(!state.user) { goTo('login'); return; }
  state.selectedUser = state.users.find(u=>u.id===userId) || { id:userId, name:userName };
  const roomId = getChatRoomId(state.user.id, state.selectedUser.id);
  // reset unread for this user in that room
  db.collection('chats').doc(roomId).update({ [`unread_${state.user.id}`]: 0 }).catch(()=>{});
  state.chatMessages = [];
  if(currentChatUnsub) currentChatUnsub();
  currentChatUnsub = db.collection('chats').doc(roomId).collection('messages').orderBy('timestamp')
    .onSnapshot(snap=>{
      state.chatMessages = snap.docs.map(d=>({ id:d.id, ...d.data() }));
      if(state.screen !== 'chat'){ state.screen='chat'; render(); }
      updateChatBox();
      updateUnreadTotal();
    }, err=>{ console.error('chat listen err', err); });
}

function updateChatBox(){
  const cb = document.getElementById('chatBox'); if(!cb) return;
  cb.innerHTML = (state.chatMessages||[]).map(m=>{
    const isMe = m.senderId === state.user.id;
    const time = m.timestamp && m.timestamp.toDate ? new Date(m.timestamp.toDate()).toLocaleTimeString() : '';
    return `<div class="${isMe? 'text-right':'text-left'}"><div class="${isMe? 'inline-block bg-gradient-to-tr from-[#4EC7B6] to-[#2FB3A3] text-white p-3 rounded-lg':'inline-block bg-white border p-3 rounded-lg'} max-w-[85%]">${escapeHtml(m.content)}<div class="text-xs small-muted mt-1">${time}${isMe && m.read? ' âœ…':''}</div></div></div>`;
  }).join('');
  setTimeout(()=>{ const cb2=document.getElementById('chatBox'); if(cb2) cb2.scrollTop = cb2.scrollHeight; },50);
}

async function sendMessage(){
  const input = document.getElementById('chatInput'); if(!input) return;
  const content = input.value.trim(); if(!content) return;
  if(!state.selectedUser) return alert('×‘×—×¨ ×©×™×—×”');
  const roomId = getChatRoomId(state.user.id, state.selectedUser.id);
  const message = { senderId: state.user.id, content, timestamp: firebase.firestore.FieldValue.serverTimestamp(), read:false };
  try {
    await db.collection('chats').doc(roomId).collection('messages').add(message);
    await db.collection('chats').doc(roomId).set({
      participants: [state.user.id, state.selectedUser.id],
      lastMessage: content,
      lastMessageTime: firebase.firestore.FieldValue.serverTimestamp(),
      [`unread_${state.selectedUser.id}`]: firebase.firestore.FieldValue.increment(1)
    }, { merge:true });
    input.value = '';
    // push via Cloud Function can be added
  } catch(e){ console.error(e); alert('×©×’×™××” ×‘×©×œ×™×—×ª ×”×”×•×“×¢×”'); }
}

/* recompute global unread */
async function updateUnreadTotal(){
  if(!state.user) return;
  try {
    let total = 0;
    const snap = await db.collection('chats').where('participants','array-contains', state.user.id).get();
    snap.forEach(d=>{
      const data = d.data();
      const v = data[`unread_${state.user.id}`] || 0;
      total += v;
    });
    state.unreadTotal = total;
    updateHeader();
  } catch(e){ console.warn('updateUnreadTotal', e); }
}

/* ===================== Forums functions ===================== */
function showCreateForumModal(){ document.getElementById('createForumModal').classList.remove('hidden'); }
function hideCreateForumModal(){ document.getElementById('createForumModal').classList.add('hidden'); }
async function createForum(){
  const title = document.getElementById('newForumTitle').value.trim();
  const desc = document.getElementById('newForumDesc').value.trim();
  if(!title) return alert('×”×–×Ÿ ×›×•×ª×¨×ª');
  try {
    const doc = await db.collection('forums').add({ title, description: desc, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
    state.forums.unshift({ id: doc.id, title, description: desc });
    hideCreateForumModal();
    render();
  } catch(e){ console.error('createForum', e); alert('×©×’×™××”'); }
}
function searchForums(){
  const q = document.getElementById('forumSearch').value.trim().toLowerCase();
  const arr = (state.forums||[]).filter(f => !q || (f.title && f.title.toLowerCase().includes(q)) || (f.description && f.description.toLowerCase().includes(q)));
  const el = document.getElementById('forumsFullList'); if(!el) return;
  el.innerHTML = arr.map(f=>`<div class="p-3 border rounded mb-2"><div class="font-semibold">${escapeHtml(f.title)}</div><div class="text-sm small-muted">${escapeHtml(f.description||'')}</div><div class="mt-2"><button class="pill btn-primary" onclick="openForum('${f.id}')">×¤×ª×—</button>${state.user && state.user.role==='admin'?` <button class="pill bg-red-400" onclick="deleteForum('${f.id}')">××—×§</button>`:''}</div></div>`).join('');
}
async function openForum(id){
  try {
    const doc = await db.collection('forums').doc(id).get();
    if(!doc.exists) return alert('×¤×•×¨×•× ×œ× ×§×™×™×');
    const data = doc.data();
    const postsSnap = await db.collection('forums').doc(id).collection('posts').orderBy('createdAt','desc').get();
    const posts = postsSnap.docs.map(d=>({ id:d.id, ...d.data() }));
    const html = `<div class="p-4"><div class="flex justify-between items-center mb-3"><div><h3 class="font-semibold">${escapeHtml(data.title)}</h3><div class="text-sm small-muted">${escapeHtml(data.description||'')}</div></div><div><button class="pill bg-white border" onclick="render()">×—×–×•×¨</button></div></div><div class="mb-3"><button class="pill btn-primary" onclick="createPostPrompt('${id}')">×¦×•×¨ ×¤×•×¡×˜</button></div><div>${posts.map(p=>`<div class="p-3 border rounded mb-2"><div class="font-semibold">${escapeHtml(p.title)}</div><div class="text-sm">${escapeHtml(p.body)}</div><div class="text-xs small-muted mt-2">${p.createdAt? new Date(p.createdAt.seconds*1000).toLocaleString():''}</div><div class="mt-2"><button class="pill bg-white border" onclick="showComments('${id}','${p.id}')">×ª×’×•×‘×•×ª</button> ${state.user && state.user.role==='admin'?`<button class="pill bg-red-400" onclick="deletePost('${id}','${p.id}')">××—×§</button>`:''}</div></div>`).join('')}</div></div>`;
    document.getElementById('root').innerHTML = `<div class="card p-4">${html}</div>`;
  } catch(e){ console.error('openForum', e); alert('×©×’×™××” ×‘×˜×¢×™× ×ª ×¤×•×¨×•×'); }
}
function createPostPrompt(forumId){ const t = prompt('×›×•×ª×¨×ª ×”×¤×•×¡×˜:'); if(!t) return; const b = prompt('×ª×•×›×Ÿ ×”×¤×•×¡×˜:'); if(!b) return; db.collection('forums').doc(forumId).collection('posts').add({ title:t, body:b, authorId: state.user? state.user.id : null, createdAt: firebase.firestore.FieldValue.serverTimestamp() }).then(()=> openForum(forumId)); }
function showComments(forumId, postId){ db.collection('forums').doc(forumId).collection('posts').doc(postId).collection('comments').orderBy('createdAt','asc').get().then(snap=>{ const comments = snap.docs.map(d=>d.data()); const html = `<div class="p-4"><div class="mb-3"><button class="pill bg-white border" onclick="openForum('${forumId}')">×—×–×•×¨</button></div><div>${comments.map(c=>`<div class="p-2 border rounded mb-2"><div class="text-sm">${escapeHtml(c.text)}</div><div class="text-xs small-muted mt-1">${c.createdAt? new Date(c.createdAt.seconds*1000).toLocaleString():''}</div></div>`).join('')}</div><div class="mt-3"><button class="pill btn-primary" onclick="addComment('${forumId}','${postId}')">×”×•×¡×£ ×ª×’×•×‘×”</button></div></div>`; document.getElementById('root').innerHTML = `<div class="card p-4">${html}</div>`; }); }
function addComment(forumId, postId){ const t = prompt('×›×ª×•×‘ ×ª×’×•×‘×”:'); if(!t) return; db.collection('forums').doc(forumId).collection('posts').doc(postId).collection('comments').add({ text:t, authorId: state.user? state.user.id : null, createdAt: firebase.firestore.FieldValue.serverTimestamp() }).then(()=> showComments(forumId, postId)); }
async function deleteForum(id){ if(!confirm('××—×§ ×¤×•×¨×•×?')) return; await db.collection('forums').doc(id).delete(); state.forums = state.forums.filter(f=>f.id!==id); render(); }
async function deletePost(forumId, postId){ if(!confirm('××—×§ ×¤×•×¡×˜?')) return; await db.collection('forums').doc(forumId).collection('posts').doc(postId).delete(); openForum(forumId); }

/* ===================== Activities functions ===================== */
function showCreateActivityModal(){ document.getElementById('createActivityModal').classList.remove('hidden'); }
function hideCreateActivityModal(){ document.getElementById('createActivityModal').classList.add('hidden'); }
async function createActivity(){
  const title = document.getElementById('actTitle').value.trim();
  const date = document.getElementById('actDate').value;
  const location = document.getElementById('actLocation').value.trim();
  const capacity = parseInt(document.getElementById('actCapacity').value) || null;
  const desc = document.getElementById('actDesc').value.trim();
  if(!title) return alert('×”×–×Ÿ ×›×•×ª×¨×ª');
  try {
    const doc = await db.collection('activities').add({
      title, location, capacity, description: desc,
      ownerId: state.user ? state.user.id : null,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    state.activities.unshift({ id: doc.id, title, location, capacity, description: desc, ownerId: state.user?state.user.id:null });
    hideCreateActivityModal();
    render();
  } catch(e){ console.error(e); alert('×©×’×™××” ×‘×™×¦×™×¨×ª ×¤×¢×™×œ×•×ª'); }
}

async function openActivity(id){
  const doc = await db.collection('activities').doc(id).get();
  if(!doc.exists) return alert('×¤×¢×™×œ×•×ª ×œ× ×§×™×™××ª');
  const data = doc.data();
  const attendeesSnap = await db.collection('activities').doc(id).collection('attendees').get();
  const attendees = attendeesSnap.docs.map(d=>({ id:d.id, ...d.data() }));
  const taken = attendees.length;
  const spotsText = data.capacity ? `${taken} / ${data.capacity}` : '×œ×œ× ×”×’×‘×œ×”';
  let html = `<div class="p-4"><div class="flex justify-between items-center mb-3"><div><h3 class="font-semibold">${escapeHtml(data.title)}</h3><div class="text-sm small-muted">${escapeHtml(data.location||'')} â€¢ ${spotsText}</div></div><div><button class="pill bg-white border" onclick="render()">×—×–×•×¨</button></div></div><div class="mb-3"><div class="text-sm">${escapeHtml(data.description||'')}</div></div><div class="mb-3"><div class="font-semibold">××©×ª×ª×¤×™×</div>${attendees.map(a=>`<div class="p-2 border rounded mb-1">${escapeHtml(a.name || a.email)}</div>`).join('')}</div><div class="flex gap-2">`;
  if(state.user){
    const isAtt = attendees.some(a=>a.id===state.user.id);
    if(isAtt) html += `<button class="pill bg-white border" onclick="leaveActivity('${id}')">×¢×–×•×‘ ×¤×¢×™×œ×•×ª</button>`; else html += `<button class="pill btn-primary" onclick="joinActivity('${id}', ${data.capacity || 'null'})">×”×™×¨×©×</button>`;
    if(state.user.id === data.ownerId || state.user.role==='admin'){
      html += `<button class="pill btn-sec" onclick="messageActivity('${id}')">×©×œ×— ×”×•×“×¢×” ×œ×¨×©×•××™×</button>`;
    }
  } else {
    html += `<button class="pill bg-white border" onclick="goTo('login')">×”×ª×—×‘×¨ ×›×“×™ ×œ×”×¨×©×</button>`;
  }
  html += `</div></div>`;
  document.getElementById('root').innerHTML = `<div class="card p-4">${html}</div>`;
}
async function joinActivity(id, capacity){
  if(!state.user) return goTo('login');
  const attendeesRef = db.collection('activities').doc(id).collection('attendees');
  const snap = await attendeesRef.get();
  if(capacity && snap.size >= capacity) return alert('×”×¤×¢×™×œ×•×ª ××œ××”');
  await attendeesRef.doc(state.user.id).set({ name: state.user.name, joinedAt: firebase.firestore.FieldValue.serverTimestamp() });
  alert('× ×¨×©××ª ×œ×¤×¢×™×œ×•×ª');
  fetchInitial();
}
async function leaveActivity(id){
  await db.collection('activities').doc(id).collection('attendees').doc(state.user.id).delete();
  alert('×¢×–×‘×ª ×¤×¢×™×œ×•×ª');
  fetchInitial();
}
async function editActivityPrompt(id){
  const doc = await db.collection('activities').doc(id).get();
  if(!doc.exists) return alert('×œ× ×§×™×™×');
  const data = doc.data();
  const title = prompt('×›×•×ª×¨×ª', data.title); if(!title) return;
  const location = prompt('××™×§×•×', data.location||''); 
  const capacity = prompt('×›××•×ª ××§×•××•×ª (×¨×™×§ = ×œ×œ× ×”×’×‘×œ×”)', data.capacity || '');
  const desc = prompt('×ª×™××•×¨', data.description||'');
  await db.collection('activities').doc(id).update({ title, location, capacity: capacity? parseInt(capacity): null, description: desc });
  alert('×¢×•×“×›×Ÿ');
  fetchInitial();
}
async function deleteActivity(id){ if(!confirm('××—×§ ×¤×¢×™×œ×•×ª?')) return; await db.collection('activities').doc(id).delete(); fetchInitial(); }

/* send message to all attendees (store as activityMessages) */
async function messageActivity(activityId){
  const text = prompt('×”×•×“×¢×” ×œ×¨×©×•××™×:');
  if(!text) return;
  await db.collection('activities').doc(activityId).collection('activityMessages').add({ text, senderId: state.user.id, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
  alert('× ×©×œ×—×” ×”×•×“×¢×” (× ×©××¨×” ×‘-Firestore).');
}

/* ===================== Help center functions ===================== */
function showHelpModal(){ document.getElementById('helpModal').classList.remove('hidden'); const sel=document.getElementById('helpCatSelect'); if(sel) sel.innerHTML = (state.helpCategories||[]).map(c=>`<option value="${c.id}">${escapeHtml(c.title||c.name||'')}</option>`).join(''); }
function hideHelpModal(){ document.getElementById('helpModal').classList.add('hidden'); }
async function submitHelpRequest(){
  const cat = document.getElementById('helpCatSelect').value;
  const title = document.getElementById('helpTitle').value.trim();
  const body = document.getElementById('helpBody').value.trim();
  if(!title||!body) return alert('××œ× ×›×•×ª×¨×ª ×•×ª×™××•×¨');
  await db.collection('helpRequests').add({ categoryId: cat, title, body, authorId: state.user? state.user.id : null, status:'open', createdAt: firebase.firestore.FieldValue.serverTimestamp() });
  alert('×”×‘×§×©×” × ×©×œ×—×” ×œ×§×”×™×œ×”');
  hideHelpModal();
  fetchInitial();
}

/* admin help categories */
async function createHelpCategory(){
  const name = document.getElementById('newHelpCat').value.trim();
  if(!name) return alert('×”×–×Ÿ ×©× ×§×˜×’×•×¨×™×”');
  const doc = await db.collection('helpCenter').add({ title: name });
  state.helpCategories.push({ id: doc.id, title: name });
  render();
}
async function deleteHelpCategory(id){ if(!confirm('××—×§ ×§×˜×’×•×¨×™×”?')) return; await db.collection('helpCenter').doc(id).delete(); state.helpCategories = state.helpCategories.filter(c=>c.id!==id); render(); }

/* ===================== Registration / Auth ===================== */
async function doRegister(){
  const name = document.getElementById('regName').value.trim();
  const username = document.getElementById('regUsername').value.trim();
  const email = document.getElementById('regEmail').value.trim();
  const pwd = document.getElementById('regPwd').value;
  const age = parseInt(document.getElementById('regAge').value);
  const city = document.getElementById('regCity').value;
  const agree = document.getElementById('agreeRules').checked;
  if(!name || !email || !pwd || !age || !agree) return alert('××œ× ××ª ×›×œ ×”×©×“×•×ª ×•×”×¡×›×•× ×œ×ª×§× ×•×Ÿ');
  const hobbyChecks = Array.from(document.querySelectorAll('#hobbiesList input[type=checkbox]')).filter(i=>i.checked).map(i=>i.value);
  const hobbyOther = document.getElementById('hobbyOtherChk') && document.getElementById('hobbyOtherChk').checked ? document.getElementById('hobbyOtherText').value.trim() : '';
  const hobbies = hobbyOther ? [...hobbyChecks.filter(h=>'××—×¨'!==h), hobbyOther] : hobbyChecks;
  const contribChecks = Array.from(document.querySelectorAll('#contribList input[type=checkbox]')).filter(i=>i.checked).map(i=>i.value);
  const contribOther = document.getElementById('contribOtherChk') && document.getElementById('contribOtherChk').checked ? document.getElementById('contribOtherText').value.trim() : '';
  const contributions = contribOther ? [...contribChecks.filter(c=>'××—×¨'!==c), contribOther] : contribChecks;
  if(age < 60) return alert('×”×¨×©××” ××•×’×‘×œ×ª ×œ×’×™×œ 60 ×•××¢×œ×”. ×× ×™×© ×¦×•×¨×š ×‘×©×™× ×•×™ ×¤× ×” ×œ×× ×”×œ.');
  try {
    const cred = await auth.createUserWithEmailAndPassword(email, pwd);
    const uid = cred.user.uid;
    let avatarUrl = null;
    const fileIn = document.getElementById('profileImage');
    if(fileIn && fileIn.files && fileIn.files[0]){
      avatarUrl = await readFileAsDataURL(fileIn.files[0]);
    } else {
      const emoji = document.getElementById('emojiChoice').value.trim();
      if(emoji) avatarUrl = null;
    }
    const doc = {
      name, username, email, age, city, hobbies, contributions, role: 'user', isActive: true, joinDate: firebase.firestore.FieldValue.serverTimestamp(),
      avatarDataUrl: avatarUrl || null,
      avatarEmoji: (!avatarUrl && document.getElementById('emojiChoice')? document.getElementById('emojiChoice').value.trim() : null)
    };
    await db.collection('users').doc(uid).set(doc);
    alert('× ×¨×©××ª ×‘×”×¦×œ×—×”! ×”×™×›× ×¡ ×›×¢×ª.');
  } catch(e){ console.error('register err', e); alert('×©×’×™××” ×‘×”×¨×©××”: ' + (e && e.message)); }
}
function readFileAsDataURL(file){
  return new Promise((res, rej)=>{
    const r = new FileReader();
    r.onload = ()=>res(r.result);
    r.onerror = rej;
    r.readAsDataURL(file);
  });
}
async function doLogin(){
  const email = document.getElementById('loginEmail').value;
  const pwd = document.getElementById('loginPwd').value;
  if(!email||!pwd) return alert('×”×›× ×¡ ××™××™×™×œ ×•×¡×™×¡××”');
  try {
    await auth.signInWithEmailAndPassword(email, pwd);
  } catch(e){ alert('×©×’×™××” ×‘×”×ª×—×‘×¨×•×ª: ' + (e && e.message)); }
}

/* admin delete user */
async function adminDeleteUser(userId){
  if(!confirm('××—×§ ××©×ª××© ×-Firestore? (×œ× ××•×—×§ ×-Auth)')) return;
  await db.collection('users').doc(userId).delete();
  state.users = state.users.filter(u=>u.id!==userId);
  render();
  alert('× ××—×§ ×-Firestore. ×œ××—×™×§×” ××œ××” ×™×© ×œ×”×©×ª××© ×‘-Admin SDK/Cloud Function.');
}

/* promote to senior */
async function adminPromoteToSenior(userId){
  const perms = prompt('×¨×©×•× ×”×¨×©××•×ª ×¢×‘×•×¨ ××©×ª××© ×‘×›×™×¨ (comma-separated): deleteComments, manageForums, manageActivities, handleHelpRequests', 'deleteComments,manageForums');
  const arr = perms ? perms.split(',').map(s=>s.trim()) : [];
  await db.collection('users').doc(userId).update({ role: 'senior', seniorPermissions: arr });
  alert('×¢×•×“×›×Ÿ');
  fetchInitial();
}

/* ===================== Auth state / presence ===================== */
auth.onAuthStateChanged(async user=>{
  if(user){
    // ensure user doc exists
    const docRef = db.collection('users').doc(user.uid);
    const docSnap = await docRef.get();
    if(!docSnap.exists){
      await docRef.set({ name: user.email.split('@')[0], email:user.email, role: (user.email==='meircha.ai@gmail.com')?'admin':'user', isActive:true, joinDate: firebase.firestore.FieldValue.serverTimestamp() });
    }
    const d = (await docRef.get()).data();
    state.user = { id:user.uid, email:user.email, name: d.name || '××©×ª××©', role: d.role || 'user', city: d.city || '', isActive: d.isActive!==false, avatarEmoji: d.avatarEmoji || null };
    // presence
    await db.collection('users').doc(user.uid).update({ isOnline: true }).catch(()=>{});
    window.addEventListener('beforeunload', ()=>{ db.collection('users').doc(user.uid).update({ isOnline: false }).catch(()=>{}); });
    window.addEventListener('blur', ()=>{ db.collection('users').doc(user.uid).update({ isOnline: false }).catch(()=>{}); });
    window.addEventListener('focus', ()=>{ db.collection('users').doc(user.uid).update({ isOnline: true }).catch(()=>{}); });
    // load data
    await fetchInitial();
    // messaging
    initMessagingForUser(user.uid).catch(()=>{});
    state.screen = 'home';
    render();
  } else {
    // user logged out
    try { if(state.user && state.user.id) await db.collection('users').doc(state.user.id).update({ isOnline: false }); } catch(e){/*ignore*/ }
    state.user = null;
    await fetchInitial();
    state.screen = 'login';
    render();
  }
});

/* logout button handler in header */
document.addEventListener('click', function(e){
  if(e.target && e.target.id === 'authBtn'){
    if(state.user) auth.signOut();
    else goTo('login');
  }
});

/* ===================== Messaging (FCM client) ===================== */
async function initMessagingForUser(uid){
  try {
    const perm = await Notification.requestPermission();
    if(perm !== 'granted'){ console.log('notifications not granted:', perm); return; }
    const token = await messaging.getToken({ vapidKey: null }).catch(e=>{ console.warn('getToken err', e); return null; });
    if(token) await db.collection('users').doc(uid).update({ fcmToken: token });
    messaging.onMessage(payload => {
      console.log('fg msg', payload);
      if(Notification.permission === 'granted'){
        const n = payload.notification || {};
        new Notification(n.title || '×”×•×“×¢×”', { body: n.body || '' });
      }
    });
  } catch(e){ console.warn('initMessaging err', e); }
}

/* ===================== Utilities ===================== */
const TIP_LIST = ["×¦××• ×œ×”×œ×™×›×” ×§×¦×¨×” ×•×”×ª×—×‘×¨×• ×œ×˜×‘×¢.", "×”×ª×§×©×¨×• ×œ×—×‘×¨ ×•×ª×©×ª×¤×• ×–×™×›×¨×•×Ÿ × ×—××“.", "× ×¡×• ×œ×”×›×™×Ÿ ×× ×” ×—×“×©×” ×¤×©×•×˜×”.", "×¢×©×• ×ª×¨×’×™×œ×™ × ×©×™××•×ª ×©×œ 5 ×“×§×•×ª.", "×›×ª×‘×• ××›×ª×‘ ×ª×•×“×” ×œ××“× ×™×§×¨."];
function getDailyTip(){ const d = new Date(); return TIP_LIST[d.getDate() % TIP_LIST.length]; }
function renderDailyTipSafe(){
  try {
    const el = document.getElementById('dailyTipContainer');
    if(!el){ console.warn('dailyTipContainer missing'); return; }
    if(state.dailyTips && state.dailyTips.length){
      el.innerText = state.dailyTips[0].text || getDailyTip();
    } else {
      el.innerText = getDailyTip();
    }
    // wire header button safely
    const btn = document.getElementById('refreshTipBtnHeader');
    if(btn){ btn.onclick = ()=>{ cycleTip(); }; }
  } catch(e){ console.error('renderDailyTipSafe', e); }
}
function cycleTip(){
  if(state.dailyTips && state.dailyTips.length){
    // rotate array
    state.dailyTips.push(state.dailyTips.shift());
    renderDailyTipSafe();
  } else {
    // fallback random tip
    const el = document.getElementById('dailyTipContainer');
    if(el) el.innerText = getDailyTip();
  }
}

/* safe refreshTip for legacy code */
function refreshTip(text){
  const el = document.getElementById('dailyTipContainer') || document.getElementById('dailyTipText');
  if(!el){ console.warn('no daily tip element'); return; }
  el.innerText = text || getDailyTip();
}

/* populate city filters */
function populateCityFilters(){
  const cf = document.getElementById('cityFilter'); if(cf){ cf.innerHTML = `<option value="">×”×›×œ</option>${state.cities.map(c=>`<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join('')}`; }
  const cc = document.getElementById('chatCityFilter'); if(cc){ cc.innerHTML = `<option value="">×”×›×œ</option>${state.cities.map(c=>`<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join('')}`; }
}

/* ========== Admin lists render ========== */
async function loadAdminLists(){
  if(!state.user || state.user.role!=='admin') return;
  const usersEl = document.getElementById('adminUsersList'); if(!usersEl) return;
  usersEl.innerHTML = (state.users||[]).map(u=>`<div class="p-2 border rounded mb-2 flex justify-between items-center">${escapeHtml(u.name)}<div><button class="pill bg-red-400" onclick="adminDeleteUser('${u.id}')">××—×§</button> <button class="pill btn-sec" onclick="adminPromoteToSenior('${u.id}')">×§×“×</button></div></div>`).join('');
  const repEl = document.getElementById('adminHelpCats'); if(repEl) repEl.innerHTML = (state.helpCategories||[]).map(c=>`<div class="p-2 border rounded mb-2 flex justify-between items-center">${escapeHtml(c.title||c.name||'')}<div><button class="pill bg-red-400" onclick="deleteHelpCategory('${c.id}')">××—×§</button></div></div>`).join('');
  const actEl = document.getElementById('adminActivities'); if(actEl) actEl.innerHTML = (state.activities||[]).map(a=>`<div class="p-2 border rounded mb-2">${escapeHtml(a.title)} â€¢ ${escapeHtml(a.location||'')} <div class="mt-2"><button class="pill bg-white border" onclick="openActivity('${a.id}')">×¤×ª×—</button></div></div>`).join('');
}

/* ========== fetchInitial wrapper will be called on load/auth change ========== */

/* ========== Event bindings ========== */
window.addEventListener('load', ()=>{
  render();
  // call fetchInitial safely after short delay to allow auth to settle
  setTimeout(()=>{ fetchInitial().catch(e=>console.warn('initial fetch err', e)); }, 300);
  // safe periodic unread update
  setInterval(()=>{ if(state.user) updateUnreadTotal().catch(()=>{}); }, 25000);
});

/* ===================== Error handling notes ===================== */
/*
 - ×× ×ª×§×‘×œ 'Missing or insufficient permissions' â€” ×•×“× ×©×”-Firestore Rules ×××¤×©×¨×™× ×§×¨×™××” ×œ××©×ª××©×™× ×”××—×•×‘×¨×™×.
 - ×œ×¦×•×¨×š ×‘×“×™×§×•×ª: ××¤×©×¨ ×œ×”×¤×¢×™×œ ×–×× ×™×ª
   match /{document=**} { allow read, write: if true; }
   ××‘×œ ××œ ×ª×©×›×— ×œ×”×—×–×™×¨ ×œ×›×œ×œ×™× ×××•×‘×˜×—×™× ×œ×¤× ×™ ×¤×¨×•×“×§×©×Ÿ.
 - ×•×“× ×©×§×™×™××™× documents ×‘××•×¡×¤×™×: dailyTips, helpCenter (×›××• ×©×”×¡×‘×¨×ª×™ ×œ×¤× ×™).
*/

/* ===================== Cloud Function note (×œÖ¾push) =====================
 ×× ×ª×¨×¦×” ×©××©×œ×™× ×œ×š ××ª ×”-Cloud Function ×œ×¤×¨×™×¡×”, ××›×ª×•×‘ ×§×•×‘×¥ Node.js ××•×›×Ÿ ×œ×©×™× ×‘-functions/index.js ×™×—×“ ×¢× ×”×•×¨××•×ª ×¤×¨×™×¡×”.
======================================================================= */

</script>

<div id="rulesModal" class="fixed inset-0 bg-black/30 hidden items-center justify-center z-60">
  <div class="bg-white p-6 rounded w-full max-w-2xl card">
    <h3 class="font-semibold mb-2">×ª×§× ×•×Ÿ ×”×©×™××•×© ×•×§×•×“ ×”×ª× ×”×’×•×ª ×‘×§×”×™×œ×”</h3>
    <div class="small-muted mb-4">
      <strong>×”×¢×¨×” ×—×©×•×‘×”:</strong> ××¨×›×– ×”×¢×–×¨×” ××•×¢×‘×¨ ×¢×œ ×‘×¡×™×¡ ×§×”×™×œ×ª×™ ×‘×œ×‘×“. ×‘×¢×œ×™ ×”××ª×¨ ××™× × ××¡×¤×§×™× ×™×™×¢×•×¥ ××§×¦×•×¢×™ ×•××™× × ××—×¨××™× ×¢×œ ×”×ª×›× ×™× ××• ×”×ª×•×¦××•×ª. ×¤× ×™×•×ª ×‘×ª×—×•× ××©×¤×˜×™, ×¨×¤×•××™ ××• ×¤×™× × ×¡×™ ××”×•×•×ª ×”××œ×¦×” ×‘×œ×‘×“ ×•××™×Ÿ ×œ×¨××•×ª ×‘×”×Ÿ ×ª×—×œ×™×£ ×œ×™×™×¢×•×¥ ××§×¦×•×¢×™.
    </div>
    <ol class="text-sm small-muted list-decimal ml-6">
      <li>×›×‘×“×• ×¤×¨×˜×™×•×ª ×©×œ ×—×‘×¨×™× â€” ××™×Ÿ ×œ×¤×¨×¡× ××™×“×¢ ××™×©×™ ×œ×œ× ×”×¡×›××” ×‘×¨×•×¨×”.</li>
      <li>××¡×•×¨ ×œ×©×ª×£ ×ª×›× ×™× ×¤×•×’×¢× ×™×™×, ×’×–×¢× ×™×™× ××• ×§×™×¦×•× ×™×™×.</li>
      <li>×”×™×× ×¢×• ××”×¦×¢×•×ª ××¡×—×¨×™×•×ª ×œ× ××•×¨×©×•×ª ×œ×œ× ××™×©×•×¨ ×× ×”×œ ×”×§×”×™×œ×”.</li>
      <li>×”××“××™×Ÿ ×•×¦×•×•×ª ×”×§×”×™×œ×” ×¨×©××™× ×œ×”×¡×™×¨ ×ª×•×›×Ÿ ×¤×•×’×¢× ×™ ××• ×œ×©×œ×•×œ ×’×™×©×” ×‘×”×ª×× ×œ×©×™×§×•×œ ×“×¢×ª×.</li>
      <li>××™×Ÿ ×œ×¨××•×ª ×‘×ª×›× ×™× ×™×™×¢×•×¥ ××§×¦×•×¢×™; ×œ×›×œ ×¦×•×¨×š ××§×¦×•×¢×™ ×™×© ×œ×¤× ×•×ª ×œ×’×•×¨× ××•×¡××š.</li>
    </ol>
    <div class="mt-4 flex justify-end gap-2">
      <button class="pill bg-white border" onclick="document.getElementById('rulesModal').classList.add('hidden')">×¡×’×•×¨</button>
    </div>
  </div>
</div>

</body>
</html>
