<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>קהילת קשר — בית</title>

  <!-- Tailwind (CDN) — מתאים לפרוטוטייפ/הדגמה -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

  <style>
    /* צבעים מותאמים לגיל הזהב — רכים, ניגודיות טובה */
    :root{
      --primary: #FF6B6B;     /* ורוד/אדמדם */
      --accent:  #4EC7B6;     /* טורקיז */
      --bg:      #F7F7F9;
      --card:    #FFFFFF;
      --muted:   #6B6B6B;
    }
    body { background: var(--bg); font-family: Arial, "Segoe UI", Roboto, sans-serif; color:#222; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }
    .btn-main { background: var(--accent); color: white; }
    .btn-secondary { background: var(--primary); color: white; }
    .card { background: var(--card); border-radius: 12px; box-shadow: 0 6px 18px rgba(20,20,20,0.06); }
    /* נגישות: כפתורים גדולים */
    button, .clickable { padding: .8rem 1rem; border-radius: .6rem; font-size: 1.05rem; }
    input, textarea { font-size: 1rem; }
    /* כפתור צף צ'אט */
    .fab { position: fixed; bottom: 22px; left: 22px; z-index: 60; border-radius: 999px; width: 64px; height: 64px; display:flex; align-items:center; justify-content:center; box-shadow:0 10px 20px rgba(0,0,0,0.15); }
    /* כפתורים קטנים עזר */
    .pill { padding: .4rem .6rem; border-radius:9999px; font-size:.9rem; }
  </style>
</head>
<body>

<!-- SERVICE WORKER REGISTRATION (מיקום מוקדם כדי שיעבוד מהר) -->
<script>
  // אם הפרויקט שלך נמצא תחת תיקיה שונה — שנה כאן את הנתיב ל־firebase-messaging-sw.js המתאים.
  // כאן מניחים: https://meircha.github.io/kesher-bakir/
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/kesher-bakir/firebase-messaging-sw.js')
      .then(() => console.log('SW registered (github pages path).'))
      .catch(e => console.warn('SW registration failed:', e));
  }
</script>

<div id="app" class="min-h-screen">
  <!-- Header -->
  <header class="bg-white shadow-sm sticky top-0 z-50">
    <div class="max-w-5xl mx-auto px-4 py-4 flex items-center justify-between">
      <div class="flex items-center gap-4">
        <img src="https://images.unsplash.com/photo-1534528741775-53994a69daeb?q=80&w=80&auto=format&fit=crop&ixlib=rb-4.0.3&s=3a9a1d93b6e0b2d0a5b7b8a8c0c6a8b7" alt="לוגו" class="w-12 h-12 rounded-full object-cover border-2 border-gray-100 shadow-sm">
        <div>
          <div class="text-xl font-bold" style="color:var(--primary)">קהילת קשר</div>
          <div class="text-sm text-gray-500">מרחב תמיכה וחברות לבני 60+</div>
        </div>
      </div>

      <div class="flex items-center gap-3">
        <button onclick="goTo('home')" class="pill bg-white border border-gray-200">בית</button>
        <button onclick="goTo('forums')" class="pill bg-white border border-gray-200">פורומים</button>
        <button onclick="goTo('activities')" class="pill bg-white border border-gray-200">פעילויות</button>
        <button onclick="goTo('users')" class="pill bg-white border border-gray-200">חברים / צ'אט</button>
        <button id="authBtn" class="pill btn-secondary">התחבר</button>
      </div>
    </div>
  </header>

  <!-- Main content -->
  <main class="max-w-5xl mx-auto px-4 py-8" id="root"></main>

  <!-- צף - מעבר לצ'אט מהיר -->
  <button class="fab btn-main card clickable" title="צ'אט מהיר" onclick="goTo('users')" aria-label="צ'אט מהיר">
    <i class="fa-solid fa-comments" style="font-size:22px;"></i>
  </button>
</div>

<!-- Firebase v8 (מתאים למה שהיה בקוד שלך) -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-messaging.js"></script>

<script>
/* ==================  CONFIG  ===================
   החלף כאן אם יש לך קונפיג אחר. שמרתי את הקונפיג שהיה בקובץ שלך.
   ================================================== */
const firebaseConfig = {
  apiKey: "AIzaSyCrcxC420HW5PXGNd8M4KuclUkiJSwHreM",
  authDomain: "kesher-bakir.firebaseapp.com",
  projectId: "kesher-bakir",
  storageBucket: "kesher-bakir.firebasestorage.app",
  messagingSenderId: "671996189455",
  appId: "1:671996189455:web:dbe089d69a85a2ab38fc7a",
  measurementId: "G-42EWSKFXW"
};

if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const messaging = firebase.messaging();

/* נסיון לאפשר persistence, אם אפשרי */
if (db.enablePersistence) {
  db.enablePersistence().catch(err => {
    console.warn('Could not enable persistence:', err && err.code);
  });
}

/* ================  STATE  ================= */
const state = {
  user: null,
  screen: 'loading',
  users: [],
  forums: [],
  activities: [],
  chatMessages: [],
  selectedUser: null,
  listeners: [],
  unreadCounts: {}
};

/* ==================  UI RENDERERS  ================== */
function el(html){ const div=document.createElement('div'); div.innerHTML=html; return div.firstElementChild; }

function renderHero(){
  // תמונה גדולה + כרטיסים בולטים
  return `
    <section class="card overflow-hidden mb-6">
      <div class="relative">
        <img src="https://images.unsplash.com/photo-1524504388940-b1c1722653e1?q=80&w=1600&auto=format&fit=crop&ixlib=rb-4.0.3&s=3d6c2b2b5d3af9c1b8f8f1a5b7c4b2a1" alt="קהילה" class="w-full h-48 object-cover"/>
        <div style="background: linear-gradient(180deg, rgba(0,0,0,0.00), rgba(0,0,0,0.35));"
             class="absolute inset-0"></div>
        <div class="absolute left-6 bottom-6 text-right text-white">
          <div class="text-2xl font-bold">ברוכים הבאים לקהילת קשר</div>
          <div class="text-lg">מקום בטוח, תומך וחברותי לבני 60 ומעלה</div>
        </div>
      </div>
      <div class="p-6 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
        <div class="card p-4 flex items-center gap-4 clickable" onclick="goTo('chatCard')">
          <div class="w-14 h-14 rounded-full bg-gradient-to-tr from-[#4EC7B6] to-[#2FB3A3] flex items-center justify-center text-white text-xl"><i class="fa-solid fa-comments"></i></div>
          <div>
            <div class="text-lg font-semibold">צ'אט</div>
            <div class="text-sm text-gray-500">שוחחו עם חברים ותמכו אחד בשני</div>
          </div>
        </div>

        <div class="card p-4 flex items-center gap-4 clickable" onclick="goTo('activities')">
          <div class="w-14 h-14 rounded-full bg-gradient-to-tr from-[#FF9AA2] to-[#FF6B6B] flex items-center justify-center text-white text-xl"><i class="fa-solid fa-calendar-day"></i></div>
          <div>
            <div class="text-lg font-semibold">פעילויות</div>
            <div class="text-sm text-gray-500">מפגשים מקומיים וסדנאות קרובות אליך</div>
          </div>
        </div>

        <div class="card p-4 flex items-center gap-4 clickable" onclick="goTo('forums')">
          <div class="w-14 h-14 rounded-full bg-gradient-to-tr from-[#A0D8EF] to-[#6FBDE8] flex items-center justify-center text-white text-xl"><i class="fa-solid fa-people-arrows"></i></div>
          <div>
            <div class="text-lg font-semibold">פורומים</div>
            <div class="text-sm text-gray-500">שאלות, עצות וחוויות של הקהילה</div>
          </div>
        </div>

        <div class="card p-4 flex items-center gap-4 clickable" onclick="goTo('tip')">
          <div class="w-14 h-14 rounded-full bg-gradient-to-tr from-[#FFD27A] to-[#FFCD4D] flex items-center justify-center text-white text-xl"><i class="fa-solid fa-lightbulb"></i></div>
          <div>
            <div class="text-lg font-semibold">טיפ יומי</div>
            <div class="text-sm text-gray-500">רעיונות קטנים לשיפור היום-יום</div>
          </div>
        </div>

        <div class="card p-4 flex items-center gap-4 clickable" onclick="goTo('users')">
          <div class="w-14 h-14 rounded-full bg-gradient-to-tr from-[#BEB3FF] to-[#8F7BFF] flex items-center justify-center text-white text-xl"><i class="fa-solid fa-user-friends"></i></div>
          <div>
            <div class="text-lg font-semibold">חברים מחוברים</div>
            <div class="text-sm text-gray-500">ראו מי זמין עכשיו וקבלו רעיונות לשיחה</div>
          </div>
        </div>

      </div>
    </section>
  `;
}

function renderHome(){
  return `
    ${renderHero()}
    <section class="mb-6">
      <div class="card p-4">
        <div class="flex items-center justify-between">
          <div>
            <div class="text-xl font-bold">טיפ יומי</div>
            <div id="dailyTip" class="text-lg text-gray-700 mt-2">מטעין...</div>
          </div>
          <div>
            <button onclick="refreshTip()" class="btn-main pill">טען טיפ אחר</button>
          </div>
        </div>
      </div>
    </section>

    <section class="grid md:grid-cols-2 gap-4">
      <div class="card p-4">
        <div class="text-lg font-bold mb-2">פורומים אחרונים</div>
        <div id="forumsList" class="space-y-3 text-gray-700">טוען...</div>
      </div>

      <div class="card p-4">
        <div class="text-lg font-bold mb-2">פעילויות קרובות</div>
        <div id="activitiesList" class="space-y-3 text-gray-700">טוען...</div>
      </div>
    </section>
  `;
}

function renderUsers(){
  const list = state.users.filter(u=>u.isActive!==false && u.id!==state.user?.id);
  return `
    <div class="card p-4">
      <div class="flex items-center justify-between mb-4">
        <div class="text-xl font-bold">חברים</div>
        <div class="text-sm text-gray-500">לחצו לפתיחת צ'אט</div>
      </div>
      <div class="space-y-3">
        ${list.map(u=>`
          <div class="p-3 flex items-center justify-between border rounded">
            <div class="flex items-center gap-3">
              <div class="w-12 h-12 rounded-full bg-gray-200 flex items-center justify-center text-xl">${(u.name||'א').charAt(0)}</div>
              <div>
                <div class="font-semibold">${u.name}</div>
                <div class="text-sm text-gray-500">${u.city || ''}</div>
              </div>
            </div>
            <div class="flex items-center gap-2">
              <button class="btn-main pill" onclick="openChat('${u.id}','${escapeHtml(u.name)}')">צ'אט</button>
            </div>
          </div>
        `).join('')}
      </div>
    </div>
  `;
}

function renderForums(){
  return `
    <div class="card p-4">
      <div class="text-xl font-bold mb-3">פורומים</div>
      <div id="forumsListFull" class="space-y-3"></div>
    </div>
  `;
}

function renderActivities(){
  return `
    <div class="card p-4">
      <div class="text-xl font-bold mb-3">פעילויות קרובות</div>
      <div id="activitiesListFull" class="space-y-3"></div>
    </div>
  `;
}

/* ======= Chat screen ======= */
function renderChat(){
  if(!state.selectedUser) return goTo('users');
  return `
    <div class="card p-4 h-[70vh] flex flex-col">
      <div class="flex items-center justify-between mb-3">
        <div>
          <div class="text-xl font-bold">שיחה עם ${escapeHtml(state.selectedUser.name)}</div>
          <div class="text-sm text-gray-500">היסטוריית ההודעות</div>
        </div>
        <div>
          <button class="btn-secondary pill" onclick="closeChat()">סגור</button>
        </div>
      </div>
      <div id="chatBox" class="flex-grow overflow-y-auto p-3 space-y-3 border rounded bg-gray-50"></div>
      <div class="mt-3 flex gap-2 items-center">
        <input id="chatInput" type="text" placeholder="הקלד הודעה..." class="flex-grow p-3 border rounded" onkeydown="if(event.key==='Enter') sendMessage()" aria-label="שדה הודעה">
        <button class="btn-main clickable" onclick="sendMessage()">שלח</button>
      </div>
    </div>
  `;
}

/* ====== small helpers ====== */
function escapeHtml(s){ return (s||'').replace(/'/g,"\\'").replace(/"/g,'\"'); }
function getChatRoomId(a,b){ if(!a||!b) return null; return a < b ? `${a}_${b}` : `${b}_${a}`; }
function scrollChatToBottom(){ const cb=document.getElementById('chatBox'); if(cb) cb.scrollTop = cb.scrollHeight; }

/* ==============  Render manager  ============== */
function renderRoot(){
  let html = '';
  switch(state.screen){
    case 'loading': html = '<div class="p-8 text-center">טוען...</div>'; break;
    case 'home': html = renderHome(); break;
    case 'users': html = renderUsers(); break;
    case 'forums': html = renderForums(); break;
    case 'activities': html = renderActivities(); break;
    case 'chat': html = renderChat(); break;
    case 'tip': html = `<div class="card p-4"><h2 class="text-xl font-bold">טיפ יומי</h2><div id="dailyTipLarge" class="mt-3 text-lg"></div></div>`; break;
    default: html = '<div>שגיאת ניווט</div>';
  }
  document.getElementById('root').innerHTML = html;

  // אחרי רינדור — עדכון תכנים דינמיים
  if(state.screen === 'home') {
    document.getElementById('dailyTip').innerText = getDailyTip();
    renderForumsList();
    renderActivitiesList();
  }
  if(state.screen === 'users') { /* כל המשתמשים נטענים כבר */ }
  if(state.screen === 'chat') { updateChatBox(); setTimeout(scrollChatToBottom, 80); }
  if(state.screen === 'tip') {
    const el = document.getElementById('dailyTipLarge');
    if(el) el.innerText = getDailyTip();
  }
}

/* ==============  Navigation ============== */
function goTo(screen){
  state.screen = screen;
  renderRoot();
}

/* ==============  Data fetching & realtime listeners  ============== */
async function fetchInitial(){
  try {
    const usersSnap = await db.collection('users').get();
    state.users = usersSnap.docs.map(d => ({ id: d.id, ...d.data() }));

    const forumsSnap = await db.collection('forums').get();
    state.forums = forumsSnap.docs.map(d => ({ id: d.id, ...d.data() }));

    const actsSnap = await db.collection('activities').get();
    state.activities = actsSnap.docs.map(d => ({ id: d.id, ...d.data() }));

    renderRoot();
  } catch(err){
    console.error('initial fetch error', err);
  }
}

/* מאזין להודעות בחדר הנבחר (onSnapshot) */
let currentChatUnsub = null;
function listenChat(roomId){
  if(currentChatUnsub) { currentChatUnsub(); currentChatUnsub = null; }
  state.chatMessages = [];
  currentChatUnsub = db.collection('chats').doc(roomId).collection('messages')
    .orderBy('timestamp')
    .onSnapshot(snap => {
      state.chatMessages = snap.docs.map(d => ({ id:d.id, ...d.data() }));
      // show
      if(state.screen === 'chat') updateChatBox();
      // update unread counters for UI (if any)
      updateUnreadFromRoom(roomId, snap);
      setTimeout(scrollChatToBottom, 60);
    }, err => {
      console.error('chat listen error', err);
    });
}

/* עדכון מונה לא נקראים מתוך מסמך החדר (אם קיים שדה unread_userid) */
function updateUnreadFromRoom(roomId, snap){
  db.collection('chats').doc(roomId).get().then(doc => {
    if(!doc.exists) return;
    const data = doc.data();
    if(!data) return;
    const key = `unread_${state.user?.id}`;
    const v = data[key] || 0;
    if(v>0) state.unreadCounts[roomId] = v;
    else delete state.unreadCounts[roomId];
    // יתעדכן UI כשתרנדר
    renderRoot();
  }).catch(()=>{});
}

/* =================  Send message (no double push) =================
   חשוב: כאן לא דוחפים את ההודעה ל־state באופן ידני. אנו סומכים על onSnapshot
   כדי למנוע כפילות. זה גם אומר שההודעה תופיע לאחר ש־Firestore יאשר אותה.
*/
async function sendMessage(){
  const input = document.getElementById('chatInput');
  if(!input) return;
  const content = input.value.trim();
  if(!content) return;
  if(!state.selectedUser || !state.user) return alert('שגיאה: אין משתמש נבחר או אינך מחובר');

  const roomId = getChatRoomId(state.user.id, state.selectedUser.id);
  if(!roomId) return;

  const message = {
    senderId: state.user.id,
    content,
    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
    read: false
  };

  try {
    // הוספה ל־messages collection
    await db.collection('chats').doc(roomId).collection('messages').add(message);

    // עדכון מסמך החדר (lastMessage + unread counter)
    await db.collection('chats').doc(roomId).set({
      participants: [state.user.id, state.selectedUser.id],
      lastMessage: content,
      lastMessageTime: firebase.firestore.FieldValue.serverTimestamp(),
      [`unread_${state.selectedUser.id}`]: firebase.firestore.FieldValue.increment(1)
    }, { merge: true });

    input.value = '';
    // גלילה - ההודעה תופיע עם ה־onSnapshot
  } catch(err){
    console.error('sendMessage error', err);
    alert('שגיאה בשליחת ההודעה. בדוק חיבור ו־Firestore rules.');
  }
}

/* עדכון תיבת צ'אט לפי state.chatMessages */
function updateChatBox(){
  const cb = document.getElementById('chatBox');
  if(!cb) return;
  cb.innerHTML = state.chatMessages.map(m=>{
    const isMe = m.senderId === state.user?.id;
    const time = m.timestamp && m.timestamp.toDate ? new Date(m.timestamp.toDate()).toLocaleTimeString('he-IL',{hour:'2-digit',minute:'2-digit'}) : '';
    return `<div class="${isMe?'text-right':'text-left'}"><div class="${isMe?'inline-block bg-gradient-to-tr from-[#4EC7B6] to-[#2FB3A3] text-white':'inline-block bg-white border'} p-3 rounded-lg max-w-[85%]">${escapeHtml(m.content)}<div class="text-xs mt-1 text-gray-400">${time}${isMe && m.read? ' ✅':''}</div></div></div>`;
  }).join('');
}

/* פתיחת שיחה (נקרא ע"י כפתור ברשימת משתמשים) */
function openChat(userId, userName){
  const user = state.users.find(u=>u.id===userId);
  if(!user) {
    // במידה ואין במטמון נטען אותו
    db.collection('users').doc(userId).get().then(d => {
      if(d.exists) {
        state.selectedUser = { id: d.id, ...d.data() };
        state.screen = 'chat';
        renderRoot();
        const roomId = getChatRoomId(state.user.id, state.selectedUser.id);
        listenChat(roomId);
      }
    });
    return;
  }
  state.selectedUser = user;
  state.screen = 'chat';
  renderRoot();
  const roomId = getChatRoomId(state.user.id, state.selectedUser.id);
  listenChat(roomId);

  // סימון מונה לא נקראים ל־0 במסמך החדר (אם קיים)
  db.collection('chats').doc(roomId).update({ [`unread_${state.user.id}`]: 0 }).catch(()=>{});
}

function closeChat(){
  if(currentChatUnsub) { currentChatUnsub(); currentChatUnsub = null; }
  state.selectedUser = null;
  goTo('home');
}

/* =========  Simple helpers for lists ========= */
function renderForumsList(){
  const el = document.getElementById('forumsList');
  if(!el) return;
  if(!state.forums.length) { el.innerHTML = '<div class="text-gray-500">אין פורומים להצגה</div>'; return; }
  el.innerHTML = state.forums.slice(0,4).map(f => `<div class="p-3 border rounded"><div class="font-semibold">${escapeHtml(f.title)}</div><div class="text-sm text-gray-500">${escapeHtml(f.description||'')}</div></div>`).join('');
  const full = document.getElementById('forumsListFull');
  if(full) full.innerHTML = state.forums.map(f=>`<div class="p-3 border rounded"><div class="font-semibold">${escapeHtml(f.title)}</div><div class="text-sm text-gray-500">${escapeHtml(f.description||'')}</div></div>`).join('');
}
function renderActivitiesList(){
  const el = document.getElementById('activitiesList');
  if(!el) return;
  if(!state.activities.length) { el.innerHTML = '<div class="text-gray-500">אין פעילויות</div>'; return; }
  el.innerHTML = state.activities.slice(0,4).map(a => `<div class="p-3 border rounded"><div class="font-semibold">${escapeHtml(a.title||'')} ${a.date? ' — ' + (new Date(a.date.seconds*1000).toLocaleDateString()):''}</div><div class="text-sm text-gray-500">${escapeHtml(a.location||'')}</div></div>`).join('');
  const full = document.getElementById('activitiesListFull');
  if(full) full.innerHTML = state.activities.map(a=>`<div class="p-3 border rounded"><div class="font-semibold">${escapeHtml(a.title||'')}</div><div class="text-sm text-gray-500">${escapeHtml(a.location||'')}</div></div>`).join('');
}

/* ======= Daily tip function ======= */
const TIP_LIST = [
  "צאו להליכה של 20 דקות — גם הקצרות עושות הבדל.",
  "התקשרו לחבר ותשאלו לשלומו — שיחה מחממת לב.",
  "שתו משקה חם ושוחחו על זיכרון טוב מעבר.",
  "עשו תרגילי נשימה של 5 דקות לשלווה.",
  "סדרו מגירה קטנה — תספיק לשיפור גדול."
];
function getDailyTip(){
  const d = new Date();
  return TIP_LIST[d.getDate() % TIP_LIST.length];
}
function refreshTip(){ document.getElementById('dailyTip').innerText = getDailyTip(); }

/* ==================  Messaging (Push) client side ================== */
/* אנו מבקשים הרשאה רק אם המשתמש מסכים (כדי לא לקבל blocked).
   הערה: שליחת דחיפות (server -> FCM) צריכה Cloud Function / server עם Admin key.
*/
async function initMessagingForUser(uid){
  try{
    // בקשת הרשאה בצורה שמבודדת שגיאות
    const perm = await Notification.requestPermission();
    if(perm !== 'granted'){ console.log('Notification permission not granted:', perm); return; }
    try {
      // אם רוצים לקבל token יש לספק vapidKey בדרך כלל; נא להשלים אם יש לך
      const token = await messaging.getToken({ vapidKey: null }).catch(e=>{ console.warn('getToken error', e); return null; });
      if(token) {
        await db.collection('users').doc(uid).update({ fcmToken: token });
        console.log('Saved FCM token for user', uid);
      }
    } catch(e){
      console.warn('Could not get token:', e);
    }
    messaging.onMessage(payload => {
      console.log('Foreground message', payload);
      // הצגה פשוטה
      if(Notification.permission === 'granted'){
        const n = payload.notification || {};
        new Notification(n.title || 'הודעה חדשה', { body: n.body || '' });
      }
    });
  } catch(e){ console.warn('init messaging err', e); }
}

/* ==================  AUTH (פשוט) ================== */
document.getElementById('authBtn').addEventListener('click', () => {
  // אם מחובר — יציאה, אחרת פתיחת חלון התחברות מהיר (ממשק מינימלי)
  if(state.user) { auth.signOut(); return; }
  const email = prompt('הקלד אימייל (לניסוי):');
  const pwd = prompt('הקלד סיסמה (לניסוי):');
  if(!email || !pwd) return alert('איברים חסרים');
  auth.signInWithEmailAndPassword(email,pwd).catch(e=>{
    alert('שגיאת התחברות: ' + e.message);
  });
});

auth.onAuthStateChanged(async u => {
  if(u){
    // קח פרטי משתמש מ־users collection
    const doc = await db.collection('users').doc(u.uid).get();
    if(!doc.exists){
      // אם אין דוק — צור משתמש בסיסי (לנראות)
      await db.collection('users').doc(u.uid).set({ name: u.email.split('@')[0], role: 'user', isActive: true, joinDate: firebase.firestore.FieldValue.serverTimestamp() });
    }
    const data = (await db.collection('users').doc(u.uid).get()).data();
    state.user = { id: u.uid, email:u.email, name: data.name || 'משתמש', role: data.role || 'user', isActive: data.isActive!==false };
    document.getElementById('authBtn').innerText = 'התנתק';
    await fetchInitial();
    // init messaging politely
    initMessagingForUser(u.uid).catch(()=>{});
    // אחרי שמטעינים — נווט לבית
    state.screen = 'home';
    renderRoot();
  } else {
    state.user = null;
    document.getElementById('authBtn').innerText = 'התחבר';
    state.screen = 'home';
    renderRoot();
  }
});

/* =====================  Startup ===================== */
window.addEventListener('load', () => {
  // טעינה ראשונית של נתונים
  fetchInitial();
  // ברירת מחדל — הבית
  state.screen = 'home';
  renderRoot();
  // small: close any chat listener on unload
  window.addEventListener('beforeunload', ()=>{ if(currentChatUnsub) currentChatUnsub(); });
});
</script>

</body>
</html>
