<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>קהילת קשר 60+</title>

  <!-- Tailwind (dev CDN — החלף ל‑build בייצור) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

  <style>
    :root{
      --primary:#2B6CB0;
      --accent:#38B2AC;
      --bg:#F7FAFC;
      --card:#FFFFFF;
      --muted:#4A5568;
      --danger:#E53E3E;
    }
    html,body { height:100%; }
    body{ background:var(--bg); font-family: "Segoe UI", Roboto, Arial, sans-serif; color:#1a202c; margin:0; padding:0; -webkit-font-smoothing:antialiased; }
    .card{ background:var(--card); border-radius:12px; box-shadow:0 6px 20px rgba(0,0,0,0.06); }
    .btn-primary{ background:var(--accent); color:white; transition:background-color .15s; }
    .btn-primary:hover{ background:#319795; }
    .btn-sec{ background:var(--primary); color:white; transition:background-color .15s; }
    .btn-sec:hover{ background:#2C5282; }
    .pill{ padding:.35rem .7rem; border-radius:9999px; font-size:.75rem; font-weight:600; }
    .small-muted{ color:var(--muted); font-size:.9rem; }
    .text-link{ color:var(--primary); cursor:pointer; text-decoration:underline; font-weight:500; }
    input:focus, textarea:focus { border-color: var(--accent); box-shadow: 0 0 0 1px var(--accent); outline: none; }
    header .nav-item.active { border-bottom: 3px solid var(--accent); padding-bottom: .4rem; }
    #hero { background: linear-gradient(90deg,#f7fafc,#e6f6f5); padding: 2.5rem 0; }
    #site-banner-img { width:160px; height:120px; border-radius:12px; object-fit:cover; }
    @media (max-width: 768px) { header nav { display:none; } #site-banner-img { width:120px; height:90px; } }
    #error-message-box { position: fixed; top: 0; left: 0; right: 0; z-index:1000; display:none; justify-content:center; align-items:center; padding: .9rem 1rem; color: white; background-color: var(--danger); font-weight:700; }
    .hidden { display:none !important; }
  </style>
</head>
<body class="flex flex-col min-h-screen">

<!-- Global error -->
<div id="error-message-box" role="alert">
  <div id="error-text">שגיאה: בדוק את הקונסול.</div>
  <button onclick="hideError()" aria-label="close" class="ml-4 text-white font-bold text-xl">&times;</button>
</div>

<!-- Header -->
<header class="bg-white shadow sticky top-0 z-40">
  <div class="container mx-auto px-4 py-3 flex items-center justify-between">
    <div class="flex items-center gap-4">
      <div onclick="goTo('home')" class="flex items-center cursor-pointer select-none">
        <img id="brand-logo" src="https://placehold.co/60x60/FF6B6B/ffffff?text=K" alt="קשר" class="w-12 h-12 rounded-full mr-3 shadow-sm">
        <div>
          <div class="text-lg font-extrabold">קהילת קשר</div>
          <div class="text-xs small-muted">קהילה +60</div>
        </div>
      </div>
      <nav class="ml-6 hidden md:flex items-center gap-4 text-sm">
        <a class="nav-item px-3 py-2 hover:opacity-80 cursor-pointer" onclick="goTo('home')"><i class="fas fa-home ml-1"></i> דף הבית</a>
        <a class="nav-item px-3 py-2 hover:opacity-80 cursor-pointer" onclick="goTo('forum')"><i class="fas fa-comments ml-1"></i> פורום</a>
        <a class="nav-item px-3 py-2 hover:opacity-80 cursor-pointer" onclick="goTo('activities')"><i class="fas fa-calendar-alt ml-1"></i> פעילויות</a>
        <a class="nav-item px-3 py-2 hover:opacity-80 cursor-pointer" onclick="goTo('members')"><i class="fas fa-users ml-1"></i> חברים</a>
        <a class="nav-item px-3 py-2 hover:opacity-80 cursor-pointer" onclick="goTo('chats')"><i class="fas fa-comments ml-1"></i> צ'אטים</a>
      </nav>
    </div>

    <div class="flex items-center gap-3">
      <div id="daily-tip" class="text-sm small-muted hidden md:block">טיפ יומי: שמרו על קשר עם השכנים — חיוך אחד עושה פלאים</div>
      <div id="user-actions" class="flex items-center gap-3">
        <button id="btn-create" class="btn-sec py-2 px-3 rounded text-sm" onclick="goTo('addPost')"><i class="fas fa-plus mr-2"></i> פוסט חדש</button>
        <button id="btn-admin" class="btn-primary py-2 px-3 rounded text-sm hidden" onclick="goTo('admin')"><i class="fas fa-tools mr-2"></i> ניהול</button>
        <div id="user-menu" class="flex items-center gap-2">
          <button id="login-btn" class="text-sm text-link" onclick="goTo('login')">התחבר/י</button>
        </div>
      </div>
    </div>
  </div>
</header>

<!-- Hero -->
<section id="hero" class="mb-6">
  <div class="container mx-auto px-4">
    <div class="card p-6 flex items-center justify-between gap-4">
      <div>
        <h1 class="text-3xl font-extrabold mb-2">ברוכים הבאים לקהילת קשר</h1>
        <p class="small-muted mb-4">מרכז תמיכה, שיתוף ועזרה לקשישים +60 — הצטרפו, שתפו וחזקו את הקהילה שלכם.</p>
        <div class="flex gap-3">
          <button class="btn-primary py-2 px-4 rounded" onclick="goTo('forum')">היכנסו לפורום</button>
          <button class="btn-sec py-2 px-4 rounded" onclick="goTo('register')">הירשמו</button>
        </div>
      </div>
      <div class="flex-shrink-0">
        <img id="site-banner-img" src="https://placehold.co/400x300/8EC5B0/ffffff?text=Senior+Friends" alt="אנשים מבוגרים" />
      </div>
    </div>
  </div>
</section>

<!-- App container -->
<main id="app-container" class="container mx-auto px-4 flex-grow">
  <!-- תוכן דינמי יושתל כאן -->
  <div class="flex items-center justify-center p-12">
    <div class="text-center small-muted">טוען אפליקציה...</div>
  </div>
</main>

<!-- Terms modal -->
<div id="rulesModal" class="fixed inset-0 bg-black/40 hidden items-center justify-center z-50" onclick="if(event.target.id==='rulesModal') hideRules()">
  <div class="bg-white rounded-lg p-6 w-full max-w-2xl card">
    <h3 class="font-bold text-2xl mb-4">תנאי שימוש</h3>
    <div class="small-muted mb-4">כללי הקהילה: שמור/שמרי על כבוד, הימנע/הימנעי מפרסום פוגעני, ועוד.</div>
    <div class="text-right">
      <button class="btn-primary py-2 px-4 rounded" onclick="hideRules()">סגור</button>
    </div>
  </div>
</div>

<script type="module">
/* חלק 1/נשלח — קוד JS (התחלה) */
/* יבוא Firebase (v11.6.1) */
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, query, addDoc, serverTimestamp, getDocs, updateDoc, arrayUnion, arrayRemove, increment, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

/* Firebase config — וודא שהערכים תואמים ל‑Project settings ב‑Firebase */
const firebaseConfig = {
  apiKey: "AIzaSyCrcxC420HW5PXGNd8M4KuclUkiJSwHreM",
  authDomain: "kesher-bakir.firebaseapp.com",
  projectId: "kesher-bakir",
  storageBucket: "kesher-bakir.appspot.com",
  messagingSenderId: "671996189455",
  appId: "1:671996189455:web:d8ee089585a852ab38fc7a",
  measurementId: "G-42EWSKFHXP"
};

const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-kesher-app-id';
const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

let app, db, auth;

const state = {
  screen: 'loading',
  user: null,
  posts: [],
  currentPost: null,
  allUsers: {},
  error: null,
  pendingAuth: null,
  dailyTipIndex: 0
};

/* UI helpers */
function showError(message, critical = false) {
  console.error("ERROR:", message);
  state.error = message;
  const box = document.getElementById('error-message-box');
  const txt = document.getElementById('error-text');
  if (box && txt) {
    txt.textContent = message;
    box.style.display = 'flex';
    if (!critical) setTimeout(hideError, 6000);
  }
}
function hideError() {
  state.error = null;
  const box = document.getElementById('error-message-box');
  if (box) box.style.display = 'none';
}
function showRules(){ document.getElementById('rulesModal').classList.remove('hidden'); }
function hideRules(){ document.getElementById('rulesModal').classList.add('hidden'); }

function updateHeaderForUser() {
  const loginBtn = document.getElementById('login-btn');
  const btnAdmin = document.getElementById('btn-admin');
  if (state.user) {
    loginBtn.style.display = 'none';
    document.getElementById('user-menu').innerHTML = `
      <button class="text-sm font-semibold flex items-center" onclick="goTo('profile')">
        <img src="${state.user.avatar}" alt="${state.user.displayName}" class="w-8 h-8 rounded-full border mr-2"> <span>${state.user.displayName}</spa
        n>
      </button>
    `;
    if (state.user.role === 'admin' || (state.user.__rawProfile && state.user.__rawProfile.role === 'admin')) {
      btnAdmin.classList.remove('hidden');
    } else {
      btnAdmin.classList.add('hidden');
    }
  } else {
    loginBtn.style.display = '';
    document.getElementById('user-menu').innerHTML = '';
    btnAdmin.classList.add('hidden');
  }
}

function formatTimestamp(ts) {
  if (!ts) return 'לא זמין';
  try {
    const d = ts.toDate ? ts.toDate() : new Date(ts);
    const diff = (Date.now() - d.getTime())/1000;
    if (diff < 60) return 'הרגע';
    if (diff < 3600) return `לפני ${Math.floor(diff/60)} דקות`;
    if (diff < 86400) return `לפני ${Math.floor(diff/3600)} שעות`;
    return d.toLocaleDateString('he-IL');
  } catch(e) { return 'לא זמין'; }
}

function getFirebaseErrorMessage(code) {
  if (!code) return "שגיאה לא ידועה";
  switch (code) {
    case 'auth/invalid-email': return 'כתובת אימייל לא תקינה.';
    case 'auth/user-disabled': return 'המשתמש נחסם.';
    case 'auth/user-not-found':
    case 'auth/wrong-password': return 'מייל או סיסמה שגויים.';
    case 'auth/email-already-in-use': return 'המייל כבר רשום.';
    case 'auth/weak-password': return 'הסיסמה חלשה (לפחות 6 תווים).';
    default: return 'שגיאת אימות: ' + code.replace('auth/','');
  }
}

/* Auth actions */

async function login(email, password) {
  hideError();
  if (!auth) { showError("Firebase לא אתחל כראוי."); return false; }
  if (!email || !password) { showError("נא להזין אימייל וסיסמה."); return false; }
  try {
    const uc = await signInWithEmailAndPassword(auth, email, password);
    console.log("Signed in:", uc.user.email);
    return true;
  } catch (error) {
    console.error("Login error:", error, "code:", error.code, "message:", error.message);
    showError(getFirebaseErrorMessage(error.code));
    return false;
  }
}

async function register(email, password, displayName, gender) {
  hideError();
  if (!auth || !db) { showError("Firebase לא אתחל כראוי."); return false; }
  if (password.length < 6) { showError("אורך סיסמה חייב להיות לפחות 6 תווים."); return false; }

  if (state.pendingAuth) {
    try {
      const uid = state.pendingAuth.uid;
      const userProfileRef = doc(db, 'artifacts', appId, 'users', uid, 'profile', 'data');
      await setDoc(userProfileRef, {
        uid,
        email: state.pendingAuth.email || email,
        displayName,
        gender,
        avatar: gender === 'male' ? 'https://placehold.co/400x400/2B6CB0/ffffff?text=M' : 'https://placehold.co/400x400/38B2AC/ffffff?text=F',
        createdAt: serverTimestamp(),
        lastLogin: serverTimestamp(),
        bio: `היי, אני ${displayName} בקהילה!`
      });
      state.user = { uid, email: state.pendingAuth.email || email, displayName, gender, avatar: gender === 'male' ? 'https://placehold.co/400x400/2B6CB0/ffffff?text=M' : 'https://placehold.co/400x400/38B2AC/ffffff?text=F', bio: `היי, אני ${displayName} בקהילה!` };
      state.pendingAuth = null;
      await fetchInitialData();
      updateHeaderForUser();
      goTo('home');
      return true;
    } catch (e) {
      console.error("Error creating profile from pendingAuth:", e);
      showError("שגיאה ביצירת פרופיל מתוך חשבון קיים.");
      return false;
    }
  }

  try {
    const uc = await createUserWithEmailAndPassword(auth, email, password);
    const user = uc.user;
    const userProfileRef = doc(db, 'artifacts', appId, 'users', user.uid, 'profile', 'data');
    await setDoc(userProfileRef, {
      uid: user.uid,
      email,
      displayName,
      gender,
      avatar: gender === 'male' ? 'https://placehold.co/400x400/2B6CB0/ffffff?text=M' : 'https://placehold.co/400x400/38B2AC/ffffff?text=F',
      createdAt: serverTimestamp(),
      lastLogin: serverTimestamp(),
      bio: `היי, אני ${displayName} בקהילה!`
    });
    console.log("User created and profile set:", email);
    return true;
  } catch (error) {
    console.error("Register error:", error, "code:", error.code, "message:", error.message);
    showError(getFirebaseErrorMessage(error.code));
    return false;
  }
}

async function logout() {
  if (auth) await signOut(auth);
  state.user = null;
  updateHeaderForUser();
  goTo('login');
}

/* Data fetching and listeners */

async function fetchInitialData() {
  if (!db) return;

  try {
    const postsRef = collection(db, 'artifacts', appId, 'public', 'data', 'posts');
    onSnapshot(query(postsRef), (snap) => {
      state.posts = snap.docs.map(d => ({ id: d.id, ...d.data() })).sort((a,b) => (b.createdAt?.toMillis?b.createdAt.toMillis():0)-(a.createdAt?.toMillis? a.createdAt.toMillis():0));
      render();
    }, (e) => { console.error("Posts snapshot error:", e); showError("שגיאה בעדכון פוסטים."); });
  } catch (e) { console.error("fetch posts error:", e); }

  try {
    const usersRef = collection(db, 'artifacts', appId, 'users');
    const usersSnap = await getDocs(usersRef);
    const map = {};
    for (const u of usersSnap.docs) {
      const p = await getDoc(doc(u.ref, 'profile', 'data'));
      if (p.exists()) {
        const d = p.data();
        map[d.uid] = { displayName: d.displayName, avatar: d.avatar, gender: d.gender, bio: d.bio || '' };
      }
    }
    state.allUsers = map;
  } catch (e) { console.error("fetch users error:", e); }
}

/* Posts, comments, likes */

async function addPost(title, content, category) {
  if (!db || !state.user) { showError("צריך להתחבר כדי לפרסם."); return false; }
  try {
    const postsRef = collection(db, 'artifacts', appId, 'public', 'data', 'posts');
    await addDoc(postsRef, { userId: state.user.uid, title, content, category, createdAt: serverTimestamp(), updatedAt: serverTimestamp(), commentsCount:0, likes:[] });
    goTo('forum');
    return true;
  } catch (e) { console.error("addPost error:", e); showError("שגיאה ביצירת פוסט."); return false; }
}

async function addComment(postId, text) {
  if (!db || !state.user || !text.trim()) return;
  try {
    const postRef = doc(db, 'artifacts', appId, 'public', 'data', 'posts', postId);
    const commentsRef = collection(postRef, 'comments');
    await addDoc(commentsRef, { userId: state.user.uid, content: text, createdAt: serverTimestamp() });
    try { await updateDoc(postRef, { commentsCount: increment(1), updatedAt: serverTimestamp() }); } catch(e){ console.warn(e); }
  } catch (e) { console.error("addComment error:", e); showError("שגיאה בהוספת תגובה."); }
}

async function toggleLike(postId) {
  if (!db || !state.user) { showError("צריך להיות מחובר כדי לאהוב."); return; }
  try {
    const postRef = doc(db, 'artifacts', appId, 'public', 'data', 'posts', postId);
    const post = state.posts.find(p => p.id === postId);
    if (!post) return;
    const likes = Array.isArray(post.likes) ? post.likes : [];
    const liked = likes.includes(state.user.uid);
    await updateDoc(postRef, { likes: liked ? arrayRemove(state.user.uid) : arrayUnion(state.user.uid) });
  } catch (e) { console.error("toggleLike error:", e); showError("שגיאה בעדכון לייק."); }
}

/* UI components */

function PostCard(post) {
  const u = state.allUsers[post.userId] || { displayName: 'משתמש', avatar: 'https://placehold.co/80x80/cccccc/ffffff?text=?' };
  const likes = Array.isArray(post.likes)?post.likes.length:0;
  const liked = Array.isArray(post.likes) && state.user ? post.likes.includes(state.user.uid) : false;
  return `
    <div class="post-card p-4 flex justify-between items-start hover:bg-gray-50 cursor-pointer" onclick="goTo('singlePost',{postId:'${post.id}'})">
      <div class="flex-grow">
        <div class="flex items-center mb-2">
          <img src="${u.avatar}" class="w-10 h-10 rounded-full ml-3" alt="${u.displayName}">
          <div>
            <div class="font-semibold">${u.displayName}</div>
            <div class="small-muted text-xs">${formatTimestamp(post.createdAt)}</div>
          </div>
        </div>
        <h3 class="font-bold text-lg">${post.title}</h3>
        <p class="small-muted mt-2">${(post.content||'').slice(0,240)}${(post.content||'').length>240? '...':''}</p>
      </div>
      <div class="flex flex-col items-center mr-4">
        <button onclick="event.stopPropagation(); toggleLike('${post.id}')" class="${liked ? 'text-red-500' : 'text-gray-400'} mb-1">
          <i class="${liked ? 'fas' : 'far'} fa-heart"></i>
        </button>
        <div class="small-muted">${likes}</div>
      </div>
    </div>
  `;
}
  <!-- חלק 3/להדבקה -->
<script type="module">
// continuation (helpers, views, rendering and Firebase init already imported earlier)

/* CommentCard */
function CommentCard(c) {
  const u = state.allUsers[c.userId] || { displayName: 'משתמש', avatar: 'https://placehold.co/80x80/cccccc/ffffff?text=?' };
  return `
    <div class="comment-card p-3 mb-3 rounded-lg flex">
      <img src="${u.avatar}" class="w-10 h-10 rounded-full ml-3" alt="${u.displayName}">
      <div class="flex-grow">
        <div class="flex justify-between">
          <div class="font-semibold">${u.displayName}</div>
          <div class="small-muted text-xs">${formatTimestamp(c.createdAt)}</div>
        </div>
        <div class="mt-1 text-gray-700">${c.content}</div>
      </div>
    </div>
  `;
}

/* Views rendering functions (continued if needed) are already defined in previous parts.
   Now implement render orchestrator and event bindings, comment loading, profile update, etc. */

/* Load comments for a post (reusable) */
async function loadComments(postId) {
  if (!db) return;
  const container = document.getElementById('commentsContainer');
  if (!container) return;
  try {
    const commentsRef = collection(db, 'artifacts', appId, 'public', 'data', 'posts', postId, 'comments');
    onSnapshot(query(commentsRef), snap => {
      const comments = snap.docs.map(d => ({ id: d.id, ...d.data() }))
        .sort((a, b) => (a.createdAt?.toMillis ? a.createdAt.toMillis() : 0) - (b.createdAt?.toMillis ? b.createdAt.toMillis() : 0));
      container.innerHTML = `<h3 class="font-bold mb-3">תגובות (${comments.length})</h3>${comments.map(CommentCard).join('')}`;
    }, e => {
      console.error("comments snapshot error:", e);
      container.innerHTML = `<div class="text-red-500 p-4">שגיאה בטעינת תגובות: ${e.message}</div>`;
    });
  } catch (e) {
    console.error("loadComments error:", e);
    container.innerHTML = `<div class="text-red-500 p-4">שגיאה: ${e.message}</div>`;
  }
}

/* Update profile */
async function updateProfile(displayName, bio) {
  if (!db || !state.user) { showError("אין חיבור ל‑Firebase."); return false; }
  try {
    const ref = doc(db, 'artifacts', appId, 'users', state.user.uid, 'profile', 'data');
    await updateDoc(ref, { displayName, bio });
    state.user.displayName = displayName;
    state.user.bio = bio;
    if (state.allUsers[state.user.uid]) {
      state.allUsers[state.user.uid].displayName = displayName;
      state.allUsers[state.user.uid].bio = bio;
    }
    goTo('profile');
    return true;
  } catch (e) {
    console.error("updateProfile error:", e);
    showError("שגיאה בעדכון הפרופיל.");
    return false;
  }
}

/* Render orchestrator function (ensures events bound after innerHTML set) */
function render() {
  const app = document.getElementById('app-container');
  if (!app) return;
  let html = '';
  switch (state.screen) {
    case 'loading': html = renderLoading(); break;
    case 'login': html = renderLogin(); break;
    case 'register': html = renderRegister(); break;
    case 'home': html = renderHome(); break;
    case 'forum': html = renderForum(); break;
    case 'singlePost': html = renderSinglePost(); break;
    case 'addPost': html = renderAddPost(); break;
    case 'members': html = renderMembers(); break;
    case 'activities': html = renderActivities(); break;
    case 'chats': html = renderChats(); break;
    case 'admin': html = renderAdmin(); break;
    case 'profile': html = renderProfile(); break;
    case 'editProfile': html = renderEditProfile(); break;
    default: html = renderHome(); break;
  }
  app.innerHTML = html;

  // bind forms & controls
  if (state.screen === 'login') {
    const f = document.getElementById('loginForm');
    f?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('loginEmail').value;
      const pass = document.getElementById('loginPassword').value;
      await login(email, pass);
    });
  }

  if (state.screen === 'register') {
    const f = document.getElementById('registerForm');
    f?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('registerEmail').value;
      const pass = document.getElementById('registerPassword').value;
      const dn = document.getElementById('registerDisplayName').value;
      const gender = document.querySelector('input[name="gender"]:checked')?.value || 'unknown';
      await register(email, pass, dn, gender);
    });
  }

  if (state.screen === 'addPost') {
    const f = document.getElementById('addPostForm');
    f?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const title = document.getElementById('postTitle').value;
      const content = document.getElementById('postContent').value;
      await addPost(title, content, 'general');
    });
  }

  if (state.screen === 'editProfile') {
    const f = document.getElementById('editProfileForm');
    f?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const dn = document.getElementById('editDisplayName').value;
      const bio = document.getElementById('editBio').value;
      if (dn) await updateProfile(dn, bio);
    });
  }

  // update header buttons/menu
  updateHeaderForUser();

  // load comments if needed
  if (state.screen === 'singlePost' && state.currentPost) {
    loadComments(state.currentPost.id);
  }
}

/* Firebase init and auth state handling with fallback */
async function initializeFirebase() {
  try {
    app = initializeApp(firebaseConfig);
    db = getFirestore(app);
    auth = getAuth(app);
    try { setLogLevel('debug'); } catch(e) {}
    console.log("Firebase initialized.");
    if (initialAuthToken) {
      try { await signInWithCustomToken(auth, initialAuthToken); console.log("Custom token sign-in ok."); } catch(e){ console.warn("Custom token failed:", e); }
    }
    return true;
  } catch (e) {
    console.error("Firebase init error:", e);
    showError("שגיאה באתחול Firebase.");
    return false;
  }
}

async function startApp() {
  goTo('loading');
  const ok = await initializeFirebase();
  if (!ok) return;

  onAuthStateChanged(auth, async (userAuth) => {
    if (userAuth) {
      const uid = userAuth.uid;
      console.log("Auth state: logged in UID:", uid);

      const primaryRef = doc(db, 'artifacts', appId, 'users', uid, 'profile', 'data');

      try {
        let primaryDoc = null;
        try { primaryDoc = await getDoc(primaryRef); } catch (e) { console.error("primary getDoc error:", e); }

        if (primaryDoc && primaryDoc.exists()) {
          state.user = { ...primaryDoc.data(), uid };
          await fetchInitialData();
          updateHeaderForUser();
          goTo('home');
          return;
        }

        console.warn("No profile at artifacts path; attempting fallback to /users/<uid>");
        let fallbackDoc = null;
        try { fallbackDoc = await getDoc(doc(db, 'users', uid)); } catch (e) { console.error("fallback getDoc error:", e); }

        if (fallbackDoc && fallbackDoc.exists()) {
          const d = fallbackDoc.data();
          state.user = {
            uid,
            email: d.email || userAuth.email || '',
            displayName: d.name || d.displayName || d.email || 'משתמש',
            gender: d.gender || 'unknown',
            avatar: d.avatar || ('https://placehold.co/400x400/2B6CB0/ffffff?text=' + (d.name ? d.name[0] : 'U')),
            bio: d.bio || '',
            __rawProfile: d
          };
          await fetchInitialData();
          updateHeaderForUser();
          goTo('home');
          return;
        }

        // nothing found - mark pendingAuth and go to register
        state.pendingAuth = { uid, email: userAuth.email || '' };
        showError("נמצאה כניסה אך אין פרופיל משתמש. יש להשלים הרשמה.", false);
        goTo('register');
      } catch (err) {
        console.error("Error resolving user profile:", err);
        showError("שגיאת טעינת פרופיל. בדוק הרשאות Firestore.", true);
        state.user = null;
        goTo('login');
      }

    } else {
      console.log("Auth state: logged out.");
      state.user = null;
      updateHeaderForUser();
      if (state.screen !== 'register') goTo('login'); else render();
    }
  });
}

/* Expose helper functions to window for inline onclick attributes */
window.goTo = goTo;
window.logout = logout;
window.showRules = showRules;
window.hideRules = hideRules;
window.toggleLike = toggleLike;

/* Start app */
startApp();
</script>

<!-- end of part 3 -->

/* End of part 2 */
  <!-- חלק 3/להדבקה -->
<script type="module">
// continuation (helpers, views, rendering and Firebase init already imported earlier)

/* CommentCard */
function CommentCard(c) {
  const u = state.allUsers[c.userId] || { displayName: 'משתמש', avatar: 'https://placehold.co/80x80/cccccc/ffffff?text=?' };
  return `
    <div class="comment-card p-3 mb-3 rounded-lg flex">
      <img src="${u.avatar}" class="w-10 h-10 rounded-full ml-3" alt="${u.displayName}">
      <div class="flex-grow">
        <div class="flex justify-between">
          <div class="font-semibold">${u.displayName}</div>
          <div class="small-muted text-xs">${formatTimestamp(c.createdAt)}</div>
        </div>
        <div class="mt-1 text-gray-700">${c.content}</div>
      </div>
    </div>
  `;
}

/* Views rendering functions (continued if needed) are already defined in previous parts.
   Now implement render orchestrator and event bindings, comment loading, profile update, etc. */

/* Load comments for a post (reusable) */
async function loadComments(postId) {
  if (!db) return;
  const container = document.getElementById('commentsContainer');
  if (!container) return;
  try {
    const commentsRef = collection(db, 'artifacts', appId, 'public', 'data', 'posts', postId, 'comments');
    onSnapshot(query(commentsRef), snap => {
      const comments = snap.docs.map(d => ({ id: d.id, ...d.data() }))
        .sort((a, b) => (a.createdAt?.toMillis ? a.createdAt.toMillis() : 0) - (b.createdAt?.toMillis ? b.createdAt.toMillis() : 0));
      container.innerHTML = `<h3 class="font-bold mb-3">תגובות (${comments.length})</h3>${comments.map(CommentCard).join('')}`;
    }, e => {
      console.error("comments snapshot error:", e);
      container.innerHTML = `<div class="text-red-500 p-4">שגיאה בטעינת תגובות: ${e.message}</div>`;
    });
  } catch (e) {
    console.error("loadComments error:", e);
    container.innerHTML = `<div class="text-red-500 p-4">שגיאה: ${e.message}</div>`;
  }
}

/* Update profile */
async function updateProfile(displayName, bio) {
  if (!db || !state.user) { showError("אין חיבור ל‑Firebase."); return false; }
  try {
    const ref = doc(db, 'artifacts', appId, 'users', state.user.uid, 'profile', 'data');
    await updateDoc(ref, { displayName, bio });
    state.user.displayName = displayName;
    state.user.bio = bio;
    if (state.allUsers[state.user.uid]) {
      state.allUsers[state.user.uid].displayName = displayName;
      state.allUsers[state.user.uid].bio = bio;
    }
    goTo('profile');
    return true;
  } catch (e) {
    console.error("updateProfile error:", e);
    showError("שגיאה בעדכון הפרופיל.");
    return false;
  }
}

/* Render orchestrator function (ensures events bound after innerHTML set) */
function render() {
  const app = document.getElementById('app-container');
  if (!app) return;
  let html = '';
  switch (state.screen) {
    case 'loading': html = renderLoading(); break;
    case 'login': html = renderLogin(); break;
    case 'register': html = renderRegister(); break;
    case 'home': html = renderHome(); break;
    case 'forum': html = renderForum(); break;
    case 'singlePost': html = renderSinglePost(); break;
    case 'addPost': html = renderAddPost(); break;
    case 'members': html = renderMembers(); break;
    case 'activities': html = renderActivities(); break;
    case 'chats': html = renderChats(); break;
    case 'admin': html = renderAdmin(); break;
    case 'profile': html = renderProfile(); break;
    case 'editProfile': html = renderEditProfile(); break;
    default: html = renderHome(); break;
  }
  app.innerHTML = html;

  // bind forms & controls
  if (state.screen === 'login') {
    const f = document.getElementById('loginForm');
    f?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('loginEmail').value;
      const pass = document.getElementById('loginPassword').value;
      await login(email, pass);
    });
  }

  if (state.screen === 'register') {
    const f = document.getElementById('registerForm');
    f?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('registerEmail').value;
      const pass = document.getElementById('registerPassword').value;
      const dn = document.getElementById('registerDisplayName').value;
      const gender = document.querySelector('input[name="gender"]:checked')?.value || 'unknown';
      await register(email, pass, dn, gender);
    });
  }

  if (state.screen === 'addPost') {
    const f = document.getElementById('addPostForm');
    f?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const title = document.getElementById('postTitle').value;
      const content = document.getElementById('postContent').value;
      await addPost(title, content, 'general');
    });
  }

  if (state.screen === 'editProfile') {
    const f = document.getElementById('editProfileForm');
    f?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const dn = document.getElementById('editDisplayName').value;
      const bio = document.getElementById('editBio').value;
      if (dn) await updateProfile(dn, bio);
    });
  }

  // update header buttons/menu
  updateHeaderForUser();

  // load comments if needed
  if (state.screen === 'singlePost' && state.currentPost) {
    loadComments(state.currentPost.id);
  }
}

/* Firebase init and auth state handling with fallback */
async function initializeFirebase() {
  try {
    app = initializeApp(firebaseConfig);
    db = getFirestore(app);
    auth = getAuth(app);
    try { setLogLevel('debug'); } catch(e) {}
    console.log("Firebase initialized.");
    if (initialAuthToken) {
      try { await signInWithCustomToken(auth, initialAuthToken); console.log("Custom token sign-in ok."); } catch(e){ console.warn("Custom token failed:", e); }
    }
    return true;
  } catch (e) {
    console.error("Firebase init error:", e);
    showError("שגיאה באתחול Firebase.");
    return false;
  }
}

async function startApp() {
  goTo('loading');
  const ok = await initializeFirebase();
  if (!ok) return;

  onAuthStateChanged(auth, async (userAuth) => {
    if (userAuth) {
      const uid = userAuth.uid;
      console.log("Auth state: logged in UID:", uid);

      const primaryRef = doc(db, 'artifacts', appId, 'users', uid, 'profile', 'data');

      try {
        let primaryDoc = null;
        try { primaryDoc = await getDoc(primaryRef); } catch (e) { console.error("primary getDoc error:", e); }

        if (primaryDoc && primaryDoc.exists()) {
          state.user = { ...primaryDoc.data(), uid };
          await fetchInitialData();
          updateHeaderForUser();
          goTo('home');
          return;
        }

        console.warn("No profile at artifacts path; attempting fallback to /users/<uid>");
        let fallbackDoc = null;
        try { fallbackDoc = await getDoc(doc(db, 'users', uid)); } catch (e) { console.error("fallback getDoc error:", e); }

        if (fallbackDoc && fallbackDoc.exists()) {
          const d = fallbackDoc.data();
          state.user = {
            uid,
            email: d.email || userAuth.email || '',
            displayName: d.name || d.displayName || d.email || 'משתמש',
            gender: d.gender || 'unknown',
            avatar: d.avatar || ('https://placehold.co/400x400/2B6CB0/ffffff?text=' + (d.name ? d.name[0] : 'U')),
            bio: d.bio || '',
            __rawProfile: d
          };
          await fetchInitialData();
          updateHeaderForUser();
          goTo('home');
          return;
        }

        // nothing found - mark pendingAuth and go to register
        state.pendingAuth = { uid, email: userAuth.email || '' };
        showError("נמצאה כניסה אך אין פרופיל משתמש. יש להשלים הרשמה.", false);
        goTo('register');
      } catch (err) {
        console.error("Error resolving user profile:", err);
        showError("שגיאת טעינת פרופיל. בדוק הרשאות Firestore.", true);
        state.user = null;
        goTo('login');
      }

    } else {
      console.log("Auth state: logged out.");
      state.user = null;
      updateHeaderForUser();
      if (state.screen !== 'register') goTo('login'); else render();
    }
  });
}

/* Expose helper functions to window for inline onclick attributes */
window.goTo = goTo;
window.logout = logout;
window.showRules = showRules;
window.hideRules = hideRules;
window.toggleLike = toggleLike;

/* Start app */
startApp();
</script>

<!-- end of part 3 -->
  <!-- חלק 4/המשך וסיום הקובץ -->

<script>
// קטן: סקריפטים עזריים שלא יכולים להיות מודולים (נגישות מה־DOM)
(function attachGlobalShortcuts(){
  // קיצורי מקלדת פשוטים לדוגמה: H -> Home, F -> Forum, L -> Login
  document.addEventListener('keydown', (e) => {
    if (e.altKey || e.ctrlKey || e.metaKey) return;
    const k = e.key.toLowerCase();
    if (k === 'h') { goTo('home'); }
    if (k === 'f') { goTo('forum'); }
    if (k === 'l') { goTo('login'); }
  });
})();

// small helper: auto-rotate daily tip every 12s
(function rotateDailyTip(){
  const el = document.getElementById('daily-tip');
  if (!el) return;
  setInterval(()=> {
    try {
      // fetch tip from state (function defined in module parts)
      el.textContent = typeof window.getDailyTip === 'function' ? window.getDailyTip() : '';
    } catch(e) {}
  }, 12000);
})();

// expose a safe debug printer for convenience
window.debugPrintState = function() {
  console.log("APP STATE:", {
    screen: state.screen,
    user: state.user,
    postsCount: state.posts.length,
    pendingAuth: state.pendingAuth
  });
};

// small UX: collapse mobile nav toggle
(function mobileNavToggle(){
  // add small toggle button if needed (only if nav hidden)
  const header = document.querySelector('header .container');
  if (!header) return;
  const btn = document.createElement('button');
  btn.className = 'md:hidden p-2 ml-2';
  btn.innerHTML = '<i class="fas fa-bars"></i>';
  btn.onclick = () => {
    const nav = document.querySelector('header nav');
    if (nav) nav.classList.toggle('hidden');
  };
  header.querySelector('.flex.items-center')?.prepend(btn);
})();

/* Final instructions to you (developer) */
console.log("Kesher app bootstrap complete. If UI is missing parts, check console for errors.");
</script>

<!-- end of file -->
  <!-- חלק 5/השלמות ותוספות פונקציונליות -->

<script>
// Additional utilities and safety checks

// Safe getter for nested properties
function safeGet(obj, path, fallback = undefined) {
  try {
    return path.split('.').reduce((o, k) => (o && o[k] !== undefined) ? o[k] : fallback, obj);
  } catch (e) {
    return fallback;
  }
}

// Friendly timestamp formatter for templates (exposed globally)
window.formatTimestamp = formatTimestamp;

// expose daily tip generator to non-module scripts
window.getDailyTip = function() {
  const tips = [
    "שוחח/י עם שכן חדש השבוע — הכרות מקרבת.",
    "צא/י להליכה של 20 דקות ביום לשיפור מצב הרוח.",
    "שתף/י זיכרון נחמד בפורום — מישהו מחכה לשמוע.",
    "בדוק/י את התפריטים הקהילתיים הקרובים.",
    "קרא/י מדריך קצר על בטיחות באינטרנט."
  ];
  window.__dailyTipIndex = (window.__dailyTipIndex === undefined) ? 0 : (window.__dailyTipIndex + 1) % tips.length;
  return tips[window.__dailyTipIndex];
};

// UX: show skeleton loaders if network slow
function showSkeleton(targetSelector, lines = 3) {
  const container = document.querySelector(targetSelector);
  if (!container) return;
  let html = '';
  for (let i=0;i<lines;i++){
    html += `<div class="p-4 border-b animate-pulse"><div class="h-4 bg-gray-200 rounded w-3/4 mb-2"></div><div class="h-3 bg-gray-200 rounded w-1/2"></div></div>`;
  }
  container.innerHTML = html;
}

// Basic client-side validation helpers
function validateEmailFormat(email) {
  const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  return re.test(String(email).toLowerCase());
}

// Small helper to scroll into view for messages
function scrollToTopOfApp() {
  try { window.scrollTo({ top: 0, behavior: 'smooth' }); } catch(e) {}
}

// Retry helper for transient Firestore reads
async function retry(fn, attempts = 3, delayMs = 300) {
  let lastErr;
  for (let i=0;i<attempts;i++){
    try { return await fn(); } catch(e) { lastErr = e; await new Promise(r=>setTimeout(r, delayMs)); }
  }
  throw lastErr;
}

/* Extended admin helpers (only visible if user role admin) */
async function adminListUsersSample() {
  // This is just a helper to list a sample of root /users docs for admins
  if (!db || !(state.user && (state.user.role==='admin' || (state.user.__rawProfile && state.user.__rawProfile.role==='admin')))) {
    showError("אין הרשאה להצגת משתמשים (admin).");
    return;
  }
  try {
    const usersRef = collection(db, 'users');
    const snap = await getDocs(usersRef);
    console.log("Admin: root /users count:", snap.size);
    snap.docs.slice(0,20).forEach(d => console.log(d.id, d.data()));
    showError(`טען ${snap.size} משתמשים (קונסול).`, false);
  } catch(e) {
    console.error("adminListUsersSample error:", e);
    showError("שגיאה בטעינת משתמשים (admin).");
  }
}

/* Small accessibility improvements */
(function accessibilityInit(){
  document.documentElement.setAttribute('lang','he');
  document.documentElement.setAttribute('dir','rtl');
  // add skip-to-content
  const skip = document.createElement('a');
  skip.href = '#app-container';
  skip.className = 'sr-only focus:not-sr-only p-2';
  skip.textContent = 'דילוג לתוכן העיקרי';
  document.body.prepend(skip);
})();

/* Feature flag: enableVerboseLogs — useful while debugging */
window.__KESHER_VERBOSE = false;
function vlog(...args){ if (window.__KESHER_VERBOSE) console.log(...args); }

/* Tidy up: ensure header state sync after auth */
(function ensureHeaderSync(){
  // run every time user changes (poll small)
  let lastUser = null;
  setInterval(()=> {
    if (JSON.stringify(lastUser)!==JSON.stringify(state.user)) {
      lastUser = JSON.parse(JSON.stringify(state.user || null));
      try { updateHeaderForUser(); } catch(e){/*ignore*/ }
    }
  }, 1000);
})();

/* Helpful debug command: recreate profile under artifacts path from root /users doc */
window.adminCreateArtifactProfileFromRoot = async function(uid) {
  if (!db) { showError("אין חיבור ל‑Firebase."); return; }
  if (!uid) { showError("נא לספק UID."); return; }
  try {
    const rootDoc = await getDoc(doc(db,'users',uid));
    if (!rootDoc.exists()) { showError("מסמך root/users לא נמצא."); return; }
    const d = rootDoc.data();
    const profileRef = doc(db, 'artifacts', appId, 'users', uid, 'profile', 'data');
    await setDoc(profileRef, {
      uid,
      email: d.email || '',
      displayName: d.name || d.displayName || d.email || 'משתמש',
      gender: d.gender || 'unknown',
      avatar: d.avatar || ('https://placehold.co/400x400/2B6CB0/ffffff?text='+(d.name?d.name[0]:'U')),
      createdAt: serverTimestamp(),
      lastLogin: serverTimestamp(),
      bio: d.bio || ''
    });
    showError("פרופיל תווסף ל‑artifacts (ראה קונסול).", false);
    console.log("adminCreateArtifactProfileFromRoot: done for", uid);
  } catch(e) {
    console.error("adminCreateArtifactProfileFromRoot error:", e);
    showError("שגיאה ביצירת פרופיל מה‑root.");
  }
};

/* End of part 5 additions */
</script>
