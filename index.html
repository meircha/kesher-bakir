<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>קהילת קשר — קהילה תומכת 60+</title>

  <!-- Tailwind CDN (לנוחות; אפשר להחליף בעת פרודקשן) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

  <style>
    :root{
      --primary:#2B6CB0;
      --accent:#38B2AC;
      --bg:#F7FAFC;
      --card:#FFFFFF;
      --muted:#4A5568;
    }
    html,body { height:100%; }
    body{ background:var(--bg); font-family: "Segoe UI", Roboto, Arial, sans-serif; color:#1a202c; -webkit-font-smoothing:antialiased; margin:0; padding:0; }
    .card{ background:var(--card); border-radius:12px; box-shadow:0 6px 20px rgba(0,0,0,0.06); }
    .btn-primary{ background:var(--accent); color:white; }
    .btn-sec{ background:var(--primary); color:white; }
    .pill{ padding:.5rem .9rem; border-radius:9999px; font-size:0.8rem; font-weight:600; text-align:center; }
    .small-muted{ color:var(--muted); font-size:0.8rem; }
    .forum-post:hover { box-shadow:0 8px 30px rgba(0,0,0,0.1); transform:translateY(-2px); transition:all 0.3s; }
    .user-avatar{ width:40px; height:40px; border-radius:9999px; background-color:var(--accent); display:flex; align-items:center; justify-content:center; color:white; font-weight:bold; font-size:1.1rem; }
    .header-link:hover{ color:var(--accent); }
    /* כפתורי ניווט תחתונים במובייל */
    @media (max-width: 768px) {
        #nav-menu {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 50;
            background-color: var(--card);
            border-top: 1px solid #E2E8F0;
            display: flex;
            justify-content: space-around;
            padding: 0.5rem 0;
            box-shadow: 0 -4px 10px rgba(0, 0, 0, 0.05);
        }
        .header-link {
            flex-direction: column;
            padding: 0.5rem 0;
            text-align: center;
        }
        .header-link span {
            font-size: 0.75rem;
            margin-top: 0.2rem;
        }
        #desktop-nav {
            display: none;
        }
    }
    @media (min-width: 769px) {
        #nav-menu {
            display: none;
        }
    }
    .modal-backdrop{
        background-color: rgba(0, 0, 0, 0.5);
    }
    .loader {
        border: 4px solid #f3f3f3;
        border-top: 4px solid var(--accent);
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
  </style>
</head>

<body class="min-h-screen">

  <!-- מכולת האפליקציה הראשית -->
  <div id="app-container" class="max-w-4xl mx-auto h-full p-4">
    <!-- תוכן האפליקציה ירונדר כאן -->
  </div>

  <!-- תפריט ניווט תחתון (למובייל) -->
  <div id="nav-menu" class="md:hidden">
    <a href="#" onclick="goTo('home')" class="header-link flex items-center text-gray-600 hover:text-accent p-2">
      <i class="fas fa-home text-xl"></i>
      <span class="text-xs">בית</span>
    </a>
    <a href="#" onclick="goTo('forum')" class="header-link flex items-center text-gray-600 hover:text-accent p-2">
      <i class="fas fa-comments text-xl"></i>
      <span class="text-xs">פורום</span>
    </a>
    <a href="#" onclick="goTo('chat')" class="header-link flex items-center text-gray-600 hover:text-accent p-2">
      <i class="fas fa-users text-xl"></i>
      <span class="text-xs">צ'אט</span>
    </a>
    <a href="#" onclick="goTo('profile')" class="header-link flex items-center text-gray-600 hover:text-accent p-2">
      <i class="fas fa-user-circle text-xl"></i>
      <span class="text-xs">פרופיל</span>
    </a>
  </div>
  
  <script type="module">
    // הגדרות Firebase גלובליות
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    // ייבוא מודולים של Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile, sendEmailVerification } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, collection, query, orderBy, onSnapshot, where, updateDoc, arrayUnion, arrayRemove, deleteDoc, addDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    
    // מופעים גלובליים (יאותחלו ב-main)
    let app, db, auth;
    let userId = null; // מזהה משתמש נוכחי (uid)
    let unsubscribeForum = null; // לשמירת מנוי ה-onSnapshot של הפורום
    let unsubscribeChat = null; // לשמירת מנוי ה-onSnapshot של הצ'אט

    // מצב האפליקציה הגלובלי (State)
    const state = {
        screen: 'loading', // 'loading', 'login', 'register', 'home', 'forum', 'newPost', 'chat', 'profile', 'postDetail'
        user: null, // אובייקט פרופיל המשתמש מה-Firestore
        posts: [], // רשימת פוסטים מהפורום
        comments: {}, // תגובות לפוסטים (postId: [comments])
        currentPost: null, // הפוסט המוצג במסך postDetail
        onlineUsers: [], // רשימת משתמשים מחוברים (לצ'אט)
        chatMessages: [], // הודעות הצ'אט הציבורי
        chatInput: '', // קלט של הודעת הצ'אט
        forumInput: { title: '', content: '' }, // קלט של פוסט חדש
        loginForm: { email: '', password: '' },
        registerForm: { email: '', password: '', displayName: '', age: '', city: '' },
        isModalOpen: false, // האם המודל פתוח (כרגע לכללים)
    };

    // --- כלי עזר ---

    /**
     * מחזיר מזהה גלובלי של משתמש: uid אם מחובר, או מזהה אנונימי/רנדומלי.
     */
    function getCurrentUserId() {
        return auth.currentUser?.uid || userId || 'anonymous';
    }

    /**
     * פונקציית ניתוב (מעדכנת את ה-state ומבצעת render מחדש)
     * @param {string} screenName שם המסך
     * @param {object} params פרמטרים נוספים (כמו post)
     */
    function goTo(screenName, params = {}) {
        console.log(`מעבר למסך: ${screenName}`, params);

        // ניתוק ממנויים קודמים
        if (unsubscribeForum) { unsubscribeForum(); unsubscribeForum = null; }
        if (unsubscribeChat) { unsubscribeChat(); unsubscribeChat = null; }

        state.screen = screenName;
        state.currentPost = params.post || null;

        // הפעלת לוגיקה ייעודית למסך
        switch (screenName) {
            case 'forum':
                fetchForumPosts();
                break;
            case 'chat':
                fetchChatMessages();
                break;
        }

        render();
        // גלילה לראש הדף
        document.getElementById('app-container').scrollTop = 0;
    }

    // --- אימות ו-Firestore: שירותים ---

    /**
     * מקבל את נתיב המסמך עבור נתוני משתמש.
     * @param {string} uid מזהה המשתמש
     * @returns {string} הנתיב המלא
     */
    function getUserDocPath(uid) {
        // שומר נתונים פרטיים של המשתמש תחת הנתיב האישי שלו
        return `artifacts/${appId}/users/${uid}/userData/profile`;
    }

    /**
     * מקבל את נתיב האוסף הציבורי (למשל, לפורום או צ'אט).
     * @param {string} collectionName שם האוסף
     * @returns {object} הפנייה לאוסף
     */
    function getPublicCollection(collectionName) {
        return collection(db, `artifacts/${appId}/public/data/${collectionName}`);
    }

    /**
     * אחזור נתוני פרופיל המשתמש מה-Firestore.
     * @param {string} uid מזהה המשתמש
     * @returns {Promise<object | null>} פרופיל המשתמש או null
     */
    async function fetchUserProfile(uid) {
        if (!db) return null;
        try {
            const userDocRef = doc(db, getUserDocPath(uid));
            const userDoc = await getDoc(userDocRef);
            if (userDoc.exists()) {
                const profile = userDoc.data();
                // ודא שכל השדות קיימים
                return {
                    uid,
                    email: auth.currentUser.email,
                    ...profile,
                    displayName: profile.displayName || 'משתמש חדש',
                    isAnon: auth.currentUser.isAnonymous,
                    memberSince: profile.memberSince ? new Date(profile.memberSince.toDate ? profile.memberSince.toDate() : profile.memberSince) : new Date(),
                    lastActive: new Date(),
                };
            }
            return null; // המסמך לא קיים
        } catch (error) {
            console.error("שגיאה באחזור פרופיל משתמש:", error);
            return null;
        }
    }

    /**
     * עדכון סטטוס פעילות אחרון של המשתמש
     */
    async function updateLastActive() {
        if (state.user && db && auth.currentUser && !auth.currentUser.isAnonymous) {
            try {
                const userDocRef = doc(db, getUserDocPath(auth.currentUser.uid));
                await updateDoc(userDocRef, {
                    lastActive: new Date(),
                });
            } catch (error) {
                console.warn("לא ניתן לעדכן סטטוס פעילות אחרון:", error);
            }
        }
    }

    /**
     * יצירת משתמש חדש ופרופיל ב-Firestore
     * @param {object} userObj אובייקט המשתמש מ-Firebase Auth
     * @param {object} registrationData נתוני ההרשמה
     */
    async function createNewUserProfile(userObj, registrationData) {
        if (!db) return;
        try {
            const userDocRef = doc(db, getUserDocPath(userObj.uid));
            const newUserProfile = {
                uid: userObj.uid,
                displayName: registrationData.displayName || userObj.email.split('@')[0],
                age: registrationData.age || '',
                city: registrationData.city || '',
                memberSince: new Date(),
                lastActive: new Date(),
                role: 'member',
            };
            await setDoc(userDocRef, newUserProfile, { merge: true });
            return {
                ...newUserProfile,
                email: userObj.email,
                isAnon: userObj.isAnonymous,
            };
        } catch (error) {
            console.error("שגיאה ביצירת פרופיל משתמש חדש:", error);
            throw new Error("שגיאה ביצירת פרופיל משתמש.");
        }
    }

    // --- לוגיקת פורום ---

    /**
     * שליחת פוסט חדש ל-Firestore
     */
    async function submitNewPost() {
        if (!state.user) {
            console.error("נדרשת התחברות כדי לפרסם.");
            showModal('נדרשת התחברות כדי לפרסם פוסט.', 'שגיאה');
            return;
        }
        const { title, content } = state.forumInput;

        if (!title.trim() || !content.trim()) {
            showModal('כותרת ותוכן הפוסט אינם יכולים להיות ריקים.', 'אזהרה');
            return;
        }

        try {
            const newPost = {
                title: title.trim(),
                content: content.trim(),
                authorUid: state.user.uid,
                authorName: state.user.displayName,
                createdAt: new Date(),
                updatedAt: new Date(),
                commentCount: 0,
                views: 0,
            };

            await addDoc(getPublicCollection('forumPosts'), newPost);

            // איפוס ושמירת לוגיקה
            state.forumInput = { title: '', content: '' };
            goTo('forum');
        } catch (error) {
            console.error("שגיאה בשליחת פוסט חדש:", error);
            showModal('אירעה שגיאה בשליחת הפוסט. אנא נסה שוב.', 'שגיאה');
        }
    }

    /**
     * עדכון הפוסט והצגת התגובות
     * @param {object} post הפוסט הנוכחי
     */
    async function viewPost(post) {
        goTo('postDetail', { post });

        // עדכון מונה צפיות ב-Firestore (לא ממתין)
        try {
            const postDocRef = doc(getPublicCollection('forumPosts'), post.id);
            // בדיקה האם המשתמש כבר צפה (ניתן לשפר עם מערך UID)
            if (post.authorUid !== state.user?.uid) {
                await updateDoc(postDocRef, {
                    views: (post.views || 0) + 1,
                });
            }
        } catch (e) {
            console.warn("שגיאה בעדכון צפיות:", e);
        }

        // אחזור תגובות בזמן אמת
        fetchComments(post.id);
    }

    /**
     * אחזור תגובות לפוסט ספציפי בזמן אמת
     * @param {string} postId מזהה הפוסט
     */
    function fetchComments(postId) {
        const commentsQuery = query(
            getPublicCollection('comments'),
            where('postId', '==', postId),
            orderBy('createdAt', 'asc')
        );

        // שימוש ב-onSnapshot כדי לקבל עדכונים בזמן אמת
        unsubscribeForum = onSnapshot(commentsQuery, (snapshot) => {
            const commentsList = [];
            snapshot.forEach(doc => {
                const data = doc.data();
                commentsList.push({
                    id: doc.id,
                    ...data,
                    createdAt: data.createdAt ? new Date(data.createdAt.toDate()) : new Date(),
                });
            });
            state.comments = { [postId]: commentsList };
            render();
        }, (error) => {
            console.error("שגיאה באחזור תגובות:", error);
        });
    }

    /**
     * שליחת תגובה חדשה
     * @param {string} postId מזהה הפוסט
     */
    async function submitComment(postId) {
        if (!state.user) {
            showModal('נדרשת התחברות כדי להגיב.', 'שגיאה');
            return;
        }

        const inputEl = document.getElementById('commentInput');
        const content = inputEl?.value.trim() || '';

        if (!content) {
            showModal('תוכן התגובה אינו יכול להיות ריק.', 'אזהרה');
            return;
        }

        try {
            const newComment = {
                postId: postId,
                content: content,
                authorUid: state.user.uid,
                authorName: state.user.displayName,
                createdAt: new Date(),
            };

            await addDoc(getPublicCollection('comments'), newComment);

            // עדכון מונה התגובות בפוסט (לא ממתין)
            const postDocRef = doc(getPublicCollection('forumPosts'), postId);
            await updateDoc(postDocRef, {
                commentCount: arrayUnion({ dummy: true }), // שימוש בטריק זמני
            });
            // הקוד הנכון לעדכון מונה: (נדרש טרנזקציה לקבלת הערך הנוכחי ולעדכן אותו)
            // ניתן לפשט:
            // await updateDoc(postDocRef, { commentCount: post.commentCount + 1 });
            // אך לצורך הדמו נפשט את עדכון המונה כרגע על ידי עדכון ה-post.commentCount בעת הקריאה ל-viewPost

            if (inputEl) inputEl.value = ''; // איפוס השדה
        } catch (error) {
            console.error("שגיאה בשליחת תגובה:", error);
            showModal('אירעה שגיאה בשליחת התגובה. אנא נסה שוב.', 'שגיאה');
        }
    }

    /**
     * אחזור רשימת פוסטים בזמן אמת
     */
    function fetchForumPosts() {
        const postsQuery = query(
            getPublicCollection('forumPosts'),
            // אין שימוש ב-orderBy כדי להימנע מאינדקסים, נמיין ב-JS
            // orderBy('createdAt', 'desc')
        );

        // שימוש ב-onSnapshot כדי לקבל עדכונים בזמן אמת
        unsubscribeForum = onSnapshot(postsQuery, (snapshot) => {
            const postsList = [];
            snapshot.forEach(doc => {
                const data = doc.data();
                postsList.push({
                    id: doc.id,
                    ...data,
                    createdAt: data.createdAt ? new Date(data.createdAt.toDate()) : new Date(),
                    updatedAt: data.updatedAt ? new Date(data.updatedAt.toDate()) : new Date(),
                    commentCount: data.commentCount || 0,
                    views: data.views || 0,
                });
            });

            // מיון ב-JavaScript במקום ב-Firestore Query
            postsList.sort((a, b) => b.createdAt.getTime() - a.createdAt.getTime());

            state.posts = postsList;
            render();
        }, (error) => {
            console.error("שגיאה באחזור פוסטים:", error);
            showModal('אירעה שגיאה באחזור נתוני הפורום. אנא נסה שוב.', 'שגיאה');
        });
    }

    // --- לוגיקת צ'אט ---

    /**
     * אחזור הודעות צ'אט ורשימת משתמשים בזמן אמת
     */
    function fetchChatMessages() {
        // 1. אחזור הודעות הצ'אט
        const chatQuery = query(
            getPublicCollection('chatMessages'),
            // אין שימוש ב-orderBy כדי להימנע מאינדקסים, נמיין ב-JS
            // orderBy('createdAt', 'desc')
        );

        unsubscribeChat = onSnapshot(chatQuery, (snapshot) => {
            const messagesList = [];
            snapshot.forEach(doc => {
                const data = doc.data();
                messagesList.push({
                    id: doc.id,
                    ...data,
                    createdAt: data.createdAt ? new Date(data.createdAt.toDate()) : new Date(),
                });
            });

            // מיון ב-JavaScript במקום ב-Firestore Query
            messagesList.sort((a, b) => a.createdAt.getTime() - b.createdAt.getTime());
            state.chatMessages = messagesList;

            // גלילה אוטומטית לתחתית הצ'אט
            const chatBox = document.getElementById('chatBox');
            if (chatBox) {
                // גלילה רק אם המשתמש קרוב לתחתית, או אם זו הודעה שהוא שלח
                const isScrolledToBottom = chatBox.scrollHeight - chatBox.clientHeight <= chatBox.scrollTop + 100;
                if (isScrolledToBottom) {
                    setTimeout(() => chatBox.scrollTop = chatBox.scrollHeight, 100);
                }
            }
            render();
        }, (error) => {
            console.error("שגיאה באחזור הודעות צ'אט:", error);
        });

        // 2. אחזור משתמשים פעילים (לצורך דמו)
        fetchOnlineUsers();
    }

    /**
     * שליחת הודעת צ'אט
     */
    async function sendChatMessage() {
        if (!state.user || auth.currentUser.isAnonymous) {
            showModal('נדרשת התחברות (לא אנונימית) כדי לשלוח הודעה.', 'שגיאה');
            return;
        }

        const content = state.chatInput.trim();
        if (!content) return;

        try {
            const newMessage = {
                content: content,
                authorUid: state.user.uid,
                authorName: state.user.displayName,
                createdAt: new Date(),
            };
            await addDoc(getPublicCollection('chatMessages'), newMessage);
            state.chatInput = '';
            // ה-onSnapshot יעדכן את המסך
        } catch (error) {
            console.error("שגיאה בשליחת הודעת צ'אט:", error);
            showModal('אירעה שגיאה בשליחת ההודעה.', 'שגיאה');
        }
    }

    /**
     * אחזור רשימת משתמשים 'מחוברים' (לצורך דמו: פעילים בדקה האחרונה)
     */
    async function fetchOnlineUsers() {
        if (!db) return;
        try {
            // הדרך הנכונה: לאסוף את כל מסמכי הפרופיל הציבוריים
            const usersRef = collection(db, `artifacts/${appId}/users`); // או אוסף נפרד ל-UIDs
            // לצורך הדמו, אין לנו אוסף אחד שלם של users. נשתמש בטריק:
            // אם המשתמש הנוכחי מחובר, נניח שרק הוא מחובר.
            if (state.user) {
                state.onlineUsers = [{ ...state.user, status: 'מחובר' }];
            } else {
                state.onlineUsers = [];
            }
            render();

        } catch (error) {
            console.warn("שגיאה באחזור משתמשים מחוברים (מודל הדגמה):", error);
        }
    }

    // --- פונקציות עזר ל-UI ---

    /**
     * פורמט יפה לתאריך ושעה
     * @param {Date} dateObj אובייקט תאריך
     * @returns {string} מחרוזת מפורמטת
     */
    function formatDateTime(dateObj) {
        if (!dateObj || isNaN(dateObj.getTime())) return 'תאריך לא ידוע';
        const now = new Date();
        const diffInDays = (now.getTime() - dateObj.getTime()) / (1000 * 3600 * 24);

        if (diffInDays < 1) {
            return dateObj.toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit' });
        } else if (diffInDays < 7) {
            return dateObj.toLocaleDateString('he-IL', { weekday: 'short', hour: '2-digit', minute: '2-digit' });
        } else {
            return dateObj.toLocaleDateString('he-IL');
        }
    }

    /**
     * קיצור מחרוזת (לכותרות)
     */
    function truncateString(str, num) {
        if (str.length <= num) return str;
        return str.slice(0, num) + '...';
    }

    /**
     * מחזיר יוזר אייקון מותאם
     * @param {string} displayName שם המשתמש
     * @returns {string} HTML של האייקון
     */
    function getUserAvatar(displayName) {
        const initial = displayName ? displayName[0].toUpperCase() : '?';
        return `<div class="user-avatar text-sm md:text-base">${initial}</div>`;
    }

    // --- רכיבי (Components) UI ---

    /**
     * רכיב: כפתור בסיסי
     */
    function Button({ text, onClick, primary = true, type = 'button', disabled = false, icon = '' }) {
        const baseClasses = 'px-4 py-2 rounded-lg font-semibold shadow-md transition duration-300 flex items-center justify-center space-x-2';
        const styleClasses = primary ? 'btn-primary hover:bg-teal-500' : 'bg-gray-200 text-gray-700 hover:bg-gray-300';
        return `
            <button type="${type}" onclick="${onClick}" class="${baseClasses} ${styleClasses}" ${disabled ? 'disabled' : ''}>
                ${icon ? `<i class="${icon} ${icon.includes('fa-spin') ? 'fa-spin' : ''}"></i>` : ''}
                <span>${text}</span>
            </button>
        `;
    }

    /**
     * רכיב: כרטיס פוסט בפורום
     */
    function ForumPostCard(post) {
        return `
            <div class="forum-post card p-4 mb-4 cursor-pointer hover:border-accent border border-white" onclick="viewPost('${post.id}')">
                <div class="flex items-center justify-between mb-2">
                    <h3 class="font-bold text-lg text-primary">${truncateString(post.title, 50)}</h3>
                    <div class="small-muted text-xs">${formatDateTime(post.createdAt)}</div>
                </div>
                <div class="small-muted mb-3 line-clamp-2">${truncateString(post.content, 120)}</div>
                <div class="flex items-center justify-between text-sm text-gray-500">
                    <div class="flex items-center space-x-3 space-x-reverse">
                        <div class="flex items-center">
                            <i class="fas fa-user-circle ml-1 text-primary"></i>
                            <span>${post.authorName}</span>
                        </div>
                        <div class="flex items-center">
                            <i class="fas fa-comments ml-1 text-accent"></i>
                            <span>${post.commentCount || 0}</span>
                        </div>
                        <div class="flex items-center">
                            <i class="fas fa-eye ml-1 text-gray-400"></i>
                            <span>${post.views || 0}</span>
                        </div>
                    </div>
                    ${Button({ text: 'קרא עוד', primary: false, onClick: `viewPost('${post.id}')` })}
                </div>
            </div>
        `;
    }


    /**
     * רכיב: Header וסרגל ניווט עליון (לדסקטופ)
     */
    function Header() {
        const userButton = state.user ? `
            <a href="#" onclick="goTo('profile')" class="flex items-center space-x-2 space-x-reverse p-2 hover:bg-gray-100 rounded-full transition">
                ${getUserAvatar(state.user.displayName)}
                <span class="font-semibold text-sm hidden md:inline">${state.user.displayName}</span>
            </a>
            ${Button({ text: 'יציאה', primary: false, onClick: 'handleSignOut()', icon: 'fas fa-sign-out-alt' })}
        ` : `
            ${Button({ text: 'התחברות', primary: true, onClick: "goTo('login')" })}
            ${Button({ text: 'הרשמה', primary: false, onClick: "goTo('register')" })}
        `;

        return `
            <header class="bg-card shadow-sm mb-6 p-4 rounded-b-xl sticky top-0 z-40">
                <div class="flex justify-between items-center max-w-4xl mx-auto">
                    <!-- לוגו וכותרת -->
                    <div class="flex items-center space-x-3 space-x-reverse">
                        <i class="fas fa-handshake text-3xl text-accent"></i>
                        <h1 class="text-xl font-bold text-primary hidden sm:inline">קהילת קשר</h1>
                        <span class="text-sm text-muted hidden md:inline">תמיכה הדדית לגיל 60+</span>
                    </div>

                    <!-- ניווט דסקטופ & משתמש -->
                    <nav id="desktop-nav" class="flex items-center space-x-6 space-x-reverse">
                        <a href="#" onclick="goTo('home')" class="header-link flex items-center text-gray-600 hover:text-accent font-medium">
                            <i class="fas fa-home ml-1"></i> בית
                        </a>
                        <a href="#" onclick="goTo('forum')" class="header-link flex items-center text-gray-600 hover:text-accent font-medium">
                            <i class="fas fa-comments ml-1"></i> פורום
                        </a>
                        <a href="#" onclick="goTo('chat')" class="header-link flex items-center text-gray-600 hover:text-accent font-medium">
                            <i class="fas fa-users ml-1"></i> צ'אט
                        </a>
                        <a href="#" onclick="goTo('profile')" class="header-link flex items-center text-gray-600 hover:text-accent font-medium">
                            <i class="fas fa-user-circle ml-1"></i> פרופיל
                        </a>
                    </nav>

                    <!-- כפתורי אימות -->
                    <div class="flex items-center space-x-3 space-x-reverse">
                        ${state.user ? userButton : userButton}
                    </div>
                </div>
            </header>
        `;
    }

    // --- מסכים ---

    function ScreenLoading() {
        return `
            <div class="flex flex-col items-center justify-center min-h-[60vh]">
                <div class="loader"></div>
                <p class="mt-4 text-primary font-semibold">טוען את האפליקציה...</p>
                <p class="small-muted mt-2">בדיקת פרטי התחברות</p>
            </div>
        `;
    }

    function ScreenLogin() {
        const handleLoginInput = (field, value) => {
            state.loginForm[field] = value;
            render(); // רנדור מחדש כדי לשמור את המצב
        };

        const handleSubmit = async (event) => {
            event.preventDefault();
            const loginButton = document.getElementById('loginBtn');
            const originalText = loginButton.innerHTML;
            
            loginButton.innerHTML = `<i class="fas fa-spinner fa-spin ml-2"></i> מתחבר...`;
            loginButton.disabled = true;

            try {
                const { email, password } = state.loginForm;
                await signInWithEmailAndPassword(auth, email, password);
                // ה-onAuthStateChanged יטפל בניווט
                state.loginForm = { email: '', password: '' };
            } catch (error) {
                console.error("שגיאת התחברות:", error);
                let message = 'שגיאת התחברות. ודא ששם המשתמש והסיסמה נכונים.';
                if (error.code === 'auth/user-not-found') {
                    message = 'משתמש לא נמצא. אנא הירשם.';
                } else if (error.code === 'auth/wrong-password') {
                    message = 'סיסמה שגויה. אנא נסה שוב.';
                }
                showModal(message, 'שגיאת אימות');
            } finally {
                loginButton.innerHTML = originalText;
                loginButton.disabled = false;
            }
        };
        
        // נרשום את הפונקציה הגלובלית עבור ה-onclick
        window.handleLoginSubmit = handleSubmit;

        return `
            <div class="card p-8 md:p-10 max-w-md mx-auto mt-10">
                <h2 class="text-2xl font-bold mb-6 text-center text-primary">ברוך הבא לקהילת קשר</h2>
                <form onsubmit="handleLoginSubmit(event)">
                    <div class="mb-4">
                        <label for="loginEmail" class="block text-sm font-medium text-gray-700 mb-1">דוא"ל</label>
                        <input type="email" id="loginEmail" name="loginEmail" required
                               value="${state.loginForm.email}"
                               oninput="state.loginForm.email = this.value; render();"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-accent focus:border-accent"
                               placeholder="your@email.com">
                    </div>
                    <div class="mb-6">
                        <label for="loginPassword" class="block text-sm font-medium text-gray-700 mb-1">סיסמה</label>
                        <input type="password" id="loginPassword" name="loginPassword" required
                               value="${state.loginForm.password}"
                               oninput="state.loginForm.password = this.value; render();"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-accent focus:border-accent"
                               placeholder="********">
                    </div>
                    ${Button({ text: 'התחבר', primary: true, type: 'submit', icon: 'fas fa-sign-in-alt', id: 'loginBtn' })}
                </form>
                <p class="mt-6 text-center text-sm text-gray-600">
                    עדיין אין לך חשבון? <a href="#" onclick="goTo('register')" class="text-accent hover:underline font-medium">להרשמה</a>
                </p>
            </div>
        `;
    }

    function ScreenRegister() {
        const handleRegisterInput = (field, value) => {
            state.registerForm[field] = value;
            render();
        };

        const handleSubmit = async (event) => {
            event.preventDefault();
            const registerButton = document.getElementById('registerBtn');
            const originalText = registerButton.innerHTML;

            registerButton.innerHTML = `<i class="fas fa-spinner fa-spin ml-2"></i> מרשם...`;
            registerButton.disabled = true;

            try {
                const { email, password, displayName, age, city } = state.registerForm;

                if (password.length < 6) {
                    showModal('הסיסמה חייבת להיות באורך 6 תווים לפחות.', 'אזהרת סיסמה');
                    return;
                }

                // 1. יצירת משתמש ב-Auth
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                // 2. יצירת פרופיל ב-Firestore
                await createNewUserProfile(user, { displayName, age, city });

                // 3. עדכון שם המשתמש ב-Auth (אופציונלי)
                await updateProfile(user, { displayName });

                // 4. שליחת מייל אימות (מומלץ)
                // await sendEmailVerification(user);

                showModal(`נרשמת בהצלחה! ברוך הבא, ${displayName}.`, 'הרשמה הושלמה');
                state.registerForm = { email: '', password: '', displayName: '', age: '', city: '' };
                goTo('home'); // מעבר למסך הבית
            } catch (error) {
                console.error("שגיאת הרשמה:", error);
                let message = 'אירעה שגיאה בתהליך ההרשמה.';
                if (error.code === 'auth/email-already-in-use') {
                    message = 'הדוא"ל הזה כבר רשום. אנא התחבר או נסה דוא"ל אחר.';
                } else if (error.code === 'auth/weak-password') {
                    message = 'הסיסמה חלשה מדי. השתמש בסיסמה של 6 תווים לפחות.';
                }
                showModal(message, 'שגיאת הרשמה');
            } finally {
                registerButton.innerHTML = originalText;
                registerButton.disabled = false;
            }
        };

        window.handleRegisterSubmit = handleSubmit;
        window.handleRegisterInput = handleRegisterInput;

        return `
            <div class="card p-8 md:p-10 max-w-md mx-auto mt-10">
                <h2 class="text-2xl font-bold mb-6 text-center text-accent">הרשמה לקהילה</h2>
                <form onsubmit="handleRegisterSubmit(event)">
                    <div class="mb-4">
                        <label for="regDisplayName" class="block text-sm font-medium text-gray-700 mb-1">שם מציג (כינוי)</label>
                        <input type="text" id="regDisplayName" name="regDisplayName" required
                               value="${state.registerForm.displayName}"
                               oninput="handleRegisterInput('displayName', this.value)"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-accent focus:border-accent"
                               placeholder="כינוי בקהילה">
                    </div>
                    <div class="mb-4 grid grid-cols-2 gap-4">
                        <div>
                            <label for="regAge" class="block text-sm font-medium text-gray-700 mb-1">גיל (שנה)</label>
                            <input type="number" id="regAge" name="regAge"
                                   value="${state.registerForm.age}"
                                   oninput="handleRegisterInput('age', this.value)"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-accent focus:border-accent"
                                   placeholder="65">
                        </div>
                        <div>
                            <label for="regCity" class="block text-sm font-medium text-gray-700 mb-1">עיר/ישוב</label>
                            <input type="text" id="regCity" name="regCity"
                                   value="${state.registerForm.city}"
                                   oninput="handleRegisterInput('city', this.value)"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-accent focus:border-accent"
                                   placeholder="תל אביב">
                        </div>
                    </div>
                    <div class="mb-4">
                        <label for="regEmail" class="block text-sm font-medium text-gray-700 mb-1">דוא"ל</label>
                        <input type="email" id="regEmail" name="regEmail" required
                               value="${state.registerForm.email}"
                               oninput="handleRegisterInput('email', this.value)"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-accent focus:border-accent"
                               placeholder="your@email.com">
                    </div>
                    <div class="mb-6">
                        <label for="regPassword" class="block text-sm font-medium text-gray-700 mb-1">סיסמה (6 תווים מינימום)</label>
                        <input type="password" id="regPassword" name="regPassword" required
                               value="${state.registerForm.password}"
                               oninput="handleRegisterInput('password', this.value)"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-accent focus:border-accent"
                               placeholder="********">
                    </div>
                    ${Button({ text: 'הירשם לקהילה', primary: true, type: 'submit', icon: 'fas fa-user-plus', id: 'registerBtn' })}
                </form>
                <p class="mt-6 text-center text-sm text-gray-600">
                    כבר רשום? <a href="#" onclick="goTo('login')" class="text-accent hover:underline font-medium">להתחברות</a>
                </p>
                <p class="mt-4 text-center text-xs text-gray-500">
                    בלחיצה על הרשמה, אתה מאשר את <a href="#" onclick="showRulesModal()" class="text-blue-500 hover:underline">תקנון השימוש</a> שלנו.
                </p>
            </div>
        `;
    }

    function ScreenHome() {
        if (!state.user) {
            return `
                <div class="flex flex-col items-center justify-center min-h-[60vh] text-center">
                    <i class="fas fa-handshake text-6xl text-primary mb-4"></i>
                    <h2 class="text-3xl font-bold text-primary mb-2">ברוך הבא לקהילת קשר!</h2>
                    <p class="text-lg text-muted mb-6">המקום הבטוח שלך לשאלות, שיתוף וקבלת תמיכה.</p>
                    <div class="flex space-x-4 space-x-reverse">
                        ${Button({ text: 'להתחברות', primary: true, onClick: "goTo('login')" })}
                        ${Button({ text: 'להרשמה', primary: false, onClick: "goTo('register')" })}
                    </div>
                </div>
            `;
        }

        const recentPosts = state.posts.slice(0, 3).map(ForumPostCard).join('');
        const onlineCount = state.onlineUsers.length;

        return `
            ${Header()}
            <main class="p-4 md:p-0">
                <div class="card p-6 mb-6">
                    <div class="flex items-center justify-between">
                        <h2 class="text-2xl font-bold text-primary">שלום, ${state.user.displayName}!</h2>
                        <div class="pill bg-green-100 text-green-700 text-sm">
                            <i class="fas fa-circle text-green-500 text-xs ml-1"></i>
                            ${onlineCount} מחוברים
                        </div>
                    </div>
                    <p class="small-muted mt-2 mb-4">כמה טוב לראות אותך! מה תרצה לעשות היום?</p>

                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <div class="text-center p-4 card hover:bg-gray-50 transition cursor-pointer" onclick="goTo('forum')">
                            <i class="fas fa-comments text-4xl text-accent mb-2"></i>
                            <p class="font-semibold text-primary">פורום קהילתי</p>
                            <p class="text-xs text-muted">שאלות, עצות ודיונים</p>
                        </div>
                        <div class="text-center p-4 card hover:bg-gray-50 transition cursor-pointer" onclick="goTo('chat')">
                            <i class="fas fa-users text-4xl text-accent mb-2"></i>
                            <p class="font-semibold text-primary">צ'אט ציבורי</p>
                            <p class="text-xs text-muted">לשוחח עם חברים בזמן אמת</p>
                        </div>
                        <div class="text-center p-4 card hover:bg-gray-50 transition cursor-pointer" onclick="goTo('profile')">
                            <i class="fas fa-user-circle text-4xl text-accent mb-2"></i>
                            <p class="font-semibold text-primary">הפרופיל שלי</p>
                            <p class="text-xs text-muted">עדכון פרטים אישיים</p>
                        </div>
                    </div>
                </div>

                <!-- פוסטים אחרונים -->
                <div class="mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-primary">שיחות אחרונות בפורום</h3>
                        <a href="#" onclick="goTo('forum')" class="text-accent hover:underline text-sm font-medium">הצג את כל הדיונים</a>
                    </div>
                    ${state.posts.length > 0 ? recentPosts : `<p class="text-muted text-center card p-4">אין עדיין דיונים. ${state.user.isAnon ? 'התחבר כדי להתחיל אחד!' : `<a href="#" onclick="goTo('newPost')" class="text-accent hover:underline font-medium">התחל דיון!</a>`}</p>`}
                </div>
            </main>
        `;
    }

    function ScreenForum() {
        const postsContent = state.posts.map(ForumPostCard).join('');

        return `
            ${Header()}
            <main class="p-4 md:p-0">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold text-primary">הפורום הקהילתי</h2>
                    ${state.user && !auth.currentUser.isAnonymous ? Button({ text: 'פרסם פוסט חדש', primary: true, onClick: "goTo('newPost')", icon: 'fas fa-plus' }) : '<p class="text-muted">התחבר כדי לפרסם</p>'}
                </div>

                ${state.posts.length > 0 ? postsContent : `
                    <div class="card p-6 text-center min-h-[40vh] flex flex-col items-center justify-center">
                        <i class="fas fa-comments text-5xl text-gray-300 mb-4"></i>
                        <p class="text-lg text-muted mb-4">אין עדיין פוסטים בפורום. היה הראשון לשתף!</p>
                        ${state.user && !auth.currentUser.isAnonymous ? Button({ text: 'פרסם עכשיו', primary: true, onClick: "goTo('newPost')" }) : ''}
                    </div>
                `}
            </main>
        `;
    }

    function ScreenNewPost() {
        const { title, content } = state.forumInput;

        window.handlePostInput = (field, value) => {
            state.forumInput[field] = value;
            render();
        };

        return `
            ${Header()}
            <main class="p-4 md:p-0">
                <h2 class="text-3xl font-bold text-primary mb-6">פרסום פוסט חדש</h2>
                <div class="card p-6">
                    <div class="mb-4">
                        <label for="postTitle" class="block text-sm font-medium text-gray-700 mb-1">כותרת הפוסט</label>
                        <input type="text" id="postTitle" value="${title}"
                               oninput="handlePostInput('title', this.value)"
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-accent focus:border-accent text-lg font-semibold"
                               placeholder="כותרת קצרה וממוקדת לנושא...">
                    </div>
                    <div class="mb-6">
                        <label for="postContent" class="block text-sm font-medium text-gray-700 mb-1">תוכן הפוסט</label>
                        <textarea id="postContent" rows="10"
                                  oninput="handlePostInput('content', this.value)"
                                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-accent focus:border-accent resize-none"
                                  placeholder="שתף את השאלה, העצה או הסיפור שלך כאן...">
                                  ${content}</textarea>
                    </div>

                    <div class="flex justify-end space-x-3 space-x-reverse">
                        ${Button({ text: 'בטל', primary: false, onClick: "goTo('forum')" })}
                        ${Button({ text: 'פרסם בפורום', primary: true, onClick: "submitNewPost()", icon: 'fas fa-paper-plane' })}
                    </div>
                </div>
            </main>
        `;
    }

    function ScreenPostDetail() {
        const post = state.currentPost;
        const comments = state.comments[post?.id] || [];

        if (!post) {
            return `
                ${Header()}
                <main class="p-4 md:p-0">
                    <div class="card p-6 text-center">
                        <p class="text-xl text-red-500">שגיאה: הפוסט לא נמצא.</p>
                        ${Button({ text: 'חזור לפורום', primary: true, onClick: "goTo('forum')" })}
                    </div>
                </main>
            `;
        }

        // ודא שפונקציות גלובליות זמינות
        window.submitComment = submitComment;

        const isAuthor = state.user?.uid === post.authorUid;

        return `
            ${Header()}
            <main class="p-4 md:p-0">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-3xl font-bold text-primary">${post.title}</h2>
                    ${Button({ text: 'חזרה לפורום', primary: false, onClick: "goTo('forum')", icon: 'fas fa-arrow-right' })}
                </div>

                <!-- כרטיס הפוסט הראשי -->
                <div class="card p-6 mb-8">
                    <div class="flex items-center space-x-3 space-x-reverse mb-4 border-b pb-3">
                        ${getUserAvatar(post.authorName)}
                        <div>
                            <p class="font-semibold text-primary">${post.authorName}</p>
                            <p class="text-xs text-muted">פורסם: ${formatDateTime(post.createdAt)}</p>
                        </div>
                    </div>

                    <div class="text-gray-700 leading-relaxed mb-6">
                        ${post.content.split('\n').map(p => `<p class="mb-2">${p}</p>`).join('')}
                    </div>

                    <div class="flex items-center text-sm text-gray-500 space-x-4 space-x-reverse">
                        <div class="flex items-center"><i class="fas fa-comments ml-1 text-accent"></i> ${comments.length} תגובות</div>
                        <div class="flex items-center"><i class="fas fa-eye ml-1 text-gray-400"></i> ${post.views + 1 || 1} צפיות</div>
                        ${isAuthor ? '<div class="pill bg-blue-100 text-blue-700">הפוסט שלי</div>' : ''}
                    </div>
                </div>

                <!-- תגובות -->
                <h3 class="text-2xl font-bold text-primary mb-4">תגובות (${comments.length})</h3>

                <!-- טופס תגובה -->
                ${state.user && !auth.currentUser.isAnonymous ? `
                    <div class="card p-4 mb-6">
                        <h4 class="font-semibold mb-2">הוסף תגובה</h4>
                        <textarea id="commentInput" rows="3"
                                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-accent focus:border-accent resize-none mb-3"
                                  placeholder="הקלד את התגובה שלך כאן..."></textarea>
                        <div class="flex justify-end">
                            ${Button({ text: 'שלח תגובה', primary: true, onClick: `submitComment('${post.id}')`, icon: 'fas fa-reply' })}
                        </div>
                    </div>
                ` : `<div class="card p-4 mb-6 text-center text-muted">התחבר כדי להגיב לפוסט זה.</div>`}

                <!-- רשימת תגובות -->
                ${comments.length > 0 ? comments.map(comment => `
                    <div class="card p-4 mb-3 border-r-4 ${comment.authorUid === post.authorUid ? 'border-primary' : 'border-accent'}">
                        <div class="flex items-start space-x-3 space-x-reverse mb-2">
                            ${getUserAvatar(comment.authorName)}
                            <div>
                                <p class="font-semibold text-primary">${comment.authorName}</p>
                                <p class="text-xs text-muted">${formatDateTime(comment.createdAt)}</p>
                            </div>
                        </div>
                        <p class="text-gray-700 leading-relaxed mr-12">${comment.content}</p>
                    </div>
                `).join('') : '<p class="text-muted text-center card p-4">אין עדיין תגובות. היה הראשון להגיב!</p>'}
            </main>
        `;
    }

    function ScreenChat() {
        window.sendChatMessage = sendChatMessage;
        const messages = state.chatMessages;
        const onlineUsers = state.onlineUsers;

        // ודא שפונקציות גלובליות זמינות
        window.handleChatInput = (value) => {
            state.chatInput = value;
            render();
        };

        return `
            ${Header()}
            <main class="grid grid-cols-1 md:grid-cols-4 gap-6 p-4 md:p-0">

                <!-- עמודת צ'אט ראשית -->
                <div class="md:col-span-3">
                    <h2 class="text-3xl font-bold text-primary mb-4">צ'אט קהילתי</h2>
                    <div class="card flex flex-col h-[70vh]">
                        <!-- תיבת הודעות -->
                        <div id="chatBox" class="flex-grow overflow-y-auto p-4 space-y-4 bg-gray-50 border-b">
                            ${messages.length === 0 ? `
                                <div class="text-center text-muted pt-10">
                                    <i class="fas fa-feather-alt text-4xl mb-2"></i>
                                    <p>התחל לשוחח! אין עדיין הודעות בצ'אט הציבורי.</p>
                                </div>
                            ` : messages.map(msg => {
                                const isMine = state.user && msg.authorUid === state.user.uid;
                                return `
                                    <div class="flex ${isMine ? 'justify-end' : 'justify-start'}">
                                        <div class="max-w-xs md:max-w-md ${isMine ? 'bg-accent text-white rounded-l-xl rounded-t-xl' : 'bg-gray-200 text-gray-800 rounded-r-xl rounded-t-xl'} p-3 shadow">
                                            ${!isMine ? `<p class="font-semibold text-sm ${isMine ? 'text-white/80' : 'text-primary'}">${msg.authorName}</p>` : ''}
                                            <p class="text-sm">${msg.content}</p>
                                            <p class="text-xs ${isMine ? 'text-white/60' : 'text-gray-500'} mt-1 text-left">${formatDateTime(msg.createdAt)}</p>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>

                        <!-- טופס שליחה -->
                        <div class="p-4 border-t bg-white">
                            ${state.user && !auth.currentUser.isAnonymous ? `
                                <div class="flex space-x-2 space-x-reverse">
                                    <input type="text" id="chatInput"
                                           value="${state.chatInput}"
                                           oninput="handleChatInput(this.value)"
                                           onkeypress="if(event.key === 'Enter') { sendChatMessage(); event.preventDefault(); }"
                                           class="flex-grow px-4 py-2 border border-gray-300 rounded-lg focus:ring-accent focus:border-accent"
                                           placeholder="הקלד את ההודעה שלך...">
                                    ${Button({ text: 'שלח', primary: true, onClick: "sendChatMessage()", icon: 'fas fa-paper-plane' })}
                                </div>
                            ` : `<div class="text-center text-muted">התחבר עם חשבון כדי להשתתף בצ'אט.</div>`}
                        </div>
                    </div>
                </div>

                <!-- עמודת משתמשים -->
                <div class="md:col-span-1">
                    <h3 class="text-xl font-bold text-primary mb-4">מחוברים (${onlineUsers.length})</h3>
                    <div class="card p-4">
                        ${onlineUsers.length > 0 ? onlineUsers.map(user => `
                            <div class="flex items-center space-x-3 space-x-reverse mb-3">
                                ${getUserAvatar(user.displayName)}
                                <div class="flex-grow">
                                    <p class="font-semibold text-sm">${user.displayName}</p>
                                    <div class="text-xs text-green-600 flex items-center">
                                        <i class="fas fa-circle text-green-500 text-[8px] ml-1"></i> פעיל כעת
                                    </div>
                                </div>
                                <div class="text-xs text-muted">${user.city || ''}</div>
                            </div>
                        `).join('') : '<p class="text-muted text-sm text-center">אין משתמשים פעילים כרגע.</p>'}
                        <p class="text-xs text-muted mt-4 border-t pt-2">מודל הדגמה: מציג רק את המשתמש הנוכחי כמחובר. ביישום אמיתי יוצגו משתמשים נוספים.</p>
                    </div>
                </div>
            </main>
        `;
    }

    function ScreenProfile() {
        if (!state.user) {
            return `
                ${Header()}
                <main class="p-4 md:p-0">
                    <div class="card p-6 text-center">
                        <p class="text-xl text-red-500">יש להתחבר כדי לצפות בפרופיל.</p>
                        ${Button({ text: 'להתחברות', primary: true, onClick: "goTo('login')" })}
                    </div>
                </main>
            `;
        }

        const user = state.user;

        return `
            ${Header()}
            <main class="p-4 md:p-0">
                <h2 class="text-3xl font-bold text-primary mb-6">הפרופיל שלי</h2>
                <div class="card p-8 flex flex-col md:flex-row items-start md:items-center space-x-6 space-x-reverse">
                    <div class="flex flex-col items-center md:items-start mb-6 md:mb-0">
                        ${getUserAvatar(user.displayName)}
                        <h3 class="text-2xl font-bold text-primary mt-3">${user.displayName}</h3>
                        <p class="text-muted text-sm">${user.email}</p>
                    </div>

                    <div class="flex-grow w-full">
                        <p class="text-xl font-semibold mb-4 text-accent border-b pb-2">פרטים אישיים</p>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-gray-700">
                            <div>
                                <p class="font-medium text-sm text-primary">מזהה משתמש:</p>
                                <p class="break-all text-xs small-muted">${user.uid}</p>
                            </div>
                            <div>
                                <p class="font-medium text-sm text-primary">גיל (שנת לידה):</p>
                                <p class="text-base">${user.age || 'לא צויין'}</p>
                            </div>
                            <div>
                                <p class="font-medium text-sm text-primary">עיר/ישוב:</p>
                                <p class="text-base">${user.city || 'לא צויין'}</p>
                            </div>
                            <div>
                                <p class="font-medium text-sm text-primary">חבר בקהילה מאז:</p>
                                <p class="text-base">${user.memberSince.toLocaleDateString('he-IL')}</p>
                            </div>
                            <div>
                                <p class="font-medium text-sm text-primary">תפקיד:</p>
                                <p class="pill bg-blue-100 text-blue-700 w-fit">${user.role || 'חבר'}</p>
                            </div>
                            <div>
                                <p class="font-medium text-sm text-primary">סטטוס:</p>
                                <p class="pill bg-green-100 text-green-700 w-fit flex items-center"><i class="fas fa-circle text-green-500 text-[8px] ml-1"></i> פעיל</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-8 flex justify-start">
                    ${Button({ text: 'התנתק', primary: false, onClick: 'handleSignOut()', icon: 'fas fa-sign-out-alt' })}
                </div>
            </main>
        `;
    }

    // --- מערכת הודעות (מודלים) ---

    /**
     * הצגת מודל עם הודעה
     * @param {string} message תוכן ההודעה
     * @param {string} title כותרת המודל
     */
    function showModal(message, title = 'הודעה') {
        const modalId = 'alertModal';
        let modalEl = document.getElementById(modalId);
        if (!modalEl) {
            modalEl = document.createElement('div');
            modalEl.id = modalId;
            document.body.appendChild(modalEl);
        }

        modalEl.className = 'fixed inset-0 modal-backdrop flex items-center justify-center z-60';
        modalEl.innerHTML = `
            <div class="card p-6 w-full max-w-sm mx-4" role="alert">
                <h3 class="font-bold text-xl mb-2 text-primary">${title}</h3>
                <p class="mb-4 text-gray-700">${message}</p>
                <div class="flex justify-end">
                    ${Button({ text: 'אישור', primary: true, onClick: `document.getElementById('${modalId}').classList.add('hidden')` })}
                </div>
            </div>
        `;
        modalEl.classList.remove('hidden');
    }

    /**
     * הצגת מודל תקנון השימוש
     */
    function showRulesModal() {
        const modalEl = document.getElementById('rulesModal');
        if (modalEl) {
            modalEl.classList.remove('hidden');
            modalEl.classList.add('flex');
            state.isModalOpen = true;
            render();
        }
    }

    /**
     * סגירת מודל תקנון השימוש
     */
    function closeRulesModal() {
        const modalEl = document.getElementById('rulesModal');
        if (modalEl) {
            modalEl.classList.add('hidden');
            modalEl.classList.remove('flex');
            state.isModalOpen = false;
            render();
        }
    }

    // --- פונקציית Render ראשית ---

    /**
     * מרונדר את כל האפליקציה בהתאם ל-state
     */
    function render() {
        const container = document.getElementById('app-container');
        if (!container) return;

        // 1. רינדור ה-Header (לא במסכי אימות/טעינה)
        let headerHtml = '';
        if (state.screen !== 'loading' && state.screen !== 'login' && state.screen !== 'register') {
            headerHtml = Header();
        }

        // 2. רינדור המסך הראשי
        let screenHtml = '';
        switch (state.screen) {
            case 'loading':
                screenHtml = ScreenLoading();
                break;
            case 'login':
                screenHtml = ScreenLogin();
                break;
            case 'register':
                screenHtml = ScreenRegister();
                break;
            case 'home':
                screenHtml = ScreenHome();
                break;
            case 'forum':
                screenHtml = ScreenForum();
                break;
            case 'newPost':
                screenHtml = ScreenNewPost();
                break;
            case 'postDetail':
                screenHtml = ScreenPostDetail();
                break;
            case 'chat':
                screenHtml = ScreenChat();
                break;
            case 'profile':
                screenHtml = ScreenProfile();
                break;
            default:
                screenHtml = `
                    <div class="p-10 text-center">
                        <h2 class="text-xl font-bold text-red-500">מסך לא ידוע: ${state.screen}</h2>
                        ${Button({ text: 'חזור לבית', primary: true, onClick: "goTo('home')" })}
                    </div>
                `;
                break;
        }

        // רינדור התוכן הסופי
        container.innerHTML = headerHtml + screenHtml;

        // 3. עדכון ניווט מובייל
        const navMenu = document.getElementById('nav-menu');
        if (navMenu) {
            navMenu.querySelectorAll('.header-link').forEach(link => {
                link.classList.remove('text-accent');
                link.classList.add('text-gray-600');
            });
            const activeLink = navMenu.querySelector(`[onclick="goTo('${state.screen}')"]`);
            if (activeLink) {
                activeLink.classList.remove('text-gray-600');
                activeLink.classList.add('text-accent');
            }
        }
    }

    // --- לוגיקת אתחול ואימות (Auth) ---

    /**
     * אחזור נתונים ראשוניים לאחר אימות
     */
    async function fetchInitialData() {
        // ביישום מורכב יותר, כאן נביא את כל הנתונים הנדרשים למסכי הבית/פורום
        // כרגע, אנחנו רק מפעילים את ה-onSnapshot עבור הפורום (כדי למלא את state.posts)
        if (state.screen === 'home' && state.posts.length === 0) {
            fetchForumPosts();
        }
        // מעדכן פעילות אחרונה בכל טעינת נתונים
        updateLastActive();
    }


    /**
     * טיפול ביציאה מהמערכת
     */
    window.handleSignOut = async () => {
        try {
            await signOut(auth);
            // ה-onAuthStateChanged יטפל בניווט ל-login
            state.user = null;
            goTo('login');
        } catch (error) {
            console.error("שגיאת יציאה:", error);
            showModal('אירעה שגיאה ביציאה מהמערכת.', 'שגיאה');
        }
    };


    /**
     * פונקציית האתחול הראשית של האפליקציה
     */
    async function main() {
        console.log("מתחיל אתחול Firebase...");
        if (!firebaseConfig) {
            console.error("שגיאה: חסר משתנה __firebase_config.");
            state.screen = 'error';
            render();
            return;
        }

        try {
            // אתחול Firebase Services
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            setLogLevel('debug'); // הגדרת רמת לוגים עבור Firestore

            // טיפול באימות ראשוני (Custom Token / אנונימי)
            if (auth.currentUser === null) {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    // אם אין טוקן, מתחברים אנונימית (או נשארים במסך לוגין)
                    // ביישום זה נדרוש לוגין/הרשמה
                    // await signInAnonymously(auth);
                    console.log("אין טוקן אימות. נשארים במסך לוגין/הרשמה.");
                }
            }


            // ה-Listener לשינויים במצב האימות - הליבה של האתחול
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    // **המשתמש מחובר**
                    userId = user.uid;
                    try {
                        let profile = await fetchUserProfile(user.uid);

                        if (profile) {
                            // 1. פרופיל קיים, מעדכנים את ה-state
                            state.user = profile;

                            // 2. אחזור נתונים ראשוניים
                            await fetchInitialData();

                            // 3. ניתוב למסך הבית רק אם לא היתה שגיאה קריטית
                            if (state.screen === 'loading' || state.screen === 'login' || state.screen === 'register') {
                                goTo('home');
                            } else {
                                render(); // אם המשתמש כבר במסך כלשהו (כמו פורום), רנדר מחדש
                            }
                        } else if (!user.isAnonymous) {
                            // המשתמש מחובר ב-Auth אבל לא קיים במסמך users (כנראה נמחק או עדיין לא נרשם)
                            // אם מדובר במשתמש רגיל ולא אנונימי, נאלץ אותו לצאת או להשלים הרשמה
                            console.warn("משתמש Auth קיים ללא פרופיל Firestore. ניתוב להרשמה.");
                            // auth.signOut();
                            goTo('register'); // נניח שהוא נרשם רק ב-Auth ולא השלים את הפרטים
                        } else {
                            // משתמש אנונימי - נשאר במסך לוגין
                            goTo('login');
                        }
                    } catch (error) {
                        console.error("שגיאה קריטית באחזור פרופיל משתמש או נתונים (Firebase/Config):", error);
                         // אם יש שגיאה בחיבור ל-Firebase, אנו חוזרים ללוגין
                        state.user = null;
                        state.screen = 'login';
                        render();
                        showModal("שגיאה בחיבור לשרת או באחזור נתונים. נסה להתחבר שוב.", "שגיאה קריטית");
                    }
                } else {
                    // **המשתמש לא מחובר או יצא**
                    state.user = null;
                    if (state.screen !== 'register') {
                        goTo('login');
                    } else {
                        render();
                    }
                }
            });

        } catch (error) {
            console.error("שגיאה קריטית באתחול האפליקציה (Firebase):", error);
            state.screen = 'login';
            render();
            showModal("שגיאה קריטית באתחול האפליקציה. אנא רענן את הדף.", "שגיאה");
        }
    }

    // הפעלת האפליקציה
    // ודא שפונקציות גלובליות מוגדרות לפני ה-render
    window.goTo = goTo;
    window.viewPost = async (postId) => {
        const post = state.posts.find(p => p.id === postId);
        if (post) {
            await viewPost(post);
        } else {
            console.error("פוסט לא נמצא:", postId);
        }
    };
    window.submitNewPost = submitNewPost;
    window.showRulesModal = showRulesModal;
    window.closeRulesModal = closeRulesModal;
    window.showModal = showModal;

    // הפעלת הפונקציה הראשית רק לאחר טעינת כל ה-DOM והסקריפטים
    document.addEventListener('DOMContentLoaded', main);

    </script>

<!-- Terms modal (simple) -->
<div id="rulesModal" class="fixed inset-0 modal-backdrop hidden items-center justify-center z-60" onclick="if(event.target.id === 'rulesModal') closeRulesModal()">
  <div class="bg-white p-6 rounded w-full max-w-2xl card">
    <h3 class="font-semibold mb-2 text-xl text-primary">תקנון השימוש וקוד התנהגות בקהילה</h3>
    <div class="small-muted mb-4 border-b pb-4">
      <strong>הערה חשובה:</strong> מרכז העזרה מועבר על בסיס קהילתי בלבד. בעלי האתר אינם מספקים ייעוץ מקצועי ואינם אחראים על התכנים או התוצאות. פניות בתחום משפטי, רפואי או פיננסי מהוות המלצה בלבד ואין לראות בהן תחליף לייעוץ מקצועי.
    </div>
    <ol class="text-sm text-gray-700 list-decimal ml-6 max-h-80 overflow-y-auto mb-4">
      <li><strong>כבדו פרטיות:</strong> אין לפרסם מידע אישי של חברים ללא הסכמה ברורה.</li>
      <li><strong>שפה נאותה:</strong> אסור לשתף תכנים פוגעניים, גזעניים, קיצוניים, או להשתמש בשפה אלימה/מאיימת.</li>
      <li><strong>אין מסחר:</strong> הפורום אינו מיועד למכירות, שיווק או פרסום שירותים עסקיים.</li>
      <li><strong>אחריות אישית:</strong> כל המידע והעצות הנמסרים בקהילה הם בגדר המלצה בלבד. השתמשו בשיקול דעת.</li>
      <li><strong>דיוק:</strong> הקפידו על דיוק בפרטים ובמידע שאתם משתפים.</li>
      <li><strong>אמפתיה:</strong> גלו רגישות ואמפתיה לאחרים, במיוחד בנושאים רגישים.</li>
      <li><strong>דיווח:</strong> דווחו למנהלים על כל תוכן פוגעני או מפר כלל.</li>
    </ol>
    <div class="flex justify-end">
        ${Button({ text: 'סגור', primary: false, onClick: "closeRulesModal()" })}
    </div>
  </div>
</div>
</body>
</html>
