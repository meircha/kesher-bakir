<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×§×©×¨ ×‘×›×™×¨ - ×§×”×™×œ×ª ×•×•×ª×™×§×™×</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // ×”×’×“×¨×•×ª Tailwind CSS ××•×ª×××•×ª
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'kesher-green': '#38a169',
                        'kesher-blue': '#4299e1',
                        'kesher-bg': '#f7fdf7',
                    }
                }
            }
        }
    </script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>
<body class="bg-kesher-bg min-h-screen">
    <div id="root"></div>

    <script>
        // --- Firebase Init ---
        firebase.initializeApp({
            apiKey: "AIzaSyCrcxC420HW5PXGNd8M4KuclUkiJSwHreM", // ×”×—×œ×£ ×‘××¤×ª×—×•×ª ×”×××™×ª×™×™× ×©×œ×š
            authDomain: "kesher-bakir.firebaseapp.com",
            projectId: "kesher-bakir",
            storageBucket: "kesher-bakir.firebasestorage.app",
            messagingSenderId: "671996189455",
            appId: "1:671996189455:web:d8ee089585a852ab38fc7a"
        });

        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- State ---
        let state = {
            user: null,
            screen: 'login',
            users: [],
            forums: [],
            activities: [],
            reports: [],
            currentForumId: null,
            currentPostId: null,
            currentChatId: null,
            chatMessages: [],
            selectedUser: null,
            searchFilters: { city: '', hobby: '', contribution: '' } // ×“×¨×™×©×” 4
        };

        // --- × ×ª×•× ×™× ×§×‘×•×¢×™× ---
        const HOBBIES = ['×§×¨×™××”', '×‘×™×©×•×œ', '×’×™× ×•×Ÿ', '×˜×™×•×œ×™×', '×©×—××˜', '××—×©×‘×™×', '×¡×¤×•×¨×˜'];
        const CONTRIBUTIONS = ['×™×™×¢×•×¥ ××©×¤×˜×™', '××—×©×‘×™× ×•×˜×›× ×•×œ×•×’×™×”', '×™×™×¢×•×¥ ×¤×™× × ×¡×™', '×ª××™×›×” ×¨×’×©×™×ª', '×©×¤×•×ª ×–×¨×•×ª', '×‘×™×©×•×œ ×•××¤×™×™×”', '××—×¨'];
        const REPORT_TYPES = ['×©×¤×” ×œ× × ××•×ª×”', '×ª×•×›×Ÿ ×¤×•×’×¢× ×™', '×”×˜×¨×“×” ×‘×¦×³××˜', '×”×ª×—×–×•×ª', '××—×¨'];
        
        // --- ×¤×•× ×§×¦×™×•×ª ×¢×–×¨ ×›×œ×œ×™×•×ª ---

        // ×“×¨×™×©×” 4 - ×©×—×–×•×¨ ×¡×™×¡××”
        async function doResetPassword() {
            const email = prompt('×× × ×”×›× ×¡ ××ª ×”××™×™×œ ×©×œ×š ×œ×©×—×–×•×¨ ×¡×™×¡××”:');
            if (email) {
                try {
                    await auth.sendPasswordResetEmail(email);
                    alert('âœ… × ×©×œ×— ×§×™×©×•×¨ ×œ×©×—×–×•×¨ ×¡×™×¡××” ×œ××™×™×œ ×©×œ×š.');
                } catch(e) {
                    alert('×©×’×™××” ×‘×©×œ×™×—×ª ×§×™×©×•×¨: ' + e.message);
                }
            }
        }

        function goTo(screen, data = {}) {
            state.screen = screen;
            if (screen === 'forumPosts') {
                state.currentForumId = data.forumId;
                loadPosts(data.forumId);
            } else if (screen === 'postDetails') {
                state.currentPostId = data.postId;
                loadPostDetails(data.postId);
            } else if (screen === 'chat') {
                state.currentChatId = data.chatId;
                state.selectedUser = data.targetUser;
                loadChatMessages(data.chatId);
            } else if (screen === 'admin') {
                loadReports();
            }
            render();
        }

        // --- ×˜×¢×™× ×ª × ×ª×•× ×™× ×›×œ×œ×™×ª (××§×•×¦×¨×ª) ---
        async function loadData() {
            try {
                // ××©×ª××©×™×
                const usersSnap = await db.collection('users').get();
                state.users = usersSnap.docs.map(d => ({id: d.id, ...d.data(), isOnline: false})); // isOnline ×™×˜×•×¤×œ ×‘× ×¤×¨×“
                
                // ×¤×•×¨×•××™×
                const forumsSnap = await db.collection('forums').get();
                state.forums = forumsSnap.docs.map(d => ({id: d.id, ...d.data()}));
                
                // ×¤×¢×™×œ×•×™×•×ª (×“×¨×™×©×” 3)
                const activitiesSnap = await db.collection('activities').get();
                state.activities = activitiesSnap.docs.map(d => ({id: d.id, ...d.data()}));
                
                render();
            } catch (e) {
                console.error("×©×’×™××” ×‘×˜×¢×™× ×ª × ×ª×•× ×™×:", e);
            }
        }

        // --- Auth & User Status ---
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                const doc = await db.collection('users').doc(user.uid).get();
                if (doc.exists) {
                    state.user = {id: user.uid, ...doc.data()};
                    // ×“×¨×™×©×” 4 - ×¢×“×›×•×Ÿ ×¡×˜×˜×•×¡ ××•× ×œ×™×™×Ÿ
                    await db.collection('users').doc(user.uid).update({ isOnline: true });
                    state.screen = 'home';
                    await initDefaultData();
                    await loadData();
                    // ×”×’×“×¨×ª ×××–×™×Ÿ ×œ×©×™× ×•×™×™× ×‘×¡×˜×˜×•×¡ ××•× ×œ×™×™×Ÿ ×©×œ ××©×ª××©×™× ××—×¨×™×
                    setupOnlineStatusListener(); 
                }
            } else {
                if (state.user) {
                     // ×“×¨×™×©×” 4 - ×¢×“×›×•×Ÿ ×¡×˜×˜×•×¡ ×œ× ××§×•×•×Ÿ
                    await db.collection('users').doc(state.user.id).update({ isOnline: false });
                }
                state.user = null;
                state.screen = 'login';
                render();
            }
        });
        
        // --- ×¤×•× ×§×¦×™×•×ª ××©×ª××© ×•×¨×™×©×•× ---

        async function doRegister() {
            const name = document.getElementById('rName').value;
            const email = document.getElementById('rEmail').value;
            const pwd = document.getElementById('rPwd').value;
            const age = document.getElementById('rAge').value;
            const city = document.getElementById('rCity').value;
            // ×“×¨×™×©×” 1 - ×ª×—×‘×™×‘×™× ×•×ª×¨×•××•×ª
            const hobbies = Array.from(document.querySelectorAll('input[name="hobby"]:checked')).map(cb => cb.value);
            const contributions = Array.from(document.querySelectorAll('input[name="contribution"]:checked')).map(cb => cb.value);

            if (!name || !email || !pwd || !age || !city || hobbies.length === 0 || contributions.length === 0) {
                alert('××œ× ××ª ×›×œ ×”×©×“×•×ª ×•×‘×—×¨ ×œ×¤×—×•×ª ×ª×—×‘×™×‘ ××—×“ ×•× ×•×©× ×ª×¨×•××” ××—×“.');
                return;
            }
            if (parseInt(age) < 60) {
                alert('×’×™×œ ××™× ×™××œ×™: 60');
                return;
            }

            try {
                const cred = await auth.createUserWithEmailAndPassword(email, pwd);
                await db.collection('users').doc(cred.user.uid).set({
                    name, email, age: parseInt(age), city,
                    role: 'user', points: 0,
                    hobbies: hobbies, // ×“×¨×™×©×” 1
                    contributions: contributions, // ×“×¨×™×©×” 1
                    isOnline: false, // ×“×¨×™×©×” 4
                    joinDate: new Date().toISOString()
                });
                alert('âœ… × ×¨×©××ª ×‘×”×¦×œ×—×”!');
            } catch(e) {
                alert('×©×’×™××”: ' + e.message);
            }
        }

        // --- ×“×¨×™×©×” 4: ×¦'××˜ ×•××©×ª××©×™× ---

        // ×××–×™×Ÿ ×œ×©×™× ×•×™×™× ×‘×¡×˜×˜×•×¡ ××•× ×œ×™×™×Ÿ ×©×œ ×›×œ ×”××©×ª××©×™×
        function setupOnlineStatusListener() {
            db.collection('users').onSnapshot(snapshot => {
                snapshot.docChanges().forEach(change => {
                    if (change.type === 'modified' || change.type === 'added') {
                        const updatedUser = { id: change.doc.id, ...change.doc.data() };
                        const index = state.users.findIndex(u => u.id === updatedUser.id);
                        if (index > -1) {
                            state.users[index].isOnline = updatedUser.isOnline;
                        } else {
                            state.users.push(updatedUser);
                        }
                    }
                });
                if (state.screen === 'users' || state.screen === 'home') {
                    render(); // ×¨×¢× ×•×Ÿ ×ª×¦×•×’×”
                }
            });
        }
        
        // ×¤×ª×™×—×ª ×¦'××˜ ××• ×™×¦×™×¨×ª ×¦'××˜ ×—×“×© (×“×¨×™×©×” 4)
        async function openChat(targetUser) {
            if (targetUser.id === state.user.id) return;
            
            const chatId1 = `${state.user.id}_${targetUser.id}`;
            const chatId2 = `${targetUser.id}_${state.user.id}`;

            const chatSnap1 = await db.collection('chats').doc(chatId1).get();
            const chatSnap2 = await db.collection('chats').doc(chatId2).get();

            let chatId;
            if (chatSnap1.exists) {
                chatId = chatId1;
            } else if (chatSnap2.exists) {
                chatId = chatId2;
            } else {
                // ×¦×•×¨ ×¦'××˜ ×—×“×©
                await db.collection('chats').doc(chatId1).set({
                    users: [state.user.id, targetUser.id],
                    createdAt: new Date()
                });
                chatId = chatId1;
            }
            goTo('chat', { chatId, targetUser });
        }
        
        // ×˜×¢×™× ×ª ×”×•×“×¢×•×ª ×¦'××˜ (×¢× ×××–×™×Ÿ ×œ×–××Ÿ ×××ª)
        function loadChatMessages(chatId) {
            db.collection('chats').doc(chatId).collection('messages').orderBy('timestamp').onSnapshot(snapshot => {
                state.chatMessages = snapshot.docs.map(d => ({id: d.id, ...d.data()}));
                if (state.screen === 'chat') {
                    render();
                    // ×’×œ×™×œ×” ××•×˜×•××˜×™×ª ×œ×ª×—×ª×™×ª
                    const chatBox = document.getElementById('chatBox');
                    if (chatBox) chatBox.scrollTop = chatBox.scrollHeight;
                }
            });
        }
        
        // ×©×œ×™×—×ª ×”×•×“×¢×” ×‘×¦'××˜
        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const content = input.value.trim();
            if (content && state.currentChatId) {
                await db.collection('chats').doc(state.currentChatId).collection('messages').add({
                    senderId: state.user.id,
                    content: content,
                    timestamp: new Date()
                });
                input.value = '';
            }
        }
        
        // --- ×“×¨×™×©×” 3: ×¤×¨×¡×•× ×¤×¢×™×œ×•×ª ×—×“×©×” ---

        async function createActivity() {
            const title = document.getElementById('activityTitle').value;
            const description = document.getElementById('activityDescription').value;
            const date = document.getElementById('activityDate').value;
            const location = document.getElementById('activityLocation').value;

            if (!title || !description || !date || !location) {
                alert('××œ× ××ª ×›×œ ×©×“×•×ª ×”×¤×¢×™×œ×•×ª.');
                return;
            }

            try {
                await db.collection('activities').add({
                    title, description, date, location,
                    creatorId: state.user.id,
                    creatorName: state.user.name,
                    attendees: [state.user.id],
                    createdAt: new Date()
                });
                alert('âœ… ×”×¤×¢×™×œ×•×ª ×¤×•×¨×¡××” ×‘×”×¦×œ×—×”!');
                await loadData();
                goTo('activities'); // ×—×–×¨×” ×œ××¡×š ×”×¤×¢×™×œ×•×™×•×ª
            } catch (e) {
                alert('×©×’×™××” ×‘×¤×¨×¡×•× ×¤×¢×™×œ×•×ª: ' + e.message);
            }
        }

        async function registerForActivity(activityId) {
            const activity = state.activities.find(a => a.id === activityId);
            if (!activity) return;

            if (activity.attendees.includes(state.user.id)) {
                alert('××ª×” ×›×‘×¨ ×¨×©×•× ×œ×¤×¢×™×œ×•×ª ×–×•.');
                return;
            }

            try {
                await db.collection('activities').doc(activityId).update({
                    attendees: firebase.firestore.FieldValue.arrayUnion(state.user.id)
                });
                alert('âœ… × ×¨×©××ª ×œ×¤×¢×™×œ×•×ª ×‘×”×¦×œ×—×”!');
                await loadData(); // ×¨×¢× ×•×Ÿ × ×ª×•× ×™×
            } catch (e) {
                alert('×©×’×™××” ×‘×”×¨×©××”: ' + e.message);
            }
        }

        // --- ×“×¨×™×©×” 2: ×¤×•×¨×•××™×, ×¤×•×¡×˜×™× ×•×ª×’×•×‘×•×ª ---

        // × ×ª×•× ×™× ×¨××©×•× ×™×™× ×× ×œ× ×§×™×™××™×
        async function initDefaultData() {
            const forumsSnap = await db.collection('forums').get();
            if (forumsSnap.empty) {
                const defaultForums = [
                    { title: '×¢×–×¨×” ×‘× ×•×©××™× ×˜×›× ×•×œ×•×’×™×™×', icon: 'ğŸ’»', description: '×©××œ×•×ª ×•×ª×©×•×‘×•×ª', creatorId: 'system' },
                    { title: '×©××™×¨×” ×¢×œ ×›×•×©×¨ ×•×‘×¨×™××•×ª', icon: 'ğŸƒâ€â™‚ï¸', description: '×ª×¨×’×™×œ×™× ×•×˜×™×¤×™×', creatorId: 'system' },
                    { title: '××ª×›×•× ×™× ×•×‘×™×©×•×œ', icon: 'ğŸ³', description: '×©×™×ª×•×£ ××ª×›×•× ×™×', creatorId: 'system' },
                    { title: '×˜×™×•×œ×™× ×•×˜×‘×¢', icon: 'ğŸŒ„', description: '×”××œ×¦×•×ª ×˜×™×•×œ×™×', creatorId: 'system' }
                ];
                for (const forum of defaultForums) {
                    await db.collection('forums').add(forum);
                }
            }
        }

        // ×˜×¢×™× ×ª ×¤×•×¡×˜×™× ×œ×¤×•×¨×•× ××¡×•×™× (×“×¨×™×©×” 2)
        function loadPosts(forumId) {
            db.collection('posts').where('forumId', '==', forumId).orderBy('createdAt', 'desc').onSnapshot(snapshot => {
                const forum = state.forums.find(f => f.id === forumId);
                if (forum) {
                    forum.posts = snapshot.docs.map(d => ({id: d.id, ...d.data()}));
                    if (state.screen === 'forumPosts') render();
                }
            });
        }
        
        // ×˜×¢×™× ×ª ×¤×¨×˜×™ ×¤×•×¡×˜ ×•×ª×’×•×‘×•×ª (×“×¨×™×©×” 2)
        function loadPostDetails(postId) {
             // ×××–×™×Ÿ ×œ×©×™× ×•×™×™× ×‘×¤×•×¡×˜ ×¢×¦××•
            db.collection('posts').doc(postId).onSnapshot(doc => {
                if (doc.exists) {
                    state.currentPost = { id: doc.id, ...doc.data() };
                }
                if (state.screen === 'postDetails') render();
            });

             // ×××–×™×Ÿ ×œ×©×™× ×•×™×™× ×‘×ª×’×•×‘×•×ª
            db.collection('replies').where('postId', '==', postId).orderBy('createdAt').onSnapshot(snapshot => {
                state.currentPostReplies = snapshot.docs.map(d => ({id: d.id, ...d.data()}));
                if (state.screen === 'postDetails') render();
            });
        }

        // ×™×¦×™×¨×ª ×¤×•×¡×˜ ×—×“×© (×“×¨×™×©×” 2)
        async function createPost() {
            const title = document.getElementById('postTitle').value;
            const content = document.getElementById('postContent').value;
            if (!title || !content) {
                alert('××œ× ×›×•×ª×¨×ª ×•×ª×•×›×Ÿ.');
                return;
            }
            try {
                await db.collection('posts').add({
                    forumId: state.currentForumId,
                    title, content,
                    creatorId: state.user.id,
                    creatorName: state.user.name,
                    likes: [], // ×“×¨×™×©×” 2
                    createdAt: new Date(),
                });
                alert('âœ… ×”×¤×•×¡×˜ ×¤×•×¨×¡×!');
                goTo('forumPosts', { forumId: state.currentForumId });
            } catch (e) {
                alert('×©×’×™××” ×‘×¤×¨×¡×•× ×¤×•×¡×˜: ' + e.message);
            }
        }
        
        // ×”×•×¡×¤×ª ×ª×’×•×‘×” (×“×¨×™×©×” 2)
        async function addReply() {
            const content = document.getElementById('replyContent').value;
            if (!content) return;
            try {
                await db.collection('replies').add({
                    postId: state.currentPostId,
                    content,
                    creatorId: state.user.id,
                    creatorName: state.user.name,
                    createdAt: new Date()
                });
                document.getElementById('replyContent').value = '';
                // ×”×××–×™×Ÿ ×©×œ loadPostDetails ×™×¢×©×” render ××•×˜×•××˜×™×ª
            } catch (e) {
                alert('×©×’×™××” ×‘×”×•×¡×¤×ª ×ª×’×•×‘×”: ' + e.message);
            }
        }

        // ×œ×™×™×§ ×œ×¤×•×¡×˜ (×“×¨×™×©×” 2)
        async function toggleLike(postId) {
            const postRef = db.collection('posts').doc(postId);
            const post = state.currentPost;

            if (post.likes.includes(state.user.id)) {
                // ×”×¡×¨×ª ×œ×™×™×§
                await postRef.update({
                    likes: firebase.firestore.FieldValue.arrayRemove(state.user.id)
                });
            } else {
                // ×”×•×¡×¤×ª ×œ×™×™×§
                await postRef.update({
                    likes: firebase.firestore.FieldValue.arrayUnion(state.user.id)
                });
            }
            // ×”×××–×™×Ÿ ×©×œ loadPostDetails ×™×¢×©×” render ××•×˜×•××˜×™×ª
        }

        // ×¢×¨×™×›×”/××—×™×§×” (×“×¨×™×©×•×ª 2 ×•-5)
        async function deletePost(postId) {
            if (!confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×”×¤×•×¡×˜?')) return;
            try {
                await db.collection('posts').doc(postId).delete();
                // ××—×™×§×ª ×›×œ ×”×ª×’×•×‘×•×ª ×œ×¤×•×¡×˜ ×–×”
                const repliesSnap = await db.collection('replies').where('postId', '==', postId).get();
                const batch = db.batch();
                repliesSnap.docs.forEach(doc => batch.delete(doc.ref));
                await batch.commit();
                alert('âœ… ×”×¤×•×¡×˜ × ××—×§.');
                goTo('forumPosts', { forumId: state.currentForumId });
            } catch (e) {
                alert('×©×’×™××” ×‘××—×™×§×ª ×¤×•×¡×˜: ' + e.message);
            }
        }

        async function editPost(postId, currentTitle, currentContent) {
            const newTitle = prompt('×¢×¨×•×š ×›×•×ª×¨×ª:', currentTitle);
            if (newTitle === null) return;
            const newContent = prompt('×¢×¨×•×š ×ª×•×›×Ÿ:', currentContent);
            if (newContent === null) return;
            
            if (newTitle.trim() && newContent.trim()) {
                await db.collection('posts').doc(postId).update({ title: newTitle, content: newContent });
                alert('âœ… ×”×¤×•×¡×˜ ×¢×•×“×›×Ÿ.');
            }
        }
        
        async function deleteReply(replyId) {
            if (!confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×”×ª×’×•×‘×”?')) return;
            try {
                await db.collection('replies').doc(replyId).delete();
                alert('âœ… ×”×ª×’×•×‘×” × ××—×§×”.');
                // ×”×××–×™×Ÿ ×™×¢×©×” render
            } catch (e) {
                alert('×©×’×™××” ×‘××—×™×§×ª ×ª×’×•×‘×”: ' + e.message);
            }
        }

        // --- ×“×¨×™×©×” 5: ×›×¤×ª×•×¨ ×“×™×•×•×— (×›×œ×œ×™) ---

        async function reportItem(itemId, itemType, itemCreatorId) {
            const reason = prompt('××”×™ ×¡×™×‘×ª ×”×“×™×•×•×—? ×‘×—×¨ ××ª×•×š: ' + REPORT_TYPES.join(', ') + ' ××• ×›×ª×•×‘ ××—×¨×ª:');
            if (!reason) return;

            const reportType = REPORT_TYPES.includes(reason) ? reason : '××—×¨';

            try {
                await db.collection('reports').add({
                    itemId, itemType, itemCreatorId,
                    reporterId: state.user.id,
                    reporterName: state.user.name,
                    reportType: reportType,
                    reason: reason,
                    status: '×—×“×©',
                    createdAt: new Date()
                });
                alert('âœ… ×”×“×™×•×•×— × ×©×œ×— ×œ×× ×”×œ×™×, ×ª×•×“×”!');
            } catch (e) {
                alert('×©×’×™××” ×‘×©×œ×™×—×ª ×“×™×•×•×—: ' + e.message);
            }
        }
        
        // --- ×¤×•× ×§×¦×™×•×ª × ×™×”×•×œ (×“×¨×™×©×” 5) ---
        
        // ×˜×¢×™× ×ª ×“×™×•×•×—×™×
        async function loadReports() {
            if (state.user?.role !== 'admin') return;
            const reportsSnap = await db.collection('reports').orderBy('createdAt', 'desc').get();
            state.reports = reportsSnap.docs.map(d => ({id: d.id, ...d.data()}));
            render();
        }

        // ×¢×“×›×•×Ÿ ×¡×˜×˜×•×¡ ×“×™×•×•×—
        async function updateReportStatus(reportId, newStatus) {
            await db.collection('reports').doc(reportId).update({ status: newStatus });
            alert(`âœ… ×”×¡×˜×˜×•×¡ ×¢×•×“×›×Ÿ ×œ: ${newStatus}`);
            await loadReports();
        }

        // ×”×•×¡×¤×ª ×¤×•×¨×•× ×—×“×©
        async function addForum() {
            const title = prompt('×©× ×”×¤×•×¨×•×:');
            const description = prompt('×ª×™××•×¨ ×”×¤×•×¨×•×:');
            const icon = prompt('××™×™×§×•×Ÿ (××™××•×’\'×™):', 'ğŸ’¬');

            if (title && description) {
                await db.collection('forums').add({
                    title, description, icon,
                    creatorId: state.user.id,
                    createdAt: new Date()
                });
                alert('âœ… ×¤×•×¨×•× ×—×“×© × ×•×¡×£!');
                await loadData();
            }
        }
        
        // ×¢×¨×™×›×ª ×¤×•×¨×•×
        async function editForum(forum) {
            const newTitle = prompt('×¢×¨×•×š ×©× ×¤×•×¨×•×:', forum.title);
            if (newTitle === null) return;
            const newDescription = prompt('×¢×¨×•×š ×ª×™××•×¨ ×¤×•×¨×•×:', forum.description);
            if (newDescription === null) return;
            const newIcon = prompt('×¢×¨×•×š ××™×™×§×•×Ÿ:', forum.icon);
            if (newIcon === null) return;

            if (newTitle.trim() && newDescription.trim()) {
                await db.collection('forums').doc(forum.id).update({
                    title: newTitle, description: newDescription, icon: newIcon
                });
                alert('âœ… ×”×¤×•×¨×•× ×¢×•×“×›×Ÿ.');
                await loadData();
            }
        }

        // ××—×™×§×ª ×¤×•×¨×•×
        async function deleteForum(forumId) {
             if (!confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×”×¤×•×¨×•× ×•××ª ×›×œ ×”×¤×•×¡×˜×™× ×•×”×ª×’×•×‘×•×ª ×‘×ª×•×›×•?')) return;
             // ×”×¢×¨×”: ××—×™×§×ª ×ª×›× ×™ ×”×¤×•×¨×•× ×“×•×¨×©×ª ×œ×•×’×™×§×” ××•×¨×›×‘×ª ×™×•×ª×¨ ×©××™× ×” ×××•××©×ª ×‘××œ×•××” ×›××Ÿ (×¦×¨×™×š ×œ××—×•×§ posts ×•-replies ×§×•×“×), ××š × ×©××™×¨ ××ª ×–×” ×›×¤×•× ×§×¦×™×” ×‘×¡×™×¡×™×ª:
             await db.collection('forums').doc(forumId).delete();
             alert('âœ… ×”×¤×•×¨×•× × ××—×§.');
             await loadData();
        }


        // --- Render Functions (Tailwind UI) ---

        const getHeader = () => `
            <header class="bg-white shadow p-4 mb-6 sticky top-0 z-10">
                <div class="max-w-6xl mx-auto flex justify-between items-center">
                    <h1 class="text-2xl font-bold text-kesher-green">×§×©×¨ ×‘×›×™×¨ ğŸ§‘â€ğŸ¦³</h1>
                    <div class="flex gap-3 items-center">
                        <span class="font-medium">${state.user.name}</span>
                        ${state.user.role === 'admin' ? '<span class="bg-amber-200 px-3 py-1 rounded-full text-sm">ğŸ‘‘ ×× ×”×œ</span>' : ''}
                        <button onclick="doLogout()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition">×™×¦×™××”</button>
                    </div>
                </div>
            </header>
            <div class="max-w-6xl mx-auto px-4">
                <nav class="bg-white rounded-xl shadow p-3 flex gap-3 mb-6 overflow-x-auto">
                    <button onclick="goTo('home')" class="${state.screen === 'home' ? 'bg-green-100 text-green-800' : 'hover:bg-gray-100'} px-4 py-2 rounded-lg font-medium whitespace-nowrap">ğŸ  ×‘×™×ª</button>
                    <button onclick="goTo('users')" class="${state.screen === 'users' ? 'bg-green-100 text-green-800' : 'hover:bg-gray-100'} px-4 py-2 rounded-lg font-medium whitespace-nowrap">ğŸ‘¥ ×—×‘×¨×™× ×•×¦'××˜</button>
                    <button onclick="goTo('forums')" class="${state.screen === 'forums' || state.screen === 'forumPosts' || state.screen === 'postDetails' ? 'bg-green-100 text-green-800' : 'hover:bg-gray-100'} px-4 py-2 rounded-lg font-medium whitespace-nowrap">ğŸ’¬ ×¤×•×¨×•××™×</button>
                    <button onclick="goTo('activities')" class="${state.screen === 'activities' || state.screen === 'newActivity' ? 'bg-green-100 text-green-800' : 'hover:bg-gray-100'} px-4 py-2 rounded-lg font-medium whitespace-nowrap">ğŸ—“ï¸ ×¤×¢×™×œ×•×™×•×ª</button>
                    ${state.user.role === 'admin' ? `<button onclick="goTo('admin')" class="${state.screen === 'admin' ? 'bg-green-100 text-green-800' : 'hover:bg-gray-100'} px-4 py-2 rounded-lg font-medium whitespace-nowrap">âš™ï¸ × ×™×”×•×œ</button>` : ''}
                </nav>
            </div>
        `;

        const renderLogin = () => `
            <div class="min-h-screen flex items-center justify-center p-4">
                <div class="bg-white rounded-2xl shadow-xl p-8 w-full max-w-md">
                    <h1 class="text-3xl font-bold text-center text-kesher-green mb-8">×§×©×¨ ×‘×›×™×¨ ğŸ¤</h1>
                    <input id="email" type="email" placeholder="××™×™×œ" class="w-full p-3 border-2 rounded-lg mb-4" />
                    <input id="pwd" type="password" placeholder="×¡×™×¡××”" class="w-full p-3 border-2 rounded-lg mb-6" />
                    <button onclick="doLogin()" class="w-full bg-kesher-green hover:bg-green-700 text-white p-3 rounded-lg font-bold mb-3">×›× ×™×¡×”</button>
                    <button onclick="goTo('register')" class="w-full bg-amber-200 hover:bg-amber-300 text-amber-900 p-3 rounded-lg font-bold mb-3">×”×¨×©××”</button>
                    <button onclick="doResetPassword()" class="w-full text-blue-500 hover:text-blue-700 text-sm font-medium">×©×›×—×ª×™ ×¡×™×¡××”</button>
                </div>
            </div>
        `;

        const renderRegister = () => `
            <div class="min-h-screen flex items-center justify-center p-4">
                <div class="bg-white rounded-2xl shadow-xl p-8 w-full max-w-lg">
                    <h1 class="text-2xl font-bold text-center text-kesher-green mb-6">×”×¨×©××” ×œ×§×”×™×œ×ª 60+</h1>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <input id="rName" type="text" placeholder="×©× ××œ×" class="p-3 border-2 rounded-lg" />
                        <input id="rEmail" type="email" placeholder="××™×™×œ" class="p-3 border-2 rounded-lg" />
                        <input id="rPwd" type="password" placeholder="×¡×™×¡××” (6+ ×ª×•×•×™×)" class="p-3 border-2 rounded-lg" />
                        <input id="rAge" type="number" placeholder="×’×™×œ (60+)" class="p-3 border-2 rounded-lg" />
                    </div>
                    <input id="rCity" type="text" placeholder="×¢×™×¨ ××’×•×¨×™×" class="w-full p-3 border-2 rounded-lg mb-6" />
                    
                    <h3 class="font-bold text-lg mb-2 text-kesher-green">×”×ª×—×‘×™×‘×™× ×©×œ×™: (×‘×—×¨ ×œ×¤×—×•×ª 1)</h3>
                    <div class="grid grid-cols-2 sm:grid-cols-3 gap-2 mb-6">
                        ${HOBBIES.map(h => `
                            <label class="flex items-center p-2 bg-gray-50 rounded-lg cursor-pointer">
                                <input type="checkbox" name="hobby" value="${h}" class="mr-2 h-4 w-4 text-kesher-green rounded focus:ring-kesher-green" />
                                <span class="text-sm">${h}</span>
                            </label>
                        `).join('')}
                    </div>

                    <h3 class="font-bold text-lg mb-2 text-kesher-green">× ×•×©××™ ×ª×¨×•××”: (×‘×—×¨ ×œ×¤×—×•×ª 1)</h3>
                    <p class="text-sm text-gray-600 mb-4">×‘××” ××ª×” ×™×›×•×œ ×œ×¢×–×•×¨ ×œ××©×ª××©×™× ××—×¨×™×?</p>
                    <div class="grid grid-cols-2 sm:grid-cols-3 gap-2 mb-6">
                        ${CONTRIBUTIONS.map(c => `
                            <label class="flex items-center p-2 bg-gray-50 rounded-lg cursor-pointer">
                                <input type="checkbox" name="contribution" value="${c}" class="mr-2 h-4 w-4 text-kesher-green rounded focus:ring-kesher-green" />
                                <span class="text-sm">${c}</span>
                            </label>
                        `).join('')}
                    </div>

                    <button onclick="doRegister()" class="w-full bg-kesher-green hover:bg-green-700 text-white p-3 rounded-lg font-bold mb-3">×”×¨×©××”</button>
                    <button onclick="goTo('login')" class="w-full bg-gray-300 p-3 rounded-lg font-bold">×—×–×¨×” ×œ×›× ×™×¡×”</button>
                </div>
            </div>
        `;
        
        // ×“×¨×™×©×” 4: ×¡×™× ×•×Ÿ ××©×ª××©×™×
        function applyUserFilters() {
            state.searchFilters.city = document.getElementById('filterCity').value;
            state.searchFilters.hobby = document.getElementById('filterHobby').value;
            state.searchFilters.contribution = document.getElementById('filterContribution').value;
            render(); // ×¨×¢× ×•×Ÿ ××¡×š users
        }
        
        const renderUsers = () => {
            // ×“×¨×™×©×” 4 - ×œ×•×’×™×§×ª ×¡×™× ×•×Ÿ
            const filteredUsers = state.users.filter(u => {
                const cityMatch = !state.searchFilters.city || u.city?.toLowerCase().includes(state.searchFilters.city.toLowerCase());
                const hobbyMatch = !state.searchFilters.hobby || u.hobbies?.includes(state.searchFilters.hobby);
                const contributionMatch = !state.searchFilters.contribution || u.contributions?.includes(state.searchFilters.contribution);
                const isCurrentUser = u.id === state.user.id;
                
                return cityMatch && hobbyMatch && contributionMatch && !isCurrentUser;
            });

            return `
                ${getHeader()}
                <div class="max-w-6xl mx-auto px-4">
                    <h2 class="text-3xl font-bold text-kesher-blue mb-6">ğŸ‘¥ ××¦×™××ª ×—×‘×¨×™× ×—×“×©×™×</h2>
                    
                    <div class="bg-white p-5 rounded-xl shadow-lg mb-6 grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                        <input id="filterCity" type="text" placeholder="×—×™×¤×•×© ×œ×¤×™ ×¢×™×¨" value="${state.searchFilters.city}" class="p-3 border rounded-lg" onkeyup="applyUserFilters()" />
                        <select id="filterHobby" class="p-3 border rounded-lg" onchange="applyUserFilters()">
                            <option value="">×›×œ ×”×ª×—×‘×™×‘×™×</option>
                            ${HOBBIES.map(h => `<option value="${h}" ${state.searchFilters.hobby === h ? 'selected' : ''}>${h}</option>`).join('')}
                        </select>
                        <select id="filterContribution" class="p-3 border rounded-lg" onchange="applyUserFilters()">
                            <option value="">×›×œ × ×•×©××™ ×”×ª×¨×•××”</option>
                            ${CONTRIBUTIONS.map(c => `<option value="${c}" ${state.searchFilters.contribution === c ? 'selected' : ''}>${c}</option>`).join('')}
                        </select>
                        <button onclick="state.searchFilters = { city: '', hobby: '', contribution: '' }; applyUserFilters();" class="p-3 bg-gray-200 rounded-lg font-bold hover:bg-gray-300">××™×¤×•×¡</button>
                    </div>

                    <div class="space-y-4">
                        ${filteredUsers.length > 0 ? filteredUsers.map(u => `
                            <div class="bg-white p-5 rounded-xl shadow-md flex justify-between items-center hover:shadow-lg transition">
                                <div class="flex items-center gap-4">
                                    <div class="w-12 h-12 rounded-full flex items-center justify-center bg-blue-100 text-2xl">${u.name.substring(0,1)}</div>
                                    <div>
                                        <p class="font-bold text-lg">${u.name} 
                                            <span class="text-sm ${u.isOnline ? 'text-green-500' : 'text-gray-500'} font-normal">
                                                ${u.isOnline ? 'ğŸŸ¢ ××—×•×‘×¨' : 'âš« ×œ× ××—×•×‘×¨'}
                                            </span>
                                        </p>
                                        <p class="text-sm text-gray-600">${u.age} â€¢ ${u.city}</p>
                                        <p class="text-xs text-gray-500 mt-1">×ª×—×‘×™×‘×™×: ${u.hobbies?.join(', ')} | ×ª×¨×•××”: ${u.contributions?.join(', ')}</p>
                                    </div>
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="openChat({id: '${u.id}', name: '${u.name}'})" class="bg-kesher-green hover:bg-green-700 text-white px-4 py-2 rounded-lg font-bold text-sm">×©×œ×— ×”×•×“×¢×” ğŸ’¬</button>
                                    <button onclick="reportItem('${u.id}', 'user', '${u.id}')" class="bg-red-100 hover:bg-red-200 text-red-700 px-3 py-2 rounded-lg text-sm">âš ï¸ ×“×•×•×—</button>
                                </div>
                            </div>
                        `).join('') : '<p class="text-center text-xl text-gray-500 p-10">×œ× × ××¦××• ××©×ª××©×™× ×ª×•×××™× ×œ×¡×™× ×•×Ÿ.</p>'}
                    </div>
                </div>
            `;
        }

        const renderChat = () => {
            const targetUser = state.selectedUser;
            if (!targetUser) return goTo('users'); // ×—×–×¨×” ×× ××™×Ÿ ××©×ª××© × ×‘×—×¨

            return `
                ${getHeader()}
                <div class="max-w-4xl mx-auto px-4">
                    <button onclick="goTo('users')" class="mb-4 text-kesher-blue hover:text-blue-700 font-bold">â† ×—×–×¨×” ×œ×—×‘×¨×™×</button>
                    <div class="bg-white rounded-xl shadow-lg h-[70vh] flex flex-col">
                        <div class="p-4 border-b flex justify-between items-center">
                            <h2 class="text-xl font-bold text-kesher-green">×¦'××˜ ×¢× ${targetUser.name}</h2>
                            <button onclick="reportItem('${targetUser.id}', 'chat', '${targetUser.id}')" class="bg-red-100 hover:bg-red-200 text-red-700 px-3 py-1 rounded-lg text-sm">âš ï¸ ×“×•×•×—</button>
                        </div>
                        
                        <div id="chatBox" class="flex-grow p-4 overflow-y-auto space-y-3">
                            ${state.chatMessages.length > 0 ? state.chatMessages.map(msg => `
                                <div class="flex ${msg.senderId === state.user.id ? 'justify-end' : 'justify-start'}">
                                    <div class="${msg.senderId === state.user.id ? 'bg-kesher-blue text-white rounded-tr-none' : 'bg-gray-200 text-gray-800 rounded-tl-none'} max-w-xs p-3 rounded-xl shadow-sm">
                                        <p class="text-xs font-bold mb-1">${msg.senderId === state.user.id ? '×× ×™' : targetUser.name}</p>
                                        <p>${msg.content}</p>
                                        <p class="text-right text-[10px] opacity-70 mt-1">${new Date(msg.timestamp.toDate()).toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit' })}</p>
                                    </div>
                                </div>
                            `).join('') : '<p class="text-center text-gray-500 mt-10">×”×ª×—×™×œ×• ×©×™×—×” ×—×“×©×”...</p>'}
                        </div>
                        
                        <div class="p-4 border-t flex gap-2">
                            <input id="chatInput" type="text" placeholder="×›×ª×•×‘ ×”×•×“×¢×”..." class="flex-grow p-3 border rounded-lg" onkeydown="if(event.key === 'Enter') sendMessage()" />
                            <button onclick="sendMessage()" class="bg-kesher-green hover:bg-green-700 text-white px-4 py-2 rounded-lg font-bold">×©×œ×—</button>
                        </div>
                    </div>
                </div>
            `;
        };


        const renderForumList = () => `
            ${getHeader()}
            <div class="max-w-6xl mx-auto px-4">
                <h2 class="text-3xl font-bold text-kesher-blue mb-6">ğŸ’¬ ×¤×•×¨×•××™× ×§×”×™×œ×ª×™×™×</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    ${state.forums.map(f => `
                        <div onclick="goTo('forumPosts', { forumId: '${f.id}' })" class="bg-white p-6 rounded-xl shadow-lg hover:shadow-xl transition cursor-pointer border-r-4 border-kesher-green/50">
                            <div class="flex items-center gap-4 mb-3">
                                <span class="text-5xl">${f.icon}</span>
                                <div>
                                    <h3 class="text-xl font-bold">${f.title}</h3>
                                    <p class="text-gray-600 text-sm">${f.description}</p>
                                </div>
                            </div>
                            <p class="text-sm text-gray-500">${f.posts?.length || 0} ×¤×•×¡×˜×™× ××—×¨×•× ×™×</p>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;

        const renderForumPosts = () => {
            const forum = state.forums.find(f => f.id === state.currentForumId);
            if (!forum) return goTo('forums');

            return `
                ${getHeader()}
                <div class="max-w-6xl mx-auto px-4">
                    <button onclick="goTo('forums')" class="mb-4 text-kesher-blue hover:text-blue-700 font-bold">â† ×—×–×¨×” ×œ×¤×•×¨×•××™×</button>
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-3xl font-bold text-kesher-blue">${forum.icon} ${forum.title}</h2>
                        <button onclick="goTo('newPost')" class="bg-kesher-green hover:bg-green-700 text-white px-4 py-2 rounded-lg font-bold">â• ×¤×•×¡×˜ ×—×“×©</button>
                    </div>

                    <div class="space-y-4">
                        ${forum.posts && forum.posts.length > 0 ? forum.posts.map(post => `
                            <div onclick="goTo('postDetails', { postId: '${post.id}' })" class="bg-white p-5 rounded-xl shadow-md hover:shadow-lg transition cursor-pointer">
                                <h3 class="text-xl font-bold text-kesher-green">${post.title}</h3>
                                <p class="text-gray-700 line-clamp-2 mt-1">${post.content}</p>
                                <div class="flex justify-between items-center text-sm text-gray-500 mt-3">
                                    <span>ğŸ‘¤ ${post.creatorName} â€¢ ${new Date(post.createdAt.toDate()).toLocaleDateString('he-IL')}</span>
                                    <span class="flex gap-3 items-center">
                                        <span>â¤ï¸ ${post.likes?.length || 0}</span>
                                        <span>ğŸ’¬ ${state.currentPostReplies?.filter(r => r.postId === post.id).length || 0}</span>
                                    </span>
                                </div>
                            </div>
                        `).join('') : '<p class="text-center text-xl text-gray-500 p-10">××™×Ÿ ×¢×“×™×™×Ÿ ×¤×•×¡×˜×™× ×‘×¤×•×¨×•× ×–×”. ×”×™×” ×”×¨××©×•×Ÿ ×œ×¤×¨×¡×!</p>'}
                    </div>
                </div>
            `;
        };
        
        const renderPostDetails = () => {
            const post = state.currentPost;
            const replies = state.currentPostReplies || [];
            if (!post) return goTo('forumPosts', { forumId: state.currentForumId });
            
            const isCreatorOrAdmin = post.creatorId === state.user.id || state.user.role === 'admin';
            const isLiked = post.likes?.includes(state.user.id);
            const forum = state.forums.find(f => f.id === post.forumId);

            return `
                ${getHeader()}
                <div class="max-w-4xl mx-auto px-4">
                    <button onclick="goTo('forumPosts', { forumId: '${post.forumId}' })" class="mb-4 text-kesher-blue hover:text-blue-700 font-bold">â† ×—×–×¨×” ×œ×¤×•×¨×•× ${forum.title}</button>

                    <div class="bg-white p-6 rounded-xl shadow-lg mb-6 border-t-4 border-kesher-green">
                        <h2 class="text-3xl font-bold text-kesher-green mb-4">${post.title}</h2>
                        <p class="text-gray-800 text-lg whitespace-pre-wrap">${post.content}</p>
                        <div class="flex justify-between items-center text-sm text-gray-500 mt-5 pt-3 border-t">
                            <span>ğŸ‘¤ ${post.creatorName} â€¢ ${new Date(post.createdAt.toDate()).toLocaleDateString('he-IL')}</span>
                            <div class="flex gap-3">
                                <button onclick="toggleLike('${post.id}')" class="flex items-center gap-1 ${isLiked ? 'text-red-500 font-bold' : 'text-gray-500 hover:text-red-500'}">
                                    â¤ï¸ ${post.likes?.length || 0} ×œ×™×™×§×™×
                                </button>
                                ${isCreatorOrAdmin ? `
                                    <button onclick="editPost('${post.id}', '${post.title.replace(/'/g, "\\'")}', '${post.content.replace(/'/g, "\\'")}')" class="text-blue-500 hover:text-blue-700">âœï¸ ×¢×¨×•×š</button>
                                    <button onclick="deletePost('${post.id}')" class="text-red-500 hover:text-red-700">ğŸ—‘ï¸ ××—×§</button>
                                ` : ''}
                                <button onclick="reportItem('${post.id}', 'post', '${post.creatorId}')" class="text-red-500 hover:text-red-700">âš ï¸ ×“×•×•×—</button>
                            </div>
                        </div>
                    </div>

                    <h3 class="text-2xl font-bold text-kesher-blue mb-4">ğŸ’¬ ×ª×’×•×‘×•×ª (${replies.length})</h3>
                    <div class="space-y-4 mb-8">
                        ${replies.length > 0 ? replies.map(reply => {
                            const isReplyCreatorOrAdmin = reply.creatorId === state.user.id || state.user.role === 'admin';
                            return `
                                <div class="bg-white p-4 rounded-xl shadow-sm border-r-2 border-blue-200">
                                    <div class="flex justify-between items-start">
                                        <p class="font-bold text-kesher-blue">${reply.creatorName}</p>
                                        <div class="text-xs text-gray-500 flex gap-2 items-center">
                                            ${new Date(reply.createdAt.toDate()).toLocaleString('he-IL')}
                                            ${isReplyCreatorOrAdmin ? `<button onclick="deleteReply('${reply.id}')" class="text-red-500 hover:text-red-700 ml-2">ğŸ—‘ï¸</button>` : ''}
                                            <button onclick="reportItem('${reply.id}', 'reply', '${reply.creatorId}')" class="text-red-500 hover:text-red-700">âš ï¸</button>
                                        </div>
                                    </div>
                                    <p class="text-gray-700 mt-1">${reply.content}</p>
                                </div>
                            `;
                        }).join('') : '<p class="text-gray-500">××™×Ÿ ×ª×’×•×‘×•×ª, ×”×•×¡×£ ××ª ×”×¨××©×•× ×”!</p>'}
                    </div>

                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <h3 class="text-xl font-bold text-kesher-green mb-3">×”×•×¡×£ ×ª×’×•×‘×”</h3>
                        <textarea id="replyContent" rows="3" placeholder="×›×ª×•×‘ ××ª ×ª×’×•×‘×ª×š ×›××Ÿ..." class="w-full p-3 border rounded-lg focus:ring-kesher-green"></textarea>
                        <button onclick="addReply()" class="mt-3 bg-kesher-green hover:bg-green-700 text-white px-4 py-2 rounded-lg font-bold">×¤×¨×¡× ×ª×’×•×‘×”</button>
                    </div>
                </div>
            `;
        };
        
        const renderNewPost = () => `
            ${getHeader()}
            <div class="max-w-4xl mx-auto px-4">
                <button onclick="goTo('forumPosts', { forumId: '${state.currentForumId}' })" class="mb-4 text-kesher-blue hover:text-blue-700 font-bold">â† ×—×–×¨×” ×œ×¤×•×¨×•×</button>
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-3xl font-bold text-kesher-green mb-6">â• ×¤×¨×¡×•× ×¤×•×¡×˜ ×—×“×©</h2>
                    <input id="postTitle" type="text" placeholder="×›×•×ª×¨×ª ×”×¤×•×¡×˜" class="w-full p-3 border-2 rounded-lg mb-4 text-lg" />
                    <textarea id="postContent" rows="8" placeholder="×ª×•×›×Ÿ ×”×¤×•×¡×˜ ×”××œ×..." class="w-full p-3 border-2 rounded-lg mb-6"></textarea>
                    <button onclick="createPost()" class="bg-kesher-green hover:bg-green-700 text-white p-3 rounded-lg font-bold w-full">×¤×¨×¡× ×¤×•×¡×˜</button>
                </div>
            </div>
        `;
        
        // ×“×¨×™×©×” 3: ×¤×¢×™×œ×•×™×•×ª
        const renderActivities = () => `
            ${getHeader()}
            <div class="max-w-6xl mx-auto px-4">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold text-kesher-blue">ğŸ—“ï¸ ×¤×¢×™×œ×•×™×•×ª ×§×”×™×œ×ª×™×•×ª</h2>
                    <button onclick="goTo('newActivity')" class="bg-kesher-green hover:bg-green-700 text-white px-4 py-2 rounded-lg font-bold">â• ×¤×¨×¡× ×¤×¢×™×œ×•×ª ×—×“×©×”</button>
                </div>

                <div class="space-y-4">
                    ${state.activities.length > 0 ? state.activities.map(act => {
                        const isRegistered = act.attendees.includes(state.user.id);
                        return `
                            <div class="bg-white p-5 rounded-xl shadow-lg border-l-4 border-kesher-blue/50">
                                <h3 class="text-xl font-bold text-kesher-green mb-2">${act.title}</h3>
                                <p class="text-gray-700 mb-3">${act.description}</p>
                                <div class="text-sm text-gray-600 space-y-1">
                                    <p>ğŸ“… ×ª××¨×™×š: ${act.date}</p>
                                    <p>ğŸ“ ××™×§×•×: ${act.location}</p>
                                    <p>ğŸ‘¥ ××©×ª×ª×¤×™×: ${act.attendees.length}</p>
                                </div>
                                <div class="flex justify-between items-center mt-4 pt-3 border-t">
                                    <p class="text-xs text-gray-500">×¤×•×¨×¡× ×¢"×™: ${act.creatorName}</p>
                                    <button onclick="${isRegistered ? `alert('××ª×” ×›×‘×¨ ×¨×©×•× ×œ×¤×¢×™×œ×•×ª ×–×•.')` : `registerForActivity('${act.id}')`}" class="text-white px-4 py-2 rounded-lg font-bold text-sm ${isRegistered ? 'bg-gray-400 cursor-not-allowed' : 'bg-kesher-blue hover:bg-blue-700'}">
                                        ${isRegistered ? 'âœ… ×¨×©×•×' : '×”×¨×©××”'}
                                    </button>
                                </div>
                            </div>
                        `;
                    }).join('') : '<p class="text-center text-xl text-gray-500 p-10">××™×Ÿ ×¤×¢×™×œ×•×™×•×ª ×¤×•×¨×¡××• ×¢×“×™×™×Ÿ.</p>'}
                </div>
            </div>
        `;

        const renderNewActivity = () => `
            ${getHeader()}
            <div class="max-w-4xl mx-auto px-4">
                <button onclick="goTo('activities')" class="mb-4 text-kesher-blue hover:text-blue-700 font-bold">â† ×—×–×¨×” ×œ×¤×¢×™×œ×•×™×•×ª</button>
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-3xl font-bold text-kesher-green mb-6">â• ×¤×¨×¡×•× ×¤×¢×™×œ×•×ª ×—×“×©×”</h2>
                    <input id="activityTitle" type="text" placeholder="×©× ×”×¤×¢×™×œ×•×ª (×›×’×•×Ÿ: ××¤×’×© ×‘×™×©×•×œ)" class="w-full p-3 border-2 rounded-lg mb-4 text-lg" />
                    <textarea id="activityDescription" rows="5" placeholder="×ª×™××•×¨ ××œ× ×©×œ ×”×¤×¢×™×œ×•×ª..." class="w-full p-3 border-2 rounded-lg mb-4"></textarea>
                    <input id="activityDate" type="text" placeholder="×ª××¨×™×š ×•×©×¢×” (×œ×“×•×’××”: 20/12/2025 ×‘-18:00)" class="w-full p-3 border-2 rounded-lg mb-4" />
                    <input id="activityLocation" type="text" placeholder="××™×§×•× (×¤×™×–×™ ××• ××§×•×•×Ÿ, ×œ×“×•×’××”: ×§×¤×” ×’×œ, ×ª"×)" class="w-full p-3 border-2 rounded-lg mb-6" />
                    <button onclick="createActivity()" class="bg-kesher-green hover:bg-green-700 text-white p-3 rounded-lg font-bold w-full">×¤×¨×¡× ×¤×¢×™×œ×•×ª</button>
                </div>
            </div>
        `;

        // ×“×¨×™×©×” 5: ××¡×š × ×™×”×•×œ ××•×¨×—×‘
        const renderAdmin = () => `
            ${getHeader()}
            <div class="max-w-6xl mx-auto px-4">
                <h2 class="text-3xl font-bold text-red-700 mb-6">âš™ï¸ ×œ×•×— ×‘×§×¨×” ×œ×× ×”×œ</h2>
                
                <div class="bg-white p-6 rounded-xl shadow-lg mb-6">
                    <h3 class="text-xl font-bold mb-4 border-b pb-2">ğŸ‘¥ × ×™×”×•×œ ××©×ª××©×™× (${state.users.length})</h3>
                    <div class="space-y-3 max-h-96 overflow-y-auto">
                        ${state.users.map(u => `
                            <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                                <div class="flex-grow">
                                    <p class="font-bold">${u.name}</p>
                                    <p class="text-sm text-gray-600">${u.email} â€¢ ${u.city}</p>
                                </div>
                                <div class="flex gap-2 items-center text-sm">
                                    <span class="px-3 py-1 rounded-full ${u.role === 'admin' ? 'bg-amber-200 text-amber-900' : 'bg-blue-200 text-blue-900'}">
                                        ${u.role === 'admin' ? '×× ×”×œ' : '××©×ª××©'}
                                    </span>
                                    ${u.id !== state.user.id ? `
                                        ${u.role === 'user' ? `<button onclick="changeRole('${u.id}','admin')" class="bg-amber-500 text-white px-3 py-1 rounded">â†‘ ×× ×”×œ</button>` : `<button onclick="changeRole('${u.id}','user')" class="bg-gray-500 text-white px-3 py-1 rounded">â†“ ××©×ª××©</button>`}
                                        <button onclick="deleteUser('${u.id}')" class="bg-red-500 text-white px-3 py-1 rounded">××—×§</button>
                                    ` : ''}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>

                <div class="bg-white p-6 rounded-xl shadow-lg mb-6">
                    <div class="flex justify-between items-center mb-4 border-b pb-2">
                        <h3 class="text-xl font-bold">ğŸ’¬ × ×™×”×•×œ ×¤×•×¨×•××™× (${state.forums.length})</h3>
                        <button onclick="addForum()" class="bg-kesher-green hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm font-bold">â• ×”×•×¡×£ ×¤×•×¨×•×</button>
                    </div>
                    <div class="space-y-3 max-h-96 overflow-y-auto">
                         ${state.forums.map(f => `
                            <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                                <div class="flex-grow">
                                    <p class="font-bold">${f.icon} ${f.title}</p>
                                    <p class="text-sm text-gray-600">${f.description}</p>
                                </div>
                                <div class="flex gap-2 items-center text-sm">
                                    <button onclick="editForum({id: '${f.id}', title: '${f.title.replace(/'/g, "\\'")}', description: '${f.description.replace(/'/g, "\\'")}', icon: '${f.icon}'})" class="bg-blue-500 text-white px-3 py-1 rounded">âœï¸ ×¢×¨×•×š</button>
                                    <button onclick="deleteForum('${f.id}')" class="bg-red-500 text-white px-3 py-1 rounded">ğŸ—‘ï¸ ××—×§</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>

                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h3 class="text-xl font-bold mb-4 border-b pb-2">âš ï¸ ××¨×›×– ×“×™×•×•×—×™× (${state.reports.length})</h3>
                    <div class="space-y-3 max-h-96 overflow-y-auto">
                        ${state.reports.length > 0 ? state.reports.map(r => `
                            <div class="p-3 rounded-lg shadow-sm border ${r.status === '×—×“×©' ? 'border-red-400 bg-red-50' : r.status === '×‘×˜×™×¤×•×œ' ? 'border-amber-400 bg-amber-50' : 'border-green-400 bg-green-50'}">
                                <p class="font-bold text-red-700">×“×™×•×•×—: ${r.reportType} (${r.status})</p>
                                <p class="text-sm text-gray-700">×¢×œ ×¤×¨×™×˜: **${r.itemType}** (ID: ${r.itemId})</p>
                                <p class="text-sm text-gray-700">×¡×™×‘×”: ${r.reason}</p>
                                <p class="text-xs text-gray-500 mt-1">×“×•×•×— ×¢"×™: ${r.reporterName} â€¢ ${new Date(r.createdAt.toDate()).toLocaleString('he-IL')}</p>
                                <div class="mt-2 flex gap-2 text-xs">
                                    ${r.status !== '×‘×˜×™×¤×•×œ' ? `<button onclick="updateReportStatus('${r.id}', '×‘×˜×™×¤×•×œ')" class="bg-amber-500 text-white px-2 py-1 rounded">×‘×˜×™×¤×•×œ</button>` : ''}
                                    ${r.status !== '×˜×•×¤×œ' ? `<button onclick="updateReportStatus('${r.id}', '×˜×•×¤×œ')" class="bg-green-600 text-white px-2 py-1 rounded">×˜×•×¤×œ</button>` : ''}
                                    <button onclick="updateReportStatus('${r.id}', '× ×“×—×”')" class="bg-gray-500 text-white px-2 py-1 rounded">× ×“×—×”</button>
                                </div>
                            </div>
                        `).join('') : '<p class="text-center text-gray-500 p-4">××™×Ÿ ×“×™×•×•×—×™× ×—×“×©×™×.</p>'}
                    </div>
                </div>
            </div>
        `;

        // --- Render Switch ---
        function render() {
            const root = document.getElementById('root');
            if (!state.user && state.screen !== 'register') {
                state.screen = 'login';
            }
            
            switch (state.screen) {
                case 'login':
                    root.innerHTML = renderLogin();
                    break;
                case 'register':
                    root.innerHTML = renderRegister();
                    break;
                case 'home':
                    // ×”×•×¡×¤×ª ×§×•×“ ×œ×‘×™×ª
                    root.innerHTML = getHeader() + `
                        <div class="max-w-6xl mx-auto px-4">
                            <div class="bg-white p-8 rounded-xl shadow-lg text-center">
                                <h2 class="text-3xl font-bold text-kesher-green mb-4">×‘×¨×•×š ×”×‘× ${state.user.name}! ğŸ‘‹</h2>
                                <p class="text-lg text-gray-600 mb-6">××¦× ×—×‘×¨×™×, ×ª×¨×•× ×œ×™×“×¢ ×©×œ×š ×•×”×©×ª×ª×£ ×‘×¤×¢×™×œ×•×™×•×ª!</p>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-6">
                                    <div onclick="goTo('users')" class="bg-blue-50 p-6 rounded-xl hover:shadow-md cursor-pointer">
                                        <p class="text-4xl font-bold text-blue-700">ğŸ‘¥</p>
                                        <p class="text-gray-600 mt-2">××¦×™××ª ×—×‘×¨×™× ×•×¦'××˜</p>
                                    </div>
                                    <div onclick="goTo('forums')" class="bg-green-50 p-6 rounded-xl hover:shadow-md cursor-pointer">
                                        <p class="text-4xl font-bold text-green-700">ğŸ’¬</p>
                                        <p class="text-gray-600 mt-2">×”×¦×˜×¨×¤×•×ª ×œ×¤×•×¨×•××™×</p>
                                    </div>
                                    <div onclick="goTo('activities')" class="bg-amber-50 p-6 rounded-xl hover:shadow-md cursor-pointer">
                                        <p class="text-4xl font-bold text-amber-700">ğŸ—“ï¸</p>
                                        <p class="text-gray-600 mt-2">×¤×¨×¡×•× ×•×”×¨×©××” ×œ×¤×¢×™×œ×•×™×•×ª</p>
                                    </div>
                                </div>
                                <div class="mt-8 pt-4 border-t text-sm text-gray-500">
                                    <p>×”×ª×—×‘×™×‘×™× ×©×œ×™: **${state.user.hobbies?.join(', ') || '×œ× ×”×•×’×“×¨'}**</p>
                                    <p>×× ×™ ×™×›×•×œ ×œ×ª×¨×•× ×‘: **${state.user.contributions?.join(', ') || '×œ× ×”×•×’×“×¨'}**</p>
                                </div>
                            </div>
                        </div>
                    `;
                    break;
                case 'users':
                    root.innerHTML = renderUsers();
                    break;
                case 'chat':
                    root.innerHTML = renderChat();
                    break;
                case 'forums':
                    root.innerHTML = renderForumList();
                    break;
                case 'forumPosts':
                    root.innerHTML = renderForumPosts();
                    break;
                case 'postDetails':
                    root.innerHTML = renderPostDetails();
                    break;
                case 'newPost':
                    root.innerHTML = renderNewPost();
                    break;
                case 'activities':
                    root.innerHTML = renderActivities();
                    break;
                case 'newActivity':
                    root.innerHTML = renderNewActivity();
                    break;
                case 'admin':
                    root.innerHTML = renderAdmin();
                    break;
                default:
                    root.innerHTML = `<p class="text-center p-20">×©×’×™××” ××• ××¡×š ×œ× ××•×›×¨.</p>`;
            }
        }

        // --- Expose functions to global scope ---
        window.doLogin = async () => { /* ... (×¤×•× ×§×¦×™×” ×§×™×™××ª ×‘×§×•×“ ×”××§×•×¨×™) ... */ };
        window.doRegister = doRegister;
        window.doLogout = async () => { await auth.signOut(); }; // ×©×™××•×© ×‘-async/await
        window.doResetPassword = doResetPassword;
        window.goTo = goTo;
        window.changeRole = async (userId, newRole) => { 
            await db.collection('users').doc(userId).update({role: newRole});
            alert('âœ… ×¢×•×“×›×Ÿ!');
            await loadData();
        };
        window.deleteUser = async (userId) => { 
            if (!confirm('×œ××—×•×§?')) return;
            await db.collection('users').doc(userId).delete();
            alert('âœ… × ××—×§');
            await loadData();
        };
        // ×¤×•×¨×•××™×
        window.createPost = createPost;
        window.addReply = addReply;
        window.toggleLike = toggleLike;
        window.deletePost = deletePost;
        window.editPost = editPost;
        window.deleteReply = deleteReply;
        // ×¦'××˜
        window.openChat = openChat;
        window.sendMessage = sendMessage;
        window.applyUserFilters = applyUserFilters;
        // ×¤×¢×™×œ×•×™×•×ª
        window.createActivity = createActivity;
        window.registerForActivity = registerForActivity;
        // ××“××™×Ÿ
        window.addForum = addForum;
        window.editForum = editForum;
        window.deleteForum = deleteForum;
        window.reportItem = reportItem;
        window.updateReportStatus = updateReportStatus;

        // ×”×ª×—×œ×ª ×¨×™× ×“×•×¨
        render();
    </script>
</body>
</html>
