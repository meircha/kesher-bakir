<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>קהילת קשר — קהילה תומכת 60+</title>

  <!-- Tailwind CDN (לנוחות; אפשר להחליף בעת פרודקשן) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

  <style>
    :root{
      --primary:#2B6CB0;
      --accent:#38B2AC;
      --bg:#F7FAFC;
      --card:#FFFFFF;
      --muted:#4A5568;
    }
    html,body { height:100%; }
    body{ background:var(--bg); font-family: "Segoe UI", Roboto, Arial, sans-serif; color:#1a202c; -webkit-font-smoothing:antialiased; margin:0; padding:0; }
    .card{ background:var(--card); border-radius:12px; box-shadow:0 6px 20px rgba(0,0,0,0.06); }
    .btn-primary{ background:var(--accent); color:white; }
    .btn-sec{ background:var(--primary); color:white; }
    .pill{ padding:.5rem .9rem; border-radius:9999px; font-size:.8rem; font-weight:600; }
    .link-subtle { color: var(--primary); text-decoration: none; border-bottom: 1px dashed var(--primary); cursor: pointer; }
    .link-subtle:hover { border-bottom: 1px solid var(--primary); }
    .input-field { padding: 0.75rem; border: 1px solid #E2E8F0; border-radius: 8px; width: 100%; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
    .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; font-size: 0.9rem; color: var(--muted); }
    .chat-bubble { max-width: 80%; padding: 0.75rem 1rem; border-radius: 18px; margin-bottom: 0.5rem; word-wrap: break-word; }
    .chat-self { background-color: var(--primary); color: white; border-bottom-left-radius: 2px; }
    .chat-other { background-color: #E2E8F0; color: #333; border-bottom-right-radius: 2px; }
    /* מותאם לכפתורים עגולים (כפתור הוספת פוסט) */
    .btn-floating { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
  </style>
</head>
<body class="flex flex-col min-h-screen">

  <main id="app-container" class="flex-grow">
    <!-- תוכן האפליקציה יושתל כאן -->
  </main>

  <div id="modal-container">
    <!-- Modal content will be rendered here -->
  </div>

<script type="module">
    // ==========================================================
    // --- 1. הגדרות וייבוא Firebase (ES Modules) ---
    // ==========================================================

    import { initializeApp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged, signOut, updateProfile, createUserWithEmailAndPassword, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, query, where, addDoc, updateDoc, deleteDoc, arrayRemove, arrayUnion, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    setLogLevel('debug'); // הגדרת רמת לוגים לצורך דיבאג

    // משתנים גלובליים המסופקים על ידי המערכת (חובה)
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
    
    // אתחול Firebase ושמירה במשתני Window גלובליים
    window.app = initializeApp(firebaseConfig);
    window.db = getFirestore(window.app);
    window.auth = getAuth(window.app);

    // ==========================================================
    // --- 2. ניהול מצב גלובלי (State Management) ---
    // ==========================================================

    const state = {
        screen: 'loading', // 'loading', 'login', 'register', 'home', 'forum', 'chat'
        user: null, // אובייקט המשתמש הנוכחי מ-Firestore
        profile: null, // פרופיל המשתמש
        posts: [], // פוסטים בפורום
        currentPost: null, // הפוסט שנבחר לצ'אט
        postMessages: [], // הודעות הצ'אט של הפוסט הנוכחי
        usersOnline: {}, // מילון של משתמשים מחוברים
        searchTerm: '' // מונח חיפוש עבור הפורום
    };

    const listeners = []; // רשימת פונקציות ה-onSnapshot לניקוי

    /**
     * פונקציה כללית לשינוי מצב המסך ולרנדור מחדש.
     * @param {string} newScreen - שם המסך החדש.
     */
    function goTo(newScreen) {
        state.screen = newScreen;
        render();
    }

    // ==========================================================
    // --- 3. פונקציות עזר ל-Firestore ---
    // ==========================================================

    /**
     * יצירת הנתיב למסמך פרטי של משתמש (תחת /artifacts/{appId}/users/{userId}/...).
     * @param {string} collectionName - שם האוסף (לדוגמה: 'profile').
     * @returns {string} הנתיב המלא.
     */
    function getUserDocPath(collectionName) {
        const userId = window.auth.currentUser?.uid || 'anonymous';
        return `artifacts/${appId}/users/${userId}/${collectionName}/main`;
    }

    /**
     * יצירת הנתיב לאוסף ציבורי (תחת /artifacts/{appId}/public/data/{collectionName}).
     * @param {string} collectionName - שם האוסף (לדוגמה: 'posts').
     * @returns {string} הנתיב המלא.
     */
    function getPublicCollectionPath(collectionName) {
        return `artifacts/${appId}/public/data/${collectionName}`;
    }

    /**
     * ניקוי כל המאזינים הפעילים ל-Firestore.
     */
    function cleanupListeners() {
        listeners.forEach(unsubscribe => unsubscribe());
        listeners.length = 0; // מנקה את המערך
    }


    /**
     * קריאת המשתמש הנוכחי מ-Firestore.
     * @returns {Promise<object|null>} נתוני הפרופיל.
     */
    async function fetchUserProfile() {
        const userId = window.auth.currentUser?.uid;
        if (!userId) return null;

        const profilePath = getUserDocPath('profile');
        const profileRef = doc(window.db, profilePath);
        
        try {
            const docSnap = await getDoc(profileRef);
            if (docSnap.exists()) {
                return { id: docSnap.id, ...docSnap.data(), uid: userId };
            }
            return null; // פרופיל לא קיים
        } catch (error) {
            console.error("שגיאה באחזור פרופיל משתמש:", error);
            return null;
        }
    }
    
    /**
     * הפעלת מאזינים לנתונים הציבוריים לאחר אתחול מוצלח.
     */
    function setupPublicListeners() {
        cleanupListeners(); // ודא שאין מאזינים קודמים

        // --- מאזין לפוסטים בפורום ---
        const postsCollection = collection(window.db, getPublicCollectionPath('posts'));
        const qPosts = query(postsCollection, where('isDeleted', '==', false)); // רק פוסטים שאינם מחוקים

        const unsubscribePosts = onSnapshot(qPosts, (snapshot) => {
            const posts = snapshot.docs.map(doc => ({ 
                id: doc.id, 
                ...doc.data(),
                // המרת Timestamp לאובייקט Date
                timestamp: doc.data().timestamp?.toDate ? doc.data().timestamp.toDate() : new Date(doc.data().timestamp)
            }));
            
            // מיון: הכי חדש למעלה
            posts.sort((a, b) => b.timestamp.getTime() - a.timestamp.getTime());

            state.posts = posts;
            
            // עדכון הפוסט הנוכחי אם קיים, כדי לשקף שינויים (כגון מחיקה)
            if (state.currentPost && !posts.some(p => p.id === state.currentPost.id)) {
                // הפוסט הנוכחי נמחק, חוזרים לפורום
                state.currentPost = null;
                goTo('forum');
            } else if (state.screen === 'forum' || (state.screen === 'chat' && state.currentPost)) {
                render();
            }
        }, (error) => {
            console.error("שגיאה במאזין פוסטים:", error);
        });
        listeners.push(unsubscribePosts);

        // --- מאזין להודעות צ'אט (אם יש פוסט פתוח) ---
        if (state.currentPost) {
            const messagesCollection = collection(window.db, getPublicCollectionPath(`posts/${state.currentPost.id}/messages`));
            const qMessages = query(messagesCollection); // אין צורך ב-where

            const unsubscribeMessages = onSnapshot(qMessages, (snapshot) => {
                const messages = snapshot.docs.map(doc => ({ 
                    id: doc.id, 
                    ...doc.data(),
                    // המרת Timestamp לאובייקט Date
                    timestamp: doc.data().timestamp?.toDate ? doc.data().timestamp.toDate() : new Date(doc.data().timestamp)
                }));
                
                // מיון: הכי ישן למעלה
                messages.sort((a, b) => a.timestamp.getTime() - b.timestamp.getTime());

                state.postMessages = messages;
                if (state.screen === 'chat') render();
            }, (error) => {
                console.error("שגיאה במאזין הודעות:", error);
            });
            listeners.push(unsubscribeMessages);
        }
    }


    // ==========================================================
    // --- 4. לוגיקת רינדור (Rendering Logic) ---
    // ==========================================================
    
    /**
     * מרנדר את התוכן של המסך הנוכחי.
     */
    function render() {
        const container = document.getElementById('app-container');
        if (!container) return;

        let content = '';
        switch (state.screen) {
            case 'loading':
                content = renderLoading();
                break;
            case 'login':
                content = renderLogin();
                break;
            case 'register':
                content = renderRegister();
                break;
            case 'home':
                content = renderHome();
                break;
            case 'forum':
                content = renderForum();
                break;
            case 'chat':
                content = renderChat();
                break;
            default:
                content = `<div class="p-8 text-center text-red-500">שגיאה: מסך לא ידוע (${state.screen})</div>`;
        }

        container.innerHTML = renderLayout(content);
        
        // ודא שכל ה-Event Listeners מחוברים מחדש לאחר הרנדור
        attachEventListeners();

        // גלילה אוטומטית למטה בצ'אט
        if (state.screen === 'chat') {
            const chatBox = document.getElementById('chat-messages');
            if (chatBox) {
                chatBox.scrollTop = chatBox.scrollHeight;
            }
        }
    }

    /**
     * עוטף את תוכן המסך בראש עמוד (Header) ופוטר (Footer) אם נדרש.
     * @param {string} content - תוכן המסך.
     * @returns {string} ה-HTML המלא.
     */
    function renderLayout(content) {
        if (['login', 'register'].includes(state.screen)) {
            return content;
        }

        const navLinks = [
            { id: 'home', icon: 'fa-home', label: 'בית', screen: 'home' },
            { id: 'forum', icon: 'fa-comments', label: 'פורום', screen: 'forum' },
            { id: 'profile', icon: 'fa-user', label: state.profile?.name || 'אורח', screen: 'profile' } // 'profile' screen is not implemented yet
        ];

        return `
            ${renderHeader(navLinks)}
            <div class="flex-grow p-4 md:p-8 pt-20 max-w-7xl mx-auto w-full">
                ${content}
            </div>
            ${renderFooter(navLinks)}
        `;
    }

    /**
     * רנדור כותרת עליונה (Header).
     * @param {Array<object>} navLinks - קישורי הניווט.
     * @returns {string} HTML של הכותרת.
     */
    function renderHeader(navLinks) {
        const currentScreen = state.screen === 'chat' ? 'forum' : state.screen; // בצ'אט, מדגישים את 'פורום'
        
        return `
            <header class="fixed top-0 left-0 right-0 bg-white shadow-md z-50">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3 flex justify-between items-center">
                    <div class="flex items-center space-x-4 space-x-reverse">
                        <h1 class="text-xl font-bold text-gray-800">קהילת קשר</h1>
                    </div>
                    <nav class="hidden md:flex space-x-6 space-x-reverse">
                        ${navLinks.map(link => `
                            <button data-action="goTo" data-screen="${link.screen}"
                                class="text-sm font-medium transition duration-150 ease-in-out 
                                ${currentScreen === link.screen ? 'text-blue-600 border-b-2 border-blue-600' : 'text-gray-500 hover:text-blue-600'}">
                                <i class="fa ${link.icon} ml-1"></i> ${link.label}
                            </button>
                        `).join('')}
                    </nav>
                    <div class="flex items-center space-x-4 space-x-reverse">
                        <button data-action="showRules" class="text-gray-500 hover:text-blue-600 text-sm">
                            <i class="fa fa-book-open ml-1"></i> תקנון
                        </button>
                        <button data-action="logout" class="text-red-500 hover:text-red-700 text-sm">
                            <i class="fa fa-sign-out-alt ml-1"></i> יציאה
                        </button>
                    </div>
                </div>
            </header>
        `;
    }

    /**
     * רנדור סרגל ניווט תחתון (Footer) למובייל.
     * @param {Array<object>} navLinks - קישורי הניווט.
     * @returns {string} HTML של הפוטר.
     */
    function renderFooter(navLinks) {
        const currentScreen = state.screen === 'chat' ? 'forum' : state.screen;

        return `
            <footer class="md:hidden fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 z-50 shadow-lg">
                <nav class="flex justify-around items-center h-14">
                    ${navLinks.map(link => `
                        <button data-action="goTo" data-screen="${link.screen}"
                            class="flex flex-col items-center justify-center w-full h-full text-xs font-medium transition duration-150 ease-in-out 
                            ${currentScreen === link.screen ? 'text-blue-600' : 'text-gray-500 hover:text-blue-600'}">
                            <i class="fa ${link.icon} text-lg mb-1"></i>
                            ${link.label}
                        </button>
                    `).join('')}
                </nav>
            </footer>
        `;
    }


    // ==========================================================
    // --- 5. רנדור מסכים ספציפיים ---
    // ==========================================================

    /**
     * רנדור מסך טעינה.
     */
    function renderLoading() {
        return `
            <div class="flex items-center justify-center h-screen bg-white">
                <div class="text-center">
                    <i class="fa fa-spinner fa-spin text-4xl text-blue-500"></i>
                    <p class="mt-4 text-gray-600">טוען את קהילת קשר...</p>
                </div>
            </div>
        `;
    }

    /**
     * רנדור מסך כניסה (Login).
     */
    function renderLogin() {
        // ... (התוכן של renderLogin)
        return `
            <div class="flex items-center justify-center min-h-screen bg-gray-50 p-4">
                <div class="w-full max-w-md card p-8">
                    <div class="text-center mb-6">
                        <h2 class="text-3xl font-bold text-gray-900 mb-2">ברוך שובך לקהילת קשר</h2>
                        <p class="text-sm text-gray-600">מקום חם לשיתוף וקבלת עזרה</p>
                    </div>
                    <form id="loginForm">
                        <div class="form-group mb-4">
                            <label for="loginEmail">דוא"ל</label>
                            <input type="email" id="loginEmail" name="email" placeholder="הכנס אימייל" class="input-field" required>
                        </div>
                        <div class="form-group mb-6">
                            <label for="loginPassword">סיסמה</label>
                            <input type="password" id="loginPassword" name="password" placeholder="הכנס סיסמה" class="input-field" required>
                        </div>
                        <button type="submit" class="w-full py-3 btn-sec font-semibold rounded-lg shadow-md hover:opacity-90 transition duration-150">
                            כניסה
                        </button>
                    </form>
                    <div class="mt-6 text-center text-sm">
                        <p class="text-gray-600">עדיין לא חבר?</p>
                        <button data-action="goTo" data-screen="register" class="link-subtle mt-1">
                            הרשמה מהירה!
                        </button>
                        <p id="loginError" class="text-red-500 mt-3 hidden text-sm font-medium">שגיאה: פרטי כניסה שגויים או משתמש לא קיים.</p>
                    </div>
                </div>
            </div>
        `;
    }

    /**
     * רנדור מסך הרשמה (Register).
     */
    function renderRegister() {
        // ... (התוכן של renderRegister)
        return `
            <div class="flex items-center justify-center min-h-screen bg-gray-50 p-4">
                <div class="w-full max-w-md card p-8">
                    <div class="text-center mb-6">
                        <h2 class="text-3xl font-bold text-gray-900 mb-2">הרשמה לקהילת קשר</h2>
                        <p class="text-sm text-gray-600">בואו נכיר אתכם קצת יותר</p>
                    </div>
                    <form id="registerForm">
                        <div class="form-group mb-4">
                            <label for="registerName">שם פרטי (יופיע בקהילה)</label>
                            <input type="text" id="registerName" name="name" placeholder="הכנס שם" class="input-field" required>
                        </div>
                        <div class="form-group mb-4">
                            <label for="registerEmail">דוא"ל</label>
                            <input type="email" id="registerEmail" name="email" placeholder="הכנס אימייל" class="input-field" required>
                        </div>
                        <div class="form-group mb-6">
                            <label for="registerPassword">סיסמה (לפחות 6 תווים)</label>
                            <input type="password" id="registerPassword" name="password" placeholder="הכנס סיסמה" class="input-field" required minlength="6">
                        </div>
                        
                        <div class="mb-4">
                            <input type="checkbox" id="agreeRules" required class="ml-2">
                            <label for="agreeRules" class="text-sm text-gray-600">
                                אני מאשר/ת את <button type="button" data-action="showRules" class="link-subtle">תקנון הקהילה</button>
                            </label>
                        </div>

                        <button type="submit" class="w-full py-3 btn-primary font-semibold rounded-lg shadow-md hover:opacity-90 transition duration-150">
                            הרשמה ואישור
                        </button>
                    </form>
                    <div class="mt-6 text-center text-sm">
                        <p class="text-gray-600">יש לך כבר חשבון?</p>
                        <button data-action="goTo" data-screen="login" class="link-subtle mt-1">
                            חזרה לכניסה
                        </button>
                        <p id="registerError" class="text-red-500 mt-3 hidden text-sm font-medium">שגיאה: האימייל כבר בשימוש או בעיה אחרת.</p>
                    </div>
                </div>
            </div>
        `;
    }

    /**
     * רנדור מסך הבית (Home) - מסך פתיחה פשוט.
     */
    function renderHome() {
        // ... (התוכן של renderHome)
        const name = state.profile?.name || 'חבר קהילה';
        return `
            <div class="max-w-4xl mx-auto py-8">
                <div class="card p-6 mb-8 text-center bg-white border-b-4 border-accent">
                    <h2 class="text-3xl font-extrabold text-gray-800">שלום, ${name}!</h2>
                    <p class="text-gray-600 mt-2">כאן מתחיל החיבור. בחר נושא לדיון או הצטרף לשיחה קיימת בפורום.</p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- קארד 1: פורום הקהילה -->
                    <div class="card p-6 flex flex-col items-center text-center hover:shadow-xl transition duration-300 cursor-pointer" data-action="goTo" data-screen="forum">
                        <i class="fa fa-comments text-4xl text-accent mb-4"></i>
                        <h3 class="text-xl font-semibold mb-2">פורום תמיכה פעיל</h3>
                        <p class="text-sm text-gray-500">הצטרף לדיונים, שאל שאלות וקבל עזרה מקהילת החברים.</p>
                        <div class="mt-4 py-2 px-4 btn-primary rounded-full text-xs font-bold">כניסה לפורום</div>
                    </div>

                    <!-- קארד 2: מרכז עזרה והדרכה (פוטנציאלי) -->
                    <div class="card p-6 flex flex-col items-center text-center opacity-70">
                        <i class="fa fa-lightbulb text-4xl text-blue-400 mb-4"></i>
                        <h3 class="text-xl font-semibold mb-2">טיפים ומידע</h3>
                        <p class="text-sm text-gray-500">טיפים לחיים, בריאות וטכנולוגיה (בקרוב!)</p>
                        <div class="mt-4 py-2 px-4 bg-gray-300 text-gray-700 rounded-full text-xs font-bold">בקרוב</div>
                    </div>

                    <!-- קארד 3: שיתוף רגעים (פוטנציאלי) -->
                    <div class="card p-6 flex flex-col items-center text-center opacity-70">
                        <i class="fa fa-camera-retro text-4xl text-red-400 mb-4"></i>
                        <h3 class="text-xl font-semibold mb-2">אלבום קהילתי</h3>
                        <p class="text-sm text-gray-500">שתף רגעים יפים מהחיים עם חברי הקהילה (בקרוב!)</p>
                        <div class="mt-4 py-2 px-4 bg-gray-300 text-gray-700 rounded-full text-xs font-bold">בקרוב</div>
                    </div>
                </div>
                
                <div class="mt-8 text-center text-sm text-gray-500">
                    <p>מזהה משתמש: ${state.profile?.uid}</p>
                    <p>השתמש במזהה זה כדי שאחרים יוכלו לאתר אותך.</p>
                </div>
            </div>
        `;
    }

    /**
     * רנדור מסך הפורום (Forum).
     */
    function renderForum() {
        // ... (התוכן של renderForum)
        const posts = state.posts.filter(post => 
            !state.searchTerm || post.title.toLowerCase().includes(state.searchTerm.toLowerCase()) || post.content.toLowerCase().includes(state.searchTerm.toLowerCase())
        );

        return `
            <div class="max-w-4xl mx-auto">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4 md:mb-0">פורום הקהילה: שיתוף, ייעוץ ותמיכה</h2>
                    <div class="flex w-full md:w-auto space-x-2 space-x-reverse">
                        <input type="text" id="forumSearch" placeholder="חיפוש נושאים..." class="input-field w-full md:w-64" value="${state.searchTerm}">
                        <button data-action="showNewPostModal" class="flex-shrink-0 py-2 px-4 btn-primary rounded-lg shadow-md hover:opacity-90 transition duration-150">
                            <i class="fa fa-plus ml-1"></i> פוסט חדש
                        </button>
                    </div>
                </div>

                <div id="postsList">
                    ${posts.length > 0 ? posts.map(post => `
                        <div class="card p-4 mb-4 hover:shadow-lg transition duration-300 cursor-pointer" data-post-id="${post.id}" data-action="openPostChat">
                            <div class="flex justify-between items-start">
                                <h3 class="text-xl font-bold text-primary mb-1">${post.title}</h3>
                                ${post.authorId === state.profile.uid ? `
                                    <button data-action="showEditPostModal" data-post-id="${post.id}" class="text-gray-400 hover:text-accent p-1 text-sm">
                                        <i class="fa fa-edit"></i>
                                    </button>
                                ` : ''}
                            </div>
                            <p class="text-gray-700 text-sm mb-2">${post.content.substring(0, 150)}${post.content.length > 150 ? '...' : ''}</p>
                            <div class="flex justify-between items-end text-xs text-gray-500 mt-2">
                                <p>נפתח על ידי: 
                                    <span class="font-semibold text-primary">${post.authorName}</span>
                                    ${post.authorId === state.profile.uid ? '<span class="pill bg-yellow-100 text-yellow-800 mr-2">אני</span>' : ''}
                                </p>
                                <p>נפתח בתאריך: ${new Date(post.timestamp).toLocaleDateString('he-IL')}</p>
                            </div>
                        </div>
                    `).join('') : `
                        <div class="card p-8 text-center text-gray-500">
                            <i class="fa fa-search text-3xl mb-3"></i>
                            <p class="text-lg">לא נמצאו פוסטים תואמים לחיפוש.</p>
                            <p class="text-sm mt-1">נסה מונח אחר או פתח פוסט חדש!</p>
                        </div>
                    `}
                </div>
            </div>
            ${renderModal('newPostModal', renderNewPostModalContent())}
            ${renderModal('editPostModal', renderEditPostModalContent())}
        `;
    }

    /**
     * רנדור מסך הצ'אט (Chat).
     */
    function renderChat() {
        // ... (התוכן של renderChat)
        if (!state.currentPost) {
            return `<div class="p-8 text-center text-red-500">שגיאה: פוסט לא נבחר.</div>`;
        }
        
        const post = state.currentPost;

        return `
            <div class="max-w-4xl mx-auto flex flex-col h-full md:h-[calc(100vh-100px)]">
                <!-- כותרת הפוסט -->
                <div class="card p-4 mb-4 flex justify-between items-center border-b-4 border-accent">
                    <div>
                        <button data-action="goTo" data-screen="forum" class="text-primary hover:text-blue-700 text-sm mr-2">
                            <i class="fa fa-arrow-right ml-2"></i> חזרה לפורום
                        </button>
                        <h2 class="text-xl font-bold text-gray-800">${post.title}</h2>
                        <p class="text-sm text-gray-500 mt-1">נפתח ע"י ${post.authorName} | UID: ${post.authorId}</p>
                    </div>
                    ${post.authorId === state.profile.uid ? `
                        <button data-action="confirmDeletePost" data-post-id="${post.id}" class="text-red-500 hover:text-red-700 p-1 text-sm">
                            <i class="fa fa-trash-alt ml-1"></i> מחק פוסט
                        </button>
                    ` : ''}
                </div>

                <!-- חלון הודעות -->
                <div id="chat-messages" class="flex-grow overflow-y-auto p-4 mb-4 space-y-3 card">
                    ${state.postMessages.length > 0 ? state.postMessages.map(msg => {
                        const isSelf = msg.authorId === state.profile.uid;
                        return `
                            <div class="flex ${isSelf ? 'justify-end' : 'justify-start'}">
                                <div class="chat-bubble ${isSelf ? 'chat-self' : 'chat-other'} shadow-sm">
                                    <p class="text-xs font-semibold ${isSelf ? 'text-white' : 'text-primary'} mb-1">${isSelf ? 'את/ה' : msg.authorName}</p>
                                    <p class="text-sm">${msg.text}</p>
                                    <p class="text-xs mt-1 opacity-70 ${isSelf ? 'text-white' : 'text-gray-600'} text-left">${new Date(msg.timestamp).toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit' })}</p>
                                </div>
                            </div>
                        `;
                    }).join('') : `
                        <div class="text-center text-gray-500 py-10">
                            <i class="fa fa-comment-dots text-4xl mb-3"></i>
                            <p class="text-lg">הדיון פתוח! שלח/י את ההודעה הראשונה.</p>
                        </div>
                    `}
                </div>

                <!-- טופס שליחת הודעה -->
                <form id="chatForm" class="flex p-4 card shadow-inner">
                    <input type="text" id="chatInput" placeholder="כתוב הודעה..." class="input-field flex-grow ml-3" required>
                    <button type="submit" class="py-2 px-6 btn-sec font-semibold rounded-lg shadow-md hover:opacity-90 transition duration-150">
                        <i class="fa fa-paper-plane"></i>
                    </button>
                </form>
            </div>
            ${renderModal('confirmDeletePostModal', renderConfirmDeletePostModalContent())}
        `;
    }

    // ==========================================================
    // --- 6. רנדור קומפוננטות (Modal, Forms) ---
    // ==========================================================

    /**
     * פונקציה כללית לרנדור מודאל.
     * @param {string} id - ה-ID של המודאל.
     * @param {string} content - תוכן ה-HTML של המודאל.
     * @returns {string} HTML של המודאל.
     */
    function renderModal(id, content) {
        return `
            <div id="${id}" class="fixed inset-0 bg-black/30 hidden items-center justify-center z-60" data-modal-id="${id}">
                <div class="bg-white p-6 rounded w-full max-w-lg card" onclick="event.stopPropagation()">
                    ${content}
                    <div class="mt-6 text-left">
                        <button data-action="closeModal" data-modal-id="${id}" class="text-gray-500 hover:text-gray-700">סגור</button>
                    </div>
                </div>
            </div>
        `;
    }

    function renderNewPostModalContent() {
        return `
            <h3 class="text-2xl font-bold mb-4">פתיחת נושא חדש</h3>
            <form id="newPostForm">
                <div class="form-group mb-4">
                    <label for="newPostTitle">כותרת הנושא</label>
                    <input type="text" id="newPostTitle" name="title" placeholder="כותרת קצרה וממוקדת" class="input-field" required maxlength="100">
                </div>
                <div class="form-group mb-4">
                    <label for="newPostContent">תוכן הבקשה/שאלה</label>
                    <textarea id="newPostContent" name="content" placeholder="פרט את שאלתך או את מה שתרצה לשתף" class="input-field h-32" required></textarea>
                </div>
                <button type="submit" class="w-full py-3 btn-primary font-semibold rounded-lg shadow-md hover:opacity-90 transition duration-150">
                    <i class="fa fa-paper-plane ml-2"></i> פרסם פוסט
                </button>
            </form>
            <p id="newPostError" class="text-red-500 mt-3 hidden text-sm font-medium">שגיאה ביצירת הפוסט.</p>
        `;
    }

    function renderEditPostModalContent() {
        const post = state.currentPost; // יש להגדיר את currentPost לפני פתיחת המודאל
        if (!post) return '';

        return `
            <h3 class="text-2xl font-bold mb-4">עריכת פוסט</h3>
            <form id="editPostForm" data-post-id="${post.id}">
                <div class="form-group mb-4">
                    <label for="editPostTitle">כותרת הנושא</label>
                    <input type="text" id="editPostTitle" name="title" value="${post.title}" placeholder="כותרת קצרה וממוקדת" class="input-field" required maxlength="100">
                </div>
                <div class="form-group mb-4">
                    <label for="editPostContent">תוכן הבקשה/שאלה</label>
                    <textarea id="editPostContent" name="content" placeholder="פרט את שאלתך או את מה שתרצה לשתף" class="input-field h-32" required>${post.content}</textarea>
                </div>
                <button type="submit" class="w-full py-3 btn-primary font-semibold rounded-lg shadow-md hover:opacity-90 transition duration-150">
                    <i class="fa fa-save ml-2"></i> שמור שינויים
                </button>
            </form>
            <p id="editPostError" class="text-red-500 mt-3 hidden text-sm font-medium">שגיאה בעדכון הפוסט.</p>
        `;
    }

    function renderConfirmDeletePostModalContent() {
        return `
            <h3 class="text-2xl font-bold mb-4 text-red-600">אישור מחיקה</h3>
            <p class="text-gray-700 mb-6">האם אתה בטוח שברצונך למחוק את הפוסט הזה? פעולה זו אינה הפיכה.</p>
            <div class="flex justify-end space-x-3 space-x-reverse">
                <button data-action="closeModal" data-modal-id="confirmDeletePostModal" class="py-2 px-4 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">
                    ביטול
                </button>
                <button data-action="deletePostConfirmed" class="py-2 px-4 bg-red-500 text-white rounded-lg hover:bg-red-600 font-semibold">
                    מחק לצמיתות
                </button>
            </div>
            <p id="deletePostError" class="text-red-500 mt-3 hidden text-sm font-medium">שגיאה במחיקת הפוסט.</p>
        `;
    }


    // ==========================================================
    // --- 7. לוגיקת אירועים (Event Handling) ---
    // ==========================================================
    
    /**
     * מחבר את כל מאזיני האירועים ל-DOM.
     */
    function attachEventListeners() {
        // --- מאזינים כלליים (עבור כפתורי goTo, מודאלים) ---
        document.querySelectorAll('[data-action]').forEach(element => {
            // הסר מאזין קודם כדי למנוע כפילויות
            element.removeEventListener('click', handleGlobalClick);
            element.addEventListener('click', handleGlobalClick);
        });

        // --- מאזינים לטפסים (Login, Register, New Post, Chat) ---
        // Login
        const loginForm = document.getElementById('loginForm');
        if (loginForm) {
            loginForm.removeEventListener('submit', handleLogin);
            loginForm.addEventListener('submit', handleLogin);
        }

        // Register
        const registerForm = document.getElementById('registerForm');
        if (registerForm) {
            registerForm.removeEventListener('submit', handleRegister);
            registerForm.addEventListener('submit', handleRegister);
        }
        
        // New Post
        const newPostForm = document.getElementById('newPostForm');
        if (newPostForm) {
            newPostForm.removeEventListener('submit', handleNewPost);
            newPostForm.addEventListener('submit', handleNewPost);
        }

        // Edit Post
        const editPostForm = document.getElementById('editPostForm');
        if (editPostForm) {
            editPostForm.removeEventListener('submit', handleEditPost);
            editPostForm.addEventListener('submit', handleEditPost);
        }

        // Chat
        const chatForm = document.getElementById('chatForm');
        if (chatForm) {
            chatForm.removeEventListener('submit', handleChatSubmit);
            chatForm.addEventListener('submit', handleChatSubmit);
        }

        // Search
        const forumSearch = document.getElementById('forumSearch');
        if (forumSearch) {
            forumSearch.removeEventListener('input', handleSearchInput);
            forumSearch.addEventListener('input', handleSearchInput);
        }
        
        // Modal Backdrop closing
        document.querySelectorAll('.fixed.inset-0[data-modal-id]').forEach(modal => {
            modal.removeEventListener('click', handleBackdropClick);
            modal.addEventListener('click', handleBackdropClick);
        });
    }

    /**
     * מטפל בלחיצות גלובליות על אלמנטים עם data-action.
     */
    function handleGlobalClick(event) {
        const action = event.currentTarget.getAttribute('data-action');
        const screen = event.currentTarget.getAttribute('data-screen');
        const postId = event.currentTarget.getAttribute('data-post-id');
        const modalId = event.currentTarget.getAttribute('data-modal-id');

        switch (action) {
            case 'goTo':
                if (screen) {
                    goTo(screen);
                }
                break;
            case 'logout':
                handleLogout();
                break;
            case 'showRules':
                showModal('rulesModal');
                break;
            case 'showNewPostModal':
                showModal('newPostModal');
                break;
            case 'showEditPostModal':
                // לפני פתיחת העריכה, נמצא את הפוסט ושמור אותו ב-state.currentPost
                const postToEdit = state.posts.find(p => p.id === postId);
                if (postToEdit) {
                    state.currentPost = postToEdit;
                    // מרנדרים מחדש רק את המודאל כדי שיוצג עם התוכן המעודכן
                    const modalContainer = document.getElementById('modal-container');
                    modalContainer.innerHTML = modalContainer.innerHTML + renderModal('editPostModal', renderEditPostModalContent());
                    attachEventListeners(); // חבר מאזינים מחדש
                    showModal('editPostModal');
                }
                break;
            case 'openPostChat':
                const postToOpen = state.posts.find(p => p.id === postId);
                if (postToOpen) {
                    state.currentPost = postToOpen;
                    setupPublicListeners(); // התחל להאזין להודעות של הפוסט החדש
                    goTo('chat');
                }
                break;
            case 'confirmDeletePost':
                showModal('confirmDeletePostModal');
                break;
            case 'deletePostConfirmed':
                handleDeletePost();
                break;
            case 'closeModal':
                if (modalId) {
                    hideModal(modalId);
                }
                break;
            default:
                console.warn('Action not handled:', action);
        }
    }

    /**
     * מטפל בלחיצה על רקע המודאל לסגירה.
     */
    function handleBackdropClick(event) {
        if (event.target.classList.contains('fixed') && event.target.getAttribute('data-modal-id')) {
            hideModal(event.target.getAttribute('data-modal-id'));
        }
    }
    
    /**
     * מטפל בשינויים בתיבת החיפוש.
     */
    function handleSearchInput(event) {
        state.searchTerm = event.target.value;
        // רנדור מחדש כדי לסנן את הפוסטים (לא משנה מסך, רק מעדכן את הרשימה)
        render(); 
    }

    /**
     * מציג מודאל.
     */
    function showModal(id) {
        const modal = document.getElementById(id);
        if (modal) {
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            // רנדור מחדש של תוכן המודאל לעריכה אם זה מודאל עריכה
            if (id === 'editPostModal') {
                const modalContent = modal.querySelector('.w-full.max-w-lg');
                modalContent.innerHTML = renderEditPostModalContent() + 
                                         `<div class="mt-6 text-left"><button data-action="closeModal" data-modal-id="${id}" class="text-gray-500 hover:text-gray-700">סגור</button></div>`;
                attachEventListeners(); // חבר מאזינים מחדש
            }
        }
    }

    /**
     * מסתיר מודאל.
     */
    function hideModal(id) {
        const modal = document.getElementById(id);
        if (modal) {
            modal.classList.remove('flex');
            modal.classList.add('hidden');
        }
    }

    // ==========================================================
    // --- 8. לוגיקת אוטנטיקציה ו-Firestore ---
    // ==========================================================

    /**
     * מטפל בהתחברות באמצעות דוא"ל וסיסמה.
     */
    async function handleLogin(event) {
        event.preventDefault();
        const email = event.target.elements.loginEmail.value;
        const password = event.target.elements.loginPassword.value;
        const errorEl = document.getElementById('loginError');
        errorEl.classList.add('hidden');

        try {
            await signInWithEmailAndPassword(window.auth, email, password);
            // onAuthStateChanged יטפל במעבר למסך הבית
        } catch (error) {
            console.error("שגיאה בהתחברות:", error);
            errorEl.textContent = 'שגיאה: שם משתמש או סיסמה שגויים.';
            errorEl.classList.remove('hidden');
        }
    }

    /**
     * מטפל בהרשמה באמצעות דוא"ל, סיסמה ושם.
     */
    async function handleRegister(event) {
        event.preventDefault();
        const name = event.target.elements.registerName.value;
        const email = event.target.elements.registerEmail.value;
        const password = event.target.elements.registerPassword.value;
        const errorEl = document.getElementById('registerError');
        errorEl.classList.add('hidden');

        try {
            const userCredential = await createUserWithEmailAndPassword(window.auth, email, password);
            
            // עדכון השם ב-Firebase Auth
            await updateProfile(userCredential.user, { displayName: name });

            // יצירת מסמך פרופיל ב-Firestore
            const userId = userCredential.user.uid;
            const profileRef = doc(window.db, getUserDocPath('profile'));
            await setDoc(profileRef, {
                name: name,
                email: email,
                uid: userId,
                joinedAt: serverTimestamp()
            });

            // onAuthStateChanged יטפל במעבר למסך הבית
        } catch (error) {
            console.error("שגיאה בהרשמה:", error);
            if (error.code === 'auth/email-already-in-use') {
                errorEl.textContent = 'שגיאה: האימייל הזה כבר רשום במערכת.';
            } else if (error.code === 'auth/weak-password') {
                errorEl.textContent = 'שגיאה: הסיסמה חלשה מדי (לפחות 6 תווים).';
            } else {
                 errorEl.textContent = 'שגיאה: בעיה בהרשמה. אנא נסה שוב מאוחר יותר.';
            }
            errorEl.classList.remove('hidden');
        }
    }

    /**
     * מטפל ביציאה מהמערכת.
     */
    async function handleLogout() {
        try {
            cleanupListeners();
            await signOut(window.auth);
            state.user = null;
            state.profile = null;
            goTo('login');
        } catch (error) {
            console.error("שגיאה ביציאה:", error);
        }
    }

    /**
     * יוצר פוסט חדש בפורום.
     */
    async function handleNewPost(event) {
        event.preventDefault();
        const title = event.target.elements.newPostTitle.value;
        const content = event.target.elements.newPostContent.value;
        const errorEl = document.getElementById('newPostError');
        errorEl.classList.add('hidden');

        if (!state.profile) {
            errorEl.textContent = 'שגיאה: אינך מחובר כרגע.';
            errorEl.classList.remove('hidden');
            return;
        }

        try {
            const postsCollectionRef = collection(window.db, getPublicCollectionPath('posts'));
            await addDoc(postsCollectionRef, {
                title: title,
                content: content,
                authorId: state.profile.uid,
                authorName: state.profile.name,
                timestamp: serverTimestamp(),
                isDeleted: false,
                chatCount: 0
            });

            hideModal('newPostModal');
            event.target.reset(); // ניקוי הטופס
            // ה-onSnapshot יעדכן את רשימת הפוסטים ויגרום לרנדור מחדש
        } catch (error) {
            console.error("שגיאה ביצירת פוסט:", error);
            errorEl.textContent = 'שגיאה: לא ניתן ליצור את הפוסט כרגע.';
            errorEl.classList.remove('hidden');
        }
    }

    /**
     * מעדכן פוסט קיים.
     */
    async function handleEditPost(event) {
        event.preventDefault();
        const postId = event.target.getAttribute('data-post-id');
        const title = event.target.elements.editPostTitle.value;
        const content = event.target.elements.editPostContent.value;
        const errorEl = document.getElementById('editPostError');
        errorEl.classList.add('hidden');

        if (!state.profile || !postId) {
            errorEl.textContent = 'שגיאה: נתונים חסרים.';
            errorEl.classList.remove('hidden');
            return;
        }
        
        const postRef = doc(window.db, getPublicCollectionPath('posts'), postId);
        
        try {
            await updateDoc(postRef, {
                title: title,
                content: content,
                lastEdited: serverTimestamp()
            });

            hideModal('editPostModal');
            // ה-onSnapshot יעדכן את רשימת הפוסטים ויגרום לרנדור מחדש
        } catch (error) {
            console.error("שגיאה בעדכון פוסט:", error);
            errorEl.textContent = 'שגיאה: לא ניתן לעדכן את הפוסט.';
            errorEl.classList.remove('hidden');
        }
    }

    /**
     * מסמן פוסט כמחוק.
     */
    async function handleDeletePost() {
        const postId = state.currentPost?.id;
        const errorEl = document.getElementById('deletePostError');
        errorEl.classList.add('hidden');
        
        if (!postId || state.currentPost.authorId !== state.profile.uid) {
            errorEl.textContent = 'שגיאה: אין לך הרשאה למחוק פוסט זה.';
            errorEl.classList.remove('hidden');
            return;
        }
        
        try {
            const postRef = doc(window.db, getPublicCollectionPath('posts'), postId);
            await updateDoc(postRef, {
                isDeleted: true,
                deletedAt: serverTimestamp()
            });

            hideModal('confirmDeletePostModal');
            // ה-onSnapshot יטפל במעבר למסך הפורום
        } catch (error) {
            console.error("שגיאה במחיקת פוסט:", error);
            errorEl.textContent = 'שגיאה: לא ניתן למחוק את הפוסט.';
            errorEl.classList.remove('hidden');
        }
    }

    /**
     * מטפל בשליחת הודעה בצ'אט.
     */
    async function handleChatSubmit(event) {
        event.preventDefault();
        const inputEl = document.getElementById('chatInput');
        const text = inputEl.value.trim();

        if (!text || !state.currentPost || !state.profile) return;

        try {
            const messagesCollectionRef = collection(window.db, getPublicCollectionPath(`posts/${state.currentPost.id}/messages`));
            await addDoc(messagesCollectionRef, {
                text: text,
                authorId: state.profile.uid,
                authorName: state.profile.name,
                timestamp: serverTimestamp()
            });

            inputEl.value = ''; // ניקוי השדה
            // ה-onSnapshot יעדכן את רשימת ההודעות ויגרום לגלילה
        } catch (error) {
            console.error("שגיאה בשליחת הודעה:", error);
            // אין צורך בהודעת שגיאה על המסך, רק ב-console
        }
    }
    
    // ==========================================================
    // --- 9. פונקציית אתחול ראשית (Start App) ---
    // ==========================================================
    
    /**
     * **(שם הפונקציה שונה כדי למנוע קונפליקט עם Firebase.initializeApp)**
     * פונקציית אתחול ראשית של האפליקציה.
     */
    async function startApp() {
        // 1. נסה להתחבר עם טוקן מותאם אישית אם קיים
        if (initialAuthToken) {
            try {
                await signInWithCustomToken(window.auth, initialAuthToken);
            } catch (error) {
                console.error("שגיאה בהתחברות עם Custom Token, עובר לאנונימי:", error);
                await signInAnonymously(window.auth);
            }
        } else {
            // אם אין טוקן מותאם אישית, התחבר כאנונימי
            await signInAnonymously(window.auth);
        }
        
        // 2. הירשם למצב האימות
        // קריאה חוזרת זו מתבצעת פעם אחת בעת עליית האפליקציה, ואז שוב כל פעם שמצב ה-Auth משתנה (התחברות/יציאה)
        // **הערה חשובה:** אין לבצע קריאות ל-Firestore לפני שהפונקציה הזו רצה והגדירה את state.user
        onAuthStateChanged(window.auth, async (user) => {
            if (user) {
                // **המשתמש מחובר (בבדיקה הראשונית או אחרי כניסה)**
                state.user = user;
                
                try {
                    // 1. אחזור נתוני פרופיל מ-Firestore
                    const profileData = await fetchUserProfile();
                    
                    if (profileData) {
                        // 2. עדכון ה-state
                        state.profile = profileData;
                        
                        // 3. הגדרת מאזינים לנתונים הציבוריים
                        setupPublicListeners();
                        
                        // 4. ניתוב למסך הבית רק אם לא היתה שגיאה קריטית
                        if (state.screen === 'loading' || state.screen === 'login' || state.screen === 'register') {
                            goTo('home');
                        } else {
                            render(); // אם המשתמש כבר במסך כלשהו (כמו פורום), רנדר מחדש
                        }
                    } else {
                        // המשתמש מחובר ב-Auth אבל לא קיים במסמך users (כנראה נמחק או עדיין בהרשמה)
                        // אם זה משתמש אנונימי או חדש - נאפשר לו להירשם
                        if (user.isAnonymous) {
                           goTo('login');
                        } else {
                            // אם זה משתמש רשום ללא פרופיל, ננתב להרשמה (או לוגין כדי שינסה שוב)
                            if (state.screen !== 'register') {
                                goTo('login');
                            }
                        }
                    }
                } catch (error) {
                    console.error("שגיאה קריטית באחזור פרופיל משתמש או נתונים:", error);
                     // אם יש שגיאה בחיבור ל-Firebase, אנו חוזרים ללוגין
                    state.user = null;
                    state.screen = 'login';
                    render();
                    // שימוש במודאל/הודעה מותאמת אישית במקום alert
                    // alert("שגיאה בחיבור לשרת או באחזור נתונים. נסה להתחבר שוב.");
                }
            } else {
                // **המשתמש לא מחובר או יצא**
                state.user = null;
                state.profile = null;
                cleanupListeners(); // נקה מאזינים ציבוריים כשיוצאים
                if (state.screen !== 'register') {
                    goTo('login');
                } else {
                    render();
                }
            }
        });
    }

    // הפעלת האפליקציה
    startApp(); 
</script>

<!-- Terms modal (simple) -->
<div id="rulesModal" class="fixed inset-0 bg-black/30 hidden items-center justify-center z-60" data-modal-id="rulesModal">
  <div class="bg-white p-6 rounded w-full max-w-2xl card" onclick="event.stopPropagation()">
    <h3 class="font-semibold mb-2">תקנון השימוש וקוד התנהגות בקהילה</h3>
    <div class="small-muted mb-4 text-sm">
      <strong>הערה חשובה:</strong> מרכז העזרה מועבר על בסיס קהילתי בלבד. בעלי האתר אינם מספקים ייעוץ מקצועי ואינם אחראים על התכנים או התוצאות. פניות בתחום משפטי, רפואי או פיננסי מהוות המלצה בלבד ואין לראות בהן תחליף לייעוץ מקצועי.
    </div>
    <ol class="text-sm small-muted list-decimal ml-6 space-y-2">
      <li>כבדו פרטיות של חברים — אין לפרסם מידע אישי ללא הסכמה ברורה.</li>
      <li>אסור לשתף תכנים פוגעניים, גזעניים או קיצוניים.</li>
      <li>הימנעו מהצעות רפואיות/משפטיות/פיננסיות מוחלטות; יש להפנות לייעוץ מקצועי.</li>
      <li>יש לשמור על שפה מכבדת ומאפשרת.</li>
      <li>למנהלי הקהילה שמורה הזכות למחוק תכנים פוגעניים או לחסום משתמשים המפרים את הכללים.</li>
    </ol>
    <div class="mt-6 text-left">
        <button data-action="closeModal" data-modal-id="rulesModal" class="text-gray-500 hover:text-gray-700">סגור</button>
    </div>
  </div>
</div>

</body>
</html>
