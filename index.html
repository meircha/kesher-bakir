<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>קהילת קשר | החיים הטובים</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome (לאייקונים) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <style>
        /* --- 1. עיצוב חדש וצבעוני (מותאם לקהל מבוגר) --- */
        :root {
            --kesher-primary: #0077B6; /* כחול עמוק - אמין, רגוע */
            --kesher-secondary: #00B4D8; /* תכלת בהיר - פתוח, נגיש */
            --kesher-accent: #FFC300; /* זהב - דגש */
            --kesher-text: #2c3e50;
            --kesher-bg: #EAEFF2;
        }
        html, body { 
            height: 100%; 
            background-color: var(--kesher-bg);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            color: var(--kesher-text);
        }
        .bg-kesher-primary { background-color: var(--kesher-primary); }
        .text-kesher-primary { color: var(--kesher-primary); }
        .bg-kesher-secondary { background-color: var(--kesher-secondary); }
        .text-kesher-secondary { color: var(--kesher-secondary); }
        .bg-kesher-accent { background-color: var(--kesher-accent); }
        .hover\:bg-kesher-primary:hover { background-color: #005A8D; }
        
        /* סגנון כללי לכרטיס (Card) */
        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            padding: 1.5rem;
            margin-bottom: 1rem;
        }
        /* סגנון לכפתור הראשי */
        .btn-primary {
            display: block;
            width: 100%;
            padding: 0.75rem;
            border-radius: 8px;
            font-weight: bold;
            color: white;
            transition: background-color 0.2s;
        }
        /* שדה קלט */
        input:not([type="checkbox"]), textarea {
            border: 1px solid #D1D5DB;
            border-radius: 6px;
            padding: 0.75rem;
            width: 100%;
            transition: border-color 0.2s;
        }
        input:focus, textarea:focus {
            outline: none;
            border-color: var(--kesher-primary);
            box-shadow: 0 0 0 1px var(--kesher-primary);
        }

        /* סגנון מיוחד למסכי כניסה/הרשמה */
        .auth-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            background: linear-gradient(135deg, var(--kesher-secondary) 0%, var(--kesher-primary) 100%);
        }
        .auth-title {
            font-size: 2.5rem;
            font-weight: 800;
            color: white;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }
        /* הסתרת מסכים לא רלוונטיים */
        .screen:not(.active) { display: none !important; }
        
        /* גלילה מותאמת אישית לצ'אט */
        .chat-messages {
            overflow-y: auto;
            display: flex;
            flex-direction: column-reverse; /* כדי שהודעות חדשות יהיו למטה */
        }
    </style>
</head>
<body dir="rtl">
    
    <!-- רכיב ה-ROOT של האפליקציה -->
    <div id="app" class="h-full">
        <!-- המסכים ירונדרו כאן על ידי JavaScript -->
    </div>

    <!-- Firebase Config - הנתונים שהכנסת -->
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCrcxC420HW5PXGNd8M4KuclUkiJSwHreM", 
            authDomain: "kesher-bakir.firebaseapp.com",
            projectId: "kesher-bakir",
            storageBucket: "kesher-bakir.firebasestorage.app",
            messagingSenderId: "671996189455",
            appId: "1:671996189455:web:d8ee089585a852ab38fc7a"
        };

        // אתחול Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // הגדרת משתני מצב גלובליים (State Management)
        const state = {
            screen: 'loading',
            user: null, // פרטי המשתמש המחובר
            users: [], // רשימת כל המשתמשים
            forums: [], // רשימת פורומים
            activities: [], // רשימת פעילויות
            currentForum: null, // הפורום המוצג כרגע
            forumPosts: [], // פוסטים בפורום הנוכחי
            currentRecipientId: null, // ID של מקבל הצ'אט
            chatMessages: [], // הודעות הצ'אט הנוכחי
            unreadCount: 0,
            
            // נתונים לשמירה אוטומטית (כמו טיוטה של פוסט)
            draft: {
                newPostText: '',
                newPostTitle: ''
            }
        };
        
        /* ====================== Utility Functions (כלים) ====================== */
        
        /**
         * מנווט למסך חדש ומבצע רינדור.
         * @param {string} screenName - שם המסך ('home', 'login', 'forum', 'chat', 'profile')
         * @param {object} [data] - נתונים אופציונליים (כמו ID של פורום)
         */
        function goTo(screenName, data = {}) {
            state.screen = screenName;
            
            // איפוס/הגדרת נתונים לפי המסך
            if (screenName === 'forum' && data.forumId) {
                state.currentForum = state.forums.find(f => f.id === data.forumId);
                state.forumPosts = []; // ניקוי פוסטים ישנים
                if (state.currentForum) {
                     // הפעלת מאזין לפוסטים (יוגדר בלוגיקת ה-init)
                } else {
                    alert('פורום לא נמצא!');
                    goTo('home');
                }
            } else if (screenName === 'chat' && data.recipientId) {
                state.currentRecipientId = data.recipientId;
                state.chatMessages = [];
                 // הפעלת מאזין לצ'אט
            } else {
                state.currentForum = null;
                state.currentRecipientId = null;
            }
            
            console.log(`ניווט למסך: ${screenName}`, data);
            render();
        }

        /**
         * מאחזר את כל הנתונים הראשוניים הנדרשים מה-Firestore.
         */
        async function fetchInitialData() {
            const usersRef = db.collection('users').get();
            const forumsRef = db.collection('forums').get();
            const activitiesRef = db.collection('activities').get();

            const [usersSnapshot, forumsSnapshot, activitiesSnapshot] = await Promise.all([usersRef, forumsRef, activitiesRef]);
            
            state.users = usersSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            state.forums = forumsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            state.activities = activitiesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

            console.log("נתונים ראשוניים נטענו:", { 
                users: state.users.length, 
                forums: state.forums.length, 
                activities: state.activities.length 
            });
        }
        
        function getUserDisplayName(userId) {
            const user = state.users.find(u => u.id === userId);
            return user ? (user.displayName || user.email.split('@')[0]) : 'משתמש לא ידוע';
        }
        
        function formatRelativeTime(timestamp) {
            if (!timestamp || !timestamp.toDate) return 'לא ידוע';
            const date = timestamp.toDate();
            const now = new Date();
            const diff = now.getTime() - date.getTime();
            
            const minutes = Math.floor(diff / (1000 * 60));
            if (minutes < 60) return `לפני ${minutes} דק'`;
            
            const hours = Math.floor(diff / (1000 * 60 * 60));
            if (hours < 24) return `לפני ${hours} שעות`;
            
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            if (days < 7) return `לפני ${days} ימים`;

            return date.toLocaleDateString('he-IL');
        }

        /* ====================== Screen Render Functions (רכיבים) ====================== */
        
        /**
         * רכיב: כותרת ואזור ניווט עליון (משותף)
         */
        function renderHeader() {
            const user = state.user || {};
            return `
                <header class="bg-white shadow-md p-4 flex justify-between items-center sticky top-0 z-50 border-b border-gray-100">
                    <h1 class="text-xl font-bold text-kesher-primary cursor-pointer" onclick="goTo('home')">
                        <i class="fa-solid fa-handshake-angle ml-2"></i> קהילת קשר
                    </h1>
                    <nav class="flex space-x-4 space-x-reverse items-center">
                        <button onclick="goTo('home')" class="text-gray-600 hover:text-kesher-secondary p-2 rounded-full">
                            <i class="fa-solid fa-house text-2xl"></i>
                        </button>
                        <button onclick="goTo('chatList')" class="text-gray-600 hover:text-kesher-secondary p-2 rounded-full relative">
                            <i class="fa-solid fa-comments text-2xl"></i>
                            ${state.unreadCount > 0 ? `<span class="absolute top-0 right-0 inline-flex items-center justify-center w-5 h-5 text-xs font-bold leading-none text-white transform translate-x-1/4 -translate-y-1/4 bg-red-600 rounded-full">${state.unreadCount}</span>` : ''}
                        </button>
                        <button onclick="goTo('profile', { userId: user.id })" class="text-gray-600 hover:text-kesher-secondary p-2 rounded-full">
                            <i class="fa-solid fa-user text-2xl"></i>
                        </button>
                        <button onclick="auth.signOut()" class="text-red-500 hover:text-red-700 p-2 rounded-full">
                            <i class="fa-solid fa-right-from-bracket text-2xl"></i>
                        </button>
                    </nav>
                </header>
            `;
        }
        
        /**
         * רכיב: מסך הבית (Home)
         */
        function renderHome() {
            const user = state.user || {};
            const onlineUsers = state.users.filter(u => u.isOnline && u.id !== user.id);

            return `
                <div class="flex flex-col h-full">
                    ${renderHeader()}
                    
                    <main class="flex-grow p-4 overflow-y-auto">
                        <h2 class="text-3xl font-bold text-kesher-primary mb-6">ברוך הבא, ${user.displayName || 'חבר'}!</h2>
                        
                        <!-- כרטיס פעילויות אחרונות -->
                        <div class="card mb-6">
                            <h4 class="font-bold text-xl text-kesher-secondary mb-3 border-b pb-2"><i class="fa-solid fa-calendar-alt ml-2"></i> פעילויות קרובות (${state.activities.length})</h4>
                            <div class="space-y-3">
                                ${state.activities.slice(0, 3).map(activity => `
                                    <div class="p-3 bg-blue-50 border border-blue-200 rounded-lg hover:shadow-lg transition cursor-pointer">
                                        <p class="font-semibold text-lg">${activity.title}</p>
                                        <p class="text-sm text-gray-700"><i class="fa-solid fa-location-dot ml-1"></i> ${activity.location || 'מרחב וירטואלי'}</p>
                                        <p class="text-xs text-gray-500">${new Date(activity.date).toLocaleDateString('he-IL')}</p>
                                    </div>
                                `).join('')}
                                ${state.activities.length > 3 ? `<div class="text-center mt-4"><a href="#" onclick="goTo('activitiesList')" class="text-kesher-primary font-semibold hover:underline">כל הפעילויות</a></div>` : ''}
                            </div>
                        </div>

                        <!-- כרטיס פורומים -->
                        <div class="card">
                            <h4 class="font-bold text-xl text-kesher-primary mb-3 border-b pb-2"><i class="fa-solid fa-comments ml-2"></i> דיונים ופורומים (${state.forums.length})</h4>
                            <div class="space-y-2">
                                ${state.forums.map(forum => `
                                    <div class="p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition cursor-pointer flex items-center justify-between" onclick="goTo('forum', { forumId: '${forum.id}' })">
                                        <div>
                                            <p class="font-semibold">${forum.name}</p>
                                            <p class="text-sm text-gray-600">${forum.description || 'דיון כללי'}</p>
                                        </div>
                                        <span class="text-xs text-kesher-secondary font-bold">${forum.postCount || 0} פוסטים</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        <!-- מי מחובר -->
                        <div class="card mt-6">
                            <h4 class="font-bold text-xl text-kesher-secondary mb-3 border-b pb-2"><i class="fa-solid fa-circle-user ml-2"></i> חברים אונליין (${onlineUsers.length})</h4>
                            <div class="flex flex-wrap gap-3">
                                ${onlineUsers.slice(0, 10).map(u => `
                                    <div class="px-3 py-1 bg-green-100 text-green-700 rounded-full text-sm font-medium cursor-pointer flex items-center hover:bg-green-200 transition" onclick="goTo('chat', { recipientId: '${u.id}' })">
                                        <i class="fa-solid fa-message text-xs ml-1"></i>
                                        ${u.displayName || u.email.split('@')[0]}
                                    </div>
                                `).join('')}
                                ${onlineUsers.length === 0 ? '<p class="text-gray-500 text-sm">כרגע אין חברים נוספים מחוברים.</p>' : ''}
                            </div>
                        </div>
                    </main>
                </div>
            `;
        }
        
        /**
         * רכיב: מסך פורום ספציפי (Forum View)
         */
        function renderForum() {
            if (!state.currentForum) return goTo('home');
            const forum = state.currentForum;

            // פוסטים מדומה, ממוין לפי זמן אחרון
            const sortedPosts = state.forumPosts.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));

            return `
                <div class="flex flex-col h-full">
                    ${renderHeader()}
                    
                    <main class="flex-grow p-4 overflow-y-auto">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-3xl font-bold text-kesher-primary">${forum.name}</h2>
                            <button onclick="document.getElementById('newPostModal').classList.remove('hidden')" class="bg-kesher-secondary hover:bg-kesher-primary text-white font-bold py-2 px-4 rounded-lg transition shadow-md">
                                <i class="fa-solid fa-plus ml-2"></i> פוסט חדש
                            </button>
                        </div>
                        <p class="text-gray-600 mb-6">${forum.description}</p>
                        
                        <!-- רשימת פוסטים -->
                        <div class="space-y-4">
                            ${sortedPosts.length > 0 ? sortedPosts.map(post => `
                                <div class="card hover:shadow-lg transition border border-gray-100">
                                    <h3 class="text-xl font-bold text-kesher-text mb-1">${post.title}</h3>
                                    <p class="text-sm text-gray-500 mb-3">
                                        פורסם על ידי 
                                        <span class="font-semibold text-kesher-secondary">${getUserDisplayName(post.authorId)}</span> 
                                        - ${formatRelativeTime(post.createdAt)}
                                    </p>
                                    <p class="text-gray-700 line-clamp-3">${post.content}</p>
                                    <div class="flex justify-between items-center mt-3 pt-3 border-t border-gray-100">
                                        <button onclick="goTo('postDetails', { postId: '${post.id}', forumId: '${forum.id}' })" class="text-sm text-kesher-primary hover:underline font-medium">
                                            קרא עוד (${post.commentCount || 0} תגובות)
                                        </button>
                                        <span class="text-xs text-gray-400">#${forum.tag}</span>
                                    </div>
                                </div>
                            `).join('') : '<p class="text-gray-500 text-center card p-8">אין עדיין פוסטים בפורום זה. היה הראשון לפרסם!</p>'}
                        </div>
                    </main>
                </div>

                <!-- מודאל פוסט חדש -->
                <div id="newPostModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
                    <div class="card w-full max-w-lg">
                        <h3 class="text-2xl font-bold mb-4">פרסום פוסט חדש ב${forum.name}</h3>
                        <form id="newPostForm">
                            <div class="mb-4">
                                <label for="postTitle" class="block font-medium mb-1">כותרת</label>
                                <input type="text" id="postTitle" required placeholder="כותרת הפוסט שלך" value="${state.draft.newPostTitle}" oninput="state.draft.newPostTitle = this.value">
                            </div>
                            <div class="mb-4">
                                <label for="postContent" class="block font-medium mb-1">תוכן הפוסט</label>
                                <textarea id="postContent" rows="6" required placeholder="שתף את המחשבות שלך..." value="${state.draft.newPostText}" oninput="state.draft.newPostText = this.value"></textarea>
                            </div>
                            <div class="flex justify-end space-x-2 space-x-reverse">
                                <button type="button" onclick="document.getElementById('newPostModal').classList.add('hidden')" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">בטל</button>
                                <button type="submit" class="bg-kesher-secondary hover:bg-kesher-primary text-white font-bold py-2 px-4 rounded-lg transition">שלח פוסט</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
        }

        /**
         * רכיב: מסך צ'אט (Chat View)
         * כולל את רשימת המשתמשים ואת מסך הצ'אט הפעיל
         */
        function renderChat() {
            const recipientId = state.currentRecipientId;
            const recipient = recipientId ? state.users.find(u => u.id === recipientId) : null;
            const chatPartnerName = recipient ? getUserDisplayName(recipientId) : 'בחר חבר';
            const chatContainerClass = recipientId ? 'md:col-span-2' : 'col-span-3';

            // ממוין לפי זמן (החדש ביותר למטה)
            const sortedMessages = state.chatMessages.slice().sort((a, b) => (a.createdAt?.seconds || 0) - (b.createdAt?.seconds || 0));

            return `
                <div class="flex flex-col h-full">
                    ${renderHeader()}
                    
                    <main class="flex-grow grid grid-cols-3 overflow-hidden">
                        <!-- עמודת רשימת צ'אטים/משתמשים -->
                        <div class="col-span-1 border-l bg-white overflow-y-auto">
                            <h3 class="text-xl font-bold p-4 border-b">צ'אטים וחברים</h3>
                            <div class="space-y-1 p-2">
                                ${state.users.filter(u => u.id !== state.user.id).map(u => `
                                    <div class="p-3 rounded-lg cursor-pointer flex items-center justify-between transition ${u.id === recipientId ? 'bg-blue-100' : 'hover:bg-gray-50'}" onclick="goTo('chat', { recipientId: '${u.id}' })">
                                        <div class="flex items-center">
                                            <div class="w-3 h-3 rounded-full ${u.isOnline ? 'bg-green-500' : 'bg-gray-300'} ml-2"></div>
                                            <p class="font-semibold">${getUserDisplayName(u.id)}</p>
                                        </div>
                                        ${u.id === recipientId ? '<i class="fa-solid fa-arrow-left text-kesher-primary"></i>' : ''}
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        <!-- עמודת הצ'אט הפעיל -->
                        <div class="${chatContainerClass} flex flex-col bg-white border-l">
                            ${recipientId ? `
                                <!-- כותרת צ'אט -->
                                <div class="p-4 border-b bg-gray-50 flex items-center justify-between">
                                    <h3 class="text-lg font-bold">שיחה עם ${chatPartnerName}</h3>
                                    <button onclick="goTo('profile', { userId: recipientId })" class="text-sm text-kesher-primary hover:underline">
                                        <i class="fa-solid fa-user-circle ml-1"></i> פרופיל
                                    </button>
                                </div>

                                <!-- הודעות הצ'אט -->
                                <div id="chatMessages" class="chat-messages flex-grow p-4 space-y-4">
                                    ${sortedMessages.length > 0 ? sortedMessages.reverse().map(msg => `
                                        <div class="flex ${msg.senderId === state.user.id ? 'justify-end' : 'justify-start'}">
                                            <div class="max-w-xs md:max-w-md lg:max-w-lg p-3 rounded-xl shadow-sm ${msg.senderId === state.user.id ? 'bg-kesher-primary text-white rounded-bl-none' : 'bg-gray-200 text-gray-800 rounded-br-none'}">
                                                <p class="text-sm">${msg.content}</p>
                                                <span class="text-xs opacity-75 block text-left mt-1">${formatRelativeTime(msg.createdAt)}</span>
                                            </div>
                                        </div>
                                    `).join('') : '<p class="text-center text-gray-500 pt-10">התחל שיחה חדשה!</p>'}
                                </div>

                                <!-- טופס שליחת הודעה -->
                                <form id="chatForm" class="p-4 border-t bg-gray-50">
                                    <div class="flex">
                                        <input type="text" id="messageInput" placeholder="הקלד הודעה..." required class="flex-grow ml-2">
                                        <button type="submit" class="bg-kesher-secondary hover:bg-kesher-primary text-white py-2 px-4 rounded-lg transition">
                                            <i class="fa-solid fa-paper-plane"></i>
                                        </button>
                                    </div>
                                </form>
                            ` : `
                                <div class="flex-grow flex items-center justify-center text-gray-500 text-lg">
                                    <i class="fa-solid fa-message text-4xl mr-2"></i> בחר חבר להתחיל שיחה.
                                </div>
                            `}
                        </div>
                    </main>
                </div>
            `;
        }

        /**
         * רכיב: מסך פרופיל משתמש
         */
        function renderProfile() {
            const userId = state.currentData?.userId || state.user.id;
            const profileUser = state.users.find(u => u.id === userId);

            if (!profileUser) return goTo('home');

            const isCurrentUser = profileUser.id === state.user.id;

            return `
                <div class="flex flex-col h-full">
                    ${renderHeader()}
                    
                    <main class="flex-grow p-4 overflow-y-auto flex justify-center">
                        <div class="w-full max-w-2xl card mt-6 p-8 text-center">
                            <div class="mb-6">
                                <i class="fa-solid fa-circle-user text-kesher-secondary text-8xl mb-4"></i>
                                <h2 class="text-3xl font-bold text-kesher-text mb-1">${profileUser.displayName || 'משתמש חדש'}</h2>
                                <p class="text-gray-500">${profileUser.email}</p>
                                <span class="inline-block mt-2 px-3 py-1 text-sm rounded-full font-semibold ${profileUser.isOnline ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-700'}">
                                    ${profileUser.isOnline ? 'מחובר עכשיו' : 'לא מחובר'}
                                </span>
                            </div>
                            
                            <!-- פרטים נוספים (לצפייה עצמית) -->
                            ${isCurrentUser ? `
                                <div class="text-right border-t pt-4 mt-4">
                                    <h3 class="text-xl font-bold text-kesher-primary mb-3">הגדרות אישיות</h3>
                                    <div class="space-y-3 text-lg">
                                        <p class="flex justify-between items-center border-b pb-2">
                                            <span class="font-medium text-gray-600">תפקיד:</span> 
                                            <span class="font-semibold">${profileUser.role || 'חבר קהילה'}</span>
                                        </p>
                                        <p class="flex justify-between items-center border-b pb-2">
                                            <span class="font-medium text-gray-600">תאריך הצטרפות:</span> 
                                            <span class="font-semibold">${formatRelativeTime(profileUser.createdAt)}</span>
                                        </p>
                                        
                                        <button onclick="document.getElementById('editProfileModal').classList.remove('hidden')" class="btn-primary bg-kesher-secondary mt-4">
                                            <i class="fa-solid fa-edit ml-2"></i> ערוך פרופיל
                                        </button>
                                    </div>
                                </div>
                            ` : `
                                <button onclick="goTo('chat', { recipientId: profileUser.id })" class="btn-primary bg-kesher-secondary mt-4 max-w-sm mx-auto">
                                    <i class="fa-solid fa-comment ml-2"></i> שלח הודעה פרטית
                                </button>
                            `}
                        </div>
                    </main>
                </div>
                
                <!-- מודאל עריכת פרופיל (למשתמש הנוכחי בלבד) -->
                <div id="editProfileModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
                    <div class="card w-full max-w-md">
                        <h3 class="text-2xl font-bold mb-4">עריכת הפרופיל שלי</h3>
                        <form id="editProfileForm">
                            <div class="mb-4">
                                <label for="editDisplayName" class="block font-medium mb-1">שם תצוגה</label>
                                <input type="text" id="editDisplayName" value="${profileUser.displayName || ''}" required>
                            </div>
                            <div class="flex justify-end space-x-2 space-x-reverse">
                                <button type="button" onclick="document.getElementById('editProfileModal').classList.add('hidden')" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">בטל</button>
                                <button type="submit" class="bg-kesher-primary hover:bg-kesher-secondary text-white font-bold py-2 px-4 rounded-lg transition">שמור שינויים</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
        }
        
        // רכיב רינדור למסך כניסה/הרשמה/טעינה/שגיאה
        function renderAuthScreen(mode) {
            // mode: 'login', 'register', 'loading', 'error'
            const isLogin = mode === 'login';
            const isRegister = mode === 'register';

            if (mode === 'loading') {
                 return `
                    <div class="auth-container">
                        <div class="card w-full max-w-sm text-center">
                            <i class="fa-solid fa-spinner fa-spin text-6xl text-kesher-secondary mb-4"></i>
                            <h1 class="text-2xl font-bold mb-2">טוען את קהילת קשר...</h1>
                            <p class="text-gray-600 mb-4">אנא המתן.</p>
                        </div>
                    </div>
                `;
            }
            if (mode === 'error') {
                 return `
                    <div class="auth-container">
                        <div class="card w-full max-w-sm text-center">
                            <i class="fa-solid fa-triangle-exclamation text-6xl text-red-500 mb-4"></i>
                            <h1 class="text-2xl font-bold mb-2">שגיאה קריטית</h1>
                            <p class="text-gray-600 mb-4">כשל בטעינת האפליקציה או בחיבור לשרת.</p>
                            <button onclick="window.location.reload()" class="btn-primary bg-gray-500 hover:bg-gray-600">
                                רענן ונסה שוב
                            </button>
                        </div>
                    </div>
                `;
            }
            
            return `
                <div class="auth-container">
                    <div class="card w-full max-w-sm">
                        <div class="text-center mb-6">
                            <h1 class="auth-title ${isLogin ? 'text-kesher-primary' : 'text-kesher-secondary'}">קהילת קשר</h1>
                            <p class="text-gray-500">${isLogin ? 'התחבר לחשבונך' : 'צור חשבון חדש'}</p>
                        </div>
                        <form id="${isLogin ? 'loginForm' : 'registerForm'}">
                            ${isRegister ? `
                                <div class="mb-4">
                                    <label for="registerDisplayName" class="block text-sm font-medium mb-1">שם מלא/כינוי</label>
                                    <input type="text" id="registerDisplayName" placeholder="שם מלא או כינוי" required>
                                </div>
                            ` : ''}
                            <div class="mb-4">
                                <label for="${mode}Email" class="block text-sm font-medium mb-1">דוא"ל</label>
                                <input type="email" id="${mode}Email" placeholder="example@gmail.com" required>
                            </div>
                            <div class="mb-6">
                                <label for="${mode}Password" class="block text-sm font-medium mb-1">סיסמה</label>
                                <input type="password" id="${mode}Password" placeholder="******" required minlength="6">
                            </div>
                            
                            ${isRegister ? `
                                <div class="flex items-start mb-4">
                                    <input type="checkbox" id="agreeTerms" required class="mt-1 ml-2">
                                    <label for="agreeTerms" class="text-sm">אני מאשר את <a href="#" onclick="alert('בבקשה קרא את תנאי השימוש כאן...')" class="text-kesher-primary font-bold hover:underline">תנאי השימוש</a></label>
                                </div>
                            ` : ''}

                            <button type="submit" class="btn-primary ${isLogin ? 'bg-kesher-primary' : 'bg-kesher-secondary'} hover:opacity-80">
                                <i class="fa-solid ${isLogin ? 'fa-right-to-bracket' : 'fa-user-plus'} ml-2"></i> ${isLogin ? 'התחברות' : 'הירשם'}
                            </button>
                        </form>
                        <div class="text-center mt-6 text-sm">
                            <p>
                                ${isLogin ? 'אין לך חשבון? ' : 'יש לך כבר חשבון? '}
                                <a href="#" onclick="goTo('${isLogin ? 'register' : 'login'}')" class="text-kesher-secondary font-bold hover:underline">
                                    ${isLogin ? 'הירשם עכשיו' : 'התחבר'}
                                </a>
                            </p>
                        </div>
                    </div>
                </div>
            `;
        }

        /**
         * פונקציה ראשית: מעדכנת את תוכן ה-DOM בהתאם למצב הנוכחי (state.screen)
         */
        function render() {
            const app = document.getElementById('app');
            if (!app) return console.error("Element #app not found!");

            let htmlContent = '';
            // קביעת התוכן לפי המסך
            switch (state.screen) {
                case 'login':
                case 'register':
                case 'loading':
                case 'error':
                    htmlContent = renderAuthScreen(state.screen);
                    break;
                case 'home':
                    if (state.user) { htmlContent = renderHome(); } else { return goTo('login'); }
                    break;
                case 'forum':
                    if (state.user) { htmlContent = renderForum(); } else { return goTo('login'); }
                    break;
                case 'chatList': // רשימת צ'אטים כללית
                case 'chat': // צ'אט ספציפי
                    if (state.user) { htmlContent = renderChat(); } else { return goTo('login'); }
                    break;
                case 'profile':
                    if (state.user) { htmlContent = renderProfile(); } else { return goTo('login'); }
                    break;
                default:
                    // מסך שגיאה אם המסך לא מוגדר
                    htmlContent = renderAuthScreen('error');
                    break;
            }

            app.innerHTML = htmlContent;
            
            // --- Attach Event Listeners ---
            // חובה לחבר את הלוגיקה לאחר הוספת ה-HTML ל-DOM
            if (state.screen === 'login') {
                document.getElementById('loginForm')?.addEventListener('submit', handleLogin);
            } else if (state.screen === 'register') {
                 document.getElementById('registerForm')?.addEventListener('submit', handleRegister);
            } else if (state.screen === 'forum') {
                 document.getElementById('newPostForm')?.addEventListener('submit', handleNewPost);
            } else if (state.screen === 'chat' && state.currentRecipientId) {
                 document.getElementById('chatForm')?.addEventListener('submit', handleNewChatMessage);
            } else if (state.screen === 'profile' && state.users.find(u => u.id === state.currentData?.userId)?.id === state.user.id) {
                 document.getElementById('editProfileForm')?.addEventListener('submit', handleEditProfile);
            }
        }
        
        /* ====================== CRUD Handlers (טיפול בפעולות נתונים) ====================== */
        
        async function handleNewPost(e) {
            e.preventDefault();
            const title = e.target.postTitle.value;
            const content = e.target.postContent.value;
            const forumId = state.currentForum.id;

            try {
                // הוספת הפוסט לקולקציה המתאימה
                await db.collection('forums').doc(forumId).collection('posts').add({
                    title: title,
                    content: content,
                    authorId: state.user.id,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    commentCount: 0,
                    forumId: forumId 
                });
                
                // עדכון מונה פוסטים בפורום הראשי (אופציונלי, מומלץ Cloud Function)
                db.collection('forums').doc(forumId).update({
                    postCount: firebase.firestore.FieldValue.increment(1)
                }).catch(e=>console.warn('Could not update forum post count', e));
                
                // איפוס טיוטה וסגירת המודאל
                state.draft.newPostTitle = '';
                state.draft.newPostText = '';
                document.getElementById('newPostModal').classList.add('hidden');
                alert("הפוסט פורסם בהצלחה!");
                // ה-Listener ל-forumPosts יעדכן את המסך
            } catch (error) {
                alert("שגיאה בפרסום פוסט: " + error.message);
            }
        }

        async function handleNewChatMessage(e) {
            e.preventDefault();
            const messageInput = document.getElementById('messageInput');
            const content = messageInput.value.trim();
            
            if (!content || !state.currentRecipientId || !state.user) return;

            const recipientId = state.currentRecipientId;
            const senderId = state.user.id;

            // יצירת ID עקבי לחדר הצ'אט (ממוין לפי ID)
            const chatIds = [senderId, recipientId].sort();
            const chatId = chatIds.join('_');
            
            try {
                // שליחת ההודעה לקולקציית ההודעות בתוך הצ'אט
                await db.collection('chats').doc(chatId).collection('messages').add({
                    content: content,
                    senderId: senderId,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    read: false // סימון כ"לא נקרא"
                });

                // עדכון הצ'אט הראשי (לצורך רשימת הצ'אטים)
                await db.collection('chats').doc(chatId).set({
                    participants: chatIds,
                    lastMessage: content,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    // עדכון מונה הודעות שלא נקראו (אופציונלי, עדיף Cloud Function)
                    unread: { [recipientId]: firebase.firestore.FieldValue.increment(1) }
                }, { merge: true }); // משתמשים ב-merge כדי לא למחוק שדות קיימים
                
                messageInput.value = ''; // ניקוי הקלט
                
                // הגלילה כלפי מטה (למעלה בגלל direction: column-reverse)
                setTimeout(() => {
                    const messagesDiv = document.getElementById('chatMessages');
                    if (messagesDiv) messagesDiv.scrollTop = 0;
                }, 50);

            } catch (error) {
                console.error("שגיאה בשליחת הודעה:", error);
                alert("שגיאה בשליחת ההודעה.");
            }
        }
        
        async function handleEditProfile(e) {
            e.preventDefault();
            const displayName = e.target.editDisplayName.value;
            
            try {
                // עדכון ב-Auth
                await auth.currentUser.updateProfile({ displayName: displayName });
                
                // עדכון ב-Firestore
                await db.collection('users').doc(state.user.id).update({
                    displayName: displayName
                });
                
                // עדכון ה-State המקומי
                state.user.displayName = displayName;
                
                document.getElementById('editProfileModal').classList.add('hidden');
                alert("הפרופיל עודכן בהצלחה!");
                render(); // רנדור מחדש להצגת השם החדש
            } catch (error) {
                alert("שגיאה בעדכון הפרופיל: " + error.message);
            }
        }


        /* ====================== Auth & Listener Handlers (לוגיקת כניסה ורישום) ====================== */
        
        async function handleLogin(e) {
            e.preventDefault();
            const email = e.target.loginEmail.value;
            const password = e.target.loginPassword.value;
            
            try {
                await auth.signInWithEmailAndPassword(email, password);
            } catch (error) {
                alert("שגיאת התחברות: " + error.message);
            }
        }
        
        async function handleRegister(e) {
            e.preventDefault();
            const displayName = e.target.registerDisplayName.value;
            const email = e.target.registerEmail.value;
            const password = e.target.registerPassword.value;

            try {
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                
                // יצירת מסמך המשתמש
                await db.collection('users').doc(userCredential.user.uid).set({
                    displayName: displayName,
                    email: email,
                    role: 'user', 
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    isOnline: true,
                    isActive: true,
                });
                
                await userCredential.user.updateProfile({ displayName: displayName });
                alert("ההרשמה בוצעה בהצלחה! ברוך הבא לקהילה.");
            } catch (error) {
                alert("שגיאת רישום: " + error.message);
            }
        }

        /* ====================== Realtime Listeners (מאזינים לשינויים) ====================== */
        
        // מאזינים שמורים כדי שנוכל לבטל אותם כשיוצאים ממסך
        let unsubscribeForum = null;
        let unsubscribeChat = null;
        let unsubscribeUsers = null;

        function attachRealtimeListeners() {
            // 1. מאזין קבוע לכל המשתמשים (כדי לדעת מי אונליין)
            if (unsubscribeUsers) unsubscribeUsers();
            unsubscribeUsers = db.collection('users').onSnapshot(snapshot => {
                state.users = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                // אם אנחנו במסך הבית או הצ'אט, נרנדר מחדש
                if (state.screen === 'home' || state.screen === 'chat') {
                    render();
                }
            }, error => console.error("שגיאה במאזין משתמשים:", error));


            // 2. מאזין לפוסטים בפורום ספציפי
            if (state.screen === 'forum' && state.currentForum) {
                if (unsubscribeForum) unsubscribeForum();
                
                const forumId = state.currentForum.id;
                unsubscribeForum = db.collection('forums').doc(forumId).collection('posts')
                    .orderBy('createdAt', 'desc') // ממוין לפי חדש קודם
                    .onSnapshot(snapshot => {
                        state.forumPosts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        render(); // רנדור מחדש של מסך הפורום
                    }, error => console.error(`שגיאה במאזין פורום ${forumId}:`, error));
            } else if (unsubscribeForum) {
                unsubscribeForum(); // ביטול אם לא במסך פורום
                unsubscribeForum = null;
            }

            // 3. מאזין להודעות בצ'אט ספציפי
            if (state.screen === 'chat' && state.currentRecipientId && state.user) {
                if (unsubscribeChat) unsubscribeChat();

                const chatIds = [state.user.id, state.currentRecipientId].sort();
                const chatId = chatIds.join('_');

                unsubscribeChat = db.collection('chats').doc(chatId).collection('messages')
                    .orderBy('createdAt', 'desc') // חדש קודם
                    .limit(50) // הגבלת הודעות
                    .onSnapshot(snapshot => {
                        state.chatMessages = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        render(); // רנדור מחדש של מסך הצ'אט
                        
                         // גלילה למטה (למעלה בגלל direction: column-reverse)
                        const messagesDiv = document.getElementById('chatMessages');
                        if (messagesDiv) messagesDiv.scrollTop = 0;
                        
                    }, error => console.error(`שגיאה במאזין צ'אט ${chatId}:`, error));

            } else if (unsubscribeChat) {
                unsubscribeChat(); // ביטול אם לא במסך צ'אט
                unsubscribeChat = null;
            }
        }


        /* ====================== App Init ====================== */
        
        async function initializeApp() {
            
            // **שלב 1: אחזור נתונים ראשוניים קריטיים**
            try {
                await fetchInitialData(); 
            } catch (error) {
                console.error("שגיאה קריטית בטעינת נתונים ראשוניים:", error);
                state.screen = 'error'; 
                render();
                return; 
            }
            
            // **שלב 2: הגדרת המאזין לשינוי סטטוס משתמש**
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    // **המשתמש מחובר**
                    try {
                        const userDoc = state.users.find(u => u.id === user.uid);

                        if (userDoc && userDoc.isActive !== false) {
                            state.user = { id: user.uid, ...userDoc };
                            
                            // עדכון סטטוס מחובר (IsOnline) ב-Firestore (לא ממתין)
                            db.collection('users').doc(user.uid).update({ isOnline: true }).catch(e=>console.warn('Cannot update online status', e));

                            // התחלת מאזינים בזמן אמת (פורומים, צ'אטים וכו')
                            attachRealtimeListeners();
                            
                            // ניתוב לבית או רנדור מחדש
                            if (state.screen === 'login' || state.screen === 'register' || state.screen === 'loading') {
                                goTo('home');
                            } else {
                                render();
                            }

                        } else {
                            // המשתמש לא קיים במסמך users
                            auth.signOut();
                        }
                    } catch (error) {
                        console.error("שגיאה קריטית באחזור פרופיל משתמש:", error);
                        state.user = null;
                        goTo('login');
                    }
                } else {
                    // **המשתמש לא מחובר או יצא**
                    if(state.user && state.user.id){
                        // עדכון סטטוס לא מחובר
                         db.collection('users').doc(state.user.id).update({ isOnline: false }).catch(e=>console.warn('Cannot update offline status', e));
                    }
                    state.user = null;
                    
                    // ביטול מאזינים
                    if (unsubscribeForum) unsubscribeForum();
                    if (unsubscribeChat) unsubscribeChat();
                    // לא מבטלים את unsubscribeUsers כי צריך אותו כדי לטעון את רשימת המשתמשים מחדש
                    
                    // ניתוב לכניסה
                    if (state.screen !== 'register') {
                        goTo('login');
                    } else {
                        render();
                    }
                }
            });
        }

        // הפעלת האפליקציה לאחר טעינת כל ה-DOM
        window.addEventListener('load', ()=>{
          // 1. רנדור ראשוני של מסך 'טעינה'
          state.screen = 'loading'; 
          render(); 
          
          // 2. הפעלת לוגיקת האתחול האסינכרונית
          initializeApp();
          
          // 3. עדכון תקופתי בטוח של ספירת הודעות שלא נקראו
          // פונקציה זו דורשת לוגיקה מורכבת ב-Firestore (מונים בצ'אט) שאני לא מממש כאן במלואה
          // ניתן לממש אותה באמצעות מאזין ל-db.collection('chats')...
          // setInterval(()=>{ 
          //     if(state.user) updateUnreadTotal().catch(()=>{}); 
          // }, 25000);
        });
    </script>
</body>
</html>
