<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×§×”×™×œ×ª ×§×©×¨ | ×”×—×™×™× ×”×˜×•×‘×™×</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <style>
        /* --- 1. ×¢×™×¦×•×‘ ×—×“×© ×•×¦×‘×¢×•× ×™ (××•×ª×× ×œ×§×”×œ ××‘×•×’×¨) --- */
        :root {
            --kesher-primary: #FF6B6B; /* Vibrant Coral - ×—×, ×× ×¨×’×˜×™ */
            --kesher-secondary: #4ECDC4; /* Bright Aqua/Teal - ××¨×¢× ×Ÿ, ×‘×”×™×¨ */
            --kesher-accent: #FFCD00; /* Gold/Yellow - ××•×¤×˜×™××™×•×ª, × ×™×§×•×“ */
            --kesher-text: #333;
        }
        .bg-kesher-primary { background-color: var(--kesher-primary); }
        .hover\:bg-kesher-primary:hover { background-color: #e56060; }
        .text-kesher-primary { color: var(--kesher-primary); }
        
        .bg-kesher-secondary { background-color: var(--kesher-secondary); }
        .hover\:bg-kesher-secondary:hover { background-color: #40b0aa; }
        .text-kesher-secondary { color: var(--kesher-secondary); }

        body {
            background-color: #f7f7f7; /* ×¨×§×¢ ×‘×”×™×¨ ×•× ×¢×™× */
            font-family: 'Arial', sans-serif;
        }
        #root {
            min-height: 100vh;
            padding-bottom: 4rem;
        }
    </style>
</head>
<body>
    <div id="root" class="pt-16">
        <div id="loading-spinner" class="flex justify-center items-center min-h-screen">
             <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-kesher-primary"></div>
             <p class="text-kesher-primary text-lg mr-4">×˜×•×¢×Ÿ × ×ª×•× ×™×...</p>
        </div>
    </div>

    <script>
        // --- 1. ×”×’×“×¨×•×ª Firebase ×•××™×—×–×•×¨ × ×ª×•× ×™× ---
        
        // **×•×•×“× ×©×–×”×• ×”-CONFIG ×”××“×•×™×§ ×©×œ×š!**
        const firebaseConfig = {
            apiKey: "AIzaSyCrcxC420HW5PXGNd8M4KuclUkiJSwHreM", 
            authDomain: "kesher-bakir.firebaseapp.com",
            projectId: "kesher-bakir",
            storageBucket: "kesher-bakir.firebasestorage.app",
            messagingSenderId: "671996189455",
            appId: "1:671996189455:web:dbe089d69a85a2ab38fc7a",
            measurementId: "G-42EWSKFXW" 
        };
        
        // ××ª×—×•×œ Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        
        const auth = firebase.auth();
        const db = firebase.firestore();

        // ××¦×‘ ×’×œ×•×‘×œ×™ (State Management)
        const state = {
            user: null, 
            screen: 'loading', // ×”×ª×—×œ ×‘-loading
            users: [], 
            forums: [],
            activities: [],
            reports: [],
            
            // --- ×—×“×©: × ×ª×•× ×™× ×œ×¦'××˜ ---
            unreadCounts: {}, // { 'chat_room_id': count }
            
            // ××©×ª× ×™× ×¡×¤×¦×™×¤×™×™× ×œ××¡×š
            currentForumId: null,
            currentPost: null,
            currentPostReplies: [],
            selectedUser: null,
            chatMessages: [],
            usersFilter: { city: '', role: '', hobby: '' },
        };
        
        // --- ×¨×©×™××ª ×”××œ×¦×•×ª ×™×•××™×ª ---
        const DAILY_RECOMMENDATIONS = [
            "×¦××• ×œ×˜×™×•×œ ×§×¦×¨ ×©×œ 30 ×“×§×•×ª ×‘×©××©! â˜€ï¸ ×—×™×•× ×™ ×œ×•×•×™×˜××™×Ÿ D ×•×œ××¦×‘ ×¨×•×— ×˜×•×‘.",
            "×”×ª×§×©×¨×• ×”×™×•× ×œ×—×‘×¨ ×•×ª×™×§ ×©×œ× ×“×™×‘×¨×ª× ××™×ª×• ×–××Ÿ ×¨×‘. ğŸ“ ×§×©×¨×™× ×—×‘×¨×ª×™×™× ×”× ×”××¤×ª×— ×œ××•×©×¨.",
            "×”×™×•× × ×¡×• ×œ××›×•×œ ×™×¨×§×•×ª ×™×¨×•×§×™× ×›×”×™×. ğŸ¥¦ ×”× ×¢×©×™×¨×™× ×‘×¡×™×“×Ÿ ×•×‘×¨×™××™× ×œ×œ×‘.",
            "×œ××“×• ××™×œ×” ×—×“×©×” ××• ×¢×•×‘×“×” ×”×™×¡×˜×•×¨×™×ª ××¢× ×™×™× ×ª. ğŸ§  ×©××¨×• ×¢×œ ×”××•×— ×—×“ ×•×¤×¢×™×œ.",
            "×”×©×§×™×¢×• 15 ×“×§×•×ª ×‘××“×™×˜×¦×™×” ××• × ×©×™××•×ª ×¢××•×§×•×ª. ğŸ§˜ ×–×” ××•×¨×™×“ ×œ×—×¥ ×“× ×•××—×–×§ ××ª ×”× ×¤×©.",
            "×¡×“×¨×• ××’×™×¨×” ××—×ª ×§×˜× ×” ×‘×‘×™×ª. ××¨×’×•×Ÿ ××©×—×¨×¨ ×•××‘×™× ×¡×™×¤×•×§! âœ¨",
            "×›×ª×‘×• 3 ×“×‘×¨×™× ×©××ª× ××¡×™×¨×™ ×ª×•×“×” ×¢×œ×™×”× ×”×™×•×. ğŸ™ ×ª×¨×’×•×œ ×”×›×¨×ª ×ª×•×“×” ××©×¤×¨ ××ª ××™×›×•×ª ×”×—×™×™×."
        ];
        
        /**
         * ×¤×•× ×§×¦×™×” ×œ×—×™×©×•×‘ ×”×”××œ×¦×” ×”×™×•××™×ª (××©×ª× ×” ×›×œ ×™×•×)
         */
        function getDailyRecommendation() {
            const today = new Date();
            const dayOfYear = Math.floor((today - new Date(today.getFullYear(), 0, 0)) / 1000 / 60 / 60 / 24);
            const index = dayOfYear % DAILY_RECOMMENDATIONS.length;
            return DAILY_RECOMMENDATIONS[index];
        }
        
        /**
         * ×¤×•× ×§×¦×™×™×ª ×¢×–×¨ ×œ×™×™×¦×•×¨ ID ×—×“×¨ ×¦'××˜ ×¢×§×‘×™ (A_B ××• B_A)
         */
        function getChatRoomId(uid1, uid2) {
             if (!uid1 || !uid2) {
                console.error("×©×’×™××”: ×—×¡×¨ UID ×œ×¦×•×¨×š ×™×¦×™×¨×ª ×—×“×¨ ×¦'××˜.", { uid1, uid2 });
                return null; 
            }
            return uid1 < uid2 ? `${uid1}_${uid2}` : `${uid2}_${uid1}`;
        }

        /**
         * ××—×–×•×¨ × ×ª×•× ×™× ×¨××©×•× ×™ ×-Firestore (×—×™×•× ×™ ×œ×× ×™×¢×ª ×”××¡×š ×”×œ×‘×Ÿ)
         */
        async function fetchInitialData() {
            // ×˜×¢×™× ×ª × ×ª×•× ×™× ×¤×™×§×˜×™×‘×™×™× ×§×•×“×
            loadFakeForumData(false); 
            
            try {
                // 1. ××—×–×•×¨ ×¨×©×™××ª ××©×ª××©×™×
                const usersSnapshot = await db.collection('users').get();
                state.users = usersSnapshot.docs.map(doc => ({ 
                    id: doc.id, 
                    ...doc.data(), 
                    isOnline: doc.data().isOnline || false,
                    role: doc.data().role || 'user',
                    isActive: doc.data().isActive !== false // ×”×•×¡×¤×ª ×©×“×” isActive
                }));
                
                // 2. ××—×–×•×¨ ×¤×¢×™×œ×•×™×•×ª
                const activitiesSnapshot = await db.collection('activities').get();
                state.activities = activitiesSnapshot.docs.map(doc => ({ 
                    id: doc.id, 
                    ...doc.data(),
                    date: doc.data().date?.toDate() || new Date() 
                }));

                // 3. ××—×–×•×¨ ××•× ×” ×”×•×“×¢×•×ª ×©×œ× × ×§×¨××• - **×¨×§ ×× ×”××©×ª××© ××—×•×‘×¨**
                if (state.user && state.user.id) {
                    const myChatsSnapshot = await db.collection('chats')
                        .where('participants', 'array-contains', state.user.id)
                        .get();

                    state.unreadCounts = {};
                    for (const chatDoc of myChatsSnapshot.docs) {
                        const unreadCountForMe = chatDoc.data()[`unread_${state.user.id}`] || 0;
                        if (unreadCountForMe > 0) {
                            state.unreadCounts[chatDoc.id] = unreadCountForMe;
                        }
                    }
                }
                
            } catch (error) {
                console.error("×©×’×™××” ×‘××—×–×•×¨ × ×ª×•× ×™× ×-Firebase. ×˜×•×¢×Ÿ × ×ª×•× ×™× ×¤×™×§×˜×™×‘×™×™× ××œ××™×:", error);
                loadFakeForumData(true); 
            }
        }
        
        // ×¤×•× ×§×¦×™×™×ª ×˜×¢×™× ×ª × ×ª×•× ×™× ×¤×™×§×˜×™×‘×™×™× ×œ××‘× ×™× (×¤×•×¨×•×, ×¤×¢×™×œ×•×™×•×ª)
        function loadFakeForumData(forceUserFakes = false) {
            const now = firebase.firestore.Timestamp.now();
            const post1Replies = [
                { id: 'r1', content: '××¡×›×™×! ×”×—×©×™×¤×” ×œ××ª× ×“×‘×™× ×—×“×©×™× ×”×™× ××ª×’×¨ ×××™×ª×™.', creatorId: 'user2', creatorName: '×“× ×™××œ ×›×”×Ÿ', createdAt: now },
                { id: 'r2', content: '××•×œ×™ ×›×“××™ ×œ×™×¦×•×¨ ×“×£ × ×—×™×ª×” ×™×™×¢×•×“×™?', creatorId: 'user1', creatorName: '××•×¨×™×ª ×œ×•×™', createdAt: now },
            ];
            state.forums = [
                { id: 'f1', title: '×”×ª× ×“×‘×•×ª ×•×§×”×™×œ×”', description: '×“×™×•× ×™× ×¢×œ ×™×•×–××•×ª ×—×‘×¨×ª×™×•×ª ×—×“×©×•×ª.', icon: '<i class="fa-solid fa-users"></i>', posts: [
                    { id: 'p1', title: '××™×š ××’×™×™×¡×™× ××ª× ×“×‘×™× ×—×“×©×™×?', content: '×× ×™ ×× ×”×œ ×§×‘×•×¦×” ×§×˜× ×” ×•××—×¤×© ×“×¨×›×™× ×™×¦×™×¨×ª×™×•×ª ×œ×’×™×™×¡ ×¢×•×“ ×—×‘×¨×™× ×¤×¢×™×œ×™×.', creatorId: 'user1', creatorName: '××•×¨×™×ª ×œ×•×™', createdAt: now, likes: ['user2', 'user3'], replies: post1Replies },
                ]},
                { id: 'f2', title: '×˜×™×•×œ×™× ×•×˜×‘×¢', description: '××¡×œ×•×œ×™× ××•××œ×¦×™× ×•×¦×™×•×“ ×§××¤×™× ×’.', icon: '<i class="fa-solid fa-mountain-sun"></i>', posts: [] },
                { id: 'f3', title: '×‘×¨×™××•×ª ×•×›×•×©×¨', description: '×˜×™×¤×™× ×•×“×™×•× ×™× ×¢×œ ×©××™×¨×” ×¢×œ ×›×•×©×¨ ×‘×’×™×œ ×”×©×œ×™×©×™.', icon: '<i class="fa-solid fa-heart-pulse"></i>', posts: [] },
            ];
            if (forceUserFakes || state.users.length === 0) {
                 // **×—×©×•×‘: ×× Firebase ×œ× ×¢×•×‘×“, ×”××©×ª××©×™× ×”×¤×™×§×˜×™×‘×™×™× ×”××œ×” × ×˜×¢× ×™×**
                 state.users = [
                    { id: 'user1', name: '××•×¨×™×ª ×œ×•×™', email: 'orit@example.com', city: '×ª×œ ××‘×™×‘', role: 'admin', points: 150, isOnline: true, hobbies: ['×‘×™×©×•×œ', '×˜×™×•×œ×™×'], contributions: ['×™×™×¢×•×¥ ×¢×¡×§×™', '××¨×’×•×Ÿ ××™×¨×•×¢×™×'], isActive: true },
                    { id: 'user2', name: '×“× ×™××œ ×›×”×Ÿ', email: 'daniel@example.com', city: '×™×¨×•×©×œ×™×', role: 'senior', points: 300, isOnline: false, hobbies: ['×¡×¤×•×¨×˜', '×¦×™×œ×•×'], contributions: ['×¢×–×¨×” ×˜×›× ×™×ª', '×”×“×¨×›×”'], isActive: true },
                    { id: 'user3', name: '×××™×” ××œ×•×Ÿ', email: 'maya@example.com', city: '×—×™×¤×”', role: 'user', points: 900, isOnline: true, hobbies: ['×¦×™×œ×•×', '××¤×™×™×”'], contributions: ['× ×™×”×•×œ ×§×”×™×œ×”', '×’×¨×¤×™×§×”'], isActive: true },
                    { id: 'user4', name: '×™×•×¡×£ ××•×©×”×”', email: 'yosef@example.com', city: '×—×™×¤×”', role: 'user', points: 10, isOnline: false, hobbies: ['×©×—××˜'], contributions: ['×¤× ×¡×™×”'], isActive: false },
                ];
                // ×× ×× ×—× ×• ×‘×˜×¢×™× ×” ×¤×™×§×˜×™×‘×™×ª, × ×˜×¢×Ÿ ×’× ×¤×¢×™×œ×•×™×•×ª ×¤×™×§×˜×™×‘×™×•×ª ×× ×œ× × ×˜×¢× ×• ×-Firebase
                if (state.activities.length === 0) {
                     state.activities = [
                        { id: 'a1', title: '×˜×™×•×œ ×¨×’×œ×™ ×‘×’×Ÿ ×”×‘×•×˜× ×™', description: '××¡×œ×•×œ ×§×œ ××ª××™× ×œ×›×•×œ×.', date: new Date(new Date().getTime() + 86400000 * 5), location: '×ª×œ ××‘×™×‘', creatorName: '××•×¨×™×ª ×œ×•×™', attendees: ['user1', 'user3'] },
                        { id: 'a2', title: '×¡×“× ×ª ××¤×™×™×” ×œ××ª×§×“××™×', description: '× ××¤×” ×¢×•×’×•×ª ×©××¨×™× ××™×•×—×“×•×ª.', date: new Date(new Date().getTime() + 86400000 * 10), location: '×™×¨×•×©×œ×™×', creatorName: '×××™×” ××œ×•×Ÿ', attendees: ['user3'] },
                    ];
                }
            }

            state.reports = [
                { id: 'rep1', itemId: 'p1', itemType: 'post', reason: '×©×¤×” ×‘×•×˜×”', reporterName: '×“× ×™××œ ×›×”×Ÿ', reportedUserId: 'user1', status: '×—×“×©' },
            ];
        }

        /**
         * ×¤×•× ×§×¦×™×™×ª × ×™×ª×•×‘ ×‘×¡×™×¡×™×ª
         */
        function goTo(screen, params = {}) {
            state.screen = screen;
            state.currentForumId = params.forumId || null;
            state.currentPost = null;
            state.currentPostReplies = [];
            state.selectedUser = null; 

            if (screen === 'forumPosts' && params.forumId) {
                state.currentForumId = params.forumId;
            } else if (screen === 'postDetails' && params.postId) {
                const forum = state.forums.find(f => f.posts?.some(p => p.id === params.postId));
                if (forum) {
                    state.currentPost = forum.posts.find(p => p.id === params.postId);
                    state.currentPostReplies = state.currentPost.replies || [];
                    state.currentForumId = forum.id;
                } else {
                    console.error('×©×’×™××”: ×”×¤×•×¡×˜ ×œ× × ××¦×', params.postId);
                    goTo('forums');
                }
            }
            render();
            // ×’×œ×™×œ×” ××•×˜×•××˜×™×ª ×œ××˜×” ×‘×¦'××˜ (××‘×•×¦×¢×ª ×©×•×‘ ×‘-openChat)
            if (screen === 'chat') {
                setTimeout(() => {
                    const chatBox = document.getElementById('chatBox');
                    if (chatBox) chatBox.scrollTop = chatBox.scrollHeight;
                }, 50);
            }
        }

        /**
         * ×¤×ª×™×—×ª ×¦'××˜ ×•××—×–×•×¨ ×”×•×“×¢×•×ª - **×”×¤×•× ×§×¦×™×” ×ª×•×§× ×” ×›×“×™ ×œ×× ×•×¢ ×§×¨×™×¡×” ×œ×“×£ ×œ×‘×Ÿ**
         */
        window.openChat = async (targetUser) => {
            // **×‘×“×™×§×ª × ×ª×•× ×™× ×§×¨×™×˜×™×ª ×œ×× ×™×¢×ª ×§×¨×™×¡×”**
            if (!state.user || !state.user.id || !targetUser || !targetUser.id) {
                console.error("×©×’×™××”: ×—×¡×¨ ××©×ª××© ××—×•×‘×¨ ××• ××©×ª××© ×™×¢×“ ×œ×¦'××˜.", { user: state.user, target: targetUser });
                alert("×©×’×™××” ×¤× ×™××™×ª: ×œ× × ×™×ª×Ÿ ×œ×¤×ª×•×— ×¦'××˜. ×—×¡×¨ ×¤×¨×˜×™ ××©×ª××©.");
                goTo('users');
                return;
            }

            state.selectedUser = targetUser;
            const chatRoomId = getChatRoomId(state.user.id, targetUser.id);
            state.chatMessages = [];
            
            if (!chatRoomId) {
                 console.error("×©×’×™××”: ×œ× × ×™×ª×Ÿ ×œ×™×¦×•×¨ Chat Room ID. ×—×•×–×¨ ×œ××¡×š ×—×‘×¨×™×.");
                 goTo('users');
                 return;
            }
            
            // **× ×™×ª×•×‘ ××™×™×“×™ ×œ××¡×š ×”×¦'××˜ ×¢× ×”×•×“×¢×ª ×˜×¢×™× ×”** - ××•× ×¢ ×“×£ ×œ×‘×Ÿ ×–×× ×™!
            goTo('chat'); 
            
            try {
                // ××—×–×•×¨ ×”×•×“×¢×•×ª ×§×•×“××•×ª
                const messagesSnapshot = await db.collection('chats').doc(chatRoomId)
                    .collection('messages').orderBy('timestamp').get();
                
                state.chatMessages = messagesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                // ×¡×™××•×Ÿ ×”×•×“×¢×•×ª ×›"× ×§×¨××•" (×©×œ ×”××©×ª××© ×”×©× ×™)
                const batch = db.batch();
                let unreadCountToClear = 0;
                messagesSnapshot.docs.forEach(doc => {
                    // ×•×“× ×©×”×©×“×•×ª ×§×™×™××™× ×œ×¤× ×™ ×”×’×™×©×”, ×•×›×Ÿ ××˜×¤×œ ×‘××§×¨×” ×©×œ 'read: undefined'
                    if (doc.data().senderId === targetUser.id && (doc.data().read === false || doc.data().read === undefined)) {
                        batch.update(doc.ref, { read: true });
                        unreadCountToClear++;
                    }
                });
                
                await batch.commit();

                // ×”×¡×¨×ª ××•× ×” ×”"×œ× × ×§×¨××•" ×”×’×œ×•×‘×œ×™ (Firestore)
                if (unreadCountToClear > 0) {
                    delete state.unreadCounts[chatRoomId];
                    await db.collection('chats').doc(chatRoomId).update({ 
                        [`unread_${state.user.id}`]: 0 
                    });
                }
                
                // ×¨× ×“×•×¨ ××—×“×© ×¢× ×”×”×•×“×¢×•×ª ×©× ×˜×¢× ×•
                render(); 

            } catch (error) {
                // **×–×” ×”×‘×œ×•×§ ×©×¦×¨×™×š ×œ×‘×“×•×§ ×× ×”×•× ×§×•×¨×”**
                console.error("×©×’×™××” ×§×¨×™×˜×™×ª ×‘×˜×¢×™× ×ª ×¦'××˜ (Firestore/Config/Rules):", error);
                
                // **×˜×™×¤×•×œ ×—×–×§ ×‘×©×’×™××” ×œ×× ×™×¢×ª ×§×¨×™×¡×”**
                // ×”×¦×’×ª ×”×•×“×¢×” ×¤×™×§×˜×™×‘×™×ª ×¢× ×©×’×™××” ×‘××§×•× ×”×”×•×“×¢×•×ª
                state.chatMessages = [{ 
                    id: 'm0', 
                    senderId: targetUser.id, 
                    content: `**×©×’×™××ª ×—×™×‘×•×¨!** ×œ× × ×™×ª×Ÿ ×œ×˜×¢×•×Ÿ ×”×•×“×¢×•×ª ××”×©×¨×ª. ×™×™×ª×›×Ÿ ×©×™×© ×‘×¢×™×” ×‘×”×’×“×¨×•×ª Firebase (Rules/Config). ×× × × ×¡×” ×©×•×‘.`, 
                    timestamp: firebase.firestore.Timestamp.now() 
                }];
                // ×•×•×“× ×©× ×©××¨×™× ×‘××¡×š ×”×¦'××˜ ×›×“×™ ×©×”××©×ª××© ×™×¨××” ××ª ×”×©×’×™××”
                render();
            }
            
            // ×’×œ×™×œ×” ××•×˜×•××˜×™×ª ×œ×ª×—×ª×™×ª ×”×¦'××˜
            setTimeout(() => {
                const chatBox = document.getElementById('chatBox');
                if (chatBox) chatBox.scrollTop = chatBox.scrollHeight;
            }, 50);
        };


        // --- 2. ×¤×•× ×§×¦×™×•×ª Firebase (×”×ª×—×‘×¨×•×ª, ×¨×™×©×•×, ×©×—×–×•×¨) ---
        
        window.doLogin = async () => {
            const email = document.getElementById('email').value;
            const password = document.getElementById('pwd').value;
            const errorElement = document.getElementById('loginError');
            errorElement.textContent = '';
            
            try {
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                const user = userCredential.user;
                const userDoc = await db.collection('users').doc(user.uid).get();
                
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    
                    // ×‘×“×™×§×ª ×¡×˜×˜×•×¡ ×”×©×¢×™×” (isActive: false)
                    if (userData.isActive === false) {
                        errorElement.textContent = '×—×©×‘×•× ×š ××•×©×”×” ×¢×œ ×™×“×™ ×× ×”×œ ×”××¢×¨×›×ª.';
                        auth.signOut();
                        return;
                    }

                    state.user = { 
                        id: user.uid, 
                        email: user.email, 
                        name: userData.name, 
                        role: userData.role || 'user', 
                        points: userData.points || 0,
                        hobbies: userData.hobbies || [], 
                        contributions: userData.contributions || [],
                        isActive: userData.isActive !== false
                    };
                    await fetchInitialData(); 
                    goTo('home');
                } else {
                    errorElement.textContent = '×©×’×™××”: ×”×¤×¨×•×¤×™×œ ×œ× × ××¦× ×‘××¡×“ ×”× ×ª×•× ×™×.';
                    auth.signOut();
                }
            } catch (error) {
                errorElement.textContent = `×©×’×™××ª ×”×ª×—×‘×¨×•×ª: ${error.message}`;
            }
        };

        window.doRegister = async () => {
            const name = document.getElementById('regName').value;
            const email = document.getElementById('regEmail').value;
            const password = document.getElementById('regPwd').value;
            const city = document.getElementById('regCity').value;
            const hobbiesInput = document.getElementById('regHobbies').value;
            const contributionsInput = document.getElementById('regContributions').value;
            const errorElement = document.getElementById('registerError');
            errorElement.textContent = '';
            if (!name || !email || !password || !city || !hobbiesInput || !contributionsInput) {
                errorElement.textContent = '×™×© ×œ××œ× ××ª ×›×œ ×”×©×“×•×ª.';
                return;
            }
            
            const hobbiesArray = hobbiesInput.split(',').map(item => item.trim()).filter(item => item !== '');
            const contributionsArray = contributionsInput.split(',').map(item => item.trim()).filter(item => item !== '');

            try {
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;
                
                const newUserData = {
                    name: name,
                    city: city,
                    role: 'user', // ×‘×¨×™×¨×ª ××—×“×œ: ××©×ª××© ×¨×’×™×œ
                    points: 0,
                    isOnline: true,
                    isActive: true, // ××©×ª××© ×—×“×© ×¤×¢×™×œ ×›×‘×¨×™×¨×ª ××—×“×œ
                    hobbies: hobbiesArray, 
                    contributions: contributionsArray,
                    email: email,
                    joinDate: firebase.firestore.FieldValue.serverTimestamp()
                };
                await db.collection('users').doc(user.uid).set(newUserData);
                
                state.user = { id: user.uid, email: user.email, ...newUserData };
                await fetchInitialData();
                goTo('home');
                
            } catch (error) {
                 errorElement.textContent = `×©×’×™××ª ×¨×™×©×•×: ${error.message}`;
            }
        };

        window.doLogout = () => {
            auth.signOut().then(() => {
                state.user = null;
                goTo('login');
            });
        };


        // --- 3. ×¤×•× ×§×¦×™×•×ª ×¢×–×¨ ×•××™× ×˜×¨××§×¦×™×” ---
        
        /**
         * ×¤×•× ×§×¦×™×™×ª ×©×œ×™×—×ª ×”×•×“×¢×” - ×©××™×¨×” ×‘-Firestore
         */
        window.sendMessage = async () => {
            const input = document.getElementById('chatInput');
            const content = input.value.trim();
            if (!content || !state.selectedUser || !state.user || !state.user.id) return;
            
            const chatRoomId = getChatRoomId(state.user.id, state.selectedUser.id);
            const receiverId = state.selectedUser.id;
            
            if (!chatRoomId) {
                alert("×©×’×™××” ×¤× ×™××™×ª: ×œ× × ×™×ª×Ÿ ×œ×©×œ×•×— ×”×•×“×¢×”.");
                return;
            }

            const newMessage = {
                senderId: state.user.id,
                content: content,
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                read: false,
            };
            
            try {
                // ×”×•×¡×¤×ª ×”×”×•×“×¢×” ×œ××•×¡×£ Messages
                const messageRef = await db.collection('chats').doc(chatRoomId).collection('messages').add(newMessage);
                
                // ×¢×“×›×•×Ÿ (××• ×™×¦×™×¨×ª) ××¡××š ×”×¦'××˜ ×”×¨××©×™
                await db.collection('chats').doc(chatRoomId).set({
                    participants: [state.user.id, receiverId],
                    lastMessage: content,
                    lastMessageTime: firebase.firestore.FieldValue.serverTimestamp(),
                    [`unread_${receiverId}`]: firebase.firestore.FieldValue.increment(1), // ×”×’×“×œ×ª ××•× ×” ×”×”×•×“×¢×•×ª ×©×œ× × ×§×¨××•
                }, { merge: true });

                // ×¢×“×›×•×Ÿ ×”-state ×”××§×•××™ ×•×”×¦×’×” ××™×™×“×™×ª
                state.chatMessages.push({ id: messageRef.id, ...newMessage, timestamp: firebase.firestore.Timestamp.now() });
                input.value = '';
                // ×’×œ×™×œ×” ×œ×ª×—×ª×™×ª ×”×¦'××˜ ×‘××•×¤×Ÿ ××™×™×“×™
                setTimeout(() => {
                    const chatBox = document.getElementById('chatBox');
                    if (chatBox) chatBox.scrollTop = chatBox.scrollHeight;
                }, 0); 
                render(); 
            } catch (error) {
                console.error("×©×’×™××” ×‘×©×œ×™×—×ª ×”×•×“×¢×” (Firebase/Config):", error);
                alert("×©×’×™××” ×‘×©×œ×™×—×ª ×”×”×•×“×¢×”. ×‘×“×•×§ ××ª ×”×—×™×‘×•×¨ ×œ-Firebase ×•×›×œ×œ×™ ×”××‘×˜×—×”.");
            }
        };

        window.createPost = () => { alert('×”×¤×•× ×§×¦×™×” ×œ×™×¦×™×¨×ª ×¤×•×¡×˜ ×˜×¨× ××•××©×” ×‘××•×¤×Ÿ ××œ×.'); };
        window.addReply = () => { alert('×”×¤×•× ×§×¦×™×” ×œ×”×•×¡×¤×ª ×ª×’×•×‘×” ×˜×¨× ××•××©×” ×‘××•×¤×Ÿ ××œ×.'); };
        window.toggleLike = (postId) => { alert('×”×¤×•× ×§×¦×™×” ×œ×œ×™×™×§ ×˜×¨× ××•××©×” ×‘××•×¤×Ÿ ××œ×.'); };
        window.createActivity = async () => { alert('×”×¤×•× ×§×¦×™×” ×œ×™×¦×™×¨×ª ×¤×¢×™×œ×•×ª ×˜×¨× ××•××©×” ×‘××•×¤×Ÿ ××œ×.'); };
        window.registerForActivity = async (activityId) => { alert('×”×”×¨×©××” ×œ×¤×¢×™×œ×•×ª ×˜×¨× ××•××©×” ×‘××•×¤×Ÿ ××œ×.'); };
        window.reportItem = (itemId, itemType, reportedUserId) => { alert(`×“×•×•×— ×¢×œ ${itemType} (ID: ${itemId}) ×¢×§×‘ ×ª×•×›×Ÿ ×œ× ×¨××•×™. ×ª×•×“×” ×¢×œ ×”×“×™×•×•×—!`); };
        window.updateReportStatus = (reportId, newStatus) => { alert(`×¡×˜×˜×•×¡ ×”×“×™×•×•×— ${reportId} ×¢×•×“×›×Ÿ ×œ: ${newStatus}`); };

        /**
         * ×¤×•× ×§×¦×™×™×ª ××—×™×§×ª ×¤×•×¡×˜ (×¢× ×”×¨×©××•×ª)
         */
        window.deletePost = async (postId) => {
            if (state.user.role !== 'admin' && state.user.role !== 'senior') {
                alert('××™×Ÿ ×œ×š ×”×¨×©××” ×œ××—×•×§ ×¤×•×¡×˜×™×.');
                return;
            }
            if (!confirm("×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×”×¤×•×¡×˜ ×”×–×”?")) return;

            // ×¢×“×›×•×Ÿ ×”-state ×”××§×•××™
            const forum = state.forums.find(f => f.posts?.some(p => p.id === postId));
            if (forum) {
                forum.posts = forum.posts.filter(p => p.id !== postId);
                state.currentPost = null;
                alert('×”×¤×•×¡×˜ × ××—×§ ×‘×”×¦×œ×—×”.');
                goTo('forumPosts', { forumId: forum.id });
                // ×‘××¢×¨×›×ª ×××™×ª×™×ª, × ××—×§ ×›××Ÿ ×-Firestore
            }
        };

        /**
         * ×¤×•× ×§×¦×™×™×ª ×¢×“×›×•×Ÿ ×“×¨×’×ª ××©×ª××© (×‘××¡×š × ×™×”×•×œ)
         */
        window.updateUserRole = async (userId, newRole) => {
            if (state.user.role !== 'admin') {
                alert('×¨×§ ××“××™×Ÿ ×™×›×•×œ ×œ×©× ×•×ª ×“×¨×’×•×ª.');
                return;
            }
            if (userId === state.user.id) {
                alert('××™× ×š ×™×›×•×œ ×œ×©× ×•×ª ××ª ×”×“×¨×’×” ×©×œ ×¢×¦××š.');
                return;
            }
            
            try {
                await db.collection('users').doc(userId).update({ role: newRole });
                const userToUpdate = state.users.find(u => u.id === userId);
                if (userToUpdate) {
                    userToUpdate.role = newRole;
                    alert(`×“×¨×’×ª ×”××©×ª××© ${userToUpdate.name} ×¢×•×“×›× ×” ×œ: ${newRole}`);
                }
                render();
            } catch (error) {
                console.error("×©×’×™××” ×‘×¢×“×›×•×Ÿ ×“×¨×’×”:", error);
                alert("×©×’×™××” ×‘×¢×“×›×•×Ÿ ×“×¨×’×” ×‘-Firestore. ×‘×“×•×§ ××ª ×”×—×™×‘×•×¨ ×•×›×œ×œ×™ ×”××‘×˜×—×”.");
            }
        };

        /**
         * ××—×™×§×ª ××©×ª××© ×œ×¦××™×ª×•×ª (Admin only)
         */
        window.deleteUser = async (userId, userName) => {
            if (state.user.role !== 'admin') {
                alert('×¨×§ ××“××™×Ÿ ×™×›×•×œ ×œ××—×•×§ ××©×ª××©×™×.');
                return;
            }
            if (userId === state.user.id) {
                alert('××™× ×š ×™×›×•×œ ×œ××—×•×§ ××ª ×”×—×©×‘×•×Ÿ ×©×œ×š ×“×¨×š ×”×××©×§ ×”×–×”.');
                return;
            }
            if (!confirm(`×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ×œ×¦××™×ª×•×ª ××ª ×”××©×ª××© ${userName}? ×¤×¢×•×œ×” ×–×• ×‘×œ×ª×™ ×”×¤×™×›×”.`)) return;

            try {
                // **×”×¢×¨×” ×—×©×•×‘×”: ××—×™×§×” ×××™×ª×™×ª ×©×œ ××©×ª××© Auth ×“×•×¨×©×ª ×¤×•× ×§×¦×™×™×ª ×¦×“ ×©×¨×ª (Cloud Function)**
                // ×‘××•×“×œ ×”× ×•×›×—×™, × ×¡××Ÿ ××•×ª×• ×›'××—×§' ×‘-Firestore ×•× ××ª×—×œ ××ª ×”-state.
                await db.collection('users').doc(userId).delete();
                
                // ×¢×“×›×•×Ÿ ×”-state ×”××§×•××™
                state.users = state.users.filter(u => u.id !== userId);
                alert(`×”××©×ª××© ${userName} × ××—×§ ×‘×”×¦×œ×—×” (×-Firestore ×‘×œ×‘×“).`);
                render();
            } catch (error) {
                console.error("×©×’×™××” ×‘××—×™×§×ª ××©×ª××©:", error);
                alert("×©×’×™××” ×‘××—×™×§×ª ×”××©×ª××©. ×‘×“×•×§ ×›×œ×œ×™ ××‘×˜×—×”.");
            }
        };

        /**
         * ×”×©×”×™×” ××• ×”×¤×¢×œ×” ××—×“×© ×©×œ ××©×ª××© (Admin only)
         */
        window.toggleUserActive = async (userId, userName, isActive) => {
            if (state.user.role !== 'admin') {
                alert('×¨×§ ××“××™×Ÿ ×™×›×•×œ ×œ×”×©×”×•×ª ××©×ª××©×™×.');
                return;
            }
            const newStatus = isActive ? false : true; // ×× ×¤×¢×™×œ ×›×¨×’×¢, ×”×¤×•×š ×œ×œ× ×¤×¢×™×œ (false)
            const actionText = newStatus ? '×”×¤×¢×œ×” ××—×“×©' : '×”×©×”×™×”';
            
            if (!confirm(`×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ×‘×¦×¢ ${actionText} ×œ××©×ª××© ${userName}?`)) return;

            try {
                // ×¢×“×›×•×Ÿ ×©×“×” ×—×“×© ×‘-Firestore ×©×™×¡××Ÿ ×× ×”××©×ª××© ×™×›×•×œ ×œ×”×ª×—×‘×¨
                await db.collection('users').doc(userId).update({ isActive: newStatus });
                
                // ×¢×“×›×•×Ÿ ×”-state ×”××§×•××™
                const userToUpdate = state.users.find(u => u.id === userId);
                if (userToUpdate) {
                    userToUpdate.isActive = newStatus;
                }
                alert(`×”××©×ª××© ${userName} ×¢×•×“×›×Ÿ ×œ×¡×˜×˜×•×¡: ${newStatus ? '×¤×¢×™×œ' : '××•×©×”×”'}`);
                render();
            } catch (error) {
                console.error("×©×’×™××” ×‘×¢×“×›×•×Ÿ ×¡×˜×˜×•×¡ ××©×ª××©:", error);
                alert("×©×’×™××” ×‘×¢×“×›×•×Ÿ ×¡×˜×˜×•×¡ ×”××©×ª××©. ×‘×“×•×§ ×›×œ×œ×™ ××‘×˜×—×”.");
            }
        };
        

        function timeSince(date) { 
             const seconds = Math.floor((new Date() - date) / 1000);
            let interval = seconds / 31536000;
            if (interval > 1) return Math.floor(interval) + " ×©× ×™×";
            interval = seconds / 2592000;
            if (interval > 1) return Math.floor(interval) + " ×—×•×“×©×™×";
            interval = seconds / 86400;
            if (interval > 1) return Math.floor(interval) + " ×™××™×";
            interval = seconds / 3600;
            if (interval > 1) return Math.floor(interval) + " ×©×¢×•×ª";
            interval = seconds / 60;
            if (interval > 1) return Math.floor(interval) + " ×“×§×•×ª";
            return "×¢×›×©×™×•";
        }


        // --- 4. ×¨×›×™×‘×™× ×—×–×•×ª×™×™× (Rendering Components) ---

        const getHeader = () => {
            if (!state.user) return '';

            const isCurrent = (screen) => state.screen === screen ? 'bg-white text-kesher-primary shadow-md' : 'text-white hover:bg-kesher-primary/80';
            const totalUnread = Object.values(state.unreadCounts).reduce((sum, count) => sum + count, 0);

            return `
                <header class="fixed top-0 left-0 right-0 bg-kesher-primary text-white shadow-lg z-50">
                    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                        <div class="flex items-center justify-between h-16">
                            <div class="flex items-center">
                                <span class="text-2xl font-bold">×§×”×™×œ×ª ×§×©×¨ <i class="fa-solid fa-seedling"></i></span>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="goTo('home')" class="px-3 py-2 rounded-lg font-medium transition ${isCurrent('home')}">
                                    <i class="fa-solid fa-house"></i> ×‘×™×ª
                                </button>
                                <button onclick="goTo('users')" class="relative px-3 py-2 rounded-lg font-medium transition ${isCurrent('users') || isCurrent('chat')}">
                                    <i class="fa-solid fa-user-group"></i> ×¦'××˜/×—×‘×¨×™×
                                    ${totalUnread > 0 ? `<span class="absolute top-0 right-0 inline-flex items-center justify-center px-2 py-1 text-xs font-bold leading-none text-white transform translate-x-1/2 -translate-y-1/2 bg-kesher-accent rounded-full">${totalUnread}</span>` : ''}
                                </button>
                                <button onclick="goTo('forums')" class="px-3 py-2 rounded-lg font-medium transition ${isCurrent('forums') || isCurrent('forumPosts') || isCurrent('newPost') || isCurrent('postDetails')}">
                                    <i class="fa-solid fa-comments"></i> ×¤×•×¨×•××™×
                                </button>
                                <button onclick="goTo('activities')" class="px-3 py-2 rounded-lg font-medium transition ${isCurrent('activities') || isCurrent('newActivity')}">
                                    <i class="fa-solid fa-calendar-check"></i> ×¤×¢×™×œ×•×™×•×ª
                                </button>
                                ${state.user.role === 'admin' ? `
                                    <button onclick="goTo('admin')" class="px-3 py-2 rounded-lg font-medium transition ${isCurrent('admin')} bg-red-700 hover:bg-red-800">
                                        <i class="fa-solid fa-shield-halved"></i> × ×™×”×•×œ
                                    </button>
                                ` : ''}
                            </div>
                            <div class="flex items-center gap-4">
                                <span class="text-sm font-medium"><i class="fa-solid fa-user"></i> ${state.user.name}</span>
                                <button onclick="doLogout()" class="bg-kesher-secondary hover:bg-teal-600 text-white px-3 py-1 rounded-full transition text-sm">×™×¦×™××”</button>
                            </div>
                        </div>
                    </div>
                </header>
            `;
        };
        
        const renderLoading = () => {
             return `
                <div class="flex justify-center items-center min-h-screen">
                     <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-kesher-primary"></div>
                     <p class="text-kesher-primary text-lg mr-4">×˜×•×¢×Ÿ × ×ª×•× ×™×...</p>
                </div>
             `;
        }

        const renderLogin = () => {
            return `
                <div class="flex items-center justify-center min-h-screen bg-gray-100 p-4 pt-16">
                    <div class="w-full max-w-md bg-white p-8 rounded-2xl shadow-2xl">
                        <h2 class="text-4xl font-extrabold text-center text-kesher-primary mb-2">×‘×¨×•×›×™× ×”×‘××™× ×œ×§×”×™×œ×ª ×§×©×¨</h2>
                        <p class="text-center text-gray-500 mb-8"><i class="fa-solid fa-heart"></i> ××™×¤×” ×©×”×—×™×™× ×”×˜×•×‘×™× ××ª×—×™×œ×™×</p>
                        <form onsubmit="event.preventDefault(); doLogin()" class="space-y-6">
                            <div>
                                <label for="email" class="block text-sm font-medium text-gray-700">×“×•×"×œ</label>
                                <input type="email" id="email" class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:ring-kesher-primary focus:border-kesher-primary" required>
                            </div>
                            <div>
                                <label for="pwd" class="block text-sm font-medium text-gray-700">×¡×™×¡××”</label>
                                <input type="password" id="pwd" class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:ring-kesher-primary focus:border-kesher-primary" required>
                            </div>
                            <p id="loginError" class="text-red-600 text-sm text-center"></p>
                            <button type="submit" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-md text-lg font-bold text-white bg-kesher-secondary hover:bg-teal-600 transition">
                                ×”×ª×—×‘×¨
                            </button>
                            <button type="button" onclick="alert('×©×—×–×•×¨ ×¡×™×¡××”...')" class="w-full text-sm text-kesher-primary hover:text-red-700 mt-2">
                                ×©×›×—×ª×™ ×¡×™×¡××”
                            </button>
                        </form>
                        <div class="mt-6 text-center">
                            <p class="text-sm text-gray-600">
                                ××™×Ÿ ×œ×š ×—×©×‘×•×Ÿ?
                                <button onclick="goTo('register')" class="font-medium text-kesher-primary hover:text-red-700">×”×™×¨×©× ×›××Ÿ</button>
                            </p>
                        </div>
                        <div class="mt-8 p-4 bg-yellow-50 border border-yellow-200 rounded-lg text-sm text-gray-700">
                            **×‘×“×™×§×”:** × ×¡×” ×œ×”×ª×—×‘×¨ ×¢×: <br>
                            ××“××™×Ÿ: **orit@example.com** / **123456** (×× ×”× ×ª×•× ×™× ×”×¤×™×§×˜×™×‘×™×™× × ×˜×¢× ×•)
                        </div>
                    </div>
                </div>
            `;
        };

        const renderRegister = () => { 
             return `
                <div class="flex items-center justify-center min-h-screen bg-gray-100 p-4 pt-16">
                    <div class="w-full max-w-md bg-white p-8 rounded-2xl shadow-2xl">
                        <h2 class="text-4xl font-extrabold text-center text-kesher-primary mb-8">×”×¨×©××” ×œ×§×”×™×œ×”</h2>
                        <form onsubmit="event.preventDefault(); doRegister()" class="space-y-6">
                            <div>
                                <label for="regName" class="block text-sm font-medium text-gray-700">×©× ××œ×</label>
                                <input type="text" id="regName" class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm" required>
                            </div>
                            <div>
                                <label for="regEmail" class="block text-sm font-medium text-gray-700">×“×•×"×œ</label>
                                <input type="email" id="regEmail" class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm" required>
                            </div>
                            <div>
                                <label for="regPwd" class="block text-sm font-medium text-gray-700">×¡×™×¡××” (6 ×ª×•×•×™× ×œ×¤×—×•×ª)</label>
                                <input type="password" id="regPwd" class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm" required>
                            </div>
                            <div>
                                <label for="regCity" class="block text-sm font-medium text-gray-700">×¢×™×¨ ××’×•×¨×™×</label>
                                <input type="text" id="regCity" class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm" required>
                            </div>
                            
                            <div>
                                <label for="regHobbies" class="block text-sm font-medium text-gray-700">×ª×—×‘×™×‘×™× (×”×¤×¨×“ ×‘×¤×¡×™×§, ×œ×“×•×’××”: ×¡×¤×•×¨×˜, ×‘×™×©×•×œ)</label>
                                <input type="text" id="regHobbies" placeholder="×œ×“×•×’××”: ×’×™× ×•×Ÿ, ×§×¨×™××”, ×˜×™×•×œ×™×" class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm" required>
                            </div>
                            
                            <div>
                                <label for="regContributions" class="block text-sm font-medium text-gray-700">×ª×—×•××™× ×‘×”× ×× ×™ ×™×›×•×œ/×” ×œ×ª×¨×•× (×”×¤×¨×“ ×‘×¤×¡×™×§, ×œ×“×•×’××”: ×™×™×¢×•×¥ ××©×¤×˜×™, × ×’×¨×•×ª)</label>
                                <input type="text" id="regContributions" placeholder="×œ×“×•×’××”: ×¢×–×¨×” ×˜×›× ×™×ª, ×©×™×¢×•×¨×™ ×¢×–×¨, ×™×™×¢×•×¥" class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm" required>
                            </div>

                            <p id="registerError" class="text-red-600 text-sm text-center"></p>
                            <button type="submit" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-md text-lg font-bold text-white bg-kesher-primary hover:bg-red-700 transition">
                                ×”×©×œ× ×”×¨×©××”
                            </button>
                        </form>
                        <div class="mt-6 text-center">
                            <p class="text-sm text-gray-600">
                                ×›×‘×¨ ×™×© ×œ×š ×—×©×‘×•×Ÿ?
                                <button onclick="goTo('login')" class="font-medium text-kesher-secondary hover:text-teal-700">×”×ª×—×‘×¨ ×›××Ÿ</button>
                            </p>
                        </div>
                    </div>
                </div>
            `;
        };

        const renderHome = () => {
            // ×¡×™× ×•×Ÿ ××©×ª××©×™× ×©×”×•×©×¢×• (isActive: false)
            const onlineUsers = (state.users || []).filter(u => u.isOnline && u.id !== state.user.id && u.isActive !== false);
            const myActivities = (state.activities || []).filter(a => a.attendees?.includes(state.user.id));
            const dailyRec = getDailyRecommendation();

            return `
                ${getHeader()}
                <div class="max-w-6xl mx-auto px-4 mt-8">
                    <h2 class="text-3xl font-bold text-gray-800 mb-8">
                        <i class="fa-solid fa-hand"></i> ×‘×¨×•×š ×”×‘×, ${state.user.name}! 
                        <span class="text-base font-normal text-gray-500">(${state.user.role === 'admin' ? '×× ×”×œ' : state.user.role === 'senior' ? '×‘×›×™×¨' : '××©×ª××© ×¨×’×™×œ'})</span>
                    </h2>

                    <div class="bg-kesher-secondary text-white p-5 rounded-2xl shadow-xl mb-8 flex items-center justify-between">
                        <div>
                            <h3 class="text-xl font-bold mb-1"><i class="fa-solid fa-book-open-reader"></i> ×”×”××œ×¦×” ×”×™×•××™×ª ×©×œ× ×• ×œ×—×™×™× ×‘×¨×™××™×:</h3>
                            <p class="text-lg font-medium">${dailyRec}</p>
                        </div>
                        <img src="https://picsum.photos/seed/happy-senior/100/100" alt="×©××—×”" class="rounded-full w-16 h-16 object-cover hidden sm:block"/>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        
                        <div class="bg-kesher-primary text-white p-6 rounded-2xl shadow-xl lg:col-span-1 flex flex-col justify-between">
                            <h3 class="text-2xl font-bold mb-2"><i class="fa-solid fa-star"></i> ×”× ×™×§×•×“ ×©×œ×™</h3>
                            <p class="text-5xl font-extrabold mb-4">${state.user.points || 0}</p>
                            <p class="text-sm">×¦×‘×•×¨ × ×§×•×“×•×ª ×¢×œ ×™×“×™ ×ª×’×•×‘×•×ª ×•×¢×–×¨×” ×œ××—×¨×™×.</p>
                        </div>

                        <div class="bg-white p-6 rounded-2xl shadow-xl lg:col-span-2">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-xl font-bold text-kesher-primary"><i class="fa-solid fa-user-group"></i> ×—×‘×¨×™× ××—×•×‘×¨×™× ( ${onlineUsers.length} )</h3>
                                <button onclick="goTo('users')" class="text-kesher-primary hover:text-red-700 text-sm font-medium">×”×¦×’ ××ª ×›×œ ×”×—×‘×¨×™× <i class="fa-solid fa-arrow-right"></i></button>
                            </div>
                            <div class="space-y-3 max-h-48 overflow-y-auto">
                                ${onlineUsers.length > 0 ? onlineUsers.slice(0, 5).map(u => `
                                    <button onclick="openChat({ id: '${u.id}', name: '${u.name}' })" class="flex items-center gap-2 p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100 transition w-full text-right">
                                        <div class="w-2 h-2 bg-kesher-secondary rounded-full shrink-0"></div>
                                        <span class="text-sm font-medium">${u.name} (${u.city})</span>
                                    </button>
                                `).join('') : '<p class="text-gray-500">××™×Ÿ ×—×‘×¨×™× ××—×•×‘×¨×™× ×›×¨×’×¢.</p>'}
                            </div>
                        </div>

                        <div class="lg:col-span-3 bg-white p-6 rounded-2xl shadow-xl">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-xl font-bold text-kesher-secondary"><i class="fa-solid fa-comments"></i> ×¤×•×¨×•××™× ×¤×•×¤×•×œ×¨×™×™×</h3>
                                <button onclick="goTo('forums')" class="text-kesher-secondary hover:text-teal-700 text-sm font-medium">×”×›×œ <i class="fa-solid fa-arrow-right"></i></button>
                            </div>
                            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4">
                                ${state.forums.slice(0, 4).map(f => `
                                    <div onclick="goTo('forumPosts', { forumId: '${f.id}' })" class="bg-gray-50 p-4 rounded-xl shadow-sm hover:shadow-md transition cursor-pointer text-center">
                                        <div class="text-3xl mb-2">${f.icon}</div>
                                        <p class="font-bold text-kesher-primary">${f.title}</p>
                                        <p class="text-xs text-gray-500">${f.description}</p>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <div class="lg:col-span-3 bg-white p-6 rounded-2xl shadow-xl">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-xl font-bold text-kesher-primary"><i class="fa-solid fa-calendar-check"></i> ×”×¤×¢×™×œ×•×™×•×ª ×”×§×¨×•×‘×•×ª ×©×œ×™</h3>
                                <button onclick="goTo('activities')" class="text-kesher-primary hover:text-red-700 text-sm font-medium">×”×¦×’ ×”×›×œ <i class="fa-solid fa-arrow-right"></i></button>
                            </div>
                            <div class="space-y-3">
                                ${myActivities.length > 0 ? myActivities.slice(0, 3).map(a => `
                                    <div class="bg-gray-50 p-3 rounded-lg flex justify-between items-center">
                                        <div>
                                            <p class="font-medium">${a.title}</p>
                                            <p class="text-xs text-gray-500"><i class="fa-solid fa-location-dot"></i> ${new Date(a.date).toLocaleDateString('he-IL')} - ${a.location}</p>
                                        </div>
                                        <span class="text-xs font-semibold px-3 py-1 rounded-full bg-kesher-secondary text-white">×¨×©×•×</span>
                                    </div>
                                `).join('') : '<p class="text-gray-500">×œ× × ×¨×©××ª ×œ×¤×¢×™×œ×•×™×•×ª ×§×¨×•×‘×•×ª.</p>'}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        };
        
        const renderUsers = () => {
             // ×¡×™× ×•×Ÿ ××©×ª××©×™× ×©×”×•×©×¢×• ××• ×œ× ×¤×¢×™×œ×™×
             const activeUsers = (state.users || []).filter(u => u.isActive !== false);

             const filteredUsers = activeUsers.filter(u => u.id !== state.user.id)
                .filter(u => !state.usersFilter.city || u.city === state.usersFilter.city)
                .filter(u => !state.usersFilter.role || u.role === state.usersFilter.role)
                .filter(u => !state.usersFilter.hobby || u.hobbies?.includes(state.usersFilter.hobby));
            
            const allCities = [...new Set((state.users || []).map(u => u.city).filter(c => c))];
            const allHobbies = [...new Set((state.users || []).flatMap(u => u.hobbies || []).filter(h => h))];

            return `
                ${getHeader()}
                <div class="max-w-6xl mx-auto px-4 mt-8">
                    <h2 class="text-3xl font-bold text-kesher-secondary mb-6"><i class="fa-solid fa-user-group"></i> ×—×‘×¨×™× ×‘×§×”×™×œ×” (${filteredUsers.length} × ××¦××•)</h2>
                    
                    <div class="bg-white p-4 rounded-xl shadow-md mb-6 flex flex-wrap gap-4 items-center">
                        <span class="font-medium text-gray-700">×¡×™× ×•×Ÿ:</span>
                        
                        <select onchange="state.usersFilter.city = this.value; render()" class="p-2 border rounded-lg">
                            <option value="">×›×œ ×”×¢×¨×™×</option>
                            ${allCities.map(c => `<option value="${c}" ${state.usersFilter.city === c ? 'selected' : ''}>${c}</option>`).join('')}
                        </select>
                        
                        <select onchange="state.usersFilter.role = this.value; render()" class="p-2 border rounded-lg">
                            <option value="">×›×œ ×”×ª×¤×§×™×“×™×</option>
                            <option value="user" ${state.usersFilter.role === 'user' ? 'selected' : ''}>××©×ª××© ×¨×’×™×œ</option>
                            <option value="senior" ${state.usersFilter.role === 'senior' ? 'selected' : ''}>××©×ª××© ×‘×›×™×¨</option>
                            <option value="admin" ${state.usersFilter.role === 'admin' ? 'selected' : ''}>×× ×”×œ</option>
                        </select>

                         <select onchange="state.usersFilter.hobby = this.value; render()" class="p-2 border rounded-lg">
                            <option value="">×›×œ ×”×ª×—×‘×™×‘×™×</option>
                            ${allHobbies.map(h => `<option value="${h}" ${state.usersFilter.hobby === h ? 'selected' : ''}>${h}</option>`).join('')}
                        </select>
                    </div>

                    <div class="space-y-4">
                        ${filteredUsers.map(u => {
                            const chatRoomId = getChatRoomId(state.user.id, u.id);
                            const unreadCount = state.unreadCounts[chatRoomId] || 0;
                            return `
                                <div class="bg-white p-6 rounded-xl shadow-md flex flex-col md:flex-row justify-between items-start md:items-center hover:shadow-lg transition">
                                    <div class="flex items-start gap-4 mb-4 md:mb-0">
                                        <div class="w-12 h-12 bg-gray-200 rounded-full flex items-center justify-center text-xl font-bold text-kesher-primary shrink-0">${u.name[0]}</div>
                                        <div class="flex-grow">
                                            <h3 class="text-xl font-bold text-gray-800">${u.name}</h3>
                                            <p class="text-sm text-gray-600"><i class="fa-solid fa-location-dot"></i> ${u.city} | <span class="font-bold text-kesher-secondary">${u.role === 'admin' ? '×× ×”×œ' : u.role === 'senior' ? '×‘×›×™×¨' : '××©×ª××© ×¨×’×™×œ'}</span></p>
                                            <div class="mt-2 text-xs">
                                                <p class="font-semibold text-kesher-secondary"><i class="fa-solid fa-heart"></i> ×ª×—×‘×™×‘×™×: <span class="font-normal text-gray-700">${u.hobbies?.join(', ') || '×œ× ×¦×•×™×Ÿ'}</span></p>
                                                <p class="font-semibold text-kesher-primary"><i class="fa-solid fa-handshake"></i> ×™×›×•×œ/×” ×œ×ª×¨×•×: <span class="font-normal text-gray-700">${u.contributions?.join(', ') || '×œ× ×¦×•×™×Ÿ'}</span></p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="flex gap-2 items-center">
                                        <span class="text-xs font-semibold px-3 py-1 rounded-full ${u.isOnline ? 'bg-kesher-secondary/20 text-kesher-secondary' : 'bg-gray-100 text-gray-500'}">${u.isOnline ? 'ğŸŸ¢ ××—×•×‘×¨' : 'âšª ×œ× ××—×•×‘×¨'}</span>
                                        <button onclick="openChat({ id: '${u.id}', name: '${u.name}' })" class="relative bg-kesher-primary hover:bg-red-700 text-white px-4 py-2 rounded-lg transition text-sm">
                                            <i class="fa-solid fa-comment-dots"></i> ×©×œ×— ×”×•×“×¢×”
                                            ${unreadCount > 0 ? `<span class="absolute top-0 right-0 inline-flex items-center justify-center px-2 py-1 text-xs font-bold leading-none text-kesher-primary transform translate-x-1/2 -translate-y-1/2 bg-kesher-accent rounded-full">${unreadCount}</span>` : ''}
                                        </button>
                                        <button onclick="reportItem('${u.id}', 'user', '${u.id}')" class="bg-red-100 text-red-700 hover:bg-red-200 px-3 py-2 rounded-lg transition text-sm"><i class="fa-solid fa-flag"></i> ×“×•×•×—</button>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        };

        const renderChat = () => {
            if (!state.selectedUser) { goTo('users'); return ''; }

            return `
                ${getHeader()}
                <div class="max-w-4xl mx-auto px-4 mt-8">
                    <div class="bg-white rounded-2xl shadow-xl overflow-hidden h-[70vh] flex flex-col">
                        <div class="bg-kesher-primary text-white p-4 flex justify-between items-center">
                            <h2 class="text-xl font-bold"><i class="fa-solid fa-comments"></i> ×¦'××˜ ×¢× ${state.selectedUser.name}</h2>
                            <button onclick="goTo('users')" class="bg-red-600 hover:bg-red-700 px-3 py-1 rounded transition text-sm">×—×–×¨×” ×œ×—×‘×¨×™×</button>
                        </div>
                        <div id="chatBox" class="flex-grow p-4 overflow-y-auto space-y-3">
                            ${state.chatMessages.map(msg => {
                                const isMe = msg.senderId === state.user.id;
                                const time = msg.timestamp && msg.timestamp.toDate ? new Date(msg.timestamp.toDate()).toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit' }) : '×¢×›×©×™×•';
                                
                                // ×‘×“×™×§×” ×× ×–×• ×”×•×“×¢×ª ×©×’×™××” ×§×¨×™×˜×™×ª
                                const isError = msg.content.includes('×©×’×™××ª ×—×™×‘×•×¨!');
                                
                                return `
                                    <div class="flex ${isMe ? 'justify-end' : 'justify-start'}">
                                        <div class="${isError ? 'bg-red-100 border border-red-400 text-red-800' : isMe ? 'bg-kesher-secondary text-white rounded-tr-none' : 'bg-gray-200 text-gray-800 rounded-tl-none'} max-w-xs p-3 rounded-xl shadow-md">
                                            <p class="text-sm">${msg.content}</p>
                                            <div class="text-xs mt-1 flex justify-between items-center">
                                                <span class="${isError ? 'text-red-500' : isMe ? 'text-teal-200' : 'text-gray-500'}">${time} ${isMe && msg.read ? 'âœ…' : isMe ? '...' : ''}</span>
                                                ${!isMe && !isError ? `<button onclick="reportItem('${msg.id}', 'message', '${msg.senderId}')" class="text-red-400 hover:text-red-600 mr-2"><i class="fa-solid fa-flag"></i> ×“×•×•×—</button>` : ''}
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        <div class="p-4 border-t flex gap-2">
                            <input type="text" id="chatInput" placeholder="×”×§×œ×“ ×”×•×“×¢×”..." class="flex-grow p-3 border-2 rounded-lg" onkeydown="if(event.key === 'Enter') sendMessage()" />
                            <button onclick="sendMessage()" class="bg-kesher-primary hover:bg-red-700 text-white px-4 py-3 rounded-lg font-bold">×©×œ×—</button>
                        </div>
                    </div>
                </div>
            `;
        };

        const renderForums = () => { 
            return `
                ${getHeader()}
                <div class="max-w-6xl mx-auto px-4 mt-8">
                    <h2 class="text-3xl font-bold text-kesher-secondary mb-6"><i class="fa-solid fa-comments"></i> ×¤×•×¨×•××™ ×§×”×™×œ×”</h2>
                    <div class="space-y-4">
                        ${state.forums.map(f => `
                            <div class="bg-white p-6 rounded-xl shadow-md flex justify-between items-center hover:shadow-lg transition">
                                <div>
                                    <h3 class="text-2xl font-bold text-gray-800">${f.icon} ${f.title}</h3>
                                    <p class="text-gray-600">${f.description}</p>
                                </div>
                                <div class="flex items-center gap-4">
                                    <button onclick="goTo('forumPosts', { forumId: '${f.id}' })" class="bg-kesher-primary hover:bg-red-700 text-white px-4 py-2 rounded-lg font-medium transition">×›× ×¡ ×œ×¤×•×¨×•×</button>
                                    ${state.user.role === 'admin' || state.user.role === 'senior' ? `
                                        <div class="flex gap-2 text-sm">
                                            <button onclick="alert('××—×™×§×ª ×¤×•×¨×•× ×“×•×¨×©×ª ××™×©×•×¨ (×œ×× ×”×œ×™×/×‘×›×™×¨×™× ×‘×œ×‘×“)')" class="text-red-500 hover:text-red-700"><i class="fa-solid fa-trash"></i> ××—×§</button>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        };

        const renderForumPosts = () => {
            const forum = state.forums.find(f => f.id === state.currentForumId);
            if (!forum) { goTo('forums'); return ''; }

            return `
                ${getHeader()}
                <div class="max-w-6xl mx-auto px-4 mt-8">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-3xl font-bold text-kesher-secondary">${forum.icon} ${forum.title}</h2>
                        <button onclick="alert('×™×¦×™×¨×ª ×¤×•×¡×˜ ×—×“×©')" class="bg-kesher-primary hover:bg-red-700 text-white px-4 py-2 rounded-lg font-medium transition"><i class="fa-solid fa-pen-to-square"></i> ×¤×ª×— × ×•×©× ×—×“×©</button>
                    </div>
                    ${forum.posts?.length > 0 ? `<div class="space-y-4">
                        ${forum.posts.map(p => `
                            <div onclick="goTo('postDetails', { postId: '${p.id}' })" class="bg-white p-5 rounded-xl shadow-md cursor-pointer hover:shadow-lg transition flex justify-between items-center">
                                <div>
                                    <h3 class="text-xl font-bold text-gray-800">${p.title}</h3>
                                    <p class="text-sm text-gray-600">× ×¤×ª×— ×¢×œ ×™×“×™: ${p.creatorName} | ×œ×¤× ×™: ${timeSince(p.createdAt.toDate())}</p>
                                </div>
                                <div class="flex gap-4 text-gray-500">
                                    <span><i class="fa-solid fa-heart"></i> ${p.likes?.length || 0}</span>
                                    <span><i class="fa-solid fa-comment-dots"></i> ${p.replies?.length || 0}</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>` : '<p class="text-center text-gray-500 p-8 bg-white rounded-xl shadow-md">××™×Ÿ ×¤×•×¡×˜×™× ×‘×¤×•×¨×•× ×–×” ×›×¨×’×¢. ×”×ª×—×œ ××ª ×”×“×™×•×Ÿ ×”×¨××©×•×Ÿ!</p>'}
                </div>
            `;
        };

        const renderPostDetails = () => {
            const post = state.currentPost;
            if (!post) { goTo('forums'); return ''; }
            
            const isLiked = post.likes?.includes(state.user.id);
            const likeIcon = isLiked ? '<i class="fa-solid fa-heart"></i>' : '<i class="fa-regular fa-heart"></i>';
            const likeColor = isLiked ? 'text-kesher-primary bg-kesher-primary/10' : 'text-gray-600 bg-gray-100';
            const canDelete = state.user.role === 'admin' || state.user.role === 'senior' || post.creatorId === state.user.id;
            const canDeleteReply = state.user.role === 'admin' || state.user.role === 'senior';


            return `
                ${getHeader()}
                <div class="max-w-4xl mx-auto px-4 mt-8">
                    <button onclick="goTo('forumPosts', { forumId: state.currentForumId })" class="text-kesher-secondary hover:text-teal-700 font-medium mb-4 flex items-center gap-1">
                        <i class="fa-solid fa-arrow-right-from-bracket rotate-180"></i> ×—×–×¨×” ×œ×¤×•×¨×•×
                    </button>
                    
                    <div class="bg-white p-6 rounded-2xl shadow-xl mb-6">
                        <h1 class="text-3xl font-extrabold text-gray-900 mb-2">${post.title}</h1>
                        <p class="text-sm text-gray-500 mb-4">× ×¤×ª×— ×¢×œ ×™×“×™: <span class="font-bold">${post.creatorName}</span> | ×œ×¤× ×™: ${timeSince(post.createdAt.toDate())}</p>
                        
                        <div class="prose max-w-none mb-6">
                            <p class="text-gray-700 whitespace-pre-wrap">${post.content}</p>
                        </div>

                        <div class="flex justify-between items-center border-t pt-4">
                            <div class="flex gap-4 items-center">
                                <button onclick="toggleLike('${post.id}')" class="flex items-center gap-2 p-2 rounded-full ${likeColor} font-bold transition text-sm">
                                    ${likeIcon} ×œ×™×™×§ (${post.likes?.length || 0})
                                </button>
                            </div>
                            <div class="flex gap-3 text-sm">
                                ${canDelete ? `<button onclick="deletePost('${post.id}')" class="text-red-500 hover:text-red-700"><i class="fa-solid fa-trash"></i> ××—×§</button>` : ''}
                                ${post.creatorId !== state.user.id ? `<button onclick="reportItem('${post.id}', 'post', '${post.creatorId}')" class="text-red-400 hover:text-red-600"><i class="fa-solid fa-flag"></i> ×“×•×•×—</button>` : ''}
                            </div>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-2xl shadow-xl mb-6">
                        <h3 class="text-xl font-bold text-kesher-primary mb-3">×”×•×¡×£ ×ª×’×•×‘×”:</h3>
                        <textarea id="replyContent" placeholder="×”×ª×’×•×‘×” ×©×œ×š..." rows="3" class="w-full p-3 border-2 rounded-lg mb-3"></textarea>
                        <button onclick="addReply()" class="bg-kesher-secondary hover:bg-teal-700 text-white px-4 py-2 rounded-lg font-bold">×©×œ×— ×ª×’×•×‘×”</button>
                    </div>

                    <h3 class="text-2xl font-bold text-gray-800 mb-4"><i class="fa-solid fa-reply-all"></i> ${state.currentPostReplies.length} ×ª×’×•×‘×•×ª</h3>
                    <div class="space-y-4">
                        ${state.currentPostReplies.map(r => `
                            <div class="bg-white p-4 rounded-xl shadow-md border-r-4 ${r.creatorId === post.creatorId ? 'border-kesher-accent' : 'border-gray-200'}">
                                <p class="font-medium mb-1">${r.creatorName} ${r.creatorId === post.creatorId ? ' (<i class="fa-solid fa-crown text-kesher-accent"></i> ×›×•×ª×‘ ×”×¤×•×¡×˜)' : ''}</p>
                                <p class="text-gray-700 whitespace-pre-wrap">${r.content}</p>
                                <div class="text-xs text-gray-500 mt-2 flex justify-between items-center">
                                    <span>${new Date(r.createdAt.toDate()).toLocaleString('he-IL')}</span>
                                    ${canDeleteReply ? 
                                        `<button onclick="alert('××—×™×§×ª ×ª×’×•×‘×”: ×× ×”×œ×™×/×‘×›×™×¨×™× ×™×›×•×œ×™× ×œ××—×•×§')" class="text-red-500 hover:text-red-700"><i class="fa-solid fa-trash"></i> ××—×§</button>` : 
                                        `<button onclick="reportItem('${r.id}', 'reply', '${r.creatorId}')" class="text-red-400 hover:text-red-600"><i class="fa-solid fa-flag"></i> ×“×•×•×—</button>`
                                    }
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        };
        
        const renderActivities = () => { 
             const upcomingActivities = (state.activities || []).sort((a, b) => a.date - b.date).filter(a => a.date >= new Date());
             const canDeleteActivity = state.user.role === 'admin' || state.user.role === 'senior';
             
             return `
                ${getHeader()}
                <div class="max-w-6xl mx-auto px-4 mt-8">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-3xl font-bold text-kesher-primary"><i class="fa-solid fa-calendar-check"></i> ×¤×¢×™×œ×•×™×•×ª ×§×”×™×œ×ª×™×•×ª</h2>
                        ${state.user.role === 'admin' || state.user.role === 'senior' ? `
                            <button onclick="alert('×™×¦×™×¨×ª ×¤×¢×™×œ×•×ª...')" class="bg-kesher-secondary hover:bg-teal-700 text-white px-4 py-2 rounded-lg font-medium transition"><i class="fa-solid fa-plus"></i> ×”×¦×¢ ×¤×¢×™×œ×•×ª</button>
                        ` : ''}
                    </div>
                    <div class="space-y-4">
                        ${upcomingActivities.length > 0 ? upcomingActivities.map(a => {
                            const isRegistered = a.attendees.includes(state.user.id);
                            const actionButton = isRegistered 
                                ? `<span class="text-sm font-semibold px-3 py-1 rounded-full bg-kesher-secondary text-white">×¨×©×•×</span>`
                                : `<button onclick="registerForActivity('${a.id}')" class="bg-kesher-primary hover:bg-red-700 text-white px-4 py-2 rounded-lg transition text-sm">×”×¨×©×</button>`;
                            
                            return `
                                <div class="bg-white p-6 rounded-xl shadow-md hover:shadow-lg transition flex flex-col md:flex-row justify-between items-start md:items-center">
                                    <div class="mb-4 md:mb-0">
                                        <h3 class="text-2xl font-bold text-gray-800">${a.title}</h3>
                                        <p class="text-sm text-gray-600 mb-2"><i class="fa-solid fa-location-dot"></i> ${a.location} | ×××¨×’×Ÿ: ${a.creatorName}</p>
                                        <p class="text-base font-medium text-kesher-secondary"><i class="fa-solid fa-clock"></i> ${new Date(a.date).toLocaleString('he-IL')}</p>
                                        <p class="mt-2 text-gray-700 whitespace-pre-wrap">${a.description}</p>
                                    </div>
                                    <div class="flex flex-col items-end gap-2 shrink-0">
                                        ${actionButton}
                                        <p class="text-xs text-gray-500"><i class="fa-solid fa-users"></i> ${a.attendees.length} × ×¨×©××•</p>
                                        ${canDeleteActivity ? `<button onclick="alert('××—×™×§×ª ×¤×¢×™×œ×•×ª: ×× ×”×œ×™×/×‘×›×™×¨×™× ×™×›×•×œ×™× ×œ××—×•×§')" class="text-xs text-red-500 hover:text-red-700"><i class="fa-solid fa-trash"></i> ××—×§</button>` : ''}
                                    </div>
                                </div>
                            `;
                        }).join('') : '<p class="text-center text-gray-500 p-8 bg-white rounded-xl shadow-md">××™×Ÿ ×¤×¢×™×œ×•×™×•×ª ×§×¨×•×‘×•×ª ××ª×•×›× × ×•×ª.</p>'}
                    </div>
                </div>
             `;
        };


        /**
         * ×××©×§ ××“××™×Ÿ ××©×•×“×¨×’ (×›×•×œ×œ × ×™×”×•×œ ××©×ª××©×™×)
         */
        const renderAdmin = () => {
            if (state.user.role !== 'admin') { goTo('home'); return ''; }

            const newReports = (state.reports || []).filter(r => r.status === '×—×“×©');

            return `
                ${getHeader()}
                <div class="max-w-6xl mx-auto px-4 mt-8">
                    <h2 class="text-3xl font-bold text-red-600 mb-6"><i class="fa-solid fa-shield-halved"></i> ×œ×•×— ×‘×§×¨×” ×œ×× ×”×œ</h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                        <div class="bg-white p-5 rounded-xl shadow-lg border-r-4 border-kesher-primary">
                            <p class="text-xs text-gray-500">×¡×”"×› ××©×ª××©×™×</p>
                            <p class="text-3xl font-bold text-kesher-primary">${(state.users || []).length}</p>
                        </div>
                        <div class="bg-white p-5 rounded-xl shadow-lg border-r-4 border-kesher-secondary">
                            <p class="text-xs text-gray-500">×¤×¢×™×œ×•×™×•×ª ×§×¨×•×‘×•×ª</p>
                            <p class="text-3xl font-bold text-kesher-secondary">${(state.activities || []).filter(a => a.date >= new Date()).length}</p>
                        </div>
                        <div class="bg-white p-5 rounded-xl shadow-lg border-r-4 border-red-500">
                            <p class="text-xs text-gray-500">×“×™×•×•×—×™× ×—×“×©×™×</p>
                            <p class="text-3xl font-bold text-red-500">${newReports.length}</p>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-2xl shadow-xl mb-8">
                        <h3 class="text-2xl font-bold text-kesher-primary mb-4"><i class="fa-solid fa-users-gear"></i> × ×™×”×•×œ ××©×ª××©×™×</h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">×©×</th>
                                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">×¢×™×¨</th>
                                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">×“×¨×’×” × ×•×›×—×™×ª</th>
                                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">×©× ×” ×“×¨×’×”</th>
                                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">×¤×¢×•×œ×•×ª</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    ${(state.users || []).map(u => `
                                        <tr>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                                ${u.name} 
                                                ${u.id === state.user.id ? '(×× ×™)' : ''}
                                                ${u.isActive === false ? ' <span class="text-red-500 font-bold">(××•×©×”×”)</span>' : ''}
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${u.city}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold">
                                                <span class="${u.role === 'admin' ? 'text-red-600' : u.role === 'senior' ? 'text-kesher-secondary' : 'text-gray-500'}">${u.role}</span>
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                                <select onchange="updateUserRole('${u.id}', this.value)" class="p-1 border rounded-lg text-sm" ${u.id === state.user.id ? 'disabled' : ''}>
                                                    <option value="user" ${u.role === 'user' ? 'selected' : ''}>××©×ª××© ×¨×’×™×œ</option>
                                                    <option value="senior" ${u.role === 'senior' ? 'selected' : ''}>××©×ª××© ×‘×›×™×¨</option>
                                                    <option value="admin" ${u.role === 'admin' ? 'selected' : ''}>××“××™×Ÿ</option>
                                                </select>
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-2 space-x-reverse">
                                                <button 
                                                    onclick="toggleUserActive('${u.id}', '${u.name}', ${u.isActive !== false})" 
                                                    class="p-1 rounded text-xs ${u.isActive !== false ? 'bg-yellow-500 hover:bg-yellow-600 text-white' : 'bg-kesher-secondary hover:bg-teal-600 text-white'}"
                                                    ${u.id === state.user.id ? 'disabled' : ''}>
                                                    ${u.isActive !== false ? '<i class="fa-solid fa-pause"></i> ×”×©×”×”' : '<i class="fa-solid fa-play"></i> ×”×¤×¢×œ ××—×“×©'}
                                                </button>
                                                <button onclick="deleteUser('${u.id}', '${u.name}')" class="p-1 rounded text-xs bg-red-500 hover:bg-red-600 text-white" ${u.id === state.user.id ? 'disabled' : ''}>
                                                    <i class="fa-solid fa-trash"></i> ××—×§
                                                </button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-2xl shadow-xl">
                        <h3 class="text-2xl font-bold text-red-600 mb-4"><i class="fa-solid fa-flag"></i> × ×™×”×•×œ ×“×™×•×•×—×™× (${(state.reports || []).length})</h3>
                        <div class="space-y-4">
                            ${(state.reports || []).map(r => {
                                const statusColor = r.status === '×—×“×©' ? 'bg-red-100 text-red-800' : 
                                                    r.status === '×‘×˜×™×¤×•×œ' ? 'bg-kesher-accent/20 text-kesher-accent' : 'bg-kesher-secondary/20 text-kesher-secondary';
                                return `
                                    <div class="border p-4 rounded-lg flex justify-between items-center">
                                        <div>
                                            <p class="font-bold">×“×•×•×— ×¢×œ: ${r.itemType} (ID: ${r.itemId.substring(0, 8)}...)</p>
                                            <p class="text-sm text-gray-600">×¡×™×‘×”: ${r.reason}</p>
                                            <p class="text-xs text-gray-500">××“×•×•×—: ${r.reporterName} | ××©×ª××© ××“×•×•×— ID: ${r.reportedUserId.substring(0, 8)}...</p>
                                        </div>
                                        <div class="flex flex-col gap-2 items-end">
                                            <span class="px-3 py-1 rounded-full text-xs font-semibold ${statusColor}">${r.status}</span>
                                            <select onchange="updateReportStatus('${r.id}', this.value)" class="p-1 border rounded-lg text-sm">
                                                <option value="×—×“×©" ${r.status === '×—×“×©' ? 'selected' : ''}>×—×“×©</option>
                                                <option value="×‘×˜×™×¤×•×œ" ${r.status === '×‘×˜×™×¤×•×œ' ? 'selected' : ''}>×‘×˜×™×¤×•×œ</option>
                                                <option value="×˜×•×¤×œ" ${r.status === '×˜×•×¤×œ' ? 'selected' : ''}>×˜×•×¤×œ</option>
                                            </select>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                </div>
            `;
        };


        // --- 5. ×× ×•×¢ ×¨×™× ×“×•×¨ ×•×˜×¢×™× ×” ×¨××©×•× ×™×ª ---

        function render() {
            let content = '';
            
            if (!state.user && state.screen !== 'register') {
                state.screen = 'login';
            }

            switch (state.screen) {
                case 'loading': content = renderLoading(); break; // ××¡×š ×˜×¢×™× ×”
                case 'login': content = renderLogin(); break;
                case 'register': content = renderRegister(); break;
                case 'home': content = renderHome(); break;
                case 'users': content = renderUsers(); break;
                case 'chat': content = renderChat(); break;
                case 'forums': content = renderForums(); break;
                case 'forumPosts': content = renderForumPosts(); break;
                case 'newPost': content = '<h1>×™×¦×™×¨×ª ×¤×•×¡×˜ ×—×“×© - ×œ× ×××•××©</h1>'; break; 
                case 'postDetails': content = renderPostDetails(); break;
                case 'activities': content = renderActivities(); break;
                case 'newActivity': content = '<h1>×™×¦×™×¨×ª ×¤×¢×™×œ×•×ª ×—×“×©×” - ×œ× ×××•××©</h1>'; break;
                case 'admin': content = renderAdmin(); break;
                default: 
                    // ×‘×¨×™×¨×ª ××—×“×œ ×‘×˜×•×—×”
                    content = `<h1>×©×’×™××ª × ×™×ª×•×‘</h1><button onclick="goTo('home')">×—×–×•×¨ ×”×‘×™×ª×”</button>`;
                    console.error("×©×’×™××ª × ×™×ª×•×‘: ××¡×š ×œ× ××•×›×¨:", state.screen);
            }
            
            document.getElementById('root').innerHTML = content;
        }

        async function initializeApp() {
            // **×©×œ×‘ 1: ×˜×¢×™× ×” ××”×™×¨×” ×©×œ ××‘× ×” × ×ª×•× ×™× ×¨×™×§ ×›×“×™ ×œ×× ×•×¢ ×§×¨×™×¡×” ××•×§×“××ª**
            loadFakeForumData(false); 
            
            // **×©×œ×‘ 2: ×”××–× ×” ×œ××¦×‘ ×”×”×ª×—×‘×¨×•×ª**
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    try {
                        // 1. ××—×–×•×¨ × ×ª×•× ×™ ××©×ª××©
                        const userDoc = await db.collection('users').doc(user.uid).get();
                        
                        if (userDoc.exists) {
                            const userData = userDoc.data();
                            
                            // ×‘×“×™×§×ª ×¡×˜×˜×•×¡ ×”×©×¢×™×” (isActive: false)
                            if (userData.isActive === false) {
                                console.log("×”××©×ª××© ××•×©×”×”. ×™×¦×™××”.");
                                auth.signOut();
                                return;
                            }

                            state.user = { 
                                id: user.uid, 
                                email: user.email, 
                                name: userData.name || '××©×ª××©', 
                                role: userData.role || 'user', 
                                points: userData.points || 0,
                                hobbies: userData.hobbies || [], 
                                contributions: userData.contributions || [],
                                isActive: userData.isActive !== false // ×‘×¨×™×¨×ª ××—×“×œ: ×¤×¢×™×œ
                            };
                            
                            // 2. ×˜×¢×™× ×ª × ×ª×•× ×™× ×›×œ×œ×™×™× (××©×ª××©×™×, ×¤×¢×™×œ×•×™×•×ª, ××•× ×™ ×¦'××˜)
                            await fetchInitialData(); 
                            
                            // 3. × ×™×ª×•×‘ ×œ××¡×š ×”×‘×™×ª ×¨×§ ×× ×œ× ×”×™×ª×” ×©×’×™××” ×§×¨×™×˜×™×ª
                            if (state.screen === 'loading' || state.screen === 'login') {
                                goTo('home');
                            } else {
                                render(); // ×× ×”××©×ª××© ×›×‘×¨ ×‘××¡×š ×›×œ×©×”×• (×›××• ×¤×•×¨×•×), ×¨× ×“×¨ ××—×“×©
                            }
                        } else {
                            // ×”××©×ª××© ××—×•×‘×¨ ×‘-Auth ××‘×œ ×œ× ×§×™×™× ×‘××¡××š users (×›× ×¨××” × ××—×§)
                            auth.signOut();
                        }
                    } catch (error) {
                        console.error("×©×’×™××” ×§×¨×™×˜×™×ª ×‘××—×–×•×¨ ×¤×¨×•×¤×™×œ ××©×ª××© ××• × ×ª×•× ×™× (Firebase/Config):", error);
                         // ×× ×™×© ×©×’×™××” ×‘×—×™×‘×•×¨ ×œ-Firebase, ×× ×• ×—×•×–×¨×™× ×œ×œ×•×’×™×Ÿ
                        state.user = null;
                        state.screen = 'login';
                        render();
                        alert("×©×’×™××” ×‘×—×™×‘×•×¨ ×œ×©×¨×ª ××• ×‘××—×–×•×¨ × ×ª×•× ×™×. × ×¡×” ×œ×”×ª×—×‘×¨ ×©×•×‘.");
                    }
                } else {
                    // **×”××©×ª××© ×œ× ××—×•×‘×¨ ××• ×™×¦×**
                    state.user = null;
                    if (state.screen !== 'register') {
                        goTo('login');
                    } else {
                        render();
                    }
                }
            });
        }

        // ×”×¤×¢×œ×ª ×”××¤×œ×™×§×¦×™×”
        initializeApp(); 
    </script>
</body>
</html>
