<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>קהילת קשר 60+</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

  <style>
    :root{
      --primary:#2B6CB0;
      --accent:#38B2AC;
      --bg:#F7FAFC;
      --card:#FFFFFF;
      --muted:#4A5568;
      --danger: #E53E3E;
    }
    html,body { height:100%; }
    body{ background:var(--bg); font-family: "Segoe UI", Roboto, Arial, sans-serif; color:#1a202c; -webkit-font-smoothing:antialiased; margin:0; padding:0; }
    .card{ background:var(--card); border-radius:12px; box-shadow:0 6px 20px rgba(0,0,0,0.06); }
    .btn-primary{ background:var(--accent); color:white; transition:background-color 0.2s; }
    .btn-primary:hover{ background:#319795; }
    .btn-sec{ background:var(--primary); color:white; transition:background-color 0.2s; }
    .btn-sec:hover{ background:#2C5282; }
    .pill{ padding:.5rem .9rem; border-radius:9999px; font-size:.875rem; font-weight:600; }
    .small-muted{ color:var(--muted); font-size:0.875rem; }
    .text-link{ color:var(--primary); cursor:pointer; text-decoration:underline; font-weight:500; }
    input[type="text"]:focus, input[type="email"]:focus, input[type="password"]:focus, textarea:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px var(--accent);
      outline: none;
    }
    .post-card { border-bottom: 1px solid #E2E8F0; }
    .post-card:last-child { border-bottom: none; }
    .comment-card { 
        background: #F0F4F8; 
        border-right: 3px solid var(--accent); 
        margin-right: 1.5rem;
    }
    .text-red-500 { color: var(--danger); }
    #error-message-box { 
        position: fixed; 
        top: 0; 
        left: 0; 
        right: 0; 
        z-index: 100;
        text-align: center;
        padding: 1rem;
        color: white;
        background-color: var(--danger);
        font-weight: bold;
        display: none;
    }
  </style>
</head>
<body class="flex flex-col min-h-screen">

<!-- תיבת שגיאות גלובלית -->
<div id="error-message-box">
  <span id="error-text">שגיאה: קרתה שגיאה. נא לבדוק.</span>
  <button onclick="hideError()" class="float-left text-white font-bold text-lg mr-4">&times;</button>
</div>

<!-- אזור האפליקציה -->
<div id="app-container" class="flex-grow flex flex-col items-center"></div>

<script type="module">
    // =========================================================
    // 1. יבוא Firebase
    // =========================================================
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, query, addDoc, serverTimestamp, setLogLevel, getDocs, updateDoc, arrayUnion, arrayRemove, increment } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    
    // ======= Firebase config - ודא שהערכים כאן תואמים לפרויקט שלך ב־Firebase =======
    const firebaseConfig = {
      apiKey: "AIzaSyCrcxC420HW5PXGNd8M4KuclUkiJSwHreM",
      authDomain: "kesher-bakir.firebaseapp.com",
      projectId: "kesher-bakir",
      storageBucket: "kesher-bakir.appspot.com", // תוקן
      messagingSenderId: "671996189455",
      appId: "1:671996189455:web:d8ee089585a852ab38fc7a",
      measurementId: "G-42EWSKFHXP"
    };
    // ========================================================================

    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-kesher-app-id';
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    let app, db, auth;

    const state = {
        screen: 'loading',
        user: null,
        posts: [],
        currentPost: null,
        allUsers: {},
        error: null,
        pendingAuth: null, // אם Auth קיים אבל אין פרופיל Firestore
    };

    // =========================================================
    // UI & Utility
    // =========================================================
    function showError(message, critical = false) {
        console.error("ERROR:", message);
        state.error = message;
        
        const errorBox = document.getElementById('error-message-box');
        const errorText = document.getElementById('error-text');

        if (errorBox && errorText) {
            errorText.textContent = message;
            errorBox.style.display = 'flex';
            
            if (!critical) {
                setTimeout(hideError, 5000);
            }
        }
        if (state.screen !== 'loading') {
             render();
        }
    }

    function hideError() {
        state.error = null;
        const errorBox = document.getElementById('error-message-box');
        if (errorBox) {
            errorBox.style.display = 'none';
        }
        render();
    }
    
    function getFirebaseErrorMessage(code) {
        if (!code) return "שגיאה לא ידועה";
        switch (code) {
            case 'auth/invalid-email':
                return 'כתובת אימייל לא תקינה.';
            case 'auth/user-disabled':
                return 'המשתמש נחסם.';
            case 'auth/user-not-found':
            case 'auth/wrong-password':
                return 'מייל או סיסמה שגויים.';
            case 'auth/email-already-in-use':
                return 'כתובת מייל כבר בשימוש.';
            case 'auth/weak-password':
                return 'הסיסמה חלשה (6 תווים מינימום).';
            case 'auth/requires-recent-login':
                return 'נדרש התחברות מחדש לביצוע פעולה זו.';
            default:
                return 'שגיאת אימות: ' + code.replace('auth/', '');
        }
    }

    function goTo(newScreen, params = {}) {
        hideError();
        state.screen = newScreen;
        if (newScreen === 'singlePost' && params.postId) {
            state.currentPost = state.posts.find(p => p.id === params.postId) || null;
            if (!state.currentPost) {
                showError("הפוסט לא נמצא.");
                goTo('forum');
                return;
            }
        } else {
            state.currentPost = null;
        }
        render();
    }
    
    function formatTimestamp(timestamp) {
        if (!timestamp) return 'לא זמין';
        let date = timestamp instanceof Date ? timestamp : (timestamp.toDate ? timestamp.toDate() : new Date(timestamp));
        const now = new Date();
        const diffInSeconds = (now.getTime() - date.getTime()) / 1000;

        if (diffInSeconds < 60) return 'הרגע';
        if (diffInSeconds < 3600) return `לפני ${Math.floor(diffInSeconds / 60)} דקות`;
        if (diffInSeconds < 86400) return `לפני ${Math.floor(diffInSeconds / 3600)} שעות`;

        const options = { year: 'numeric', month: 'numeric', day: 'numeric' };
        return date.toLocaleDateString('he-IL', options);
    }
    
    // =========================================================
    // Firebase functions
    // =========================================================

    function showRules() {
        const modal = document.getElementById('rulesModal');
        if (modal) {
            modal.style.display = 'flex';
        }
    }

    function hideRules() {
        const modal = document.getElementById('rulesModal');
        if (modal) {
            modal.style.display = 'none';
        }
    }

    async function login(email, password) {
        hideError();
        if (!auth) {
            showError("Firebase לא אתחל כראוי. בדוק קונפיג.", true);
            return false;
        }
        
        try {
            if (!email || !password) {
                showError("אנא מלא/י אימייל וסיסמה.");
                return false;
            }
            
            const userCredential = await signInWithEmailAndPassword(auth, email, password);
            console.log("Signed in:", userCredential.user.email);
            return true;
        } catch (error) {
            console.error("Login error:", error, "code:", error.code, "message:", error.message);
            showError(`שגיאת כניסה: ${getFirebaseErrorMessage(error.code)}`);
            return false;
        }
    }

    async function register(email, password, displayName, gender) {
        hideError();
        if (!auth || !db) {
            showError("Firebase לא אתחל כראוי. בדוק קונפיג.", true);
            return false;
        }
        
        if (password.length < 6) {
             showError("אורך סיסמה חייב להיות לפחות 6 תווים.");
             return false;
        }
        
        // אם יש pendingAuth - המשתמש כבר נמצא ב‑Auth אך חסר פרופיל ב‑Firestore
        if (state.pendingAuth) {
            try {
                const uid = state.pendingAuth.uid;
                const userProfileRef = doc(db, 'artifacts', appId, 'users', uid, 'profile', 'data');
                await setDoc(userProfileRef, {
                    uid: uid,
                    email: state.pendingAuth.email || email,
                    displayName: displayName,
                    gender: gender,
                    avatar: gender === 'male' ? 'https://placehold.co/400x400/2B6CB0/ffffff?text=M' : 'https://placehold.co/400x400/38B2AC/ffffff?text=F',
                    createdAt: serverTimestamp(),
                    lastLogin: serverTimestamp(),
                    bio: `היי, אני ${displayName} בקהילה!`
                });
                state.user = { uid, email: state.pendingAuth.email || email, displayName, gender, avatar: gender === 'male' ? 'https://placehold.co/400x400/2B6CB0/ffffff?text=M' : 'https://placehold.co/400x400/38B2AC/ffffff?text=F', bio: `היי, אני ${displayName} בקהילה!` };
                state.pendingAuth = null;
                await fetchInitialData();
                goTo('home');
                return true;
            } catch (error) {
                console.error("Error creating profile from pendingAuth:", error);
                showError("שגיאה ביצירת פרופיל. נסה שוב.");
                return false;
            }
        }

        try {
            const userCredential = await createUserWithEmailAndPassword(auth, email, password);
            const user = userCredential.user;
            
            const userProfileRef = doc(db, 'artifacts', appId, 'users', user.uid, 'profile', 'data');
            
            await setDoc(userProfileRef, {
                uid: user.uid,
                email: email,
                displayName: displayName,
                gender: gender,
                avatar: gender === 'male' ? 'https://placehold.co/400x400/2B6CB0/ffffff?text=M' : 'https://placehold.co/400x400/38B2AC/ffffff?text=F',
                createdAt: serverTimestamp(),
                lastLogin: serverTimestamp(),
                bio: `היי, אני ${displayName} בקהילה!`
            });
            
            console.log("User registered and profile created:", user.email);
            return true;

        } catch (error) {
            console.error("Register error:", error);
            showError(`שגיאת רישום: (${getFirebaseErrorMessage(error.code)})`);
            return false;
        }
    }

    async function logout() {
        if (auth) {
            await signOut(auth);
        }
    }
    
    async function fetchInitialData() {
        if (!db) return;

        const postsColRef = collection(db, 'artifacts', appId, 'public', 'data', 'posts');
        const postsQuery = query(postsColRef);
        onSnapshot(postsQuery, (snapshot) => {
            console.log("Firebase Debug: Posts updated.");
            const postsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            state.posts = postsData.sort((a, b) => (b.createdAt?.toMillis ? b.createdAt.toMillis() : 0) - (a.createdAt?.toMillis ? a.createdAt.toMillis() : 0));
            
            if (state.screen === 'singlePost' && state.currentPost) {
                state.currentPost = state.posts.find(p => p.id === state.currentPost.id) || null;
            }
            render();
        }, (error) => {
            console.error("Error updating posts:", error);
            showError("שגיאה בעדכון פוסטים. בדוק חיבור.");
        });

        const usersColRef = collection(db, 'artifacts', appId, 'users');
        
        try {
            const usersSnapshot = await getDocs(usersColRef);
            let userMap = {};
            for (const docSnapshot of usersSnapshot.docs) {
                const userProfileRef = doc(docSnapshot.ref, 'profile', 'data');
                const profileDoc = await getDoc(userProfileRef);
                if (profileDoc.exists()) {
                    const data = profileDoc.data();
                    userMap[data.uid] = {
                        displayName: data.displayName,
                        avatar: data.avatar,
                        gender: data.gender,
                        bio: data.bio || 'אין ביוגרפיה.',
                    };
                }
            }
            state.allUsers = userMap;
            console.log("Firebase Debug: Users map loaded. Count:", Object.keys(state.allUsers).length);
        } catch (error) {
            console.error("Error loading users:", error);
            showError("שגיאה בטעינת משתמשים.");
        }
    }
    
    async function addPost(title, content, category) {
        if (!db || !state.user) {
            showError("אין חיבור ל‑Firebase או המשתמש לא מחובר.");
            return false;
        }

        try {
            const postsColRef = collection(db, 'artifacts', appId, 'public', 'data', 'posts');
            await addDoc(postsColRef, {
                userId: state.user.uid,
                title: title,
                content: content,
                category: category,
                createdAt: serverTimestamp(),
                updatedAt: serverTimestamp(),
                commentsCount: 0,
                likes: [],
            });
            goTo('forum');
            return true;
        } catch (error) {
            console.error("Add post error:", error);
            showError("שגיאה ביצירת פוסט. בדוק הרשאות Firestore.");
            return false;
        }
    }

    async function addComment(postId, commentText) {
        if (!db || !state.user || !commentText.trim()) {
            return;
        }

        try {
            const postRef = doc(db, 'artifacts', appId, 'public', 'data', 'posts', postId);
            const commentsColRef = collection(postRef, 'comments');
            
            await addDoc(commentsColRef, {
                userId: state.user.uid,
                content: commentText,
                createdAt: serverTimestamp(),
            });
            
            try {
                await updateDoc(postRef, {
                    commentsCount: increment(1),
                    updatedAt: serverTimestamp(),
                });
            } catch (e) {
                console.warn("Warning: could not increment commentsCount:", e);
            }

        } catch (error) {
            console.error("Add comment error:", error);
            showError("שגיאה בהוספת תגובה.");
        }
    }
    
    async function toggleLike(postId) {
        if (!db || !state.user) {
            showError("אין הרשאה לשנות לייקים.");
            return;
        }

        try {
            const postRef = doc(db, 'artifacts', appId, 'public', 'data', 'posts', postId);
            const post = state.posts.find(p => p.id === postId);

            if (post) {
                const likesArray = Array.isArray(post.likes) ? post.likes : [];
                const isLiked = likesArray.includes(state.user.uid);
                
                await updateDoc(postRef, {
                    likes: isLiked ? arrayRemove(state.user.uid) : arrayUnion(state.user.uid)
                });
            }
        } catch (error) {
            console.error("Toggle like error:", error);
            showError("שגיאה בעדכון לייק.");
        }
    }


    // =========================================================
    // UI templates (שמרתי את כל המסכים)
    // =========================================================

    function PostCard(post) {
        const user = state.allUsers[post.userId] || { displayName: 'משתמש', avatar: 'https://placehold.co/400x400/808080/ffffff?text=?' };
        const likesCount = post.likes ? post.likes.length : 0;
        const isLiked = post.likes ? (state.user ? post.likes.includes(state.user.uid) : false) : false;
        
        return `
            <div class="post-card p-4 flex justify-between items-center hover:bg-gray-50 cursor-pointer" onclick="goTo('singlePost', {postId: '${post.id}'})">
                <div class="flex-grow">
                    <div class="flex items-center mb-1">
                        <img src="${user.avatar}" alt="תמונה ${user.displayName}" class="w-8 h-8 rounded-full ml-3 border-2 border-kesher-secondary">
                        <span class="text-sm font-semibold text-kesher-text">${user.displayName}</span>
                        <span class="small-muted mr-3">| ${formatTimestamp(post.createdAt)}</span>
                    </div>
                    <h4 class="text-lg font-bold text-kesher-primary mb-1">${post.title}</h4>
                    <span class="pill bg-kesher-secondary/20 text-kesher-secondary text-xs">${post.category}</span>
                </div>
                <div class="flex flex-col items-center ml-4 text-center">
                    <span class="text-sm small-muted mb-1">תגובות</span>
                    <span class="text-xl font-bold text-kesher-primary">${post.commentsCount || 0}</span>
                </div>
                <div class="flex flex-col items-center ml-4 text-center">
                    <button onclick="event.stopPropagation(); toggleLike('${post.id}')" class="text-xl transition-transform transform ${isLiked ? 'text-red-500 scale-110' : 'text-gray-400 hover:text-red-400'}">
                        <i class="${isLiked ? 'fas' : 'far'} fa-heart"></i>
                    </button>
                    <span class="text-sm small-muted">${likesCount}</span>
                </div>
            </div>
        `;
    }

    function CommentCard(comment) {
        const user = state.allUsers[comment.userId] || { displayName: 'משתמש', avatar: 'https://placehold.co/400x400/808080/ffffff?text=?' };
        
        return `
            <div class="comment-card p-4 my-3 rounded-lg flex">
                <img src="${user.avatar}" alt="תמונה ${user.displayName}" class="w-10 h-10 rounded-full border-2 border-kesher-accent ml-3">
                <div class="flex-grow">
                    <div class="flex justify-between items-start mb-1">
                        <span class="font-semibold text-kesher-text">${user.displayName}</span>
                        <span class="small-muted text-xs">${formatTimestamp(comment.createdAt)}</span>
                    </div>
                    <p class="text-sm text-gray-700 mt-1">${comment.content}</p>
                </div>
            </div>
        `;
    }

    // =========================================================
    // Views (כל המסכים שלך נשמרו)
    // =========================================================

    function renderLoading() {
        return `
            <div class="flex flex-col items-center justify-center h-screen w-full">
                <i class="fas fa-spinner fa-spin text-kesher-primary text-6xl mb-4"></i>
                <h1 class="text-2xl font-bold text-kesher-text">טוען...</h1>
                <p class="small-muted mt-2">מנסה להתחבר ל‑Firebase.</p>
            </div>
        `;
    }
    
    function renderLogin() {
        const prefill = state.pendingAuth?.email || '';
        return `
            <div class="flex flex-col items-center justify-center w-full min-h-screen p-4">
                <div class="card p-8 w-full max-w-md text-center">
                    <img src="https://placehold.co/150x150/FF6B6B/ffffff?text=K" alt="לוגו" class="mx-auto mb-6 rounded-full shadow-lg">
                    <h1 class="text-3xl font-extrabold mb-2 text-kesher-primary">התחבר/י לחשבון</h1>
                    <p class="small-muted mb-6">קהילת 60+</p>
                    
                    <form id="loginForm" class="space-y-4">
                        <input type="email" id="loginEmail" placeholder="אימייל" required 
                               class="w-full p-3 border border-gray-300 rounded-lg text-right" dir="ltr" value="${prefill}">
                        <input type="password" id="loginPassword" placeholder="סיסמה" required 
                               class="w-full p-3 border border-gray-300 rounded-lg text-right" dir="ltr">
                        
                        <button type="submit" class="btn-primary w-full p-3 rounded-lg font-bold text-lg shadow-md hover:shadow-lg transition">
                            התחבר <i class="fas fa-sign-in-alt mr-2"></i>
                        </button>
                    </form>
                    
                    <p class="mt-6 text-sm">
                        אין לך חשבון? <span class="text-link" onclick="goTo('register')">רשום/י</span>
                    </p>
                    <p class="mt-4 text-xs small-muted">
                        <span class="text-link" onclick="showRules()">תנאי שימוש</span>
                    </p>
                </div>
            </div>
        `;
    }
    
    function renderRegister() {
        const prefill = state.pendingAuth?.email || '';
        return `
            <div class="flex flex-col items-center justify-center w-full min-h-screen p-4">
                <div class="card p-8 w-full max-w-md text-center">
                    <h1 class="text-3xl font-extrabold mb-2 text-kesher-secondary">הרשמה</h1>
                    <p class="small-muted mb-6">צור/י חשבון חדש בקהילה.</p>
                    
                    <form id="registerForm" class="space-y-4">
                        <input type="email" id="registerEmail" placeholder="אימייל" required 
                               class="w-full p-3 border border-gray-300 rounded-lg text-right" dir="ltr" value="${prefill}">
                        <input type="password" id="registerPassword" placeholder="סיסמה (6 תווים לפחות)" required 
                               class="w-full p-3 border border-gray-300 rounded-lg text-right" dir="ltr">
                        <input type="text" id="registerDisplayName" placeholder="שם תצוגה" required 
                               class="w-full p-3 border border-gray-300 rounded-lg text-right">
                        
                        <div class="flex justify-around bg-gray-100 p-2 rounded-lg">
                            <label class="flex items-center cursor-pointer">
                                <input type="radio" name="gender" value="male" class="form-radio text-kesher-primary h-5 w-5 ml-2" required>
                                זכר <i class="fas fa-male mr-1 text-kesher-primary"></i>
                            </label>
                            <label class="flex items-center cursor-pointer">
                                <input type="radio" name="gender" value="female" class="form-radio text-kesher-secondary h-5 w-5 ml-2" required checked>
                                נקבה <i class="fas fa-female mr-1 text-kesher-secondary"></i>
                            </label>
                        </div>

                        <button type="submit" class="btn-sec w-full p-3 rounded-lg font-bold text-lg shadow-md hover:shadow-lg transition">
                            צור חשבון <i class="fas fa-user-plus mr-2"></i>
                        </button>
                    </form>
                    
                    <p class="mt-6 text-sm">
                        כבר רשום? <span class="text-link" onclick="goTo('login')">התחבר</span>
                    </p>
                    <p class="mt-4 text-xs small-muted">
                        בעיות? בדוק את התנאים ב‑<span class="text-link" onclick="showRules()">תנאי השימוש</span>
                    </p>
                </div>
            </div>
        `;
    }

    function renderHome() {
        if (!state.user) return renderLoading();
        const user = state.user;

        return `
            ${Header()}
            <main class="container mx-auto p-4 flex-grow">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    
                    <div class="md:col-span-2 card p-6 bg-white flex items-center shadow-xl">
                        <img src="${user.avatar}" alt="תמונה" class="w-20 h-20 rounded-full border-4 border-kesher-accent ml-4 shadow-md">
                        <div>
                            <p class="text-xl text-gray-500">שלום, ${user.displayName}!</p>
                            <h2 class="text-3xl font-extrabold text-kesher-primary">${user.displayName}</h2>
                            <p class="small-muted mt-1">${user.bio}</p>
                        </div>
                    </div>
                    
                    <div class="card p-6 bg-kesher-secondary/10 flex flex-col justify-center items-center cursor-pointer hover:bg-kesher-secondary/20 transition" onclick="goTo('profile')">
                        <i class="fas fa-user-circle text-4xl text-kesher-secondary mb-2"></i>
                        <h3 class="font-bold text-kesher-secondary">הצג פרופיל</h3>
                    </div>

                </div>

                <h2 class="text-2xl font-bold text-kesher-text mb-4 flex justify-between items-center border-b pb-2">
                    פוסטים אחרונים
                    <button class="btn-primary py-2 px-4 rounded-full text-sm flex items-center" onclick="goTo('forum')">
                        עוד פוסטים <i class="fas fa-arrow-left mr-2"></i>
                    </button>
                </h2>
                
                <div class="card divide-y divide-gray-100">
                    ${state.posts.slice(0, 5).map(post => PostCard(post)).join('')}
                    ${state.posts.length === 0 ? '<p class="p-4 text-center small-muted">אין עדיין פוסטים. תתחיל/י לשתף!</p>' : ''}
                </div>
                
                <div class="mt-8 text-center">
                     <button class="btn-sec py-3 px-8 rounded-full text-lg font-bold shadow-xl hover:shadow-2xl transition" onclick="goTo('addPost')">
                        <i class="fas fa-plus-circle ml-2"></i> יצירת פוסט חדש
                    </button>
                </div>
            </main>
        `;
    }
    
    function renderForum() {
        if (!state.user) return renderLoading();
        
        const postsContent = state.posts.length > 0
            ? state.posts.map(post => PostCard(post)).join('')
            : '<p class="p-4 text-center small-muted">אין פוסטים להצגה.</p>';

        return `
            ${Header()}
            <main class="container mx-auto p-4 flex-grow">
                <div class="flex justify-between items-center mb-6 border-b pb-4">
                    <h1 class="text-3xl font-extrabold text-kesher-secondary">פורום הקהילה</h1>
                    <button class="btn-sec py-2 px-4 rounded-full font-bold shadow-md" onclick="goTo('addPost')">
                        <i class="fas fa-edit ml-2"></i> פוסט חדש
                    </button>
                </div>
                
                <div class="mb-4 small-muted">
                    <i class="fas fa-filter ml-2"></i> סינון (סה״כ פוסטים: ${state.posts.length}).
                </div>
                
                <div class="card divide-y divide-gray-100 shadow-xl">
                    ${postsContent}
                </div>
            </main>
        `;
    }

    function renderSinglePost() {
        if (!state.user || !state.currentPost) return renderForum();

        const post = state.currentPost;
        const author = state.allUsers[post.userId] || { displayName: 'משתמש', avatar: 'https://placehold.co/400x400/808080/ffffff?text=?' };
        const likesCount = post.likes ? post.likes.length : 0;
        const isLiked = post.likes ? post.likes.includes(state.user.uid) : false;
        
        let commentsHtml = `
            <div id="commentsContainer" class="mt-6">
                <h3 class="text-xl font-bold text-kesher-text mb-4 border-b pb-2">תגובות (${post.commentsCount || 0})</h3>
                <p class="text-center small-muted p-4">טוען תגובות...</p>
            </div>
        `;
        
        setTimeout(() => loadComments(post.id), 0);


        return `
            ${Header()}
            <main class="container mx-auto p-4 flex-grow">
                <button class="small-muted text-link mb-4 flex items-center" onclick="goTo('forum')">
                    <i class="fas fa-arrow-right ml-2"></i> חזרה לפורום
                </button>
                
                <div class="card p-6 shadow-xl mb-6">
                    <span class="pill bg-kesher-accent/20 text-kesher-accent text-sm mb-3">${post.category}</span>
                    <h1 class="text-3xl font-extrabold text-kesher-primary mb-4">${post.title}</h1>
                    
                    <div class="flex items-center mb-4 border-b pb-4">
                        <img src="${author.avatar}" alt="תמונה ${author.displayName}" class="w-12 h-12 rounded-full border-2 border-kesher-primary ml-3 shadow">
                        <div>
                            <p class="font-semibold text-kesher-text">${author.displayName} <span class="text-xs small-muted">(מחבר)</span></p>
                            <p class="small-muted text-xs">פורסם: ${formatTimestamp(post.createdAt)}</p>
                        </div>
                    </div>
                    
                    <div class="prose max-w-none text-gray-700 leading-relaxed mb-6">
                        <p>${post.content.split('\n').map(p => `<span>${p}</span>`).join('<br>')}</p>
                    </div>
                    
                    <div class="flex items-center justify-end border-t pt-4">
                        <button onclick="toggleLike('${post.id}')" class="flex items-center p-2 rounded-full transition-colors ${isLiked ? 'text-red-500 bg-red-100' : 'text-gray-500 hover:text-red-500 hover:bg-gray-100'}">
                            <i class="${isLiked ? 'fas' : 'far'} fa-heart text-xl ml-2"></i>
                            <span class="font-bold">${likesCount}</span>
                        </button>
                    </div>
                </div>

                <div class="card p-4 mb-6 shadow-lg">
                    <h4 class="font-bold mb-3 text-kesher-text">הוסף תגובה:</h4>
                    <form id="addCommentForm" onsubmit="event.preventDefault(); handleAddComment('${post.id}')" class="space-y-3">
                        <textarea id="commentContent" rows="3" placeholder="כתוב/י תגובה..." required
                                  class="w-full p-3 border border-gray-300 rounded-lg focus:ring-kesher-accent focus:border-kesher-accent"></textarea>
                        <button type="submit" class="btn-primary py-2 px-6 rounded-lg font-bold float-left">
                            שלח תגובה <i class="fas fa-comment ml-2"></i>
                        </button>
                    </form>
                    <div class="clearfix"></div>
                </div>

                ${commentsHtml}
            </main>
        `;
    }
    
    async function loadComments(postId) {
        if (!db) return;
        const commentsContainer = document.getElementById('commentsContainer');
        if (!commentsContainer) return;
        
        try {
            const commentsColRef = collection(db, 'artifacts', appId, 'public', 'data', 'posts', postId, 'comments');
            const commentsQuery = query(commentsColRef);

            onSnapshot(commentsQuery, (snapshot) => {
                let comments = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                comments.sort((a, b) => (a.createdAt?.toMillis ? a.createdAt.toMillis() : 0) - (b.createdAt?.toMillis ? b.createdAt.toMillis() : 0));

                const commentsHtml = comments.map(CommentCard).join('');
                
                commentsContainer.innerHTML = `
                    <h3 class="text-xl font-bold text-kesher-text mb-4 border-b pb-2">תגובות (${comments.length})</h3>
                    ${comments.length > 0 ? commentsHtml : '<p class="text-center small-muted p-4 bg-white rounded-lg shadow-sm">אין עדיין תגובות. כתבו את הראשונה!</p>'}
                `;
            }, (error) => {
                console.error("Error loading comments:", error);
                commentsContainer.innerHTML = `<p class="text-center text-red-500 p-4">שגיאה בטעינת תגובות: ${error.message}</p>`;
            });

        } catch (error) {
            console.error("Error reading comments:", error);
            commentsContainer.innerHTML = `<p class="text-center text-red-500 p-4">שגיאה בקריאה: ${error.message}</p>`;
        }
    }
    
    async function handleAddComment(postId) {
        const textarea = document.getElementById('commentContent');
        const commentText = textarea.value;
        if (commentText.trim()) {
            await addComment(postId, commentText);
            textarea.value = '';
        }
    }
    
    function renderAddPost() {
        if (!state.user) return renderLoading();
        
        const categories = [
            { value: 'health', label: 'בריאות' },
            { value: 'finance', label: 'כספים' },
            { value: 'tech', label: 'טכנולוגיה' },
            { value: 'social', label: 'חיי חברה' },
            { value: 'general', label: 'כללי' },
        ];

        return `
            ${Header()}
            <main class="container mx-auto p-4 flex-grow">
                <div class="card p-8 w-full max-w-3xl mx-auto shadow-xl">
                    <h1 class="text-3xl font-extrabold text-kesher-secondary mb-4 border-b pb-2">יצירת פוסט חדש</h1>
                    <p class="small-muted mb-6">שתפו משהו עם הקהילה.</p>
                    
                    <form id="addPostForm" onsubmit="event.preventDefault(); handleAddPostSubmit()" class="space-y-4">
                        
                        <select id="postCategory" required class="w-full p-3 border border-gray-300 rounded-lg">
                            <option value="">בחר/י קטגוריה</option>
                            ${categories.map(cat => `<option value="${cat.value}">${cat.label}</option>`).join('')}
                        </select>
                        
                        <input type="text" id="postTitle" placeholder="כותרת הפוסט (חובה)" required 
                               class="w-full p-3 border border-gray-300 rounded-lg font-semibold text-lg">
                        
                        <textarea id="postContent" rows="8" placeholder="תוכן הפוסט..." required
                                  class="w-full p-3 border border-gray-300 rounded-lg"></textarea>

                        <div class="flex justify-between items-center pt-4">
                            <button type="button" class="btn-sec bg-gray-500 hover:bg-gray-600 py-2 px-6 rounded-lg font-bold" onclick="goTo('forum')">
                                בטל <i class="fas fa-times-circle ml-2"></i>
                            </button>
                            <button type="submit" class="btn-primary py-2 px-6 rounded-lg font-bold">
                                פרסם פוסט <i class="fas fa-share-square ml-2"></i>
                            </button>
                        </div>
                    </form>
                </div>
            </main>
        `;
    }
    
    async function handleAddPostSubmit() {
        const title = document.getElementById('postTitle').value;
        const content = document.getElementById('postContent').value;
        const category = document.getElementById('postCategory').value;
        
        if (title && content && category) {
            await addPost(title, content, category);
        } else {
            showError("נא למלא את כל השדות.");
        }
    }


    function renderProfile() {
        if (!state.user) return renderLoading();
        const user = state.user;

        return `
            ${Header()}
            <main class="container mx-auto p-4 flex-grow">
                <div class="card p-8 w-full max-w-2xl mx-auto shadow-xl">
                    <h1 class="text-3xl font-extrabold text-kesher-primary mb-6 border-b pb-2">פרופיל אישי</h1>

                    <div class="flex flex-col items-center mb-6">
                        <img src="${user.avatar}" alt="תמונה" class="w-32 h-32 rounded-full border-4 border-kesher-accent shadow-lg mb-4">
                        <h2 class="text-2xl font-bold text-kesher-text">${user.displayName}</h2>
                        <p class="small-muted text-lg">${user.email}</p>
                    </div>

                    <div class="space-y-4 text-right">
                        <div>
                            <label class="block font-semibold text-sm mb-1 text-gray-700">מגדר:</label>
                            <p class="p-3 bg-gray-50 rounded-lg">${user.gender === 'male' ? 'זכר' : 'נקבה'} <i class="fas fa-user-${user.gender === 'male' ? 'male' : 'female'} mr-1 text-${user.gender === 'male' ? 'kesher-primary' : 'kesher-secondary'}"></i></p>
                        </div>
                        <div>
                            <label class="block font-semibold text-sm mb-1 text-gray-700">ביוגרפיה:</label>
                            <p class="p-3 bg-gray-50 rounded-lg whitespace-pre-wrap">${user.bio || 'אין ביוגרפיה.'}</p>
                        </div>
                        <div>
                            <label class="block font-semibold text-sm mb-1 text-gray-700">זיהוי משתמש (UID):</label>
                            <p class="p-3 bg-gray-50 rounded-lg text-xs" dir="ltr">${user.uid}</p>
                        </div>
                    </div>
                    
                    <div class="flex justify-between items-center mt-8 pt-4 border-t">
                        <button class="btn-sec py-2 px-6 rounded-lg font-bold text-sm" onclick="goTo('editProfile')">
                            <i class="fas fa-pencil-alt ml-2"></i> ערוך פרופיל
                        </button>
                        <button class="text-link text-sm text-red-500" onclick="logout()">
                            <i class="fas fa-sign-out-alt ml-1"></i> התנתק
                        </button>
                    </div>
                </div>
            </main>
        `;
    }
    
    async function updateProfile(newDisplayName, newBio) {
        if (!db || !state.user) {
            showError("אין חיבור ל‑Firebase.");
            return false;
        }

        try {
            const userProfileRef = doc(db, 'artifacts', appId, 'users', state.user.uid, 'profile', 'data');
            
            await updateDoc(userProfileRef, {
                displayName: newDisplayName,
                bio: newBio,
            });
            
            state.user.displayName = newDisplayName;
            state.user.bio = newBio;
            if (state.allUsers[state.user.uid]) {
                state.allUsers[state.user.uid].displayName = newDisplayName;
                state.allUsers[state.user.uid].bio = newBio;
            }
            
            goTo('profile');
            return true;
        } catch (error) {
            console.error("Error updating profile:", error);
            showError("שגיאה בעדכון הפרופיל. נסה שוב מאוחר יותר.");
            return false;
        }
    }

    function renderEditProfile() {
        if (!state.user) return renderLoading();
        const user = state.user;

        return `
            ${Header()}
            <main class="container mx-auto p-4 flex-grow">
                <div class="card p-8 w-full max-w-2xl mx-auto shadow-xl">
                    <h1 class="text-3xl font-extrabold text-kesher-secondary mb-6 border-b pb-2">עריכת פרופיל</h1>

                    <form id="editProfileForm" onsubmit="event.preventDefault(); handleEditProfileSubmit()" class="space-y-4">
                        
                        <div class="flex flex-col items-center mb-6">
                            <img src="${user.avatar}" alt="תמונה" class="w-32 h-32 rounded-full border-4 border-kesher-accent shadow-lg mb-4">
                            <p class="small-muted">כדי לשנות תמונה, עדכן/י ב‑Firestore או שמשתמש מספק תמונה.</p>
                        </div>
                        
                        <div>
                            <label for="editDisplayName" class="block font-semibold text-sm mb-1 text-gray-700">שם תצוגה:</label>
                            <input type="text" id="editDisplayName" value="${user.displayName}" required 
                               class="w-full p-3 border border-gray-300 rounded-lg text-right">
                        </div>

                        <div>
                            <label for="editBio" class="block font-semibold text-sm mb-1 text-gray-700">ביוגרפיה:</label>
                            <textarea id="editBio" rows="5" placeholder="כתוב/י קצת על עצמך..." 
                                  class="w-full p-3 border border-gray-300 rounded-lg">${user.bio || ''}</textarea>
                        </div>

                        <div class="flex justify-between items-center pt-4">
                            <button type="button" class="btn-sec bg-gray-500 hover:bg-gray-600 py-2 px-6 rounded-lg font-bold" onclick="goTo('profile')">
                                בטל <i class="fas fa-times-circle ml-2"></i>
                            </button>
                            <button type="submit" class="btn-primary py-2 px-6 rounded-lg font-bold">
                                שמור שינויי פרופיל <i class="fas fa-save ml-2"></i>
                            </button>
                        </div>
                    </form>
                </div>
            </main>
        `;
    }
    
    async function handleEditProfileSubmit() {
        const newDisplayName = document.getElementById('editDisplayName').value;
        const newBio = document.getElementById('editBio').value;
        
        if (newDisplayName) {
            await updateProfile(newDisplayName, newBio);
        } else {
            showError("שם תצוגה לא יכול להיות ריק.");
        }
    }


    function Header() {
        const user = state.user || { displayName: 'אורח', avatar: 'https://placehold.co/100x100/cccccc/ffffff?text=?' };
        const activeClass = "border-b-4 border-kesher-accent text-kesher-accent font-bold";
        const baseClass = "px-3 py-2 text-gray-700 hover:text-kesher-primary transition";

        return `
            <header class="bg-white shadow-md sticky top-0 z-50">
                <div class="container mx-auto p-4 flex justify-between items-center">
                    
                    <div class="flex items-center">
                        <div class="text-2xl font-extrabold text-kesher-primary flex items-center cursor-pointer" onclick="goTo('home')">
                            <img src="https://placehold.co/30x30/FF6B6B/ffffff?text=K" alt="לוגו" class="rounded-full shadow-sm ml-2">
                            קהילת קשר
                        </div>
                        <nav class="hidden md:flex mr-6 space-x-4 space-x-reverse">
                            <a href="#" class="${state.screen === 'home' ? activeClass : baseClass}" onclick="goTo('home')">
                                <i class="fas fa-home ml-1"></i> דף הבית
                            </a>
                            <a href="#" class="${state.screen === 'forum' || state.screen === 'singlePost' || state.screen === 'addPost' ? activeClass : baseClass}" onclick="goTo('forum')">
                                <i class="fas fa-comments ml-1"></i> פורום
                            </a>
                        </nav>
                    </div>

                    <div class="flex items-center">
                        <button class="text-sm font-semibold flex items-center hover:opacity-80 transition" onclick="goTo('profile')">
                            <span class="text-kesher-text mr-2">${user.displayName}</span>
                            <img src="${user.avatar}" alt="תמונה" class="w-10 h-10 rounded-full border-2 border-kesher-secondary shadow">
                        </button>
                        <button class="small-muted mr-4 hover:text-red-500 transition" onclick="logout()">
                            <i class="fas fa-sign-out-alt"></i>
                        </button>
                    </div>

                </div>
            </header>
        `;
    }


    // =========================================================
    // רינדור דינמי ופיזור אירועים
    // =========================================================

    function render() {
        const container = document.getElementById('app-container');
        if (!container) return;

        let htmlContent = '';
        
        switch (state.screen) {
            case 'loading':
                htmlContent = renderLoading();
                break;
            case 'login':
                htmlContent = renderLogin();
                break;
            case 'register':
                htmlContent = renderRegister();
                break;
            case 'home':
                htmlContent = renderHome();
                break;
            case 'forum':
                htmlContent = renderForum();
                break;
            case 'singlePost':
                htmlContent = renderSinglePost();
                break;
            case 'addPost':
                htmlContent = renderAddPost();
                break;
            case 'profile':
                htmlContent = renderProfile();
                break;
            case 'editProfile':
                htmlContent = renderEditProfile();
                break;
            default:
                htmlContent = `
                    ${Header()}
                    <div class="p-8 text-center text-red-500">
                        <h1 class="text-2xl">שגיאה 404: מסך לא נמצא</h1>
                        <p class="mt-2">חזור ל־<span class="text-link" onclick="goTo('home')">דף הבית</span></p>
                    </div>
                `;
                break;
        }

        container.innerHTML = htmlContent;
        
        if (state.screen === 'login') {
            document.getElementById('loginForm')?.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;
                await login(email, password); 
            });
        } else if (state.screen === 'register') {
             document.getElementById('registerForm')?.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('registerEmail').value;
                const password = document.getElementById('registerPassword').value;
                const displayName = document.getElementById('registerDisplayName').value;
                const gender = document.querySelector('input[name="gender"]:checked').value;
                await register(email, password, displayName, gender);
            });
        }
    }


    // =========================================================
    // אתחול Firebase ו‑Auth
    // =========================================================

    async function initializeFirebase() {
        if (!firebaseConfig) {
            showError("חסרה קונפיגורציית Firebase.", true);
            return false;
        }

        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            try { setLogLevel('debug'); } catch(e) {}
            
            console.log("Firebase: אתחול הצליח.");

            if (initialAuthToken) {
                try {
                    console.log("ניסיון כניסה עם custom token...");
                    await signInWithCustomToken(auth, initialAuthToken);
                    console.log("Custom token sign-in הצליח.");
                } catch (e) {
                    console.error("כשל כניסה עם custom token:", e);
                    try { await signOut(auth); } catch(_) {}
                }
            } else {
                // הושבתה התחברות אנונימית אוטומטית כדי לא לחסום Email/Password.
                // אם תרצה להפעיל אנונימי עבור מקרים מסוימים, השתמש בקריאה מבוקרת מחוץ לאתחול.
            }

            return true;
        } catch (error) {
            console.error("שגיאה באתחול Firebase SDK:", error);
            showError("שגיאה באתחול Firebase. בדוק את קונפיג ההתחברות.", true);
            return false;
        }
    }
    
    // renamed to avoid clash with imported initializeApp
    async function startApp() {
        goTo('loading');
        
        const firebaseReady = await initializeFirebase();
        if (!firebaseReady) {
            return;
        }
        
        onAuthStateChanged(auth, async (userAuth) => {
            if (userAuth) {
                const userId = userAuth.uid;
                console.log("Firebase Debug: Auth state changed. User is logged in (UID:", userId, ").");
                
                const userProfileRef = doc(db, 'artifacts', appId, 'users', userId, 'profile', 'data');
                let profileDoc = null;
                try {
                    profileDoc = await getDoc(userProfileRef);
                } catch (e) {
                    console.error("Error reading profile doc:", e);
                    showError("שגיאה בטעינת פרופיל המשתמש. בדוק חיבור/הרשאות Firestore.");
                    state.user = null;
                    goTo('login');
                    return;
                }
                
                if (profileDoc && profileDoc.exists()) {
                    try {
                        state.user = { ...profileDoc.data(), uid: userId };
                        console.log("Firebase Debug: User profile fetched successfully:", state.user.displayName);
                        
                        await fetchInitialData(); 
                        
                        if (state.screen === 'loading' || state.screen === 'login' || state.screen === 'register') {
                            goTo('home');
                        } else {
                            render();
                        }
                    } catch (error) {
                        console.error("שגיאה פנימית בטעינת פרופיל:", error);
                        state.user = null;
                        state.screen = 'login';
                        showError("שגיאה בטעינת נתונים. נא לנסות שוב.", true);
                        render();
                    }
                } else {
                    // פרופיל חסר ב־Firestore — אל נעשה signOut אוטומטי
                    console.warn("Firebase Debug: Auth user found but profile missing in Firestore.");
                    state.pendingAuth = { uid: userId, email: userAuth.email || '' };
                    showError("נמצאה כניסה אך אין פרופיל משתמש. יש להשלים את ההרשמה ליצירת הפרופיל.", false);
                    goTo('register');
                }
            } else {
                console.log("Firebase Debug: Auth state changed. User is logged out.");
                state.user = null;
                if (state.screen !== 'register') {
                    goTo('login');
                } else {
                    render();
                }
            }
        });
    }

    // start the app
    startApp(); 
</script>

<!-- Terms modal (simple) -->
<div id="rulesModal" class="fixed inset-0 bg-black/30 hidden items-center justify-center z-60" onclick="if(event.target.id === 'rulesModal') hideRules()">
  <div class="bg-white p-6 rounded-xl w-full max-w-2xl card shadow-2xl">
    <h3 class="font-bold text-2xl mb-4 text-kesher-primary">כללי הקהילה ותנאי שימוש</h3>
    <div class="small-muted mb-4 p-3 bg-red-50 border-r-4 border-red-500 rounded">
      <strong>תשומת לב:</strong> יש להשתמש בפורום בכבוד ובנימוס. אין לפרסם תכנים פוגעניים, מסחריים או מסמכים חסויים.
    </div>
    <ol class="text-sm small-muted list-decimal mr-6 space-y-2 max-h-96 overflow-y-auto">
      <li><strong>כבוד לאחרים:</strong> התנהגו בכבוד בכל דיון.</li>
      <li><strong>תוכן אסור:</strong> אין לפרסם תכנים בעלי אופי פוגעני או מסחרי בלתי מורשה.</li>
      <li><strong>פרטיות:</strong> הימנעו מפרסום מידע אישי של אחרים ללא הסכמה.</li>
      <li><strong>דיווח:</strong> מצאתם תוכן בעייתי? דווחו למנהלי האתר.</li>
    </ol>
    <div class="text-center mt-6">
        <button class="btn-primary py-2 px-6 rounded-lg font-bold" onclick="hideRules()">
            קראתי והסכמתי <i class="fas fa-check-circle mr-2"></i>
        </button>
    </div>
  </div>
</div>

</body>
</html>
