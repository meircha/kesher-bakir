<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>קהילת קשר | החיים הטובים לגיל הזהב</title>
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#E63946">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <style>
        :root { --primary: #E63946; --primary-hover: #C81D2A; --secondary: #457B9D; --text-main: #1D3557; --bg-color: #f8fafc; --bubble-bg: #FFFFFF; }
        body { background-color: var(--bg-color); color: var(--text-main); font-family: 'Segoe UI', sans-serif; font-size: 16px; margin: 0; padding: 0; overflow-x: hidden; -webkit-tap-highlight-color: transparent; }
        
        /* Layout */
        .main-app-container { max-width: 1024px; margin: 0 auto; min-height: 100vh; background-color: #ffffff; position: relative; box-shadow: 0 0 25px rgba(0,0,0,0.05); display: flex; flex-direction: column; padding-bottom: 0; }
        .content-area { flex: 1; padding-top: 7.5rem; padding-bottom: 6rem; padding-left: 1rem; padding-right: 1rem; min-height: 80vh; overflow-y: auto; }
        
        /* Components */
        .btn-primary { background-color: var(--primary); color: white; transition: 0.3s; font-weight: 700; display: flex; justify-content: center; align-items: center; cursor: pointer; border-radius: 0.75rem; padding: 0.75rem 1.5rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .btn-primary:hover { background-color: var(--primary-hover); transform: translateY(-2px); }
        input, select, textarea { font-size: 16px !important; padding: 12px !important; border-radius: 0.75rem; border: 1px solid #e2e8f0; width: 100%; margin-bottom: 12px; background-color: #f8fafc; display: block; }
        input:focus { outline: none; border-color: var(--primary); background: #fff; }
        
        /* Animations & Utils */
        .hidden { display: none !important; }
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .profile-img { object-fit: cover; width: 100%; height: 100%; }
        .card-img { object-fit: cover; width: 100%; height: 100%; }
        
        /* Header Bubbles */
        .header-bubble { background-color: var(--bubble-bg); border: 1px solid #e5e7eb; border-radius: 1rem; padding: 2px; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 70px; width: 70px; min-width: 70px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); cursor: pointer; margin: 0 3px; transition: transform 0.1s; }
        .header-bubble:active { transform: scale(0.95); }
        .header-icon { font-size: 1.3rem; margin-bottom: 1px; color: #4B5563; }
        .header-text { font-size: 0.6rem; font-weight: bold; text-align: center; line-height: 1; color: #1D3557; margin-bottom: 2px; }
        .badge-text { font-size: 0.55rem; background: #f3f4f6; padding: 1px 3px; border-radius: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 62px; color: #555; }

        /* Chat Split View */
        .chat-split-container { display: flex; flex-direction: row; height: calc(100vh - 240px); background: white; border-radius: 1rem; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border: 1px solid #e5e7eb; }
        .chat-sidebar { width: 35%; min-width: 120px; border-left: 1px solid #e5e7eb; background-color: #f9fafb; display: flex; flex-direction: column; }
        .chat-main-area { flex: 1; display: flex; flex-direction: column; background-color: #ffffff; position: relative; }
        .chat-user-item { transition: 0.2s; cursor: pointer; border-bottom: 1px solid #f3f4f6; }
        .chat-user-item:hover { background-color: #ffffff; }
        .chat-user-item.active { background-color: #fff0f0; border-right: 4px solid #E63946; }

        /* Footer */
        #bottom-nav-bar { position: fixed; bottom: 0; left: 0; right: 0; z-index: 9999; background-color: white; border-top: 1px solid #e5e7eb; box-shadow: 0 -4px 15px rgba(0,0,0,0.08); max-width: 1024px; margin: 0 auto; padding-bottom: env(safe-area-inset-bottom); }
        .nav-item { display: flex; flex-direction: column; align-items: center; padding: 10px 0; color: #9ca3af; transition: color 0.2s; }
        .nav-item.active { color: var(--primary); }
        
        /* Avatars */
        .avatar-option { border: 2px solid transparent; transition: 0.2s; cursor: pointer; }
        .avatar-option.selected { border-color: var(--primary); background-color: #fee2e2; transform: scale(1.05); }
    </style>
</head>
<body>
    <div id="app" class="main-app-container">
        <div class="flex justify-center items-center h-screen flex-col gap-6 bg-white z-50 relative">
            <h2 class="text-3xl font-bold text-gray-800">קהילת קשר</h2>
            <p class="text-gray-500 text-sm animate-pulse">טוען...</p>
        </div>
    </div>

    <div id="suggestionModal" class="hidden fixed inset-0 bg-black/60 z-[100] flex items-center justify-center p-4 backdrop-blur-sm"><div class="bg-white rounded-3xl p-6 w-full max-w-md shadow-xl"><h2 class="text-xl font-bold mb-4">הצעה לשיפור</h2><form onsubmit="event.preventDefault(); sendSuggestion()"><input id="sugCategory" placeholder="נושא" required class="p-3 rounded-xl"><textarea id="sugContent" rows="4" placeholder="פירוט..." required class="p-3 rounded-xl"></textarea><div class="flex gap-3 mt-4"><button type="button" onclick="document.getElementById('suggestionModal').classList.add('hidden')" class="flex-1 bg-gray-100 py-2 rounded-xl">ביטול</button><button class="flex-1 btn-primary py-2">שלח</button></div></form></div></div>
    
    <div id="profileModal" class="hidden fixed inset-0 bg-black/70 z-[100] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl p-6 w-full max-w-md shadow-2xl max-h-[90vh] overflow-y-auto">
            <h2 class="text-2xl font-bold mb-4 text-center">פרופיל שלי</h2>
            <form onsubmit="event.preventDefault(); saveProfileChanges()">
                <div class="flex flex-col items-center mb-6">
                    <div class="relative w-24 h-24 mb-3">
                        <div class="w-full h-full rounded-full overflow-hidden border-4 border-red-100 shadow-lg"><img src="" id="previewImg" class="profile-img"></div>
                        <label for="fileInput" class="absolute bottom-0 right-0 bg-red-500 text-white w-8 h-8 rounded-full flex items-center justify-center cursor-pointer"><i class="fa-solid fa-camera text-sm"></i></label>
                        <input type="file" id="fileInput" accept="image/*" class="hidden" onchange="handleImageUpload(this)">
                    </div>
                    <p class="text-xs text-gray-500">העלה תמונה או בחר מהמערכת:</p>
                </div>
                <div class="mb-4 grid grid-cols-3 gap-3" id="avatarGrid"></div>
                <input type="hidden" id="selectedAvatarUrl">
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div><label class="block text-sm font-bold">עיר</label><input type="text" id="editCity" required></div>
                    <div><label class="block text-sm font-bold">מין</label><select id="editGender" required><option value="male">גבר</option><option value="female">אישה</option></select></div>
                </div>
                <div class="flex gap-3"><button type="button" onclick="document.getElementById('profileModal').classList.add('hidden')" class="flex-1 bg-gray-100 py-2 rounded-xl">ביטול</button><button class="flex-1 btn-primary py-2">שמור</button></div>
            </form>
        </div>
    </div>
    
    <div id="missingInfoModal" class="hidden fixed inset-0 bg-black/80 z-[100] flex items-center justify-center p-4"><div class="bg-white rounded-2xl p-8 w-full max-w-md text-center"><h2 class="text-xl font-bold mb-4">חסרים פרטים</h2><form onsubmit="event.preventDefault(); updateMissingInfo()"><select id="missingGender" required class="mb-4"><option value="male">גבר</option><option value="female">אישה</option></select><input type="date" id="missingDob" required class="mb-4"><button class="btn-primary w-full py-2">עדכן</button></form></div></div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyCrcxC420HW5PXGNd8M4KuclUkiJSwHreM", authDomain: "kesher-bakir.firebaseapp.com", projectId: "kesher-bakir", storageBucket: "kesher-bakir.firebasestorage.app", messagingSenderId: "671996189455", appId: "1:671996189455:web:dbe089d69a85a2ab38fc7a", measurementId: "G-42EWSKFXW" };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth(), db = firebase.firestore();

        const store = { user: null, currentPage: 'loading', currentChatTargetId: null, chatDraft: "", chatFilterOnline: false, data: { users: [], forums: [], activities: [], chats: [], currentChatMessages: [] } };
        const AVATARS_CATALOG = [
            { name: "סבא יוסף", url: "https://api.dicebear.com/9.x/avataaars/svg?seed=Felix&mouth=smile&eyebrows=default" },
            { name: "סבתא שרה", url: "https://api.dicebear.com/9.x/avataaars/svg?seed=Aneka&mouth=smile&eyebrows=default" },
            { name: "דוד משה", url: "https://api.dicebear.com/9.x/avataaars/svg?seed=Joshua&mouth=smile" },
            { name: "דודה רבקה", url: "https://api.dicebear.com/9.x/avataaars/svg?seed=Molly&mouth=smile" },
            { name: "חבר יקר", url: "https://api.dicebear.com/9.x/avataaars/svg?seed=Liam&mouth=smile" },
            { name: "חברה יקרה", url: "https://api.dicebear.com/9.x/avataaars/svg?seed=Zoe&mouth=smile" }
        ];

        function navigate(p) { store.currentPage = p; render(); window.scrollTo(0,0); }
        
        // --- Profile Logic ---
        function openProfileModal() {
            const u = store.user;
            document.getElementById('editCity').value = u.city || '';
            document.getElementById('editGender').value = u.gender || 'male';
            document.getElementById('previewImg').src = getUserImage(u);
            
            const grid = document.getElementById('avatarGrid');
            grid.innerHTML = AVATARS_CATALOG.map(a => `
                <div onclick="selectAvatar('${a.url}', this)" class="avatar-option rounded-xl p-1 bg-gray-50 border text-center hover:bg-gray-100">
                    <img src="${a.url}" class="w-10 h-10 mx-auto rounded-full mb-1 bg-white">
                    <span class="text-[10px] font-bold">${a.name}</span>
                </div>
            `).join('');
            
            store.tempImageBase64 = null;
            document.getElementById('profileModal').classList.remove('hidden');
        }

        window.selectAvatar = function(url, el) {
            document.getElementById('selectedAvatarUrl').value = url;
            document.getElementById('previewImg').src = url;
            store.tempImageBase64 = null;
            document.querySelectorAll('.avatar-option').forEach(d => d.classList.remove('selected', 'border-red-500', 'bg-red-50'));
            el.classList.add('border-red-500', 'bg-red-50');
        }

        function handleImageUpload(i) {
            const f = i.files[0];
            if (f) {
                const r = new FileReader();
                r.onload = (e) => {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        const cvs = document.createElement('canvas');
                        const ctx = cvs.getContext('2d');
                        cvs.width = 300; cvs.height = 300; // Resize to avoid large payload
                        ctx.drawImage(img, 0, 0, 300, 300);
                        const b64 = cvs.toDataURL('image/jpeg', 0.7);
                        store.tempImageBase64 = b64;
                        document.getElementById('previewImg').src = b64;
                        document.getElementById('selectedAvatarUrl').value = '';
                    };
                };
                r.readAsDataURL(f);
            }
        }

        async function saveProfileChanges() {
            const d = { city: document.getElementById('editCity').value, gender: document.getElementById('editGender').value };
            if (store.tempImageBase64) { d.customImage = store.tempImageBase64; d.avatarSeed = null; }
            else if (document.getElementById('selectedAvatarUrl').value) { d.avatarSeed = document.getElementById('selectedAvatarUrl').value; d.customImage = null; }
            
            await db.collection('users').doc(store.user.uid).update(d);
            store.user = { ...store.user, ...d };
            document.getElementById('profileModal').classList.add('hidden');
            render();
        }
        
        // --- Chat Logic ---
        let msgSub = null;
        function loadChatMessages(oid) {
            if (msgSub) msgSub();
            store.currentChatTargetId = oid;
            const cid = [store.user.uid, oid].sort().join("_");
            
            db.collection('chats').doc(cid).update({ [`unread_${store.user.uid}`]: 0 }).catch(()=>{});
            
            msgSub = db.collection('chats').doc(cid).collection('messages').orderBy('timestamp','asc').onSnapshot(s => {
                store.data.currentChatMessages = s.docs.map(d => ({ id: d.id, ...d.data() }));
                render(); 
                setTimeout(() => { const el = document.getElementById('chatMessagesArea'); if(el) el.scrollTop = el.scrollHeight; }, 100);
            });
        }

        async function sendMessage() {
            const txt = document.getElementById('chatInput').value;
            const rid = store.currentChatTargetId;
            if (!rid || !txt.trim()) return;
            
            const cid = [store.user.uid, rid].sort().join("_");
            const r = store.data.users.find(u => u.id === rid);
            
            await db.collection('chats').doc(cid).collection('messages').add({
                senderId: store.user.uid, content: txt, timestamp: firebase.firestore.FieldValue.serverTimestamp(), read: false
            });
            
            await db.collection('chats').doc(cid).set({
                participants: [store.user.uid, rid],
                participantNames: { [store.user.uid]: store.user.name, [rid]: r ? r.name : 'משתמש' },
                lastMessage: txt,
                lastUpdated: firebase.firestore.FieldValue.serverTimestamp(),
                [`unread_${rid}`]: firebase.firestore.FieldValue.increment(1)
            }, { merge: true });
            
            document.getElementById('chatInput').value = '';
        }

        // --- General Utils ---
        function getUserImage(u) { 
            if (u && u.customImage) return u.customImage; 
            const s = u ? (u.avatarSeed || u.name) : 'User'; 
            if(s && s.startsWith('http')) return s; 
            return `https://api.dicebear.com/9.x/avataaars/svg?seed=${encodeURIComponent(s)}&backgroundColor=c0aede&mood=happy`; 
        }
        async function updateMissingInfo() { const g = document.getElementById('missingGender').value, d = document.getElementById('missingDob').value; if (g && d) { await db.collection('users').doc(store.user.uid).update({ gender: g, dob: d }); store.user.gender = g; store.user.dob = d; document.getElementById('missingInfoModal').classList.add('hidden'); render(); } }
        async function sendSuggestion() { await db.collection('suggestions').add({ content: document.getElementById('sugContent').value, uid: store.user.uid }); document.getElementById('suggestionModal').classList.add('hidden'); alert("תודה!"); }

        // --- Init ---
        function fetchData() {
            if (!store.user) return;
            db.collection('users').onSnapshot(s => { store.data.users = s.docs.map(d => ({ id: d.id, ...d.data() })); render(); });
            db.collection('forums').orderBy('createdAt', 'desc').onSnapshot(s => { store.data.forums = s.docs.map(d => ({ id: d.id, ...d.data() })); render(); });
            db.collection('activities').orderBy('date', 'asc').onSnapshot(s => { store.data.activities = s.docs.map(d => ({ id: d.id, ...d.data() })); render(); });
            db.collection('chats').where('participants', 'array-contains', store.user.uid).onSnapshot(s => { store.data.chats = s.docs.map(d => ({ id: d.id, ...d.data() })); render(); });
        }

        auth.onAuthStateChanged(async u => {
            if (u) {
                const d = await db.collection('users').doc(u.uid).get();
                if (d.exists) {
                    store.user = { uid: u.uid, ...d.data() };
                    if (!store.user.gender || !store.user.dob) document.getElementById('missingInfoModal').classList.remove('hidden');
                    fetchData();
                    navigate('home');
                } else auth.signOut();
            } else { store.user = null; navigate('login'); }
        });

        // --- Rendering ---
        function render() {
            const app = document.getElementById('app');
            if (store.currentPage === 'loading') return;
            if (store.currentPage === 'login') { app.innerHTML = renderLogin(); return; }
            if (store.currentPage === 'register') { app.innerHTML = renderRegister(); return; }

            app.innerHTML = `${renderHeader()}<div class="content-area fade-in">${renderContent()}</div>${renderBottomNav()}`;
        }

        function renderContent() {
            switch (store.currentPage) {
                case 'home': return renderHome();
                case 'activities': return renderActivities();
                case 'forums': return renderForums();
                case 'chats': return renderChatsSplitView();
                default: return renderHome();
            }
        }

        function renderLogin() { return `<div class="min-h-screen flex items-center justify-center bg-red-50 p-4"><div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md text-center"><h1 class="text-4xl font-bold text-red-600 mb-4">קהילת קשר</h1><button onclick="auth.signInWithPopup(new firebase.auth.GoogleAuthProvider())" class="btn-primary w-full py-3 rounded-xl">כניסה עם גוגל</button></div></div>`; }
        function renderRegister() { return ``; } // (קיים בקוד מלא, קוצר כאן לתצוגה)

        function renderHeader() {
            const u = store.user;
            return `<header class="bg-white shadow-md fixed top-0 left-0 right-0 z-40 h-24 flex items-center justify-center max-w-[1024px] mx-auto w-full px-4">
                <div class="flex justify-between items-center w-full">
                    <div class="flex items-center gap-3 w-1/3">
                        <div class="header-bubble" onclick="document.getElementById('suggestionModal').classList.remove('hidden')"><i class="fa-regular fa-lightbulb header-icon text-yellow-600"></i><span class="header-text text-gray-600">הצעות</span></div>
                        <div class="header-bubble"><span class="header-icon text-lg">⭐</span><span class="header-text text-blue-600">${u.points || 0} נק'</span></div>
                    </div>
                    <div class="flex flex-col items-center justify-center w-1/3 cursor-pointer" onclick="navigate('home')"><i class="fa-solid fa-heart text-4xl text-red-600"></i><span class="text-sm font-bold text-gray-700 mt-1">קהילת קשר</span></div>
                    <div class="flex items-center gap-3 justify-end w-1/3">
                        <div class="header-bubble" onclick="openProfileModal()"><div class="w-8 h-8 rounded-full overflow-hidden border border-gray-300 header-icon"><img src="${getUserImage(u)}" class="profile-img"></div><span class="header-text text-gray-600">פרופיל</span></div>
                        <button onclick="auth.signOut()" class="text-red-500 text-2xl px-2"><i class="fa-solid fa-right-from-bracket"></i></button>
                    </div>
                </div>
            </header>`;
        }

        function renderHome() {
            return `<div class="space-y-8 mt-4 p-4"><div class="bg-gradient-to-r from-red-500 to-pink-600 text-white p-8 rounded-3xl shadow-xl text-center"><h2 class="text-4xl font-bold mb-2">שלום, ${store.user.name}</h2><p class="text-xl opacity-90">ברוכים הבאים!</p></div><div class="grid grid-cols-2 gap-4"><button onclick="navigate('activities')" class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-green-500"><i class="fa-solid fa-person-walking text-4xl text-green-500 mb-2"></i><div class="font-bold text-lg">פעילויות</div></button><button onclick="navigate('forums')" class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-blue-500"><i class="fa-solid fa-comments text-4xl text-blue-500 mb-2"></i><div class="font-bold text-lg">פורומים</div></button></div></div>`;
        }

        function renderActivities() { return `<div class="p-4 text-center font-bold text-xl">לוח פעילויות (בבנייה)</div>`; }
        function renderForums() { return `<div class="p-4 text-center font-bold text-xl">פורומים (בבנייה)</div>`; }

        // --- Split View Chat ---
        function renderChatsSplitView() {
            let filteredUsers = store.data.users.filter(u => u.id !== store.user.uid);
            if (store.chatFilterOnline) {
                const fiveMinAgo = new Date(Date.now() - 5 * 60 * 1000);
                filteredUsers = filteredUsers.filter(u => u.lastSeen && u.lastSeen.toDate() > fiveMinAgo);
            }
            
            // מיון: הודעות שלא נקראו קודם
            filteredUsers.sort((a, b) => {
                const chatA = store.data.chats.find(c => c.participants.includes(a.id));
                const chatB = store.data.chats.find(c => c.participants.includes(b.id));
                const unreadA = chatA ? (chatA['unread_' + store.user.uid] || 0) : 0;
                const unreadB = chatB ? (chatB['unread_' + store.user.uid] || 0) : 0;
                return unreadB - unreadA; // יורד
            });

            const targetUser = store.data.users.find(u => u.id === store.currentChatTargetId);
            const msgs = store.data.currentChatMessages || [];

            return `
            <div class="chat-split-container mt-4 h-[calc(100vh-14rem)] flex bg-white rounded-2xl shadow overflow-hidden border border-gray-200">
                <div class="w-1/3 min-w-[140px] border-l bg-gray-50 flex flex-col">
                    <div class="p-3 border-b bg-white">
                        <h2 class="font-bold mb-2 text-sm">הודעות</h2>
                        <div class="flex items-center gap-2 mb-2"><input type="checkbox" ${store.chatFilterOnline?'checked':''} onclick="store.chatFilterOnline=!store.chatFilterOnline; render()" class="custom-checkbox"><span class="text-xs">מחוברים</span></div>
                    </div>
                    <div class="flex-1 overflow-y-auto p-2 space-y-1">
                        ${filteredUsers.map(u => {
                            const chat = store.data.chats.find(c => c.participants.includes(u.id));
                            const unread = chat ? (chat['unread_' + store.user.uid] || 0) : 0;
                            const isActive = store.currentChatTargetId === u.id;
                            return `<div onclick="loadChatMessages('${u.id}')" class="flex items-center gap-2 p-2 rounded-lg cursor-pointer hover:bg-white transition ${isActive ? 'bg-white border-r-4 border-red-500' : ''}"><div class="relative"><img src="${getUserImage(u)}" class="w-8 h-8 rounded-full border bg-gray-200 object-cover"></div><div class="flex-1 min-w-0"><div class="flex justify-between"><span class="font-bold text-xs truncate">${u.name}</span>${unread > 0 ? `<span class="bg-red-600 text-white text-[9px] font-bold px-1.5 rounded-full">${unread}</span>` : ''}</div></div></div>`;
                        }).join('')}
                    </div>
                </div>
                <div class="flex-1 flex flex-col bg-white relative">
                    ${targetUser ? `
                        <div class="p-3 border-b flex items-center gap-3 bg-gray-50 shadow-sm z-10"><img src="${getUserImage(targetUser)}" class="w-8 h-8 rounded-full border"><h3 class="font-bold text-sm">${targetUser.name}</h3></div>
                        <div id="chatMessagesArea" class="flex-1 overflow-y-auto p-4 space-y-3">${msgs.map(m => { const isMe = m.senderId === store.user.uid; return `<div class="flex ${isMe ? 'justify-end' : 'justify-start'}"><div class="max-w-[75%] p-2 rounded-xl text-sm ${isMe ? 'bg-red-500 text-white rounded-tl-none' : 'bg-gray-100 text-gray-800 rounded-tr-none'}"><p>${m.content}</p></div></div>`; }).join('')}</div>
                        <div class="p-2 border-t bg-gray-50 flex gap-2"><input id="chatInput" class="flex-1 rounded-full px-4 py-2 border text-sm" placeholder="הודעה..." onkeydown="if(event.key==='Enter') sendMessage('${targetUser.id}')"><button onclick="sendMessage('${targetUser.id}')" class="bg-red-600 text-white w-8 h-8 rounded-full flex items-center justify-center shadow"><i class="fa-solid fa-paper-plane text-sm"></i></button></div>
                    ` : `<div class="flex flex-col items-center justify-center h-full text-gray-300"><i class="fa-regular fa-comments text-6xl mb-4"></i><p>בחר חבר</p></div>`}
                </div>
            </div>`;
        }

        function renderBottomNav() { 
            const a = (k) => store.currentPage.startsWith(k) ? 'text-red-600' : 'text-gray-400';
            const un = store.data.chats.reduce((s,c)=>s+(c['unread_'+store.user.uid]||0),0);
            return `<nav id="bottom-nav-bar" class="fixed bottom-0 w-full bg-white border-t py-2 px-4 flex justify-between items-center z-40 shadow-lg max-w-[1024px] mx-auto left-0 right-0"><button onclick="navigate('home')" class="${a('home')} flex flex-col items-center"><i class="fa-solid fa-house text-2xl"></i><span class="text-xs">בית</span></button><button onclick="navigate('activities')" class="${a('activities')} flex flex-col items-center"><i class="fa-solid fa-person-walking text-2xl"></i><span class="text-xs">פעילויות</span></button><button onclick="navigate('forums')" class="${a('forums')} flex flex-col items-center"><i class="fa-solid fa-comments text-2xl"></i><span class="text-xs">פורומים</span></button><button onclick="navigate('chats')" class="${a('chats')} flex flex-col items-center relative"><div class="relative"><i class="fa-solid fa-envelope text-2xl"></i>${un>0?`<span class="absolute -top-2 -right-2 bg-red-600 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-full border-2 border-white">${un}</span>`:''}</div><span class="text-xs">הודעות</span></button></nav>`; 
        }
    </script>
</body>
</html>
