<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>×§×”×™×œ×ª ×§×©×¨ | ×”×—×™×™× ×”×˜×•×‘×™× ×œ×’×™×œ ×”×–×”×‘</title>
    
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#E63946">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <style>
        /* --- ×”×’×“×¨×•×ª ×‘×¡×™×¡ --- */
        :root {
            --primary: #E63946; 
            --primary-hover: #C81D2A;
            --secondary: #457B9D;
            --text-main: #1D3557; 
            --bg-color: #f8fafc;
            --bubble-bg: #FFFFFF;
        }
        
        /* ×× ×™×¢×ª ×’×œ×™×œ×” ×©×œ ×›×œ ×”×¢××•×“ - ×§×¨×™×˜×™ ×œ××•×‘×™×™×œ */
        body, html {
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 16px;
            margin: 0; padding: 0;
            height: 100%; 
            overflow: hidden; /* ××™×Ÿ ×’×œ×™×œ×” ×¨××©×™×ª */
            -webkit-tap-highlight-color: transparent;
        }

        /* ×”××™×›×œ ×”×¨××©×™ ×ª×•×¤×¡ 100% ×’×•×‘×” ×•××—×œ×§ ××ª ×”××¡×š */
        .main-app-container {
            max-width: 1024px;
            margin: 0 auto;
            height: 100%;
            background-color: #ffffff;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        /* ×”×”×“×¨ ×•×”×¤×•×˜×¨ ××§×•×‘×¢×™×, ×”×ª×•×›×Ÿ ×‘×××¦×¢ ×’××™×© */
        .app-header {
            height: 80px; /* ×’×•×‘×” ×§×‘×•×¢ ×œ×”×“×¨ */
            flex-shrink: 0;
            z-index: 50;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .app-footer {
            height: 70px; /* ×’×•×‘×” ×§×‘×•×¢ ×œ×¤×•×˜×¨ */
            flex-shrink: 0;
            z-index: 50;
            background: white;
            border-top: 1px solid #e5e7eb;
            padding-bottom: env(safe-area-inset-bottom);
        }

        /* ××–×•×¨ ×”×ª×•×›×Ÿ × ×’×œ×œ ×¢×¦×××™×ª */
        .content-area {
            flex-grow: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding: 1rem;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        /* --- ×¨×›×™×‘×™× --- */
        .btn-primary {
            background-color: var(--primary);
            color: white;
            font-weight: 700;
            display: flex; justify-content: center; align-items: center;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.1s;
        }
        .btn-primary:active { transform: scale(0.95); }

        input, select, textarea {
            width: 100%; padding: 12px;
            border: 1px solid #cbd5e1;
            border-radius: 0.75rem;
            background-color: #f8fafc;
            margin-bottom: 12px;
            font-size: 16px; /* ××•× ×¢ ×–×•× ×‘××™×™×¤×•×Ÿ */
        }
        input:focus, select:focus, textarea:focus { outline: none; border-color: var(--primary); background: white; }

        /* ×‘×•×¢×•×ª Header - ××•×ª×××•×ª ×œ××•×‘×™×™×œ */
        .header-bubble {
            background-color: var(--bubble-bg);
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 2px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            height: 65px; width: 65px; min-width: 65px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            cursor: pointer; margin: 0 4px;
            position: relative;
        }
        .header-icon { font-size: 1.2rem; margin-bottom: 0; color: #4B5563; }
        .header-text { font-size: 0.6rem; font-weight: bold; text-align: center; line-height: 1; margin-top: 2px; }
        .badge-text { font-size: 0.5rem; background: #f3f4f6; padding: 1px 4px; border-radius: 4px; margin-top: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 58px; }

        /* --- ×¦'××˜ ××¤×•×¦×œ (Split View) ××•×ª×× ×œ×’×•×‘×” ××œ× --- */
        .chat-layout {
            display: flex;
            flex-direction: row;
            height: 100%; /* ×ª×•×¤×¡ ××ª ×›×œ ×”×’×•×‘×” ×©×œ content-area */
            background: white;
            border-radius: 0.75rem;
            overflow: hidden;
            border: 1px solid #e5e7eb;
        }

        .chat-sidebar {
            width: 35%; min-width: 200px;
            border-left: 1px solid #e5e7eb;
            background-color: #f9fafb;
            display: flex; flex-direction: column;
        }

        .chat-main {
            flex: 1;
            display: flex; flex-direction: column;
            background-color: #ffffff;
            position: relative;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            background-color: #fff;
            display: flex; flex-direction: column; gap: 0.5rem;
        }

        .chat-input-bar {
            padding: 0.75rem;
            background-color: #f9fafb;
            border-top: 1px solid #e5e7eb;
            display: flex; gap: 0.5rem; align-items: center;
            flex-shrink: 0; /* ×©×œ× ×™×ª×›×•×•×¥ */
        }

        /* ×”×ª×××” ×œ××•×‘×™×™×œ - ×”×¡×ª×¨×ª ×¦×“ ××—×“ */
        @media (max-width: 768px) {
            .content-area { padding: 0; margin-top: 80px; margin-bottom: 70px; } /* ××§×¡×™××•× ××§×•× */
            .chat-layout { border: none; border-radius: 0; }
            
            /* ×›×‘×¨×™×¨×ª ××—×“×œ ××¦×™×’×™× ×¨×©×™××” */
            .chat-sidebar { width: 100%; display: flex; }
            .chat-main { display: none; }

            /* ×›×©×™×© ×¦'××˜ ×¤×¢×™×œ, ××¡×ª×™×¨×™× ×¨×©×™××” ×•××¦×™×’×™× ×¦'××˜ */
            .chat-mode-active .chat-sidebar { display: none; }
            .chat-mode-active .chat-main { display: flex; width: 100%; }
            
            /* ×”×¡×ª×¨×ª ×‘×•×¢×•×ª ×¤×—×•×ª ×—×©×•×‘×•×ª ×‘×”×“×¨ ×‘××•×‘×™×™×œ */
            .hide-on-mobile { display: none; }
            .header-bubble { height: 55px; width: 55px; min-width: 55px; } /* ×§×˜×Ÿ ×™×•×ª×¨ ×‘××•×‘×™×™×œ */
        }

        .chat-item {
            padding: 10px; border-bottom: 1px solid #f0f0f0; cursor: pointer;
            display: flex; align-items: center; gap: 10px;
            transition: background 0.2s;
        }
        .chat-item:hover { background-color: #f0f9ff; }
        .chat-item.selected { background-color: #e0f2fe; border-right: 3px solid var(--primary); }

        /* ××•×•×˜××¨×™× */
        .avatar-grid-item {
            border: 2px solid transparent; cursor: pointer; padding: 4px; border-radius: 0.5rem;
        }
        .avatar-grid-item.selected {
            border-color: var(--primary); background-color: #fff1f2;
        }

        /* ×¢×–×¨×™× */
        .profile-pic-sm { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 1px solid #ddd; }
        .unread-badge { background-color: #ef4444; color: white; font-size: 0.6rem; font-weight: bold; padding: 0.1rem 0.4rem; border-radius: 999px; }
        
        /* ×ª×™×§×•×Ÿ ×œ××™××•×’'×™ */
        .emoji-picker {
            position: absolute; bottom: 60px; right: 10px;
            background: white; border: 1px solid #ccc; border-radius: 8px;
            padding: 8px; display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.1); z-index: 100;
        }
    </style>
</head>
<body>

    <div id="app" class="main-app-container">
        <div id="loader" class="fixed inset-0 bg-white z-[100] flex flex-col items-center justify-center">
            <i class="fa-solid fa-heart text-6xl text-red-500 animate-pulse mb-4"></i>
            <h1 class="text-2xl font-bold text-gray-700">×˜×•×¢×Ÿ ××ª ×”×§×”×™×œ×”...</h1>
        </div>

        <div id="header-container"></div>
        <div id="content-container" class="content-area"></div>
        <div id="footer-container"></div>
    </div>

    <div id="profileModal" class="fixed inset-0 bg-black/60 hidden z-[80] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl p-6 w-full max-w-md shadow-2xl h-[85vh] flex flex-col">
            <div class="flex justify-between items-center mb-4 shrink-0">
                <h2 class="text-xl font-bold">×¢×¨×™×›×ª ×¤×¨×•×¤×™×œ</h2>
                <button onclick="closeModal('profileModal')" class="text-gray-500"><i class="fa-solid fa-xmark text-2xl"></i></button>
            </div>
            <div class="overflow-y-auto flex-1 p-1">
                <div class="flex justify-center mb-4">
                    <div class="relative">
                        <img id="editProfileImg" src="" class="w-24 h-24 rounded-full border-4 border-red-100 object-cover">
                        <label class="absolute bottom-0 right-0 bg-red-500 text-white p-2 rounded-full cursor-pointer shadow">
                            <i class="fa-solid fa-camera text-sm"></i>
                            <input type="file" class="hidden" onchange="handleImageUpload(this)">
                        </label>
                    </div>
                </div>
                
                <div class="mb-4">
                    <p class="text-sm font-bold mb-2 text-center">×‘×—×¨ ×“××•×ª ××”×××’×¨:</p>
                    <div id="avatarGrid" class="grid grid-cols-3 gap-2"></div>
                    <input type="hidden" id="selectedAvatarUrl">
                </div>

                <label class="block text-sm font-bold mb-1">×¢×™×¨ ××’×•×¨×™×</label>
                <input id="editCity" class="mb-3">
                
                <label class="block text-sm font-bold mb-1">××™×Ÿ</label>
                <select id="editGender" class="mb-4">
                    <option value="male">×’×‘×¨</option>
                    <option value="female">××™×©×”</option>
                </select>
            </div>
            <div class="mt-4 shrink-0">
                <button onclick="saveProfileChanges()" class="btn-primary w-full">×©××•×¨ ×©×™× ×•×™×™×</button>
            </div>
        </div>
    </div>

    <script>
        // --- 1. Firebase Config ---
        const firebaseConfig = { apiKey: "AIzaSyCrcxC420HW5PXGNd8M4KuclUkiJSwHreM", authDomain: "kesher-bakir.firebaseapp.com", projectId: "kesher-bakir", storageBucket: "kesher-bakir.firebasestorage.app", messagingSenderId: "671996189455", appId: "1:671996189455:web:dbe089d69a85a2ab38fc7a", measurementId: "G-42EWSKFXW" };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth(), db = firebase.firestore();

        // --- State ---
        const store = {
            user: null,
            currentScreen: 'home',
            chatTargetId: null,
            chatListener: null,
            data: { users: [], chats: [], messages: [] },
            tempImg: null
        };

        // --- Avatars ---
        const AVATARS = [
            {name:"×¡×‘× ×™×•×¡×£", url:"https://api.dicebear.com/9.x/avataaars/svg?seed=Felix&mouth=smile&eyebrows=default&clothing=collarAndSweater"},
            {name:"×¡×‘×ª× ×©×¨×”", url:"https://api.dicebear.com/9.x/avataaars/svg?seed=Aneka&mouth=smile&eyebrows=default&clothing=shirtScoopNeck"},
            {name:"×“×•×“ ××©×”", url:"https://api.dicebear.com/9.x/avataaars/svg?seed=Joshua&mouth=smile"},
            {name:"×“×•×“×” ×¨×‘×§×”", url:"https://api.dicebear.com/9.x/avataaars/svg?seed=Molly&mouth=smile"},
            {name:"×—×‘×¨ ×™×§×¨", url:"https://api.dicebear.com/9.x/avataaars/svg?seed=Liam&mouth=smile&glasses=round"},
            {name:"×—×‘×¨×” ×™×§×¨×”", url:"https://api.dicebear.com/9.x/avataaars/svg?seed=Zoe&mouth=smile&glasses=catEye"}
        ];

        // --- Init ---
        auth.onAuthStateChanged(async u => {
            if (u) {
                const doc = await db.collection('users').doc(u.uid).get();
                if (doc.exists) {
                    store.user = { uid: u.uid, ...doc.data() };
                    listenToData();
                    renderApp();
                } else {
                    // ×™×¦×™×¨×ª ××©×ª××© ×¨××©×•× ×™ ×× ×œ× ×§×™×™×
                    await db.collection('users').doc(u.uid).set({
                        name: u.displayName || '××©×ª××© ×—×“×©', email: u.email, 
                        avatarSeed: AVATARS[0].url, points: 0, role: 'user', 
                        joinDate: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    window.location.reload();
                }
            } else {
                renderLogin();
            }
            document.getElementById('loader').classList.add('hidden');
        });

        function listenToData() {
            // ×”××–× ×” ×œ××©×ª××©×™× (×œ×¨×©×™××ª ×”×¦'××˜)
            db.collection('users').onSnapshot(snap => {
                store.data.users = snap.docs.map(d => ({id: d.id, ...d.data()}));
                if (store.currentScreen === 'chat') renderChatScreen();
            });
            
            // ×”××–× ×” ×œ×¦'××˜×™× (×œ××•× ×™×)
            db.collection('chats').where('participants', 'array-contains', store.user.uid).onSnapshot(snap => {
                store.data.chats = snap.docs.map(d => ({id: d.id, ...d.data()}));
                renderFooter(); // ×¢×“×›×•×Ÿ ××•× ×” ×”×•×“×¢×•×ª
                if (store.currentScreen === 'chat') renderChatScreen();
            });
        }

        // --- Navigation & Rendering ---
        function navigate(screen) {
            store.currentScreen = screen;
            
            // ××™×¤×•×¡ ××¦×‘ ×¦'××˜ ×× ×™×•×¦××™× ××× ×•
            if (screen !== 'chat') {
                if (store.chatListener) store.chatListener(); // × ×™×ª×•×§ ×”××–× ×”
                store.chatTargetId = null;
                const app = document.getElementById('app');
                app.classList.remove('chat-mode-active'); // ×‘×™×˜×•×œ ××¦×‘ ××•×‘×™×™×œ
            }
            
            renderApp();
        }

        function renderApp() {
            renderHeader();
            renderFooter();
            const container = document.getElementById('content-container');
            container.innerHTML = '';

            switch (store.currentScreen) {
                case 'home': container.innerHTML = renderHome(); break;
                case 'chat': renderChatScreen(); break; // ×¨× ×“×•×¨ ××™×•×—×“ ×œ×¦'××˜
                case 'forums': container.innerHTML = `<div class="text-center p-10 text-gray-500">×¤×•×¨×•××™× (×‘×§×¨×•×‘)</div>`; break;
                case 'activities': container.innerHTML = `<div class="text-center p-10 text-gray-500">×¤×¢×™×œ×•×™×•×ª (×‘×§×¨×•×‘)</div>`; break;
                default: container.innerHTML = renderHome();
            }
        }

        // --- Components HTML Generators ---
        
        function renderHeader() {
            const u = store.user;
            const html = `
            <div class="app-header fixed top-0 w-full flex items-center justify-between px-4">
                <div class="flex items-center gap-2 w-1/3">
                     <div class="header-bubble hide-on-mobile" onclick="alert('×”×¦×¢×•×ª')">
                        <i class="fa-regular fa-lightbulb header-icon text-yellow-600"></i>
                        <span class="header-text">×”×¦×¢×•×ª</span>
                    </div>
                    <div class="header-bubble">
                        <span class="header-icon text-lg">â­</span>
                        <span class="header-text text-blue-600 text-xs">${u.points} × ×§'</span>
                        <span class="badge-text">×“×¨×’×”</span>
                    </div>
                </div>
                <div class="w-1/3 flex justify-center cursor-pointer" onclick="navigate('home')">
                    <div class="text-center">
                        <i class="fa-solid fa-heart text-3xl text-red-500"></i>
                        <div class="text-xs font-bold">×§×”×™×œ×ª ×§×©×¨</div>
                    </div>
                </div>
                <div class="flex items-center gap-2 justify-end w-1/3">
                    <div class="header-bubble" onclick="openProfileModal()">
                        <img src="${u.customImage || u.avatarSeed}" class="w-8 h-8 rounded-full object-cover border">
                        <span class="header-text">×¤×¨×•×¤×™×œ</span>
                    </div>
                    <button onclick="auth.signOut()" class="text-red-500 px-2"><i class="fa-solid fa-right-from-bracket text-xl"></i></button>
                </div>
            </div>`;
            document.getElementById('header-container').innerHTML = html;
        }

        function renderFooter() {
            const active = (s) => store.currentScreen === s ? 'text-red-600' : 'text-gray-400';
            const totalUnread = store.data.chats.reduce((sum, c) => sum + (c['unread_' + store.user.uid] || 0), 0);
            
            const html = `
            <div class="app-footer fixed bottom-0 w-full flex justify-between px-6 items-center">
                <button onclick="navigate('home')" class="nav-item ${active('home')}">
                    <i class="fa-solid fa-house"></i><span>×‘×™×ª</span>
                </button>
                <button onclick="navigate('activities')" class="nav-item ${active('activities')}">
                    <i class="fa-solid fa-person-walking"></i><span>×¤×¢×™×œ×•×™×•×ª</span>
                </button>
                <button onclick="navigate('forums')" class="nav-item ${active('forums')}">
                    <i class="fa-solid fa-comments"></i><span>×¤×•×¨×•××™×</span>
                </button>
                <button onclick="navigate('chat')" class="nav-item ${active('chat')} relative">
                    <div class="relative">
                        <i class="fa-solid fa-envelope"></i>
                        ${totalUnread > 0 ? `<span class="absolute -top-2 -right-2 bg-red-600 text-white text-[10px] px-1.5 rounded-full">${totalUnread}</span>` : ''}
                    </div>
                    <span>×”×•×“×¢×•×ª</span>
                </button>
            </div>`;
            document.getElementById('footer-container').innerHTML = html;
        }

        function renderHome() {
            return `
            <div class="text-center space-y-6 mt-4">
                <div class="bg-gradient-to-r from-red-500 to-pink-500 text-white p-6 rounded-2xl shadow-lg">
                    <h1 class="text-3xl font-bold mb-2">×©×œ×•×, ${store.user.name.split(' ')[0]}</h1>
                    <p>××” ×ª×¨×¦×” ×œ×¢×©×•×ª ×”×™×•×?</p>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <button onclick="navigate('chat')" class="bg-white p-6 rounded-2xl shadow-md border-t-4 border-blue-500">
                        <i class="fa-solid fa-comments text-4xl text-blue-500 mb-2"></i>
                        <div class="font-bold">×”×•×“×¢×•×ª</div>
                    </button>
                    <button onclick="navigate('activities')" class="bg-white p-6 rounded-2xl shadow-md border-t-4 border-green-500">
                        <i class="fa-solid fa-person-walking text-4xl text-green-500 mb-2"></i>
                        <div class="font-bold">×¤×¢×™×œ×•×™×•×ª</div>
                    </button>
                </div>
            </div>`;
        }

        // --- CHAT SYSTEM (Logic + UI) ---
        
        function renderChatScreen() {
            const container = document.getElementById('content-container');
            
            // 1. ×”×›× ×ª ×¨×©×™××ª ×”××©×ª××©×™× (××¡×•× × ×ª ×•×××•×™× ×ª)
            let users = store.data.users.filter(u => u.uid !== store.user.uid);
            
            // ××™×•×Ÿ: ×§×•×“× ×›×œ ××™ ×©×™×© ×”×•×“×¢×” ×©×œ× × ×§×¨××” ××× ×•
            users.sort((a, b) => {
                const chatA = store.data.chats.find(c => c.participants.includes(a.uid));
                const chatB = store.data.chats.find(c => c.participants.includes(b.uid));
                const unreadA = chatA ? (chatA['unread_' + store.user.uid] || 0) : 0;
                const unreadB = chatB ? (chatB['unread_' + store.user.uid] || 0) : 0;
                return unreadB - unreadA;
            });

            const targetUser = store.chatTargetId ? users.find(u => u.uid === store.chatTargetId) : null;
            
            const html = `
            <div class="chat-layout h-full">
                <div class="chat-sidebar">
                    <div class="p-3 bg-white border-b font-bold text-gray-700">×—×‘×¨×™× ×œ×©×™×—×”</div>
                    <div class="overflow-y-auto flex-1 p-1 space-y-1">
                        ${users.map(u => {
                            const chat = store.data.chats.find(c => c.participants.includes(u.uid));
                            const unread = chat ? (chat['unread_' + store.user.uid] || 0) : 0;
                            const isSelected = store.chatTargetId === u.uid;
                            
                            return `
                            <div onclick="selectChatUser('${u.uid}')" class="chat-item rounded-lg p-2 flex items-center gap-3 cursor-pointer hover:bg-white transition ${isSelected ? 'bg-white border-r-4 border-red-500 shadow-sm' : ''}">
                                <div class="relative">
                                    <img src="${u.customImage || u.avatarSeed}" class="w-10 h-10 rounded-full border bg-gray-200 object-cover">
                                    ${unread > 0 ? `<span class="absolute -top-1 -right-1 bg-red-600 text-white text-[10px] px-1.5 rounded-full border border-white">${unread}</span>` : ''}
                                </div>
                                <div class="flex-1">
                                    <div class="font-bold text-sm text-gray-800">${u.name}</div>
                                    <div class="text-xs text-gray-500 truncate">${u.city || ''}</div>
                                </div>
                            </div>`;
                        }).join('')}
                    </div>
                </div>

                <div class="chat-main">
                    ${targetUser ? `
                        <div class="p-3 bg-white border-b flex items-center gap-3 shadow-sm z-10">
                            <button onclick="closeChatMobile()" class="md:hidden text-gray-500"><i class="fa-solid fa-arrow-right text-xl"></i></button>
                            <img src="${targetUser.customImage || targetUser.avatarSeed}" class="w-8 h-8 rounded-full border">
                            <span class="font-bold">${targetUser.name}</span>
                        </div>
                        <div id="messagesBox" class="chat-messages">
                            <div class="flex justify-center mt-4"><span class="loading loading-dots"></span></div>
                        </div>
                        <div class="chat-input-bar">
                            <button onclick="toggleEmoji()" class="text-gray-500 text-xl p-1">ğŸ˜Š</button>
                            <input id="msgInput" placeholder="×›×ª×•×‘ ×”×•×“×¢×”..." class="flex-1 !mb-0" onkeydown="if(event.key==='Enter') sendMsg()">
                            <button onclick="sendMsg()" class="bg-red-600 text-white w-10 h-10 rounded-full flex items-center justify-center shadow"><i class="fa-solid fa-paper-plane"></i></button>
                        </div>
                        <div id="emojiPicker" class="emoji-picker hidden">
                            ${['â¤ï¸','ğŸ‘','ğŸ˜Š','ğŸ˜‚','ğŸŒ·','ğŸ‘‹','ğŸ™','â˜•'].map(e => `<button onclick="addEmoji('${e}')" class="text-2xl hover:bg-gray-100 rounded">${e}</button>`).join('')}
                        </div>
                    ` : `
                        <div class="flex flex-col items-center justify-center h-full text-gray-400">
                            <i class="fa-regular fa-comments text-6xl mb-4"></i>
                            <p>×‘×—×¨ ×—×‘×¨ ××”×¨×©×™××”</p>
                        </div>
                    `}
                </div>
            </div>`;
            
            container.innerHTML = html;
            
            // ×× ×™×© ××©×ª××© × ×‘×—×¨, ×˜×¢×Ÿ ××ª ×”×”×•×“×¢×•×ª ×©×œ×• (×× ×œ× × ×˜×¢× ×• ×›×‘×¨)
            if (targetUser) {
                // ×”×•×¡×¤×ª ×§×œ××¡ ×œ××•×‘×™×™×œ ×›×“×™ ×œ×”×¦×™×’ ××ª ×”×©×™×—×”
                document.getElementById('app').classList.add('chat-mode-active');
                
                // ×’×œ×™×œ×” ×œ××˜×”
                const box = document.getElementById('messagesBox');
                if (box) {
                    box.innerHTML = store.data.messages.map(m => {
                        const isMe = m.senderId === store.user.uid;
                        return `
                        <div class="flex ${isMe ? 'justify-end' : 'justify-start'}">
                            <div class="${isMe ? 'bg-red-500 text-white rounded-tl-none' : 'bg-gray-100 text-gray-800 rounded-tr-none'} p-2 px-3 rounded-xl max-w-[75%] shadow-sm text-sm break-words">
                                ${m.content}
                            </div>
                        </div>`;
                    }).join('');
                    box.scrollTop = box.scrollHeight;
                }
            } else {
                document.getElementById('app').classList.remove('chat-mode-active');
            }
        }

        // ×¤×•× ×§×¦×™×” ×©××—×œ×™×¤×” ××©×ª××© ×‘×¦'××˜
        window.selectChatUser = function(uid) {
            if (store.chatTargetId === uid) return; // ×›×‘×¨ × ×‘×—×¨
            
            // × ×™×ª×•×§ ×”××–× ×” ×§×•×“××ª
            if (store.chatListener) {
                store.chatListener();
                store.chatListener = null;
            }

            store.chatTargetId = uid;
            store.data.messages = []; // × ×™×§×•×™ ×”×•×“×¢×•×ª ×œ×ª×¦×•×’×”
            renderChatScreen(); // ×¨× ×“×•×¨ ×›×“×™ ×œ×”×¨××•×ª ××ª ×”-Loading ×•××¦×‘ ××•×‘×™×™×œ

            // ×—×™×‘×•×¨ ×”××–× ×” ×—×“×©×”
            const cid = [store.user.uid, uid].sort().join('_');
            
            // ××™×¤×•×¡ ××•× ×” ×”×•×“×¢×•×ª
            db.collection('chats').doc(cid).update({ [`unread_${store.user.uid}`]: 0 }).catch(()=>{});

            store.chatListener = db.collection('chats').doc(cid).collection('messages')
                .orderBy('timestamp', 'asc')
                .onSnapshot(snap => {
                    store.data.messages = snap.docs.map(d => ({id:d.id, ...d.data()}));
                    renderChatScreen(); // ×¨× ×“×•×¨ ×¢× ×”×”×•×“×¢×•×ª ×”×—×“×©×•×ª
                });
        };

        window.closeChatMobile = function() {
            store.chatTargetId = null;
            if (store.chatListener) store.chatListener();
            document.getElementById('app').classList.remove('chat-mode-active');
            renderChatScreen();
        };

        window.sendMsg = async function() {
            const txt = document.getElementById('msgInput').value;
            if (!txt.trim() || !store.chatTargetId) return;
            
            const cid = [store.user.uid, store.chatTargetId].sort().join('_');
            const otherId = store.chatTargetId;
            
            document.getElementById('msgInput').value = ''; // × ×™×§×•×™ ××™×“×™
            
            try {
                await db.collection('chats').doc(cid).collection('messages').add({
                    senderId: store.user.uid,
                    content: txt,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                await db.collection('chats').doc(cid).set({
                    participants: [store.user.uid, otherId],
                    lastMessage: txt,
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp(),
                    [`unread_${otherId}`]: firebase.firestore.FieldValue.increment(1)
                }, {merge: true});
            } catch(e) { alert("×©×’×™××” ×‘×©×œ×™×—×”"); }
        };

        // --- ×¢×–×¨×™× ×œ×¦'××˜ ---
        window.toggleEmoji = () => document.getElementById('emojiPicker').classList.toggle('hidden');
        window.addEmoji = (e) => { 
            const inp = document.getElementById('msgInput');
            inp.value += e; 
            inp.focus();
            document.getElementById('emojiPicker').classList.add('hidden'); // ×¡×’×™×¨×” ××•×˜×•××˜×™×ª
        };


        // --- ×¤×¨×•×¤×™×œ ×•××•×•×˜××¨×™× ---
        function openProfileModal() {
            document.getElementById('editCity').value = store.user.city || '';
            document.getElementById('editGender').value = store.user.gender || 'male';
            document.getElementById('previewImg').src = store.user.customImage || store.user.avatarSeed;
            
            const grid = document.getElementById('avatarGrid');
            grid.innerHTML = AVATARS.map(a => `
                <div onclick="selectAvatar('${a.url}', this)" class="avatar-grid-item rounded-lg p-1 bg-gray-50 border flex flex-col items-center hover:bg-gray-100 transition">
                    <img src="${a.url}" class="w-12 h-12 rounded-full bg-white mb-1 border">
                    <span class="text-[10px] font-bold">${a.name}</span>
                </div>
            `).join('');
            
            document.getElementById('profileModal').classList.remove('hidden');
        }

        window.selectAvatar = function(url, el) {
            store.tempImg = null; // ×‘×™×˜×•×œ ×”×¢×œ××” ×§×•×“××ª
            document.getElementById('selectedAvatarUrl').value = url;
            document.getElementById('previewImg').src = url;
            
            // ×¡×™××•×Ÿ
            document.querySelectorAll('.avatar-grid-item').forEach(d => d.classList.remove('selected'));
            el.classList.add('selected');
        }

        window.handleImageUpload = function(input) {
            const file = input.files[0];
            if (!file) return;
            
            // ×“×—×™×¡×ª ×ª××•× ×” (×”×§×˜× ×”) ×œ×× ×™×¢×ª ×§×¨×™×¡×”
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.src = e.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const maxSize = 300; // ×”×§×˜× ×” ×œ-300 ×¤×™×§×¡×œ×™×
                    let w = img.width, h = img.height;
                    
                    if (w > h) { if (w > maxSize) { h *= maxSize/w; w = maxSize; } }
                    else { if (h > maxSize) { w *= maxSize/h; h = maxSize; } }
                    
                    canvas.width = w; canvas.height = h;
                    ctx.drawImage(img, 0, 0, w, h);
                    
                    const compressedBase64 = canvas.toDataURL('image/jpeg', 0.7);
                    store.tempImg = compressedBase64;
                    document.getElementById('previewImg').src = compressedBase64;
                    document.getElementById('selectedAvatarUrl').value = ''; // ××™×¤×•×¡ ×‘×—×™×¨×ª ××•×•×˜××¨
                };
            };
            reader.readAsDataURL(file);
        }

        window.saveProfileChanges = async function() {
            const city = document.getElementById('editCity').value;
            const gender = document.getElementById('editGender').value;
            const updateData = { city, gender };
            
            if (store.tempImg) {
                updateData.customImage = store.tempImg;
                updateData.avatarSeed = null;
            } else {
                const avUrl = document.getElementById('selectedAvatarUrl').value;
                if (avUrl) {
                    updateData.avatarSeed = avUrl;
                    updateData.customImage = null;
                }
            }
            
            await db.collection('users').doc(store.user.uid).update(updateData);
            // ×¢×“×›×•×Ÿ ×œ×•×§××œ×™ ××”×™×¨
            store.user = { ...store.user, ...updateData };
            
            closeModal('profileModal');
            renderHeader(); // ×¨×¢× ×•×Ÿ ×”×”×“×¨ ×¢× ×”×ª××•× ×” ×”×—×“×©×”
        }
        
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
        
        function renderLogin() { return `<div class="flex flex-col items-center justify-center h-full p-6"><div class="mb-6 transform scale-150">${LOGO_SVG}</div><h1 class="text-3xl font-bold text-red-600 mb-8">×§×”×™×œ×ª ×§×©×¨</h1><button onclick="auth.signInWithPopup(new firebase.auth.GoogleAuthProvider())" class="btn-primary w-full py-4 text-lg shadow-lg">×›× ×™×¡×” ×¢× Google</button></div>`; }
    </script>
</body>
</html>
