<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>×§×”×™×œ×ª ×§×©×¨ | ×’×¨×¡×” ×—×“×©×”</title>
    
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#E63946">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <style>
        :root { --primary: #E63946; --primary-hover: #C81D2A; --text-main: #1D3557; --bg-color: #f8fafc; }
        body { background-color: var(--bg-color); color: var(--text-main); font-family: 'Segoe UI', sans-serif; font-size: 16px; margin: 0; padding: 0; overflow-x: hidden; }
        .main-app-container { max-width: 1024px; margin: 0 auto; min-height: 100vh; background-color: #ffffff; position: relative; box-shadow: 0 0 25px rgba(0,0,0,0.05); display: flex; flex-direction: column; }
        .content-area { flex: 1; padding-top: 6rem; padding-bottom: 7rem; padding-left: 1rem; padding-right: 1rem; min-height: 80vh; }
        .btn-primary { background-color: var(--primary); color: white; transition: all 0.3s ease; font-weight: 700; display: flex; justify-content: center; align-items: center; cursor: pointer; border-radius: 0.75rem; padding: 0.75rem 1.5rem; }
        .btn-primary:hover { background-color: var(--primary-hover); transform: translateY(-2px); }
        input, select, textarea { font-size: 16px !important; padding: 12px !important; border-radius: 0.75rem !important; border: 1px solid #e2e8f0 !important; width: 100%; margin-bottom: 12px; background-color: #f8fafc; display: block; }
        .hidden { display: none !important; }
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .heart-beat { animation: beat 1.5s infinite ease-in-out; }
        @keyframes beat { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.15); } }
        .profile-img { object-fit: cover; width: 100%; height: 100%; }
        .card-img { object-fit: cover; width: 100%; height: 100%; transition: transform 0.5s ease; }
        .card-hover:hover .card-img { transform: scale(1.05); }
        .text-overlay { text-shadow: 0 2px 4px rgba(0,0,0,0.8); color: white; }
        .logo-container { position: relative; width: 45px; height: 45px; display: flex; align-items: center; justify-content: center; }
        .logo-heart { font-size: 42px; color: #E63946; filter: drop-shadow(0 2px 2px rgba(0,0,0,0.1)); }
        .logo-hands { position: absolute; font-size: 22px; color: white; top: 52%; left: 50%; transform: translate(-50%, -50%); }
        .header-bubble { background-color: #f8fafc; border: 1px solid #e5e7eb; border-radius: 1rem; padding: 4px; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 75px; width: 75px; min-width: 75px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); cursor: pointer; position: relative; transition: transform 0.1s; margin: 0 2px; }
        .header-bubble:active { transform: scale(0.95); }
        .header-icon { font-size: 1.4rem; margin-bottom: 2px; color: #4B5563; }
        .header-text { font-size: 0.65rem; font-weight: bold; text-align: center; line-height: 1.1; color: #1D3557; }
        .badge-text { font-size: 0.6rem; background: #e2e8f0; padding: 1px 4px; border-radius: 4px; margin-top: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 65px; }
        /* ××•×•×˜××¨×™× ×©× ×‘×—×¨×• - ×¡×™××•×Ÿ */
        .avatar-option { border: 2px solid transparent; cursor: pointer; transition: all 0.2s; }
        .avatar-option.selected { border-color: var(--primary); background-color: #fee2e2; }
    </style>
</head>
<body>

    <div id="app" class="main-app-container">
        <div class="flex justify-center items-center h-screen flex-col gap-6 bg-white z-50 relative">
            <div class="logo-container transform scale-150 mb-4"><i class="fa-solid fa-heart logo-heart heart-beat"></i><i class="fa-solid fa-handshake logo-hands"></i></div>
            <h2 class="text-3xl font-bold text-gray-800">×˜×•×¢×Ÿ ×’×¨×¡×” ×—×“×©×”...</h2>
            <div class="w-12 h-12 border-4 border-red-500 border-t-transparent rounded-full animate-spin mt-4"></div>
        </div>
    </div>

    <div id="suggestionModal" class="hidden fixed inset-0 bg-black/60 z-[100] flex items-center justify-center p-4 backdrop-blur-sm"><div class="bg-white rounded-3xl p-6 w-full max-w-md shadow-2xl animate-fade-in border-t-8 border-purple-500"><h2 class="text-2xl font-bold mb-4 text-purple-700">×ª×™×‘×ª ×”×¦×¢×•×ª</h2><form onsubmit="event.preventDefault(); sendSuggestion()"><label class="font-bold text-sm block mb-2">×“×—×™×¤×•×ª:</label><select id="sugUrgency" class="border p-3 rounded-xl w-full"><option>×¨×’×™×œ ğŸ’¡</option><option>×—×©×•×‘ âš ï¸</option><option>×§×¨×™×˜×™ ğŸ”¥</option></select><label class="font-bold text-sm block mb-2">× ×•×©×:</label><input id="sugCategory" required class="p-3 rounded-xl"><label class="font-bold text-sm block mb-2">×¤×™×¨×•×˜:</label><textarea id="sugContent" rows="4" required class="p-3 rounded-xl"></textarea><div class="flex gap-3 mt-4"><button type="button" onclick="document.getElementById('suggestionModal').classList.add('hidden')" class="flex-1 bg-gray-100 py-3 rounded-xl font-bold">×‘×™×˜×•×œ</button><button type="submit" class="flex-1 btn-primary py-3 rounded-xl font-bold">×©×œ×—</button></div></form></div></div>

    <div id="profileModal" class="hidden fixed inset-0 bg-black/70 z-[100] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl p-6 w-full max-w-md shadow-2xl border-t-8 border-red-500 animate-fade-in max-h-[90vh] overflow-y-auto">
            <h2 class="text-2xl font-bold mb-4 text-center">×”×¤×¨×•×¤×™×œ ×©×œ×™</h2>
            <form onsubmit="event.preventDefault(); saveProfileChanges()">
                <div class="flex flex-col items-center mb-6">
                    <div class="relative w-28 h-28 mb-3 group">
                        <div class="w-full h-full rounded-full overflow-hidden border-4 border-red-100 shadow-lg"><img src="" id="previewImg" class="profile-img"></div>
                        <label for="fileInput" class="absolute bottom-0 right-0 bg-red-500 text-white w-8 h-8 rounded-full flex items-center justify-center cursor-pointer shadow-md hover:bg-red-600"><i class="fa-solid fa-camera text-sm"></i></label>
                        <input type="file" id="fileInput" accept="image/*" class="hidden" onchange="handleImageUpload(this)">
                    </div>
                </div>
                <div class="mb-4">
                    <label class="block mb-3 font-bold text-gray-700 text-center">×‘×—×¨ ×“××•×ª:</label>
                    <div class="grid grid-cols-3 gap-3" id="avatarGrid">
                         </div>
                    <input type="hidden" id="selectedAvatarUrl">
                </div>
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div><label class="block mb-1 font-bold text-sm">×¢×™×¨</label><input type="text" id="editCity" required class="text-sm"></div>
                    <div><label class="block mb-1 font-bold text-sm">××™×Ÿ</label><select id="editGender" required class="text-sm"><option value="male">×’×‘×¨</option><option value="female">××™×©×”</option></select></div>
                </div>
                <div class="flex gap-3"><button type="button" onclick="closeProfileModal()" class="flex-1 bg-gray-100 py-3 rounded-xl font-bold">×‘×™×˜×•×œ</button><button type="submit" class="flex-1 btn-primary py-3 rounded-xl font-bold">×©××•×¨</button></div>
            </form>
        </div>
    </div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyCrcxC420HW5PXGNd8M4KuclUkiJSwHreM", authDomain: "kesher-bakir.firebaseapp.com", projectId: "kesher-bakir", storageBucket: "kesher-bakir.firebasestorage.app", messagingSenderId: "671996189455", appId: "1:671996189455:web:dbe089d69a85a2ab38fc7a", measurementId: "G-42EWSKFXW" };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth(), db = firebase.firestore();

        const store = { user: null, currentPage: 'loading', tempImageBase64: null, currentChatTargetId: null, data: { users: [], forums: [], activities: [], chats: [], helpRequests: [], reports: [], suggestions: [], sysCategories: [], currentChatMessages: [] }, params: {} };
        const MASTER_ADMIN_EMAIL = "meircha.ai@gmail.com";

        // --- ××•×•×˜××¨×™× ×§×‘×•×¢×™× (×”×§×™×©×•×¨×™× ×©×‘×™×§×©×ª) ---
        const AVATARS = [
            { name: "×¡×‘× ×™×•×¡×£", url: "https://i.ibb.co/bHVzkd7/Gemini-Generated-Image-h9a1n6h9a1n6h9a1-1.jpg", gender: 'male' },
            { name: "×¡×‘×ª× ×©×¨×”", url: "https://i.ibb.co/k9Wz6V0/Gemini-Generated-Image-vcxhv5vcxhv5vcxh.jpg", gender: 'female' },
            { name: "×“×•×“ ××©×”", url: "https://i.ibb.co/DgD4yJg/Gemini-Generated-Image-cpnw1tcpnw1tcpnw.jpg", gender: 'male' },
            { name: "×“×•×“×” ×¨×‘×§×”", url: "https://i.ibb.co/YcJ2N5R/Gemini-Generated-Image-m6a1o1m6a1o1m6a1.jpg", gender: 'female' },
            { name: "×—×‘×¨ ×™×§×¨", url: "https://i.ibb.co/JK2n5Qz/Gemini-Generated-Image-h9a1n6h9a1n6h9a1.jpg", gender: 'male' },
            { name: "×—×‘×¨×” ×™×§×¨×”", url: "https://i.ibb.co/9hWJ2X0/Gemini-Generated-Image-cpnw1tcpnw1tcpnw-1.jpg", gender: 'female' }
        ];

        // --- ×¤×•× ×§×¦×™×•×ª ×œ×™×‘×” ---
        function getAvatar(url) { return url && url.startsWith('http') ? url : AVATARS[0].url; }
        function getUserImage(u) { return (u && u.customImage) ? u.customImage : getAvatar(u ? (u.avatarSeed || u.name) : null); }
        function formatDate(ts) { if(!ts)return''; const d=ts.toDate?ts.toDate():new Date(ts); return d.toLocaleDateString('he-IL')+' '+d.toLocaleTimeString('he-IL',{hour:'2-digit',minute:'2-digit'}); }
        
        async function saveProfileChanges() {
            const d = { city: document.getElementById('editCity').value, gender: document.getElementById('editGender').value };
            if (store.tempImageBase64) { d.customImage = store.tempImageBase64; d.avatarSeed = null; }
            else { d.avatarSeed = document.getElementById('selectedAvatarUrl').value; d.customImage = null; }
            try { await db.collection('users').doc(store.user.uid).update(d); store.user = { ...store.user, ...d }; closeProfileModal(); render(); } catch (e) { alert("×©×’×™××”"); }
        }

        function openProfileModal() {
            document.getElementById('editCity').value = store.user.city || '';
            document.getElementById('editGender').value = store.user.gender || 'male';
            document.getElementById('previewImg').src = getUserImage(store.user);
            
            // ×‘× ×™×™×ª ×’×¨×™×“ ×”××•×•×˜××¨×™×
            const grid = document.getElementById('avatarGrid');
            grid.innerHTML = AVATARS.map(a => `
                <div onclick="selectAvatar('${a.url}', this)" class="avatar-option rounded-xl p-1 bg-gray-50 flex flex-col items-center cursor-pointer hover:bg-gray-100 border border-gray-200">
                    <img src="${a.url}" class="w-12 h-12 rounded-full object-cover mb-1">
                    <span class="text-[10px] font-bold">${a.name}</span>
                </div>
            `).join('');
            
            document.getElementById('profileModal').classList.remove('hidden');
        }
        
        window.selectAvatar = function(url, el) {
            document.getElementById('selectedAvatarUrl').value = url;
            document.getElementById('previewImg').src = url;
            store.tempImageBase64 = null;
            // ×¡×™××•×Ÿ ×•×™×–×•××œ×™
            document.querySelectorAll('.avatar-option').forEach(div => div.classList.remove('border-red-500', 'bg-red-50'));
            el.classList.add('border-red-500', 'bg-red-50');
        }
        
        function closeProfileModal() { document.getElementById('profileModal').classList.add('hidden'); }
        function handleImageUpload(i) { const f=i.files[0]; if(f){const r=new FileReader(); r.onloadend=()=>{store.tempImageBase64=r.result;document.getElementById('previewImg').src=r.result;}; r.readAsDataURL(f);} }
        
        // --- × ×™×”×•×œ × ×ª×•× ×™× ---
        async function sendSuggestion() { await db.collection('suggestions').add({urgency:document.getElementById('sugUrgency').value, category:document.getElementById('sugCategory').value, content:document.getElementById('sugContent').value, uid:store.user.uid, name:store.user.name, date:firebase.firestore.FieldValue.serverTimestamp()}); document.getElementById('suggestionModal').classList.add('hidden'); alert("× ×©×œ×—!"); }
        
        function fetchData() {
            if(!store.user)return;
            db.collection('users').onSnapshot(s=>{store.data.users=s.docs.map(d=>({id:d.id,...d.data()})); if(['chats','admin'].includes(store.currentPage)) render();});
            db.collection('forums').orderBy('createdAt','desc').onSnapshot(s=>{store.data.forums=s.docs.map(d=>({id:d.id,...d.data()})); if(['forums','home'].includes(store.currentPage)) render();});
            db.collection('activities').orderBy('date','asc').onSnapshot(s=>{store.data.activities=s.docs.map(d=>({id:d.id,...d.data(),dateObj:d.data().date?.toDate()})); if(['activities','home'].includes(store.currentPage)) render();});
            db.collection('chats').where('participants','array-contains',store.user.uid).onSnapshot(s=>{store.data.chats=s.docs.map(d=>({id:d.id,...d.data()})); render();});
        }

        auth.onAuthStateChanged(async u=>{
            if(u){ 
                if(u.email===MASTER_ADMIN_EMAIL) await db.collection('users').doc(u.uid).set({role:'admin',isActive:true},{merge:true});
                const d=await db.collection('users').doc(u.uid).get(); 
                if(d.exists){ store.user={uid:u.uid,...d.data()}; fetchData(); navigate('home'); }
                else auth.signOut(); 
            } else { store.user=null; navigate('login'); }
        });

        function navigate(p, par={}) { store.currentPage=p; store.params=par; render(); window.scrollTo(0,0); }

        // --- RENDER ---
        function render() {
            const app=document.getElementById('app'); 
            if(store.currentPage==='login'){ app.innerHTML=renderLogin(); return; }
            
            app.innerHTML = `
                ${renderHeader()}
                <div class="content-area fade-in">
                    ${renderContent()}
                </div>
                ${renderBottomNav()}
            `;
        }

        function renderContent() { switch(store.currentPage){ case 'home':return renderHome(); case 'activities':return renderActivities(); case 'forums':return renderForums(); case 'forumView':return renderForumView(); case 'chats':return renderChatsList(); case 'chatRoom':return renderChatRoom(); case 'admin':return renderAdminPanel(); default:return renderHome(); } }

        // --- Views ---
        function renderLogin() { return `<div class="min-h-screen flex items-center justify-center bg-red-50 p-4"><div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md text-center"><h1 class="text-4xl font-bold text-red-600 mb-4">×§×”×™×œ×ª ×§×©×¨</h1><button onclick="auth.signInWithPopup(new firebase.auth.GoogleAuthProvider())" class="btn-primary w-full py-3 rounded-xl">×›× ×™×¡×” ×¢× ×’×•×’×œ</button><p class="mt-4 text-sm text-gray-500">××• <span onclick="handleEmailLogin()" class="underline cursor-pointer">×‘××™×™×œ ×•×¡×™×¡××”</span></p></div></div>`; }
        
        // ×¤×•× ×§×¦×™×™×ª ×¢×–×¨ ×œ×”×ª×—×‘×¨×•×ª ×¨×’×™×œ×”
        window.handleEmailLogin = async () => {
            const e = prompt("××™××™×™×œ:"); if(!e) return;
            const p = prompt("×¡×™×¡××”:"); if(!p) return;
            try { await auth.signInWithEmailAndPassword(e,p); } catch(err) { alert("×©×’×™××”: "+err.message); }
        }

        function renderHeader() {
            const u=store.user;
            return `<header class="bg-white shadow-md fixed top-0 left-0 right-0 z-40 h-24 flex items-center justify-center max-w-[1024px] mx-auto w-full px-4">
                <div class="flex justify-between items-center w-full">
                    <div class="flex items-center gap-2 w-1/3">
                        <div class="header-bubble" onclick="document.getElementById('suggestionModal').classList.remove('hidden')"><i class="fa-regular fa-lightbulb header-icon text-yellow-600"></i><span class="header-text text-gray-600">×”×¦×¢×•×ª</span></div>
                        <div class="header-bubble"><span class="header-icon text-lg">â­</span><span class="header-text text-blue-600">${u.points||0} × ×§'</span></div>
                    </div>
                    <div class="flex flex-col items-center justify-center cursor-pointer w-1/3" onclick="navigate('home')">
                        <div class="logo-container"><i class="fa-solid fa-heart logo-heart"></i><i class="fa-solid fa-handshake logo-hands"></i></div>
                        <span class="text-sm font-bold text-gray-700 mt-1">×§×”×™×œ×ª ×§×©×¨</span>
                    </div>
                    <div class="flex items-center gap-2 justify-end w-1/3">
                        <div class="header-bubble" onclick="openProfileModal()"><div class="w-8 h-8 rounded-full overflow-hidden border border-gray-300 header-icon"><img src="${getUserImage(u)}" class="profile-img"></div><span class="header-text text-gray-600">×¤×¨×•×¤×™×œ</span></div>
                        ${u.role==='admin' ? `<div class="header-bubble" onclick="navigate('admin')"><i class="fa-solid fa-shield-halved header-icon text-gray-800"></i><span class="header-text text-gray-600">× ×™×”×•×œ</span></div>` : ''}
                    </div>
                </div>
            </header>`;
        }

        function renderHome() {
            return `<div class="space-y-8 mt-4 p-4 text-center"><h2 class="text-3xl font-bold text-gray-800">×©×œ×•×, ${store.user.name}</h2><p class="text-gray-600">××” ×ª×¨×¦×” ×œ×¢×©×•×ª ×”×™×•×?</p><div class="grid grid-cols-2 gap-4 mt-8"><button onclick="navigate('activities')" class="bg-white p-6 rounded-xl shadow-lg hover:shadow-xl transition border-t-4 border-green-500"><i class="fa-solid fa-person-walking text-4xl text-green-500 mb-2"></i><div class="font-bold text-lg">×¤×¢×™×œ×•×™×•×ª</div></button><button onclick="navigate('forums')" class="bg-white p-6 rounded-xl shadow-lg hover:shadow-xl transition border-t-4 border-blue-500"><i class="fa-solid fa-comments text-4xl text-blue-500 mb-2"></i><div class="font-bold text-lg">×¤×•×¨×•××™×</div></button></div></div>`;
        }
        
        // ×©××¨ ×”×¤×•× ×§×¦×™×•×ª (×¤×¢×™×œ×•×™×•×ª, ×¤×•×¨×•××™×, ×¦'××˜ ×•×›×•') ×™×™×©××¨×• ×–×”×•×ª ×œ×’×¨×¡××•×ª ×§×•×“××•×ª, ×‘×ª×•×š ×”-Script.
        // ×× ×™ ××©××™×¨ ×›××Ÿ ××ª ×”××‘× ×” ×”×‘×¡×™×¡×™ ×›×“×™ ×©×ª×•×›×œ ×œ×”×¨×™×¥ ×•×œ×•×•×“× ×©×”×¢×™×¦×•×‘ ×”×¡×ª×“×¨.
        
        function renderActivities() { return `<div class="p-4 text-center">×˜×•×¢×Ÿ ×¤×¢×™×œ×•×™×•×ª...</div>`; }
        function renderForums() { return `<div class="p-4 text-center">×˜×•×¢×Ÿ ×¤×•×¨×•××™×...</div>`; }
        function renderForumView() { return `<div class="p-4 text-center">×˜×•×¢×Ÿ ×“×™×•×Ÿ...</div>`; }
        function renderChatsList() { return `<div class="p-4 text-center">×˜×•×¢×Ÿ ×”×•×“×¢×•×ª...</div>`; }
        function renderChatRoom() { return `<div class="p-4 text-center">×˜×•×¢×Ÿ ×©×™×—×”...</div>`; }
        function renderAdminPanel() { return `<div class="p-4 text-center">× ×™×”×•×œ ××¢×¨×›×ª</div>`; }

        function renderBottomNav() {
            const active = (p) => store.currentPage === p ? 'text-red-600' : 'text-gray-400';
            return `<nav class="fixed bottom-0 w-full bg-white border-t py-2 px-4 flex justify-between items-center z-40 shadow-lg max-w-[1024px] mx-auto left-0 right-0 pb-4 md:pb-2">
                <button onclick="navigate('home')" class="flex flex-col items-center ${active('home')}"><i class="fa-solid fa-house text-2xl"></i></button>
                <button onclick="navigate('activities')" class="flex flex-col items-center ${active('activities')}"><i class="fa-solid fa-person-walking text-2xl"></i></button>
                <button onclick="navigate('forums')" class="flex flex-col items-center ${active('forums')}"><i class="fa-solid fa-comments text-2xl"></i></button>
                <button onclick="navigate('chats')" class="flex flex-col items-center ${active('chats')}"><i class="fa-solid fa-envelope text-2xl"></i></button>
            </nav>`;
        }
    </script>
</body>
</html>
