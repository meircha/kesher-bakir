<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>קהילת קשר | החיים הטובים</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <style>
        /* --- 1. עיצוב חדש וצבעוני (מותאם לקהל מבוגר) --- */
        :root {
            --kesher-primary: #FF6B6B; /* Vibrant Coral - חם, אנרגטי */
            --kesher-secondary: #4ECDC4; /* Bright Aqua/Teal - מרענן, בהיר */
            --kesher-accent: #FFCD00; /* Gold/Yellow - אופטימיות, ניקוד */
            --kesher-text: #333;
        }
        .bg-kesher-primary { background-color: var(--kesher-primary); }
        .text-kesher-primary { color: var(--kesher-primary); }
        .border-kesher-primary { border-color: var(--kesher-primary); }
        .bg-kesher-secondary { background-color: var(--kesher-secondary); }
        .text-kesher-secondary { color: var(--kesher-secondary); }
        .bg-kesher-accent { background-color: var(--kesher-accent); }
        
        /* גלילה חלקה לכל האלמנטים */
        .smooth-scroll {
            scroll-behavior: smooth;
        }

        /* הסתרת סרגל הגלילה ב-Webkit (כרום, ספארי) */
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }
        /* הסתרת סרגל הגלילה ב-Firefox */
        .hide-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        
        /* סטייל ייחודי לכפתורים ראשיים */
        .btn-primary {
            @apply bg-kesher-primary text-white font-bold py-2 px-4 rounded-xl shadow-lg hover:bg-red-500 transition duration-300;
        }
        
        /* כפתור משני / ניטרלי */
        .btn-secondary {
             @apply bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-xl shadow-md hover:bg-gray-300 transition duration-300;
        }

        /* עיצוב כרטיסים ראשי */
        .card {
            @apply bg-white p-4 rounded-2xl shadow-xl border border-gray-100;
        }

        /* עיצוב לשדות קלט */
        .input-field {
            @apply w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-kesher-secondary focus:border-transparent transition duration-200;
        }

        /* מעבר (Transition) כללי לרכיבים */
        .app-transition {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* מיקום קבוע לכפתור הצ'אט */
        #chat-button {
            z-index: 50; /* מעל רוב האלמנטים */
            position: fixed;
            bottom: 6rem; /* מעל סרגל הניווט התחתון */
            left: 50%;
            transform: translateX(50%);
        }
        
        /* גובה מרבי לאזור גלילה */
        .max-h-main {
             max-height: calc(100vh - 10rem); /* גובה המסך פחות הכותרת והניווט התחתון */
        }

        /* הצללה קלה לכותרת ולניווט התחתון */
        .nav-shadow {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
        }

    </style>
</head>
<body class="bg-gray-50 text-kesher-text font-sans app-transition">

    <header id="app-header" class="fixed top-0 w-full bg-white p-4 nav-shadow z-40 app-transition">
        <div class="flex justify-between items-center max-w-xl mx-auto">
            <h1 id="header-title" class="text-2xl font-black text-kesher-primary">
                קהילת קשר
            </h1>
            <div id="header-user-info" class="flex items-center space-x-2 space-x-reverse">
                <button id="back-button" onclick="handleBack()" class="hidden text-kesher-primary p-2">
                    <i class="fas fa-arrow-right text-xl"></i>
                </button>
                <div id="profile-container" class="w-10 h-10 rounded-full bg-gray-200 text-gray-600 flex items-center justify-center text-lg font-bold cursor-pointer hover:shadow-lg transition duration-200" onclick="goTo('profile')">
                    </div>
            </div>
        </div>
    </header>

    <main class="pt-16 pb-20 max-w-xl mx-auto p-4 app-transition">
        <div id="content-container">
            <div id="loading-screen" class="flex flex-col items-center justify-center h-screen pt-16">
                 <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12 mb-4" style="border-top-color: var(--kesher-primary);"></div>
                 <style>
                    .loader { animation: spinner 1.5s linear infinite; }
                    @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
                </style>
                <p class="text-lg text-gray-600">טוען נתונים...</p>
            </div>
        </div>
    </main>

    <button id="chat-button" class="hidden w-16 h-16 rounded-full bg-kesher-secondary text-white shadow-2xl hover:bg-teal-500 transition duration-300 transform hover:scale-105" onclick="goTo('chats')">
        <i class="fas fa-comments text-2xl"></i>
        <span id="chat-badge" class="hidden absolute top-0 right-0 inline-flex items-center justify-center px-2 py-1 text-xs font-bold leading-none text-red-100 transform translate-x-1/2 -translate-y-1/2 bg-red-600 rounded-full">
            0
        </span>
    </button>
    
    <footer id="app-footer" class="fixed bottom-0 w-full bg-white p-2 nav-shadow z-40 app-transition">
        <nav class="flex justify-around items-center max-w-xl mx-auto">
            <button onclick="goTo('home')" class="nav-item p-2 flex flex-col items-center text-gray-500 hover:text-kesher-primary transition duration-200" data-screen="home">
                <i class="fas fa-home text-xl"></i>
                <span class="text-xs mt-1">בית</span>
            </button>
            <button onclick="goTo('forums')" class="nav-item p-2 flex flex-col items-center text-gray-500 hover:text-kesher-primary transition duration-200" data-screen="forums">
                <i class="fas fa-users text-xl"></i>
                <span class="text-xs mt-1">פורומים</span>
            </button>
            <button onclick="goTo('activities')" class="nav-item p-2 flex flex-col items-center text-gray-500 hover:text-kesher-primary transition duration-200" data-screen="activities">
                <i class="fas fa-calendar-alt text-xl"></i>
                <span class="text-xs mt-1">פעילויות</span>
            </button>
            <button onclick="goTo('profile')" class="nav-item p-2 flex flex-col items-center text-gray-500 hover:text-kesher-primary transition duration-200" data-screen="profile">
                <i class="fas fa-user text-xl"></i>
                <span class="text-xs mt-1">פרופיל</span>
            </button>
        </nav>
    </footer>

    <script>
        // --- 1. הגדרות ומשתני STATE ---

        // הגדרות Firebase - חובה להחליף בערכים האמיתיים שלך
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT_ID.appspot.com",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // אתחול Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // משתנה State גלובלי - מכיל את כל נתוני האפליקציה והמצב הנוכחי
        const state = {
            user: null,         // נתוני המשתמש המחובר (כולל role)
            screen: 'loading',  // המסך המוצג כרגע ('home', 'login', 'forums' וכו')
            
            // נתונים גלובליים
            users: [],          // רשימת כל המשתמשים
            forums: [],         // רשימת כל הפורומים
            posts: [],          // רשימת כל הפוסטים בפורום הנוכחי
            activities: [],     // רשימת כל הפעילויות
            
            // נתונים ספציפיים למסך
            selectedForumId: null, // ה-ID של הפורום הנבחר
            selectedPostId: null,  // ה-ID של הפוסט הנבחר
            selectedChatId: null,  // ה-ID של הצ'אט הנבחר
            selectedActivityId: null, // ה-ID של הפעילות הנבחרת
            
            // נתונים לצ'אט
            chats: [],           // רשימת חדרי הצ'אט של המשתמש
            messages: [],        // רשימת ההודעות בצ'אט הנבחר
            chatListeners: [],   // מערך לשמירת ה-Unsubscribe functions של הליסנרים
            
            // מוני התראות
            unreadCounts: {},    // { chatId: count, ... }
        };
        
        // --- 2. פונקציות עזר (HELPER FUNCTIONS) ---

        /**
         * פונקציה לטעינת נתונים פיקטיביים (למקרה של שגיאת הרשאות או בדיקה)
         * @param {boolean} forceUserFakes - האם לאלץ טעינת משתמשים פיקטיביים גם אם יש משתמש מחובר
         */
        function loadFakeForumData(forceUserFakes = false) {
            // משתמשים פיקטיביים (אם אין נתונים ב-Firestore)
            if (state.users.length === 0 || forceUserFakes) {
                state.users = [
                    { id: 'fake_admin', email: 'admin@kesher.com', displayName: 'אלי מנהל', role: 'admin', profilePic: 'https://i.pravatar.cc/150?img=68', isOnline: true },
                    { id: 'fake_senior', email: 'senior@kesher.com', displayName: 'רינה בכירה', role: 'senior', profilePic: 'https://i.pravatar.cc/150?img=52', isOnline: true },
                    { id: 'fake_user1', email: 'user1@kesher.com', displayName: 'דוד חבר', role: 'user', profilePic: 'https://i.pravatar.cc/150?img=53', isOnline: false },
                    { id: 'fake_user2', email: 'user2@kesher.com', displayName: 'לאה קהילה', role: 'user', profilePic: 'https://i.pravatar.cc/150?img=54', isOnline: false },
                ];
            }
            
            // פורומים פיקטיביים
            state.forums = [
                { id: 'forum1', name: 'חדר כושר וספורט', description: 'טיפים ודיונים על שמירה על כושר בגיל השלישי', icon: 'fas fa-dumbbell', lastActivity: new Date(Date.now() - 3600000) },
                { id: 'forum2', name: 'בישול ואפייה', description: 'מתכונים וחוויות מהמטבח של קהילת קשר', icon: 'fas fa-utensils', lastActivity: new Date(Date.now() - 7200000) },
                { id: 'forum3', name: 'טיולים בארץ ובעולם', description: 'שאלות, המלצות ותמונות מטיולים אחרונים', icon: 'fas fa-plane', lastActivity: new Date(Date.now() - 10800000) },
            ];

            // פוסטים פיקטיביים
            if (state.selectedForumId) {
                state.posts = [
                    { id: 'post1', creatorId: 'fake_admin', title: 'הליכה נורדית - מי ניסה?', content: 'אני מתאמן כבר חודשיים ומרגיש שיפור!', createdAt: new Date(Date.now() - 86400000), repliesCount: 3 },
                    { id: 'post2', creatorId: 'fake_user1', title: 'כמה חלבון צריך אחרי גיל 60?', content: 'אני לא בטוח כמה לאכול, אשמח לדעות', createdAt: new Date(Date.now() - 172800000), repliesCount: 1 },
                ];
            }

            // פעילויות פיקטיביות
            state.activities = [
                { id: 'activity1', name: 'הרצאה: בריאות המוח', date: new Date(Date.now() + 86400000 * 2), location: 'זום', creatorId: 'fake_admin' },
                { id: 'activity2', name: 'טיול רגלי בנחל הירקון', date: new Date(Date.now() + 86400000 * 5), location: 'תל אביב', creatorId: 'fake_senior' },
            ];
            
            console.log("Fake data loaded.");
        }

        /**
         * מחזיר תווית תפקיד מעוצבת
         * @param {string} role - התפקיד ('admin', 'senior', 'user')
         * @returns {string} HTML של התווית
         */
        function getRoleLabel(role) {
            const colors = {
                'admin': 'bg-red-500',
                'senior': 'bg-kesher-secondary',
                'user': 'bg-gray-400'
            };
            const text = {
                'admin': 'מנהל',
                'senior': 'בכיר',
                'user': 'חבר'
            };
            return `<span class="text-xs font-semibold px-2 py-0.5 rounded-full text-white ${colors[role] || 'bg-gray-400'}">${text[role] || 'אורח'}</span>`;
        }

        /**
         * מחזיר HTML של תמונת פרופיל או ראשי תיבות
         * @param {object} user - אובייקט המשתמש (חייב להכיל displayName)
         * @param {string} sizeClass - קלאס Tailwind לגודל ('w-10 h-10' וכו')
         * @param {boolean} showOnlineStatus - האם להציג נקודה ירוקה
         * @returns {string} HTML
         */
        function renderProfilePic(user, sizeClass = 'w-10 h-10', showOnlineStatus = true) {
             const initials = user.displayName ? user.displayName.split(' ').map(n => n[0]).join('') : '?';
             const isOnline = user.isOnline && showOnlineStatus;
             
             let content;
             if (user.profilePic) {
                 content = `<img src="${user.profilePic}" alt="${user.displayName}" class="w-full h-full object-cover rounded-full">`;
             } else {
                 content = `<span class="text-white text-sm font-bold">${initials}</span>`;
             }

             const onlineBadge = isOnline ? `<span class="absolute bottom-0 right-0 ${sizeClass === 'w-10 h-10' ? 'w-3 h-3' : 'w-2.5 h-2.5'} bg-green-500 rounded-full border-2 border-white"></span>` : '';
             
             return `
                 <div class="relative ${sizeClass} rounded-full bg-kesher-secondary flex items-center justify-center flex-shrink-0">
                     ${content}
                     ${onlineBadge}
                 </div>
             `;
        }
        
        /**
         * פורמט מרחק הזמן מהיום (כמו: לפני 5 דקות)
         * @param {Date} date - אובייקט תאריך
         * @returns {string}
         */
        function formatDistanceToNow(date) {
            if (!(date instanceof Date) || isNaN(date)) return 'תאריך לא חוקי';
            
            const now = new Date();
            const diff = now.getTime() - date.getTime();
            
            const seconds = Math.floor(diff / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);
            const months = Math.floor(days / 30);
            const years = Math.floor(days / 365);
            
            if (seconds < 60) return 'לפני רגע';
            if (minutes < 60) return `לפני ${minutes} דקות`;
            if (hours < 24) return `לפני ${hours} שעות`;
            if (days < 30) return `לפני ${days} ימים`;
            if (months < 12) return `לפני ${months} חודשים`;
            return `לפני ${years} שנים`;
        }
        
        /**
         * פורמט זמן להצגת הודעות צ'אט (שעה:דקה או תאריך מלא)
         * @param {Date} date - אובייקט תאריך
         * @returns {string}
         */
        function formatChatTimestamp(date) {
            if (!(date instanceof Date) || isNaN(date)) return '';
            
            const now = new Date();
            const isToday = date.toDateString() === now.toDateString();
            
            if (isToday) {
                return date.toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit' });
            } else {
                return date.toLocaleDateString('he-IL', { day: 'numeric', month: 'numeric' });
            }
        }
        
        /**
         * מציאת משתמש לפי ID
         */
        function findUserById(id) {
            return state.users.find(u => u.id === id);
        }

        // --- 3. פונקציות טעינת מסכים ---

        /**
         * רנדור המסך הראשי
         */
        function renderHomePage() {
            const today = new Date().toLocaleDateString('he-IL', { weekday: 'long', day: 'numeric', month: 'long' });
            
            // טופ 3 פורומים עם פעילות אחרונה
            const topForums = state.forums
                .sort((a, b) => b.lastActivity.getTime() - a.lastActivity.getTime())
                .slice(0, 3);
                
            // פעילויות קרובות
            const upcomingActivities = state.activities
                 .filter(a => a.date.getTime() > Date.now())
                 .sort((a, b) => a.date.getTime() - b.date.getTime())
                 .slice(0, 2);

            return `
                <h2 class="text-3xl font-extrabold text-gray-800 mb-4">שלום, ${state.user.displayName}!</h2>
                <p class="text-lg text-gray-600 mb-6">${today}</p>
                
                <div class="card bg-kesher-secondary/10 mb-8 border-kesher-secondary">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-3 space-x-reverse">
                            ${renderProfilePic(state.user, 'w-14 h-14', true)}
                            <div>
                                <p class="text-xl font-bold">${state.user.displayName}</p>
                                <p class="text-sm text-gray-600">${getRoleLabel(state.user.role)}</p>
                            </div>
                        </div>
                        <button onclick="goTo('profile')" class="text-kesher-primary hover:text-red-500 font-bold">
                            <i class="fas fa-cog"></i>
                        </button>
                    </div>
                </div>

                <h3 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-bullhorn text-kesher-primary ml-2"></i>
                    פעילויות קרובות
                </h3>
                <div class="space-y-4 mb-8">
                    ${upcomingActivities.length > 0 ? upcomingActivities.map(activity => `
                        <div class="card p-3 flex justify-between items-center cursor-pointer hover:bg-gray-50" onclick="goTo('activityDetails', '${activity.id}')">
                            <div>
                                <p class="font-bold text-lg">${activity.name}</p>
                                <p class="text-sm text-gray-500">
                                    <i class="fas fa-calendar-day ml-1"></i>
                                    ${activity.date.toLocaleDateString('he-IL', { day: 'numeric', month: 'numeric' })} |
                                    <i class="fas fa-map-marker-alt ml-1"></i>
                                    ${activity.location}
                                </p>
                            </div>
                            <i class="fas fa-chevron-left text-gray-400"></i>
                        </div>
                    `).join('') : '<p class="text-gray-500">אין פעילויות קרובות כרגע.</p>'}
                </div>
                
                <h3 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-users text-kesher-secondary ml-2"></i>
                    דיונים מובילים
                </h3>
                <div class="space-y-4">
                    ${topForums.map(forum => `
                        <div class="card cursor-pointer hover:bg-gray-50" onclick="goTo('posts', '${forum.id}')">
                            <div class="flex items-center space-x-4 space-x-reverse">
                                <div class="w-14 h-14 rounded-full bg-kesher-primary/10 text-kesher-primary flex items-center justify-center text-xl">
                                    <i class="${forum.icon}"></i>
                                </div>
                                <div>
                                    <p class="font-bold text-xl">${forum.name}</p>
                                    <p class="text-sm text-gray-500">${forum.description}</p>
                                    <p class="text-xs text-gray-400 mt-1">פעילות אחרונה: ${formatDistanceToNow(forum.lastActivity)}</p>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                    <button onclick="goTo('forums')" class="w-full btn-secondary mt-4">
                        כל הפורומים
                    </button>
                </div>
            `;
        }

        /**
         * רנדור מסך הפורומים
         */
        function renderForumsPage() {
            state.screenName = "פורומים";
             return `
                <h2 class="text-3xl font-bold text-gray-800 mb-6">כל הפורומים</h2>
                <div class="space-y-4">
                    ${state.forums.map(forum => `
                        <div class="card cursor-pointer hover:bg-gray-50" onclick="goTo('posts', '${forum.id}')">
                            <div class="flex items-center space-x-4 space-x-reverse">
                                <div class="w-14 h-14 rounded-full bg-kesher-secondary/10 text-kesher-secondary flex items-center justify-center text-2xl flex-shrink-0">
                                    <i class="${forum.icon}"></i>
                                </div>
                                <div>
                                    <p class="font-bold text-xl">${forum.name}</p>
                                    <p class="text-sm text-gray-600">${forum.description}</p>
                                    <p class="text-xs text-gray-400 mt-1">פעילות אחרונה: ${formatDistanceToNow(forum.lastActivity)}</p>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        /**
         * רנדור מסך הפוסטים בפורום נבחר
         */
        async function renderPostsPage() {
            if (!state.selectedForumId) return goTo('forums');

            const forum = state.forums.find(f => f.id === state.selectedForumId);
            if (!forum) return goTo('forums');
            
            state.screenName = forum.name;
            
            // טעינת פוסטים מה-DB (אם לא נטענו)
            if (!state.posts.length || state.posts[0].forumId !== forum.id) {
                 try {
                    const postsSnapshot = await db.collection('forums').doc(forum.id).collection('posts').orderBy('createdAt', 'desc').get();
                    state.posts = postsSnapshot.docs.map(doc => ({ 
                        id: doc.id, 
                        ...doc.data(), 
                        createdAt: doc.data().createdAt?.toDate() || new Date() 
                    }));
                } catch(e) {
                     // אם נכשל, נטען נתונים פיקטיביים (שנטענו כבר ב-loadFakeForumData)
                     console.error("שגיאה בטעינת פוסטים מה-DB:", e);
                }
            }


            return `
                <h2 class="text-3xl font-bold text-kesher-secondary mb-2">${forum.name}</h2>
                <p class="text-gray-600 mb-6">${forum.description}</p>

                <button onclick="goTo('newPost')" class="btn-primary w-full mb-6 flex items-center justify-center">
                    <i class="fas fa-plus ml-2"></i>
                    פרסם פוסט חדש
                </button>
                
                <div class="space-y-4">
                    ${state.posts.length > 0 ? state.posts.map(post => {
                        const creator = findUserById(post.creatorId);
                        return `
                            <div class="card cursor-pointer hover:shadow-lg transition duration-200" onclick="goTo('postDetails', '${post.id}')">
                                <h3 class="font-bold text-xl mb-1 text-kesher-primary">${post.title}</h3>
                                <p class="text-gray-700 line-clamp-2">${post.content}</p>
                                
                                <div class="flex items-center justify-between mt-3 text-sm text-gray-500 border-t pt-2">
                                    <div class="flex items-center space-x-2 space-x-reverse">
                                        ${renderProfilePic(creator || { displayName: 'אנונימי' }, 'w-6 h-6', false)}
                                        <span class="font-semibold">${creator ? creator.displayName : 'משתמש נמחק'}</span>
                                        ${creator ? getRoleLabel(creator.role) : ''}
                                    </div>
                                    <div class="text-xs">
                                        <i class="fas fa-comment ml-1"></i> ${post.repliesCount || 0} תגובות
                                        <span class="mx-2">|</span>
                                        ${formatDistanceToNow(post.createdAt)}
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('') : '<p class="text-gray-500">אין פוסטים בפורום זה עדיין.</p>'}
                </div>
            `;
        }

        /**
         * רנדור מסך יצירת פוסט חדש
         */
        function renderNewPostPage() {
            state.screenName = "פוסט חדש";
            return `
                <h2 class="text-3xl font-bold text-gray-800 mb-6">פרסום ב${state.forums.find(f => f.id === state.selectedForumId)?.name}</h2>
                <div class="card p-6">
                    <input type="text" id="post-title" placeholder="כותרת הפוסט" class="input-field mb-4 text-xl font-bold" maxlength="80">
                    <textarea id="post-content" placeholder="תוכן הפוסט המלא..." class="input-field mb-6 h-40 resize-none"></textarea>
                    
                    <button onclick="publishPost()" class="btn-primary w-full">
                        <i class="fas fa-paper-plane ml-2"></i>
                        פרסם עכשיו
                    </button>
                </div>
            `;
        }
        
        /**
         * פרסום פוסט חדש ל-Firestore
         */
        async function publishPost() {
            const title = document.getElementById('post-title').value.trim();
            const content = document.getElementById('post-content').value.trim();
            
            if (!title || !content) {
                alert('אנא מלא כותרת ותוכן לפוסט.');
                return;
            }
            if (!state.selectedForumId || !state.user) {
                alert('שגיאת מערכת: לא ניתן לפרסם פוסט כרגע.');
                return;
            }

            try {
                const forumRef = db.collection('forums').doc(state.selectedForumId);
                const postsCollection = forumRef.collection('posts');
                
                // הוספת הפוסט החדש
                const newPostRef = await postsCollection.add({
                    forumId: state.selectedForumId,
                    creatorId: state.user.id,
                    title: title,
                    content: content,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    repliesCount: 0
                });
                
                // עדכון זמן פעילות אחרונה בפורום האב
                await forumRef.update({
                    lastActivity: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                alert('הפוסט פורסם בהצלחה!');
                // ניתוב לפוסט החדש או חזרה לרשימת הפוסטים
                goTo('posts', state.selectedForumId); 
            } catch (error) {
                console.error("שגיאה בפרסום פוסט:", error);
                alert('אירעה שגיאה בפרסום הפוסט. נסה שוב.');
            }
        }
        
        /**
         * רנדור מסך פרטי פוסט (Post Details)
         */
        async function renderPostDetailsPage() {
            if (!state.selectedPostId) return goTo('home');

            let post = state.posts.find(p => p.id === state.selectedPostId);
            if (!post) {
                // נסה לטעון מה-DB אם הגיעו לכאן ישירות
                try {
                    const postDoc = await db.collectionGroup('posts').where(firebase.firestore.FieldPath.documentId(), '==', state.selectedPostId).limit(1).get();
                    if (!postDoc.empty) {
                        post = { id: postDoc.docs[0].id, ...postDoc.docs[0].data(), createdAt: postDoc.docs[0].data().createdAt?.toDate() || new Date() };
                        state.selectedForumId = post.forumId; // לוודא שה-ForumId מעודכן
                    } else {
                        return goTo('home');
                    }
                } catch(e) {
                    console.error("שגיאה בטעינת פוסט:", e);
                    return goTo('home');
                }
            }
            
            // טעינת תגובות
            let replies = [];
            try {
                const repliesSnapshot = await db.collection('forums').doc(post.forumId).collection('posts').doc(post.id).collection('replies').orderBy('createdAt', 'asc').get();
                replies = repliesSnapshot.docs.map(doc => ({ 
                    id: doc.id, 
                    ...doc.data(), 
                    createdAt: doc.data().createdAt?.toDate() || new Date() 
                }));
            } catch(e) {
                 console.error("שגיאה בטעינת תגובות:", e);
                 // נמשיך בלי תגובות
            }

            const forum = state.forums.find(f => f.id === post.forumId);
            const creator = findUserById(post.creatorId);
            state.screenName = post.title;

            return `
                <div class="mb-4 text-sm text-gray-500 flex items-center">
                    <i class="fas fa-users ml-1"></i>
                    <span onclick="goTo('posts', '${post.forumId}')" class="font-semibold text-kesher-secondary hover:underline cursor-pointer">${forum ? forum.name : 'פורום נמחק'}</span>
                </div>

                <div class="card p-6 mb-6">
                    <h2 class="text-3xl font-extrabold text-kesher-primary mb-3">${post.title}</h2>
                    
                    <div class="flex items-center space-x-3 space-x-reverse mb-4 text-gray-600">
                        ${renderProfilePic(creator || { displayName: 'אנונימי' }, 'w-8 h-8', false)}
                        <span class="font-semibold">${creator ? creator.displayName : 'משתמש נמחק'}</span>
                        ${creator ? getRoleLabel(creator.role) : ''}
                        <span class="text-sm text-gray-400">| ${formatDistanceToNow(post.createdAt)}</span>
                    </div>

                    <p class="text-lg leading-relaxed whitespace-pre-wrap">${post.content}</p>
                </div>
                
                <h3 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">${replies.length} תגובות</h3>
                
                <div class="card p-4 mb-6">
                    <textarea id="reply-content" placeholder="הוסף תגובה..." class="input-field mb-3 resize-none"></textarea>
                    <button onclick="publishReply()" class="btn-secondary w-full">
                        <i class="fas fa-reply ml-2"></i>
                        שלח תגובה
                    </button>
                </div>

                <div class="space-y-4">
                    ${replies.map(reply => {
                        const replyCreator = findUserById(reply.creatorId);
                        return `
                            <div class="card p-4 bg-gray-50 border-gray-200">
                                <div class="flex items-start space-x-3 space-x-reverse mb-2">
                                    ${renderProfilePic(replyCreator || { displayName: 'אנונימי' }, 'w-8 h-8', false)}
                                    <div>
                                        <span class="font-bold">${replyCreator ? replyCreator.displayName : 'משתמש נמחק'}</span>
                                        ${replyCreator ? getRoleLabel(replyCreator.role) : ''}
                                        <p class="text-xs text-gray-400 mt-0.5">${formatDistanceToNow(reply.createdAt)}</p>
                                    </div>
                                </div>
                                <p class="text-gray-700 whitespace-pre-wrap">${reply.content}</p>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        /**
         * פרסום תגובה חדשה לפוסט
         */
        async function publishReply() {
            const content = document.getElementById('reply-content').value.trim();
            
            if (!content) {
                alert('אנא מלא תוכן לתגובה.');
                return;
            }
            if (!state.selectedPostId || !state.selectedForumId || !state.user) {
                alert('שגיאת מערכת: לא ניתן לפרסם תגובה.');
                return;
            }

            try {
                const repliesCollection = db.collection('forums').doc(state.selectedForumId).collection('posts').doc(state.selectedPostId).collection('replies');
                const postRef = db.collection('forums').doc(state.selectedForumId).collection('posts').doc(state.selectedPostId);
                const forumRef = db.collection('forums').doc(state.selectedForumId);

                // 1. הוספת התגובה
                await repliesCollection.add({
                    creatorId: state.user.id,
                    content: content,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // 2. עדכון מונה התגובות בפוסט
                await postRef.update({
                    repliesCount: firebase.firestore.FieldValue.increment(1)
                });

                // 3. עדכון זמן הפעילות בפורום האב
                await forumRef.update({
                    lastActivity: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // 4. ניקוי השדה ורנדור מחדש
                document.getElementById('reply-content').value = '';
                await render();
                
                alert('התגובה נשלחה בהצלחה!');
                
                // גלילה אוטומטית לתחתית התגובות
                const mainContent = document.querySelector('main');
                if(mainContent) {
                   mainContent.scrollTo({ top: mainContent.scrollHeight, behavior: 'smooth' });
                }

            } catch (error) {
                console.error("שגיאה בפרסום תגובה:", error);
                alert('אירעה שגיאה בפרסום התגובה. נסה שוב.');
            }
        }

        /**
         * רנדור מסך הצ'אטים
         */
        async function renderChatsPage() {
            state.screenName = "הודעות פרטיות";
            
            // נקה ליסנרים קודמים (אם יש)
            state.chatListeners.forEach(unsubscribe => unsubscribe());
            state.chatListeners = [];

            // 1. טעינת חדרי הצ'אט של המשתמש
            try {
                const chatsSnapshot = await db.collection('chats')
                    .where('participants', 'array-contains', state.user.id)
                    .orderBy('lastMessageAt', 'desc')
                    .get();

                state.chats = chatsSnapshot.docs.map(doc => {
                    const data = doc.data();
                    // מציאת ה-ID של המשתמש השני
                    const otherUserId = data.participants.find(id => id !== state.user.id);
                    const otherUser = findUserById(otherUserId);
                    
                    return {
                        id: doc.id,
                        otherUser: otherUser,
                        lastMessageText: data.lastMessageText || 'התחילו שיחה חדשה',
                        lastMessageAt: data.lastMessageAt?.toDate() || new Date(0),
                        unreadCount: data[`unread_${state.user.id}`] || 0
                    };
                });
            } catch (e) {
                 console.error("שגיאה בטעינת רשימת צ'אטים:", e);
                 state.chats = []; // כדי למנוע קריסה
            }

            // 2. האזנה לשינויים בחדרי הצ'אט (לעדכון מונה הודעות בזמן אמת)
            const chatListener = db.collection('chats')
                .where('participants', 'array-contains', state.user.id)
                .onSnapshot(snapshot => {
                    snapshot.docChanges().forEach(change => {
                        if (change.type === 'modified' || change.type === 'added') {
                            const data = change.doc.data();
                            const chatId = change.doc.id;
                            const unreadCount = data[`unread_${state.user.id}`] || 0;
                            
                            state.unreadCounts[chatId] = unreadCount;
                        }
                    });
                    updateChatBadge(); // עדכן את האייקון הצף
                    render(); // רנדר מחדש את המסך הנוכחי אם הוא 'chats'
                }, error => {
                    console.error("שגיאת האזנה לצ'אטים:", error);
                });

            state.chatListeners.push(chatListener);


            return `
                <h2 class="text-3xl font-bold text-gray-800 mb-6">הודעות פרטיות (${state.chats.length})</h2>
                
                <div class="space-y-3">
                    ${state.chats.length > 0 ? state.chats.map(chat => `
                        <div class="card p-4 flex items-center justify-between cursor-pointer hover:bg-gray-50 transition duration-200 relative" onclick="goTo('chatDetails', '${chat.id}')">
                            <div class="flex items-center space-x-3 space-x-reverse">
                                ${renderProfilePic(chat.otherUser || { displayName: 'משתמש נמחק' }, 'w-12 h-12', true)}
                                <div>
                                    <p class="font-bold text-lg">${chat.otherUser ? chat.otherUser.displayName : 'צ'אט לא קיים'}</p>
                                    <p class="text-sm text-gray-600 truncate max-w-xs">${chat.lastMessageText}</p>
                                </div>
                            </div>
                            
                            <div class="flex flex-col items-end text-sm text-gray-400">
                                <span class="mb-1">${formatChatTimestamp(chat.lastMessageAt)}</span>
                                ${chat.unreadCount > 0 ? `<span class="bg-kesher-primary text-white text-xs font-bold w-6 h-6 rounded-full flex items-center justify-center">${chat.unreadCount}</span>` : ''}
                            </div>
                        </div>
                    `).join('') : '<p class="text-gray-500">אין לך צ׳אטים פעילים עדיין. התחל שיחה עם מישהו מהמשתמשים!</p>'}
                </div>
                
                <button onclick="goTo('usersList')" class="btn-primary w-full mt-6 flex items-center justify-center">
                    <i class="fas fa-plus ml-2"></i>
                    התחל צ'אט חדש
                </button>
            `;
        }

        /**
         * רנדור מסך צ'אט ספציפי
         */
        async function renderChatDetailsPage() {
            if (!state.selectedChatId) return goTo('chats');

            const chatDoc = state.chats.find(c => c.id === state.selectedChatId);
            if (!chatDoc) return goTo('chats');

            const otherUser = chatDoc.otherUser;
            state.screenName = otherUser ? otherUser.displayName : 'שיחה פרטית';

            // נקה ליסנרים קודמים (רק של הודעות)
            state.chatListeners.forEach(unsubscribe => unsubscribe());
            state.chatListeners = [];
            
            // 1. האזנה להודעות חדשות
            const messagesListener = db.collection('chats').doc(state.selectedChatId).collection('messages')
                .orderBy('createdAt', 'asc')
                .onSnapshot(snapshot => {
                    state.messages = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data(),
                        createdAt: doc.data().createdAt?.toDate() || new Date()
                    }));
                    renderMessages(); // פונקציית עזר לרנדור מהיר של ההודעות בלבד
                    scrollToBottom();
                    
                    // 2. איפוס מונה ההודעות הלא-נקראות (רק לאחר הרנדור)
                    resetUnreadCount(state.selectedChatId);

                }, error => {
                    console.error("שגיאת האזנה להודעות:", error);
                });

            state.chatListeners.push(messagesListener);

            // יצירת מסך ריק שיימולא ע"י renderMessages
            return `
                <div class="flex items-center space-x-3 space-x-reverse pb-4 border-b mb-4">
                    ${renderProfilePic(otherUser || { displayName: 'משתמש נמחק' }, 'w-12 h-12', true)}
                    <h2 class="text-2xl font-bold text-gray-800">${otherUser ? otherUser.displayName : 'משתמש נמחק'}</h2>
                </div>
                
                <div id="messages-container" class="space-y-4 max-h-main overflow-y-auto hide-scrollbar">
                    </div>
                
                <div class="fixed bottom-0 w-full max-w-xl p-4 bg-white border-t nav-shadow">
                    <div class="flex space-x-2 space-x-reverse">
                        <textarea id="message-input" placeholder="כתוב הודעה..." class="input-field flex-grow resize-none overflow-hidden h-12" rows="1" oninput="autoExpandTextarea(this)"></textarea>
                        <button onclick="sendMessage()" class="bg-kesher-primary text-white w-12 h-12 rounded-full flex items-center justify-center hover:bg-red-500 transition duration-200">
                            <i class="fas fa-paper-plane text-xl"></i>
                        </button>
                    </div>
                </div>
            `;
        }

        /**
         * רנדור ההודעות בלבד (משמש בליסנר)
         */
        function renderMessages() {
            const container = document.getElementById('messages-container');
            if (!container) return; // אם לא במסך הצ'אט

            const html = state.messages.map(message => {
                const isMe = message.senderId === state.user.id;
                const alignment = isMe ? 'justify-end' : 'justify-start';
                const bgColor = isMe ? 'bg-kesher-secondary' : 'bg-gray-200';
                const textColor = isMe ? 'text-white' : 'text-gray-800';
                
                return `
                    <div class="flex ${alignment}">
                        <div class="${bgColor} ${textColor} p-3 rounded-xl max-w-xs shadow-md">
                            <p class="whitespace-pre-wrap">${message.text}</p>
                            <span class="text-xs mt-1 block ${isMe ? 'text-white/80' : 'text-gray-500'} text-left">${formatChatTimestamp(message.createdAt)}</span>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = html;
        }

        /**
         * שליחת הודעת צ'אט
         */
        async function sendMessage() {
            const input = document.getElementById('message-input');
            const text = input.value.trim();

            if (!text || !state.selectedChatId || !state.user) return;

            try {
                const chatRef = db.collection('chats').doc(state.selectedChatId);
                const messagesCollection = chatRef.collection('messages');
                const otherUserId = state.chats.find(c => c.id === state.selectedChatId)?.otherUser?.id;

                // 1. הוספת ההודעה
                await messagesCollection.add({
                    senderId: state.user.id,
                    text: text,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                // 2. עדכון חדר הצ'אט (הודעה אחרונה ומונה לא נקרא)
                if (otherUserId) {
                    await chatRef.update({
                        lastMessageText: text,
                        lastMessageAt: firebase.firestore.FieldValue.serverTimestamp(),
                        // הגדלת המונה של המשתמש השני
                        [`unread_${otherUserId}`]: firebase.firestore.FieldValue.increment(1)
                    });
                }

                // 3. ניקוי ואיפוס השדה
                input.value = '';
                input.style.height = '48px'; // איפוס גובה
                scrollToBottom();

            } catch (error) {
                console.error("שגיאה בשליחת הודעה:", error);
                alert('שגיאה בשליחת ההודעה. נסה שוב.');
            }
        }
        
        /**
         * איפוס מונה ההודעות הלא נקראות בצ'אט מסוים
         */
        async function resetUnreadCount(chatId) {
            try {
                if (state.user && state.user.id) {
                     await db.collection('chats').doc(chatId).update({
                        [`unread_${state.user.id}`]: 0
                    });
                    delete state.unreadCounts[chatId];
                    updateChatBadge();
                }
            } catch (e) {
                console.error("שגיאה באיפוס מונה לא נקרא:", e);
            }
        }

        /**
         * גלילה לתחתית אזור ההודעות
         */
        function scrollToBottom() {
            const container = document.getElementById('messages-container');
            if (container) {
                setTimeout(() => {
                     container.scrollTop = container.scrollHeight;
                }, 100);
            }
        }

        /**
         * שינוי גובה ה-textarea אוטומטית
         */
        function autoExpandTextarea(element) {
            element.style.height = 'auto';
            element.style.height = (element.scrollHeight) + 'px';
        }

        /**
         * רנדור מסך רשימת המשתמשים (להתחלת צ'אט חדש)
         */
        function renderUsersListPage() {
             state.screenName = "התחלת שיחה חדשה";
             const usersToChat = state.users.filter(u => u.id !== state.user.id);
             
             return `
                <h2 class="text-3xl font-bold text-gray-800 mb-6">בחר משתמש להתחלת שיחה</h2>
                
                <div class="space-y-4">
                    ${usersToChat.map(user => {
                        const existingChat = state.chats.find(c => c.otherUser?.id === user.id);
                        return `
                             <div class="card p-4 flex items-center justify-between cursor-pointer hover:bg-gray-50 transition duration-200" 
                                onclick="startOrGoToChat('${user.id}')">
                                <div class="flex items-center space-x-3 space-x-reverse">
                                    ${renderProfilePic(user, 'w-12 h-12', true)}
                                    <div>
                                        <p class="font-bold text-lg">${user.displayName}</p>
                                        <p class="text-sm text-gray-600">${getRoleLabel(user.role)}</p>
                                    </div>
                                </div>
                                <span class="text-kesher-secondary font-bold">
                                    ${existingChat ? 'המשך שיחה' : 'התחל צ'אט'}
                                    <i class="fas fa-chevron-left ml-1"></i>
                                </span>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }
        
        /**
         * יצירת צ'אט חדש או ניתוב לצ'אט קיים
         */
        async function startOrGoToChat(otherUserId) {
            const existingChat = state.chats.find(c => c.otherUser?.id === otherUserId);
            
            if (existingChat) {
                // צ'אט קיים - נווט אליו
                goTo('chatDetails', existingChat.id);
                return;
            }
            
            // צ'אט חדש - יצירת מסמך Chat חדש
            try {
                const newChatRef = await db.collection('chats').add({
                    participants: [state.user.id, otherUserId],
                    lastMessageText: '',
                    lastMessageAt: firebase.firestore.FieldValue.serverTimestamp(),
                    // מוני הודעות לא נקראות
                    [`unread_${state.user.id}`]: 0,
                    [`unread_${otherUserId}`]: 0,
                });
                
                // עדכן את המצב ונווט לצ'אט החדש
                // (האזנת הצ'אטים תטפל בעדכון ה-state.chats בפועל)
                goTo('chatDetails', newChatRef.id);

            } catch (error) {
                console.error("שגיאה ביצירת צ'אט חדש:", error);
                alert('אירעה שגיאה ביצירת הצ׳אט. נסה שוב.');
            }
        }


        /**
         * רנדור מסך פעילויות
         */
        function renderActivitiesPage() {
            state.screenName = "פעילויות קהילה";
            
            const futureActivities = state.activities.filter(a => a.date.getTime() > Date.now())
                .sort((a, b) => a.date.getTime() - b.date.getTime());
            
            const pastActivities = state.activities.filter(a => a.date.getTime() <= Date.now())
                .sort((a, b) => b.date.getTime() - a.date.getTime());

            const renderActivityCard = (activity) => {
                const dateString = activity.date.toLocaleDateString('he-IL', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
                const timeString = activity.date.toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit' });

                return `
                    <div class="card p-4 flex flex-col cursor-pointer hover:bg-gray-50 transition duration-200" onclick="goTo('activityDetails', '${activity.id}')">
                        <p class="font-bold text-xl text-kesher-primary mb-2">${activity.name}</p>
                        <p class="text-sm text-gray-600 mb-1">
                            <i class="fas fa-calendar-day ml-1 text-kesher-secondary"></i>
                            ${dateString}, ${timeString}
                        </p>
                        <p class="text-sm text-gray-600">
                            <i class="fas fa-map-marker-alt ml-1 text-kesher-secondary"></i>
                            ${activity.location}
                        </p>
                    </div>
                `;
            };

            return `
                <h2 class="text-3xl font-bold text-gray-800 mb-6">פעילויות קהילה</h2>
                
                ${state.user.role === 'admin' || state.user.role === 'senior' ? `
                    <button onclick="goTo('newActivity')" class="btn-primary w-full mb-6 flex items-center justify-center">
                        <i class="fas fa-calendar-plus ml-2"></i>
                        פרסם פעילות חדשה
                    </button>
                ` : ''}

                <h3 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-1">
                    <i class="fas fa-forward ml-2 text-kesher-secondary"></i>
                    פעילויות עתידיות
                </h3>
                <div class="space-y-4 mb-8">
                    ${futureActivities.length > 0 ? futureActivities.map(renderActivityCard).join('') : '<p class="text-gray-500">אין פעילויות מתוכננות.</p>'}
                </div>
                
                 <h3 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-1">
                    <i class="fas fa-backward ml-2 text-gray-400"></i>
                    פעילויות שהיו
                </h3>
                <div class="space-y-4">
                    ${pastActivities.length > 0 ? pastActivities.map(renderActivityCard).join('') : '<p class="text-gray-500">אין פעילויות קודמות.</p>'}
                </div>
            `;
        }

        /**
         * רנדור מסך יצירת פעילות חדשה
         */
        function renderNewActivityPage() {
            state.screenName = "פעילות חדשה";
            return `
                <h2 class="text-3xl font-bold text-gray-800 mb-6">פרסום פעילות חדשה</h2>
                <div class="card p-6">
                    <input type="text" id="activity-name" placeholder="שם הפעילות (הרצאה/טיול/סדנה)" class="input-field mb-4 text-xl font-bold" maxlength="100">
                    <input type="text" id="activity-location" placeholder="מיקום (זום / שם מקום)" class="input-field mb-4">
                    <input type="datetime-local" id="activity-date" class="input-field mb-6">
                    
                    <button onclick="publishActivity()" class="btn-primary w-full">
                        <i class="fas fa-calendar-check ml-2"></i>
                        פרסם פעילות
                    </button>
                </div>
            `;
        }

        /**
         * פרסום פעילות חדשה ל-Firestore
         */
        async function publishActivity() {
            const name = document.getElementById('activity-name').value.trim();
            const location = document.getElementById('activity-location').value.trim();
            const dateValue = document.getElementById('activity-date').value;
            
            if (!name || !location || !dateValue) {
                alert('אנא מלא את כל השדות.');
                return;
            }
            if (!state.user || (state.user.role !== 'admin' && state.user.role !== 'senior')) {
                alert('אין לך הרשאה לפרסם פעילות.');
                return;
            }

            const activityDate = new Date(dateValue);

            try {
                // הוספת הפעילות החדשה
                await db.collection('activities').add({
                    name: name,
                    location: location,
                    date: activityDate,
                    creatorId: state.user.id,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                alert('הפעילות פורסמה בהצלחה!');
                
                // עדכון הנתונים וניתוב למסך הפעילויות
                const activitiesSnapshot = await db.collection('activities').get();
                state.activities = activitiesSnapshot.docs.map(doc => ({ 
                    id: doc.id, 
                    ...doc.data(), 
                    date: doc.data().date?.toDate() || new Date() 
                }));
                
                goTo('activities'); 

            } catch (error) {
                console.error("שגיאה בפרסום פעילות:", error);
                alert('אירעה שגיאה בפרסום הפעילות. נסה שוב.');
            }
        }
        
        /**
         * רנדור מסך פרטי פעילות
         */
        function renderActivityDetailsPage() {
            if (!state.selectedActivityId) return goTo('activities');
            
            const activity = state.activities.find(a => a.id === state.selectedActivityId);
            if (!activity) return goTo('activities');
            
            state.screenName = activity.name;
            const dateString = activity.date.toLocaleDateString('he-IL', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
            const timeString = activity.date.toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit' });
            const creator = findUserById(activity.creatorId);

            return `
                <h2 class="text-3xl font-extrabold text-kesher-primary mb-4">${activity.name}</h2>
                
                <div class="card p-6 space-y-4">
                    <div class="flex items-center text-xl text-gray-700">
                        <i class="fas fa-calendar-day ml-3 text-kesher-secondary"></i>
                        <span class="font-bold">${dateString}</span>
                        <span class="mx-3 text-gray-400">|</span>
                        <span>${timeString}</span>
                    </div>
                    
                    <div class="flex items-center text-xl text-gray-700">
                        <i class="fas fa-map-marker-alt ml-3 text-kesher-secondary"></i>
                        <span class="font-bold">${activity.location}</span>
                    </div>
                    
                    <div class="flex items-center text-base text-gray-500 pt-3 border-t">
                        ${renderProfilePic(creator || { displayName: 'אנונימי' }, 'w-8 h-8', false)}
                        <span class="mr-2">פורסם על ידי: ${creator ? creator.displayName : 'משתמש נמחק'}</span>
                    </div>
                </div>
                
                <p class="text-gray-700 mt-6 p-4 bg-gray-100 rounded-xl">
                    ${activity.details || 'פרטים נוספים יפורסמו בהמשך...'}
                </p>
                
                ${activity.date.getTime() > Date.now() ? `
                    <button class="btn-primary w-full mt-6">
                        <i class="fas fa-check-circle ml-2"></i>
                        להרשמה לפעילות
                    </button>
                ` : `
                     <div class="bg-gray-200 text-gray-600 p-3 rounded-xl w-full mt-6 text-center font-bold">
                        פעילות זו התקיימה
                    </div>
                `}
            `;
        }


        /**
         * רנדור מסך הפרופיל
         */
        function renderProfilePage() {
            state.screenName = "הפרופיל שלי";
             return `
                <h2 class="text-3xl font-bold text-gray-800 mb-6">הפרופיל שלי</h2>
                
                <div class="card p-6 flex flex-col items-center mb-8">
                    ${renderProfilePic(state.user, 'w-24 h-24', true)}
                    <h3 class="text-3xl font-bold mt-4">${state.user.displayName}</h3>
                    <p class="text-lg text-gray-600 mb-4">${state.user.email}</p>
                    ${getRoleLabel(state.user.role)}
                </div>
                
                ${state.user.role === 'admin' || state.user.role === 'senior' ? `
                    <div class="card p-6 mb-8 space-y-4">
                        <h4 class="text-xl font-bold text-kesher-primary border-b pb-2">אזור ניהול</h4>
                        <button class="w-full text-right py-2 text-lg text-gray-700 hover:text-kesher-secondary">
                            <i class="fas fa-users-cog ml-2"></i>
                            ניהול משתמשים
                        </button>
                        <button class="w-full text-right py-2 text-lg text-gray-700 hover:text-kesher-secondary">
                            <i class="fas fa-chart-line ml-2"></i>
                            סטטיסטיקות
                        </button>
                    </div>
                ` : ''}

                <button onclick="logout()" class="btn-secondary w-full">
                    <i class="fas fa-sign-out-alt ml-2"></i>
                    התנתקות
                </button>
            `;
        }

        /**
         * רנדור מסך ההתחברות
         */
        function renderLoginPage() {
            state.screenName = "התחברות";
            return `
                <div class="flex flex-col items-center justify-center h-screen pt-16">
                    <h2 class="text-4xl font-black text-kesher-primary mb-8">ברוך הבא לקהילת קשר</h2>
                    <div class="card p-8 w-full max-w-sm">
                        <input type="email" id="login-email" placeholder="דוא''ל" class="input-field mb-4">
                        <input type="password" id="login-password" placeholder="סיסמה" class="input-field mb-6">
                        
                        <button onclick="login()" class="btn-primary w-full mb-4">
                            התחברות
                        </button>
                        
                        <p class="text-center text-gray-600">
                            עדיין לא חבר? <button onclick="goTo('register')" class="text-kesher-secondary font-bold hover:underline">הירשם עכשיו</button>
                        </p>
                    </div>
                </div>
            `;
        }

        /**
         * רנדור מסך ההרשמה
         */
        function renderRegisterPage() {
             state.screenName = "הרשמה";
             return `
                <div class="flex flex-col items-center justify-center h-screen pt-16">
                    <h2 class="text-4xl font-black text-kesher-primary mb-8">הרשמה לקהילת קשר</h2>
                    <div class="card p-8 w-full max-w-sm">
                        <input type="text" id="register-name" placeholder="שם מלא (יופיע בפרופיל)" class="input-field mb-4">
                        <input type="email" id="register-email" placeholder="דוא''ל" class="input-field mb-4">
                        <input type="password" id="register-password" placeholder="סיסמה (לפחות 6 תווים)" class="input-field mb-4">
                        
                        <button onclick="register()" class="btn-primary w-full mb-4">
                            <i class="fas fa-user-plus ml-2"></i>
                            הרשמה
                        </button>
                        
                        <p class="text-center text-gray-600">
                            יש לך חשבון? <button onclick="goTo('login')" class="text-kesher-secondary font-bold hover:underline">התחבר</button>
                        </p>
                    </div>
                </div>
            `;
        }


        // --- 4. מנגנון ניווט ורנדור ראשי ---

        /**
         * מעבר בין מסכים
         * @param {string} newScreen - שם המסך אליו עוברים
         * @param {string} dataId - ID אופציונלי (למשל, ID של פורום או פוסט)
         */
        function goTo(newScreen, dataId = null) {
            // ניקוי ליסנרים קודמים אם עוזבים מסך עם האזנה
            if (state.screen === 'chats' || state.screen === 'chatDetails') {
                state.chatListeners.forEach(unsubscribe => unsubscribe());
                state.chatListeners = [];
            }

            // עדכון המצב (State)
            state.screen = newScreen;
            state.selectedForumId = null;
            state.selectedPostId = null;
            state.selectedChatId = null;
            state.selectedActivityId = null;
            
            // שמירת נתונים ספציפיים למסך
            if (newScreen === 'posts') {
                state.selectedForumId = dataId;
            } else if (newScreen === 'postDetails') {
                state.selectedPostId = dataId;
            } else if (newScreen === 'newPost') {
                state.selectedForumId = dataId; // ה-dataId הוא ה-forumId
            } else if (newScreen === 'chatDetails') {
                state.selectedChatId = dataId;
            } else if (newScreen === 'activityDetails') {
                state.selectedActivityId = dataId;
            }
            
            // קריאה לרנדור הראשי
            render();
        }

        /**
         * מטפל בכפתור "חזור"
         */
        function handleBack() {
             // לוגיקה פשוטה של חזור
             if (state.screen === 'posts' || state.screen === 'newActivity') {
                 goTo('forums');
             } else if (state.screen === 'postDetails' || state.screen === 'newPost') {
                 goTo('posts', state.selectedForumId);
             } else if (state.screen === 'chatDetails' || state.screen === 'usersList') {
                 goTo('chats');
             } else if (state.screen === 'activityDetails') {
                 goTo('activities');
             } else {
                 goTo('home'); // ברירת מחדל
             }
        }

        /**
         * עדכון תגית ההתראה הצפה של הצ'אטים
         */
        function updateChatBadge() {
             const totalUnread = Object.values(state.unreadCounts).reduce((sum, count) => sum + count, 0);
             const badge = document.getElementById('chat-badge');
             const button = document.getElementById('chat-button');
             
             if (badge && button) {
                 if (totalUnread > 0) {
                     badge.innerText = totalUnread;
                     badge.classList.remove('hidden');
                     button.classList.remove('hidden');
                 } else {
                     badge.classList.add('hidden');
                     button.classList.remove('hidden'); // תמיד מציג את הכפתור אם המשתמש מחובר
                 }
             }
        }

        /**
         * פונקציית הרנדור הראשית - קובעת מה להציג
         */
        async function render() {
            const container = document.getElementById('content-container');
            const headerTitle = document.getElementById('header-title');
            const headerElement = document.getElementById('app-header');
            const footerElement = document.getElementById('app-footer');
            const backButton = document.getElementById('back-button');
            const chatButton = document.getElementById('chat-button');
            const mainContentArea = document.querySelector('main');
            
            if (!container || !mainContentArea) return; // לוודא שה-DOM טעון

            // ----------------------------------------------------
            // 🚨 טיפול ראשוני ב-Header וב-Footer 
            // ----------------------------------------------------
            
            // הגדרת ברירת מחדל: גלויים והריפוד הרגיל
            headerElement.classList.remove('hidden');
            footerElement.classList.remove('hidden');
            mainContentArea.classList.remove('pt-0'); // ניקוי ה-pt-0
            mainContentArea.classList.add('pt-16'); // החזרת הריפוד של Header
            backButton.classList.add('hidden');
            chatButton.classList.add('hidden');
            
            // ניקוי אלמנטים של טעינה
            container.innerHTML = '';
            
            // רנדור המסך המתאים
            let contentHtml = '';
            let isPublicScreen = false;
            let currentScreenName = '';

            if (!state.user && state.screen !== 'login' && state.screen !== 'register' && state.screen !== 'loading') {
                goTo('login');
                return;
            }
            
            // ----------------------------------------------------
            // ניתוב המסכים
            // ----------------------------------------------------
            switch (state.screen) {
                case 'loading':
                    contentHtml = document.getElementById('loading-screen').outerHTML;
                    headerElement.classList.add('hidden');
                    footerElement.classList.add('hidden');
                    isPublicScreen = true;
                    mainContentArea.classList.remove('pt-16');
                    break;
                case 'login':
                    contentHtml = renderLoginPage();
                    headerElement.classList.add('hidden'); 
                    footerElement.classList.add('hidden');
                    mainContentArea.classList.add('pt-0'); // דרוש כדי שהמסך יתפוס 100% מהגובה
                    mainContentArea.classList.remove('pt-16');
                    isPublicScreen = true;
                    break;
                case 'register':
                    contentHtml = renderRegisterPage();
                    headerElement.classList.add('hidden'); 
                    footerElement.classList.add('hidden');
                    mainContentArea.classList.add('pt-0');
                    mainContentArea.classList.remove('pt-16');
                    isPublicScreen = true;
                    break;
                case 'home':
                    contentHtml = renderHomePage();
                    currentScreenName = "קהילת קשר";
                    chatButton.classList.remove('hidden');
                    break;
                case 'forums':
                    contentHtml = renderForumsPage();
                    currentScreenName = state.screenName;
                    backButton.classList.remove('hidden');
                    chatButton.classList.remove('hidden');
                    break;
                case 'posts':
                    contentHtml = await renderPostsPage();
                    currentScreenName = state.screenName;
                    backButton.classList.remove('hidden');
                    chatButton.classList.remove('hidden');
                    break;
                case 'newPost':
                    contentHtml = renderNewPostPage();
                    currentScreenName = state.screenName;
                    backButton.classList.remove('hidden');
                    chatButton.classList.remove('hidden');
                    break;
                case 'postDetails':
                    contentHtml = await renderPostDetailsPage();
                    currentScreenName = state.screenName;
                    backButton.classList.remove('hidden');
                    chatButton.classList.remove('hidden');
                    break;
                case 'activities':
                    contentHtml = renderActivitiesPage();
                    currentScreenName = state.screenName;
                    chatButton.classList.remove('hidden');
                    break;
                case 'newActivity':
                    contentHtml = renderNewActivityPage();
                    currentScreenName = state.screenName;
                    backButton.classList.remove('hidden');
                    chatButton.classList.remove('hidden');
                    break;
                case 'activityDetails':
                    contentHtml = renderActivityDetailsPage();
                    currentScreenName = state.screenName;
                    backButton.classList.remove('hidden');
                    chatButton.classList.remove('hidden');
                    break;
                case 'chats':
                    contentHtml = await renderChatsPage();
                    currentScreenName = state.screenName;
                    chatButton.classList.remove('hidden');
                    break;
                case 'usersList':
                    contentHtml = renderUsersListPage();
                    currentScreenName = state.screenName;
                    backButton.classList.remove('hidden');
                    chatButton.classList.remove('hidden');
                    break;
                case 'chatDetails':
                    // הצ'אט הוא מסך מיוחד עם אזור קלט קבוע
                    contentHtml = await renderChatDetailsPage();
                    // הסתרת פוטר הניווט כדי למנוע הפרעה לאזור הקלט
                    footerElement.classList.add('hidden'); 
                    backButton.classList.remove('hidden');
                    chatButton.classList.add('hidden');
                    break;
                case 'profile':
                    contentHtml = renderProfilePage();
                    currentScreenName = state.screenName;
                    chatButton.classList.remove('hidden');
                    break;
                default:
                    // אם מגיעים למסך לא מוכר, נווט לבית או לוגין
                    state.user ? goTo('home') : goTo('login');
                    return;
            }

            // ----------------------------------------------------
            // 🚨 טיפול בסיום הרינדור
            // ----------------------------------------------------
            
            
            // עדכון הכותרת
            headerTitle.innerText = currentScreenName || "קהילת קשר";
            
            // רנדור התוכן ל-DOM
            container.innerHTML = contentHtml;
            
            // עדכון תמונת הפרופיל בכותרת
            const profileContainer = document.getElementById('profile-container');
            if (profileContainer && state.user && !isPublicScreen) {
                profileContainer.innerHTML = renderProfilePic(state.user, 'w-10 h-10', true);
            }
            
            // עדכון סרגל הניווט התחתון
            document.querySelectorAll('.nav-item').forEach(btn => {
                if (btn.dataset.screen === state.screen || (state.screen === 'posts' && btn.dataset.screen === 'forums') || (state.screen === 'postDetails' && btn.dataset.screen === 'forums')) {
                    btn.classList.add('text-kesher-primary');
                    btn.classList.remove('text-gray-500');
                } else {
                    btn.classList.add('text-gray-500');
                    btn.classList.remove('text-kesher-primary');
                }
            });
            
            // עדכון תגית הצ'אט
            if (!isPublicScreen) {
                updateChatBadge();
            }
        }

        // --- 5. פונקציות אחזור נתונים ראשוני ו-Firebase Auth ---
        
        /**
         * אחזור נתונים ראשוני מ-Firestore (חיוני למניעת המסך הלבן) - **תוקן לטיפול בשגיאות מחמיר**
         */
        async function fetchInitialData() {
            // **שלב 1: טעינת נתונים פיקטיביים קודם (כברירת מחדל)**
            loadFakeForumData(false); 
            
            // 2.1. אחזור רשימת משתמשים - עטוף ב-try/catch ספציפי
            try {
                const usersSnapshot = await db.collection('users').get();
                if (!usersSnapshot.empty) {
                    state.users = usersSnapshot.docs.map(doc => ({ 
                        id: doc.id, 
                        ...doc.data(), 
                        isOnline: doc.data().isOnline || false,
                        role: doc.data().role || 'user',
                        isActive: doc.data().isActive !== false
                    }));
                    console.log(`✓ נטענו ${state.users.length} משתמשים מ-Firestore.`);
                } else {
                    // אם אין משתמשים ב-Firestore, טען פיקטיביים (forceUserFakes = true)
                    loadFakeForumData(true); 
                    console.log("✓ אין משתמשים ב-Firestore. נטענו משתמשים פיקטיביים.");
                }
                
            } catch (error) {
                // שגיאה בקריאת users (כנראה הרשאות) - נשתמש בפיקטיביים ונמשיך
                console.error("⚠️ שגיאה באחזור משתמשים (בדוק Rules!):", error.message);
                loadFakeForumData(true); 
            }
            
            // 2.2. אחזור פעילויות - עטוף ב-try/catch ספציפי
            try {
                const activitiesSnapshot = await db.collection('activities').get();
                state.activities = activitiesSnapshot.docs.map(doc => ({ 
                    id: doc.id, 
                    ...doc.data(), 
                    date: doc.data().date?.toDate() || new Date() 
                }));
                 console.log(`✓ נטענו ${state.activities.length} פעילויות מ-Firestore.`);
            } catch (error) {
                console.warn("⚠️ שגיאה באחזור פעילויות (בדוק Rules!):", error.message);
                // הנתונים הפיקטיביים כבר נטענו
            }
            
            // 2.3. אחזור מונה הודעות שלא נקראו - רק אם המשתמש מחובר
            if (state.user && state.user.id) {
                try {
                    // נסה קודם לאחזר את ה-chats
                    const myChatsSnapshot = await db.collection('chats')
                        .where('participants', 'array-contains', state.user.id)
                        .get();
                    
                    state.chats = myChatsSnapshot.docs.map(doc => {
                         const data = doc.data();
                         // מציאת ה-ID של המשתמש השני
                         const otherUserId = data.participants.find(id => id !== state.user.id);
                         const otherUser = findUserById(otherUserId);
                         
                         return {
                             id: doc.id,
                             otherUser: otherUser,
                             lastMessageText: data.lastMessageText || 'התחילו שיחה חדשה',
                             lastMessageAt: data.lastMessageAt?.toDate() || new Date(0),
                             unreadCount: data[`unread_${state.user.id}`] || 0
                         };
                    });
                    
                    state.unreadCounts = {};
                    for (const chatDoc of myChatsSnapshot.docs) {
                        const unreadCountForMe = chatDoc.data()[`unread_${state.user.id}`] || 0;
                        if (unreadCountForMe > 0) {
                            state.unreadCounts[chatDoc.id] = unreadCountForMe;
                        }
                    }
                     console.log("✓ מונה הודעות צ'אט נטען בהצלחה.");
                } catch (error) {
                     console.warn("⚠️ שגיאה באחזור מוני הודעות צ'אט (בדוק Rules!):", error.message);
                     state.unreadCounts = {};
                     state.chats = []; // אפס רשימת צ'אטים
                }
            }
            
            // 2.4. אחזור פורומים - הוסף גם את זה ליתר ביטחון
            try {
                const forumsSnapshot = await db.collection('forums').get();
                 if (!forumsSnapshot.empty) {
                    state.forums = forumsSnapshot.docs.map(doc => ({ 
                        id: doc.id, 
                        ...doc.data(), 
                        lastActivity: doc.data().lastActivity?.toDate() || new Date(0)
                    }));
                    console.log(`✓ נטענו ${state.forums.length} פורומים מ-Firestore.`);
                }
            } catch (error) {
                console.warn("⚠️ שגיאה באחזור פורומים (בדוק Rules!):", error.message);
            }
        }


        /**
         * פונקציות Firebase Authentication (התחברות / הרשמה / יציאה)
         */
        async function login() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            
            if (!email || !password) {
                alert('אנא מלא את כל השדות.');
                return;
            }

            try {
                // נסה להתחבר
                await auth.signInWithEmailAndPassword(email, password);
                // ה-onAuthStateChanged יטפל בשאר הלוגיקה
            } catch (error) {
                console.error("שגיאת התחברות:", error);
                alert('שגיאת התחברות: ' + error.message);
            }
        }

        async function register() {
            const name = document.getElementById('register-name').value.trim();
            const email = document.getElementById('register-email').value.trim();
            const password = document.getElementById('register-password').value;
            
            if (!name || !email || !password) {
                alert('אנא מלא את כל השדות.');
                return;
            }

            try {
                // 1. יצירת המשתמש ב-Firebase Auth
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;
                
                // 2. עדכון שם התצוגה (displayName) ב-Auth
                await user.updateProfile({
                    displayName: name
                });
                
                // 3. יצירת מסמך משתמש ב-Firestore
                await db.collection('users').doc(user.uid).set({
                    displayName: name,
                    email: email,
                    role: 'user', // ברירת מחדל: user
                    isOnline: true,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                alert('ההרשמה הצליחה! אתה מחובר כעת.');
                // ה-onAuthStateChanged יטפל בשאר הלוגיקה (ניתוב ל-home)
                
            } catch (error) {
                console.error("שגיאת הרשמה:", error);
                alert('שגיאת הרשמה: ' + error.message);
            }
        }

        function logout() {
            auth.signOut();
            // הלוגיקה עוברת ל-onAuthStateChanged
        }


        /**
         * פונקציית האתחול הראשי - מאזינה למצב המשתמש
         */
        function initializeApp() {
            // מאזין למצב ההתחברות של המשתמש
            auth.onAuthStateChanged(async (firebaseUser) => {
                if (firebaseUser) {
                    // **המשתמש מחובר**
                    try {
                        // 1. אחזור מסמך המשתמש מ-Firestore
                        const userDoc = await db.collection('users').doc(firebaseUser.uid).get();

                        if (userDoc.exists) {
                            // 2. שמירת נתוני המשתמש ב-state
                            state.user = { 
                                id: firebaseUser.uid, 
                                email: firebaseUser.email,
                                displayName: firebaseUser.displayName || userDoc.data().displayName,
                                ...userDoc.data() 
                            };
                            
                            // עדכון סטטוס אונליין (אופציונלי)
                            await db.collection('users').doc(state.user.id).update({ isOnline: true });
                            
                            // 3. אחזור נתונים ראשוני (כל הפורומים, משתמשים וכו')
                            await fetchInitialData(); 
                            
                            // 4. ניתוב למסך הבית רק אם לא היתה שגיאה קריטית
                            if (state.screen === 'loading' || state.screen === 'login' || state.screen === 'register') {
                                goTo('home');
                            } else {
                                render(); // אם המשתמש כבר במסך כלשהו (כמו פורום), רנדר מחדש
                            }
                        } else {
                            // המשתמש מחובר ב-Auth אבל לא קיים במסמך users (כנראה נמחק)
                            auth.signOut();
                        }
                    } catch (error) {
                        console.error("שגיאה קריטית באחזור פרופיל משתמש או נתונים (Firebase/Config):", error);
                         // אם יש שגיאה בחיבור ל-Firebase, אנו חוזרים ללוגין
                        state.user = null;
                        state.screen = 'login';
                        render();
                        alert("שגיאה בחיבור לשרת או באחזור נתונים. נסה להתחבר שוב.");
                    }
                } else {
                    // **המשתמש לא מחובר או יצא**
                    if (state.user) {
                        // אם המשתמש היה מחובר, נעדכן סטטוס לאופליין
                        try {
                           await db.collection('users').doc(state.user.id).update({ isOnline: false });
                        } catch(e) { /* התעלם משגיאות עדכון סטטוס לאחר יציאה */ }
                    }
                    
                    state.user = null;
                    if (state.screen !== 'register') {
                        goTo('login');
                    } else {
                        render();
                    }
                }
            });
        }

        // הפעלת האפליקציה
        initializeApp(); 
    </script>
</body>
</html>
