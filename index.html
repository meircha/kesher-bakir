<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>קהילת קשר | החיים הטובים לגיל הזהב</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <style>
        /* עיצוב מותאם לגיל השלישי - ניגודיות וגודל */
        :root {
            --primary: #E63946; /* אדום נעים */
            --primary-hover: #C81D2A;
            --secondary: #457B9D; /* כחול מרגיע */
            --accent: #F1FAEE; /* לבן-שמנת לרקע */
            --text-main: #1D3557; /* כחול כהה לקריאות */
        }
        body {
            background-color: #f3f4f6;
            color: var(--text-main);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 18px; /* טקסט בסיס גדול יותר */
        }
        .btn-primary {
            background-color: var(--primary);
            color: white;
            transition: all 0.3s;
        }
        .btn-primary:hover { background-color: var(--primary-hover); transform: scale(1.02); }
        
        .btn-secondary {
            background-color: var(--secondary);
            color: white;
        }
        .btn-secondary:hover { opacity: 0.9; }

        /* התאמות נגישות */
        input, select, textarea {
            font-size: 18px !important;
            padding: 12px !important;
        }
        .card {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border: 1px solid #e5e7eb;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen pb-20">

    <div id="app">
        <div class="flex justify-center items-center h-screen">
            <div class="text-center">
                <i class="fa-solid fa-circle-notch fa-spin text-5xl text-red-500 mb-4"></i>
                <h2 class="text-2xl font-bold">טוען את הקהילה...</h2>
            </div>
        </div>
    </div>

    <script>
        // --- 1. הגדרות Firebase ---
        const firebaseConfig = {
            apiKey: "AIzaSyCrcxC420HW5PXGNd8M4KuclUkiJSwHreM", 
            authDomain: "kesher-bakir.firebaseapp.com",
            projectId: "kesher-bakir",
            storageBucket: "kesher-bakir.firebasestorage.app",
            messagingSenderId: "671996189455",
            appId: "1:671996189455:web:dbe089d69a85a2ab38fc7a",
            measurementId: "G-42EWSKFXW" 
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- 2. ניהול מצב (State) ---
        const store = {
            user: null,
            currentPage: 'loading',
            data: {
                users: [],
                forums: [],
                posts: [],
                activities: [],
                chats: [],
                helpRequests: []
            },
            params: {} 
        };

        // כתובת המייל של האדמין הראשי
        const MASTER_ADMIN_EMAIL = "meircha.ai@gmail.com";

        // --- 3. פונקציות ליבה וניתוב ---

        function navigate(page, params = {}) {
            store.currentPage = page;
            store.params = params;
            render();
            window.scrollTo(0, 0);
        }

        function formatDate(timestamp) {
            if (!timestamp) return '';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return date.toLocaleDateString('he-IL') + ' ' + date.toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit' });
        }

        function getAvatar(name) {
            return `https://api.dicebear.com/7.x/avataaars/svg?seed=${encodeURIComponent(name)}&backgroundColor=c0aede`;
        }

        // --- 4. לוגיקה עסקית (Firebase Actions) ---

        // בדיקה והגדרת אדמין בעת התחברות
        async function checkAdminPrivileges(user) {
            // אם זה המייל הראשי - וודא שהוא אדמין ותמיד פעיל
            if (user.email === MASTER_ADMIN_EMAIL) {
                await db.collection('users').doc(user.uid).set({ 
                    role: 'admin',
                    isActive: true // תיקון אוטומטי לחשבון הנעול
                }, { merge: true });
                return 'admin';
            }
            const doc = await db.collection('users').doc(user.uid).get();
            return doc.exists ? doc.data().role : 'user';
        }

        async function handleLogin(email, password) {
            try {
                const cred = await auth.signInWithEmailAndPassword(email, password);
                await checkAdminPrivileges(cred.user);
                // המשתמש יטען ב-auth listener
            } catch (error) {
                alert("שגיאה בהתחברות: " + error.message);
            }
        }

        async function handleRegister(name, email, password, city, avatarType) {
            try {
                const cred = await auth.createUserWithEmailAndPassword(email, password);
                await db.collection('users').doc(cred.user.uid).set({
                    name: name,
                    email: email,
                    city: city,
                    role: email === MASTER_ADMIN_EMAIL ? 'admin' : 'user',
                    avatarSeed: avatarType || name,
                    joinDate: firebase.firestore.FieldValue.serverTimestamp(),
                    isActive: true
                });
            } catch (error) {
                alert("שגיאה בהרשמה: " + error.message);
            }
        }

        function handleLogout() {
            auth.signOut();
            navigate('login');
        }

        // --- פעילויות ---
        async function createActivity(activityData) {
            try {
                await db.collection('activities').add({
                    ...activityData,
                    creatorId: store.user.uid,
                    creatorName: store.user.name,
                    attendees: [store.user.uid],
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                alert("הפעילות נוצרה בהצלחה!");
                navigate('activities');
            } catch (e) { alert("שגיאה: " + e.message); }
        }

        async function toggleActivityJoin(activityId, currentAttendees) {
            const uid = store.user.uid;
            const isIn = currentAttendees.includes(uid);
            try {
                if (isIn) {
                    await db.collection('activities').doc(activityId).update({
                        attendees: firebase.firestore.FieldValue.arrayRemove(uid)
                    });
                } else {
                    await db.collection('activities').doc(activityId).update({
                        attendees: firebase.firestore.FieldValue.arrayUnion(uid)
                    });
                }
                // לא צריך לקרוא ל-fetchData, ה-Listener יעשה את זה
            } catch (e) { console.error(e); }
        }

        // --- פורומים ---
        async function createForum(title, desc, category) {
            if (store.user.role !== 'admin' && store.user.role !== 'senior') return alert("אין הרשאה");
            await db.collection('forums').add({
                title, description: desc, category,
                creatorId: store.user.uid,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            navigate('forums');
        }

        async function createPost(forumId, title, content) {
            await db.collection('forums').doc(forumId).collection('posts').add({
                title, content,
                creatorId: store.user.uid,
                creatorName: store.user.name,
                creatorAvatar: store.user.avatarSeed,
                likes: [],
                comments: [],
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            navigate('forumView', { forumId, title: store.params.title }); // שמירת שם הפורום
        }

        // --- צ'אט ---
        async function sendMessage(recipientId, content) {
            const chatId = [store.user.uid, recipientId].sort().join("_");
            try {
                await db.collection('chats').doc(chatId).collection('messages').add({
                    senderId: store.user.uid,
                    content: content,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    read: false
                });

                await db.collection('chats').doc(chatId).set({
                    participants: [store.user.uid, recipientId],
                    participantNames: { 
                         [store.user.uid]: store.user.name,
                         [recipientId]: store.data.users.find(u => u.id === recipientId)?.name || 'משתמש'
                    },
                    lastMessage: content,
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp(),
                    [`unread_${recipientId}`]: firebase.firestore.FieldValue.increment(1)
                }, { merge: true });
                
                // אם אנחנו בתוך חדר הצ'אט, הטעינה היא אוטומטית דרך ה-Listener
            } catch (e) { console.error(e); alert("שגיאה בשליחה"); }
        }

        // --- עזרה לקהילה ---
        async function submitHelpRequest(category, desc) {
            await db.collection('helpRequests').add({
                category, description: desc,
                requesterId: store.user.uid,
                requesterName: store.user.name,
                requesterCity: store.user.city,
                status: 'open',
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            alert("הבקשה נשלחה בהצלחה לקהילה");
            navigate('help');
        }

        // --- מחיקה גנרית ---
        async function deleteItem(collection, id, subCollection = null, parentId = null) {
            if (!confirm("האם אתה בטוח שברצונך למחוק?")) return;
            try {
                if (subCollection) {
                    await db.collection(collection).doc(parentId).collection(subCollection).doc(id).delete();
                } else {
                    await db.collection(collection).doc(id).delete();
                }
                alert("נמחק בהצלחה");
            } catch (e) { alert("שגיאה במחיקה: " + e.message); }
        }


        // --- 5. טעינת נתונים (Listeners) ---
        
        function fetchData() {
            if (!store.user) return;

            db.collection('users').onSnapshot(snap => {
                store.data.users = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                if(store.currentPage === 'users' || store.currentPage === 'admin') render();
            });

            db.collection('forums').onSnapshot(snap => {
                store.data.forums = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                if(store.currentPage === 'forums') render();
            });

            db.collection('activities').orderBy('date', 'asc').onSnapshot(snap => {
                store.data.activities = snap.docs.map(d => ({ 
                    id: d.id, 
                    ...d.data(),
                    dateObj: d.data().date ? new Date(d.data().date) : new Date()
                }));
                if(store.currentPage === 'activities' || store.currentPage === 'home') render();
            });

             db.collection('helpRequests').orderBy('createdAt', 'desc').onSnapshot(snap => {
                store.data.helpRequests = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                if(store.currentPage === 'help') render();
            });
            
            db.collection('chats').where('participants', 'array-contains', store.user.uid)
                .onSnapshot(snap => {
                    store.data.chats = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    render(); // עדכון מונה הודעות בכל מסך
                });
        }

        let messageUnsubscribe = null;
        function loadChatMessages(otherUserId) {
            if (messageUnsubscribe) messageUnsubscribe();
            
            store.currentChatTargetId = otherUserId; // שמירת הנמען הנוכחי
            const chatId = [store.user.uid, otherUserId].sort().join("_");
            
            db.collection('chats').doc(chatId).update({ [`unread_${store.user.uid}`]: 0 }).catch(e => {});

            messageUnsubscribe = db.collection('chats').doc(chatId).collection('messages')
                .orderBy('timestamp', 'asc')
                .onSnapshot(snap => {
                    store.data.currentChatMessages = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    if (store.currentPage === 'chatRoom') {
                        render();
                        setTimeout(() => {
                            const el = document.getElementById('chat-messages-container');
                            if(el) el.scrollTop = el.scrollHeight;
                        }, 100);
                    }
                });
        }


        // --- 6. אתחול ראשי ---
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                const userDoc = await db.collection('users').doc(user.uid).get();
                if (userDoc.exists) {
                    store.user = { uid: user.uid, ...userDoc.data() };

                    // ** תיקון קריטי: שחרור חסימה למייל הראשי **
                    if (store.user.email === MASTER_ADMIN_EMAIL) {
                        store.user.isActive = true;
                        store.user.role = 'admin';
                        // עדכון ה-DB ברקע כדי לתקן לפעמים הבאות
                        db.collection('users').doc(user.uid).update({ isActive: true, role: 'admin' });
                    }

                    if (store.user.isActive === false) { // בדיקה מפורשת
                        alert("חשבונך מושהה. אנא פנה למנהל.");
                        auth.signOut();
                        return;
                    }
                    fetchData();
                    // אם אנחנו עדיין במסך טעינה או לוגין, נעבור לבית
                    if (store.currentPage === 'loading' || store.currentPage === 'login') {
                        navigate('home');
                    } else {
                        render();
                    }
                } else {
                    // משתמש קיים באותנטיקציה אבל לא ב-DB (נדיר)
                    await handleRegister("משתמש משוחזר", user.email, "temp1234", "ישראל", "Felix");
                }
            } else {
                store.user = null;
                if (store.currentPage !== 'register') navigate('login');
            }
        });


        // --- 7. רכיבי תצוגה (Components) ---

        function render() {
            const app = document.getElementById('app');
            
            if (store.currentPage === 'loading') return;

            if (store.currentPage === 'login') {
                app.innerHTML = renderLogin();
                return;
            }
            if (store.currentPage === 'register') {
                app.innerHTML = renderRegister();
                return;
            }

            app.innerHTML = `
                ${renderHeader()}
                <main class="max-w-4xl mx-auto p-4 pb-24">
                    ${renderContent()}
                </main>
                ${renderBottomNav()}
            `;
        }

        function renderLogin() {
            return `
            <div class="min-h-screen flex items-center justify-center bg-red-50 p-4">
                <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md border-t-8 border-red-500">
                    <h1 class="text-4xl font-bold text-center text-red-600 mb-2">קהילת קשר</h1>
                    <p class="text-center text-gray-500 mb-8 text-lg">הבית החם של גיל הזהב</p>
                    
                    <form onsubmit="event.preventDefault(); handleLogin(this.email.value, this.password.value)">
                        <div class="mb-4">
                            <label class="block text-gray-700 font-bold mb-2">דוא"ל</label>
                            <input type="email" name="email" class="w-full border rounded-lg bg-gray-50" required>
                        </div>
                        <div class="mb-6">
                            <label class="block text-gray-700 font-bold mb-2">סיסמה</label>
                            <input type="password" name="password" class="w-full border rounded-lg bg-gray-50" required>
                        </div>
                        <button type="submit" class="w-full btn-primary py-3 rounded-xl text-xl font-bold shadow-lg">כניסה</button>
                    </form>
                    <div class="mt-6 text-center">
                        <button onclick="navigate('register')" class="text-blue-600 hover:underline text-lg">עדיין אין לך חשבון? הירשם כאן</button>
                    </div>
                </div>
            </div>`;
        }

        function renderRegister() {
            return `
            <div class="min-h-screen flex items-center justify-center bg-blue-50 p-4">
                <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md border-t-8 border-blue-500">
                    <h1 class="text-3xl font-bold text-center text-blue-600 mb-6">הרשמה לקהילה</h1>
                    <form onsubmit="event.preventDefault(); handleRegister(this.name.value, this.email.value, this.password.value, this.city.value, this.avatar.value)">
                        <div class="mb-4">
                            <label class="block text-gray-700 font-bold">שם מלא</label>
                            <input type="text" name="name" class="w-full border rounded-lg" required>
                        </div>
                        <div class="mb-4">
                            <label class="block text-gray-700 font-bold">עיר מגורים</label>
                            <input type="text" name="city" class="w-full border rounded-lg" required>
                        </div>
                        <div class="mb-4">
                            <label class="block text-gray-700 font-bold">דוא"ל</label>
                            <input type="email" name="email" class="w-full border rounded-lg" required>
                        </div>
                        <div class="mb-4">
                            <label class="block text-gray-700 font-bold">סיסמה (6 תווים לפחות)</label>
                            <input type="password" name="password" class="w-full border rounded-lg" required minlength="6">
                        </div>
                        <div class="mb-6">
                            <label class="block text-gray-700 font-bold mb-2">בחר דמות (אווטאר)</label>
                            <select name="avatar" class="w-full border rounded-lg text-lg">
                                <option value="Felix">פליקס (חתול)</option>
                                <option value="Buster">באסטר</option>
                                <option value="Bella">בלה</option>
                                <option value="Granny">סבתא חביבה</option>
                                <option value="Grandpa">סבא חביב</option>
                            </select>
                        </div>
                        <button type="submit" class="w-full btn-secondary py-3 rounded-xl text-xl font-bold shadow-lg">הירשם</button>
                    </form>
                    <div class="mt-4 text-center">
                        <button onclick="navigate('login')" class="text-gray-600">חזרה לכניסה</button>
                    </div>
                </div>
            </div>`;
        }

        function renderHeader() {
            const isAdmin = store.user.role === 'admin';
            return `
            <header class="bg-white shadow-md sticky top-0 z-50">
                <div class="max-w-4xl mx-auto px-4 py-3 flex justify-between items-center">
                    <div class="flex items-center gap-3 cursor-pointer" onclick="navigate('home')">
                        <div class="w-10 h-10 rounded-full bg-red-100 flex items-center justify-center text-red-600">
                            <i class="fa-solid fa-heart text-xl"></i>
                        </div>
                        <span class="text-xl font-bold text-gray-800">קהילת קשר</span>
                    </div>
                    <div class="flex items-center gap-3">
                        <img src="${getAvatar(store.user.avatarSeed)}" class="w-10 h-10 rounded-full bg-gray-200 border border-gray-300">
                        <div class="hidden sm:block leading-tight">
                            <p class="font-bold text-sm">${store.user.name}</p>
                            <p class="text-xs text-gray-500">${store.user.city}</p>
                        </div>
                        ${isAdmin ? `<button onclick="navigate('admin')" class="bg-black text-white px-3 py-1 rounded text-sm">ניהול</button>` : ''}
                        <button onclick="handleLogout()" class="text-red-500 text-2xl ml-2"><i class="fa-solid fa-right-from-bracket"></i></button>
                    </div>
                </div>
            </header>`;
        }

        function renderBottomNav() {
            const navItem = (page, icon, label) => {
                const isActivePage = store.currentPage === page || (page === 'chats' && store.currentPage === 'chatRoom') || (page === 'activities' && store.currentPage === 'createActivity');
                const activeClass = isActivePage ? 'text-red-600 scale-110' : 'text-gray-500';
                return `
                <button onclick="navigate('${page}')" class="flex flex-col items-center gap-1 ${activeClass} transition">
                    <i class="fa-solid ${icon} text-2xl"></i>
                    <span class="text-xs font-bold">${label}</span>
                </button>`;
            };

            let unread = 0;
            store.data.chats.forEach(c => { unread += (c[`unread_${store.user.uid}`] || 0); });

            return `
            <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 py-3 px-6 flex justify-between items-center z-40 shadow-[0_-4px_6px_rgba(0,0,0,0.05)]">
                ${navItem('home', 'fa-house', 'בית')}
                ${navItem('activities', 'fa-person-walking', 'פעילויות')}
                ${navItem('forums', 'fa-comments', 'פורומים')}
                <div class="relative">
                    ${navItem('chats', 'fa-envelope', 'הודעות')}
                    ${unread > 0 ? `<span class="absolute -top-2 -right-2 bg-red-600 text-white text-xs font-bold w-5 h-5 rounded-full flex items-center justify-center animate-bounce">${unread}</span>` : ''}
                </div>
                ${navItem('help', 'fa-hand-holding-heart', 'עזרה')}
            </nav>`;
        }

        function renderContent() {
            switch(store.currentPage) {
                case 'home': return renderHome();
                case 'activities': return renderActivities();
                case 'createActivity': return renderCreateActivity();
                case 'forums': return renderForums();
                case 'forumView': return renderForumView();
                case 'chats': return renderChatsList();
                case 'chatRoom': return renderChatRoom();
                case 'help': return renderHelp();
                case 'createHelp': return renderCreateHelp();
                case 'admin': return renderAdminPanel();
                default: return renderHome();
            }
        }

        // --- מסך בית ---
        function renderHome() {
            const hour = new Date().getHours();
            const greeting = hour < 12 ? "בוקר טוב" : hour < 18 ? "צהריים טובים" : "ערב טוב";
            
            return `
            <div class="space-y-6 animate-fade-in">
                <div class="bg-gradient-to-l from-red-500 to-pink-600 text-white p-6 rounded-2xl shadow-lg flex justify-between items-center">
                    <div>
                        <h2 class="text-3xl font-bold mb-1">${greeting}, ${store.user.name}</h2>
                        <p class="opacity-90">מה תרצה לעשות היום?</p>
                    </div>
                    <i class="fa-solid fa-sun text-5xl opacity-50"></i>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <button onclick="navigate('activities')" class="bg-white p-6 rounded-xl shadow-md hover:shadow-lg transition flex flex-col items-center gap-3 border-b-4 border-green-500">
                        <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center text-green-600 text-2xl"><i class="fa-solid fa-leaf"></i></div>
                        <span class="font-bold text-lg text-gray-700">צא לטייל</span>
                    </button>
                    <button onclick="navigate('chats')" class="bg-white p-6 rounded-xl shadow-md hover:shadow-lg transition flex flex-col items-center gap-3 border-b-4 border-blue-500">
                        <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center text-blue-600 text-2xl"><i class="fa-solid fa-users"></i></div>
                        <span class="font-bold text-lg text-gray-700">דבר עם חבר</span>
                    </button>
                </div>

                <div class="bg-white rounded-2xl p-6 shadow-md">
                    <h3 class="text-xl font-bold mb-4 text-gray-800 border-r-4 border-red-500 pr-3">פעילויות קרובות</h3>
                    ${store.data.activities.slice(0, 3).map(a => `
                        <div class="flex items-center justify-between py-3 border-b last:border-0">
                            <div>
                                <p class="font-bold text-gray-800">${a.title}</p>
                                <p class="text-sm text-gray-500"><i class="fa-solid fa-clock ml-1"></i>${formatDate(a.date)}</p>
                            </div>
                            <button onclick="navigate('activities')" class="text-red-500 font-bold text-sm">לפרטים</button>
                        </div>
                    `).join('') || '<p class="text-gray-500">אין פעילויות קרובות כרגע</p>'}
                </div>
            </div>`;
        }

        // --- מסך פעילויות ---
        function renderActivities() {
            const isAdmin = store.user.role === 'admin' || store.user.role === 'senior';
            return `
            <div class="space-y-4">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-gray-800">פעילויות הקהילה</h2>
                    <button onclick="navigate('createActivity')" class="bg-red-600 text-white px-4 py-2 rounded-full font-bold shadow-md hover:bg-red-700">
                        <i class="fa-solid fa-plus ml-1"></i> צור פעילות
                    </button>
                </div>

                <div class="grid gap-4">
                    ${store.data.activities.map(act => {
                        const isCreator = act.creatorId === store.user.uid;
                        const isJoined = act.attendees && act.attendees.includes(store.user.uid);
                        const attendeeCount = act.attendees ? act.attendees.length : 0;
                        
                        return `
                        <div class="bg-white p-5 rounded-xl shadow-md border border-gray-100 relative overflow-hidden">
                            <div class="absolute top-0 left-0 bg-${isJoined ? 'green' : 'gray'}-500 text-white text-xs px-2 py-1 rounded-br-lg">
                                ${isJoined ? 'רשום לפעילות' : 'לא רשום'}
                            </div>
                            <div class="flex justify-between items-start mt-2">
                                <div>
                                    <span class="text-sm text-red-500 font-bold tracking-wider uppercase">${act.category}</span>
                                    <h3 class="text-xl font-bold text-gray-900 mb-1">${act.title}</h3>
                                    <p class="text-gray-600 text-sm mb-2"><i class="fa-solid fa-location-dot ml-1"></i> ${act.location} | <i class="fa-solid fa-calendar ml-1"></i> ${new Date(act.date).toLocaleDateString('he-IL')}</p>
                                </div>
                                <div class="text-center bg-gray-100 p-2 rounded-lg">
                                    <span class="block text-xl font-bold text-gray-800">${attendeeCount}</span>
                                    <span class="text-xs text-gray-500">משתתפים</span>
                                    ${act.maxParticipants ? `<span class="text-xs block border-t border-gray-300 mt-1 pt-1">מתוך ${act.maxParticipants}</span>` : ''}
                                </div>
                            </div>
                            <p class="text-gray-700 mt-3 mb-4 text-base">${act.description}</p>
                            
                            <div class="flex gap-2 border-t pt-4">
                                <button onclick="toggleActivityJoin('${act.id}', ${JSON.stringify(act.attendees || [])})" 
                                    class="flex-1 py-2 rounded-lg font-bold text-white transition ${isJoined ? 'bg-gray-400 hover:bg-gray-500' : 'bg-green-600 hover:bg-green-700'}">
                                    ${isJoined ? 'ביטול הרשמה' : 'הצטרף לפעילות'}
                                </button>
                                ${isJoined ? `<button onclick="navigate('chatRoom'); loadChatMessages('${act.creatorId}')" class="px-4 py-2 bg-blue-100 text-blue-700 rounded-lg font-bold"><i class="fa-solid fa-comment"></i> למארגן</button>` : ''}
                                ${(isAdmin || isCreator) ? `<button onclick="deleteItem('activities', '${act.id}')" class="px-3 text-red-500 hover:bg-red-50 rounded"><i class="fa-solid fa-trash"></i></button>` : ''}
                            </div>
                        </div>`;
                    }).join('')}
                </div>
            </div>`;
        }

        function renderCreateActivity() {
            return `
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <div class="flex justify-between mb-4">
                    <h2 class="text-2xl font-bold">יצירת פעילות חדשה</h2>
                    <button onclick="navigate('activities')" class="text-gray-500"><i class="fa-solid fa-xmark text-2xl"></i></button>
                </div>
                <form onsubmit="event.preventDefault(); createActivity({
                    title: this.title.value,
                    description: this.description.value,
                    category: this.category.value,
                    date: this.date.value,
                    location: this.location.value,
                    maxParticipants: parseInt(this.max.value) || 0
                })">
                    <div class="grid gap-4">
                        <input type="text" name="title" placeholder="שם הפעילות" class="w-full border rounded-lg" required>
                        <select name="category" class="w-full border rounded-lg">
                            <option value="טיול">טיול</option>
                            <option value="מפגש בפארק">מפגש בפארק</option>
                            <option value="ספורט וכושר">ספורט וכושר</option>
                            <option value="הרצאה">הרצאה / תרבות</option>
                            <option value="ארוחה משותפת">ארוחה משותפת</option>
                            <option value="משחקי חברה">משחקי חברה (ברידג' וכו')</option>
                        </select>
                        <input type="datetime-local" name="date" class="w-full border rounded-lg" required>
                        <input type="text" name="location" placeholder="מיקום מדויק" class="w-full border rounded-lg" required>
                        <input type="number" name="max" placeholder="הגבלת משתתפים (אופציונלי)" class="w-full border rounded-lg">
                        <textarea name="description" rows="4" placeholder="תאר את הפעילות..." class="w-full border rounded-lg" required></textarea>
                        <button type="submit" class="btn-primary w-full py-3 rounded-lg font-bold text-lg">פרסם פעילות</button>
                    </div>
                </form>
            </div>`;
        }

        // --- מסך פורומים ---
        function renderForums() {
            const isAdmin = store.user.role === 'admin' || store.user.role === 'senior';
            const fixedForums = [
                { title: 'טכנולוגיה ומחשבים', icon: 'fa-laptop' },
                { title: 'בריאות וכושר', icon: 'fa-heart-pulse' },
                { title: 'טיולים ונופש', icon: 'fa-plane' },
                { title: 'התנדבות וקהילה', icon: 'fa-hand-holding-heart' }
            ];

            return `
            <div class="space-y-4">
                <div class="bg-blue-600 text-white p-6 rounded-2xl shadow-lg text-center">
                    <h2 class="text-2xl font-bold mb-2">פורומים ודיונים</h2>
                    <p class="opacity-90">שתף, שאל והתייעץ עם חברי הקהילה</p>
                </div>

                ${isAdmin ? `
                <div class="bg-white p-4 rounded-xl shadow-sm">
                    <h3 class="font-bold mb-2">ניהול (למנהלים בלבד)</h3>
                    <form class="flex gap-2" onsubmit="event.preventDefault(); createForum(this.title.value, 'פורום כללי', 'general'); this.reset();">
                        <input name="title" placeholder="שם פורום חדש..." class="border rounded flex-1 p-2">
                        <button class="bg-gray-800 text-white px-4 rounded">הוסף</button>
                    </form>
                </div>` : ''}

                <div class="grid grid-cols-1 gap-4">
                    ${store.data.forums.map(f => `
                         <div onclick="navigate('forumView', {forumId: '${f.id}', title: '${f.title}'})" class="bg-white p-5 rounded-xl shadow-md hover:shadow-lg transition cursor-pointer flex items-center gap-4">
                            <div class="w-12 h-12 rounded-full bg-orange-100 text-orange-500 flex items-center justify-center text-2xl">
                                <i class="fa-solid fa-comments"></i>
                            </div>
                            <div class="flex-1">
                                <h3 class="text-xl font-bold text-gray-800">${f.title}</h3>
                                <p class="text-gray-500 text-sm">${f.description || 'לחץ לכניסה לדיונים'}</p>
                            </div>
                            <i class="fa-solid fa-chevron-left text-gray-300"></i>
                        </div>
                    `).join('')}
                    
                    ${store.data.forums.length === 0 ? fixedForums.map(f => `
                         <div onclick="alert('יש ליצור פורום זה במערכת הניהול תחילה (בתור אדמין)')" class="bg-gray-100 p-5 rounded-xl shadow-inner flex items-center gap-4 opacity-70">
                            <div class="w-12 h-12 rounded-full bg-gray-200 text-gray-500 flex items-center justify-center text-2xl">
                                <i class="fa-solid ${f.icon}"></i>
                            </div>
                            <div>
                                <h3 class="text-xl font-bold text-gray-800">${f.title}</h3>
                                <p class="text-sm text-gray-500">דוגמה לפורום (צור כ-Admin)</p>
                            </div>
                        </div>
                    `).join('') : ''}
                </div>
            </div>`;
        }

        function renderForumView() {
            const forumId = store.params.forumId;
            const forumTitle = store.params.title || 'דיונים';
            
            if (!store.currentForumListener || store.currentForumId !== forumId) {
                if (store.currentForumListener) store.currentForumListener();
                store.currentForumId = forumId;
                store.data.currentPosts = []; 
                store.currentForumListener = db.collection('forums').doc(forumId).collection('posts')
                    .orderBy('createdAt', 'desc')
                    .onSnapshot(snap => {
                        store.data.currentPosts = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                        render(); 
                    });
            }

            const posts = store.data.currentPosts || [];
            const canDelete = store.user.role === 'admin' || store.user.role === 'senior';

            return `
            <div class="space-y-4">
                <div class="flex items-center gap-2 mb-4">
                    <button onclick="navigate('forums')" class="p-2 bg-gray-200 rounded-full"><i class="fa-solid fa-arrow-right"></i></button>
                    <h2 class="text-2xl font-bold text-gray-800">${forumTitle}</h2>
                </div>

                <div class="bg-white p-4 rounded-xl shadow-md mb-6 border-t-4 border-red-500">
                    <h3 class="font-bold text-lg mb-2">כתוב פוסט חדש</h3>
                    <form onsubmit="event.preventDefault(); createPost('${forumId}', this.title.value, this.content.value); this.reset();">
                        <input name="title" placeholder="נושא ההודעה" class="w-full border p-2 rounded mb-2 font-bold" required>
                        <textarea name="content" placeholder="תוכן ההודעה..." class="w-full border p-2 rounded mb-2" rows="3" required></textarea>
                        <button class="bg-red-600 text-white px-6 py-2 rounded-lg font-bold">פרסם</button>
                    </form>
                </div>

                <div class="space-y-4">
                    ${posts.map(p => `
                        <div class="bg-white p-5 rounded-xl shadow-sm">
                            <div class="flex justify-between items-start">
                                <div class="flex gap-3">
                                    <img src="${getAvatar(p.creatorAvatar || p.creatorName)}" class="w-10 h-10 rounded-full bg-gray-100">
                                    <div>
                                        <h4 class="font-bold text-gray-900">${p.title}</h4>
                                        <p class="text-xs text-gray-500">${p.creatorName} | ${formatDate(p.createdAt)}</p>
                                    </div>
                                </div>
                                ${(canDelete || p.creatorId === store.user.uid) ? 
                                    `<button onclick="deleteItem('forums', '${p.id}', 'posts', '${forumId}')" class="text-red-300 hover:text-red-600"><i class="fa-solid fa-trash"></i></button>` : ''}
                            </div>
                            <p class="text-gray-700 mt-3 whitespace-pre-wrap">${p.content}</p>
                            
                            <div class="mt-4 pt-3 border-t border-gray-100">
                                <button onclick="alert('מערכת התגובות תהיה זמינה בקרוב!')" class="text-blue-600 text-sm font-bold">
                                    <i class="fa-regular fa-comment"></i> הגב לפוסט
                                </button>
                            </div>
                        </div>
                    `).join('')}
                    ${posts.length === 0 ? '<p class="text-center text-gray-500">עדיין אין הודעות בפורום זה. היה הראשון!</p>' : ''}
                </div>
            </div>`;
        }

        // --- מסכי צ'אט ---
        function renderChatsList() {
            const allUsers = store.data.users.filter(u => u.id !== store.user.uid);
            
            return `
            <div class="space-y-4 h-[80vh] flex flex-col">
                <h2 class="text-2xl font-bold text-gray-800 px-2">הודעות פרטיות</h2>
                
                <div class="bg-white p-3 rounded-xl shadow-sm">
                    <label class="text-sm font-bold text-gray-500 mb-1 block">התחל שיחה חדשה עם:</label>
                    <select onchange="if(this.value) { navigate('chatRoom'); loadChatMessages(this.value); }" class="w-full border rounded-lg p-2">
                        <option value="">בחר חבר מהרשימה...</option>
                        ${allUsers.map(u => `<option value="${u.id}">${u.name} (${u.city})</option>`).join('')}
                    </select>
                </div>

                <div class="flex-1 overflow-y-auto space-y-2 pb-20">
                    ${store.data.chats.length === 0 ? '<p class="text-center text-gray-500 mt-10">אין לך שיחות פעילות.<br>בחר משתמש למעלה כדי להתחיל.</p>' : ''}
                    
                    ${store.data.chats.sort((a,b) => b.lastUpdated - a.lastUpdated).map(chat => {
                        const otherId = chat.participants.find(id => id !== store.user.uid);
                        const otherName = chat.participantNames[otherId] || 'משתמש';
                        const unread = chat[`unread_${store.user.uid}`] || 0;
                        
                        return `
                        <div onclick="navigate('chatRoom'); loadChatMessages('${otherId}')" class="bg-white p-4 rounded-xl shadow-sm border-b border-gray-100 flex items-center gap-4 cursor-pointer hover:bg-gray-50 transition relative">
                            <img src="${getAvatar(otherName)}" class="w-12 h-12 rounded-full bg-gray-200">
                            <div class="flex-1 min-w-0">
                                <div class="flex justify-between items-center">
                                    <h3 class="font-bold text-gray-800 truncate">${otherName}</h3>
                                    <span class="text-xs text-gray-400">${chat.lastUpdated ? new Date(chat.lastUpdated.toDate()).toLocaleTimeString('he-IL', {hour:'2-digit', minute:'2-digit'}) : ''}</span>
                                </div>
                                <p class="text-sm text-gray-500 truncate ${unread > 0 ? 'font-bold text-black' : ''}">${chat.lastMessage || ''}</p>
                            </div>
                            ${unread > 0 ? `<div class="bg-red-600 text-white text-xs font-bold px-2 py-1 rounded-full">${unread}</div>` : ''}
                        </div>
                        `;
                    }).join('')}
                </div>
            </div>`;
        }

        function renderChatRoom() {
            const msgs = store.data.currentChatMessages || [];
            
            return `
            <div class="flex flex-col h-[85vh] bg-white rounded-xl shadow-lg overflow-hidden">
                <div class="bg-red-600 p-4 text-white flex items-center gap-3 shadow-md">
                    <button onclick="navigate('chats')" class="hover:bg-white/20 p-2 rounded-full"><i class="fa-solid fa-arrow-right"></i></button>
                    <h3 class="font-bold text-lg">חדר צ'אט</h3> 
                </div>
                
                <div id="chat-messages-container" class="flex-1 overflow-y-auto p-4 space-y-3 bg-slate-50">
                    ${msgs.map(m => {
                        const isMe = m.senderId === store.user.uid;
                        return `
                        <div class="flex ${isMe ? 'justify-end' : 'justify-start'}">
                            <div class="max-w-[80%] p-3 rounded-xl ${isMe ? 'bg-red-500 text-white rounded-tl-none' : 'bg-white border border-gray-200 text-gray-800 rounded-tr-none shadow-sm'}">
                                <p>${m.content}</p>
                                <p class="text-[10px] mt-1 opacity-70 text-right">${m.timestamp ? new Date(m.timestamp.toDate()).toLocaleTimeString('he-IL', {hour:'2-digit',minute:'2-digit'}) : '...'}</p>
                            </div>
                        </div>`;
                    }).join('')}
                </div>

                <div class="p-3 bg-white border-t">
                    <form onsubmit="event.preventDefault(); const input = this.querySelector('input'); if(input.value && store.currentChatTargetId) { sendMessage(store.currentChatTargetId, input.value); input.value=''; }" class="flex gap-2">
                        <input type="text" id="msgInput" placeholder="כתוב הודעה..." class="flex-1 border rounded-full px-4 py-2 bg-gray-100 focus:bg-white transition" autocomplete="off">
                        <button type="submit" class="bg-red-600 text-white w-10 h-10 rounded-full flex items-center justify-center shadow-md hover:bg-red-700"><i class="fa-solid fa-paper-plane"></i></button>
                    </form>
                </div>
            </div>`;
        }

        // --- עזרה לקהילה ---
        function renderHelp() {
            return `
            <div class="space-y-4">
                <div class="bg-purple-600 text-white p-6 rounded-2xl shadow-lg flex justify-between items-center">
                    <div>
                        <h2 class="text-2xl font-bold">עזרה לקהילה</h2>
                        <p>זקוק לסיוע? חברי הקהילה כאן בשבילך.</p>
                    </div>
                    <button onclick="navigate('createHelp')" class="bg-white text-purple-600 px-4 py-2 rounded-lg font-bold hover:bg-gray-100">בקש עזרה</button>
                </div>

                <div class="grid gap-4">
                    ${store.data.helpRequests.map(req => `
                        <div class="bg-white p-5 rounded-xl shadow-md border-r-4 border-purple-500">
                            <div class="flex justify-between">
                                <span class="text-purple-600 font-bold text-sm bg-purple-50 px-2 py-1 rounded">${req.category}</span>
                                <span class="text-gray-400 text-xs">${formatDate(req.createdAt)}</span>
                            </div>
                            <p class="text-gray-800 mt-2 font-medium">${req.description}</p>
                            <div class="mt-3 flex items-center justify-between text-sm text-gray-500">
                                <span><i class="fa-solid fa-user ml-1"></i> ${req.requesterName} (${req.requesterCity})</span>
                                <button onclick="navigate('chatRoom'); loadChatMessages('${req.requesterId}')" class="text-purple-600 font-bold hover:underline">הצע עזרה בהודעה</button>
                            </div>
                        </div>
                    `).join('')}
                    ${store.data.helpRequests.length === 0 ? '<p class="text-center text-gray-500">אין בקשות עזרה פתוחות כרגע.</p>' : ''}
                </div>
            </div>`;
        }

        function renderCreateHelp() {
            return `
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <h2 class="text-2xl font-bold mb-4 text-purple-600">בקשת עזרה חדשה</h2>
                
                <div class="bg-yellow-50 border border-yellow-200 p-4 rounded-lg mb-6 text-sm text-yellow-800">
                    <strong>כתב ויתור משפטי:</strong><br>
                    השימוש במדור זה הוא באחריות המשתמש בלבד. הקהילה ומפעיליה אינם אחראים לטיב העזרה, לייעוץ הניתן (רפואי, משפטי או אחר) או לכל נזק שיגרם. בכל עניין רפואי או משפטי יש לפנות לאיש מקצוע מוסמך.
                </div>

                <form onsubmit="event.preventDefault(); submitHelpRequest(this.category.value, this.desc.value)">
                    <label class="block mb-2 font-bold">באיזה תחום העזרה?</label>
                    <select name="category" class="w-full border rounded-lg p-3 mb-4">
                        <option value="ייעוץ רפואי (כללי בלבד)">ייעוץ רפואי (כללי בלבד)</option>
                        <option value="ייעוץ משפטי">ייעוץ משפטי</option>
                        <option value="עזרה טכנית">עזרה טכנית / מחשבים</option>
                        <option value="הסעה / שינוע">הסעה / שינוע</option>
                        <option value="ארוחה חמה">ארוחה חמה</option>
                        <option value="אחר">אחר</option>
                    </select>

                    <label class="block mb-2 font-bold">פרט את הבקשה בקצרה:</label>
                    <textarea name="desc" rows="4" class="w-full border rounded-lg p-3 mb-4" required></textarea>

                    <div class="flex gap-2 items-center mb-6">
                        <input type="checkbox" required id="disclaimer" class="w-5 h-5">
                        <label for="disclaimer" class="text-sm">קראתי והבנתי שהעזרה היא על אחריותי בלבד.</label>
                    </div>

                    <div class="flex gap-4">
                        <button type="button" onclick="navigate('help')" class="flex-1 bg-gray-200 text-gray-800 py-3 rounded-lg font-bold">ביטול</button>
                        <button type="submit" class="flex-1 bg-purple-600 text-white py-3 rounded-lg font-bold">שלח בקשה</button>
                    </div>
                </form>
            </div>`;
        }

        // --- ממשק אדמין ---
        function renderAdminPanel() {
            if (store.user.role !== 'admin') {
                setTimeout(() => navigate('home'), 0);
                return '';
            }

            window.promoteUser = (uid, currentRole) => {
                const newRole = currentRole === 'admin' ? 'user' : 'admin'; 
                const role = confirm("להפוך לאדמין? (ביטול יהפוך למשתמש רגיל)") ? 'admin' : 'user';
                db.collection('users').doc(uid).update({ role }).then(() => alert("עודכן"));
            };
            
            window.deleteUser = (uid) => {
                if(confirm("למחוק משתמש זה לצמיתות?")) db.collection('users').doc(uid).delete();
            };

            return `
            <div class="space-y-6 pb-20">
                <h2 class="text-3xl font-bold text-gray-900">פנל ניהול מערכת</h2>
                
                <div class="bg-white rounded-xl shadow overflow-hidden">
                    <div class="bg-gray-800 text-white p-4 font-bold">משתמשים רשומים</div>
                    <div class="divide-y">
                        ${store.data.users.map(u => `
                            <div class="p-4 flex justify-between items-center">
                                <div>
                                    <p class="font-bold">${u.name} ${u.role === 'admin' ? '<span class="text-red-500">(מנהל)</span>' : ''}</p>
                                    <p class="text-sm text-gray-500">${u.email}</p>
                                </div>
                                <div class="flex gap-2 text-sm">
                                    <button onclick="promoteUser('${u.id}', '${u.role}')" class="bg-blue-100 text-blue-700 px-2 py-1 rounded">שנה דרגה</button>
                                    ${u.id !== store.user.uid ? `<button onclick="deleteUser('${u.id}')" class="bg-red-100 text-red-700 px-2 py-1 rounded">מחק</button>` : ''}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-white p-4 rounded-xl shadow text-center">
                        <p class="text-3xl font-bold text-red-500">${store.data.activities.length}</p>
                        <p class="text-gray-500">פעילויות</p>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow text-center">
                        <p class="text-3xl font-bold text-blue-500">${store.data.forums.length}</p>
                        <p class="text-gray-500">פורומים</p>
                    </div>
                </div>
            </div>`;
        }

    </script>
</body>
</html>
