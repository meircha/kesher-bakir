<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>×§×”×™×œ×ª ×§×©×¨ | ×”×—×™×™× ×”×˜×•×‘×™× ×œ×’×™×œ ×”×–×”×‘</title>
    
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#E63946">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <style>
        /* ========================================= */
        /* ×”×’×“×¨×•×ª ×¢×™×¦×•×‘ (CSS)               */
        /* ========================================= */

        :root {
            --primary: #E63946;       
            --primary-hover: #C81D2A; 
            --secondary: #457B9D;     
            --text-main: #1D3557;     
            --bg-color: #f8fafc;      
            --bubble-bg: #FFFFFF;     
            --header-height: 90px;    /* ×’×•×‘×” ×›×•×ª×¨×ª */
            --nav-height: 75px;       /* ×’×•×‘×” ×ª×¤×¨×™×˜ ×ª×—×ª×•×Ÿ */
        }
        
        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 16px;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
            overflow: hidden; /* ×”××¤×œ×™×§×¦×™×” ××§×•×‘×¢×ª, ×¨×§ ×”×ª×•×›×Ÿ × ×’×œ×œ */
            height: 100vh;
            width: 100vw;
            position: fixed; /* ××•× ×¢ ×’×œ×™×œ×” ×©×œ ×›×œ ×”×¢××•×“ ×‘××™×™×¤×•×Ÿ */
        }

        /* ××™×›×œ ×¨××©×™ */
        .main-app-container {
            max-width: 1024px;
            margin: 0 auto;
            height: 100%;
            background-color: #ffffff;
            position: relative;
            display: flex;
            flex-direction: column;
        }
        
        /* ××–×•×¨ ×”×ª×•×›×Ÿ ×”××¨×›×–×™ */
        .content-area {
            position: absolute;
            top: var(--header-height);
            bottom: var(--nav-height);
            left: 0;
            right: 0;
            overflow-y: auto;       
            -webkit-overflow-scrolling: touch; 
            padding: 10px;
            background-color: #f0f2f5;
        }

        /* ×‘×™×˜×•×œ ×’×œ×™×œ×” ×‘××¡×š ×”×¦'××˜ ×›×“×™ ×©×”××™×›×œ ×”×¤× ×™××™ ×™×™×’×œ×œ */
        .content-area.chat-mode {
            overflow: hidden;
            padding: 0;
            background-color: #fff;
        }

        /* --- ×¨×›×™×‘×™ ×××©×§ --- */
        .btn-primary {
            background-color: var(--primary);
            color: white;
            transition: all 0.3s ease;
            font-weight: 700;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            border-radius: 0.75rem;
            padding: 0.75rem 1.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        input, select, textarea {
            font-size: 16px !important;
            padding: 10px !important;
            border-radius: 0.5rem !important;
            border: 1px solid #cbd5e1 !important;
            width: 100%;
            background-color: #fff;
            display: block;
        }
        
        /* --- ×× ×™××¦×™×•×ª --- */
        .hidden { display: none !important; }
        .fade-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .heart-beat { animation: beat 1.5s infinite ease-in-out; }
        @keyframes beat { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.15); } }

        /* ×ª××•× ×•×ª */
        .profile-img { object-fit: cover; width: 100%; height: 100%; }
        .card-img { object-fit: cover; width: 100%; height: 100%; }
        .gradient-overlay { background: linear-gradient(to top, rgba(0,0,0,0.8) 0%, transparent 100%); }
        
        /* --- ×œ×•×’×• --- */
        .logo-container { 
            position: relative; 
            width: 40px; 
            height: 40px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
        }
        .logo-heart { font-size: 36px; color: #E63946; }
        .logo-hands { position: absolute; font-size: 18px; color: white; top: 50%; left: 50%; transform: translate(-50%, -50%); }

        /* --- ×‘×•×¢×•×ª Header ××•×ª×××•×ª ×œ××•×‘×™×™×œ --- */
        .header-bubble {
            background-color: var(--bubble-bg);
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 2px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 55px; /* ×’×•×‘×” ××•×§×˜×Ÿ */
            width: 55px;  /* ×¨×•×—×‘ ××•×§×˜×Ÿ */
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            cursor: pointer;
            position: relative;
            margin: 0 2px;
        }
        
        .header-icon { font-size: 1.1rem; margin-bottom: 1px; color: #4B5563; }
        .header-text { font-size: 0.55rem; font-weight: bold; text-align: center; line-height: 1; color: #1D3557; }
        .badge-text { font-size: 0.5rem; background: #f3f4f6; padding: 1px 2px; border-radius: 4px; max-width: 50px; overflow: hidden; white-space: nowrap; margin-top: 1px; }

        /* --- ×¦'××˜ --- */
        .chat-split-container {
            display: flex;
            width: 100%;
            height: 100%;
            background: white;
            overflow: hidden;
            position: relative;
        }

        /* ×¦×“ ×™××™×Ÿ: ×¨×©×™××” */
        .chat-sidebar {
            width: 35%;
            min-width: 250px;
            border-left: 1px solid #e5e7eb;
            background-color: #f9fafb;
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
        }
        
        /* ×¦×“ ×©×××œ: ×”×¦'××˜ ×¢×¦××• */
        .chat-main-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: #ffffff;
            height: 100%;
            position: relative;
        }

        /* ×”×ª×××” ×œ××•×‘×™×™×œ: ×¦'××˜ */
        @media (max-width: 768px) {
            .chat-sidebar {
                width: 100%;
                min-width: 100%;
                border-left: none;
            }
            
            /* ××¡×š ×”×¦'××˜ ×‘××•×‘×™×™×œ ×™×•×©×‘ ××¢×œ ×”×¨×©×™××” */
            .chat-main-area {
                position: fixed;
                top: var(--header-height);
                bottom: var(--nav-height);
                left: 0;
                right: 0;
                z-index: 50;
                transform: translateX(100%); /* ××•×¡×ª×¨ ×‘×¨×™×¨×ª ××—×“×œ */
                transition: transform 0.25s ease-in-out;
            }

            .chat-mobile-active .chat-main-area {
                transform: translateX(0); /* ×”×—×œ×§×” ×¤× ×™××” */
            }
            
            /* ×”×ª×××ª ×”×”×“×¨ ×œ××•×‘×™×™×œ */
            .header-text-main { display: none; } /* ×”×¡×ª×¨×ª ×©× ×”××¤×œ×™×§×¦×™×” ×‘××•×‘×™×™×œ */
            
            /* ×©×‘×™×¨×ª ×©×•×¨×•×ª ×‘×¡×™× ×•×Ÿ */
            .filter-row { flex-wrap: wrap; }
            .filter-item { min-width: 45% !important; }
        }

        .chat-user-item {
            padding: 12px;
            border-bottom: 1px solid #f0f2f5;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
        }
        
        #chatMessagesArea {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            background-color: #efeae2; /* ×¨×§×¢ ×“××•×™ ×•×•××˜×¡××¤ */
        }

        /* ×©×•×¨×ª ×”×§×œ×˜ ×‘×¦'××˜ */
        .chat-input-bar {
            padding: 8px;
            background: #f0f2f5;
            display: flex;
            align-items: center;
            gap: 8px;
            border-top: 1px solid #e5e7eb;
        }

        /* ×ª×¤×¨×™×˜ ×ª×—×ª×•×Ÿ ×§×‘×•×¢ */
        #bottom-nav-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: var(--nav-height);
            z-index: 9999;
            background-color: white;
            border-top: 1px solid #e5e7eb;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
            max-width: 1024px;
            margin: 0 auto;
            padding-bottom: env(safe-area-inset-bottom);
            display: flex;
            justify-content: space-around;
            align-items: center;
        }
        
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #9ca3af;
            width: 20%;
        }
        
        .nav-item.active { color: var(--primary); }
        .nav-item i { font-size: 1.4rem; margin-bottom: 2px; }
        .nav-item span { font-size: 0.7rem; font-weight: bold; }
        
        /* ×›×•×ª×¨×ª ×¢×œ×™×•× ×” ×§×‘×•×¢×” */
        #main-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: var(--header-height);
            z-index: 9999;
            background-color: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            max-width: 1024px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            padding: 0 8px;
            justify-content: space-between;
        }

    </style>
</head>
<body>

    <div id="app" class="main-app-container">
        <div class="flex justify-center items-center h-full flex-col gap-6 bg-white z-50 relative">
            <div class="logo-container transform scale-150 mb-4">
                <i class="fa-solid fa-heart logo-heart heart-beat"></i>
                <i class="fa-solid fa-handshake logo-hands"></i>
            </div>
            <h2 class="text-3xl font-bold text-gray-800">×§×”×™×œ×ª ×§×©×¨</h2>
            <div class="w-12 h-12 border-4 border-red-500 border-t-transparent rounded-full animate-spin mt-4"></div>
            <p class="text-gray-500 text-sm animate-pulse">×˜×•×¢×Ÿ × ×ª×•× ×™×...</p>
        </div>
    </div>

    <div id="suggestionModal" class="hidden fixed inset-0 bg-black/60 z-[10000] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-3xl p-6 w-full max-w-md shadow-2xl animate-fade-in border-t-8 border-purple-500">
            <h2 class="text-2xl font-bold mb-4 text-purple-700 text-center">×”×¦×¢×•×ª ×œ×©×™×¤×•×¨</h2>
            <form onsubmit="event.preventDefault(); sendSuggestion()">
                <label class="font-bold text-sm block mb-1">×“×—×™×¤×•×ª:</label>
                <select id="sugUrgency" class="mb-2"><option>×¨×’×™×œ</option><option>×—×©×•×‘</option><option>×§×¨×™×˜×™</option></select>
                <label class="font-bold text-sm block mb-1">× ×•×©×:</label>
                <input id="sugCategory" required class="mb-2">
                <label class="font-bold text-sm block mb-1">×¤×™×¨×•×˜:</label>
                <textarea id="sugContent" rows="4" required class="mb-4"></textarea>
                <div class="flex gap-3">
                    <button type="button" onclick="document.getElementById('suggestionModal').classList.add('hidden')" class="flex-1 bg-gray-100 py-3 rounded-xl font-bold">×‘×™×˜×•×œ</button>
                    <button type="submit" class="flex-1 btn-primary py-3 rounded-xl font-bold">×©×œ×—</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="profileModal" class="hidden fixed inset-0 bg-black/70 z-[10000] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl p-6 w-full max-w-md shadow-2xl border-t-8 border-red-500 animate-fade-in max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">×”×¤×¨×•×¤×™×œ ×©×œ×™</h2>
                <button onclick="closeProfileModal()" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            <form onsubmit="event.preventDefault(); saveProfileChanges()">
                <div class="flex flex-col items-center mb-6">
                    <div class="relative w-24 h-24 mb-3">
                        <img src="" id="previewImg" class="profile-img rounded-full border-4 border-red-100 shadow-lg">
                        <label for="fileInput" class="absolute bottom-0 right-0 bg-red-500 text-white w-8 h-8 rounded-full flex items-center justify-center cursor-pointer shadow-md"><i class="fa-solid fa-camera text-sm"></i></label>
                        <input type="file" id="fileInput" accept="image/*" class="hidden" onchange="handleImageUpload(this)">
                    </div>
                </div>
                <div class="mb-4">
                    <label class="block mb-2 font-bold text-sm">×‘×—×¨ ×“××•×ª:</label>
                    <div class="grid grid-cols-3 gap-2" id="avatarGrid"></div>
                    <input type="hidden" id="selectedAvatarUrl">
                </div>
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <input type="text" id="editCity" placeholder="×¢×™×¨" required>
                    <select id="editGender" required><option value="male">×’×‘×¨</option><option value="female">××™×©×”</option></select>
                </div>
                <button type="submit" class="w-full btn-primary py-3 rounded-xl font-bold shadow-lg">×©××•×¨ ×©×™× ×•×™×™×</button>
            </form>
        </div>
    </div>

    <script>
        // --- ×”×’×“×¨×•×ª Firebase ---
        const firebaseConfig = {
            apiKey: "AIzaSyCrcxC420HW5PXGNd8M4KuclUkiJSwHreM", 
            authDomain: "kesher-bakir.firebaseapp.com",
            projectId: "kesher-bakir",
            storageBucket: "kesher-bakir.firebasestorage.app",
            messagingSenderId: "671996189455",
            appId: "1:671996189455:web:dbe089d69a85a2ab38fc7a",
            measurementId: "G-42EWSKFXW" 
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- × ×™×”×•×œ ××¦×‘ ---
        const store = {
            user: null,
            currentPage: 'loading',
            currentChatTargetId: null,
            chatDraft: "",
            
            // ××¡× × ×™×
            filterCategory: "", 
            filterCity: "",     
            filterForumCategory: "",
            chatFilterName: "", 
            chatFilterCity: "", 
            chatFilterGender: "", 
            
            data: { users: [], forums: [], activities: [], chats: [], helpRequests: [], reports: [], suggestions: [], sysCategories: [], systemAvatars: [], currentChatMessages: [] }
        };
        const MASTER_ADMIN_EMAIL = "meircha.ai@gmail.com";

        // --- ×œ×•×’×• ×•× ×ª×•× ×™× ×§×‘×•×¢×™× ---
        const LOGO_SVG = `<div class="logo-container"><i class="fa-solid fa-heart logo-heart"></i><i class="fa-solid fa-handshake logo-hands"></i></div>`;
        const BIG_LOGO_SVG = `<div class="relative w-24 h-24 flex items-center justify-center mx-auto mb-4"><i class="fa-solid fa-heart text-red-600 text-7xl heart-beat"></i><i class="fa-solid fa-handshake text-white absolute text-3xl" style="top: 55%; left: 50%; transform: translate(-50%, -50%);"></i></div>`;

        const DEFAULT_AVATARS = [
            { name: "×¡×‘× ×™×•×¡×£", url: "https://api.dicebear.com/9.x/avataaars/svg?seed=Felix&mouth=smile&eyebrows=default&clothing=collarAndSweater", gender: 'male' },
            { name: "×¡×‘×ª× ×©×¨×”", url: "https://api.dicebear.com/9.x/avataaars/svg?seed=Aneka&mouth=smile&eyebrows=default&clothing=shirtScoopNeck", gender: 'female' },
            { name: "×“×•×“ ××©×”", url: "https://api.dicebear.com/9.x/avataaars/svg?seed=Joshua&mouth=smile&facialHair=beardMedium", gender: 'male' },
            { name: "×“×•×“×” ×¨×‘×§×”", url: "https://api.dicebear.com/9.x/avataaars/svg?seed=Molly&mouth=smile&top=longHair", gender: 'female' },
            { name: "×—×‘×¨ ×™×§×¨", url: "https://api.dicebear.com/9.x/avataaars/svg?seed=Liam&mouth=smile&glasses=round", gender: 'male' },
            { name: "×—×‘×¨×” ×™×§×¨×”", url: "https://api.dicebear.com/9.x/avataaars/svg?seed=Zoe&mouth=smile&glasses=catEye", gender: 'female' }
        ];

        const BADGES = [
            { min: 0, name: '××ª×—×™×œ', icon: 'â­' },
            { min: 100, name: '××™×© ×”×××” ğŸ¥‰', icon: 'ğŸ¥‰' },
            { min: 1000, name: '××“×œ×™×™×ª ×›×¡×£ ğŸ¥ˆ', icon: 'ğŸ¥ˆ' },
            { min: 2500, name: '××œ×•×£ ×”×–×”×‘ ğŸ¥‡', icon: 'ğŸ¥‡' }
        ];

        function getUserBadge(points) {
            const safePoints = points || 0;
            return BADGES.slice().reverse().find(b => safePoints >= b.min) || BADGES[0];
        }

        // --- ×¤×•× ×§×¦×™×•×ª ×œ×™×‘×” ---
        function safeDate(timestamp) {
            if (!timestamp) return new Date();
            if (timestamp instanceof Date) return timestamp;
            if (typeof timestamp.toDate === 'function') return timestamp.toDate();
            return new Date(timestamp);
        }

        function formatDate(timestamp) {
            if (!timestamp) return '';
            const date = safeDate(timestamp);
            return date.toLocaleDateString('he-IL') + ' ' + date.toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit' });
        }

        function getUserImage(user) {
            if (user && user.customImage) return user.customImage;
            const seed = user ? (user.avatarSeed || user.name) : 'User';
            if (seed && (seed.startsWith('http') || seed.startsWith('data:image'))) return seed;
            return `https://api.dicebear.com/9.x/avataaars/svg?seed=${encodeURIComponent(seed)}&backgroundColor=c0aede&mood=happy`;
        }

        function navigate(page, params = {}) {
            store.currentPage = page;
            store.params = params;
            
            if (page !== 'chats') {
                store.currentChatTargetId = null;
                if (window.msgSub) { window.msgSub(); window.msgSub = null; }
            }
            
            render();
        }
        
        function reloadApp() {
            window.location.reload();
        }

        // --- ×“×—×™×¡×ª ×ª××•× ×” ---
        function compressImage(file, maxWidth, quality, callback) {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = event => {
                const img = new Image();
                img.src = event.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    let w = img.width, h = img.height;
                    if (w > h) { if (w > maxWidth) { h *= maxWidth / w; w = maxWidth; } } 
                    else { if (h > maxWidth) { w *= maxWidth / h; h = maxWidth; } }
                    canvas.width = w; canvas.height = h;
                    ctx.drawImage(img, 0, 0, w, h);
                    callback(canvas.toDataURL('image/jpeg', quality));
                }
            }
        }

        // --- × ×ª×•× ×™× ---
        async function ensureSystemData() {
            const cats = await db.collection('sys_categories').get();
            if(cats.empty) {
                ['×–×›×•×™×•×ª', '×‘×¨×™××•×ª', '×˜×›× ×•×œ×•×’×™×”', '×ª×¨×‘×•×ª', '××§×˜×•××œ×™×”', '×¡×¤×•×¨×˜', '×‘×™×©×•×œ', '××©×¤×—×”'].forEach(c => db.collection('sys_categories').add({name: c}));
            }
            const avs = await db.collection('system_avatars').get();
            if(avs.empty) {
                const batch = db.batch();
                DEFAULT_AVATARS.forEach(av => batch.set(db.collection('system_avatars').doc(), av));
                await batch.commit();
            }
        }

        function fetchData() {
            if(!store.user) return;
            ensureSystemData();
            
            db.collection('sys_categories').onSnapshot(s => { store.data.sysCategories = s.docs.map(d=>({id:d.id,...d.data()})); if(store.currentPage==='admin' || store.currentPage.includes('ctivity') || store.currentPage.includes('orum')) render(); });
            db.collection('users').onSnapshot(s => { store.data.users = s.docs.map(d=>({id:d.id,...d.data()})); if(store.currentPage==='chats' || store.currentPage==='admin') render(); });
            db.collection('forums').orderBy('createdAt','desc').onSnapshot(s => { store.data.forums = s.docs.map(d=>({id:d.id,...d.data()})); if(['forums','home'].includes(store.currentPage)) render(); });
            db.collection('activities').orderBy('date','asc').onSnapshot(s => { store.data.activities = s.docs.map(d=>({id:d.id, ...d.data(), dateObj: safeDate(d.data().date)})); if(['activities','home'].includes(store.currentPage)) render(); });
            db.collection('chats').where('participants','array-contains',store.user.uid).onSnapshot(s => { store.data.chats = s.docs.map(d=>({id:d.id,...d.data()})); render(); });
            db.collection('system_avatars').onSnapshot(s => { store.data.systemAvatars = s.docs.map(d=>({id:d.id,...d.data()})); });
            
            if(['admin','senior'].includes(store.user.role)) {
                 db.collection('reports').orderBy('timestamp','desc').onSnapshot(s => { store.data.reports = s.docs.map(d=>({id:d.id,...d.data()})); render(); });
                 db.collection('suggestions').orderBy('date','desc').onSnapshot(s => { store.data.suggestions = s.docs.map(d=>({id:d.id,...d.data()})); render(); });
            }
        }

        auth.onAuthStateChanged(async u => {
            if(u){ 
                if(u.email === MASTER_ADMIN_EMAIL) await db.collection('users').doc(u.uid).set({role:'admin',isActive:true},{merge:true});
                const d = await db.collection('users').doc(u.uid).get(); 
                if(d.exists){ 
                    store.user = {uid:u.uid, ...d.data()}; 
                    fetchData(); 
                    if(['loading','login','register'].includes(store.currentPage)) navigate('home'); else render();
                } else auth.signOut(); 
            } else { 
                store.user = null; 
                if(store.currentPage !== 'register') navigate('login'); 
            }
        });

        // --- Render ---
        function render() {
            const app = document.getElementById('app');
            if (store.currentPage === 'loading') return;
            if (store.currentPage === 'login') { app.innerHTML = renderLogin(); return; } 
            if (store.currentPage === 'register') { app.innerHTML = renderRegister(); return; }
            
            const isChatMode = store.currentPage === 'chats';
            
            app.innerHTML = `
                <div id="main-header">${renderHeader()}</div>
                <div class="content-area ${isChatMode ? 'chat-mode' : ''}">
                    ${renderContent()}
                </div>
                <div id="bottom-nav-bar">${renderBottomNav()}</div>
            `;
            
            // ×’×œ×™×œ×” ××•×˜×•××˜×™×ª ×‘×¦'××˜
            if (isChatMode && store.currentChatTargetId) {
                setTimeout(() => {
                    const el = document.getElementById('chatMessagesArea');
                    if(el) el.scrollTop = el.scrollHeight;
                }, 100);
            }
        }

        function renderLogin() { return `<div class="min-h-screen flex items-center justify-center bg-red-50 p-4"><div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md border-t-8 border-red-500 text-center animate-fade-in"><div class="flex justify-center items-center gap-3 mb-4 transform scale-125">${BIG_LOGO_SVG}</div><h1 class="text-4xl font-bold text-red-600 mb-2">×§×”×™×œ×ª ×§×©×¨</h1><p class="text-gray-500 mb-8">×”×‘×™×ª ×”×—× ×©×œ ×’×™×œ ×”×–×”×‘</p><form onsubmit="event.preventDefault(); handleLogin(this.email.value, this.password.value)"><input type="email" name="email" placeholder="×“×•×''×œ" required><input type="password" name="password" placeholder="×¡×™×¡××”" required><button class="w-full btn-primary py-3 rounded-xl text-xl font-bold shadow-lg mt-4">×›× ×™×¡×”</button></form><button onclick="navigate('register')" class="mt-4 text-blue-600 font-medium hover:underline block w-full">××™×Ÿ ×œ×š ×—×©×‘×•×Ÿ? ×”×™×¨×©× ×›××Ÿ</button></div></div>`; }
        function renderRegister() { return `<div class="min-h-screen flex items-center justify-center bg-blue-50 p-4"><div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md border-t-8 border-blue-500 animate-fade-in"><h1 class="text-3xl font-bold text-center text-blue-600 mb-6">×”×¨×©××” ×œ×§×”×™×œ×”</h1><form onsubmit="event.preventDefault(); handleRegister(this.name.value, this.email.value, this.password.value, this.city.value, this.gender.value)"><input name="name" placeholder="×©× ××œ×" required><input name="city" placeholder="×¢×™×¨ ××’×•×¨×™×" required><select name="gender" required><option value="">××™×Ÿ...</option><option value="male">×’×‘×¨</option><option value="female">××™×©×”</option></select><input name="email" placeholder="×“×•×''×œ" required><input type="password" name="password" placeholder="×¡×™×¡××”" required minlength="6"><button class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold hover:bg-blue-700 transition">×”×™×¨×©×</button></form><button onclick="navigate('login')" class="w-full mt-4 text-gray-600 hover:underline">×—×–×¨×” ×œ×›× ×™×¡×”</button></div></div>`; }

        async function handleLogin(e,p) { try{await auth.signInWithEmailAndPassword(e,p)}catch(err){alert("×©×’×™××”: "+err.message)} }
        async function handleRegister(n,e,p,c,g) { try{const r=await auth.createUserWithEmailAndPassword(e,p); await db.collection('users').doc(r.user.uid).set({name:n,email:e,city:c,gender:g,points:0,role:'user'});}catch(err){alert("×©×’×™××”: "+err.message)} }
        function handleLogout() { auth.signOut(); navigate('login'); }

        function renderHeader() {
            const u = store.user;
            const badge = getUserBadge(u.points);
            const badgeName = badge.name.split(' ')[0]; 
            
            return `
            <div class="flex items-center w-full justify-between">
                <div class="flex items-center gap-1">
                    <div class="header-bubble" onclick="document.getElementById('suggestionModal').classList.remove('hidden')">
                        <i class="fa-regular fa-lightbulb header-icon text-yellow-600"></i>
                        <span class="header-text">×”×¦×¢×•×ª</span>
                    </div>
                    <div class="header-bubble">
                        <span class="text-xl leading-none">${badge.icon}</span>
                        <span class="header-text mt-1">${u.points} × ×§'</span>
                        <div class="badge-text">${badgeName}</div>
                    </div>
                </div>

                <div class="flex flex-col items-center justify-center" onclick="reloadApp()">
                    ${LOGO_SVG}
                    <span class="text-xs font-bold text-gray-700 mt-1 header-text-main">×§×”×™×œ×ª ×§×©×¨</span>
                </div>

                <div class="flex items-center gap-1">
                    <button onclick="reloadApp()" class="text-gray-400 p-2 hover:text-blue-600"><i class="fa-solid fa-rotate-right text-lg"></i></button>
                    <div class="header-bubble" onclick="openProfileModal()">
                        <div class="w-6 h-6 rounded-full overflow-hidden border border-gray-300 mx-auto mb-1"><img src="${getUserImage(u)}" class="profile-img"></div>
                        <span class="header-text">×¤×¨×•×¤×™×œ</span>
                    </div>
                    ${u.role==='admin' ? `<div class="header-bubble" onclick="navigate('admin')"><i class="fa-solid fa-shield-halved header-icon text-gray-800"></i><span class="header-text">× ×™×”×•×œ</span></div>` : ''}
                    <button onclick="handleLogout()" class="text-red-500 px-2 text-lg"><i class="fa-solid fa-right-from-bracket"></i></button>
                </div>
            </div>`;
        }

        function renderContent() {
            switch(store.currentPage){
                case 'home': return renderHome();
                case 'chats': return renderChatsList();
                case 'admin': return renderAdminPanel();
                // ×™×ª×¨ ×”××¡×›×™× (×œ×§×™×¦×•×¨ ×”×§×•×“, ×”× ×“×•××™× ×œ×§×•×“××™×)
                default: return `<div class="p-4 text-center"><h2 class="text-xl font-bold text-gray-400 mt-10">×¢××•×“ ×‘×‘× ×™×™×”...</h2><button onclick="navigate('home')" class="mt-4 text-blue-500">×—×–×•×¨ ×œ×‘×™×ª</button></div>`;
            }
        }

        function renderHome() {
            return `
            <div class="space-y-6 p-2">
                <div class="bg-gradient-to-r from-red-500 to-pink-600 text-white p-6 rounded-2xl shadow-lg">
                    <h2 class="text-2xl font-bold">×©×œ×•×, ${store.user.name.split(' ')[0]}</h2>
                    <p class="opacity-90 text-sm mt-1">××™×–×” ×›×™×£ ×©×—×–×¨×ª ××œ×™× ×•!</p>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <button onclick="navigate('chats')" class="bg-white p-4 rounded-xl shadow flex flex-col items-center justify-center h-32 border-b-4 border-blue-500 active:scale-95 transition">
                        <i class="fa-solid fa-comments text-3xl text-blue-500 mb-2"></i>
                        <span class="font-bold text-gray-700">×”×•×“×¢×•×ª</span>
                    </button>
                    <button onclick="navigate('activities')" class="bg-white p-4 rounded-xl shadow flex flex-col items-center justify-center h-32 border-b-4 border-green-500 active:scale-95 transition">
                        <i class="fa-solid fa-person-walking text-3xl text-green-500 mb-2"></i>
                        <span class="font-bold text-gray-700">×¤×¢×™×œ×•×™×•×ª</span>
                    </button>
                </div>
            </div>`;
        }

        function renderChatsList() {
            let users = store.data.users.filter(u => u.id !== store.user.uid);
            
            // ×¡×™× ×•×Ÿ
            if (store.chatFilterName) users = users.filter(u => u.name.includes(store.chatFilterName));
            if (store.chatFilterCity) users = users.filter(u => u.city.includes(store.chatFilterCity));
            if (store.chatFilterGender && store.chatFilterGender !== 'all') users = users.filter(u => u.gender === store.chatFilterGender);

            const targetUser = store.data.users.find(u => u.id === store.currentChatTargetId);
            const mobileClass = targetUser ? 'chat-mobile-active' : '';

            return `
            <div class="chat-split-container ${mobileClass}">
                <div class="chat-sidebar">
                    <div class="p-3 bg-white border-b z-10 shadow-sm">
                        <input placeholder="×—×¤×© ×—×‘×¨..." oninput="store.chatFilterName=this.value; render()" class="mb-2 bg-gray-50">
                        <div class="flex gap-2 filter-row">
                            <select onchange="store.chatFilterGender=this.value; render()" class="filter-item mb-0 bg-gray-50 text-sm">
                                <option value="all">×”×›×œ (×”×¦×’ ×›×•×œ×)</option>
                                <option value="male">×’×‘×¨×™×</option>
                                <option value="female">× ×©×™×</option>
                            </select>
                            <input placeholder="×¡×™× ×•×Ÿ ×¢×™×¨" oninput="store.chatFilterCity=this.value; render()" class="filter-item mb-0 bg-gray-50 text-sm">
                        </div>
                    </div>
                    <div class="flex-1 overflow-y-auto">
                        ${users.map(u => `
                            <div onclick="loadChat('${u.id}')" class="chat-user-item hover:bg-gray-50">
                                <img src="${getUserImage(u)}" class="w-12 h-12 rounded-full border bg-white">
                                <div>
                                    <div class="font-bold text-gray-800">${u.name}</div>
                                    <div class="text-xs text-gray-500">${u.city}</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>

                <div class="chat-main-area">
                    ${targetUser ? `
                        <div class="p-2 border-b bg-white flex items-center gap-3 shadow-sm shrink-0">
                            <button onclick="closeChat()" class="md:hidden p-2"><i class="fa-solid fa-arrow-right text-xl text-gray-600"></i></button>
                            <img src="${getUserImage(targetUser)}" class="w-10 h-10 rounded-full border">
                            <div>
                                <div class="font-bold leading-tight">${targetUser.name}</div>
                                <div class="text-xs text-gray-500">${targetUser.city}</div>
                            </div>
                        </div>
                        
                        <div id="chatMessagesArea">
                            ${store.data.currentChatMessages.map(m => `
                                <div class="flex ${m.senderId === store.user.uid ? 'justify-end' : 'justify-start'} mb-2">
                                    <div class="max-w-[80%] p-2 rounded-xl text-sm ${m.senderId === store.user.uid ? 'bg-green-100 text-gray-900 rounded-tl-none' : 'bg-white text-gray-800 rounded-tr-none shadow-sm'}">
                                        ${m.content}
                                        <div class="text-[10px] text-gray-400 text-left mt-1">${formatTime(m.timestamp)}</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        
                        <div class="chat-input-bar shrink-0">
                            <input id="chatInput" placeholder="×”×•×“×¢×”..." class="rounded-full bg-white border-gray-300" autocomplete="off">
                            <button onclick="sendMessage()" class="bg-green-500 text-white w-10 h-10 rounded-full flex items-center justify-center shadow"><i class="fa-solid fa-paper-plane"></i></button>
                        </div>
                    ` : `
                        <div class="flex flex-col items-center justify-center h-full text-gray-400">
                            <i class="fa-regular fa-comments text-6xl mb-4 opacity-20"></i>
                            <p>×‘×—×¨ ××©×ª××© ×œ×”×ª×›×ª×‘×•×ª</p>
                        </div>
                    `}
                </div>
            </div>`;
        }

        function loadChat(uid) {
            if(window.msgSub) window.msgSub();
            store.currentChatTargetId = uid;
            store.data.currentChatMessages = []; // × ×™×§×•×™ ×–×× ×™
            render(); // ×¢×“×›×•×Ÿ UI ××™×™×“×™ ×œ×¤×ª×™×—×ª ×”×—×œ×•×Ÿ
            
            const cid = [store.user.uid, uid].sort().join("_");
            window.msgSub = db.collection('chats').doc(cid).collection('messages').orderBy('timestamp','asc').onSnapshot(s => {
                store.data.currentChatMessages = s.docs.map(d => d.data());
                render();
            });
        }

        function closeChat() {
            store.currentChatTargetId = null;
            if(window.msgSub) window.msgSub();
            render();
        }

        async function sendMessage() {
            const txt = document.getElementById('chatInput').value;
            if(!txt.trim()) return;
            
            const cid = [store.user.uid, store.currentChatTargetId].sort().join("_");
            await db.collection('chats').doc(cid).collection('messages').add({
                senderId: store.user.uid,
                content: txt,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            // ×¢×“×›×•×Ÿ ××—×¨×•×Ÿ ×œ×¦'××˜
            await db.collection('chats').doc(cid).set({
                participants: [store.user.uid, store.currentChatTargetId],
                lastMessage: txt,
                lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
            }, {merge:true});
            
            document.getElementById('chatInput').value = "";
        }

        function formatTime(ts) {
            if(!ts) return '...';
            return safeDate(ts).toLocaleTimeString('he-IL', {hour:'2-digit', minute:'2-digit'});
        }

        function renderAdminPanel() {
            if(store.user.role !== 'admin') return '<div class="p-4 text-center">××™×Ÿ ×’×™×©×”</div>';
            return `
            <div class="space-y-4 p-2">
                <h2 class="text-2xl font-bold text-gray-800">× ×™×”×•×œ</h2>
                
                <div class="bg-white rounded-xl shadow overflow-hidden">
                    <div class="bg-red-50 p-3 font-bold text-red-700 border-b border-red-100">×“×™×•×•×—×™× (${store.data.reports?.length || 0})</div>
                    <div class="divide-y max-h-60 overflow-y-auto">
                        ${(store.data.reports||[]).map(r => `
                            <div class="p-3 text-sm">
                                <div class="font-bold text-red-600">${r.type}</div>
                                <div>${r.content}</div>
                                <button onclick="db.collection('reports').doc('${r.id}').delete()" class="text-blue-600 text-xs mt-1">×˜×•×¤×œ (××—×§)</button>
                            </div>
                        `).join('')}
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow overflow-hidden">
                    <div class="bg-purple-50 p-3 font-bold text-purple-700 border-b border-purple-100">×”×¦×¢×•×ª (${store.data.suggestions?.length || 0})</div>
                    <div class="divide-y max-h-60 overflow-y-auto">
                        ${(store.data.suggestions||[]).map(s => `
                            <div class="p-3 text-sm">
                                <div class="font-bold">${s.category} <span class="text-xs bg-gray-100 px-1 rounded">${s.urgency}</span></div>
                                <div>${s.content}</div>
                                <button onclick="db.collection('suggestions').doc('${s.id}').delete()" class="text-red-400 text-xs mt-1">××—×§</button>
                            </div>
                        `).join('')}
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow p-3">
                    <div class="font-bold mb-2">××©×ª××©×™×</div>
                    ${store.data.users.map(u => `
                        <div class="flex justify-between items-center py-2 border-b last:border-0 text-sm">
                            <span>${u.name}</span>
                            <select onchange="db.collection('users').doc('${u.id}').update({role:this.value})" class="w-24 p-1 text-xs mb-0">
                                <option value="user" ${u.role==='user'?'selected':''}>×¨×’×™×œ</option>
                                <option value="admin" ${u.role==='admin'?'selected':''}>×× ×”×œ</option>
                            </select>
                        </div>
                    `).join('')}
                </div>
                
                <div class="bg-white p-3 rounded-xl shadow">
                    <button onclick="document.getElementById('addAvatarModal').classList.remove('hidden')" class="w-full bg-green-500 text-white py-2 rounded font-bold">×”×•×¡×£ ××•×•×˜××¨ ××¢×¨×›×ª</button>
                </div>
            </div>`;
        }

        function saveProfileChanges() {
            const city = document.getElementById('editCity').value;
            const gender = document.getElementById('editGender').value;
            const customImg = store.tempImageBase64;
            const avatarUrl = document.getElementById('selectedAvatarUrl').value;
            
            const updateData = { city, gender };
            if (customImg) updateData.customImage = customImg;
            else if (avatarUrl) { updateData.avatarSeed = avatarUrl; updateData.customImage = null; }
            
            db.collection('users').doc(store.user.uid).update(updateData).then(() => {
                closeProfileModal();
                render();
            });
        }

        function handleImageUpload(input) {
            if (input.files && input.files[0]) {
                compressImage(input.files[0], 300, 0.7, (base64) => {
                    store.tempImageBase64 = base64;
                    document.getElementById('previewImg').src = base64;
                });
            }
        }
        
        function openProfileModal() {
            document.getElementById('editCity').value = store.user.city || '';
            document.getElementById('editGender').value = store.user.gender || 'male';
            document.getElementById('previewImg').src = getUserImage(store.user);
            
            const grid = document.getElementById('avatarGrid');
            grid.innerHTML = store.data.systemAvatars.map(a => `
                <img src="${a.url}" onclick="selectAvatar('${a.url}', this)" class="w-16 h-16 rounded-full border-2 border-transparent hover:border-red-500 cursor-pointer bg-gray-100">
            `).join('');
            
            document.getElementById('profileModal').classList.remove('hidden');
        }
        
        function selectAvatar(url, el) {
            store.tempImageBase64 = null;
            document.getElementById('selectedAvatarUrl').value = url;
            document.getElementById('previewImg').src = url;
            // Visual feedback code omitted for brevity
        }

        function closeProfileModal() { document.getElementById('profileModal').classList.add('hidden'); }

        function renderBottomNav() {
            const active = (p) => store.currentPage === p ? 'active' : '';
            return `
                <div onclick="navigate('home')" class="nav-item ${active('home')}"><i class="fa-solid fa-house"></i><span>×‘×™×ª</span></div>
                <div onclick="navigate('activities')" class="nav-item ${active('activities')}"><i class="fa-solid fa-person-walking"></i><span>×¤×¢×™×œ×•×™×•×ª</span></div>
                <div onclick="navigate('forums')" class="nav-item ${active('forums')}"><i class="fa-solid fa-comments"></i><span>×¤×•×¨×•××™×</span></div>
                <div onclick="navigate('chats')" class="nav-item ${active('chats')}"><i class="fa-solid fa-envelope"></i><span>×”×•×“×¢×•×ª</span></div>
            `;
        }
    </script>
</body>
</html>
