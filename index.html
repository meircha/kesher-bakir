<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×§×”×™×œ×ª ×§×©×¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <style>
        /* ×”×’×“×¨×•×ª ×˜×™×™×œ×•×™× ×“ ×‘×¡×™×¡×™×•×ª ×•×¦×‘×¢×™× ××•×ª×××™× ××™×©×™×ª */
        :root {
            --kesher-blue: #3b82f6; /* Blue 500 */
            --kesher-green: #10b981; /* Emerald 500 */
        }
        .bg-kesher-blue { background-color: var(--kesher-blue); }
        .hover\:bg-kesher-blue:hover { background-color: #2563eb; }
        .text-kesher-blue { color: var(--kesher-blue); }
        .bg-kesher-green { background-color: var(--kesher-green); }
        .hover\:bg-kesher-green:hover { background-color: #059669; }
        .text-kesher-green { color: var(--kesher-green); }
        body {
            background-color: #f3f4f6; /* Gray 100 */
            font-family: 'Arial', sans-serif;
        }
        #root {
            min-height: 100vh;
            padding-bottom: 2rem;
        }
    </style>
</head>
<body>
    <div id="root" class="pt-16">
        </div>

    <script>
        // --- 1. ×”×’×“×¨×•×ª Firebase ×•××™×—×–×•×¨ × ×ª×•× ×™× ---
        
        // **×¤×¨×˜×™ ×”-Firebase Config ×”××ª×•×§× ×™× ×©×œ×š**
        const firebaseConfig = {
            apiKey: "AIzaSyCrcxC420HW5PXGNd8M4KuclUkiJSwHreM", 
            authDomain: "kesher-bakir.firebaseapp.com",
            projectId: "kesher-bakir",
            storageBucket: "kesher-bakir.firebasestorage.app",
            messagingSenderId: "671996189455",
            appId: "1:671996189455:web:dbe089d69a85a2ab38fc7a",
            measurementId: "G-42EWSKFXW" 
        };
        
        // ××ª×—×•×œ Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        
        const auth = firebase.auth();
        const db = firebase.firestore();

        // ××¦×‘ ×’×œ×•×‘×œ×™ (State Management)
        const state = {
            user: null, 
            screen: 'login',
            users: [], 
            forums: [],
            activities: [],
            reports: [],
            
            // ××©×ª× ×™× ×¡×¤×¦×™×¤×™×™× ×œ××¡×š
            currentForumId: null,
            currentPost: null,
            currentPostReplies: [],
            selectedUser: null,
            chatMessages: [],
            usersFilter: { city: '', role: '', hobby: '' },
        };

        // × ×ª×•× ×™× ×¤×™×§×˜×™×‘×™×™× ×–×× ×™×™× (×× ××™×Ÿ ×—×™×‘×•×¨)
        function loadFakeData() {
            state.users = [];
        }

        /**
         * ××—×–×•×¨ × ×ª×•× ×™× ×¨××©×•× ×™ ×-Firestore (×—×™×•× ×™ ×œ×× ×™×¢×ª ×”××¡×š ×”×œ×‘×Ÿ)
         */
        async function fetchInitialData() {
            try {
                // 1. ××—×–×•×¨ ×¨×©×™××ª ××©×ª××©×™×
                const usersSnapshot = await db.collection('users').get();
                state.users = usersSnapshot.docs.map(doc => ({ 
                    id: doc.id, 
                    ...doc.data(), 
                    isOnline: doc.data().isOnline || false 
                }));
                // 2. ××—×–×•×¨ ×¤×¢×™×œ×•×™×•×ª (×”×¤×¢×œ×ª ×¤×•× ×§×¦×™×•×ª ×”×¤×™×§×˜×™×‘×™×•×ª ×”×•×¡×¨×” ××›×™×•×•×Ÿ ×©×”× ×ª×•× ×™× × ×˜×¢× ×™× ×-Firestore)
                loadFakeForumData();
                const activitiesSnapshot = await db.collection('activities').get();
                state.activities = activitiesSnapshot.docs.map(doc => ({ 
                    id: doc.id, 
                    ...doc.data(),
                    date: doc.data().date?.toDate() || new Date() 
                }));
            } catch (error) {
                console.error("×©×’×™××” ×‘××—×–×•×¨ × ×ª×•× ×™×: ", error);
                // ×‘××§×¨×” ×©×œ ×©×’×™××”, × ×©×ª××© ×‘× ×ª×•× ×™× ×¤×™×§×˜×™×‘×™×™× ×œ×—×œ×•×˜×™×Ÿ.
                loadFakeForumData(true); 
            }
        }
        
        // ×¤×•× ×§×¦×™×™×ª ×˜×¢×™× ×ª × ×ª×•× ×™× ×¤×™×§×˜×™×‘×™×™× ×œ××‘× ×™× (×¤×•×¨×•×, ×¤×¢×™×œ×•×™×•×ª)
        function loadFakeForumData(forceUserFakes = false) {
            const now = firebase.firestore.Timestamp.now();
            const post1Replies = [
                { id: 'r1', content: '××¡×›×™×! ×”×—×©×™×¤×” ×œ××ª× ×“×‘×™× ×—×“×©×™× ×”×™× ××ª×’×¨ ×××™×ª×™.', creatorId: 'user2', creatorName: '×“× ×™××œ ×›×”×Ÿ', createdAt: now },
                { id: 'r2', content: '××•×œ×™ ×›×“××™ ×œ×™×¦×•×¨ ×“×£ × ×—×™×ª×” ×™×™×¢×•×“×™?', creatorId: 'user1', creatorName: '××•×¨×™×ª ×œ×•×™', createdAt: now },
            ];
            state.forums = [
                { id: 'f1', title: '×”×ª× ×“×‘×•×ª ×•×§×”×™×œ×”', description: '×“×™×•× ×™× ×¢×œ ×™×•×–××•×ª ×—×‘×¨×ª×™×•×ª ×—×“×©×•×ª.', icon: '??', posts: [
                    { id: 'p1', title: '××™×š ××’×™×™×¡×™× ××ª× ×“×‘×™× ×—×“×©×™×?', content: '×× ×™ ×× ×”×œ ×§×‘×•×¦×” ×§×˜× ×” ×•××—×¤×© ×“×¨×›×™× ×™×¦×™×¨×ª×™×•×ª ×œ×’×™×™×¡ ×¢×•×“ ×—×‘×¨×™× ×¤×¢×™×œ×™×.', creatorId: 'user1', creatorName: '××•×¨×™×ª ×œ×•×™', createdAt: now, likes: ['user2', 'user3'], replies: post1Replies },
                ]},
                { id: 'f2', title: '×˜×™×•×œ×™× ×•×˜×‘×¢', description: '××¡×œ×•×œ×™× ××•××œ×¦×™× ×•×¦×™×•×“ ×§××¤×™× ×’.', icon: '??', posts: [] },
            ];
            // ×× ××™×Ÿ ××©×ª××©×™× ×-Firestore (××• × ×›×©×œ) × ×©×ª××© ×‘×¤×™×§×˜×™×‘×™×™×
            if (forceUserFakes || state.users.length === 0) {
                 state.users = [
                    { id: 'user1', name: '××•×¨×™×ª ×œ×•×™', email: 'orit@example.com', city: '×ª×œ ××‘×™×‘', role: 'user', points: 150, isOnline: true, hobbies: ['×‘×™×©×•×œ', '×˜×™×•×œ×™×'], contributions: ['×™×™×¢×•×¥ ×¢×¡×§×™', '××¨×’×•×Ÿ ××™×¨×•×¢×™×'] },
                    { id: 'user2', name: '×“× ×™××œ ×›×”×Ÿ', email: 'daniel@example.com', city: '×™×¨×•×©×œ×™×', role: 'user', points: 300, isOnline: false, hobbies: ['×¡×¤×•×¨×˜', '×¦×™×œ×•×'], contributions: ['×¢×–×¨×” ×˜×›× ×™×ª', '×”×“×¨×›×”'] },
                    { id: 'user3', name: '×××™×” ××œ×•×Ÿ', email: 'maya@example.com', city: '×—×™×¤×”', role: 'admin', points: 900, isOnline: true, hobbies: ['×¦×™×œ×•×', '××¤×™×™×”'], contributions: ['× ×™×”×•×œ ×§×”×™×œ×”', '×’×¨×¤×™×§×”'] },
                ];
            }

            state.reports = [
                { id: 'rep1', itemId: 'p1', itemType: 'post', reason: '×©×¤×” ×‘×•×˜×”', reporterName: '×“× ×™××œ ×›×”×Ÿ', reportedUserId: 'user1', status: '×—×“×©' },
            ];
        }

        /**
         * ×¤×•× ×§×¦×™×™×ª × ×™×ª×•×‘ ×‘×¡×™×¡×™×ª
         */
        function goTo(screen, params = {}) {
            state.screen = screen;
            state.currentForumId = params.forumId || null;
            state.currentPost = null;
            state.currentPostReplies = [];
            if (screen === 'forumPosts' && params.forumId) {
                state.currentForumId = params.forumId;
            } else if (screen === 'postDetails' && params.postId) {
                const forum = state.forums.find(f => f.posts?.some(p => p.id === params.postId));
                if (forum) {
                    state.currentPost = forum.posts.find(p => p.id === params.postId);
                    state.currentPostReplies = state.currentPost.replies || [];
                    state.currentForumId = forum.id;
                } else {
                    alert('×©×’×™××”: ×”×¤×•×¡×˜ ×œ× × ××¦×');
                    goTo('forums');
                }
            }
            render();
            // ×’×œ×™×œ×” ××•×˜×•××˜×™×ª ×œ××˜×” ×‘×¦'××˜
            if (screen === 'chat') {
                setTimeout(() => {
                    const chatBox = document.getElementById('chatBox');
                    if (chatBox) chatBox.scrollTop = chatBox.scrollHeight;
                }, 50);
            }
        }

        function openChat(targetUser) {
            state.selectedUser = targetUser;
            // ×˜×¢×™× ×ª ×”×•×“×¢×•×ª ×¤×™×§×˜×™×‘×™×•×ª
            state.chatMessages = [
                { id: 'm1', senderId: targetUser.id, content: `×”×™×™ ${state.user.name}, ×‘×¨×•×š ×”×‘× ×œ×¦'××˜!`, timestamp: firebase.firestore.Timestamp.now() },
                { id: 'm2', senderId: state.user.id, content: `×”×™×™ ${targetUser.name}, ××™×–×” ×›×™×£ ×œ×”×™×•×ª ×›××Ÿ!`, timestamp: firebase.firestore.Timestamp.now() },
            ];
            goTo('chat');
        }


        // --- 2. ×¤×•× ×§×¦×™×•×ª Firebase (×”×ª×—×‘×¨×•×ª, ×¨×™×©×•×, ×©×—×–×•×¨) - **××ª×•×§×Ÿ** ---
        
        /**
         * ×¤×•× ×§×¦×™×™×ª ×”×ª×—×‘×¨×•×ª - ×©×™××•×© ×‘-Firebase Auth ×•×‘××—×–×•×¨ × ×ª×•× ×™× ×-Firestore
         */
        window.doLogin = async () => {
            const email = document.getElementById('email').value;
            const password = document.getElementById('pwd').value;
            const errorElement = document.getElementById('loginError');
            errorElement.style.color = 'red'; 
            errorElement.textContent = '';
            if (!email || !password) {
                errorElement.textContent = '×™×© ×œ××œ× ××ª ×›×œ ×”×©×“×•×ª.';
                return;
            }

            try {
                // ×©×œ×‘ 1: ××™××•×ª ×‘×××¦×¢×•×ª Firebase Authentication
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                const user = userCredential.user;
                
                // ×©×œ×‘ 2: ××—×–×•×¨ × ×ª×•× ×™ ×¤×¨×•×¤×™×œ ×-Firestore
                const userDoc = await db.collection('users').doc(user.uid).get();
                
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    
                    // ×¢×“×›×•×Ÿ ×”××¦×‘ ×”×’×œ×•×‘×œ×™ ×¢× × ×ª×•× ×™ ×”××©×ª××© ×”×××™×ª×™×™×
                    state.user = { 
                        id: user.uid, 
                        email: user.email, 
                        name: userData.name, 
                        role: userData.role || 'user', // ×–×” ×™××©×•×š ××ª 'admin' ×× ×§×™×™×
                        points: userData.points || 0,
                        hobbies: userData.hobbies || [], 
                        contributions: userData.contributions || [] 
                    };

                    // *** ×”×©×•×¨×” ×”×§×¨×™×˜×™×ª ×œ×¤×ª×¨×•×Ÿ ×”××¡×š ×”×œ×‘×Ÿ ***
                    await fetchInitialData(); 
                    
                    errorElement.textContent = '';
                    goTo('home'); // ×”××¢×‘×¨ ×™×ª×‘×¦×¢ ×¨×§ ×œ××—×¨ ×˜×¢×™× ×ª ×›×œ ×”× ×ª×•× ×™×
                } else {
                    // ×”××™×™×œ ×§×™×™× ×‘-Auth, ××‘×œ ×œ× × ××¦× ×‘-Firestore
                    errorElement.textContent = '×©×’×™××”: ×”××©×ª××© ××•××ª ××š ×”×¤×¨×•×¤×™×œ ×©×œ×• ×œ× × ××¦× ×‘××¡×“ ×”× ×ª×•× ×™× (Firestore).';
                    auth.signOut();
                }

            } catch (error) {
                // ×˜×™×¤×•×œ ×‘×©×’×™××•×ª ×›× ×™×¡×”
                if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                    errorElement.textContent = '×©× ××©×ª××© ××• ×¡×™×¡××” ×©×’×•×™×™×.';
                } else if (error.code === 'auth/invalid-email') {
                    errorElement.textContent = '×›×ª×•×‘×ª ×“×•×"×œ ×œ× ×ª×§×™× ×”.';
                } else {
                    errorElement.textContent = `×©×’×™××ª ×”×ª×—×‘×¨×•×ª: ${error.message}`;
                }
            }
        };

        /**
         * ×¤×•× ×§×¦×™×™×ª ×¨×™×©×•× - ×©×™××•×© ×‘-Firebase Auth ×•-Firestore
         */
        window.doRegister = async () => {
            const name = document.getElementById('regName').value;
            const email = document.getElementById('regEmail').value;
            const password = document.getElementById('regPwd').value;
            const city = document.getElementById('regCity').value;
            const hobbiesInput = document.getElementById('regHobbies').value;
            const contributionsInput = document.getElementById('regContributions').value;
            const errorElement = document.getElementById('registerError');
            errorElement.textContent = '';
            if (!name || !email || !password || !city || !hobbiesInput || !contributionsInput) {
                errorElement.textContent = '×™×© ×œ××œ× ××ª ×›×œ ×”×©×“×•×ª.';
                return;
            }
            
            const hobbiesArray = hobbiesInput.split(',').map(item => item.trim()).filter(item => item !== '');
            const contributionsArray = contributionsInput.split(',').map(item => item.trim()).filter(item => item !== '');

            try {
                // ×©×œ×‘ 1: ×™×¦×™×¨×ª ×”××©×ª××© ×‘-Firebase Authentication
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;
                
                // ×©×œ×‘ 2: ×™×¦×™×¨×ª ×“×•×§×•×× ×˜ ×‘-Firestore (×§×•×œ×§×¦×™×™×ª users)
                const newUserData = {
                    name: name,
                    city: city,
                    role: 'user',
                    points: 0,
                    isOnline: true,
                    hobbies: hobbiesArray, 
                    contributions: contributionsArray,
                    email: email,
                    joinDate: firebase.firestore.FieldValue.serverTimestamp()
                };
                await db.collection('users').doc(user.uid).set(newUserData);
                
                // ×¢×“×›×•×Ÿ ×”××¦×‘ ×”×’×œ×•×‘×œ×™ ×•×›× ×™×¡×”
                state.user = { id: user.uid, email: user.email, ...newUserData };
                await fetchInitialData();
                goTo('home');
                
            } catch (error) {
                if (error.code === 'auth/email-already-in-use') {
                    errorElement.textContent = '×›×ª×•×‘×ª ×”×“×•×"×œ ×”×–×• ×›×‘×¨ ×¨×©×•××” ×‘××¢×¨×›×ª.';
                } else if (error.code === 'auth/weak-password') {
                    errorElement.textContent = '×”×¡×™×¡××” ×—×œ×©×” ××“×™ (×¦×¨×™×›×” ×œ×”×™×•×ª 6 ×ª×•×•×™× ×œ×¤×—×•×ª).';
                } else {
                    errorElement.textContent = `×©×’×™××ª ×¨×™×©×•×: ${error.message}`;
                }
            }
        };

        /**
         * ×¤×•× ×§×¦×™×™×ª ×©×—×–×•×¨ ×¡×™×¡××”
         */
        window.doResetPassword = async () => {
            const email = document.getElementById('email').value;
            const errorElement = document.getElementById('loginError');
            errorElement.style.color = 'red'; 
            errorElement.textContent = ''; 

            if (!email) {
                errorElement.textContent = '×™×© ×œ×”×–×™×Ÿ ×›×ª×•×‘×ª ×“×•×"×œ ×‘×©×“×” ×”××™×™×œ ×›×“×™ ×œ×©×—×–×¨ ×¡×™×¡××”.';
                return;
            }
            
            try {
                await auth.sendPasswordResetEmail(email);
                // ×”×¦×œ×—×”
                errorElement.textContent = 'âœ… × ×©×œ×— ×§×™×©×•×¨ ×œ××™×¤×•×¡ ×¡×™×¡××” ×œ×›×ª×•×‘×ª ' + email;
                errorElement.style.color = 'green';
            } catch (error) {
                // ×˜×™×¤×•×œ ×‘×©×’×™××•×ª (×›×’×•×Ÿ: ×”××™×™×œ ×œ× ×§×™×™× ×‘-Auth)
                if (error.code === 'auth/user-not-found') {
                    errorElement.textContent = '×›×ª×•×‘×ª ×”××™×™×œ ××™× ×” ×§×™×™××ª ×‘××¢×¨×›×ª ×”××™××•×ª (Auth).';
                } else {
                    errorElement.textContent = `×©×’×™××ª ×©×—×–×•×¨: ${error.message}`;
                }
            }
            
            // ××—×¨×™ 5 ×©× ×™×•×ª × × ×§×” ××ª ×”×”×•×“×¢×”
            setTimeout(() => {
                errorElement.textContent = '';
                errorElement.style.color = 'red';
            }, 5000);
        };
        
        /**
         * ×¤×•× ×§×¦×™×™×ª ×™×¦×™××”
         */
        window.doLogout = () => {
            auth.signOut().then(() => {
                state.user = null;
                goTo('login');
                fetchInitialData(); 
            }).catch((error) => {
                console.error("×©×’×™××” ×‘×™×¦×™××”:", error);
            });
        };


        // --- 3. ×¤×•× ×§×¦×™×•×ª ×¢×–×¨ ×•××™× ×˜×¨××§×¦×™×” ---
        
        window.sendMessage = () => {
            const input = document.getElementById('chatInput');
            const content = input.value.trim();
            if (!content || !state.selectedUser || !state.user) return;
            const newMessage = {
                id: 'm' + (state.chatMessages.length + 1),
                senderId: state.user.id,
                content: content,
                timestamp: firebase.firestore.Timestamp.now(),
            };
            state.chatMessages.push(newMessage);
            input.value = '';
            render();
        };

        window.createPost = () => {
            const title = document.getElementById('postTitle').value.trim();
            const content = document.getElementById('postContent').value.trim();
            const forum = state.forums.find(f => f.id === state.currentForumId);
            if (!title || !content || !forum) {
                alert('×™×© ×œ××œ× ×›×•×ª×¨×ª ×•×ª×•×›×Ÿ.');
                return;
            }

            const newPost = {
                id: 'p' + (Math.random() * 1000).toFixed(0),
                title: title,
                content: content,
                creatorId: state.user.id,
                creatorName: state.user.name,
                createdAt: firebase.firestore.Timestamp.now(),
                likes: [],
                replies: []
            };
            if (!forum.posts) forum.posts = [];
            forum.posts.unshift(newPost);
            
            alert('×”×¤×•×¡×˜ ×¤×•×¨×¡× ×‘×”×¦×œ×—×”!');
            goTo('forumPosts', { forumId: state.currentForumId });
        };

        window.addReply = () => {
            const content = document.getElementById('replyContent').value.trim();
            const post = state.currentPost;
            
            if (!content || !post) return;

            const newReply = {
                id: 'r' + (Math.random() * 1000).toFixed(0),
                content: content,
                creatorId: state.user.id,
                creatorName: state.user.name,
                createdAt: firebase.firestore.Timestamp.now(),
            };

            if (!post.replies) post.replies = [];
            post.replies.push(newReply);
            state.currentPostReplies.push(newReply);

            // ×¢×“×›×•×Ÿ × ×™×§×•×“
            state.user.points = (state.user.points || 0) + 5;
            db.collection('users').doc(state.user.id).update({ points: state.user.points }); 

            document.getElementById('replyContent').value = '';
            render();
        };

        window.toggleLike = (postId) => {
            const post = state.currentPost;
            if (!post) return;

            if (!post.likes) post.likes = [];

            const userIndex = post.likes.indexOf(state.user.id);
            if (userIndex > -1) {
                post.likes.splice(userIndex, 1);
            } else {
                post.likes.push(state.user.id);
                // ×¢×“×›×•×Ÿ × ×™×§×•×“
                state.user.points = (state.user.points || 0) + 1;
                db.collection('users').doc(state.user.id).update({ points: state.user.points });
            }
            render();
        };

        window.createActivity = async () => {
            const title = document.getElementById('activityTitle').value.trim();
            const description = document.getElementById('activityDescription').value.trim();
            const date = document.getElementById('activityDate').value;
            const location = document.getElementById('activityLocation').value.trim();
            if (!title || !description || !date || !location) {
                alert('×™×© ×œ××œ× ××ª ×›×œ ×¤×¨×˜×™ ×”×¤×¢×™×œ×•×ª.');
                return;
            }

            const newActivityData = {
                title: title,
                description: description,
                date: new Date(date),
                location: location,
                creatorId: state.user.id,
                creatorName: state.user.name,
                attendees: [state.user.id]
            };
            try {
                const docRef = await db.collection('activities').add(newActivityData);
                state.activities.push({ id: docRef.id, ...newActivityData, date: newActivityData.date }); // ×¢×“×›×•×Ÿ ××§×•××™
                alert('×”×¤×¢×™×œ×•×ª ×¤×•×¨×¡××” ×‘×”×¦×œ×—×”!');
                goTo('activities');
            } catch (error) {
                console.error("×©×’×™××” ×‘×™×¦×™×¨×ª ×¤×¢×™×œ×•×ª:", error);
                alert("××™×¨×¢×” ×©×’×™××” ×‘×¤×¨×¡×•× ×”×¤×¢×™×œ×•×ª.");
            }
        };

        window.registerForActivity = async (activityId) => {
            const activity = state.activities.find(a => a.id === activityId);
            if (!activity || activity.attendees.includes(state.user.id)) return;

            activity.attendees.push(state.user.id);
            
            try {
                // ×¢×“×›×•×Ÿ ×”-attendees ×‘-Firestore
                await db.collection('activities').doc(activityId).update({
                    attendees: firebase.firestore.FieldValue.arrayUnion(state.user.id)
                });
                alert(`× ×¨×©××ª ×‘×”×¦×œ×—×” ×œ×¤×¢×™×œ×•×ª: ${activity.title}!`);
                render();
            } catch (error) {
                console.error("×©×’×™××” ×‘×¨×™×©×•× ×œ×¤×¢×™×œ×•×ª:", error);
                alert("××™×¨×¢×” ×©×’×™××” ×‘××”×œ×š ×”×¨×™×©×•×.");
            }
        };

        window.reportItem = (itemId, itemType, reportedUserId) => {
            const reason = prompt(`×“×•×•×— ×¢×œ ${itemType} (ID: ${itemId}). ×× × ×¦×™×™×Ÿ ×¡×™×‘×”:`);
            if (reason) {
                const newReport = {
                    id: 'rep' + (Math.random() * 1000).toFixed(0),
                    itemId: itemId,
                    itemType: itemType,
                    reason: reason,
                    reporterName: state.user.name,
                    reportedUserId: reportedUserId,
                    status: '×—×“×©'
                };
                state.reports.push(newReport);
                alert('×”×“×™×•×•×— × ×©×œ×— ×‘×”×¦×œ×—×” ×œ×¦×•×•×ª ×”× ×™×”×•×œ.');
                render();
            }
        };

        window.updateReportStatus = (reportId, newStatus) => {
            const report = state.reports.find(r => r.id === reportId);
            if (report) {
                report.status = newStatus;
                alert(`×¡×˜×˜×•×¡ ×“×™×•×•×— ${reportId.substring(0, 5)}... ×¢×•×“×›×Ÿ ×œ: ${newStatus}`);
                render();
            }
        };

        function timeSince(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            let interval = seconds / 31536000;
            if (interval > 1) return Math.floor(interval) + " ×©× ×™×";
            interval = seconds / 2592000;
            if (interval > 1) return Math.floor(interval) + " ×—×•×“×©×™×";
            interval = seconds / 86400;
            if (interval > 1) return Math.floor(interval) + " ×™××™×";
            interval = seconds / 3600;
            if (interval > 1) return Math.floor(interval) + " ×©×¢×•×ª";
            interval = seconds / 60;
            if (interval > 1) return Math.floor(interval) + " ×“×§×•×ª";
            return "×¢×›×©×™×•";
        }


        // --- 4. ×¨×›×™×‘×™× ×—×–×•×ª×™×™× (Rendering Components) ---

        const getHeader = () => {
            if (!state.user) return '';

            const isCurrent = (screen) => state.screen === screen ? 'bg-white text-kesher-blue shadow-md' : 'text-gray-100 hover:bg-kesher-blue/80';
            
            return `
                <header class="fixed top-0 left-0 right-0 bg-kesher-blue text-white shadow-lg z-50">
                    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                        <div class="flex items-center justify-between h-16">
                            <div class="flex items-center">
                                <span class="text-2xl font-bold">×§×”×™×œ×ª ×§×©×¨</span>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="goTo('home')" class="px-3 py-2 rounded-lg font-medium transition ${isCurrent('home')}">ğŸ  ×‘×™×ª</button>
                                <button onclick="goTo('users')" class="px-3 py-2 rounded-lg font-medium transition ${isCurrent('users')}">? ×—×‘×¨×™×</button>
                                <button onclick="goTo('forums')" class="px-3 py-2 rounded-lg font-medium transition ${isCurrent('forums') || isCurrent('forumPosts') || isCurrent('newPost') || isCurrent('postDetails')}">?? ×¤×•×¨×•××™×</button>
                                <button onclick="goTo('activities')" class="px-3 py-2 rounded-lg font-medium transition ${isCurrent('activities') || isCurrent('newActivity')}">?? ×¤×¢×™×œ×•×™×•×ª</button>
                                ${state.user.role === 'admin' ? `
                                    <button onclick="goTo('admin')" class="px-3 py-2 rounded-lg font-medium transition ${isCurrent('admin')} bg-red-600 hover:bg-red-700">?? × ×™×”×•×œ</button>
                                ` : ''}
                            </div>
                            <div class="flex items-center gap-4">
                                <span class="text-sm font-medium">? ${state.user.name}</span>
                                <button onclick="doLogout()" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded-full transition text-sm">×™×¦×™××”</button>
                            </div>
                        </div>
                    </div>
                </header>
            `;
        };

        const renderLogin = () => {
            return `
                <div class="flex items-center justify-center min-h-screen bg-gray-100 p-4 pt-16">
                    <div class="w-full max-w-md bg-white p-8 rounded-2xl shadow-2xl">
                        <h2 class="text-4xl font-extrabold text-center text-kesher-blue mb-8">×‘×¨×•×›×™× ×”×‘××™× ×œ×§×”×™×œ×ª ×§×©×¨</h2>
                        <form onsubmit="event.preventDefault(); doLogin()" class="space-y-6">
                            <div>
                                <label for="email" class="block text-sm font-medium text-gray-700">×“×•×"×œ</label>
                                <input type="email" id="email" class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:ring-kesher-blue focus:border-kesher-blue" required>
                            </div>
                            <div>
                                <label for="pwd" class="block text-sm font-medium text-gray-700">×¡×™×¡××”</label>
                                <input type="password" id="pwd" class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:ring-kesher-blue focus:border-kesher-blue" required>
                            </div>
                            <p id="loginError" class="text-red-600 text-sm text-center"></p>
                            <button type="submit" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-lg font-bold text-white bg-kesher-green hover:bg-green-700 transition">
                                ×”×ª×—×‘×¨
                            </button>
                            <button type="button" onclick="doResetPassword()" class="w-full text-sm text-kesher-blue hover:text-blue-700 mt-2">
                                ×©×›×—×ª×™ ×¡×™×¡××”
                            </button>
                        </form>
                        <div class="mt-6 text-center">
                            <p class="text-sm text-gray-600">
                                ××™×Ÿ ×œ×š ×—×©×‘×•×Ÿ?
                                <button onclick="goTo('register')" class="font-medium text-kesher-blue hover:text-blue-700">×”×™×¨×©× ×›××Ÿ</button>
                            </p>
                        </div>
                    </div>
                </div>
            `;
        };

        const renderRegister = () => {
            return `
                <div class="flex items-center justify-center min-h-screen bg-gray-100 p-4 pt-16">
                    <div class="w-full max-w-md bg-white p-8 rounded-2xl shadow-2xl">
                        <h2 class="text-4xl font-extrabold text-center text-kesher-green mb-8">×”×¨×©××” ×œ×§×”×™×œ×”</h2>
                        <form onsubmit="event.preventDefault(); doRegister()" class="space-y-6">
                            <div>
                                <label for="regName" class="block text-sm font-medium text-gray-700">×©× ××œ×</label>
                                <input type="text" id="regName" class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm" required>
                            </div>
                            <div>
                                <label for="regEmail" class="block text-sm font-medium text-gray-700">×“×•×"×œ</label>
                                <input type="email" id="regEmail" class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm" required>
                            </div>
                            <div>
                                <label for="regPwd" class="block text-sm font-medium text-gray-700">×¡×™×¡××” (6 ×ª×•×•×™× ×œ×¤×—×•×ª)</label>
                                <input type="password" id="regPwd" class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm" required>
                            </div>
                            <div>
                                <label for="regCity" class="block text-sm font-medium text-gray-700">×¢×™×¨ ××’×•×¨×™×</label>
                                <input type="text" id="regCity" class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm" required>
                            </div>
                            
                            <div>
                                <label for="regHobbies" class="block text-sm font-medium text-gray-700">×ª×—×‘×™×‘×™× (×”×¤×¨×“ ×‘×¤×¡×™×§, ×œ×“×•×’××”: ×¡×¤×•×¨×˜, ×‘×™×©×•×œ)</label>
                                <input type="text" id="regHobbies" placeholder="×œ×“×•×’××”: ×’×™× ×•×Ÿ, ×§×¨×™××”, ×˜×™×•×œ×™×" class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm" required>
                            </div>
                            
                            <div>
                                <label for="regContributions" class="block text-sm font-medium text-gray-700">×ª×—×•××™× ×‘×”× ×× ×™ ×™×›×•×œ/×” ×œ×ª×¨×•× (×”×¤×¨×“ ×‘×¤×¡×™×§, ×œ×“×•×’××”: ×™×™×¢×•×¥ ××©×¤×˜×™, × ×’×¨×•×ª)</label>
                                <input type="text" id="regContributions" placeholder="×œ×“×•×’××”: ×¢×–×¨×” ×˜×›× ×™×ª, ×©×™×¢×•×¨×™ ×¢×–×¨, ×™×™×¢×•×¥" class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm" required>
                            </div>

                            <p id="registerError" class="text-red-600 text-sm text-center"></p>
                            <button type="submit" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-lg font-bold text-white bg-kesher-blue hover:bg-blue-600 transition">
                                ×”×©×œ× ×”×¨×©××”
                            </button>
                        </form>
                        <div class="mt-6 text-center">
                            <p class="text-sm text-gray-600">
                                ×›×‘×¨ ×™×© ×œ×š ×—×©×‘×•×Ÿ?
                                <button onclick="goTo('login')" class="font-medium text-kesher-green hover:text-green-700">×”×ª×—×‘×¨ ×›××Ÿ</button>
                            </p>
                        </div>
                    </div>
                </div>
            `;
        };

        const renderHome = () => {
            const onlineUsers = state.users.filter(u => u.isOnline && u.id !== state.user.id);
            const myActivities = state.activities.filter(a => a.attendees.includes(state.user.id));
            
            return `
                ${getHeader()}
                <div class="max-w-6xl mx-auto px-4 mt-8">
                    <h2 class="text-3xl font-bold text-gray-800 mb-8">×‘×¨×•×š ×”×‘×, ${state.user.name}! ğŸ‘‹</h2>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        
                        <div class="bg-kesher-green text-white p-6 rounded-2xl shadow-xl lg:col-span-1 flex flex-col justify-between">
                            <h3 class="text-2xl font-bold mb-2">â­ ×”× ×™×§×•×“ ×©×œ×™</h3>
                            <p class="text-5xl font-extrabold mb-4">${state.user.points || 0}</p>
                            <p class="text-sm">×¦×‘×•×¨ × ×§×•×“×•×ª ×¢×œ ×™×“×™ ×ª×’×•×‘×•×ª ×•×¢×–×¨×” ×œ××—×¨×™×.</p>
                        </div>

                        <div class="bg-white p-6 rounded-2xl shadow-xl lg:col-span-2">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-xl font-bold text-kesher-blue">? ×—×‘×¨×™× ××—×•×‘×¨×™× ( ${onlineUsers.length} )</h3>
                                <button onclick="goTo('users')" class="text-kesher-blue hover:text-blue-700 text-sm font-medium">×”×¦×’ ××ª ×›×œ ×”×—×‘×¨×™× Â»</button>
                            </div>
                            <div class="space-y-3 max-h-48 overflow-y-auto">
                                ${onlineUsers.length > 0 ? onlineUsers.slice(0, 5).map(u => `
                                    <button onclick="openChat({ id: '${u.id}', name: '${u.name}' })" class="flex items-center gap-2 p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100 transition w-full text-right">
                                        <div class="w-2 h-2 bg-green-500 rounded-full shrink-0"></div>
                                        <span class="text-sm font-medium">${u.name} (${u.city})</span>
                                    </button>
                                `).join('') : '<p class="text-gray-500">××™×Ÿ ×—×‘×¨×™× ××—×•×‘×¨×™× ×›×¨×’×¢.</p>'}
                            </div>
                        </div>

                        <div class="lg:col-span-3 bg-white p-6 rounded-2xl shadow-xl">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-xl font-bold text-kesher-blue">?? ×¤×•×¨×•××™× ×¤×•×¤×•×œ×¨×™×™×</h3>
                                <button onclick="goTo('forums')" class="text-kesher-blue hover:text-blue-700 text-sm font-medium">×”×›×œ Â»</button>
                            </div>
                            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4">
                                ${state.forums.slice(0, 4).map(f => `
                                    <div onclick="goTo('forumPosts', { forumId: '${f.id}' })" class="bg-gray-50 p-4 rounded-xl shadow-sm hover:shadow-md transition cursor-pointer text-center">
                                        <div class="text-3xl mb-2">${f.icon}</div>
                                        <p class="font-bold text-kesher-green">${f.title}</p>
                                        <p class="text-xs text-gray-500">${f.description}</p>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <div class="lg:col-span-3 bg-white p-6 rounded-2xl shadow-xl">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-xl font-bold text-kesher-green">?? ×”×¤×¢×™×œ×•×™×•×ª ×”×§×¨×•×‘×•×ª ×©×œ×™</h3>
                                <button onclick="goTo('activities')" class="text-kesher-green hover:text-green-700 text-sm font-medium">×”×¦×’ ×”×›×œ Â»</button>
                            </div>
                            <div class="space-y-3">
                                ${myActivities.length > 0 ? myActivities.slice(0, 3).map(a => `
                                    <div class="bg-gray-50 p-3 rounded-lg flex justify-between items-center">
                                        <div>
                                            <p class="font-medium">${a.title}</p>
                                            <p class="text-xs text-gray-500">${new Date(a.date).toLocaleDateString('he-IL')} - ${a.location}</p>
                                        </div>
                                        <span class="text-xs font-semibold px-3 py-1 rounded-full bg-kesher-blue text-white">×¨×©×•×</span>
                                    </div>
                                `).join('') : '<p class="text-gray-500">×œ× × ×¨×©××ª ×œ×¤×¢×™×œ×•×™×•×ª ×§×¨×•×‘×•×ª.</p>'}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        };
        
        const renderUsers = () => {
             const filteredUsers = state.users.filter(u => u.id !== state.user.id)
                .filter(u => !state.usersFilter.city || u.city === state.usersFilter.city)
                .filter(u => !state.usersFilter.role || u.role === state.usersFilter.role)
                .filter(u => !state.usersFilter.hobby || u.hobbies?.includes(state.usersFilter.hobby));
            
            const allCities = [...new Set(state.users.map(u => u.city).filter(c => c))];
            const allHobbies = [...new Set(state.users.flatMap(u => u.hobbies || []).filter(h => h))];

            return `
                ${getHeader()}
                <div class="max-w-6xl mx-auto px-4 mt-8">
                    <h2 class="text-3xl font-bold text-kesher-blue mb-6">? ×—×‘×¨×™× ×‘×§×”×™×œ×” (${filteredUsers.length} × ××¦××•)</h2>
                    
                    <div class="bg-white p-4 rounded-xl shadow-md mb-6 flex flex-wrap gap-4 items-center">
                        <span class="font-medium text-gray-700">×¡×™× ×•×Ÿ:</span>
                        
                        <select onchange="state.usersFilter.city = this.value; render()" class="p-2 border rounded-lg">
                            <option value="">×›×œ ×”×¢×¨×™×</option>
                            ${allCities.map(c => `<option value="${c}" ${state.usersFilter.city === c ? 'selected' : ''}>${c}</option>`).join('')}
                        </select>
                        
                        <select onchange="state.usersFilter.role = this.value; render()" class="p-2 border rounded-lg">
                            <option value="">×›×œ ×”×ª×¤×§×™×“×™×</option>
                            <option value="user" ${state.usersFilter.role === 'user' ? 'selected' : ''}>××©×ª××© ×¨×’×™×œ</option>
                            <option value="admin" ${state.usersFilter.role === 'admin' ? 'selected' : ''}>×× ×”×œ</option>
                        </select>

                         <select onchange="state.usersFilter.hobby = this.value; render()" class="p-2 border rounded-lg">
                            <option value="">×›×œ ×”×ª×—×‘×™×‘×™×</option>
                            ${allHobbies.map(h => `<option value="${h}" ${state.usersFilter.hobby === h ? 'selected' : ''}>${h}</option>`).join('')}
                        </select>
                    </div>

                    <div class="space-y-4">
                        ${filteredUsers.map(u => `
                            <div class="bg-white p-6 rounded-xl shadow-md flex flex-col md:flex-row justify-between items-start md:items-center hover:shadow-lg transition">
                                <div class="flex items-start gap-4 mb-4 md:mb-0">
                                    <div class="w-12 h-12 bg-gray-200 rounded-full flex items-center justify-center text-xl font-bold text-kesher-blue shrink-0">${u.name[0]}</div>
                                    <div class="flex-grow">
                                        <h3 class="text-xl font-bold text-gray-800">${u.name}</h3>
                                        <p class="text-sm text-gray-600">${u.city} | â­ ${u.points || 0} × ×§×•×“×•×ª</p>
                                        <div class="mt-2 text-xs">
                                            <p class="font-semibold text-kesher-green">×ª×—×‘×™×‘×™×: <span class="font-normal text-gray-700">${u.hobbies?.join(', ') || '×œ× ×¦×•×™×Ÿ'}</span></p>
                                            <p class="font-semibold text-kesher-blue">×™×›×•×œ/×” ×œ×ª×¨×•×: <span class="font-normal text-gray-700">${u.contributions?.join(', ') || '×œ× ×¦×•×™×Ÿ'}</span></p>
                                        </div>
                                    </div>
                                </div>
                                <div class="flex gap-2 items-center">
                                    <span class="text-xs font-semibold px-3 py-1 rounded-full ${u.isOnline ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-500'}">${u.isOnline ? 'ğŸŸ¢ ××—×•×‘×¨' : 'âšª ×œ× ××—×•×‘×¨'}</span>
                                    <button onclick="openChat({ id: '${u.id}', name: '${u.name}' })" class="bg-kesher-blue hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition text-sm">×©×œ×— ×”×•×“×¢×”</button>
                                    <button onclick="reportItem('${u.id}', 'user', '${u.id}')" class="bg-red-100 text-red-700 hover:bg-red-200 px-3 py-2 rounded-lg transition text-sm">×“×•×•×— âš ï¸</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        };

        const renderChat = () => {
            if (!state.selectedUser) { goTo('users'); return ''; }

            return `
                ${getHeader()}
                <div class="max-w-4xl mx-auto px-4 mt-8">
                    <div class="bg-white rounded-2xl shadow-xl overflow-hidden h-[70vh] flex flex-col">
                        <div class="bg-kesher-blue text-white p-4 flex justify-between items-center">
                            <h2 class="text-xl font-bold">ğŸ’¬ ×¦'××˜ ×¢× ${state.selectedUser.name}</h2>
                            <button onclick="goTo('users')" class="bg-blue-600 hover:bg-blue-700 px-3 py-1 rounded transition text-sm">×—×–×¨×” ×œ×—×‘×¨×™×</button>
                        </div>
                        <div id="chatBox" class="flex-grow p-4 overflow-y-auto space-y-3">
                            ${state.chatMessages.map(msg => {
                                const isMe = msg.senderId === state.user.id;
                                const time = msg.timestamp ? new Date(msg.timestamp.seconds * 1000).toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit' }) : '×¢×›×©×™×•';
                                return `
                                    <div class="flex ${isMe ? 'justify-end' : 'justify-start'}">
                                        <div class="${isMe ? 'bg-kesher-green text-white rounded-tr-none' : 'bg-gray-200 text-gray-800 rounded-tl-none'} max-w-xs p-3 rounded-xl shadow-md">
                                            <p class="text-sm">${msg.content}</p>
                                            <div class="text-xs mt-1 flex justify-between items-center">
                                                <span class="${isMe ? 'text-green-200' : 'text-gray-500'}">${time}</span>
                                                ${!isMe ? `<button onclick="reportItem('${msg.id}', 'message', '${msg.senderId}')" class="text-red-400 hover:text-red-600 mr-2">×“×•×•×— âš ï¸</button>` : ''}
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        <div class="p-4 border-t flex gap-2">
                            <input type="text" id="chatInput" placeholder="×”×§×œ×“ ×”×•×“×¢×”..." class="flex-grow p-3 border-2 rounded-lg" onkeydown="if(event.key === 'Enter') sendMessage()" />
                            <button onclick="sendMessage()" class="bg-kesher-blue hover:bg-blue-600 text-white px-4 py-3 rounded-lg font-bold">×©×œ×—</button>
                        </div>
                    </div>
                </div>
            `;
        };

        const renderForums = () => {
            return `
                ${getHeader()}
                <div class="max-w-6xl mx-auto px-4 mt-8">
                    <h2 class="text-3xl font-bold text-kesher-green mb-6">?? ×¤×•×¨×•××™ ×§×”×™×œ×”</h2>
                    <div class="space-y-4">
                        ${state.forums.map(f => `
                            <div class="bg-white p-6 rounded-xl shadow-md flex justify-between items-center hover:shadow-lg transition">
                                <div>
                                    <h3 class="text-2xl font-bold text-gray-800">${f.icon} ${f.title}</h3>
                                    <p class="text-gray-600">${f.description}</p>
                                </div>
                                <div class="flex items-center gap-4">
                                    <button onclick="goTo('forumPosts', { forumId: '${f.id}' })" class="bg-kesher-blue hover:bg-blue-600 text-white px-4 py-2 rounded-lg font-medium transition">×›× ×¡ ×œ×¤×•×¨×•×</button>
                                    ${state.user.role === 'admin' ? `
                                        <div class="flex gap-2 text-sm">
                                            <button onclick="alert('×¤×•× ×§×¦×™×™×ª ×¢×¨×™×›×” ×œ× ××•××©×”')" class="text-blue-500 hover:text-blue-700">×¢×¨×•×š</button>
                                            <button onclick="alert('×¤×•× ×§×¦×™×™×ª ××—×™×§×” ×œ× ××•××©×”')" class="text-red-500 hover:text-red-700">××—×§</button>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        };

        const renderForumPosts = () => {
            const forum = state.forums.find(f => f.id === state.currentForumId);
            if (!forum) { goTo('forums'); return ''; }

            return `
                ${getHeader()}
                <div class="max-w-6xl mx-auto px-4 mt-8">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-3xl font-bold text-kesher-green">${forum.icon} ${forum.title}</h2>
                        <button onclick="goTo('newPost')" class="bg-kesher-blue hover:bg-blue-600 text-white px-4 py-2 rounded-lg font-medium transition">âœï¸ ×¤×ª×— × ×•×©× ×—×“×©</button>
                    </div>
                    ${forum.posts?.length > 0 ? `<div class="space-y-4">
                        ${forum.posts.map(p => `
                            <div onclick="goTo('postDetails', { postId: '${p.id}' })" class="bg-white p-5 rounded-xl shadow-md cursor-pointer hover:shadow-lg transition flex justify-between items-center">
                                <div>
                                    <h3 class="text-xl font-bold text-gray-800">${p.title}</h3>
                                    <p class="text-sm text-gray-600">× ×¤×ª×— ×¢×œ ×™×“×™: ${p.creatorName} | ×œ×¤× ×™: ${timeSince(p.createdAt.toDate())}</p>
                                </div>
                                <div class="flex gap-4 text-gray-500">
                                    <span>â¤ï¸ ${p.likes?.length || 0}</span>
                                    <span>ğŸ’¬ ${p.replies?.length || 0}</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>` : '<p class="text-center text-gray-500 p-8 bg-white rounded-xl shadow-md">××™×Ÿ ×¤×•×¡×˜×™× ×‘×¤×•×¨×•× ×–×” ×›×¨×’×¢. ×”×ª×—×œ ××ª ×”×“×™×•×Ÿ ×”×¨××©×•×Ÿ!</p>'}
                </div>
            `;
        };

        const renderNewPost = () => {
            const forum = state.forums.find(f => f.id === state.currentForumId);
            if (!forum) { goTo('forums'); return ''; }

            return `
                ${getHeader()}
                <div class="max-w-4xl mx-auto px-4 mt-8">
                    <h2 class="text-3xl font-bold text-kesher-green mb-6">âœï¸ ×¤×ª×™×—×ª × ×•×©× ×—×“×© ×‘×¤×•×¨×•× ${forum.title}</h2>
                    <div class="bg-white p-6 rounded-2xl shadow-xl space-y-4">
                        <input id="postTitle" type="text" placeholder="×›×•×ª×¨×ª ×”× ×•×©×" class="w-full p-3 border-2 rounded-lg text-lg font-medium" />
                        <textarea id="postContent" placeholder="×ª×•×›×Ÿ ×”×¤×•×¡×˜ ×”××œ×..." rows="8" class="w-full p-3 border-2 rounded-lg"></textarea>
                        <div class="flex justify-end gap-3">
                            <button onclick="goTo('forumPosts', { forumId: state.currentForumId })" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded-lg font-bold">×‘×™×˜×•×œ</button>
                            <button onclick="createPost()" class="bg-kesher-blue hover:bg-blue-600 text-white px-4 py-2 rounded-lg font-bold">×¤×¨×¡×</button>
                        </div>
                    </div>
                </div>
            `;
        };

        const renderPostDetails = () => {
            const post = state.currentPost;
            if (!post) { goTo('forums'); return ''; }
            
            const isLiked = post.likes?.includes(state.user.id);
            const likeText = isLiked ? 'â¤ï¸ ×‘×™×˜×•×œ ×œ×™×™×§' : 'ğŸ¤ ×œ×™×™×§';
            const likeColor = isLiked ? 'text-red-600 bg-red-100' : 'text-gray-600 bg-gray-100';

            return `
                ${getHeader()}
                <div class="max-w-4xl mx-auto px-4 mt-8">
                    <button onclick="goTo('forumPosts', { forumId: state.currentForumId })" class="text-kesher-blue hover:text-blue-700 font-medium mb-4 flex items-center gap-1">
                        <span class="text-xl">â¬…ï¸</span> ×—×–×¨×” ×œ×¤×•×¨×•×
                    </button>
                    
                    <div class="bg-white p-6 rounded-2xl shadow-xl mb-6">
                        <h1 class="text-3xl font-extrabold text-gray-900 mb-2">${post.title}</h1>
                        <p class="text-sm text-gray-500 mb-4">× ×¤×ª×— ×¢×œ ×™×“×™: <span class="font-bold">${post.creatorName}</span> | ×œ×¤× ×™: ${timeSince(post.createdAt.toDate())}</p>
                        
                        <div class="prose max-w-none mb-6">
                            <p class="text-gray-700 whitespace-pre-wrap">${post.content}</p>
                        </div>

                        <div class="flex justify-between items-center border-t pt-4">
                            <div class="flex gap-4 items-center">
                                <button onclick="toggleLike('${post.id}')" class="flex items-center gap-2 p-2 rounded-full ${likeColor} font-bold transition text-sm">
                                    ${likeText} (${post.likes?.length || 0})
                                </button>
                            </div>
                            <div class="flex gap-3 text-sm">
                                ${post.creatorId === state.user.id || state.user.role === 'admin' ? `<button onclick="alert('×¤×•× ×§×¦×™×™×ª ×¢×¨×™×›×” ×œ× ××•××©×”')" class="text-blue-500 hover:text-blue-700">×¢×¨×•×š</button>` : ''}
                                ${post.creatorId === state.user.id || state.user.role === 'admin' ? `<button onclick="alert('×¤×•× ×§×¦×™×™×ª ××—×™×§×” ×œ× ××•××©×”')" class="text-red-500 hover:text-red-700">××—×§</button>` : ''}
                                ${post.creatorId !== state.user.id ? `<button onclick="reportItem('${post.id}', 'post', '${post.creatorId}')" class="text-red-400 hover:text-red-600">×“×•×•×— âš ï¸</button>` : ''}
                            </div>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-2xl shadow-xl mb-6">
                        <h3 class="text-xl font-bold text-kesher-blue mb-3">×”×•×¡×£ ×ª×’×•×‘×”:</h3>
                        <textarea id="replyContent" placeholder="×”×ª×’×•×‘×” ×©×œ×š..." rows="3" class="w-full p-3 border-2 rounded-lg mb-3"></textarea>
                        <button onclick="addReply()" class="bg-kesher-green hover:bg-green-700 text-white px-4 py-2 rounded-lg font-bold">×©×œ×— ×ª×’×•×‘×”</button>
                    </div>

                    <h3 class="text-2xl font-bold text-gray-800 mb-4">${state.currentPostReplies.length} ×ª×’×•×‘×•×ª</h3>
                    <div class="space-y-4">
                        ${state.currentPostReplies.map(r => `
                            <div class="bg-white p-4 rounded-xl shadow-md border-r-4 ${r.creatorId === post.creatorId ? 'border-amber-400' : 'border-gray-200'}">
                                <p class="font-medium mb-1">${r.creatorName} ${r.creatorId === post.creatorId ? ' (×›×•×ª×‘ ×”×¤×•×¡×˜)' : ''}</p>
                                <p class="text-gray-700 whitespace-pre-wrap">${r.content}</p>
                                <div class="text-xs text-gray-500 mt-2 flex justify-between items-center">
                                    <span>${new Date(r.createdAt.toDate()).toLocaleString('he-IL')}</span>
                                    ${r.creatorId === state.user.id || state.user.role === 'admin' ? 
                                        `<button onclick="alert('×¤×•× ×§×¦×™×™×ª ××—×™×§×” ×œ× ××•××©×”')" class="text-red-500 hover:text-red-700">××—×§</button>` : 
                                        `<button onclick="reportItem('${r.id}', 'reply', '${r.creatorId}')" class="text-red-400 hover:text-red-600">×“×•×•×— âš ï¸</button>`
                                    }
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        };
        
        const renderActivities = () => {
             const upcomingActivities = state.activities.sort((a, b) => a.date - b.date).filter(a => a.date >= new Date());
             
             return `
                ${getHeader()}
                <div class="max-w-6xl mx-auto px-4 mt-8">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-3xl font-bold text-kesher-blue">?? ×¤×¢×™×œ×•×™×•×ª ×§×”×™×œ×ª×™×•×ª</h2>
                        <button onclick="goTo('newActivity')" class="bg-kesher-green hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium transition">â• ×”×¦×¢ ×¤×¢×™×œ×•×ª</button>
                    </div>
                    <div class="space-y-4">
                        ${upcomingActivities.length > 0 ? upcomingActivities.map(a => {
                            const isRegistered = a.attendees.includes(state.user.id);
                            const actionButton = isRegistered 
                                ? `<span class="text-sm font-semibold px-3 py-1 rounded-full bg-kesher-green text-white">×¨×©×•×</span>`
                                : `<button onclick="registerForActivity('${a.id}')" class="bg-kesher-blue hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition text-sm">×”×¨×©×</button>`;
                            
                            return `
                                <div class="bg-white p-6 rounded-xl shadow-md hover:shadow-lg transition flex flex-col md:flex-row justify-between items-start md:items-center">
                                    <div class="mb-4 md:mb-0">
                                        <h3 class="text-2xl font-bold text-gray-800">${a.title}</h3>
                                        <p class="text-sm text-gray-600 mb-2">ğŸ“ ${a.location} | ×××¨×’×Ÿ: ${a.creatorName}</p>
                                        <p class="text-base font-medium text-kesher-blue">${new Date(a.date).toLocaleString('he-IL')}</p>
                                        <p class="mt-2 text-gray-700 whitespace-pre-wrap">${a.description}</p>
                                    </div>
                                    <div class="flex flex-col items-end gap-2 shrink-0">
                                        ${actionButton}
                                        <p class="text-xs text-gray-500">${a.attendees.length} × ×¨×©××•</p>
                                    </div>
                                </div>
                            `;
                        }).join('') : '<p class="text-center text-gray-500 p-8 bg-white rounded-xl shadow-md">××™×Ÿ ×¤×¢×™×œ×•×™×•×ª ×§×¨×•×‘×•×ª ××ª×•×›× × ×•×ª.</p>'}
                    </div>
                </div>
             `;
        };

        const renderNewActivity = () => {
            return `
                ${getHeader()}
                <div class="max-w-4xl mx-auto px-4 mt-8">
                    <h2 class="text-3xl font-bold text-kesher-green mb-6">â• ×”×¦×¢×ª ×¤×¢×™×œ×•×ª ×§×”×™×œ×ª×™×ª</h2>
                    <div class="bg-white p-6 rounded-2xl shadow-xl space-y-4">
                        <input id="activityTitle" type="text" placeholder="×›×•×ª×¨×ª ×”×¤×¢×™×œ×•×ª (×œ×“×•×’××”: ×˜×™×•×œ ×™×•× ×‘×©×‘×™×œ ×™×©×¨××œ)" class="w-full p-3 border-2 rounded-lg text-lg font-medium" />
                        <textarea id="activityDescription" placeholder="×ª×™××•×¨ ××œ× ×©×œ ×”×¤×¢×™×œ×•×ª, ×“×¨×™×©×•×ª, ×•×¦×™×•×“ × ×“×¨×©..." rows="5" class="w-full p-3 border-2 rounded-lg"></textarea>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">×ª××¨×™×š ×•×©×¢×”:</label>
                                <input id="activityDate" type="datetime-local" class="w-full p-3 border-2 rounded-lg" />
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">××™×§×•× (×¢×™×¨/××§×•× ××¤×’×©):</label>
                                <input id="activityLocation" type="text" placeholder="×œ×“×•×’××”: ×ª×œ ××‘×™×‘, ×¤××¨×§ ×”×™×¨×§×•×Ÿ" class="w-full p-3 border-2 rounded-lg" />
                            </div>
                        </div>
                        <div class="flex justify-end gap-3">
                            <button onclick="goTo('activities')" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded-lg font-bold">×‘×™×˜×•×œ</button>
                            <button onclick="createActivity()" class="bg-kesher-green hover:bg-green-700 text-white px-4 py-2 rounded-lg font-bold">×¤×¨×¡× ×¤×¢×™×œ×•×ª</button>
                        </div>
                    </div>
                </div>
            `;
        };

        const renderAdmin = () => {
            if (state.user.role !== 'admin') { goTo('home'); return ''; }

            const newReports = state.reports.filter(r => r.status === '×—×“×©');
            const inProgressReports = state.reports.filter(r => r.status === '×‘×˜×™×¤×•×œ');

            return `
                ${getHeader()}
                <div class="max-w-6xl mx-auto px-4 mt-8">
                    <h2 class="text-3xl font-bold text-red-600 mb-6">âš ï¸ ×œ×•×— ×‘×§×¨×” ×œ×× ×”×œ</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                        <div class="bg-white p-5 rounded-xl shadow-lg border-r-4 border-kesher-blue">
                            <p class="text-xs text-gray-500">×¡×”"×› ××©×ª××©×™×</p>
                            <p class="text-3xl font-bold text-kesher-blue">${state.users.length}</p>
                        </div>
                        <div class="bg-white p-5 rounded-xl shadow-lg border-r-4 border-kesher-green">
                            <p class="text-xs text-gray-500">×¤×¢×™×œ×•×™×•×ª ×§×¨×•×‘×•×ª</p>
                            <p class="text-3xl font-bold text-kesher-green">${state.activities.filter(a => a.date >= new Date()).length}</p>
                        </div>
                        <div class="bg-white p-5 rounded-xl shadow-lg border-r-4 border-red-500">
                            <p class="text-xs text-gray-500">×“×™×•×•×—×™× ×—×“×©×™×</p>
                            <p class="text-3xl font-bold text-red-500">${newReports.length}</p>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-2xl shadow-xl">
                        <h3 class="text-2xl font-bold text-red-600 mb-4">?? × ×™×”×•×œ ×“×™×•×•×—×™× (${state.reports.length})</h3>
                        <div class="space-y-4">
                            ${state.reports.map(r => {
                                const statusColor = r.status === '×—×“×©' ? 'bg-red-100 text-red-800' : 
                                                    r.status === '×‘×˜×™×¤×•×œ' ? 'bg-amber-100 text-amber-800' : 'bg-green-100 text-green-800';
                                return `
                                    <div class="border p-4 rounded-lg flex justify-between items-center">
                                        <div>
                                            <p class="font-bold">×“×•×•×— ×¢×œ: ${r.itemType} (ID: ${r.itemId.substring(0, 8)}...)</p>
                                            <p class="text-sm text-gray-600">×¡×™×‘×”: ${r.reason}</p>
                                            <p class="text-xs text-gray-500">××“×•×•×—: ${r.reporterName} | ××©×ª××© ××“×•×•×— ID: ${r.reportedUserId.substring(0, 8)}...</p>
                                        </div>
                                        <div class="flex flex-col gap-2 items-end">
                                            <span class="px-3 py-1 rounded-full text-xs font-semibold ${statusColor}">${r.status}</span>
                                            <select onchange="updateReportStatus('${r.id}', this.value)" class="p-1 border rounded-lg text-sm">
                                                <option value="×—×“×©" ${r.status === '×—×“×©' ? 'selected' : ''}>×—×“×©</option>
                                                <option value="×‘×˜×™×¤×•×œ" ${r.status === '×‘×˜×™×¤×•×œ' ? 'selected' : ''}>×‘×˜×™×¤×•×œ</option>
                                                <option value="×˜×•×¤×œ" ${r.status === '×˜×•×¤×œ' ? 'selected' : ''}>×˜×•×¤×œ</option>
                                            </select>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                </div>
            `;
        };


        // --- 5. ×× ×•×¢ ×¨×™× ×“×•×¨ ×•×˜×¢×™× ×” ×¨××©×•× ×™×ª ---

        function render() {
            let content = '';
            
            if (!state.user && state.screen !== 'register') {
                state.screen = 'login';
            }

            switch (state.screen) {
                case 'login': content = renderLogin(); break;
                case 'register': content = renderRegister(); break;
                case 'home': content = renderHome(); break;
                case 'users': content = renderUsers(); break;
                case 'chat': content = renderChat(); break;
                case 'forums': content = renderForums(); break;
                case 'forumPosts': content = renderForumPosts(); break;
                case 'newPost': content = renderNewPost(); break;
                case 'postDetails': content = renderPostDetails(); break;
                case 'activities': content = renderActivities(); break;
                case 'newActivity': content = renderNewActivity(); break;
                case 'admin': content = renderAdmin(); break;
                default: content = `<h1>×©×’×™××ª × ×™×ª×•×‘</h1><button onclick="goTo('home')">×—×–×•×¨ ×”×‘×™×ª×”</button>`;
            }
            
            document.getElementById('root').innerHTML = content;
        }

        /**
         * ×˜×¢×™× ×ª ×”××©×ª××© ×”× ×•×›×—×™ ×‘××§×¨×” ×©×œ ×¨×¢× ×•×Ÿ ×“×£ (×× ×”×•× ×›×‘×¨ ××—×•×‘×¨)
         */
        async function initializeApp() {
            // ×˜×¢×™× ×ª × ×ª×•× ×™× ×¤×™×§×˜×™×‘×™×™× ×¨××©×•× ×™×ª (×œ××§×¨×” ×©×œ ×›×™×©×œ×•×Ÿ ×‘-Firestore)
            loadFakeData(); 
            
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    try {
                        const userDoc = await db.collection('users').doc(user.uid).get();
                        if (userDoc.exists) {
                            const userData = userDoc.data();
                            
                            // ×¢×“×›×•×Ÿ ×”-state
                            state.user = { 
                                id: user.uid, 
                                email: user.email, 
                                name: userData.name, 
                                role: userData.role || 'user', 
                                points: userData.points || 0,
                                hobbies: userData.hobbies || [], 
                                contributions: userData.contributions || [] 
                            };
                            
                            // ×˜×¢×™× ×ª × ×ª×•× ×™× × ×•×¡×¤×™× ×œ××—×¨ ××™××•×ª (×—×™×•× ×™ ×œ×¨× ×“×•×¨ ×”×‘×™×ª)
                            await fetchInitialData(); 

                            goTo('home');
                        } else {
                            // ×”××©×ª××© × ××¦× ×‘-Auth ××š ×œ× ×‘-Firestore - ×™×© ×œ×”×ª× ×ª×§
                            auth.signOut();
                        }
                    } catch (error) {
                        console.error("×©×’×™××” ×‘××—×–×•×¨ ×¤×¨×•×¤×™×œ ××©×ª××©:", error);
                        auth.signOut();
                    }
                } else {
                    state.user = null;
                    goTo('login');
                }
            });
        }

        // ×”×¤×¢×œ×ª ×”××¤×œ×™×§×¦×™×”
        initializeApp(); 
    </script>
</body>
</html>
